2025-09-02 12:03:54,596 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:03:57,936 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:04:00,155 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:04:00,344 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:04:02,042 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:04:02,222 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:04:02,224 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:04:02,224 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:04:02,227 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:04:02,227 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:04:02,228 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:04:02,229 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:04:02,230 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:04:02,231 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:04:02,232 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:04:03,752 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:04:03,775 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:04:03,959 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:04:05,696 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:04:05,887 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:04:05,888 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:04:05,889 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:04:05,889 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:04:05,890 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:04:05,890 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:04:05,898 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:04:05,898 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:04:05,899 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:04:05,900 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:04:05,901 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:04:06,581 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:04:06,582 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:04:06,582 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:04:06,583 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:04:06,584 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:04:06,584 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:04:06,617 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:04:06,618 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:04:10,876 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 12:04:10,876 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:04:12,421 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:13,763 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:12.610308+00:00, interaction_count=162, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:14,346 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:14,348 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:04:14,348 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:15,857 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:04:16,044 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 12:04:16,044 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:04:16,045 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 12:04:16,046 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:04:18,366 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFQjBFNkNBMTlDRkQwRDMyNQA="}]}
2025-09-02 12:04:18,368 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:19,356 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg3NkUyRTg2ODNEQUFFNEMyMAA="}]}
2025-09-02 12:04:19,359 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg3NkUyRTg2ODNEQUFFNEMyMAA='}]}
2025-09-02 12:04:19,364 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:19] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:20,535 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:20,848 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:21,132 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:21,738 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:23,196 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:04:24,745 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:26,037 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:24.926269+00:00, interaction_count=163, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:26,591 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:26,592 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:26,593 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:26,593 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:04:26,594 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:04:26,594 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:04:26,595 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:04:26,595 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:04:26,596 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:04:27,545 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE0MkMyQTA2NTRCMEU1RTVGMAA="}]}
2025-09-02 12:04:27,546 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:04:27,547 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:04:28,443 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYxMzVDN0Q2Nzk2MDJBNTVDNgA="}]}
2025-09-02 12:04:28,445 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYxMzVDN0Q2Nzk2MDJBNTVDNgA='}]}
2025-09-02 12:04:28,446 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:28] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:29,470 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,057 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,099 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,195 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,416 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,517 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:31,938 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-09-02 12:04:33,450 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:34,773 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:33.631560+00:00, interaction_count=164, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:35,323 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:35,324 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:35,324 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:35,325 - handlers.base_handler - INFO - AIHandler: Handling message 'fried rice' in AI bulk order state for session 2348055614455. Original: 'Fried rice'
2025-09-02 12:04:38,276 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:04:38,303 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:39,324 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0OUM5Q0NCMENENjY3NUFBRgA="}]}
2025-09-02 12:04:39,325 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0OUM5Q0NCMENENjY3NUFBRgA='}]}
2025-09-02 12:04:39,326 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:40,658 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:41,008 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:42,875 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:04:44,389 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:45,710 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:44.576712+00:00, interaction_count=165, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:46,268 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:46,270 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:46,270 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:46,271 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:04:46,271 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:04:46,272 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:04:46,273 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:04:46,273 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:04:46,289 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:47,194 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxNzRGQjRFREMzMzhGRUM0NwA="}]}
2025-09-02 12:04:48,277 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:48,556 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:48,703 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:48,899 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:50,013 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:48.894880+00:00, interaction_count=166, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:50,310 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:04:50,554 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:50,575 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:04:50,575 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxNzRGQjRFREMzMzhGRUM0NwA='}]}
2025-09-02 12:04:50,577 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:50] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:51,813 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:53,144 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:52.004088+00:00, interaction_count=167, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:53,714 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:53,716 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:53,716 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:53,717 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:04:53,717 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:04:53,744 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:54,875 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGNUM2QkMzQkMwRjFDOTczOAA="}]}
2025-09-02 12:04:56,005 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:56,386 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:56,415 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:56,589 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:57,702 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:56.584932+00:00, interaction_count=168, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:57,807 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:04:58,243 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:58,257 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:04:58,258 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGNUM2QkMzQkMwRjFDOTczOAA='}]}
2025-09-02 12:04:58,259 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:59,314 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:05:00,624 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:59.495236+00:00, interaction_count=169, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:05:01,192 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:05:01,194 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:05:01,194 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:05:01,195 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:05:01,196 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:05:01,196 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:05:01,213 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:05:01,214 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Error: Invalid button configuration. Please try again or contact support.'}}
2025-09-02 12:05:02,216 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyN0IyRkQ0OTY0NEVDQ0MyRQA="}]}
2025-09-02 12:05:03,227 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:05:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:05:03,723 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:05:03,992 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:05:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:05:04,995 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:05:03.902828+00:00, interaction_count=170, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:05:05,552 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:05:05,563 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:05:05,564 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyN0IyRkQ0OTY0NEVDQ0MyRQA='}]}
2025-09-02 12:05:05,565 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:05:05] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:49,005 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': "He'll"}
2025-09-02 12:06:50,528 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:06:51,832 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:06:50.708552+00:00, interaction_count=171, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:06:52,404 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:06:52,405 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:06:52,405 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:06:52,419 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:06:53,384 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE2MzI5QzFGMEFFM0E5QUM5QwA="}]}
2025-09-02 12:06:54,744 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:54,854 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:06:54,859 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:55,325 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:56,152 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:06:55.038839+00:00, interaction_count=172, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:06:56,700 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:06:56,711 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:06:56,712 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE2MzI5QzFGMEFFM0E5QUM5QwA='}]}
2025-09-02 12:06:56,713 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:59,557 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_palmpay_salvation'}
2025-09-02 12:07:01,085 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:07:02,410 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:07:01.273452+00:00, interaction_count=173, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:07:02,958 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:07:02,960 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:07:02,960 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:07:04,642 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:07:04,644 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-02 12:07:04,644 - handlers.location_address_handler - INFO - Selected preset address 'Palmpay Salvation' for session 2348055614455
2025-09-02 12:07:04,645 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-09-02 12:07:06,375 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:07:06,376 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-02 12:07:06,377 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-09-02 12:07:06,399 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:07:07,405 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEzQ0YxQjNFNkM4QzczNkY2RQA="}]}
2025-09-02 12:07:08,467 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:08,859 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:08,913 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:07:09,389 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:10,243 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:07:09.093265+00:00, interaction_count=174, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:07:10,797 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:07:10,811 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:07:10,811 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEzQ0YxQjNFNkM4QzczNkY2RQA='}]}
2025-09-02 12:07:10,812 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:34,813 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:07:34,814 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 12:07:38,947 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:07:41,387 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:07:42,923 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:07:43,108 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:07:44,902 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:07:45,081 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:07:45,083 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:07:45,084 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:07:45,087 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:07:45,088 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:07:45,089 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:07:45,090 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:07:45,090 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:07:45,091 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:07:45,092 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:07:46,582 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:07:46,601 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:07:46,793 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:07:48,532 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:07:48,724 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:07:48,725 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:07:48,726 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:07:48,727 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:07:48,728 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:07:48,728 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:07:48,730 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:07:48,731 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:07:48,732 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:07:48,733 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:07:48,734 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:07:49,442 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:07:49,443 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:07:49,443 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:07:49,444 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:07:49,445 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:07:49,445 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:07:49,480 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:07:49,481 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:08:26,234 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 12:08:26,235 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:08:27,689 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:08:29,033 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:27.877563+00:00, interaction_count=175, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:08:29,719 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:08:29,719 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:08:29,720 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:08:31,203 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:08:31,386 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 12:08:31,386 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:08:31,387 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 12:08:31,387 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:08:32,423 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCQTMwMEFEOTQzQTZBRTlCNAA="}]}
2025-09-02 12:08:32,424 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:08:33,423 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2MjQ1QjlGMUQ1QkU5QjFGQQA="}]}
2025-09-02 12:08:33,425 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2MjQ1QjlGMUQ1QkU5QjFGQQA='}]}
2025-09-02 12:08:33,426 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:33] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:33,731 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:33] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,453 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,573 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,810 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,963 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:35,143 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:36,344 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:08:37,881 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:08:39,193 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:38.063345+00:00, interaction_count=176, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:08:39,758 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:08:39,758 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:08:39,758 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:08:39,759 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:08:39,759 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:08:39,759 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:08:39,759 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:08:39,760 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:08:39,760 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:08:40,738 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkyMTIyMUIwRkIxN0RBRThFQwA="}]}
2025-09-02 12:08:40,739 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:08:40,739 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:08:41,573 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkREOTIyNTE0MjQ5NDEwQzQ2MgA="}]}
2025-09-02 12:08:41,574 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkREOTIyNTE0MjQ5NDEwQzQ2MgA='}]}
2025-09-02 12:08:41,574 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:42,110 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:42,714 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:42,739 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:43,005 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:43,215 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:43,266 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:47,251 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-02 12:08:48,727 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:08:50,019 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:48.906084+00:00, interaction_count=177, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:08:50,564 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:08:50,565 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:08:50,565 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:08:50,565 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-02 12:08:53,078 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:08:53,091 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:08:54,073 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwQTNCODk4RTM1Q0MzNDQ3OAA="}]}
2025-09-02 12:08:54,074 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwQTNCODk4RTM1Q0MzNDQ3OAA='}]}
2025-09-02 12:08:54,074 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:55,253 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:55,503 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:55,685 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:57,227 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:08:58,702 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:00,192 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:58.891202+00:00, interaction_count=178, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:00,736 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:00,737 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:00,737 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:00,737 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:09:00,737 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:09:00,738 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:09:00,738 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:09:00,738 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:09:00,746 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:09:01,672 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMDNDRjNGRDFCQUQ3RTE0RgA="}]}
2025-09-02 12:09:02,721 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:02] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:02,975 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:02] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:03,148 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:03,318 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:04,438 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:03.337024+00:00, interaction_count=179, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:04,980 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:04,990 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:04,991 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMDNDRjNGRDFCQUQ3RTE0RgA='}]}
2025-09-02 12:09:04,992 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:05,034 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:09:06,508 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:07,817 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:06.702859+00:00, interaction_count=180, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:08,354 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:08,355 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:08,355 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:08,355 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:09:08,356 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:09:08,373 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:09:09,242 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJFRUIzRkM0MTRCRTJBQzM2RgA="}]}
2025-09-02 12:09:10,313 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:10,706 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:10,885 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:11,195 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:12,006 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:10.892988+00:00, interaction_count=181, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:12,567 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:12,573 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:12,573 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJFRUIzRkM0MTRCRTJBQzM2RgA='}]}
2025-09-02 12:09:12,574 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:12] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:12,865 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:09:14,320 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:15,631 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:14.505882+00:00, interaction_count=182, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:16,206 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:16,206 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:16,207 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:16,207 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:09:16,207 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:09:16,208 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:09:16,215 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:09:17,534 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY5N0Y0NzM1NEY0MEM2Rjg2QQA="}]}
2025-09-02 12:09:18,684 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:18] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:18,860 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:18] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:19,058 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:19,665 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:19] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:20,383 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:19.234220+00:00, interaction_count=183, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:20,975 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:20,982 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:20,982 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY5N0Y0NzM1NEY0MEM2Rjg2QQA='}]}
2025-09-02 12:09:20,983 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:26,079 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_palmpay_salvation'}
2025-09-02 12:09:27,542 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:28,853 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:27.719751+00:00, interaction_count=184, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:29,425 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:29,426 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:29,426 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:31,062 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:09:31,063 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-02 12:09:31,063 - handlers.location_address_handler - INFO - Selected preset address 'Palmpay Salvation' for session 2348055614455
2025-09-02 12:09:31,064 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-09-02 12:09:32,798 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:09:32,799 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-02 12:09:32,800 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-09-02 12:09:32,812 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:09:33,753 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2MTk4Q0U5NkNDMzQyRTQwNgA="}]}
2025-09-02 12:09:34,953 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:35,166 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:35,273 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:36,004 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:36] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:36,567 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:35.462989+00:00, interaction_count=185, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:37,117 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:37,123 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:37,123 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2MTk4Q0U5NkNDMzQyRTQwNgA='}]}
2025-09-02 12:09:37,124 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:37] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:08,964 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:10:08,964 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 12:10:12,785 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:10:14,253 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:10:15,812 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:10:15,993 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:10:17,682 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:10:17,873 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:10:17,874 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:10:17,874 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:10:17,876 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:10:17,876 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:10:17,876 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:10:17,877 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:10:17,877 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:10:17,878 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:10:17,878 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:10:19,343 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:10:19,351 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:10:19,547 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:10:21,310 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:10:21,493 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:10:21,493 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:10:21,494 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:10:21,494 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:10:21,494 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:10:21,495 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:10:21,496 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:10:21,496 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:10:21,496 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:10:21,497 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:10:21,497 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:10:21,935 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:10:21,935 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:10:21,935 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:10:21,936 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:10:21,936 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:10:21,936 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:10:21,960 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:10:21,961 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:10:23,763 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hwllo'}
2025-09-02 12:10:23,764 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:10:25,242 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:10:26,578 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:10:25.432294+00:00, interaction_count=186, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:10:27,136 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:10:27,137 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:10:27,137 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:10:28,608 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:10:28,795 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:10:28,795 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-02 12:10:28,796 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:10:29,873 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJCNjk3Mjk4REYzNDlEMDE4MAA="}]}
2025-09-02 12:10:29,874 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:10:30,892 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExQ0IxQUQxRTRERkVFNTZDRQA="}]}
2025-09-02 12:10:30,893 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExQ0IxQUQxRTRERkVFNTZDRQA='}]}
2025-09-02 12:10:30,894 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:31,348 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:31,893 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:31,976 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:32,005 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:32,555 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:32,673 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:34,174 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:10:35,662 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:10:36,985 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:10:35.846676+00:00, interaction_count=187, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:10:37,548 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:10:37,549 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:10:37,549 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:10:37,550 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:10:37,550 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:10:37,551 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:10:37,551 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:10:37,551 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:10:37,552 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:10:38,546 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1M0I4MTJCMjVBMEYyQTg5QQA="}]}
2025-09-02 12:10:38,548 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:10:38,549 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:10:39,433 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBNjc4QzQ3REExNzJGMzRFQQA="}]}
2025-09-02 12:10:39,437 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBNjc4QzQ3REExNzJGMzRFQQA='}]}
2025-09-02 12:10:39,439 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,104 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,577 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,668 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,895 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:41,030 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:41,155 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:50,571 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-02 12:10:52,128 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:10:53,424 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:10:52.326433+00:00, interaction_count=188, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:10:53,965 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:10:53,966 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:10:53,967 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:10:53,967 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-02 12:10:57,311 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:10:57,322 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:10:58,183 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QjQ1NTE5QURDRThERTg0MwA="}]}
2025-09-02 12:10:58,184 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QjQ1NTE5QURDRThERTg0MwA='}]}
2025-09-02 12:10:58,185 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:59,193 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:59,730 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:59,827 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:01,794 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:11:03,280 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:04,548 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:03.463914+00:00, interaction_count=189, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:05,113 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:05,114 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:05,115 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:05,115 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:11:05,115 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:11:05,115 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:11:05,116 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:11:05,116 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:11:05,123 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:06,045 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0OTVGODAyMTQxNTU0MzQ1QQA="}]}
2025-09-02 12:11:07,104 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:07,399 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:07,547 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:07,853 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:08,913 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:07.723022+00:00, interaction_count=190, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:09,481 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:09,489 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:09,489 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0OTVGODAyMTQxNTU0MzQ1QQA='}]}
2025-09-02 12:11:09,490 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:09,717 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:11:11,332 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:12,643 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:11.528603+00:00, interaction_count=191, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:13,201 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:13,203 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:13,204 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:13,208 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:11:13,213 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:11:13,329 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:14,516 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU4MjgwNEJCMDQ4ODE4MDkxRAA="}]}
2025-09-02 12:11:15,633 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:15] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:15,897 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:15] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:16,014 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:16,335 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:16] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:17,285 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:16.194908+00:00, interaction_count=192, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:17,832 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:17,837 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:17,838 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU4MjgwNEJCMDQ4ODE4MDkxRAA='}]}
2025-09-02 12:11:17,838 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:17] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:18,344 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:11:19,820 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:21,112 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:20.011376+00:00, interaction_count=193, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:21,666 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:21,667 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:21,667 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:21,668 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:11:21,668 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:11:21,668 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:11:21,674 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:22,652 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3OTAzNTM1M0FCNDUxMjBBMgA="}]}
2025-09-02 12:11:23,632 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:23] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:24,266 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:24] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:24,272 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:24,344 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:24] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:25,739 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:24.482499+00:00, interaction_count=194, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:26,303 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:26,314 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:26,314 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3OTAzNTM1M0FCNDUxMjBBMgA='}]}
2025-09-02 12:11:26,316 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:26] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:30,594 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-02 12:11:32,132 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:33,412 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:32.312993+00:00, interaction_count=195, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:33,964 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:33,965 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:33,965 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:35,632 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:11:35,633 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-02 12:11:35,633 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-02 12:11:35,633 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-09-02 12:11:37,283 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:11:37,284 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-02 12:11:37,285 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-09-02 12:11:37,290 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:38,252 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNzQ5QjE5QURDOENBM0UwRAA="}]}
2025-09-02 12:11:39,524 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:39,624 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:39,766 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:39,815 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:41,070 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:39.945500+00:00, interaction_count=196, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:41,608 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:41,613 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:41,614 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNzQ5QjE5QURDOENBM0UwRAA='}]}
2025-09-02 12:11:41,614 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:12:00,940 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:12:00,940 - handlers.product_sync_handler - INFO - Product sync thread stopped.
