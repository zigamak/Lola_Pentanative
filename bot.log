2025-09-02 12:03:54,596 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:03:57,936 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:04:00,155 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:04:00,344 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:04:02,042 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:04:02,222 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:04:02,224 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:04:02,224 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:04:02,227 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:04:02,227 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:04:02,228 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:04:02,229 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:04:02,230 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:04:02,231 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:04:02,232 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:04:03,752 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:04:03,775 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:04:03,959 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:04:05,696 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:04:05,887 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:04:05,888 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:04:05,889 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:04:05,889 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:04:05,890 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:04:05,890 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:04:05,898 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:04:05,898 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:04:05,899 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:04:05,900 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:04:05,901 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:04:06,581 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:04:06,582 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:04:06,582 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:04:06,583 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:04:06,584 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:04:06,584 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:04:06,617 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:04:06,618 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:04:10,876 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 12:04:10,876 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:04:12,421 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:13,763 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:12.610308+00:00, interaction_count=162, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:14,346 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:14,348 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:04:14,348 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:15,857 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:04:16,044 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 12:04:16,044 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:04:16,045 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 12:04:16,046 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:04:18,366 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFQjBFNkNBMTlDRkQwRDMyNQA="}]}
2025-09-02 12:04:18,368 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:19,356 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg3NkUyRTg2ODNEQUFFNEMyMAA="}]}
2025-09-02 12:04:19,359 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg3NkUyRTg2ODNEQUFFNEMyMAA='}]}
2025-09-02 12:04:19,364 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:19] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:20,535 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:20,848 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:21,132 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:21,738 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:23,196 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:04:24,745 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:26,037 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:24.926269+00:00, interaction_count=163, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:26,591 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:26,592 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:26,593 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:26,593 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:04:26,594 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:04:26,594 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:04:26,595 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:04:26,595 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:04:26,596 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:04:27,545 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE0MkMyQTA2NTRCMEU1RTVGMAA="}]}
2025-09-02 12:04:27,546 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:04:27,547 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:04:28,443 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYxMzVDN0Q2Nzk2MDJBNTVDNgA="}]}
2025-09-02 12:04:28,445 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYxMzVDN0Q2Nzk2MDJBNTVDNgA='}]}
2025-09-02 12:04:28,446 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:28] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:29,470 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,057 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,099 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,195 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,416 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,517 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:31,938 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-09-02 12:04:33,450 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:34,773 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:33.631560+00:00, interaction_count=164, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:35,323 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:35,324 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:35,324 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:35,325 - handlers.base_handler - INFO - AIHandler: Handling message 'fried rice' in AI bulk order state for session 2348055614455. Original: 'Fried rice'
2025-09-02 12:04:38,276 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:04:38,303 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:39,324 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0OUM5Q0NCMENENjY3NUFBRgA="}]}
2025-09-02 12:04:39,325 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0OUM5Q0NCMENENjY3NUFBRgA='}]}
2025-09-02 12:04:39,326 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:40,658 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:41,008 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:42,875 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:04:44,389 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:45,710 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:44.576712+00:00, interaction_count=165, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:46,268 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:46,270 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:46,270 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:46,271 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:04:46,271 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:04:46,272 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:04:46,273 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:04:46,273 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:04:46,289 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:47,194 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxNzRGQjRFREMzMzhGRUM0NwA="}]}
2025-09-02 12:04:48,277 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:48,556 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:48,703 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:48,899 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:50,013 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:48.894880+00:00, interaction_count=166, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:50,310 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:04:50,554 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:50,575 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:04:50,575 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxNzRGQjRFREMzMzhGRUM0NwA='}]}
2025-09-02 12:04:50,577 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:50] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:51,813 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:53,144 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:52.004088+00:00, interaction_count=167, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:53,714 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:53,716 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:53,716 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:53,717 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:04:53,717 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:04:53,744 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:54,875 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGNUM2QkMzQkMwRjFDOTczOAA="}]}
2025-09-02 12:04:56,005 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:56,386 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:56,415 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:56,589 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:57,702 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:56.584932+00:00, interaction_count=168, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:57,807 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:04:58,243 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:58,257 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:04:58,258 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGNUM2QkMzQkMwRjFDOTczOAA='}]}
2025-09-02 12:04:58,259 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:59,314 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:05:00,624 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:59.495236+00:00, interaction_count=169, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:05:01,192 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:05:01,194 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:05:01,194 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:05:01,195 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:05:01,196 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:05:01,196 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:05:01,213 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:05:01,214 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Error: Invalid button configuration. Please try again or contact support.'}}
2025-09-02 12:05:02,216 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyN0IyRkQ0OTY0NEVDQ0MyRQA="}]}
2025-09-02 12:05:03,227 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:05:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:05:03,723 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:05:03,992 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:05:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:05:04,995 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:05:03.902828+00:00, interaction_count=170, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:05:05,552 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:05:05,563 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:05:05,564 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyN0IyRkQ0OTY0NEVDQ0MyRQA='}]}
2025-09-02 12:05:05,565 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:05:05] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:49,005 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': "He'll"}
2025-09-02 12:06:50,528 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:06:51,832 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:06:50.708552+00:00, interaction_count=171, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:06:52,404 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:06:52,405 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:06:52,405 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:06:52,419 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:06:53,384 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE2MzI5QzFGMEFFM0E5QUM5QwA="}]}
2025-09-02 12:06:54,744 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:54,854 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:06:54,859 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:55,325 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:56,152 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:06:55.038839+00:00, interaction_count=172, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:06:56,700 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:06:56,711 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:06:56,712 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE2MzI5QzFGMEFFM0E5QUM5QwA='}]}
2025-09-02 12:06:56,713 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:59,557 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_palmpay_salvation'}
2025-09-02 12:07:01,085 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:07:02,410 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:07:01.273452+00:00, interaction_count=173, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:07:02,958 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:07:02,960 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:07:02,960 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:07:04,642 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:07:04,644 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-02 12:07:04,644 - handlers.location_address_handler - INFO - Selected preset address 'Palmpay Salvation' for session 2348055614455
2025-09-02 12:07:04,645 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-09-02 12:07:06,375 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:07:06,376 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-02 12:07:06,377 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-09-02 12:07:06,399 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:07:07,405 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEzQ0YxQjNFNkM4QzczNkY2RQA="}]}
2025-09-02 12:07:08,467 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:08,859 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:08,913 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:07:09,389 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:10,243 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:07:09.093265+00:00, interaction_count=174, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:07:10,797 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:07:10,811 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:07:10,811 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEzQ0YxQjNFNkM4QzczNkY2RQA='}]}
2025-09-02 12:07:10,812 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:34,813 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:07:34,814 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 12:07:38,947 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:07:41,387 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:07:42,923 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:07:43,108 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:07:44,902 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:07:45,081 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:07:45,083 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:07:45,084 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:07:45,087 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:07:45,088 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:07:45,089 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:07:45,090 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:07:45,090 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:07:45,091 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:07:45,092 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:07:46,582 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:07:46,601 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:07:46,793 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:07:48,532 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:07:48,724 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:07:48,725 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:07:48,726 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:07:48,727 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:07:48,728 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:07:48,728 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:07:48,730 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:07:48,731 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:07:48,732 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:07:48,733 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:07:48,734 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:07:49,442 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:07:49,443 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:07:49,443 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:07:49,444 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:07:49,445 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:07:49,445 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:07:49,480 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:07:49,481 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:08:26,234 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 12:08:26,235 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:08:27,689 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:08:29,033 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:27.877563+00:00, interaction_count=175, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:08:29,719 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:08:29,719 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:08:29,720 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:08:31,203 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:08:31,386 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 12:08:31,386 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:08:31,387 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 12:08:31,387 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:08:32,423 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCQTMwMEFEOTQzQTZBRTlCNAA="}]}
2025-09-02 12:08:32,424 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:08:33,423 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2MjQ1QjlGMUQ1QkU5QjFGQQA="}]}
2025-09-02 12:08:33,425 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2MjQ1QjlGMUQ1QkU5QjFGQQA='}]}
2025-09-02 12:08:33,426 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:33] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:33,731 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:33] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,453 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,573 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,810 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,963 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:35,143 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:36,344 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:08:37,881 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:08:39,193 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:38.063345+00:00, interaction_count=176, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:08:39,758 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:08:39,758 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:08:39,758 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:08:39,759 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:08:39,759 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:08:39,759 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:08:39,759 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:08:39,760 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:08:39,760 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:08:40,738 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkyMTIyMUIwRkIxN0RBRThFQwA="}]}
2025-09-02 12:08:40,739 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:08:40,739 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:08:41,573 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkREOTIyNTE0MjQ5NDEwQzQ2MgA="}]}
2025-09-02 12:08:41,574 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkREOTIyNTE0MjQ5NDEwQzQ2MgA='}]}
2025-09-02 12:08:41,574 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:42,110 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:42,714 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:42,739 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:43,005 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:43,215 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:43,266 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:47,251 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-02 12:08:48,727 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:08:50,019 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:48.906084+00:00, interaction_count=177, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:08:50,564 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:08:50,565 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:08:50,565 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:08:50,565 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-02 12:08:53,078 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:08:53,091 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:08:54,073 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwQTNCODk4RTM1Q0MzNDQ3OAA="}]}
2025-09-02 12:08:54,074 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwQTNCODk4RTM1Q0MzNDQ3OAA='}]}
2025-09-02 12:08:54,074 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:55,253 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:55,503 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:55,685 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:57,227 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:08:58,702 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:00,192 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:58.891202+00:00, interaction_count=178, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:00,736 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:00,737 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:00,737 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:00,737 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:09:00,737 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:09:00,738 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:09:00,738 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:09:00,738 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:09:00,746 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:09:01,672 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMDNDRjNGRDFCQUQ3RTE0RgA="}]}
2025-09-02 12:09:02,721 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:02] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:02,975 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:02] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:03,148 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:03,318 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:04,438 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:03.337024+00:00, interaction_count=179, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:04,980 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:04,990 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:04,991 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMDNDRjNGRDFCQUQ3RTE0RgA='}]}
2025-09-02 12:09:04,992 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:05,034 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:09:06,508 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:07,817 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:06.702859+00:00, interaction_count=180, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:08,354 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:08,355 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:08,355 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:08,355 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:09:08,356 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:09:08,373 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:09:09,242 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJFRUIzRkM0MTRCRTJBQzM2RgA="}]}
2025-09-02 12:09:10,313 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:10,706 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:10,885 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:11,195 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:12,006 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:10.892988+00:00, interaction_count=181, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:12,567 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:12,573 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:12,573 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJFRUIzRkM0MTRCRTJBQzM2RgA='}]}
2025-09-02 12:09:12,574 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:12] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:12,865 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:09:14,320 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:15,631 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:14.505882+00:00, interaction_count=182, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:16,206 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:16,206 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:16,207 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:16,207 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:09:16,207 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:09:16,208 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:09:16,215 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:09:17,534 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY5N0Y0NzM1NEY0MEM2Rjg2QQA="}]}
2025-09-02 12:09:18,684 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:18] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:18,860 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:18] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:19,058 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:19,665 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:19] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:20,383 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:19.234220+00:00, interaction_count=183, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:20,975 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:20,982 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:20,982 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY5N0Y0NzM1NEY0MEM2Rjg2QQA='}]}
2025-09-02 12:09:20,983 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:26,079 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_palmpay_salvation'}
2025-09-02 12:09:27,542 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:28,853 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:27.719751+00:00, interaction_count=184, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:29,425 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:29,426 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:29,426 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:31,062 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:09:31,063 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-02 12:09:31,063 - handlers.location_address_handler - INFO - Selected preset address 'Palmpay Salvation' for session 2348055614455
2025-09-02 12:09:31,064 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-09-02 12:09:32,798 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:09:32,799 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-02 12:09:32,800 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-09-02 12:09:32,812 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:09:33,753 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2MTk4Q0U5NkNDMzQyRTQwNgA="}]}
2025-09-02 12:09:34,953 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:35,166 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:35,273 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:36,004 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:36] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:36,567 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:35.462989+00:00, interaction_count=185, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:37,117 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:37,123 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:37,123 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2MTk4Q0U5NkNDMzQyRTQwNgA='}]}
2025-09-02 12:09:37,124 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:37] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:08,964 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:10:08,964 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 12:10:12,785 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:10:14,253 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:10:15,812 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:10:15,993 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:10:17,682 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:10:17,873 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:10:17,874 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:10:17,874 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:10:17,876 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:10:17,876 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:10:17,876 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:10:17,877 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:10:17,877 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:10:17,878 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:10:17,878 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:10:19,343 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:10:19,351 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:10:19,547 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:10:21,310 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:10:21,493 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:10:21,493 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:10:21,494 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:10:21,494 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:10:21,494 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:10:21,495 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:10:21,496 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:10:21,496 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:10:21,496 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:10:21,497 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:10:21,497 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:10:21,935 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:10:21,935 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:10:21,935 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:10:21,936 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:10:21,936 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:10:21,936 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:10:21,960 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:10:21,961 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:10:23,763 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hwllo'}
2025-09-02 12:10:23,764 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:10:25,242 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:10:26,578 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:10:25.432294+00:00, interaction_count=186, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:10:27,136 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:10:27,137 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:10:27,137 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:10:28,608 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:10:28,795 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:10:28,795 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-02 12:10:28,796 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:10:29,873 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJCNjk3Mjk4REYzNDlEMDE4MAA="}]}
2025-09-02 12:10:29,874 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:10:30,892 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExQ0IxQUQxRTRERkVFNTZDRQA="}]}
2025-09-02 12:10:30,893 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExQ0IxQUQxRTRERkVFNTZDRQA='}]}
2025-09-02 12:10:30,894 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:31,348 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:31,893 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:31,976 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:32,005 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:32,555 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:32,673 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:34,174 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:10:35,662 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:10:36,985 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:10:35.846676+00:00, interaction_count=187, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:10:37,548 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:10:37,549 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:10:37,549 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:10:37,550 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:10:37,550 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:10:37,551 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:10:37,551 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:10:37,551 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:10:37,552 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:10:38,546 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1M0I4MTJCMjVBMEYyQTg5QQA="}]}
2025-09-02 12:10:38,548 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:10:38,549 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:10:39,433 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBNjc4QzQ3REExNzJGMzRFQQA="}]}
2025-09-02 12:10:39,437 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBNjc4QzQ3REExNzJGMzRFQQA='}]}
2025-09-02 12:10:39,439 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,104 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,577 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,668 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,895 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:41,030 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:41,155 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:50,571 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-02 12:10:52,128 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:10:53,424 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:10:52.326433+00:00, interaction_count=188, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:10:53,965 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:10:53,966 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:10:53,967 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:10:53,967 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-02 12:10:57,311 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:10:57,322 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:10:58,183 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QjQ1NTE5QURDRThERTg0MwA="}]}
2025-09-02 12:10:58,184 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QjQ1NTE5QURDRThERTg0MwA='}]}
2025-09-02 12:10:58,185 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:59,193 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:59,730 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:59,827 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:01,794 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:11:03,280 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:04,548 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:03.463914+00:00, interaction_count=189, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:05,113 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:05,114 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:05,115 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:05,115 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:11:05,115 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:11:05,115 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:11:05,116 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:11:05,116 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:11:05,123 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:06,045 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0OTVGODAyMTQxNTU0MzQ1QQA="}]}
2025-09-02 12:11:07,104 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:07,399 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:07,547 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:07,853 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:08,913 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:07.723022+00:00, interaction_count=190, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:09,481 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:09,489 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:09,489 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0OTVGODAyMTQxNTU0MzQ1QQA='}]}
2025-09-02 12:11:09,490 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:09,717 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:11:11,332 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:12,643 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:11.528603+00:00, interaction_count=191, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:13,201 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:13,203 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:13,204 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:13,208 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:11:13,213 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:11:13,329 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:14,516 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU4MjgwNEJCMDQ4ODE4MDkxRAA="}]}
2025-09-02 12:11:15,633 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:15] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:15,897 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:15] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:16,014 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:16,335 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:16] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:17,285 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:16.194908+00:00, interaction_count=192, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:17,832 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:17,837 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:17,838 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU4MjgwNEJCMDQ4ODE4MDkxRAA='}]}
2025-09-02 12:11:17,838 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:17] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:18,344 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:11:19,820 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:21,112 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:20.011376+00:00, interaction_count=193, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:21,666 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:21,667 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:21,667 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:21,668 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:11:21,668 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:11:21,668 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:11:21,674 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:22,652 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3OTAzNTM1M0FCNDUxMjBBMgA="}]}
2025-09-02 12:11:23,632 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:23] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:24,266 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:24] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:24,272 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:24,344 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:24] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:25,739 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:24.482499+00:00, interaction_count=194, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:26,303 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:26,314 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:26,314 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3OTAzNTM1M0FCNDUxMjBBMgA='}]}
2025-09-02 12:11:26,316 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:26] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:30,594 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-02 12:11:32,132 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:33,412 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:32.312993+00:00, interaction_count=195, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:33,964 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:33,965 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:33,965 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:35,632 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:11:35,633 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-02 12:11:35,633 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-02 12:11:35,633 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-09-02 12:11:37,283 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:11:37,284 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-02 12:11:37,285 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-09-02 12:11:37,290 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:38,252 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNzQ5QjE5QURDOENBM0UwRAA="}]}
2025-09-02 12:11:39,524 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:39,624 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:39,766 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:39,815 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:41,070 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:39.945500+00:00, interaction_count=196, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:41,608 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:41,613 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:41,614 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNzQ5QjE5QURDOENBM0UwRAA='}]}
2025-09-02 12:11:41,614 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:12:00,940 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:12:00,940 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 12:28:20,269 - __main__ - ERROR - Environment check failed. Please fix the issues above.
2025-09-02 12:30:35,792 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:30:38,235 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:30:44,340 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:30:45,065 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:30:51,660 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:30:52,122 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:30:52,123 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:30:52,123 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:30:52,125 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:30:52,126 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:30:52,127 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:30:52,127 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:30:52,127 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:30:52,128 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:30:52,128 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:30:56,918 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:30:56,946 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:30:57,471 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:31:00,898 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:31:01,327 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:31:01,328 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:31:01,328 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:31:01,329 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:31:01,329 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:31:01,329 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:31:01,331 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:31:01,332 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:31:01,332 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:31:01,333 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:31:01,333 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:31:01,791 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:31:01,791 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:31:01,791 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:31:01,792 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:31:01,792 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:31:01,793 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:31:01,823 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:31:01,824 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:31:03,952 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:31:03,952 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:31:07,737 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:31:10,256 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:31:08.000998+00:00, interaction_count=197, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:31:11,643 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:31:11,644 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:31:11,645 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:31:16,217 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:31:16,626 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:31:16,626 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-02 12:31:16,627 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:31:18,683 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJGRjgxMzY0OTc5N0IzQjhGRQA="}]}
2025-09-02 12:31:18,695 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:31:20,345 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:20,418 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM2MENCQTk2OTA3MjczNjkwNAA="}]}
2025-09-02 12:31:20,419 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM2MENCQTk2OTA3MjczNjkwNAA='}]}
2025-09-02 12:31:20,419 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:21,534 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:21,586 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:21,820 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:22,126 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:22] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:22,407 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:22] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:23,467 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:31:28,233 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:31:33,143 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:31:28.880782+00:00, interaction_count=198, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:31:35,788 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:31:35,789 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:31:35,789 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:31:35,789 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:31:35,789 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:31:35,790 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:31:35,790 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:31:35,790 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:31:35,791 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:31:39,441 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU5NDU0RkVBNTVGNTlCQzA4MwA="}]}
2025-09-02 12:31:39,442 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:31:39,442 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:31:41,266 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:41,329 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwMDBCMDkzQjFGMkI4M0Y1NAA="}]}
2025-09-02 12:31:41,330 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwMDBCMDkzQjFGMkI4M0Y1NAA='}]}
2025-09-02 12:31:41,330 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:42,446 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:42,573 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:42,896 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:42,898 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:43,223 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:49,807 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-02 12:31:54,020 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:31:57,615 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:31:54.502187+00:00, interaction_count=199, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:31:59,974 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:31:59,975 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:31:59,975 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:31:59,976 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-02 12:32:05,467 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:32:05,482 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:32:08,358 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxOERDMTgxQjIxMTRCRDBEQQA="}]}
2025-09-02 12:32:08,359 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxOERDMTgxQjIxMTRCRDBEQQA='}]}
2025-09-02 12:32:08,360 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:09,284 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:10,714 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:11,175 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:13,167 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:32:16,782 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:20,046 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:17.031875+00:00, interaction_count=200, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:22,176 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:22,177 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:32:22,177 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:32:22,178 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:32:22,178 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:32:22,178 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:32:22,179 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:32:22,179 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:32:22,197 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:32:24,754 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNDM1RkFCODMyQUE0QkNDNAA="}]}
2025-09-02 12:32:25,957 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:25] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:26,301 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:26] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:26,658 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:26] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:28,773 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:29,887 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:32:32,258 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:29.258875+00:00, interaction_count=201, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:33,546 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:33,565 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:33,584 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:32:33,584 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNDM1RkFCODMyQUE0QkNDNAA='}]}
2025-09-02 12:32:33,585 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:33] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:37,090 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:33.884253+00:00, interaction_count=201, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:38,602 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:38,602 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:32:38,603 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:32:38,603 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:32:38,603 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:32:38,615 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:32:39,761 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyQjE3NUY1ODk0QTY4RTMyNAA="}]}
2025-09-02 12:32:40,994 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:41,346 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:41,892 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:43,501 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:32:44,141 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:47,839 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:47,849 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:44.724267+00:00, interaction_count=203, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:49,827 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:49,832 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:32:49,833 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyQjE3NUY1ODk0QTY4RTMyNAA='}]}
2025-09-02 12:32:49,833 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:52,298 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:48.533691+00:00, interaction_count=203, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:53,663 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:53,664 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:32:53,664 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:32:53,664 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:32:53,664 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:32:53,665 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:32:53,671 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:32:54,698 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc0ODlFREMwQUJBNTRBQkE4RAA="}]}
2025-09-02 12:32:55,709 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:56,015 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:56,183 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:56,677 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:58,285 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:32:58,600 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:56.878221+00:00, interaction_count=205, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:59,239 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:59,244 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:32:59,245 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc0ODlFREMwQUJBNTRBQkE4RAA='}]}
2025-09-02 12:32:59,245 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:00,047 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:03,881 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:00.305753+00:00, interaction_count=206, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:05,898 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:05,899 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:33:05,899 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:33:05,900 - handlers.location_address_handler - INFO - User chose to enter their own address for session 2348055614455
2025-09-02 12:33:05,900 - handlers.location_address_handler - INFO - Showing address entry submenu for session 2348055614455
2025-09-02 12:33:05,907 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:33:08,195 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFBOEQxOEFGMDRDOEUyOTM2OAA="}]}
2025-09-02 12:33:09,249 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:10,254 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:11,097 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:12,714 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 12:33:15,406 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:20,672 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:23,041 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:16.119894+00:00, interaction_count=207, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:23,450 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:33:25,257 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:25,264 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:33:25,264 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFBOEQxOEFGMDRDOEUyOTM2OAA='}]}
2025-09-02 12:33:25,265 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:25] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:26,811 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:21.730990+00:00, interaction_count=207, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:30,443 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:30,443 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:33:30,444 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:33:30,444 - handlers.message_processor - WARNING - Session 2348055614455: Unexpected location state 'address_entry_submenu'. Attempting legacy handling.
2025-09-02 12:33:31,131 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:36,868 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:31.631892+00:00, interaction_count=209, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:37,842 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 12:33:37,914 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:33:37,915 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:33:37,928 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:33:40,402 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:40,403 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:33:40,403 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:33:40,403 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:33:40,415 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:33:42,362 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEQUI4QTgzRUM4OTEzMDNCOAA="}]}
2025-09-02 12:33:43,140 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVENTM5M0VBQkU1QUZGRjZCNwA="}]}
2025-09-02 12:33:43,399 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:44,243 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:44] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:44,421 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:44] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:45,231 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:45,402 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:46,401 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:46] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:47,109 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:48,609 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:33:49,669 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:50,635 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:53,014 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:47.696867+00:00, interaction_count=210, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:56,147 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:56,148 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:33:56,149 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:33:56,149 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:33:56,174 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:33:56,209 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:50.617840+00:00, interaction_count=210, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:56,217 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:56,935 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:51.459885+00:00, interaction_count=210, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:58,502 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:58,508 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:33:58,508 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEQUI4QTgzRUM4OTEzMDNCOAA='}]}
2025-09-02 12:33:58,509 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:58,830 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:58,837 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:33:58,837 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVENTM5M0VBQkU1QUZGRjZCNwA='}]}
2025-09-02 12:33:58,838 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:58,945 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc5NzNCRkM3MjIxMDE2MEY2RQA="}]}
2025-09-02 12:34:00,053 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:00,527 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:56.988725+00:00, interaction_count=211, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:34:00,751 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:01,010 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:01] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:02,870 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:34:02,871 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:34:02,871 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:34:02,872 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:34:02,882 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:34:03,031 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 12:34:03,373 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:03,694 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcwODE4NDU3RkEzREMyQTQ3NgA="}]}
2025-09-02 12:34:04,664 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:05,163 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:05] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:05,539 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:05,540 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:03.573892+00:00, interaction_count=214, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:34:06,062 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:06] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:07,037 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:07,263 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:34:07,270 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:34:07,270 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc5NzNCRkM3MjIxMDE2MEY2RQA='}]}
2025-09-02 12:34:07,271 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:15,319 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:34:16,573 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:05.977973+00:00, interaction_count=214, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:34:23,189 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:08.386264+00:00, interaction_count=214, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:34:24,053 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:34:28,548 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:34:28,549 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:34:28,549 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:34:28,550 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:34:28,561 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:34:29,817 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 12:34:30,625 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:34:30,632 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:34:30,632 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcwODE4NDU3RkEzREMyQTQ3NgA='}]}
2025-09-02 12:34:30,633 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:36,169 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQzQTZBRjk0MzU1N0M3M0FDMAA="}]}
2025-09-02 12:34:37,195 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:37] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:47,460 - utils.data_manager - ERROR - Database error while retrieving lead 2348055614455 from whatsapp_leads: connection to server at "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" (52.167.188.143), port 5432 failed: SSL SYSCALL error: EOF detected
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 851, in get_lead
    with psycopg2.connect(**self.db_params) as conn:
         ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\__init__.py", line 135, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: connection to server at "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" (52.167.188.143), port 5432 failed: SSL SYSCALL error: EOF detected

2025-09-02 12:34:47,468 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:34:47,468 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:34:47,482 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:34:47,552 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:47,965 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:47] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:49,969 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:49,970 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:34:55,554 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:34:56,219 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:58,775 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjREQzAyQkJDRjkzRTA3M0MzMwA="}]}
2025-09-02 12:34:59,818 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:00,617 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:00,972 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:35:01,533 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:54.537958+00:00, interaction_count=217, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:35:01,885 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:35:02,098 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:58.589105+00:00, interaction_count=217, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:35:02,202 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:35:02,203 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:35:02,203 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:35:02,204 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:35:02,215 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:35:02,341 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:35:02,654 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:02] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:03,169 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:35:03,850 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:35:03,851 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:35:03,851 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:35:03,852 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:35:03,852 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:35:03,852 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:35:03,858 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:35:03,999 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:35:04,154 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0ODNCQTk0OTQ4ODU0QjRBOQA="}]}
2025-09-02 12:35:04,847 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:35:01.593466+00:00, interaction_count=217, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:35:05,153 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:05] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:07,823 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:08,444 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCQkY1MkYzQThFNDUyNUJDNwA="}]}
2025-09-02 12:35:08,931 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:35:02.089964+00:00, interaction_count=217, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:35:09,474 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:09,477 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:10,494 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:35:10,496 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 13:19:32,034 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 13:19:34,264 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 13:19:36,314 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 13:19:36,951 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 13:19:39,556 - utils.data_manager - INFO - Successfully loaded 56 user details from database
2025-09-02 13:19:39,768 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 13:19:39,768 - services.payment_service - INFO - PaymentService initialized
2025-09-02 13:19:39,769 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 13:19:39,770 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:19:39,781 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 13:19:39,781 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 13:19:39,782 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 13:19:39,783 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 13:19:39,783 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 13:19:39,783 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 13:19:41,747 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 13:19:41,754 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 13:19:41,960 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 13:19:44,006 - utils.data_manager - INFO - Successfully loaded 56 user details from database
2025-09-02 13:19:44,218 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 13:19:44,219 - services.payment_service - INFO - PaymentService initialized
2025-09-02 13:19:44,219 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 13:19:44,219 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 13:19:44,220 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 13:19:44,220 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 13:19:44,233 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 13:19:44,234 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 13:19:44,234 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 13:19:44,234 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 13:19:44,235 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 13:19:44,710 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 13:19:44,711 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 13:19:44,711 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 13:19:44,712 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 13:19:44,712 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 13:19:44,713 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 13:19:44,746 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 13:19:44,747 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 13:20:55,533 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 13:20:55,533 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 13:20:57,673 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 13:20:59,315 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 12:20:57.878609+00:00, interaction_count=219, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 13:21:00,109 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 13:21:00,111 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 13:21:00,111 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 13:21:02,310 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 13:21:02,617 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 13:21:02,618 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 13:21:02,619 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 13:21:02,620 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 13:21:03,419 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-09-02 13:21:03,423 - services.whatsapp_service - ERROR - Failed to send image to 2348055614455. Aborting button message.
2025-09-02 13:21:03,427 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 13:21:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 13:24:41,962 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:24:42,013 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:29:42,022 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:29:42,027 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:34:42,032 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:34:42,040 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:39:42,055 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:39:42,059 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:44:42,062 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:44:42,066 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:49:42,070 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:49:42,074 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:54:42,087 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:54:42,089 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:59:42,097 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:59:42,099 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:04:42,100 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:04:42,102 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:09:42,117 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:09:42,119 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:14:42,125 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:14:42,126 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:19:42,130 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:19:42,134 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:22:30,767 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 14:22:30,769 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 14:43:49,887 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 14:43:51,669 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 14:43:54,466 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 14:43:54,694 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 14:43:56,618 - utils.data_manager - INFO - Successfully loaded 56 user details from database
2025-09-02 14:43:56,903 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 14:43:56,904 - services.payment_service - INFO - PaymentService initialized
2025-09-02 14:43:56,904 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 14:43:56,905 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:43:56,906 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 14:43:56,906 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 14:43:56,907 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 14:43:56,907 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 14:43:56,907 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 14:43:56,908 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 14:43:58,661 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 14:43:58,682 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 14:43:58,873 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 14:44:00,753 - utils.data_manager - INFO - Successfully loaded 56 user details from database
2025-09-02 14:44:00,956 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 14:44:00,957 - services.payment_service - INFO - PaymentService initialized
2025-09-02 14:44:00,957 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 14:44:00,957 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 14:44:00,958 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 14:44:00,958 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 14:44:00,959 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 14:44:00,960 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 14:44:00,960 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 14:44:00,960 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 14:44:00,961 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 14:44:01,526 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 14:44:01,526 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 14:44:01,526 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 14:44:01,527 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 14:44:01,527 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 14:44:01,528 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 14:44:01,552 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 14:44:01,553 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 14:44:01,842 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 14:44:01,842 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 14:44:03,589 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:05,206 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:03.789105+00:00, interaction_count=220, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:05,864 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:05,865 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 14:44:05,865 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:44:07,520 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 14:44:07,721 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 14:44:07,721 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:44:07,722 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 14:44:07,722 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 14:44:09,081 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyQ0I5QTUxQTlCQTE4QkI0NQA="}]}
2025-09-02 14:44:09,093 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:44:09,800 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFRDYwQjhFNjc2QjAxOTk0QQA="}]}
2025-09-02 14:44:09,801 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFRDYwQjhFNjc2QjAxOTk0QQA='}]}
2025-09-02 14:44:09,802 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:10,807 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:11,451 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:11,793 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:11,814 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:11,888 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:12,110 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:12] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:27,634 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 14:44:29,307 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:30,792 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:29.540287+00:00, interaction_count=221, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:31,465 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:31,466 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:44:31,466 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:44:31,466 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 14:44:31,466 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 14:44:31,467 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 14:44:31,467 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 14:44:31,467 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 14:44:31,468 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 14:44:32,215 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEwOEQ4NDg3QTM5OTZENjc3MAA="}]}
2025-09-02 14:44:32,216 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 14:44:32,216 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 14:44:32,962 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNEOUFGMTVGQkU3MkNBMzhGMwA="}]}
2025-09-02 14:44:32,963 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNEOUFGMTVGQkU3MkNBMzhGMwA='}]}
2025-09-02 14:44:32,964 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,134 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,625 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,665 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,747 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,986 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:35,029 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:35,150 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:35,175 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:39,963 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-02 14:44:41,965 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:44,100 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:42.164731+00:00, interaction_count=222, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:44,698 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:44,699 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:44:44,700 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:44:44,700 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-02 14:44:47,505 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 14:44:47,521 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:44:48,308 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYyRDM2MUQzM0MxQTg5Mzg0RgA="}]}
2025-09-02 14:44:48,309 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYyRDM2MUQzM0MxQTg5Mzg0RgA='}]}
2025-09-02 14:44:48,310 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:49,425 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:49,473 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:49,524 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:49,592 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:51,275 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 14:44:52,981 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:54,505 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:53.186855+00:00, interaction_count=223, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:55,124 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:55,125 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:44:55,125 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:44:55,125 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 14:44:55,125 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 14:44:55,126 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:44:55,126 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 14:44:55,126 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 14:44:55,133 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:44:55,908 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4QkEwMUQxRDBGMzVFM0YyRAA="}]}
2025-09-02 14:44:56,939 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:57,241 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:57,365 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:57,475 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:57,699 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:58,720 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 14:44:59,142 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:57.897203+00:00, interaction_count=224, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:59,781 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:59,789 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:44:59,789 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4QkEwMUQxRDBGMzVFM0YyRAA='}]}
2025-09-02 14:44:59,790 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:00,388 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:01,893 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:00.581619+00:00, interaction_count=225, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:02,542 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:02,543 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:02,543 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:02,544 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 14:45:02,544 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:45:02,555 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:03,378 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVDOEFFMkRCNjlFNEZFMjUxNQA="}]}
2025-09-02 14:45:04,700 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:04,831 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:04,833 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:04,992 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:05,017 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:06,502 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:05.220094+00:00, interaction_count=226, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:06,757 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 14:45:07,095 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:07,100 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:07,101 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVDOEFFMkRCNjlFNEZFMjUxNQA='}]}
2025-09-02 14:45:07,101 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:09,083 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:10,584 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:09.285568+00:00, interaction_count=227, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:11,385 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:11,386 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:11,387 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:11,387 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 14:45:11,387 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 14:45:11,387 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 14:45:11,394 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:12,388 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZBNUY1RDQxNDc4NEU2M0NBMQA="}]}
2025-09-02 14:45:13,511 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:13] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:13,558 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:13] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:13,650 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:13] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:13,746 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:13] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:14,132 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:15,439 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 14:45:15,637 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:14.339371+00:00, interaction_count=228, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:16,258 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:16,263 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:16,264 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZBNUY1RDQxNDc4NEU2M0NBMQA='}]}
2025-09-02 14:45:16,264 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:16] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:17,113 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:18,612 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:17.326594+00:00, interaction_count=229, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:19,252 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:19,253 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:19,253 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:19,254 - handlers.location_address_handler - INFO - User chose to enter their own address for session 2348055614455
2025-09-02 14:45:19,254 - handlers.location_address_handler - INFO - Showing address entry submenu for session 2348055614455
2025-09-02 14:45:19,259 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:20,110 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBNUM0QTFDMTFBREI1MzM5OAA="}]}
2025-09-02 14:45:21,127 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:21,495 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:22,486 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:23,683 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 14:45:24,213 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:22.827013+00:00, interaction_count=230, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:24,828 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:24,834 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:24,834 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBNUM0QTFDMTFBREI1MzM5OAA='}]}
2025-09-02 14:45:24,835 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:24] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:25,499 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:26,989 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:25.700861+00:00, interaction_count=231, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:27,595 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:27,596 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:27,596 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:27,596 - handlers.message_processor - WARNING - Session 2348055614455: Unexpected location state 'address_entry_submenu'. Attempting legacy handling.
2025-09-02 14:45:29,484 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 14:45:29,484 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:45:29,496 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:30,291 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzRDEzMTZDRDA3OTlERTlGRgA="}]}
2025-09-02 14:45:31,572 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:31,588 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:31,630 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:31,654 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:32,025 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:32,783 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 14:45:33,577 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:32.232048+00:00, interaction_count=232, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:34,191 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:34,197 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:34,197 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzRDEzMTZDRDA3OTlERTlGRgA='}]}
2025-09-02 14:45:34,199 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:34,610 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:36,196 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:34.827008+00:00, interaction_count=233, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:36,900 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:36,901 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:36,901 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:36,901 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 14:45:36,901 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 14:45:36,902 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 14:45:36,908 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:37,624 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4QThCRkU2MTg0NzQzOEE4MQA="}]}
2025-09-02 14:45:38,753 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:38,943 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:39,012 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:39,064 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:39,335 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:40,784 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:39.539976+00:00, interaction_count=234, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:41,403 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:41,409 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:41,409 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4QThCRkU2MTg0NzQzOEE4MQA='}]}
2025-09-02 14:45:41,410 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:42,397 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 14:45:44,102 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:45,734 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:44.297703+00:00, interaction_count=235, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:46,393 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:46,393 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:46,394 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:46,394 - handlers.location_address_handler - INFO - User chose to enter their own address for session 2348055614455
2025-09-02 14:45:46,394 - handlers.location_address_handler - INFO - Showing address entry submenu for session 2348055614455
2025-09-02 14:45:46,400 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:47,107 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVCRERBMzg3NEE3NzI0MkNFOAA="}]}
2025-09-02 14:45:48,354 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:48,376 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:48,548 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:48,646 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:48,936 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:49,711 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'type_address_manually'}
2025-09-02 14:45:50,543 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:49.141679+00:00, interaction_count=236, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:51,171 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:51,177 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:51,177 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVCRERBMzg3NEE3NzI0MkNFOAA='}]}
2025-09-02 14:45:51,178 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:51] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:51,380 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:52,978 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:51.578044+00:00, interaction_count=237, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:53,623 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:53,624 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:53,624 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:53,625 - handlers.message_processor - WARNING - Session 2348055614455: Unexpected location state 'address_entry_submenu'. Attempting legacy handling.
2025-09-02 14:45:55,550 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 14:45:55,550 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:45:55,565 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:56,370 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxQzQ5NTVBM0FEODg2QjA5MwA="}]}
2025-09-02 14:45:57,478 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:57,731 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:57,834 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:57,836 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:58,099 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:59,568 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:58.306585+00:00, interaction_count=238, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:46:00,183 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:46:00,188 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:46:00,189 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxQzQ5NTVBM0FEODg2QjA5MwA='}]}
2025-09-02 14:46:00,189 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:48:58,896 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:49:00,825 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 14:54:01,035 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:54:03,119 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 14:59:03,335 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:59:05,587 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:04:05,793 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:04:07,769 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:09:07,980 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:09:16,870 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:14:17,118 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:14:19,545 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:19:19,765 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:19:22,015 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:24:22,228 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:24:24,199 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:29:24,403 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:29:33,035 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:34:33,258 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:34:36,140 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:39:36,461 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:39:36,513 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 15:44:36,516 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:44:36,518 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 15:49:36,528 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:49:36,530 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 15:54:36,546 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:54:36,550 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 15:59:36,563 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:59:36,564 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 16:04:36,568 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 16:04:36,570 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 16:09:36,584 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 16:09:36,588 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 16:10:21,946 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 16:10:21,949 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:15:18,121 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:15:19,141 - __main__ - ERROR - Import error: No module named 'services.session_manager'
2025-09-03 19:15:39,190 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:15:39,785 - __main__ - ERROR - Import error: No module named 'services.session_manager'
2025-09-03 19:15:54,480 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:15:56,323 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:15:58,179 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:15:58,370 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:16:00,080 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:16:00,270 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:16:00,277 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:16:00,278 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:16:00,295 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:16:00,294 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:16:00,297 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:16:00,300 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:16:00,302 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:16:00,303 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:16:00,305 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:16:01,820 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:16:01,856 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:16:02,070 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:16:04,099 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:16:04,289 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:16:04,290 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:16:04,290 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:16:04,290 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:16:04,290 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:16:04,291 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:16:04,292 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:16:04,293 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:16:04,293 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:16:04,293 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:16:04,294 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:16:04,883 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:16:04,884 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:16:04,884 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:16:04,885 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:16:04,886 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:16:04,886 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:16:04,943 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:16:04,945 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:18:46,082 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:18:46,082 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:19:23,313 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:19:25,004 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:19:26,548 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:19:26,739 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:19:28,441 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:19:28,639 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:19:28,640 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:19:28,640 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:19:28,642 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:19:28,642 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:19:28,642 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:19:28,643 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:19:28,643 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:19:28,644 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:19:28,644 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:19:30,153 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:19:30,179 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:19:30,380 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:19:32,109 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:19:32,301 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:19:32,301 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:19:32,301 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:19:32,302 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:19:32,302 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:19:32,302 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:19:32,313 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:19:32,314 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:19:32,314 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:19:32,314 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:19:32,315 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:19:32,848 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:19:32,848 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:19:32,848 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:19:32,849 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:19:32,849 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:19:32,849 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:19:32,866 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:19:32,866 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:19:33,137 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:19:33,138 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:19:34,659 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:19:35,998 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:19:34.850267+00:00, interaction_count=239, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:19:36,579 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:19:36,580 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:19:36,580 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:19:38,119 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:19:38,309 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:19:38,309 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:19:38,310 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-03 19:19:38,310 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:19:39,718 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJBN0M0NzE0OEE0NjcyMkQyMAA="}]}
2025-09-03 19:19:39,720 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:19:40,669 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0MjM5QjcxRURFNDNCMUZGQQA="}]}
2025-09-03 19:19:40,670 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0MjM5QjcxRURFNDNCMUZGQQA='}]}
2025-09-03 19:19:40,682 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:40] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:42,319 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:42,853 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:42,919 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:43,501 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:43] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:45,391 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:19:46,921 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:19:48,249 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:19:47.108529+00:00, interaction_count=240, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:19:48,818 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:19:48,819 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:19:48,820 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:19:48,820 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:19:48,821 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:19:48,821 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:19:48,821 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:19:48,822 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:19:48,822 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:19:50,259 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEwQzFFODIzNTg3MERCMENDOQA="}]}
2025-09-03 19:19:50,260 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:19:50,261 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:19:51,199 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYzRDNFNTExMTI3QjlBMENGOQA="}]}
2025-09-03 19:19:51,199 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYzRDNFNTExMTI3QjlBMENGOQA='}]}
2025-09-03 19:19:51,200 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:51] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:52,317 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:52,929 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:53,050 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:53,082 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:53,301 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:53,460 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:58,886 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-03 19:20:00,408 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:01,940 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:00.599076+00:00, interaction_count=241, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:02,508 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:02,509 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:20:02,509 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:20:02,510 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-03 19:20:06,541 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:20:06,557 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:20:07,649 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ0RUE3MEI0ODdGQkRDMzFFMQA="}]}
2025-09-03 19:20:07,650 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ0RUE3MEI0ODdGQkRDMzFFMQA='}]}
2025-09-03 19:20:07,651 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:08,659 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:09,452 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:09] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:11,091 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:20:12,658 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:14,009 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:12.848838+00:00, interaction_count=242, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:14,578 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:14,579 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:20:14,579 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:20:14,579 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:20:14,580 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:20:14,580 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:20:14,580 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:20:14,581 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:20:14,590 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:20:15,519 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE4REUyN0I3M0MzQzBEQzM4RAA="}]}
2025-09-03 19:20:16,754 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:16,833 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:17,058 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:17,087 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:18,410 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:17.249574+00:00, interaction_count=243, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:18,531 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:20:19,078 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:19,098 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:20:19,098 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE4REUyN0I3M0MzQzBEQzM4RAA='}]}
2025-09-03 19:20:19,099 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:19] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:20,070 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:21,418 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:20.269444+00:00, interaction_count=244, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:21,988 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:21,989 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:20:21,989 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:20:21,990 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:20:21,990 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:20:22,003 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:20:22,929 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwQkY2QTEwQUI1NDg5NTU2OQA="}]}
2025-09-03 19:20:24,179 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:24,451 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:24,530 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:24,926 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:26,060 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:20:26,273 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:25.118571+00:00, interaction_count=245, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:26,848 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:26,855 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:20:26,855 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwQkY2QTEwQUI1NDg5NTU2OQA='}]}
2025-09-03 19:20:26,856 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:27,590 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:28,968 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:27.782368+00:00, interaction_count=246, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:29,582 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:29,583 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:20:29,583 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:20:29,584 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:20:29,584 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_address_handler' with message 'initiate_address_collection'.
2025-09-03 19:20:29,584 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'location_address_handler', state 'address_collection_menu', message 'initiate_address_collection'. Resetting to greeting.
2025-09-03 19:20:29,585 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:20:29,585 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-03 19:20:29,585 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:20:30,711 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0OEQ2M0JBMjBENEQ2Q0VCOAA="}]}
2025-09-03 19:20:30,712 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:20:31,875 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:32,271 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4NUEzQjA2QTgzQ0ZFOTZEMwA="}]}
2025-09-03 19:20:32,491 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:33,359 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:33,561 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:33,682 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:33,798 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:35,128 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:33.990595+00:00, interaction_count=247, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:35,709 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:35,716 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:20:35,717 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4NUEzQjA2QTgzQ0ZFOTZEMwA='}]}
2025-09-03 19:20:35,717 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:46,707 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:21:48,349 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:21:49,698 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:21:48.538034+00:00, interaction_count=248, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:21:50,257 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:21:50,258 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:21:50,258 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:21:50,259 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:21:50,259 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:21:50,259 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-03 19:21:50,259 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:21:51,278 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFM0M3NDk2MTFERjI0QTAyRQA="}]}
2025-09-03 19:21:51,279 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:21:52,259 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1QkVDNzlFRUI1N0NFRTdEMgA="}]}
2025-09-03 19:21:52,260 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1QkVDNzlFRUI1N0NFRTdEMgA='}]}
2025-09-03 19:21:52,260 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:52,502 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:53,271 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:53,508 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:53,921 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:16,695 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:22:16,696 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:22:30,286 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:22:31,562 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:22:33,107 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:22:33,298 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:22:34,999 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:22:35,182 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:22:35,182 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:22:35,183 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:22:35,184 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:22:35,184 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:22:35,185 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:22:35,185 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:22:35,186 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:22:35,186 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:22:35,186 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:22:36,697 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:22:36,707 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:22:36,898 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:22:38,648 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:22:38,838 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:22:38,839 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:22:38,839 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:22:38,839 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:22:38,840 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:22:38,840 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:22:38,841 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:22:38,841 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:22:38,841 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:22:38,842 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:22:38,842 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:22:39,217 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:22:39,217 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:22:39,218 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:22:39,218 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:22:39,219 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:22:39,219 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:22:39,239 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:22:39,239 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:22:39,921 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:39] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:40,102 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:22:40,102 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:22:41,119 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:41,608 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:22:42,925 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:22:41.797908+00:00, interaction_count=249, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:22:43,497 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:22:43,497 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:22:43,498 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:22:45,114 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:22:45,308 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:22:45,308 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:22:45,308 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-03 19:22:45,309 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:22:46,418 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCNjFDRTM0M0E4M0EzM0YyMQA="}]}
2025-09-03 19:22:46,419 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:22:47,279 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0NDVFMTBFRTlFNUNDMzUyMgA="}]}
2025-09-03 19:22:47,280 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0NDVFMTBFRTlFNUNDMzUyMgA='}]}
2025-09-03 19:22:47,280 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:47,805 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,479 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,601 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,659 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,930 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,979 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:49,839 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:22:51,468 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:22:52,788 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:22:51.661628+00:00, interaction_count=250, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:22:53,348 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:22:53,349 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:22:53,349 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:22:53,350 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:22:53,350 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:22:53,350 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:22:53,351 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:22:53,351 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:22:53,351 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:22:54,448 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI1RUNERTE4OUMyNTIwMTkwRAA="}]}
2025-09-03 19:22:54,449 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:22:54,449 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:22:55,409 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVENDYwMUI0Q0NBMjY3Q0YyOAA="}]}
2025-09-03 19:22:55,410 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVENDYwMUI0Q0NBMjY3Q0YyOAA='}]}
2025-09-03 19:22:55,411 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:55] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:55,704 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:55] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:56,479 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:56,598 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:56,760 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:56,990 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:57,018 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:00,078 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-03 19:23:01,612 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:02,938 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:01.808502+00:00, interaction_count=251, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:03,496 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:03,497 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:03,497 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:03,498 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-03 19:23:06,048 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:23:06,057 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:07,048 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlCQzM1RDQ0QkVERTVEM0RGMQA="}]}
2025-09-03 19:23:07,049 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlCQzM1RDQ0QkVERTVEM0RGMQA='}]}
2025-09-03 19:23:07,050 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:08,279 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:08,500 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:08,601 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:09,701 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:23:11,268 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:12,598 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:11.458066+00:00, interaction_count=252, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:13,167 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:13,168 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:13,168 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:13,169 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:23:13,169 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:23:13,169 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:23:13,170 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:23:13,170 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:23:13,177 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:14,190 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyMTQ3ODVGQjEzNTIyMUQxMwA="}]}
2025-09-03 19:23:15,159 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:15,502 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:15,718 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:15,860 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:17,044 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:15.908193+00:00, interaction_count=253, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:17,621 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:17,628 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:23:17,628 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyMTQ3ODVGQjEzNTIyMUQxMwA='}]}
2025-09-03 19:23:17,629 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:17,691 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:23:19,199 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:20,527 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:19.388644+00:00, interaction_count=254, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:21,128 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:21,129 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:21,129 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:21,129 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:23:21,130 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:23:21,142 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:22,048 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5QzNCNDZFODVGQzM2RUQxOAA="}]}
2025-09-03 19:23:23,119 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:23,567 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:23,641 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:24,889 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:23:24,898 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:23.757667+00:00, interaction_count=255, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:25,598 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:25,605 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:23:25,605 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5QzNCNDZFODVGQzM2RUQxOAA='}]}
2025-09-03 19:23:25,605 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:26,448 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:27,779 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:26.638260+00:00, interaction_count=256, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:28,347 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:28,348 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:28,348 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:28,349 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:23:28,349 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:23:28,349 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-03 19:23:28,355 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:29,288 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE2ODcyQzQyNUZDQjlDOTE1NwA="}]}
2025-09-03 19:23:30,244 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:30,659 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:30,781 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:30,808 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:32,138 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:31.000949+00:00, interaction_count=257, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:32,787 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:32,794 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:23:32,794 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE2ODcyQzQyNUZDQjlDOTE1NwA='}]}
2025-09-03 19:23:32,795 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:35,494 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_palmpay_salvation'}
2025-09-03 19:23:37,018 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:38,348 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:37.209081+00:00, interaction_count=258, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:39,138 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:39,139 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:39,139 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:39,140 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'location_address_handler', state 'address_collection_menu', message 'preset_palmpay_salvation'. Resetting to greeting.
2025-09-03 19:23:39,140 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:23:39,141 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-03 19:23:39,141 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:23:40,197 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBMDVFOEQwNjJDMzczRjExNQA="}]}
2025-09-03 19:23:40,198 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:41,088 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBNTVGNTg3RDQ1ODFFODIzRAA="}]}
2025-09-03 19:23:41,395 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,173 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,300 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,369 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,479 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,638 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:42,658 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:43,987 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:42.829311+00:00, interaction_count=259, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:44,557 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:44,564 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:23:44,564 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBNTVGNTg3RDQ1ODFFODIzRAA='}]}
2025-09-03 19:23:44,565 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:24:35,269 - handlers.webhook_handler - WARNING - No valid message data extracted for 2348055614455. Message type: sticker
2025-09-03 19:24:35,269 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:24:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:24:40,838 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:24:40,839 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:27:57,492 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:27:59,141 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:28:00,957 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:28:01,157 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:28:02,897 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:28:03,088 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:28:03,088 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:28:03,089 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:28:03,090 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:28:03,090 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:28:03,090 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:28:03,091 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:28:03,091 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:28:03,092 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:28:03,092 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:28:04,606 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:28:04,607 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:28:04,797 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:28:06,499 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:28:06,688 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:28:06,688 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:28:06,688 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:28:06,689 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:28:06,689 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:28:06,689 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:28:06,691 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:28:06,691 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:28:06,691 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:28:06,692 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:28:06,692 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:28:07,106 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:28:07,107 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:28:07,107 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:28:07,108 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:28:07,108 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:28:07,109 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:28:07,145 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:28:07,146 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:28:07,620 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:28:07,620 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:28:09,139 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:10,497 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:09.327268+00:00, interaction_count=260, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:11,067 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:11,068 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:28:11,068 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:12,597 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:28:12,787 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:28:12,788 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:28:12,788 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-03 19:28:12,789 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:28:13,918 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY3OEM2MjUyN0E1MDJERUNGNQA="}]}
2025-09-03 19:28:13,929 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:15,078 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:15,077 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM0QkMzQkQ0MjFBNzQ5REFENgA="}]}
2025-09-03 19:28:15,080 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM0QkMzQkQ0MjFBNzQ5REFENgA='}]}
2025-09-03 19:28:15,081 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,008 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,145 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,309 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,417 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,748 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:17,467 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:28:18,996 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:20,317 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:19.186964+00:00, interaction_count=261, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:21,987 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:21,987 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:21,988 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:21,988 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:28:21,988 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:28:21,989 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:28:21,989 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:28:21,989 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:28:21,990 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:28:22,997 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI2RjdDNjE1NUVBNDFBMDQ1QwA="}]}
2025-09-03 19:28:22,998 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:28:22,998 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:28:23,869 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4NEUzMjc2MjA2MTBGNjMyNgA="}]}
2025-09-03 19:28:23,870 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4NEUzMjc2MjA2MTBGNjMyNgA='}]}
2025-09-03 19:28:23,870 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:24,058 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:24,927 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:25,018 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:25,150 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:25,448 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:25,809 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:27,289 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-03 19:28:28,827 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:30,161 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:29.016547+00:00, interaction_count=262, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:30,726 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:30,727 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:30,727 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:30,728 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-03 19:28:33,308 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:28:33,321 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:34,197 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ3MjcxMkE5Nzg3MEM5Njc1RQA="}]}
2025-09-03 19:28:34,198 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ3MjcxMkE5Nzg3MEM5Njc1RQA='}]}
2025-09-03 19:28:34,199 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:35,243 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:35,542 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:35,708 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:40,059 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:28:41,587 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:42,917 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:41.776460+00:00, interaction_count=263, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:43,486 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:43,487 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:43,487 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:43,487 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:28:43,488 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:28:43,488 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:28:43,488 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:28:43,488 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:28:43,494 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:44,408 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzQTE3NEM1RDQwMEM1REU2OAA="}]}
2025-09-03 19:28:45,413 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:45,708 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:45,938 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:45,959 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:47,069 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:28:47,287 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:46.137315+00:00, interaction_count=264, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:47,857 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:47,877 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:28:47,878 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzQTE3NEM1RDQwMEM1REU2OAA='}]}
2025-09-03 19:28:47,878 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:48,597 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:49,927 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:48.787298+00:00, interaction_count=265, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:50,517 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:50,518 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:50,518 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:50,518 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:28:50,519 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:28:50,531 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:51,447 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNFQkMzRERBOTBBRjM0MzAzMwA="}]}
2025-09-03 19:28:52,748 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:52,969 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:53,006 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:53,089 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:54,347 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:53.187680+00:00, interaction_count=266, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:54,917 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:54,924 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:28:54,924 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNFQkMzRERBOTBBRjM0MzAzMwA='}]}
2025-09-03 19:28:54,924 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:55,080 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:28:56,607 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:57,947 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:56.797303+00:00, interaction_count=267, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:58,517 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:58,518 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:58,518 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:58,518 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:28:58,519 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:28:58,519 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-03 19:28:58,525 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:59,427 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDNUI4Nzg5NkQ3OENFOUZEMAA="}]}
2025-09-03 19:29:00,487 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:00,926 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:00,941 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:01,057 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:02,417 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:01.246731+00:00, interaction_count=268, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:02,986 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:02,992 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:29:02,992 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDNUI4Nzg5NkQ3OENFOUZEMAA='}]}
2025-09-03 19:29:02,993 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:02] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:03,228 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-03 19:29:04,758 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:06,120 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:04.947170+00:00, interaction_count=269, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:06,717 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:06,718 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:29:06,718 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:29:08,516 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:29:08,517 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-03 19:29:08,517 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-03 19:29:08,518 - handlers.location_address_handler - INFO - Redirecting back to order confirmation after address update for session 2348055614455
2025-09-03 19:29:10,227 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:29:10,228 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-03 19:29:10,228 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'show_order_confirmation_after_address_update'.
2025-09-03 19:29:10,245 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:29:11,278 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFRTdEQUEzMTU0NzcxQ0QwRAA="}]}
2025-09-03 19:29:12,573 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:12] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:12,787 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:12] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:12,847 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:12,850 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:12] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:14,187 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:13.047260+00:00, interaction_count=270, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:14,747 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:14,753 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:29:14,754 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFRTdEQUEzMTU0NzcxQ0QwRAA='}]}
2025-09-03 19:29:14,754 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:14] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:51,808 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:29:53,427 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:54,766 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:53.616691+00:00, interaction_count=271, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:55,336 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:55,337 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:29:55,337 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:29:55,338 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:29:55,338 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:29:55,338 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-03 19:29:55,344 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:29:56,347 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM4QUJENTg5NTBBMEIyNzE3MAA="}]}
2025-09-03 19:29:57,397 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:57,728 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:57,886 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:58,238 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:58] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:59,246 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:58.096806+00:00, interaction_count=272, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:59,816 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:59,822 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:29:59,822 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM4QUJENTg5NTBBMEIyNzE3MAA='}]}
2025-09-03 19:29:59,823 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:30:36,297 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:30:36,298 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:32:08,076 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:32:09,623 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:32:11,245 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:32:11,447 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:32:13,147 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:32:13,337 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:32:13,338 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:32:13,338 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:32:13,339 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:32:13,340 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:32:13,340 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:32:13,341 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:32:13,341 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:32:13,342 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:32:13,348 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:32:14,855 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:32:14,868 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:32:15,056 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:32:16,756 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:32:16,947 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:32:16,947 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:32:16,947 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:32:16,947 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:32:16,948 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:32:16,948 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:32:16,948 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:32:16,949 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:32:16,949 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:32:16,949 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:32:16,950 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:32:17,355 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:32:17,355 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:32:17,355 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:32:17,356 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:32:17,356 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:32:17,356 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:32:17,368 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:32:17,369 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:33:24,258 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hell'}
2025-09-03 19:33:24,258 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:33:26,068 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:33:27,418 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:33:26.266539+00:00, interaction_count=273, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:33:27,995 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:33:27,997 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:33:27,997 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:33:29,558 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:33:29,756 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:33:29,757 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-03 19:33:29,757 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:33:30,857 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJFNDA0QzY3ODQ0RDcxNUU3MQA="}]}
2025-09-03 19:33:30,858 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:33:31,854 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNGRDg4OUQ1NThENzk3ODI5MQA="}]}
2025-09-03 19:33:31,855 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNGRDg4OUQ1NThENzk3ODI5MQA='}]}
2025-09-03 19:33:31,856 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:32,407 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,026 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,073 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,308 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,510 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,529 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:37,398 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:33:38,938 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:33:41,231 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:33:39.129210+00:00, interaction_count=274, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:33:41,796 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:33:41,797 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:33:41,797 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:33:41,797 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:33:41,798 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:33:41,798 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:33:41,798 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:33:41,799 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:33:41,799 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:33:42,851 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBGOThBMTNDN0Q3NDFFQzk1MwA="}]}
2025-09-03 19:33:42,851 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:33:42,852 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:33:43,726 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwRjg1MTdENzYxNzcyODg0MAA="}]}
2025-09-03 19:33:43,727 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwRjg1MTdENzYxNzcyODg0MAA='}]}
2025-09-03 19:33:43,728 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:43] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:44,713 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,220 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,287 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,338 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,639 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,658 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:46,858 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-03 19:33:48,355 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:33:49,696 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:33:48.546585+00:00, interaction_count=275, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:33:50,265 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:33:50,266 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:33:50,266 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:33:50,266 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-03 19:33:53,457 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:33:53,466 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:33:54,498 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3MUY4N0Y4MjdBN0M4NkI5QgA="}]}
2025-09-03 19:33:54,499 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3MUY4N0Y4MjdBN0M4NkI5QgA='}]}
2025-09-03 19:33:54,500 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:55,602 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:55] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:56,032 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:56,192 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:58,228 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:33:59,756 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:01,106 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:33:59.946419+00:00, interaction_count=276, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:01,686 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:01,687 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:34:01,687 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:34:01,688 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:34:01,688 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:34:01,689 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:34:01,689 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:34:01,689 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:34:01,696 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:34:02,886 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgxQTUxNzAwRUZFOEIwNUI1OQA="}]}
2025-09-03 19:34:03,881 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:03] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:04,268 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:04] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:04,391 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:04] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:04,455 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:05,606 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:34:05,796 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:04.656137+00:00, interaction_count=277, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:06,357 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:06,364 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:34:06,364 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgxQTUxNzAwRUZFOEIwNUI1OQA='}]}
2025-09-03 19:34:06,365 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:06] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:07,167 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:08,516 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:07.356318+00:00, interaction_count=278, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:09,086 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:09,087 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:34:09,087 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:34:09,087 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:34:09,088 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:34:09,102 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:34:10,097 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlBMDdFRDE5QzFGRkI1MzhBMAA="}]}
2025-09-03 19:34:11,146 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:11] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:11,498 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:11] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:11,656 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:11,737 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:11] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:12,688 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:34:13,066 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:11.846165+00:00, interaction_count=279, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:13,618 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:13,624 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:34:13,625 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlBMDdFRDE5QzFGRkI1MzhBMAA='}]}
2025-09-03 19:34:13,625 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:13] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:14,217 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:15,616 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:14.422798+00:00, interaction_count=280, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:16,186 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:16,187 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:34:16,187 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:34:16,187 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:34:16,188 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:34:16,194 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:34:17,137 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwRjMyQzIzQTE5NTFDMjhFRAA="}]}
2025-09-03 19:34:18,088 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:18] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:18,428 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:18] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:18,697 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:18] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:19,586 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:19,629 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-03 19:34:20,916 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:19.776251+00:00, interaction_count=281, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:21,155 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:21,498 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:21,505 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:34:21,514 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwRjMyQzIzQTE5NTFDMjhFRAA='}]}
2025-09-03 19:34:21,515 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:22,555 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:21.347204+00:00, interaction_count=281, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:23,101 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:23,102 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:34:23,102 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:34:24,878 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:34:24,879 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-03 19:34:24,879 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-03 19:34:24,880 - handlers.location_address_handler - INFO - Redirecting back to order confirmation after address update for session 2348055614455
2025-09-03 19:34:26,616 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:34:26,617 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-03 19:34:26,617 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'show_order_confirmation_after_address_update'.
2025-09-03 19:34:26,618 - handlers.order_handler - INFO - Showing order confirmation after address update for session 2348055614455
2025-09-03 19:34:26,618 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:34:26,629 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:34:27,576 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyMzc2RDREN0QyNjEzRUY2QgA="}]}
2025-09-03 19:34:28,652 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:29,006 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:29] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:29,030 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:29] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:29,116 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:30,567 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:29.306186+00:00, interaction_count=283, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:31,168 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:31,175 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:34:31,175 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyMzc2RDREN0QyNjEzRUY2QgA='}]}
2025-09-03 19:34:31,176 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:07,056 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:35:07,057 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:35:09,708 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:35:10,899 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:35:12,586 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:35:12,782 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:35:14,512 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:35:14,768 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:35:14,769 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:35:14,769 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:35:14,770 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:35:14,771 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:35:14,771 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:35:14,772 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:35:14,772 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:35:14,773 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:35:14,773 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:35:16,295 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:35:16,340 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:35:16,576 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:35:18,296 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:35:18,486 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:35:18,487 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:35:18,487 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:35:18,487 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:35:18,487 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:35:18,488 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:35:18,488 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:35:18,489 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:35:18,489 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:35:18,489 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:35:18,490 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:35:18,874 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:35:18,874 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:35:18,874 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:35:18,875 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:35:18,875 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:35:18,876 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:35:18,890 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:35:18,890 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:35:22,977 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:35:22,978 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:35:24,486 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:35:25,826 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:35:24.676006+00:00, interaction_count=284, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:35:26,396 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:35:26,397 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:35:26,397 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:35:27,984 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:35:28,176 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:35:28,176 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:35:28,177 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 19:35:28,177 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:35:29,258 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNCQUI5RjlCRjZCNDBERTZCNQA="}]}
2025-09-03 19:35:29,259 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:35:30,196 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEOERFOERENkExODFFRTk5NgA="}]}
2025-09-03 19:35:30,197 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEOERFOERENkExODFFRTk5NgA='}]}
2025-09-03 19:35:30,198 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:30,476 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:31,317 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:31,349 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:31,372 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:31,758 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:32,019 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:44,709 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:35:44,709 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:38:20,500 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:38:22,658 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:38:25,474 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:38:25,664 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:38:27,577 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:38:27,776 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:38:27,777 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:38:27,778 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:38:27,779 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:38:27,780 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:38:27,780 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:38:27,781 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:38:27,781 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:38:27,782 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:38:27,782 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:38:29,298 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:38:29,305 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:38:29,485 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:38:31,215 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:38:31,405 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:38:31,406 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:38:31,406 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:38:31,407 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:38:31,407 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:38:31,407 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:38:31,418 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:38:31,418 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:38:31,419 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:38:31,419 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:38:31,419 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:38:31,961 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:38:31,962 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:38:31,963 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:38:31,964 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:38:31,964 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:38:31,964 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:38:31,998 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:38:31,998 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:39:13,140 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:39:13,140 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:39:15,190 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:39:16,386 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:39:17,954 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:39:18,136 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:39:19,866 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:39:20,056 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:39:20,056 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:39:20,057 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:39:20,058 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:39:20,058 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:39:20,059 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:39:20,059 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:39:20,059 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:39:20,060 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:39:20,060 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:39:21,537 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:39:21,567 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:39:21,735 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:39:23,456 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:39:23,645 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:39:23,646 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:39:23,646 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:39:23,647 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:39:23,647 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:39:23,647 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:39:23,648 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:39:23,648 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:39:23,649 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:39:23,649 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:39:23,649 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:39:24,169 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:39:24,169 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:39:24,169 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:39:24,170 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:39:24,170 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:39:24,170 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:39:24,191 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:39:24,191 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:39:24,857 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:39:24,858 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:39:26,399 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:39:27,736 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:39:26.585561+00:00, interaction_count=285, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:39:28,335 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:39:28,336 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:39:28,336 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:39:29,865 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:39:30,054 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:39:30,055 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:39:30,055 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 19:39:30,056 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:39:31,126 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNFQTk5RDZFRTM0RUYwRDA4OQA="}]}
2025-09-03 19:39:31,127 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:39:32,146 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEMUI4RDI2NDVFNzZCRjBENwA="}]}
2025-09-03 19:39:32,147 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEMUI4RDI2NDVFNzZCRjBENwA='}]}
2025-09-03 19:39:32,158 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:32,525 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,148 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,165 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,337 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,515 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,758 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:42:01,067 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:42:01,067 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:44:05,774 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:44:06,969 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:44:08,653 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:44:08,844 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:44:10,574 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:44:10,766 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:44:10,766 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:44:10,767 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:44:10,768 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:44:10,768 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:44:10,769 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:44:10,769 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:44:10,770 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:44:10,770 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:44:10,770 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:44:12,273 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:44:12,286 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:44:12,464 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:44:14,224 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:44:14,415 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:44:14,415 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:44:14,416 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:44:14,416 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:44:14,416 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:44:14,417 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:44:14,417 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:44:14,418 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:44:14,418 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:44:14,418 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:44:14,419 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:44:14,796 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:44:14,796 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:44:14,796 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:44:14,797 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:44:14,797 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:44:14,798 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:44:14,810 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:44:14,811 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:44:28,067 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:44:28,067 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:45:25,604 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:45:26,960 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:45:28,525 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:45:28,713 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:45:30,434 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:45:30,624 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:45:30,624 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:45:30,625 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:45:30,626 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:45:30,626 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:45:30,626 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:45:30,627 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:45:30,627 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:45:30,628 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:45:30,628 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:45:32,146 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:45:32,163 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:45:32,354 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:45:34,084 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:45:34,274 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:45:34,274 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:45:34,275 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:45:34,275 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:45:34,275 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:45:34,276 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:45:34,276 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:45:34,276 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:45:34,277 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:45:34,277 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:45:34,278 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:45:34,662 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:45:34,662 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:45:34,663 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:45:34,663 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:45:34,664 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:45:34,664 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:45:34,678 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:45:34,678 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:45:42,010 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hell hello'}
2025-09-03 19:45:42,010 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:45:43,635 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:45:44,965 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:45:43.823836+00:00, interaction_count=286, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:45:45,534 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:45:45,535 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:45:45,535 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:45:47,116 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:45:47,326 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:45:47,327 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-03 19:45:47,327 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:45:48,595 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2RUY4QUMxQUNDMDRCODMzQQA="}]}
2025-09-03 19:45:48,596 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:45:49,414 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM4Rjg3QUZCMjYyQTY5Q0M4RQA="}]}
2025-09-03 19:45:49,415 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM4Rjg3QUZCMjYyQTY5Q0M4RQA='}]}
2025-09-03 19:45:49,416 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:50,491 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:50,937 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:50,996 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:51,126 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:51] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:51,406 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:51] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:51,637 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:51] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:52,634 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:45:54,183 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:45:55,975 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:45:54.374430+00:00, interaction_count=287, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:45:56,633 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:45:56,634 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:45:56,634 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:45:56,635 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:45:56,635 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:45:56,635 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:45:56,635 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:45:56,636 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:45:56,636 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:45:57,876 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM1NEM2OUEyQUNCN0ZGNjgyRgA="}]}
2025-09-03 19:45:57,877 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:45:57,878 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:45:58,765 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgxQzE5QUU5QjJBMjI0RjU1NgA="}]}
2025-09-03 19:45:58,766 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgxQzE5QUU5QjJBMjI0RjU1NgA='}]}
2025-09-03 19:45:58,767 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:58] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:59,710 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,387 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,405 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,687 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,756 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,795 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:08,794 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-03 19:46:10,324 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:11,674 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:10.513868+00:00, interaction_count=288, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:12,243 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:12,245 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:46:12,246 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:46:12,247 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-03 19:46:15,215 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:46:15,233 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:46:16,474 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4RUMyRDQ4RDI3RUU0MTQ3QwA="}]}
2025-09-03 19:46:16,474 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4RUMyRDQ4RDI3RUU0MTQ3QwA='}]}
2025-09-03 19:46:16,476 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:17,541 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:17,945 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:17,997 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:19,886 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:46:21,423 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:22,843 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:21.613356+00:00, interaction_count=289, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:23,433 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:23,434 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:46:23,434 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:46:23,434 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:46:23,435 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:46:23,435 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:46:23,435 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:46:23,436 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:46:23,448 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:46:24,835 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3RUJBNTUzRjg0ODEzMDE5QgA="}]}
2025-09-03 19:46:26,000 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:26,176 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:26,414 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:26,656 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:27,765 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:26.605929+00:00, interaction_count=290, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:27,974 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:46:28,333 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:28,353 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:46:28,353 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3RUJBNTUzRjg0ODEzMDE5QgA='}]}
2025-09-03 19:46:28,354 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:29,506 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:30,864 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:29.694154+00:00, interaction_count=291, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:31,464 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:31,465 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:46:31,465 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:46:31,465 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:46:31,466 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:46:31,480 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:46:33,194 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBRjVBNzg3QTk4OUZDMzJGQgA="}]}
2025-09-03 19:46:34,166 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:34,497 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:34,685 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:34,734 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:36,134 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:34.923755+00:00, interaction_count=292, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:36,266 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 19:46:36,733 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:36,740 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:46:36,740 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBRjVBNzg3QTk4OUZDMzJGQgA='}]}
2025-09-03 19:46:36,741 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:36] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:37,795 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:39,144 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:37.983571+00:00, interaction_count=293, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:39,714 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:39,715 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:46:39,715 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:46:39,715 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-09-03 19:46:39,716 - handlers.order_handler - ERROR - Failed to save order ORD-9B633AD3 for session 2348055614455: 'DataManager' object has no attribute 'save_order'
2025-09-03 19:46:39,716 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:46:40,694 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlERkI2MjVGM0Y2NjE0MzAzMwA="}]}
2025-09-03 19:46:41,710 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:42,176 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:42,223 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:42,346 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:43,544 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:42.423565+00:00, interaction_count=294, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:44,113 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:44,119 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:46:44,119 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlERkI2MjVGM0Y2NjE0MzAzMwA='}]}
2025-09-03 19:46:44,120 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:03,031 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:48:03,032 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:48:05,320 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:48:06,785 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:48:08,423 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:48:08,623 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:48:10,364 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:48:10,565 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:48:10,567 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:48:10,568 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:48:10,570 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:48:10,571 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:48:10,573 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:48:10,574 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:48:10,575 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:48:10,576 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:48:10,576 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:48:12,139 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:48:12,145 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:48:12,334 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:48:14,096 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:48:14,299 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:48:14,299 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:48:14,299 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:48:14,299 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:48:14,300 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:48:14,300 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:48:14,300 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:48:14,301 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:48:14,301 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:48:14,301 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:48:14,302 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:48:14,746 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:48:14,746 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:48:14,746 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:48:14,747 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:48:14,747 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:48:14,747 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:48:14,761 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:48:14,761 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:48:37,231 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:48:37,232 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:48:38,823 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:48:40,219 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:48:39.015214+00:00, interaction_count=295, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:48:40,818 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:48:40,819 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:48:40,819 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:48:42,424 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:48:42,613 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:48:42,614 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:48:42,614 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 19:48:42,614 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:48:43,735 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJCMzNEM0VCQzI1QTc2QkQ5RQA="}]}
2025-09-03 19:48:43,736 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:48:44,853 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFEMjBEQUM3ODEyNzM2MjExOAA="}]}
2025-09-03 19:48:44,854 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFEMjBEQUM3ODEyNzM2MjExOAA='}]}
2025-09-03 19:48:44,855 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:44,989 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:45,365 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:46,083 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:46] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:46,197 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:46] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:46,321 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:46] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:46,336 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:46] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:47,457 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:48:48,983 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:48:50,353 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:48:49.183823+00:00, interaction_count=296, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:48:50,943 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:48:50,944 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:48:50,944 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:48:50,945 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:48:50,945 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:48:50,945 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:48:50,946 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:48:50,946 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:48:50,946 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:48:51,973 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4MzRGQjdBNTcwNDRFQTcxQgA="}]}
2025-09-03 19:48:51,974 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:48:51,974 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:48:52,844 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg1MkQ5MjkzNkMxNzZBQjM0MQA="}]}
2025-09-03 19:48:52,845 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg1MkQ5MjkzNkMxNzZBQjM0MQA='}]}
2025-09-03 19:48:52,846 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:53,254 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:53,946 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:53,964 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:54,274 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:54,346 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:54,574 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:59,604 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-03 19:49:01,153 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:02,742 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:01.589091+00:00, interaction_count=297, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:03,303 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:03,303 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:49:03,304 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:49:03,304 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-03 19:49:06,536 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:49:06,545 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:49:07,473 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNBMTlGRDQwMUYyOEZDMzc2NAA="}]}
2025-09-03 19:49:07,474 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNBMTlGRDQwMUYyOEZDMzc2NAA='}]}
2025-09-03 19:49:07,475 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:08,521 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:08,976 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:09,107 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:09] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:15,369 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:49:17,154 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:18,504 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:17.353009+00:00, interaction_count=298, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:19,074 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:19,075 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:49:19,076 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:49:19,076 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:49:19,076 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:49:19,077 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:49:19,077 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:49:19,077 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:49:19,083 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:49:20,053 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3ODM1RTA4OTkzRTQwMzcwRgA="}]}
2025-09-03 19:49:21,241 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:21,316 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:21,583 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:21,666 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:22,706 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:49:22,923 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:21.783328+00:00, interaction_count=299, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:23,493 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:23,500 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:49:23,500 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3ODM1RTA4OTkzRTQwMzcwRgA='}]}
2025-09-03 19:49:23,501 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:24,215 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:25,554 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:24.403828+00:00, interaction_count=300, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:26,123 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:26,124 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:49:26,124 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:49:26,124 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:49:26,125 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:49:26,137 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:49:27,114 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJDRDcxQjQwQjhGNzBEQjY1MgA="}]}
2025-09-03 19:49:28,231 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:28,367 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:28,665 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:28,673 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:30,004 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:28.863471+00:00, interaction_count=301, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:30,573 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:30,579 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:49:30,579 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJDRDcxQjQwQjhGNzBEQjY1MgA='}]}
2025-09-03 19:49:30,580 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:35,344 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 19:49:36,883 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:38,244 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:37.074966+00:00, interaction_count=302, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:38,814 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:38,814 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:49:38,815 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:49:38,815 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-09-03 19:49:39,964 - utils.data_manager - ERROR - Unexpected error saving order for customer 2348055614455: 'item_name'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 349, in save_user_order
    product_id = self._get_product_id_by_name(item["item_name"])
                                              ~~~~^^^^^^^^^^^^^
KeyError: 'item_name'
2025-09-03 19:49:39,966 - handlers.order_handler - INFO - Order ORD-66D105DE saved to database for session 2348055614455.
2025-09-03 19:49:39,966 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:49:41,533 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:42,902 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:41.724992+00:00, interaction_count=303, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=order_completed, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:49:43,482 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:43,488 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID ORD-66D105DE
2025-09-03 19:49:43,494 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-09-03 19:49:43,495 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-09-03 19:49:43,495 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-09-03 19:49:45,244 - utils.data_manager - ERROR - Database error retrieving order ORD-66D105DE: invalid input syntax for type bigint: "ORD-66D105DE"
LINE 6:                         WHERE id = 'ORD-66D105DE' AND mercha...
                                           ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 674, in get_order_by_id
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<6 lines>...
        (order_id, self.merchant_id)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type bigint: "ORD-66D105DE"
LINE 6:                         WHERE id = 'ORD-66D105DE' AND mercha...
                                           ^

2025-09-03 19:49:45,247 - handlers.payment_handler - ERROR - Order ORD-66D105DE not found in database for session 2348055614455
2025-09-03 19:49:45,247 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:49:46,284 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI5RTA0Q0FERTdERTBBNjk3NgA="}]}
2025-09-03 19:49:47,390 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:47,606 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:47,795 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:47,843 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:49,303 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:48.153335+00:00, interaction_count=304, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:49:49,872 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:49,878 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:49:49,879 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI5RTA0Q0FERTdERTBBNjk3NgA='}]}
2025-09-03 19:49:49,879 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:51:28,166 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:51:28,166 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:57:55,476 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:57:57,294 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:57:59,411 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:57:59,611 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:58:01,367 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:58:01,562 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:58:01,562 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:58:01,562 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:58:01,564 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:58:01,564 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:58:01,564 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:58:01,565 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:58:01,565 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:58:01,566 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:58:01,566 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:58:03,122 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:58:03,154 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:58:03,311 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:58:05,071 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:58:05,282 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:58:05,283 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:58:05,283 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:58:05,283 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:58:05,284 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:58:05,284 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:58:05,296 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:58:05,296 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:58:05,297 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:58:05,297 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:58:05,297 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:58:05,732 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:58:05,732 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:58:05,733 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:58:05,733 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:58:05,733 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:58:05,734 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:58:05,765 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:58:05,766 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:58:06,039 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:58:06,039 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:58:07,602 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:09,131 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:07.802251+00:00, interaction_count=305, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:09,752 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:09,752 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:58:09,753 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:11,374 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:58:11,573 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:58:11,574 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:58:11,574 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 19:58:11,575 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:58:12,691 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJCQ0Y2OTNBQUEwNjZERjlBNQA="}]}
2025-09-03 19:58:12,704 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:13,572 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFFNjA4NUQ5RUZDN0NBOTVGRQA="}]}
2025-09-03 19:58:13,573 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFFNjA4NUQ5RUZDN0NBOTVGRQA='}]}
2025-09-03 19:58:13,574 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:13] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:14,143 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:14] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:14,734 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:14] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:14,943 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:14] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:15,022 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:15,116 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:15,194 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:16,544 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:58:18,132 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:19,492 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:18.332453+00:00, interaction_count=306, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:20,071 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:20,072 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:20,072 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:20,073 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:58:20,073 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:58:20,073 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:58:20,074 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:58:20,074 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:58:20,075 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:58:21,114 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEyMUI1OUUxRTI2NUY4RTc0QQA="}]}
2025-09-03 19:58:21,115 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:58:21,115 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:58:22,733 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:22] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:22,994 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:22] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:23,065 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:23,111 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFRDZGRjNDN0ZFM0ZDODQ3OAA="}]}
2025-09-03 19:58:23,112 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFRDZGRjNDN0ZFM0ZDODQ3OAA='}]}
2025-09-03 19:58:23,112 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:24,122 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:24,443 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:24,544 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:26,353 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-03 19:58:27,912 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:29,356 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:28.111731+00:00, interaction_count=307, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:29,951 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:29,951 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:29,952 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:29,952 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-03 19:58:32,862 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:58:32,876 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:33,792 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzODVCMzEyQzgxNjBDRUFENgA="}]}
2025-09-03 19:58:33,793 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzODVCMzEyQzgxNjBDRUFENgA='}]}
2025-09-03 19:58:33,794 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:34,833 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:35,124 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:35,564 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:36,826 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:58:38,371 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:39,741 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:38.561453+00:00, interaction_count=308, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:40,331 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:40,332 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:40,333 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:40,333 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:58:40,333 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:58:40,334 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:58:40,334 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:58:40,335 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:58:40,341 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:41,812 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwQUMwMTY3MkY4QzVDMTVDNwA="}]}
2025-09-03 19:58:42,822 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:43,114 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:43] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:43,292 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:43] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:43,442 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:44,434 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:58:44,841 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:43.641220+00:00, interaction_count=309, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:45,411 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:45,417 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:58:45,417 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwQUMwMTY3MkY4QzVDMTVDNwA='}]}
2025-09-03 19:58:45,417 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:45,961 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:47,341 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:46.152508+00:00, interaction_count=310, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:48,021 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:48,022 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:48,022 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:48,022 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:58:48,023 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:58:48,035 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:48,932 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk1OUJBOERGRDkzOUJDRkYyNgA="}]}
2025-09-03 19:58:49,962 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:50,213 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:50,481 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:50,724 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:51,354 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:58:51,833 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:50.682018+00:00, interaction_count=311, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:52,432 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:52,438 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:58:52,438 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk1OUJBOERGRDkzOUJDRkYyNgA='}]}
2025-09-03 19:58:52,439 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:52,911 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:54,282 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:53.102121+00:00, interaction_count=312, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:54,851 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:54,852 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:54,852 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:54,853 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:58:54,853 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:58:54,859 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:56,224 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQxN0M3M0YyN0U0QjQ5M0IyQgA="}]}
2025-09-03 19:58:57,207 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:57,702 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:57,823 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:57,831 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:59,202 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:58.031389+00:00, interaction_count=313, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:59,771 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:59,778 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:58:59,778 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQxN0M3M0YyN0U0QjQ5M0IyQgA='}]}
2025-09-03 19:58:59,779 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:03,578 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-03 19:59:05,112 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:59:06,521 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:59:05.301533+00:00, interaction_count=314, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:59:07,141 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:59:07,142 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:59:07,143 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:59:08,951 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:59:08,952 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-03 19:59:08,952 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-03 19:59:08,953 - handlers.location_address_handler - INFO - Redirecting back to order confirmation after address update for session 2348055614455
2025-09-03 19:59:10,721 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:59:10,722 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-03 19:59:10,722 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'show_order_confirmation_after_address_update'.
2025-09-03 19:59:10,723 - handlers.order_handler - INFO - Showing order confirmation after address update for session 2348055614455
2025-09-03 19:59:10,723 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:59:10,735 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:59:11,752 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRDMjUxODgwRTk3MjdDOTYzMAA="}]}
2025-09-03 19:59:12,759 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:12] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:13,173 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:13] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:13,254 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:13] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:13,362 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:59:14,422 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 19:59:14,721 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:59:13.561443+00:00, interaction_count=315, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:59:15,311 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:59:15,317 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:59:15,317 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRDMjUxODgwRTk3MjdDOTYzMAA='}]}
2025-09-03 19:59:15,318 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:15,992 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:59:17,382 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:59:16.193805+00:00, interaction_count=316, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:59:17,991 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:59:17,992 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:59:17,992 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:59:17,993 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-09-03 19:59:20,791 - utils.data_manager - DEBUG - Found product_id 112 for product_name Jollof Rice
2025-09-03 19:59:21,002 - utils.data_manager - DEBUG - Assigned product_id 112 to item Jollof Rice
2025-09-03 19:59:21,604 - utils.data_manager - ERROR - Database error saving order for customer 2348055614455: null value in column "payment_reference" of relation "whatsapp_orders" violates not-null constraint
DETAIL:  Failing row contains (207, 20, 2348055614455, 1, Howson Wright, pending payment, 665.0, null, paystack, 2025-09-03 18:59:17.993565+00, 2025-09-03 18:59:17.993565+00, 2025-09-03 18:59:17.993565+00, null, , 15.00).
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 357, in save_user_order
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<22 lines>...
        )
        ^
    )
    ^
psycopg2.errors.NotNullViolation: null value in column "payment_reference" of relation "whatsapp_orders" violates not-null constraint
DETAIL:  Failing row contains (207, 20, 2348055614455, 1, Howson Wright, pending payment, 665.0, null, paystack, 2025-09-03 18:59:17.993565+00, 2025-09-03 18:59:17.993565+00, 2025-09-03 18:59:17.993565+00, null, , 15.00).

2025-09-03 19:59:21,616 - handlers.order_handler - ERROR - Failed to save order ORD-E5F2B237 for session 2348055614455: No database ID returned
2025-09-03 19:59:21,617 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:59:22,614 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDNzY1OTM5RjlENjA5MkJDQwA="}]}
2025-09-03 19:59:23,678 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:24,143 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:24,174 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:24,201 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:59:25,601 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:59:24.394617+00:00, interaction_count=317, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:59:26,201 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:59:26,208 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:59:26,208 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDNzY1OTM5RjlENjA5MkJDQwA='}]}
2025-09-03 19:59:26,209 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:20,755 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 20:01:20,755 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 20:01:22,513 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 20:01:24,303 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 20:01:25,881 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 20:01:26,082 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 20:01:28,153 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 20:01:28,365 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 20:01:28,366 - services.payment_service - INFO - PaymentService initialized
2025-09-03 20:01:28,366 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 20:01:28,367 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 20:01:28,368 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 20:01:28,368 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 20:01:28,369 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 20:01:28,369 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 20:01:28,369 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 20:01:28,370 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 20:01:29,971 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 20:01:29,981 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 20:01:30,180 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 20:01:32,094 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 20:01:32,302 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 20:01:32,303 - services.payment_service - INFO - PaymentService initialized
2025-09-03 20:01:32,303 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 20:01:32,303 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 20:01:32,303 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 20:01:32,304 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 20:01:32,315 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 20:01:32,316 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 20:01:32,316 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 20:01:32,316 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 20:01:32,317 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 20:01:32,747 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 20:01:32,747 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 20:01:32,747 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 20:01:32,748 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 20:01:32,748 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 20:01:32,749 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 20:01:32,784 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 20:01:32,784 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 20:01:32,862 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 20:01:32,863 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 20:01:34,580 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:01:35,994 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:01:34.802161+00:00, interaction_count=318, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:01:36,751 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:01:36,752 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 20:01:36,752 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:01:38,471 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 20:01:38,681 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 20:01:38,681 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:01:38,682 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 20:01:38,682 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 20:01:39,771 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc3MUNDRDI0MEI5RkVGNjY2NwA="}]}
2025-09-03 20:01:39,772 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:01:40,681 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4QzE1REEwNEIyNDE0MzY4MgA="}]}
2025-09-03 20:01:40,681 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4QzE1REEwNEIyNDE0MzY4MgA='}]}
2025-09-03 20:01:40,682 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:40] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:40,988 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:40] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:41,723 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:41,834 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:41,945 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:42,153 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:42,363 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:43,383 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 20:01:44,901 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:01:46,258 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:01:45.083715+00:00, interaction_count=319, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:01:46,841 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:01:46,842 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:01:46,842 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:01:46,843 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 20:01:46,843 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 20:01:46,843 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 20:01:46,843 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 20:01:46,844 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 20:01:46,844 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 20:01:47,932 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEzMTA5NjQ4RDM5REI4RTJGRgA="}]}
2025-09-03 20:01:47,933 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:01:47,933 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 20:01:48,841 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMzMEM4RUZCQUI5OTUyNUJGNwA="}]}
2025-09-03 20:01:48,842 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMzMEM4RUZCQUI5OTUyNUJGNwA='}]}
2025-09-03 20:01:48,842 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:49,288 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:49,853 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:50,012 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:50,053 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:50,223 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:50,795 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-03 20:01:50,862 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:52,331 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:01:53,741 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:01:52.521204+00:00, interaction_count=320, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:01:54,366 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:01:54,367 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:01:54,367 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:01:54,368 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-03 20:01:57,372 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 20:01:57,395 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:01:58,371 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBDMjg0OTVCQjc0QTFBNzlBQgA="}]}
2025-09-03 20:01:58,371 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBDMjg0OTVCQjc0QTFBNzlBQgA='}]}
2025-09-03 20:01:58,372 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:58] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:59,412 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:59,802 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:00,213 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:01,872 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 20:02:03,530 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:04,942 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:03.720652+00:00, interaction_count=321, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:05,581 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:05,582 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:05,582 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:05,582 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 20:02:05,583 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 20:02:05,583 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:02:05,583 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 20:02:05,584 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 20:02:05,601 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:06,521 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlGQjc1NDA3NzZGNDg3QTE0RgA="}]}
2025-09-03 20:02:07,737 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:07,922 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:08,073 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:08,132 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:09,383 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-09-03 20:02:09,531 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:08.333326+00:00, interaction_count=322, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:10,133 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:10,142 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:10,143 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlGQjc1NDA3NzZGNDg3QTE0RgA='}]}
2025-09-03 20:02:10,143 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:10] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:10,940 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:12,361 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:11.151451+00:00, interaction_count=323, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:12,971 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:12,972 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:12,972 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:12,972 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-09-03 20:02:12,973 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:02:12,973 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please type your note for the order (e.g., 'Please deliver after 5 PM'). Type 'back' to skip adding a note."}}
2025-09-03 20:02:14,081 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwQzE4RTk1QzIwQjg0RDcxMgA="}]}
2025-09-03 20:02:15,077 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:15,321 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:15,772 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:15,831 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:17,431 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:16.037091+00:00, interaction_count=324, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:18,090 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:18,097 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:18,097 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwQzE4RTk1QzIwQjg0RDcxMgA='}]}
2025-09-03 20:02:18,097 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:18] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:19,152 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Make sure your rice is not cold'}
2025-09-03 20:02:20,851 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:22,221 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:21.061313+00:00, interaction_count=325, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:22,820 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:22,821 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:22,822 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:22,822 - handlers.order_handler - INFO - Note 'make sure your rice is not cold' added for session 2348055614455.
2025-09-03 20:02:22,823 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:02:22,838 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:23,782 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMTIxQUYwOTYwOUYwMTk2MQA="}]}
2025-09-03 20:02:24,792 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:25,193 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:25,273 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:25,341 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:26,793 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 20:02:26,870 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:25.541169+00:00, interaction_count=326, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:27,551 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:27,558 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:27,558 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMTIxQUYwOTYwOUYwMTk2MQA='}]}
2025-09-03 20:02:27,559 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:27] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:28,390 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:29,781 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:28.591464+00:00, interaction_count=327, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:30,361 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:30,361 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:30,362 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:30,362 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 20:02:30,362 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 20:02:30,369 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:31,354 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIxQzUxMkFDRUZCQTJFMTFFNwA="}]}
2025-09-03 20:02:32,577 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:32,783 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:32,852 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:32,961 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:33,873 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-03 20:02:34,341 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:33.161126+00:00, interaction_count=328, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:34,910 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:34,916 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:34,917 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIxQzUxMkFDRUZCQTJFMTFFNwA='}]}
2025-09-03 20:02:34,917 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:35,430 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:37,021 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:35.631793+00:00, interaction_count=329, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:37,680 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:37,681 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:37,682 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:39,641 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 20:02:39,642 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-03 20:02:39,642 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-03 20:02:39,642 - handlers.location_address_handler - INFO - Redirecting back to order confirmation after address update for session 2348055614455
2025-09-03 20:02:41,591 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 20:02:41,592 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-03 20:02:41,592 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'show_order_confirmation_after_address_update'.
2025-09-03 20:02:41,592 - handlers.order_handler - INFO - Showing order confirmation after address update for session 2348055614455
2025-09-03 20:02:41,593 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:02:41,603 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:43,501 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY5QTFEM0E0NTE1N0NFNzA4MAA="}]}
2025-09-03 20:02:44,611 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:44,841 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:45,111 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:45,334 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:46,252 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 20:02:46,422 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 20:02:46,511 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:45.312078+00:00, interaction_count=330, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:47,110 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:47,117 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:47,118 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY5QTFEM0E0NTE1N0NFNzA4MAA='}]}
2025-09-03 20:02:47,118 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:47,851 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:48,030 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:49,391 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:48.231204+00:00, interaction_count=331, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:49,421 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:48.050468+00:00, interaction_count=331, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:49,971 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:49,972 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:49,972 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:49,972 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-09-03 20:02:50,201 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:50,202 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:50,202 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:50,203 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 20:02:50,203 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 20:02:50,208 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:51,732 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QUVCM0ZERUY0NzNFNDM2MQA="}]}
2025-09-03 20:02:52,840 - utils.data_manager - DEBUG - Found product_id 112 for product_name Jollof Rice
2025-09-03 20:02:53,000 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:53,030 - utils.data_manager - DEBUG - Assigned product_id 112 to item Jollof Rice
2025-09-03 20:02:53,065 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:53,303 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:53,330 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:54,690 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:53.520639+00:00, interaction_count=333, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:54,751 - utils.data_manager - DEBUG - Found product_id 113 for product_name Fried Rice
2025-09-03 20:02:54,961 - utils.data_manager - DEBUG - Assigned product_id 113 to item Fried Rice
2025-09-03 20:02:54,961 - utils.data_manager - WARNING - No payment_reference provided for order. Generated default: PAY-ORD-7736F985
2025-09-03 20:02:55,260 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:55,266 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:55,267 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QUVCM0ZERUY0NzNFNDM2MQA='}]}
2025-09-03 20:02:55,267 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:55] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:55,350 - utils.data_manager - INFO - Saved order 208 for customer 2348055614455 with payment_reference PAY-ORD-7736F985
2025-09-03 20:02:55,551 - utils.data_manager - INFO - Saved order item Jollof Rice for order 208
2025-09-03 20:02:55,751 - utils.data_manager - INFO - Saved order item Fried Rice for order 208
2025-09-03 20:02:55,952 - handlers.order_handler - INFO - Order ORD-7736F985 saved to database with DB ID 208 for session 2348055614455.
2025-09-03 20:02:55,953 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:02:57,583 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:59,148 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:57.781234+00:00, interaction_count=334, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=order_completed, final_order_value=2865.0, converted_at=2025-09-03 19:02:57.781234+00:00
2025-09-03 20:02:59,840 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:59,846 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID ORD-7736F985
2025-09-03 20:02:59,851 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-09-03 20:02:59,851 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-09-03 20:02:59,851 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-09-03 20:03:03,640 - utils.data_manager - INFO - Updated order 208 to status pending_payment
2025-09-03 20:03:03,641 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-09-03 20:03:03,641 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-ORD-7736F985 with amount: 286500, email: ziga4455@lola.com
2025-09-03 20:03:04,337 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/yc15cwpvtswdyah
2025-09-03 20:03:04,338 - handlers.payment_handler - INFO - Starting payment monitoring for order 208, reference PAY-ORD-7736F985
2025-09-03 20:03:04,338 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-7736F985
2025-09-03 20:03:04,880 - services.payment_service - WARNING - Payment not successful for reference PAY-ORD-7736F985. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5303403959, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-ORD-7736F985', 'receipt_number': None, 'amount': 286500, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-09-03T19:03:04.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.67.12.153, 172.69.224.19, 172.31.68.120', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': 'ORD-7736F985', 'db_order_id': '208', 'delivery_address': 'Howson Wright', 'charges': '215', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 14298, 'integration': '2865', 'subaccount': 269337, 'params': {'bearer': 'subaccount', 'transaction_charge': '2865', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-09-03T19:03:04.000Z', 'requested_amount': 286500, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-09-03T19:03:04.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-09-03 20:03:04,881 - handlers.payment_handler - INFO - Payment not yet verified for order 208, attempt 1/15
2025-09-03 20:03:04,882 - handlers.payment_handler - INFO - Payment link created successfully for order 208 with subaccount ACCT_u9knhyzn5eq4iop
2025-09-03 20:03:06,431 - utils.data_manager - INFO - Retrieved 2 items for order 208
2025-09-03 20:03:06,651 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:03:07,651 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEMDI5QjNFRTg3Q0RGMjdFRgA="}]}
2025-09-03 20:03:08,676 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:09,092 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:09] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:09,191 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:03:09,252 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:09] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:10,690 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:03:09.391153+00:00, interaction_count=335, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:02:57.781234+00:00
2025-09-03 20:03:11,310 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:03:11,316 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:03:11,316 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEMDI5QjNFRTg3Q0RGMjdFRgA='}]}
2025-09-03 20:03:11,317 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:11] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:11,711 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 20:03:13,340 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:03:14,871 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:03:13.650421+00:00, interaction_count=336, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:02:57.781234+00:00
2025-09-03 20:03:15,470 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:03:15,471 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:03:15,471 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:03:16,787 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-ORD-7736F985
2025-09-03 20:03:17,331 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order ORD-7736F985.
2025-09-03 20:03:19,150 - utils.data_manager - ERROR - Database error retrieving items for order ORD-7736F985: invalid input syntax for type bigint: "ORD-7736F985"
LINE 4:                         WHERE order_id = 'ORD-7736F985'
                                                 ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 759, in get_order_items
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<4 lines>...
        (order_id,)
        ^^^^^^^^^^^
    )
    ^
psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type bigint: "ORD-7736F985"
LINE 4:                         WHERE order_id = 'ORD-7736F985'
                                                 ^

2025-09-03 20:03:19,152 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:03:20,061 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU2NDk4RjYxMTE3NkNFNzdEMgA="}]}
2025-09-03 20:03:20,370 - utils.data_manager - INFO - Updated order 208 to status confirmed
2025-09-03 20:03:21,034 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:21,383 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:21,531 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:21,691 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:03:21,950 - utils.data_manager - INFO - Retrieved 2 items for order 208
2025-09-03 20:03:23,107 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:03:21.901075+00:00, interaction_count=337, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:02:57.781234+00:00
2025-09-03 20:03:23,721 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:03:23,727 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:03:23,727 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU2NDk4RjYxMTE3NkNFNzdEMgA='}]}
2025-09-03 20:03:23,728 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:23,940 - utils.data_manager - INFO - Reduced inventory for product_id 112 by 1 for order 208
2025-09-03 20:03:24,361 - utils.data_manager - INFO - Reduced inventory for product_id 113 by 1 for order 208
2025-09-03 20:03:24,550 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 20:03:26,073 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 20:03:26,261 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 208
2025-09-03 20:03:29,840 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-09-03 20:03:29,841 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-09-03 20:03:31,760 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:03:32,971 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEwODEzRDBBOTRFNkVGNzk3MQA="}]}
2025-09-03 20:03:32,972 - handlers.payment_handler - INFO - Sent payment success text message for order 208 to customer 2348055614455
2025-09-03 20:03:32,973 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 208, session 2348055614455
2025-09-03 20:03:32,973 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 9, 3, 20, 3, 32, 973710), 'payment_reference': 'PAY-ORD-7736F985', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '112', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 150.0, 'total_price': 150.0}, {'item_id': '113', 'name': 'Fried Rice', 'quantity': 1, 'variations': {}, 'price': 2000.0, 'total_price': 2000.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 2150.0, 'error': ''}, 'total_price': 2150.0, 'from_ai_order': True, 'order_note': 'make sure your rice is not cold', 'latitude': None, 'longitude': None, 'map_link': '', 'order_id': 'ORD-7736F985', 'from_confirm_order': True, 'db_order_id': '208', 'feedback_order_id': 208, 'feedback_started_at': '2025-09-03T20:03:32.973702'}
2025-09-03 20:03:32,980 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:03:33,966 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:34,022 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBMEVDMURFOTFBNEMzQjEyQQA="}]}
2025-09-03 20:03:34,023 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 208, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBMEVDMURFOTFBNEMzQjEyQQA='}]}
2025-09-03 20:03:34,023 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-09-03 20:03:34,503 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:35,031 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:35,233 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:35,251 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjAwNEFBMEVGNzAxMTBCQzFDMAA="}]}
2025-09-03 20:03:35,252 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 208 to 2347082345056
2025-09-03 20:03:35,253 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:35] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-09-03 20:03:35,422 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:36,591 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:36] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:40,124 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 20:03:40,125 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:11:21,883 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:11:25,754 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:11:27,340 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:11:27,574 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:11:27,770 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:27,950 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,151 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,341 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,529 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,720 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,911 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,091 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,280 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,470 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,660 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,926 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:30,160 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:30,349 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:32,093 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:11:32,291 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:11:32,292 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:11:32,292 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:11:32,294 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:11:32,294 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:11:32,294 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:11:32,294 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:11:32,295 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:11:32,295 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:11:32,296 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:11:33,803 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:11:33,848 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:11:34,041 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:11:34,241 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:34,430 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:34,620 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:34,810 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,000 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,190 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,380 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,562 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,740 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,931 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:36,120 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:36,313 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:36,510 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:36,700 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:38,413 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:11:38,608 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:11:38,608 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:11:38,609 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:11:38,609 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:11:38,609 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:11:38,609 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:11:38,611 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:11:38,611 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:11:38,612 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:11:38,612 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:11:38,612 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:11:39,132 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:11:39,132 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:11:39,132 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:11:39,132 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:11:39,133 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:11:39,133 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:11:39,162 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:11:39,162 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:11:48,270 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:11:48,271 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:16:01,441 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:16:03,506 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:16:05,329 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:16:05,602 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:16:05,806 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,009 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,209 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,416 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,636 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,829 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,029 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,232 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,430 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,629 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,829 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:08,035 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:08,239 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:08,439 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:10,173 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:16:10,370 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:16:10,371 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:16:10,371 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:16:10,373 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:16:10,372 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:16:10,373 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:16:10,374 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:16:10,374 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:16:10,375 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:16:10,375 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:16:11,909 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:16:11,914 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:16:12,101 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:16:12,293 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:12,599 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:12,790 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:12,979 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,163 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,358 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,551 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,749 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,939 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,129 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,319 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,536 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,745 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,943 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:16,797 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:16:16,992 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:16:16,993 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:16:16,994 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:16:16,994 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:16:16,995 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:16:16,995 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:16:16,998 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:16:16,998 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:16:16,998 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:16:17,000 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:16:17,001 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:16:18,083 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:16:18,083 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:16:18,084 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:16:18,084 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:16:18,084 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:16:18,085 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:16:18,134 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:16:18,135 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:17:39,419 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:17:39,420 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:17:42,352 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:17:44,455 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:17:46,019 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:17:46,208 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:17:46,415 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:46,609 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:46,799 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:46,989 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,179 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,369 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,609 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,799 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,990 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,179 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,369 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,559 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,751 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,939 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:50,650 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:17:50,845 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:17:50,846 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:17:50,846 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:17:50,847 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:17:50,847 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:17:50,848 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:17:50,848 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:17:50,848 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:17:50,849 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:17:50,849 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:17:52,349 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:17:52,502 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:17:52,540 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:17:52,730 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:52,919 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,110 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,299 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,489 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,679 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,872 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,069 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,259 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,449 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,639 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,829 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:55,030 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:55,229 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:56,989 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:17:57,181 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:17:57,182 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:17:57,182 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:17:57,182 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:17:57,182 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:17:57,183 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:17:57,183 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:17:57,183 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:17:57,184 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:17:57,184 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:17:57,185 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:17:57,590 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:17:57,590 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:17:57,590 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:17:57,591 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:17:57,591 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:17:57,591 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:17:57,604 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:17:57,604 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:19:07,040 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:19:07,041 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:19:08,590 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:19:09,899 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:19:08.779740+00:00, interaction_count=401, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:19:10,511 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:19:10,511 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:19:10,512 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:19:12,069 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:19:12,257 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:19:12,258 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:19:12,258 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:19:12,259 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:19:13,769 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhEOEJDNDlDNkU5MjI2NEQzQwA="}]}
2025-09-27 01:19:13,770 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:19:14,750 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJFQ0RCNThDOUU2MzVFOERDMAA="}]}
2025-09-27 01:19:14,751 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJFQ0RCNThDOUU2MzVFOERDMAA='}]}
2025-09-27 01:19:14,753 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:14] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:16,380 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:16,940 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:16,991 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:17,184 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:17,661 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:18,101 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:18] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:19,620 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 01:19:21,179 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:19:22,525 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:19:21.369358+00:00, interaction_count=402, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:19:23,090 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:19:23,092 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:19:23,093 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:19:23,093 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 01:19:23,093 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 01:19:23,094 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 01:19:23,094 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 01:19:23,094 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:19:23,095 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 01:19:24,239 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBMEMyNTc0QUE5MzhGNDNEOAA="}]}
2025-09-27 01:19:24,240 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:19:24,240 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-27 01:19:25,159 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDMzQ0N0I2MzFBOUZDNTMwNQA="}]}
2025-09-27 01:19:25,160 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDMzQ0N0I2MzFBOUZDNTMwNQA='}]}
2025-09-27 01:19:25,160 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:25] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:25,801 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:25] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:26,410 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:26,531 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:26,750 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:26,812 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:27,152 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:33,235 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-27 01:19:34,761 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:19:36,132 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:19:34.949534+00:00, interaction_count=403, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:19:36,719 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:19:36,719 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:19:36,720 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:19:36,720 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-27 01:19:40,404 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:19:40,412 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:19:42,369 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1NzdCRTYxNzE5NUI1NEFDOQA="}]}
2025-09-27 01:19:42,370 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1NzdCRTYxNzE5NUI1NEFDOQA='}]}
2025-09-27 01:19:42,371 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:43,205 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:43] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:43,801 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:43] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:44,230 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:44] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:20:17,625 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '2 portions of jellof rice and 1 portion of fried rice'}
2025-09-27 01:20:19,159 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:20:20,522 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:20:19.349596+00:00, interaction_count=404, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:20:21,139 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:20:21,140 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:20:21,140 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:20:21,140 - handlers.message_processor - WARNING - Session 2348055614455: Unhandled AI state 'ai_portion_clarification'. Resetting to AI menu.
2025-09-27 01:20:21,141 - handlers.base_handler - INFO - AIHandler: Handling message 'initial_entry' in AI menu state for session 2348055614455. Original: '2 portions of jellof rice and 1 portion of fried rice'
2025-09-27 01:20:21,147 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:20:22,299 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1MjE1OTNBRDIzRjRCODM3NAA="}]}
2025-09-27 01:20:22,300 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1MjE1OTNBRDIzRjRCODM3NAA='}]}
2025-09-27 01:20:22,301 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:20:22] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:20:23,540 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:20:23] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:20:23,732 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:20:23] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:20:24,111 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:20:24] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:22:52,690 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:22:54,362 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:25:38,638 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:25:40,168 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:25:41,588 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:25:40.358221+00:00, interaction_count=405, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:25:42,153 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:25:42,154 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:25:42,154 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:25:42,155 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:25:42,155 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:25:42,156 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:25:42,156 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:25:44,069 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkxQzBFNjY5RUU1M0E5NDYxNAA="}]}
2025-09-27 01:25:44,104 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:25:45,061 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzNzRFNjc1NThGQzE1QTBEQgA="}]}
2025-09-27 01:25:45,063 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzNzRFNjc1NThGQzE1QTBEQgA='}]}
2025-09-27 01:25:45,063 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:25:45,688 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:25:45,987 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:25:46,119 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:46] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:25:46,770 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:46] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:27:13,313 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:27:13] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:27:13,639 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:27:13] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:27:54,577 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:27:56,430 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:27:56,758 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:27:56,758 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:29:04,631 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:29:06,285 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:29:07,827 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:29:08,017 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:29:08,207 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:08,398 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:08,587 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:08,778 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:08,967 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,157 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,357 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,554 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,747 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,937 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:10,127 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:10,318 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:10,508 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:10,697 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:12,438 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:29:12,628 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:29:12,629 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:29:12,629 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:29:12,631 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:29:12,631 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:29:12,631 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:29:12,632 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:29:12,633 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:29:12,633 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:29:12,633 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:29:14,125 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:29:14,140 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:29:14,317 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:29:14,507 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:14,697 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:14,889 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,077 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,267 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,457 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,648 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,838 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,029 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,218 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,407 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,597 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,787 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,977 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:19,074 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:29:19,268 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:29:19,268 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:29:19,269 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:29:19,269 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:29:19,269 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:29:19,270 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:29:19,271 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:29:19,271 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:29:19,271 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:29:19,272 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:29:19,272 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:29:19,707 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:29:19,707 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:29:19,708 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:29:19,708 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:29:19,709 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:29:19,709 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:29:19,728 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:29:19,728 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:29:25,358 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:29:25,359 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:29:26,908 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:29:28,268 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:29:27.097511+00:00, interaction_count=406, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:29:28,837 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:29:28,838 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:29:28,838 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:29:30,398 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:29:30,587 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to AI bulk order.
2025-09-27 01:29:30,588 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': 'AIHandler' object has no attribute 'handle_ai_bulk_order'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 185, in _route_to_handler
    return self.ai_handler.handle_ai_bulk_order(state, session_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'AIHandler' object has no attribute 'handle_ai_bulk_order'. Did you mean: 'handle_ai_bulk_order_state'?
2025-09-27 01:29:30,590 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:29:31,799 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3MjY5N0NGNjdCNENDMDlBMwA="}]}
2025-09-27 01:29:31,799 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3MjY5N0NGNjdCNENDMDlBMwA='}], 'recipient_id': '2348055614455'}
2025-09-27 01:29:31,800 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:29:31] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:29:32,920 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:29:32] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:29:33,328 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:29:33] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:29:33,698 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:29:33] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:29:58,480 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:29:58,481 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:30:03,417 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:30:04,651 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:30:06,317 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:30:06,507 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:30:06,698 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:06,887 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,077 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,268 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,458 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,647 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,837 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,027 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,218 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,418 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,628 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,820 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:09,017 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:09,212 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:10,940 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:30:11,128 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:30:11,129 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:30:11,129 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:30:11,130 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:30:11,130 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:30:11,131 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:30:11,131 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:30:11,132 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:30:11,132 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:30:11,133 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:30:12,648 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:30:12,650 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:30:12,837 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:30:13,027 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,217 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,410 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,608 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,797 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,987 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,177 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,367 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,557 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,749 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,947 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:15,139 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:15,337 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:15,641 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:17,602 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:30:17,800 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:30:17,800 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:30:17,801 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:30:17,801 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:30:17,801 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:30:17,801 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:30:17,802 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:30:17,802 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:30:17,803 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:30:17,803 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:30:17,803 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:30:18,199 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:30:18,199 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:30:18,200 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:30:18,200 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:30:18,200 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:30:18,201 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:30:18,214 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:30:18,214 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:30:21,551 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:30:21,552 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:30:23,089 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:30:24,437 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:30:23.277773+00:00, interaction_count=407, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:30:25,008 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:30:25,009 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:30:25,010 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:30:26,538 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:30:26,732 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to AI bulk order.
2025-09-27 01:30:26,732 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': 'AIHandler' object has no attribute 'handle_ai_bulk_order'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 185, in _route_to_handler
    return self.ai_handler.handle_ai_bulk_order(state, session_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'AIHandler' object has no attribute 'handle_ai_bulk_order'. Did you mean: 'handle_ai_bulk_order_state'?
2025-09-27 01:30:26,734 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:30:27,918 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNDMDUzOTM0NkQ2Qjc4QjA5QQA="}]}
2025-09-27 01:30:27,919 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNDMDUzOTM0NkQ2Qjc4QjA5QQA='}], 'recipient_id': '2348055614455'}
2025-09-27 01:30:27,920 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:30:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:30:29,005 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:30:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:30:29,730 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:30:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:30:29,732 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:30:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:35:12,851 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:35:14,511 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:35:34,218 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:35:34,219 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:35:43,352 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:35:44,839 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:35:46,387 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:35:46,576 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:35:46,767 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:46,956 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,147 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,338 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,526 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,708 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,896 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,086 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,276 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,468 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,656 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,836 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:49,026 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:49,217 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:50,957 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:35:51,148 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:35:51,149 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:35:51,149 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:35:51,150 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:35:51,151 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:35:51,151 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:35:51,151 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:35:51,152 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:35:51,152 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:35:51,153 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:35:52,717 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:35:52,719 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:35:52,912 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:35:53,114 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:53,317 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:53,516 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:53,706 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:53,897 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,113 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,306 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,502 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,718 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,907 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:55,097 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:55,286 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:55,476 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:55,683 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:57,527 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:35:57,718 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:35:57,718 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:35:57,718 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:35:57,719 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:35:57,719 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:35:57,719 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:35:57,720 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:35:57,721 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:35:57,721 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:35:57,721 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:35:57,722 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:35:58,153 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:35:58,154 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:35:58,154 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:35:58,154 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:35:58,155 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:35:58,155 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:35:58,186 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:35:58,187 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:35:58,980 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:35:58,980 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:36:00,538 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:36:01,880 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:36:00.716747+00:00, interaction_count=408, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:36:02,447 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:36:02,448 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:36:02,448 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:36:03,990 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:36:04,177 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:36:04,178 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:36:04,178 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:36:04,179 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:36:06,048 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBOTgxMzE3NTYxMThFM0NDQgA="}]}
2025-09-27 01:36:06,049 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:36:07,447 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM4OTgzQzEzQzQzQUVDN0EwOQA="}]}
2025-09-27 01:36:07,448 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM4OTgzQzEzQzQzQUVDN0EwOQA='}]}
2025-09-27 01:36:07,449 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:07] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:07,863 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:07] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:08,021 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:08] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:08,347 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:08] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:08,587 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:08] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:08,819 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:08] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:09,209 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:09] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:10,196 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 01:36:11,716 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:36:13,182 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:36:11.908985+00:00, interaction_count=409, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:36:13,847 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:36:13,848 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:36:13,848 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:36:13,848 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 01:36:13,849 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 01:36:13,849 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 01:36:13,849 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 01:36:13,850 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:36:13,850 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 01:36:15,086 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjczNTIxQzYwMUZBNDdDRjc2RAA="}]}
2025-09-27 01:36:15,087 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:36:15,087 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-27 01:36:16,307 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCMjY2RDY2Mzc1MzQ0MEJBQQA="}]}
2025-09-27 01:36:16,308 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCMjY2RDY2Mzc1MzQ0MEJBQQA='}]}
2025-09-27 01:36:16,309 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:16,720 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:17,180 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:17,298 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:17,299 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:17,659 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:18,116 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:18] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:27,238 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-27 01:36:28,806 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:36:30,136 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:36:28.997163+00:00, interaction_count=410, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:36:30,706 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:36:30,707 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:36:30,708 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:36:30,708 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-27 01:36:34,849 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:36:34,857 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:36:35,957 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc3QkM5RDdBNkUxRjJCMzc2RAA="}]}
2025-09-27 01:36:35,958 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc3QkM5RDdBNkUxRjJCMzc2RAA='}]}
2025-09-27 01:36:35,959 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:35] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:36,787 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:37,409 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:37] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:37,686 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:37] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:03,644 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '1 portion of jellof rice and 3 portion of fried rice'}
2025-09-27 01:37:05,186 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:06,537 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:05.377046+00:00, interaction_count=411, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:07,096 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:07,097 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:37:07,097 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:37:10,349 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:37:10,356 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:37:11,657 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBMkEzMkVGMUZCQUQ4RjAyMQA="}]}
2025-09-27 01:37:11,658 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBMkEzMkVGMUZCQUQ4RjAyMQA='}]}
2025-09-27 01:37:11,658 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:11] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:12,815 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:12] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:13,319 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:13] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:13,428 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:13] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:24,028 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-27 01:37:25,596 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:26,936 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:25.787027+00:00, interaction_count=412, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:27,507 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:27,508 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:37:27,509 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:37:27,509 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof rice': {'item_id': 1, 'quantity': 1, 'price': 500.0, 'total_price': 500.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Fried rice': {'item_id': 2, 'quantity': 3, 'price': 550.0, 'total_price': 1650.0, 'variations': {}, 'food_share_pattern': 'Portion'}}. Redirecting to order handler.
2025-09-27 01:37:27,509 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-27 01:37:27,510 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:37:27,510 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-27 01:37:27,511 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-27 01:37:27,518 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:37:28,587 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZCMzc4RjM2RDFGMzdFRjY1MAA="}]}
2025-09-27 01:37:29,603 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:30,106 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:30,209 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:30] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:30,318 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:30] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:31,436 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:30.297236+00:00, interaction_count=413, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:32,008 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:32,017 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-27 01:37:32,017 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZCMzc4RjM2RDFGMzdFRjY1MAA='}]}
2025-09-27 01:37:32,018 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:32] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:32,152 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-27 01:37:33,716 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:35,076 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:33.920964+00:00, interaction_count=414, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:35,658 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:35,658 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:37:35,659 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:37:35,659 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-27 01:37:35,659 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:37:35,671 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:37:36,789 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU0RTk5NzJCNzU3M0ZFNzM1MQA="}]}
2025-09-27 01:37:37,893 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:37] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:38,316 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:38,489 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:38] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:38,519 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:38] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:39,676 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:38.507295+00:00, interaction_count=415, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:40,224 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:40,229 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-27 01:37:40,229 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU0RTk5NzJCNzU3M0ZFNzM1MQA='}]}
2025-09-27 01:37:40,230 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:40] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:40:52,924 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:40:54,718 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:42:46,423 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:42:46,435 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:42:48,364 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:42:49,536 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:42:51,086 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:42:51,278 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:42:51,476 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:51,665 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:51,855 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,045 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,235 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,425 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,625 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,826 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,016 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,207 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,395 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,597 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,796 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,987 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:55,706 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:42:55,888 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:42:55,922 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:42:55,923 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:42:55,925 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:42:55,925 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:42:55,932 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:42:55,936 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:42:55,939 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:42:55,939 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:42:55,940 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:42:57,458 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:42:57,487 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:42:57,675 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:42:57,866 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,055 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,245 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,435 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,628 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,825 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,015 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,205 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,395 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,585 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,787 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,975 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:43:00,165 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:43:00,355 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:43:02,087 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:43:02,276 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:43:02,276 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:43:02,277 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:43:02,277 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:43:02,277 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:43:02,278 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:43:02,278 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:43:02,279 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:43:02,279 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:43:02,279 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:43:02,280 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:43:02,678 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:43:02,678 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:43:02,678 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:43:02,679 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:43:02,679 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:43:02,680 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:43:02,694 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:43:02,694 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:43:18,586 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:43:18,586 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:43:20,126 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:43:21,465 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:43:20.315444+00:00, interaction_count=416, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:43:22,035 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:43:22,036 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:43:22,037 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:43:23,555 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:43:23,746 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:43:23,746 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:43:23,747 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:43:23,747 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:43:25,266 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExRDk5Njg0NTNCOTE4QjQyRAA="}]}
2025-09-27 01:43:25,267 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:43:26,286 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM5OTMwNjQzQjg2NUQ4NkFFNgA="}]}
2025-09-27 01:43:26,287 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM5OTMwNjQzQjg2NUQ4NkFFNgA='}]}
2025-09-27 01:43:26,288 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:26,987 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:27,536 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:27,648 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:28,107 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:28,258 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:28,576 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:29,666 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 01:43:31,195 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:43:32,505 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:43:31.386532+00:00, interaction_count=417, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:43:33,075 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:43:33,076 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:43:33,076 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:43:33,077 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 01:43:33,077 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 01:43:33,077 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 01:43:33,078 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 01:43:33,078 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:43:33,078 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 01:43:34,126 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc4NzUxMzY0N0JGMDc1M0Q3QQA="}]}
2025-09-27 01:43:34,127 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:43:34,127 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi! Please tell me what you'd like to order.\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nWhat would you like to order?"}}
2025-09-27 01:43:35,236 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5QjM0MDJGQUU0MTJGNjg3QgA="}]}
2025-09-27 01:43:35,237 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5QjM0MDJGQUU0MTJGNjg3QgA='}]}
2025-09-27 01:43:35,237 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:35] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:35,619 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:35] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,128 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,358 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,567 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,937 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,977 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:44:46,722 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '1 portion of fried rice and 2 portion jellof rice in 2 packs'}
2025-09-27 01:44:48,275 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:44:49,595 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:44:48.450799+00:00, interaction_count=418, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:44:50,165 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:44:50,165 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:44:50,166 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:44:50,166 - handlers.base_handler - INFO - AIHandler: Handling message '1 portion of fried rice and 2 portion jellof rice in 2 packs' in AI bulk order state for session 2348055614455. Original: '1 portion of fried rice and 2 portion jellof rice in 2 packs'
2025-09-27 01:44:53,556 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:44:53,565 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:44:54,865 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEzOTdDMzM0RjBDQzJCNENEOAA="}]}
2025-09-27 01:44:54,866 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEzOTdDMzM0RjBDQzJCNENEOAA='}]}
2025-09-27 01:44:54,867 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:44:54] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:44:55,874 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:44:55] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:44:56,487 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:44:56] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:44:56,689 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:44:56] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:47:57,651 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:47:59,448 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:52:59,658 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:53:01,466 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:53:37,362 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:53:37,374 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:53:40,024 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:53:41,491 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:53:43,043 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:53:43,234 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:53:43,423 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:43,616 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:43,803 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:43,993 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,193 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,384 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,574 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,764 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,954 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,143 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,334 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,526 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,714 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,904 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:47,704 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:53:47,894 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:53:47,895 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:53:47,895 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:53:47,896 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:53:47,896 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:53:47,897 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:53:47,897 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:53:47,898 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:53:47,898 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:53:47,899 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:53:49,424 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:53:49,426 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:53:49,614 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:53:49,805 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,004 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,194 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,375 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,563 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,754 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,944 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,123 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,313 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,503 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,704 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,894 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:52,085 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:52,274 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:53,994 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:53:54,185 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:53:54,185 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:53:54,185 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:53:54,186 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:53:54,186 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:53:54,186 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:53:54,197 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:53:54,197 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:53:54,197 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:53:54,198 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:53:54,198 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:53:54,613 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:53:54,613 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:53:54,613 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:53:54,614 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:53:54,614 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:53:54,615 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:53:54,645 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:53:54,645 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:53:54,805 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:53:54,805 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:53:56,324 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:53:57,664 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:53:56.514464+00:00, interaction_count=419, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:53:58,264 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:53:58,264 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:53:58,265 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:53:59,894 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:54:00,084 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:54:00,084 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:54:00,085 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:54:00,085 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:54:01,574 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRCRTM0ODZEMTY1MDZGNUZENAA="}]}
2025-09-27 01:54:01,575 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:54:02,745 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBQjhCQzBDM0JBOTIxNTlDNAA="}]}
2025-09-27 01:54:02,746 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBQjhCQzBDM0JBOTIxNTlDNAA='}]}
2025-09-27 01:54:02,747 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:02] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:03,016 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:03] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:03,897 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:03] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:04,017 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:04] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:04,027 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:04] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:04,097 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:04] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:04,556 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:04] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:05,476 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 01:54:07,004 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:54:08,344 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:54:07.194019+00:00, interaction_count=420, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:54:08,914 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:54:08,915 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:54:08,915 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:54:08,915 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 01:54:08,915 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 01:54:08,916 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 01:54:08,916 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 01:54:08,916 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:54:08,917 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 01:54:09,946 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFQ0JFRDQzQThDOUNBQTg0MQA="}]}
2025-09-27 01:54:09,947 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:54:09,948 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-09-27 01:54:10,994 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY4Rjk0NUQwRTc0MkFEMEM1QQA="}]}
2025-09-27 01:54:10,995 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY4Rjk0NUQwRTc0MkFEMEM1QQA='}]}
2025-09-27 01:54:10,996 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:10] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:11,330 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:11] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:11,855 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:11] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:11,976 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:11] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:12,227 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:12] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:12,559 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:12] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:12,577 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:12] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:34,606 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello I want 3 Jellof rice and fried rice for 3 people \nAdd chicken in one and fish in the other two'}
2025-09-27 01:54:36,124 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:54:37,464 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:54:36.314281+00:00, interaction_count=421, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:54:38,033 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:54:38,034 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:54:38,034 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:54:38,035 - handlers.base_handler - INFO - AIHandler: Handling message 'hello i want 3 jellof rice and fried rice for 3 people 
add chicken in one and fish in the other two' in AI bulk order state for session 2348055614455. Original: 'Hello I want 3 Jellof rice and fried rice for 3 people 
Add chicken in one and fish in the other two'
2025-09-27 01:54:43,104 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:54:43,112 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:54:44,334 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3M0UwREQ3N0ZFNDI3QzRBNgA="}]}
2025-09-27 01:54:44,335 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3M0UwREQ3N0ZFNDI3QzRBNgA='}]}
2025-09-27 01:54:44,335 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:44] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:45,594 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:45,936 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:46,286 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:46] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:58:49,619 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:58:51,457 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 02:02:39,579 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 02:02:39,590 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 02:03:17,355 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 02:03:19,806 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 02:03:21,389 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 02:03:21,582 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 02:03:21,772 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:21,963 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,162 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,352 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,547 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,742 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,932 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,122 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,312 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,502 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,692 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,888 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:24,082 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:24,272 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:26,002 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 02:03:26,194 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 02:03:26,195 - services.payment_service - INFO - PaymentService initialized
2025-09-27 02:03:26,195 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 02:03:26,196 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 02:03:26,196 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 02:03:26,197 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 02:03:26,197 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 02:03:26,198 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:03:26,198 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:03:26,199 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 02:03:27,712 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 02:03:27,715 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 02:03:27,903 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 02:03:28,162 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:28,353 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:28,543 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:28,732 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:28,924 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,122 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,312 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,502 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,692 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,882 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:30,073 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:30,262 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:30,452 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:30,643 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:32,352 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 02:03:32,542 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 02:03:32,543 - services.payment_service - INFO - PaymentService initialized
2025-09-27 02:03:32,543 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 02:03:32,543 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 02:03:32,544 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 02:03:32,544 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 02:03:32,555 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 02:03:32,556 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 02:03:32,556 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 02:03:32,557 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:03:32,557 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:03:32,988 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 02:03:32,988 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 02:03:32,989 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 02:03:32,989 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 02:03:32,989 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:03:32,990 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:03:33,006 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 02:03:33,007 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 02:03:33,783 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 02:03:33,784 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 02:03:35,322 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:03:36,667 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:03:35.512874+00:00, interaction_count=422, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:03:37,242 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:03:37,243 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 02:03:37,243 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:03:38,862 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 02:03:39,205 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 02:03:39,206 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 02:03:39,206 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 02:03:39,207 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 02:03:40,643 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEwRjE0MUYyNTFCQTQyNjYyMQA="}]}
2025-09-27 02:03:40,644 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:03:41,874 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIzN0M1QUNDODQzRjMxQzIzRgA="}]}
2025-09-27 02:03:41,875 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIzN0M1QUNDODQzRjMxQzIzRgA='}]}
2025-09-27 02:03:41,876 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:41] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:42,093 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:42,935 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:42,938 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:42,941 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:43,254 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:43] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:43,596 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:43] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:44,934 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 02:03:46,452 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:03:47,793 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:03:46.643157+00:00, interaction_count=423, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:03:48,362 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:03:48,363 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:03:48,363 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:03:48,364 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 02:03:48,364 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 02:03:48,364 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 02:03:48,365 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 02:03:48,365 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 02:03:48,365 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 02:03:49,413 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE1Q0QyQkI3QUJBNDM4REE2MwA="}]}
2025-09-27 02:03:49,414 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 02:03:49,414 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-09-27 02:03:50,654 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0MEZBNkI3MzExM0ExQUNEQQA="}]}
2025-09-27 02:03:50,655 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0MEZBNkI3MzExM0ExQUNEQQA='}]}
2025-09-27 02:03:50,655 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:50] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:51,149 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:51] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:51,593 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:51] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:51,723 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:51] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:51,853 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:51] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:52,084 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:52] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:52,293 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:52] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:55,125 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello I want 3 Jellof rice and fried rice for 3 people \nAdd chicken in one and fish in\xa0the\xa0other\xa0two'}
2025-09-27 02:03:56,952 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:03:58,461 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:03:57.142831+00:00, interaction_count=424, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:03:59,162 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:03:59,163 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:03:59,164 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:03:59,164 - handlers.base_handler - INFO - AIHandler: Handling message 'hello i want 3 jellof rice and fried rice for 3 people 
add chicken in one and fish intheothertwo' in AI bulk order state for session 2348055614455. Original: 'Hello I want 3 Jellof rice and fried rice for 3 people 
Add chicken in one and fish intheothertwo'
2025-09-27 02:04:04,531 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 02:04:04,540 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:04:05,743 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRCMzNEQTU3QzNDNUZDREFBQwA="}]}
2025-09-27 02:04:05,744 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRCMzNEQTU3QzNDNUZDREFBQwA='}]}
2025-09-27 02:04:05,745 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:05] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:06,600 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:06] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:07,095 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:07] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:07,242 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:07] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:23,431 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'modify_ai_order'}
2025-09-27 02:04:24,953 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:04:26,292 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:04:25.142650+00:00, interaction_count=425, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:04:26,862 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:04:26,863 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:04:26,863 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:04:26,864 - handlers.base_handler - INFO - User chose to modify AI order for session 2348055614455.
2025-09-27 02:04:26,864 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 02:04:26,864 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Please tell me your updated order:'}}
2025-09-27 02:04:28,105 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ3MjkyMzI0MUI1RTY4NjBFQgA="}]}
2025-09-27 02:04:28,105 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ3MjkyMzI0MUI1RTY4NjBFQgA='}]}
2025-09-27 02:04:28,106 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:29,109 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:29,716 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:29,847 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:29,849 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:05:33,753 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 02:05:33,754 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 02:10:58,965 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 02:11:00,311 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 02:11:02,185 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 02:11:02,367 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 02:11:02,562 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:02,753 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:02,933 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:03,133 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:03,333 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:03,532 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:03,733 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:03,934 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:04,141 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:04,332 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:04,520 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:04,719 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:04,914 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:05,113 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:06,785 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 02:11:06,988 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 02:11:06,989 - services.payment_service - INFO - PaymentService initialized
2025-09-27 02:11:06,989 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 02:11:06,991 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 02:11:06,991 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 02:11:06,991 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 02:11:06,992 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 02:11:06,992 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:11:06,993 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:11:06,993 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 02:11:08,540 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 02:11:08,585 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 02:11:08,732 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 02:11:08,924 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:09,121 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:09,303 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:09,492 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:09,686 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:09,882 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:10,072 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:10,263 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:10,453 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:10,645 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:10,842 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:11,031 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:11,236 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:11,433 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:11:13,193 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 02:11:13,384 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 02:11:13,384 - services.payment_service - INFO - PaymentService initialized
2025-09-27 02:11:13,384 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 02:11:13,385 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 02:11:13,385 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 02:11:13,385 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 02:11:13,387 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 02:11:13,387 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 02:11:13,387 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 02:11:13,388 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:11:13,388 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:11:13,812 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 02:11:13,813 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 02:11:13,813 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 02:11:13,814 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 02:11:13,814 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:11:13,815 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:11:13,842 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 02:11:13,842 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 02:12:07,389 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 02:12:07,389 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 02:12:08,928 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:12:10,268 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:12:09.118603+00:00, interaction_count=426, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:12:10,848 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:12:10,849 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 02:12:10,850 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:12:12,388 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 02:12:12,580 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 02:12:12,581 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 02:12:12,581 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 02:12:12,582 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 02:12:13,909 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE2NUUyQkZCMzFDMDFDODc0RQA="}]}
2025-09-27 02:12:13,911 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:12:14,785 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxRjkyQTdENkY1ODQ3QzQxNAA="}]}
2025-09-27 02:12:14,785 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxRjkyQTdENkY1ODQ3QzQxNAA='}]}
2025-09-27 02:12:14,787 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:14] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:15,369 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:15] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:15,681 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:15] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:15,973 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:15] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:16,238 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:16,421 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:16,574 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:17,538 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 02:12:19,130 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:12:20,471 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:12:19.322424+00:00, interaction_count=427, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:12:21,059 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:12:21,060 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:12:21,060 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:12:21,061 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 02:12:21,061 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 02:12:21,061 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 02:12:21,061 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 02:12:21,062 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 02:12:21,062 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 02:12:21,969 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxQjJBMjU1MzM0Q0I4QTY5MwA="}]}
2025-09-27 02:12:21,970 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 02:12:21,970 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-09-27 02:12:23,019 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM3OUI2NzJEOEM1QjVDMzBCMQA="}]}
2025-09-27 02:12:23,020 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM3OUI2NzJEOEM1QjVDMzBCMQA='}]}
2025-09-27 02:12:23,020 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:23] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:23,140 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:23] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:24,011 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:24] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:24,063 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:24] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:24,332 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:24] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:24,724 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:24] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:24,774 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:24] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:27,202 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello I want 3 Jellof rice and fried rice for 3 people \nAdd chicken in one and fish in\xa0the\xa0other\xa0two'}
2025-09-27 02:12:28,740 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:12:30,259 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:12:28.930796+00:00, interaction_count=428, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:12:30,830 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:12:30,831 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:12:30,831 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:12:30,832 - handlers.base_handler - INFO - AIHandler: Handling message 'hello i want 3 jellof rice and fried rice for 3 people 
add chicken in one and fish intheothertwo' in AI bulk order state for session 2348055614455. Original: 'Hello I want 3 Jellof rice and fried rice for 3 people 
Add chicken in one and fish intheothertwo'
2025-09-27 02:12:36,303 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 02:12:36,319 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:12:37,341 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAzREMxOUU2RkRBQjIyMEFBQgA="}]}
2025-09-27 02:12:37,342 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAzREMxOUU2RkRBQjIyMEFBQgA='}]}
2025-09-27 02:12:37,343 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:37] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:38,346 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:38] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:38,754 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:38] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:39,253 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:39] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:44,002 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-27 02:12:45,652 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:12:46,981 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:12:45.841782+00:00, interaction_count=429, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:12:47,551 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:12:47,552 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:12:47,552 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:12:47,553 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof rice': {'item_id': 1, 'quantity': 3, 'price': 500.0, 'total_price': 1500.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Fried rice': {'item_id': 2, 'quantity': 3, 'price': 550.0, 'total_price': 1650.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Chicken': {'item_id': 29, 'quantity': 1, 'price': 1000.0, 'total_price': 1000.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Fish': {'item_id': 30, 'quantity': 2, 'price': 1000.0, 'total_price': 2000.0, 'variations': {}, 'food_share_pattern': 'Portion'}}. Redirecting to order handler.
2025-09-27 02:12:47,553 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-27 02:12:47,553 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 02:12:47,554 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-27 02:12:47,554 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-27 02:12:47,572 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:12:48,598 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ3NDdENTM2MDZBN0QyQTUyNgA="}]}
2025-09-27 02:12:49,516 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:12:49] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:12:49,973 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 02:12:49,974 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 02:12:53,372 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 02:12:54,611 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 02:12:56,184 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 02:12:56,381 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 02:12:56,572 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:56,767 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:56,962 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:57,152 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:57,342 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:57,535 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:57,734 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:57,916 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:58,103 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:58,292 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:58,481 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:58,672 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:58,862 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:12:59,052 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:00,783 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 02:13:00,974 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 02:13:00,974 - services.payment_service - INFO - PaymentService initialized
2025-09-27 02:13:00,975 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 02:13:00,976 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 02:13:00,976 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 02:13:00,976 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 02:13:00,977 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 02:13:00,978 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:13:00,978 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:13:00,978 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 02:13:02,513 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 02:13:02,523 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 02:13:02,703 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 02:13:02,897 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:03,093 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:03,283 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:03,472 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:03,667 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:03,865 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:04,063 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:04,254 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:04,443 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:04,745 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:04,932 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:05,127 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:05,323 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:05,503 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:13:07,254 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 02:13:07,444 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 02:13:07,444 - services.payment_service - INFO - PaymentService initialized
2025-09-27 02:13:07,445 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 02:13:07,445 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 02:13:07,445 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 02:13:07,446 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 02:13:07,448 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 02:13:07,448 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 02:13:07,449 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 02:13:07,449 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:13:07,450 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:13:07,841 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 02:13:07,841 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 02:13:07,841 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 02:13:07,842 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 02:13:07,842 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:13:07,843 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:13:07,867 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 02:13:07,868 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 02:13:17,965 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-27 02:13:17,966 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 02:13:18,165 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:18] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:19,156 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 02:13:19,484 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:13:20,035 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:20] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:20,684 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:13:20,825 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:13:19.675059+00:00, interaction_count=430, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:13:21,394 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:13:21,394 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 02:13:21,395 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:13:22,024 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:13:20.877276+00:00, interaction_count=430, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:13:22,594 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:13:22,594 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 02:13:22,595 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:13:22,934 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 02:13:23,127 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 02:13:23,128 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-27 02:13:23,128 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 02:13:24,134 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 02:13:24,155 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA0MjVCMkZGQ0IzNTkxNTcxQQA="}]}
2025-09-27 02:13:24,155 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:13:24,325 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 02:13:24,326 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 02:13:24,326 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 02:13:24,327 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 02:13:25,216 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVFOEU4MDU0REY1MjcyNzk3QQA="}]}
2025-09-27 02:13:25,217 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVFOEU4MDU0REY1MjcyNzk3QQA='}]}
2025-09-27 02:13:25,218 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:25] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:25,315 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcyNDBDOUQ2ODZGMzhFNzc0OQA="}]}
2025-09-27 02:13:25,315 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:13:25,515 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:25] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:26,048 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:26,178 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:26,314 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjREQjQxNEU4NTUyNDkzREQzOQA="}]}
2025-09-27 02:13:26,315 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjREQjQxNEU4NTUyNDkzREQzOQA='}]}
2025-09-27 02:13:26,316 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:26,586 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:26,858 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:26,993 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:27,400 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:27,569 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:27,667 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:27,829 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:28,077 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:28,137 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:29,247 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 02:13:30,795 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:13:32,135 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:13:30.987930+00:00, interaction_count=432, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:13:32,705 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:13:32,706 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:13:32,707 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:13:32,707 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 02:13:32,707 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 02:13:32,707 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 02:13:32,708 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 02:13:32,708 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 02:13:32,709 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 02:13:33,697 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNFQzE4QkEyOTQwMUU4QUJGRAA="}]}
2025-09-27 02:13:33,698 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 02:13:33,699 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-09-27 02:13:34,686 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBQkE4QkVDMTI3MzBBNjQ3MwA="}]}
2025-09-27 02:13:34,687 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBQkE4QkVDMTI3MzBBNjQ3MwA='}]}
2025-09-27 02:13:34,688 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:34] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:34,913 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:34] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:35,578 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:35] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:35,707 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:35] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:35,828 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:35] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:36,281 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:36,668 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:39,800 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello I want 3 Jellof rice and fried rice for 3 people \nAdd chicken in one and fish in\xa0the\xa0other\xa0two'}
2025-09-27 02:13:41,327 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:13:42,666 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:13:41.516205+00:00, interaction_count=433, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:13:43,236 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:13:43,237 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:13:43,237 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:13:43,238 - handlers.base_handler - INFO - AIHandler: Handling message 'hello i want 3 jellof rice and fried rice for 3 people 
add chicken in one and fish intheothertwo' in AI bulk order state for session 2348055614455. Original: 'Hello I want 3 Jellof rice and fried rice for 3 people 
Add chicken in one and fish intheothertwo'
2025-09-27 02:13:47,338 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 02:13:47,345 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:13:48,467 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMzREZDRDI4NzczNzgxOTI1MQA="}]}
2025-09-27 02:13:48,468 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMzREZDRDI4NzczNzgxOTI1MQA='}]}
2025-09-27 02:13:48,469 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:48] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:49,397 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:49] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:49,831 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:49] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:50,350 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:50] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:51,160 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'modify_ai_order'}
2025-09-27 02:13:52,696 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:13:54,027 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:13:52.888123+00:00, interaction_count=434, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:13:54,649 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:13:54,649 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:13:54,650 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:13:54,650 - handlers.base_handler - INFO - User chose to modify AI order for session 2348055614455.
2025-09-27 02:13:54,650 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 02:13:55,657 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlDMzUxNzM1QkFEN0I3NTdFQQA="}]}
2025-09-27 02:13:55,658 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlDMzUxNzM1QkFEN0I3NTdFQQA='}]}
2025-09-27 02:13:55,659 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:55] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:56,663 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:56] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:57,130 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:57] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:13:58,168 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:13:58] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:14:31,801 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Remove 1 fish and add 3 eggs in each plate and then add 1 jellof rice portion for each pack'}
2025-09-27 02:14:33,303 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:14:34,673 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:14:33.491298+00:00, interaction_count=435, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:14:35,252 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:14:35,253 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:14:35,253 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:14:35,253 - handlers.message_processor - WARNING - Session 2348055614455: Unhandled AI state 'ai_order_modification'. Continuing with AI bulk order.
2025-09-27 02:14:35,254 - handlers.base_handler - INFO - AIHandler: Handling message 'continue_ordering' in AI bulk order state for session 2348055614455. Original: 'Remove 1 fish and add 3 eggs in each plate and then add 1 jellof rice portion for each pack'
2025-09-27 02:14:38,835 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 02:14:38,842 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:14:39,884 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE4QjI3MEFGRTAyODc4QUUxMwA="}]}
2025-09-27 02:14:39,885 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE4QjI3MEFGRTAyODc4QUUxMwA='}]}
2025-09-27 02:14:39,886 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:14:39] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:14:40,843 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:14:40] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:14:41,404 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:14:41] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:14:41,723 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:14:41] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:31:50,034 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-29 00:31:51,637 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-29 00:31:54,179 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-29 00:31:54,369 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-29 00:31:54,569 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:54,759 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:54,949 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:55,149 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:55,339 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:55,529 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:55,719 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:55,909 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:56,099 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:56,289 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:56,479 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:56,669 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:56,869 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:57,059 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:31:58,781 - utils.data_manager - INFO - Successfully loaded 61 user details from database
2025-09-29 00:31:58,984 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-29 00:31:58,985 - services.payment_service - INFO - PaymentService initialized
2025-09-29 00:31:58,985 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-29 00:31:58,986 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-29 00:31:58,986 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-29 00:31:58,987 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-29 00:31:58,987 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-29 00:31:58,987 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-29 00:31:58,988 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-29 00:31:58,991 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-29 00:32:00,524 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-29 00:32:00,540 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-29 00:32:00,740 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-29 00:32:00,949 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:01,139 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:01,329 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:01,519 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:01,710 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:01,909 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:02,109 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:02,300 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:02,501 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:02,701 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:02,911 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:03,109 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:03,299 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:03,489 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:32:05,210 - utils.data_manager - INFO - Successfully loaded 61 user details from database
2025-09-29 00:32:05,400 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-29 00:32:05,400 - services.payment_service - INFO - PaymentService initialized
2025-09-29 00:32:05,401 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-29 00:32:05,401 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-29 00:32:05,401 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-29 00:32:05,401 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-29 00:32:05,404 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-29 00:32:05,404 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-29 00:32:05,404 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-29 00:32:05,405 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-29 00:32:05,405 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-29 00:32:05,943 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-29 00:32:05,943 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-29 00:32:05,944 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-29 00:32:05,944 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-29 00:32:05,944 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-29 00:32:05,947 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-29 00:32:05,983 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-29 00:32:05,983 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-29 00:33:35,454 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-29 00:33:35,455 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-29 00:33:37,022 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:33:38,350 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:33:37.219199+00:00, interaction_count=436, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:33:38,939 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:33:38,940 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-29 00:33:38,940 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:33:40,489 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-29 00:33:40,682 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-29 00:33:40,682 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-29 00:33:40,683 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-29 00:33:40,683 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-29 00:33:42,290 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUwMjg0MDM1MUFGQjMyOUNFMQA="}]}
2025-09-29 00:33:42,314 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-29 00:33:43,339 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY4MTRBMjhCOEREQTc2MDYzMQA="}]}
2025-09-29 00:33:43,340 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY4MTRBMjhCOEREQTc2MDYzMQA='}]}
2025-09-29 00:33:43,353 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:43] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:44,039 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:44] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:44,393 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:44] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:44,935 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:44] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:45,562 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:46,921 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-29 00:33:48,479 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:33:49,819 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:33:48.670064+00:00, interaction_count=437, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:33:50,389 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:33:50,391 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:33:50,392 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:33:50,392 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-29 00:33:50,392 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-29 00:33:50,393 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-29 00:33:50,393 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-29 00:33:50,393 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-29 00:33:50,394 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-monday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-29 00:33:51,371 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhFODJDNUZCMEI0RDU4NzY4MQA="}]}
2025-09-29 00:33:51,375 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-29 00:33:51,376 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-09-29 00:33:52,359 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI2NjVBMDM0NTNCMjk2RDM1MwA="}]}
2025-09-29 00:33:52,360 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI2NjVBMDM0NTNCMjk2RDM1MwA='}]}
2025-09-29 00:33:52,361 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:52] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:53,130 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:53] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:53,601 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:53] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:53,762 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:53] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:54,112 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:54] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:54,432 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:54] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:33:54,960 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:33:54] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:34:51,605 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'I want to order for three people \n3 portions of jellof rice and fried rice for pack 1 and \nYam and egg for pack 2 and 3 portions for jellof rice and fried rice for pack 3'}
2025-09-29 00:34:53,129 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:34:54,458 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:34:53.310045+00:00, interaction_count=438, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:34:55,049 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:34:55,050 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:34:55,050 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:34:55,050 - handlers.base_handler - INFO - AIHandler: Handling message 'i want to order for three people 
3 portions of jellof rice and fried rice for pack 1 and 
yam and egg for pack 2 and 3 portions for jellof rice and fried rice for pack 3' in AI bulk order state for session 2348055614455. Original: 'I want to order for three people 
3 portions of jellof rice and fried rice for pack 1 and 
Yam and egg for pack 2 and 3 portions for jellof rice and fried rice for pack 3'
2025-09-29 00:34:59,111 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-29 00:34:59,131 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-29 00:35:00,239 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzN0QwNzM3RDFDMTgwOEVBNgA="}]}
2025-09-29 00:35:00,240 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzN0QwNzM3RDFDMTgwOEVBNgA='}]}
2025-09-29 00:35:00,241 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:35:00] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:35:01,189 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:35:01] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:35:02,012 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:35:02] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:37:00,702 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-29 00:37:02,451 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-29 00:40:18,927 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-29 00:40:20,464 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:40:21,834 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:40:20.654998+00:00, interaction_count=439, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:40:22,394 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:40:22,400 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:40:22,402 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:40:22,403 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-29 00:40:22,403 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-29 00:40:22,404 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-29 00:40:22,404 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-29 00:40:23,455 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY3MTk4OEUwMjRCNjA2MDQzRQA="}]}
2025-09-29 00:40:23,457 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-29 00:40:24,363 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMxM0RGRjk1MDMyQkVBOURCMgA="}]}
2025-09-29 00:40:24,364 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMxM0RGRjk1MDMyQkVBOURCMgA='}]}
2025-09-29 00:40:24,365 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:40:24] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:40:25,103 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:40:25] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:40:25,438 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:40:25] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:40:25,981 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:40:25] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:40:26,099 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:40:26] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:42:02,573 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-29 00:42:04,316 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-29 00:42:51,066 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-29 00:42:51,067 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-29 00:45:46,436 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-29 00:45:48,031 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-29 00:45:49,582 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-29 00:45:49,770 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-29 00:45:49,961 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:50,156 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:50,360 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:50,558 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:50,750 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:50,942 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:51,144 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:51,342 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:51,531 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:51,720 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:51,909 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:52,101 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:52,289 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:52,479 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:54,300 - utils.data_manager - INFO - Successfully loaded 61 user details from database
2025-09-29 00:45:54,498 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-29 00:45:54,499 - services.payment_service - INFO - PaymentService initialized
2025-09-29 00:45:54,499 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-29 00:45:54,501 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-29 00:45:54,500 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-29 00:45:54,501 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-29 00:45:54,502 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-29 00:45:54,502 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-29 00:45:54,502 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-29 00:45:54,503 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-29 00:45:56,049 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-29 00:45:56,104 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-29 00:45:56,299 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-29 00:45:56,499 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:56,689 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:56,879 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:57,069 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:57,260 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:57,449 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:57,638 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:57,830 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:58,015 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:58,210 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:58,389 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:58,578 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:58,769 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:45:58,960 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:46:00,689 - utils.data_manager - INFO - Successfully loaded 61 user details from database
2025-09-29 00:46:00,882 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-29 00:46:00,883 - services.payment_service - INFO - PaymentService initialized
2025-09-29 00:46:00,883 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-29 00:46:00,883 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-29 00:46:00,884 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-29 00:46:00,884 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-29 00:46:00,885 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-29 00:46:00,885 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-29 00:46:00,886 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-29 00:46:00,886 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-29 00:46:00,887 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-29 00:46:01,313 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-29 00:46:01,314 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-29 00:46:01,314 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-29 00:46:01,314 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-29 00:46:01,315 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-29 00:46:01,315 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-29 00:46:01,332 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-29 00:46:01,333 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-29 00:46:01,491 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-29 00:46:01,491 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-29 00:46:03,107 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:46:04,427 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:46:03.287745+00:00, interaction_count=440, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:46:05,007 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:46:05,008 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-29 00:46:05,009 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:46:06,546 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-29 00:46:06,739 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-29 00:46:06,739 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-29 00:46:06,740 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-29 00:46:06,740 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-29 00:46:07,726 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE0RjM5MjdENUUxMDUyOUU5NwA="}]}
2025-09-29 00:46:07,727 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-29 00:46:08,597 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQzQUQ5ODYzNTcxMzUwMUQyMgA="}]}
2025-09-29 00:46:08,598 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQzQUQ5ODYzNTcxMzUwMUQyMgA='}]}
2025-09-29 00:46:08,599 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:08] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:09,149 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:09] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:09,911 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:09] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:09,954 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:09] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:10,330 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:10] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:10,338 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:10] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:10,572 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:10] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:11,426 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-29 00:46:12,965 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:46:14,299 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:46:13.155606+00:00, interaction_count=441, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:46:14,885 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:46:14,886 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:46:14,886 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:46:14,887 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-29 00:46:14,887 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-29 00:46:14,887 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-29 00:46:14,888 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-29 00:46:14,888 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-29 00:46:14,888 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-monday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-29 00:46:15,846 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA2NUEzRDQxMTdGN0IzOEJERgA="}]}
2025-09-29 00:46:15,847 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-29 00:46:15,848 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-09-29 00:46:17,064 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFDQUExNkI4QUQwNjgwN0ZFNAA="}]}
2025-09-29 00:46:17,065 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFDQUExNkI4QUQwNjgwN0ZFNAA='}]}
2025-09-29 00:46:17,066 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:17] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:17,317 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:17] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:18,127 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:18] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:18,416 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:18] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:18,936 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:18] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:19,361 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:19] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:32,878 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'I want to order for three people \n3 portions of jellof rice and fried rice for pack 1 and \nYam and egg for pack 2 and 3 portions for jellof rice and fried rice for pack 3'}
2025-09-29 00:46:34,391 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:46:35,720 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:46:34.580787+00:00, interaction_count=442, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:46:36,289 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:46:36,290 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:46:36,291 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:46:36,291 - handlers.base_handler - INFO - AIHandler: Handling message 'i want to order for three people 
3 portions of jellof rice and fried rice for pack 1 and 
yam and egg for pack 2 and 3 portions for jellof rice and fried rice for pack 3' in AI bulk order state for session 2348055614455. Original: 'I want to order for three people 
3 portions of jellof rice and fried rice for pack 1 and 
Yam and egg for pack 2 and 3 portions for jellof rice and fried rice for pack 3'
2025-09-29 00:46:41,540 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-29 00:46:41,551 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-29 00:46:42,529 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI5QUIyRTUyMDgxRTI0NEY3QwA="}]}
2025-09-29 00:46:42,530 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI5QUIyRTUyMDgxRTI0NEY3QwA='}]}
2025-09-29 00:46:42,530 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:42] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:43,418 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:43] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:44,363 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:44] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:54,395 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'modify_ai_order'}
2025-09-29 00:46:55,916 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:46:57,255 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:46:56.115401+00:00, interaction_count=443, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:46:57,825 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:46:57,826 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:46:57,826 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:46:57,827 - handlers.base_handler - INFO - User chose to modify AI order for session 2348055614455.
2025-09-29 00:46:57,827 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-29 00:46:58,785 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBCREE4QzMyODZGOTBENjMwMwA="}]}
2025-09-29 00:46:58,787 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBCREE4QzMyODZGOTBENjMwMwA='}]}
2025-09-29 00:46:58,788 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:58] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:46:59,755 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:46:59] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:47:00,321 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:47:00] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:47:00,621 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:47:00] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:47:28,438 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'I want to add 1 portion of jellof rice to pack 1'}
2025-09-29 00:47:30,188 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:47:31,518 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:47:30.379048+00:00, interaction_count=444, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:47:32,087 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:47:32,088 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:47:32,088 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:47:32,088 - handlers.message_processor - WARNING - Session 2348055614455: Unhandled AI state 'ai_order_modification'. Continuing with AI bulk order.
2025-09-29 00:47:32,089 - handlers.base_handler - INFO - AIHandler: Handling message 'continue_ordering' in AI bulk order state for session 2348055614455. Original: 'I want to add 1 portion of jellof rice to pack 1'
2025-09-29 00:47:34,319 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-29 00:47:34,327 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-29 00:47:35,257 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMxOUJEMjU2QzdENjA2MzM2OQA="}]}
2025-09-29 00:47:35,262 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMxOUJEMjU2QzdENjA2MzM2OQA='}]}
2025-09-29 00:47:35,263 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:47:35] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:47:36,504 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:47:36] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:47:37,121 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:47:37] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:49:04,870 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-29 00:49:04,871 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-29 00:49:06,723 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-29 00:49:08,784 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-29 00:49:10,348 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-29 00:49:10,544 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-29 00:49:10,735 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:10,936 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:11,125 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:11,317 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:11,516 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:11,704 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:11,895 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:12,087 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:12,284 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:12,475 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:12,664 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:12,854 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:13,044 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:13,234 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:14,974 - utils.data_manager - INFO - Successfully loaded 61 user details from database
2025-09-29 00:49:15,158 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-29 00:49:15,159 - services.payment_service - INFO - PaymentService initialized
2025-09-29 00:49:15,159 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-29 00:49:15,161 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-29 00:49:15,160 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-29 00:49:15,161 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-29 00:49:15,161 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-29 00:49:15,162 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-29 00:49:15,162 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-29 00:49:15,163 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-29 00:49:16,683 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-29 00:49:16,687 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-29 00:49:16,874 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-29 00:49:17,063 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:17,254 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:17,443 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:17,633 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:17,829 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:18,023 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:18,224 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:18,424 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:18,614 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:18,803 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:18,991 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:19,182 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:19,374 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:19,573 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-29 00:49:21,304 - utils.data_manager - INFO - Successfully loaded 61 user details from database
2025-09-29 00:49:21,494 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-29 00:49:21,495 - services.payment_service - INFO - PaymentService initialized
2025-09-29 00:49:21,496 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-29 00:49:21,496 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-29 00:49:21,496 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-29 00:49:21,497 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-29 00:49:21,498 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-29 00:49:21,498 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-29 00:49:21,499 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-29 00:49:21,499 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-29 00:49:21,500 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-29 00:49:22,254 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-29 00:49:22,255 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-29 00:49:22,255 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-29 00:49:22,256 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-29 00:49:22,257 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-29 00:49:22,258 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-29 00:49:22,280 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-29 00:49:22,280 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-29 00:49:47,145 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:49:47] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:49:51,439 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-29 00:49:51,439 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-29 00:49:52,985 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:49:54,320 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:49:53.176483+00:00, interaction_count=445, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:49:54,905 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:49:54,906 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-29 00:49:54,907 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:49:56,436 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-29 00:49:56,625 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-29 00:49:56,626 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-29 00:49:56,626 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-29 00:49:56,627 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-29 00:49:57,635 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhCNDI3NDZENTJFQjNDRUMxNgA="}]}
2025-09-29 00:49:57,636 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-29 00:49:58,525 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk5NEYxQjUxOEYyMzQ5NUU4MQA="}]}
2025-09-29 00:49:58,526 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk5NEYxQjUxOEYyMzQ5NUU4MQA='}]}
2025-09-29 00:49:58,527 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:49:58] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:49:59,565 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:49:59] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:49:59,862 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:49:59] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:49:59,892 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:49:59] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:00,155 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:00] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:00,599 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:00] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:00,837 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:00] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:00,997 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:00] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:01,037 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:01] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:02,366 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-29 00:50:03,904 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:50:05,283 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:50:04.093881+00:00, interaction_count=446, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:50:05,853 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:50:05,854 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:50:05,854 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:50:05,855 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-29 00:50:05,855 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-29 00:50:05,855 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-29 00:50:05,856 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-29 00:50:05,856 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-29 00:50:05,857 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-monday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-29 00:50:06,853 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNBNzhEMzUyNjlDMUZGMEYwMgA="}]}
2025-09-29 00:50:06,854 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-29 00:50:06,854 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-09-29 00:50:07,754 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBNzM2QTExNkE4RTU3QThERAA="}]}
2025-09-29 00:50:07,755 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBNzM2QTExNkE4RTU3QThERAA='}]}
2025-09-29 00:50:07,756 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:07] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:08,459 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:08] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:09,222 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:09] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:09,225 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:09] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:09,227 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:09] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:09,475 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:09] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:09,476 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:09] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:09,495 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:09] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:10,095 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:10] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:17,587 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:17] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:36,872 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '3 portion of jollof rice, 3 beef and moi moi one plate\n\nAnother plate should have 3 fried rice, beans and chicken\n\nAnother should have 4 poundo afang and chicken'}
2025-09-29 00:50:38,415 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:50:39,804 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:50:38.606046+00:00, interaction_count=447, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:50:40,375 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:50:40,376 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:50:40,376 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:50:40,377 - handlers.base_handler - INFO - AIHandler: Handling message '3 portion of jollof rice, 3 beef and moi moi one plate

another plate should have 3 fried rice, beans and chicken

another should have 4 poundo afang and chicken' in AI bulk order state for session 2348055614455. Original: '3 portion of jollof rice, 3 beef and moi moi one plate

Another plate should have 3 fried rice, beans and chicken

Another should have 4 poundo afang and chicken'
2025-09-29 00:50:47,555 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-29 00:50:47,575 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-29 00:50:48,610 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMyMUExNDgzODZFOEE1NTgwOQA="}]}
2025-09-29 00:50:48,611 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMyMUExNDgzODZFOEE1NTgwOQA='}]}
2025-09-29 00:50:48,612 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:48] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:49,649 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:49] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:50,105 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:50] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:50:50,315 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:50:50] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:51:32,383 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'modify_ai_order'}
2025-09-29 00:51:33,974 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:51:36,343 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:51:34.165712+00:00, interaction_count=448, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:51:36,923 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:51:36,924 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:51:36,924 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:51:36,925 - handlers.base_handler - INFO - User chose to modify AI order for session 2348055614455.
2025-09-29 00:51:36,925 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-29 00:51:38,765 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyQkNFQTc5NDQ3QTQyQTlGOAA="}]}
2025-09-29 00:51:38,766 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyQkNFQTc5NDQ3QTQyQTlGOAA='}]}
2025-09-29 00:51:38,767 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:51:38] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:51:40,051 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:51:40] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:51:40,374 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:51:40] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:51:40,444 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:51:40] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:51:43,562 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '3 moi moi , 2 jollof and beef for 3 people'}
2025-09-29 00:51:45,130 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-29 00:51:46,743 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-28 23:51:45.328718+00:00, interaction_count=449, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-29 00:51:47,310 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-29 00:51:47,311 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-29 00:51:47,312 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-29 00:51:47,312 - handlers.message_processor - WARNING - Session 2348055614455: Unhandled AI state 'ai_order_modification'. Continuing with AI bulk order.
2025-09-29 00:51:47,312 - handlers.base_handler - INFO - AIHandler: Handling message 'continue_ordering' in AI bulk order state for session 2348055614455. Original: '3 moi moi , 2 jollof and beef for 3 people'
2025-09-29 00:51:51,256 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-29 00:51:51,263 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-29 00:51:52,312 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEyRkY2NTAxMjQ1MUU5MkY1RQA="}]}
2025-09-29 00:51:52,313 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEyRkY2NTAxMjQ1MUU5MkY1RQA='}]}
2025-09-29 00:51:52,314 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:51:52] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:51:53,447 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:51:53] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:51:53,783 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:51:53] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:51:54,052 - werkzeug - INFO - 127.0.0.1 - - [29/Sep/2025 00:51:54] "POST /webhook HTTP/1.1" 200 -
2025-09-29 00:52:45,292 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-29 00:52:45,293 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 11:32:33,286 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 11:32:36,810 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 11:32:39,363 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 11:32:39,561 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 11:32:39,761 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:39,946 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:40,137 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:40,328 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:40,546 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:40,735 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:41,070 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:41,263 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:41,450 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:41,641 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:41,841 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:42,033 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:42,231 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:42,420 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:44,153 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 11:32:44,356 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 11:32:44,358 - services.payment_service - INFO - PaymentService initialized
2025-10-01 11:32:44,359 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 11:32:44,361 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 11:32:44,361 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 11:32:44,362 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 11:32:44,363 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 11:32:44,364 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455
2025-10-01 11:32:44,365 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 11:32:44,366 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-01 11:32:44,367 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 11:32:45,878 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 11:32:45,923 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 11:32:46,121 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 11:32:46,325 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:46,523 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:46,721 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:46,921 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:47,131 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:47,321 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:47,511 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:47,700 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:47,892 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:48,100 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:48,370 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:48,561 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:48,761 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:48,961 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:32:50,701 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 11:32:50,894 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 11:32:50,895 - services.payment_service - INFO - PaymentService initialized
2025-10-01 11:32:50,895 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 11:32:50,896 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 11:32:50,897 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 11:32:50,897 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 11:32:50,899 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 11:32:50,899 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 11:32:50,900 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 11:32:50,900 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455
2025-10-01 11:32:50,901 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 11:32:50,901 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-01 11:32:51,459 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 11:32:51,460 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 11:32:51,460 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 11:32:51,461 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 11:32:51,462 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455
2025-10-01 11:32:51,462 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 11:32:51,463 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-01 11:32:51,505 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 11:32:51,505 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 11:34:51,003 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-01 11:34:51,003 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-01 11:34:52,571 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:34:53,911 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:34:52.751379+00:00, interaction_count=451, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-10-01 11:34:54,490 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:34:54,491 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-01 11:34:54,491 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:34:56,031 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-01 11:34:56,271 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 11:34:56,271 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 11:34:56,272 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 11:34:56,272 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 11:34:57,086 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-01 11:34:57,088 - services.whatsapp_service - ERROR - Failed to send image to 2348055614455. Aborting button message.
2025-10-01 11:34:57,089 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:34:57] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:08,668 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 11:36:08,668 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 11:36:09,912 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 11:36:11,539 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 11:36:13,213 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 11:36:13,406 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 11:36:13,639 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:13,860 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:14,048 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:14,265 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:14,461 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:14,659 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:14,845 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:15,036 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:15,230 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:15,411 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:15,601 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:15,801 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:15,990 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:16,175 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:17,897 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 11:36:18,080 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 11:36:18,080 - services.payment_service - INFO - PaymentService initialized
2025-10-01 11:36:18,081 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 11:36:18,082 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 11:36:18,082 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 11:36:18,083 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 11:36:18,083 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 11:36:18,084 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455
2025-10-01 11:36:18,084 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 11:36:18,084 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-01 11:36:18,085 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 11:36:19,600 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 11:36:19,670 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 11:36:19,794 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 11:36:19,990 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:20,180 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:20,383 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:20,580 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:20,771 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:20,971 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:21,161 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:21,340 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:21,529 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:21,720 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:21,910 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:22,101 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:22,302 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:22,490 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:36:24,301 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 11:36:24,525 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 11:36:24,526 - services.payment_service - INFO - PaymentService initialized
2025-10-01 11:36:24,526 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 11:36:24,527 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 11:36:24,528 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 11:36:24,528 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 11:36:24,530 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 11:36:24,531 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 11:36:24,531 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 11:36:24,532 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455
2025-10-01 11:36:24,533 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 11:36:24,534 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-01 11:36:25,346 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 11:36:25,347 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 11:36:25,347 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 11:36:25,348 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 11:36:25,349 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455
2025-10-01 11:36:25,350 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 11:36:25,351 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-01 11:36:25,394 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 11:36:25,395 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 11:36:26,023 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-01 11:36:26,024 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-01 11:36:27,571 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:36:28,951 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:36:27.762559+00:00, interaction_count=452, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-10-01 11:36:29,531 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:36:29,534 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-01 11:36:29,535 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:36:31,091 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-01 11:36:31,319 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 11:36:31,319 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 11:36:31,320 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 11:36:31,321 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 11:36:33,114 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQxOUJEQUJCQTg4NTZEQUQwRQA="}]}
2025-10-01 11:36:33,116 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 11:36:34,563 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZFMkQ1OTc5NjMzMTk4MzhBOAA="}]}
2025-10-01 11:36:34,565 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZFMkQ1OTc5NjMzMTk4MzhBOAA='}]}
2025-10-01 11:36:34,566 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:34] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:34,923 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:34] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:35,703 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:35] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:36,014 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:36] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:36,018 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:36] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:36,322 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:36] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:36,750 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:36] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:42,875 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-10-01 11:36:44,442 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:36:45,841 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:36:44.631507+00:00, interaction_count=453, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-10-01 11:36:46,553 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:36:46,555 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:36:46,556 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:36:46,557 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-10-01 11:36:46,558 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-10-01 11:36:46,559 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-10-01 11:36:46,561 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-10-01 11:36:46,562 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 11:36:46,564 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-10-01 11:36:48,224 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkxQ0E5QkEzODEyQzJDQ0EzQwA="}]}
2025-10-01 11:36:48,227 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 11:36:48,228 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-10-01 11:36:49,842 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZDMjlCMENBRUE5MDM3QjM0RAA="}]}
2025-10-01 11:36:49,845 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZDMjlCMENBRUE5MDM3QjM0RAA='}]}
2025-10-01 11:36:49,847 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:49] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:50,076 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:50] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:50,983 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:50] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:50,987 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:50] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:51,874 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:51] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:36:52,155 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:36:52] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:37:35,053 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:37:35] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:37:35,175 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:37:35] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:37:43,213 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-10-01 11:37:44,951 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:37:46,661 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:37:45.230880+00:00, interaction_count=454, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-10-01 11:37:47,278 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:37:47,279 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:37:47,279 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:37:47,280 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-10-01 11:37:51,347 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-10-01 11:37:51,372 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 11:37:52,721 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUwRTNCM0QyRjI3REQ2RjdENgA="}]}
2025-10-01 11:37:52,722 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUwRTNCM0QyRjI3REQ2RjdENgA='}]}
2025-10-01 11:37:52,724 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:37:52] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:37:53,864 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:37:53] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:37:54,551 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:37:54] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:37:54,644 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:37:54] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:37:57,028 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-10-01 11:37:58,925 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:38:00,381 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:37:59.158755+00:00, interaction_count=455, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-10-01 11:38:01,015 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:38:01,016 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:38:01,016 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:38:01,017 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof rice': {'item_id': 1, 'quantity': 1, 'price': 500.0, 'total_price': 500.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Fried rice': {'item_id': 2, 'quantity': 1, 'price': 550.0, 'total_price': 550.0, 'variations': {}, 'food_share_pattern': 'Portion'}}. Redirecting to order handler.
2025-10-01 11:38:01,018 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-10-01 11:38:01,018 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 11:38:01,019 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-10-01 11:38:01,019 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-10-01 11:38:01,035 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 11:38:02,973 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM3Q0FBODQyNEQ1NkI0QTEzQQA="}]}
2025-10-01 11:38:04,157 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:04] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:04,561 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:38:04,839 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:04] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:06,072 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:38:04.760521+00:00, interaction_count=456, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-10-01 11:38:06,449 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-10-01 11:38:06,670 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:38:06,685 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-01 11:38:06,686 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM3Q0FBODQyNEQ1NkI0QTEzQQA='}]}
2025-10-01 11:38:06,687 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:06] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:08,085 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:38:09,531 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:38:08.290812+00:00, interaction_count=457, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-10-01 11:38:10,198 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:38:10,200 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:38:10,201 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:38:10,202 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-10-01 11:38:10,204 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 11:38:10,236 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 11:38:11,402 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkwRjlCMkQ0OTE1REJEQUM4RAA="}]}
2025-10-01 11:38:12,705 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:12] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:12,980 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:38:13,031 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:13] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:13,134 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:13] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:14,412 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:38:13.170931+00:00, interaction_count=458, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-10-01 11:38:14,990 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:38:15,015 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-01 11:38:15,016 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkwRjlCMkQ0OTE1REJEQUM4RAA='}]}
2025-10-01 11:38:15,017 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:15] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:20,763 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-10-01 11:38:22,312 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:38:23,840 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:38:22.604417+00:00, interaction_count=459, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-10-01 11:38:24,440 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:38:24,442 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:38:24,442 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:38:24,443 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-10-01 11:38:27,726 - utils.data_manager - DEBUG - Found product_id 1 for product_name Jollof rice
2025-10-01 11:38:27,929 - utils.data_manager - DEBUG - Assigned product_id 1 to item Jollof rice
2025-10-01 11:38:29,702 - utils.data_manager - DEBUG - Found product_id 2 for product_name Fried rice
2025-10-01 11:38:29,917 - utils.data_manager - DEBUG - Assigned product_id 2 to item Fried rice
2025-10-01 11:38:29,919 - utils.data_manager - WARNING - No payment_reference provided for order. Generated default: PAY-ORD-4B86357A
2025-10-01 11:38:30,410 - utils.data_manager - INFO - Saved order 220 for customer 2348055614455 with payment_reference PAY-ORD-4B86357A
2025-10-01 11:38:30,703 - utils.data_manager - INFO - Saved order item Jollof rice for order 220
2025-10-01 11:38:30,901 - utils.data_manager - INFO - Saved order item Fried rice for order 220
2025-10-01 11:38:31,109 - handlers.order_handler - INFO - Order ORD-4B86357A saved to database with DB ID 220 for session 2348055614455.
2025-10-01 11:38:31,109 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 11:38:32,681 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:38:34,052 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:38:32.880939+00:00, interaction_count=460, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:38:32.880939+00:00
2025-10-01 11:38:34,681 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:38:34,704 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID ORD-4B86357A
2025-10-01 11:38:34,716 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-10-01 11:38:34,716 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-10-01 11:38:34,717 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-10-01 11:38:38,280 - utils.data_manager - INFO - Updated order 220 to status pending_payment
2025-10-01 11:38:38,283 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-10-01 11:38:38,284 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-ORD-4B86357A with amount: 165500, email: ziga4455@lola.com
2025-10-01 11:38:39,124 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/u31l41dnrh60xdp
2025-10-01 11:38:39,125 - handlers.payment_handler - INFO - Starting payment monitoring for order 220, reference PAY-ORD-4B86357A
2025-10-01 11:38:39,126 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-4B86357A
2025-10-01 11:38:39,672 - services.payment_service - WARNING - Payment not successful for reference PAY-ORD-4B86357A. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5389539693, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-ORD-4B86357A', 'receipt_number': None, 'amount': 165500, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-10-01T10:38:38.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.67.12.153, 141.101.99.135, 172.31.68.120', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': 'ORD-4B86357A', 'db_order_id': '220', 'delivery_address': 'Howson Wright', 'charges': '105', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 2483, 'integration': '1655', 'subaccount': 161362, 'params': {'bearer': 'subaccount', 'transaction_charge': '1655', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-10-01T10:38:38.000Z', 'requested_amount': 165500, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-10-01T10:38:38.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-10-01 11:38:39,673 - handlers.payment_handler - INFO - Payment not yet verified for order 220, attempt 1/15
2025-10-01 11:38:39,675 - handlers.payment_handler - INFO - Payment link created successfully for order 220 with subaccount ACCT_u9knhyzn5eq4iop
2025-10-01 11:38:41,661 - utils.data_manager - INFO - Retrieved 2 items for order 220
2025-10-01 11:38:41,854 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 11:38:43,033 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZEREJCRkIyNDBCOEFBNjJCMAA="}]}
2025-10-01 11:38:44,201 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:44] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:44,590 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:38:45,024 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:45] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:45,150 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:45] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:46,000 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:38:44.826032+00:00, interaction_count=461, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=cart_added, final_order_value=1655.0, converted_at=2025-10-01 10:38:32.880939+00:00
2025-10-01 11:38:46,567 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-10-01 11:38:46,650 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:38:46,661 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-01 11:38:46,661 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZEREJCRkIyNDBCOEFBNjJCMAA='}]}
2025-10-01 11:38:46,663 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:46] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:48,701 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:38:50,254 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:38:48.900393+00:00, interaction_count=462, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=cart_added, final_order_value=1655.0, converted_at=2025-10-01 10:38:32.880939+00:00
2025-10-01 11:38:50,831 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:38:50,834 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:38:50,835 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:38:51,497 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-ORD-4B86357A
2025-10-01 11:38:52,630 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order ORD-4B86357A.
2025-10-01 11:38:54,451 - utils.data_manager - ERROR - Database error retrieving items for order ORD-4B86357A: invalid input syntax for type bigint: "ORD-4B86357A"
LINE 4:                         WHERE order_id = 'ORD-4B86357A'
                                                 ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 794, in get_order_items
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<4 lines>...
        (order_id,)
        ^^^^^^^^^^^
    )
    ^
psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type bigint: "ORD-4B86357A"
LINE 4:                         WHERE order_id = 'ORD-4B86357A'
                                                 ^

2025-10-01 11:38:54,505 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 11:38:55,019 - utils.data_manager - INFO - Updated order 220 to status confirmed
2025-10-01 11:38:55,621 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg2QzlFQzUzQzM4ODA2NEM4QwA="}]}
2025-10-01 11:38:56,590 - utils.data_manager - INFO - Retrieved 2 items for order 220
2025-10-01 11:38:56,693 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:56] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:57,160 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:38:57,494 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:57] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:38:58,530 - utils.data_manager - INFO - Reduced inventory for product_id 1 by 1 for order 220
2025-10-01 11:38:58,530 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:38:57.340934+00:00, interaction_count=463, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=cart_added, final_order_value=1655.0, converted_at=2025-10-01 10:38:32.880939+00:00
2025-10-01 11:38:58,942 - utils.data_manager - INFO - Reduced inventory for product_id 2 by 1 for order 220
2025-10-01 11:38:59,201 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:38:59,201 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 11:38:59,221 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-01 11:38:59,221 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg2QzlFQzUzQzM4ODA2NEM4QwA='}]}
2025-10-01 11:38:59,223 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:38:59] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:39:00,785 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 11:39:00,981 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 220
2025-10-01 11:39:04,590 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-10-01 11:39:04,591 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-10-01 11:39:06,433 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 11:39:07,764 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNBRTYyNTg2NzE4MzE5NDNDRAA="}]}
2025-10-01 11:39:07,767 - handlers.payment_handler - INFO - Sent payment success text message for order 220 to customer 2348055614455
2025-10-01 11:39:07,817 - handlers.payment_handler - ERROR - Error sending payment success messages for order 220: cannot access local variable 'state' where it is not associated with a value
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\payment_handler.py", line 369, in _send_payment_success_message
    self._initiate_feedback_collection(state, session_id, order_id)
                                       ^^^^^
UnboundLocalError: cannot access local variable 'state' where it is not associated with a value
2025-10-01 11:39:07,819 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-10-01 11:39:08,933 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:39:08] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:39:09,130 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjcxNUI4MTM5QTlFMTNFQTJDRQA="}]}
2025-10-01 11:39:09,132 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 220 to 2347082345056
2025-10-01 11:39:09,133 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 11:39:09,354 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:39:09] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:39:10,131 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQzOTNCMzBCOTg5QzE4NjIyRgA="}]}
2025-10-01 11:39:10,133 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 220 to 2348055614455
2025-10-01 11:39:10,135 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:39:10] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-10-01 11:39:10,605 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:39:10] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:39:11,324 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:39:11] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:39:11,364 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:39:11] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:39:11,415 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:39:11] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:39:11,785 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:39:11] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:39:12,238 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:39:12] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:39:39,675 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-4B86357A
2025-10-01 11:39:40,229 - services.payment_service - INFO - Payment verified successfully for reference PAY-ORD-4B86357A. Status: success
2025-10-01 11:39:40,231 - handlers.payment_handler - INFO - Payment verified for order 220 on attempt 2
2025-10-01 11:39:40,232 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-4B86357A
2025-10-01 11:39:40,753 - services.payment_service - INFO - Payment verified successfully for reference PAY-ORD-4B86357A. Status: success
2025-10-01 11:39:44,890 - utils.data_manager - INFO - Updated order 220 to status confirmed
2025-10-01 11:39:46,430 - utils.data_manager - INFO - Retrieved 2 items for order 220
2025-10-01 11:39:48,610 - utils.data_manager - INFO - Reduced inventory for product_id 1 by 1 for order 220
2025-10-01 11:39:48,990 - utils.data_manager - INFO - Reduced inventory for product_id 2 by 1 for order 220
2025-10-01 11:39:49,235 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 11:39:50,887 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 11:39:51,082 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 220
2025-10-01 11:39:56,311 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:39:57,780 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:39:56.514485+00:00, interaction_count=464, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 11:39:58,460 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:39:58,467 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID 220
2025-10-01 11:41:19,880 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 11:41:24,161 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 11:44:06,178 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 11:44:06,179 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 11:50:44,633 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 11:50:48,016 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 11:50:50,798 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 11:50:51,379 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 11:50:51,878 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:52,069 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:52,282 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:52,502 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:52,837 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:53,028 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:53,223 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:53,569 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:53,768 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:53,986 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:54,281 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:54,967 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:55,181 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:55,385 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:50:57,739 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 11:50:57,930 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 11:50:57,931 - services.payment_service - INFO - PaymentService initialized
2025-10-01 11:50:57,931 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 11:50:57,933 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 11:50:57,934 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 11:50:57,935 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 11:50:57,935 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 11:50:57,936 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 11:50:57,937 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 11:50:57,938 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 11:50:57,939 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 11:51:01,024 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 11:51:01,281 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 11:51:01,284 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 11:51:01,478 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:01,721 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:01,980 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:02,210 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:02,408 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:02,607 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:02,929 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:03,194 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:06,763 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:09,748 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:11,676 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:12,662 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:17,586 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:18,085 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:51:23,489 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 11:51:23,784 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 11:51:23,785 - services.payment_service - INFO - PaymentService initialized
2025-10-01 11:51:23,785 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 11:51:23,786 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 11:51:23,787 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 11:51:23,787 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 11:51:23,789 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 11:51:23,789 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 11:51:23,790 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 11:51:23,791 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 11:51:23,792 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 11:51:23,792 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 11:51:24,964 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 11:51:24,965 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 11:51:24,966 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 11:51:24,967 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 11:51:24,968 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 11:51:24,969 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 11:51:24,969 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 11:51:25,026 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 11:51:25,028 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 11:52:30,541 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-01 11:52:30,541 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-01 11:52:32,428 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:52:34,488 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:52:32.624420+00:00, interaction_count=465, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 11:52:35,299 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:52:35,301 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-01 11:52:35,301 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:52:37,308 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-01 11:52:37,525 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 11:52:37,526 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 11:52:37,527 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 11:52:37,527 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 11:52:38,900 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUzRUI1ODU2ODVCOEU1NjAxMgA="}]}
2025-10-01 11:52:38,950 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 11:52:40,207 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM2MkUyNjVCNTIwNTJBRDZCOAA="}]}
2025-10-01 11:52:40,209 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM2MkUyNjVCNTIwNTJBRDZCOAA='}]}
2025-10-01 11:52:40,213 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:52:40] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:52:41,152 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:52:41] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:52:41,600 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:52:41] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:52:41,605 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:52:41] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:52:41,611 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:52:41] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:52:42,069 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:52:42] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:52:42,436 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:52:42] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:18,272 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-10-01 11:54:20,845 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:54:22,274 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:54:21.039873+00:00, interaction_count=466, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 11:54:22,948 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:54:22,950 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:54:22,950 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:54:22,950 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-10-01 11:54:22,951 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-10-01 11:54:22,951 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-10-01 11:54:22,952 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-10-01 11:54:22,952 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 11:54:22,953 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-10-01 11:54:24,840 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNBQkIyMzZGRTI5MDk0MjNEQQA="}]}
2025-10-01 11:54:24,841 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 11:54:24,843 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-10-01 11:54:25,820 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwM0FFRkEzOTQ1MzM4MTUyNwA="}]}
2025-10-01 11:54:25,821 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwM0FFRkEzOTQ1MzM4MTUyNwA='}]}
2025-10-01 11:54:25,823 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:25] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:26,941 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:26] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:27,252 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:27] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:27,256 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:27] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:27,312 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:27] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:28,131 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:28] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:28,135 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:28] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:47,162 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '3 Jellof rice and fried rice'}
2025-10-01 11:54:48,884 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:54:51,007 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:54:49.068357+00:00, interaction_count=467, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 11:54:51,648 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:54:51,651 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:54:51,651 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:54:51,652 - handlers.base_handler - INFO - AIHandler: Handling message '3 jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: '3 Jellof rice and fried rice'
2025-10-01 11:54:55,757 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-10-01 11:54:55,787 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 11:54:57,025 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE4QjA0NjVDQ0M4M0Y2MzdENwA="}]}
2025-10-01 11:54:57,032 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE4QjA0NjVDQ0M4M0Y2MzdENwA='}]}
2025-10-01 11:54:57,042 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:57] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:58,187 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:58] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:58,963 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:58] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:54:59,304 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:54:59] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:55:46,313 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'modify_ai_order'}
2025-10-01 11:55:47,958 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:55:49,299 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:55:48.149248+00:00, interaction_count=468, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 11:55:49,947 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:55:49,948 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:55:49,949 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:55:49,950 - handlers.base_handler - INFO - User chose to modify AI order for session 2348055614455.
2025-10-01 11:55:49,950 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 11:55:51,119 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ1ODkzQTE3OURBQzA4NUI2RAA="}]}
2025-10-01 11:55:51,120 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ1ODkzQTE3OURBQzA4NUI2RAA='}]}
2025-10-01 11:55:51,121 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:55:51] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:55:52,441 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:55:52] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:55:52,874 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:55:52] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:55:53,470 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:55:53] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:56:01,480 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 11:56:04,051 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 11:56:10,614 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Remove frice rice and add 1 chicken'}
2025-10-01 11:56:12,209 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 11:56:13,557 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 10:56:12.400371+00:00, interaction_count=469, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 11:56:14,125 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 11:56:14,127 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 11:56:14,127 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 11:56:14,128 - handlers.message_processor - WARNING - Session 2348055614455: Unhandled AI state 'ai_order_modification'. Continuing with AI bulk order.
2025-10-01 11:56:14,129 - handlers.base_handler - INFO - AIHandler: Handling message 'continue_ordering' in AI bulk order state for session 2348055614455. Original: 'Remove frice rice and add 1 chicken'
2025-10-01 11:56:17,728 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-10-01 11:56:17,742 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 11:56:18,942 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcxOERCOUQ4RUI0MDU0MDk1OAA="}]}
2025-10-01 11:56:18,970 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcxOERCOUQ4RUI0MDU0MDk1OAA='}]}
2025-10-01 11:56:18,972 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:56:18] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:56:20,200 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:56:20] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:56:20,480 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:56:20] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:56:20,801 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 11:56:20] "POST /webhook HTTP/1.1" 200 -
2025-10-01 11:56:52,306 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 11:56:52,307 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 11:56:55,156 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 11:56:58,154 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 11:57:00,001 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 11:57:00,199 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 11:57:00,413 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:00,607 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:00,821 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:01,019 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:01,333 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:01,537 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:01,743 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:01,937 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:02,122 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:02,317 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:02,507 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:02,697 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:02,970 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:03,169 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 11:57:05,126 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 11:57:05,319 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 11:57:05,320 - services.payment_service - INFO - PaymentService initialized
2025-10-01 11:57:05,320 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 11:57:05,323 - app - ERROR - Error initializing a handler: name 'AIService' is not defined
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\app.py", line 60, in <module>
    greeting_handler = GreetingHandler(config, session_manager, data_manager, whatsapp_service)
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 19, in __init__
    self.ai_service = AIService(config, data_manager)  # Initialize AIService for name parsing
                      ^^^^^^^^^
NameError: name 'AIService' is not defined
2025-10-01 11:57:05,323 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 11:57:05,334 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 11:57:07,265 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 11:57:07,464 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:01:30,497 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:01:32,817 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:01:34,707 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:01:34,907 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:01:35,107 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:35,296 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:35,497 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:35,786 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:35,989 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:36,186 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:36,397 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:36,597 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:36,807 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:37,007 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:37,198 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:37,397 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:37,597 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:37,796 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:39,537 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:01:39,725 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:01:39,725 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:01:39,726 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:01:39,727 - app - ERROR - Error initializing a handler: name 'AIService' is not defined
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\app.py", line 60, in <module>
    greeting_handler = GreetingHandler(config, session_manager, data_manager, whatsapp_service)
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 19, in __init__
    self.ai_service = AIService(config, data_manager)  # Initialize AIService for name parsing
                      ^^^^^^^^^
NameError: name 'AIService' is not defined
2025-10-01 12:01:39,727 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:01:39,732 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 12:01:41,279 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:01:41,466 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:01:46,766 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:01:48,025 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:01:49,612 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:01:49,807 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:01:50,007 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:50,206 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:50,435 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:50,627 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:50,833 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:51,044 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:51,227 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:51,418 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:51,608 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:51,800 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:52,013 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:52,207 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:52,407 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:52,597 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:01:54,378 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:01:54,592 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:01:54,593 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:01:54,593 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:01:54,594 - app - ERROR - Error initializing a handler: name 'AIService' is not defined
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\app.py", line 60, in <module>
    greeting_handler = GreetingHandler(config, session_manager, data_manager, whatsapp_service)
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 19, in __init__
    self.ai_service = AIService(config, data_manager)  # Initialize AIService for name parsing
                      ^^^^^^^^^
NameError: name 'AIService' is not defined
2025-10-01 12:01:54,594 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:01:54,598 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 12:01:56,229 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:01:56,426 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:03:19,937 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:03:21,150 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:03:22,687 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:03:22,876 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:03:23,076 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:23,277 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:23,476 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:23,676 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:23,876 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:24,073 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:24,266 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:24,456 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:24,646 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:24,837 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:25,027 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:25,226 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:25,426 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:25,626 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:27,356 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:03:27,548 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:03:27,548 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:03:27,549 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:03:27,550 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:03:27,986 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:03:27,987 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:03:27,987 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 12:03:27,988 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:03:27,989 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:03:27,989 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:03:27,990 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:03:27,990 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:03:29,079 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:03:29,547 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:03:29,747 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:03:29,947 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:30,148 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:30,346 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:30,564 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:30,756 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:30,956 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:31,156 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:31,356 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:31,547 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:31,738 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:31,939 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:32,147 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:32,356 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:32,553 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:03:34,317 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:03:34,507 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:03:34,508 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:03:34,508 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 12:03:34,508 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 12:03:34,852 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:03:34,852 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:03:34,852 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:03:34,865 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:03:34,865 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 12:03:34,866 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:03:34,866 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:03:34,867 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:03:34,867 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:03:35,207 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:03:35,207 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 12:03:35,207 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 12:03:35,208 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 12:03:35,209 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:03:35,209 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:03:35,209 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:03:35,230 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 12:03:35,231 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 12:03:38,088 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-01 12:03:38,088 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-01 12:03:39,647 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:03:41,534 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:03:39.829746+00:00, interaction_count=470, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:03:42,106 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:03:42,107 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-01 12:03:42,108 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:03:43,679 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-01 12:03:43,860 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 12:03:43,861 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 12:03:43,861 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 12:03:43,861 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 12:03:45,917 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY4Nzc0MTk5MEZFRDRDREE2RgA="}]}
2025-10-01 12:03:45,944 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:03:47,150 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYyRTk5QjhBNDNCM0ZGMkJDNAA="}]}
2025-10-01 12:03:47,150 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYyRTk5QjhBNDNCM0ZGMkJDNAA='}]}
2025-10-01 12:03:47,151 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:47] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:47,618 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:47] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:48,309 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:48] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:48,419 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:48] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:48,421 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:48] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:48,857 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:48] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:49,188 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:49] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:50,857 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-10-01 12:03:52,396 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:03:53,736 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:03:52.600206+00:00, interaction_count=471, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:03:54,316 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:03:54,317 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:03:54,317 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:03:54,318 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-10-01 12:03:54,318 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-10-01 12:03:54,318 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-10-01 12:03:54,319 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-10-01 12:03:54,319 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 12:03:54,319 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-10-01 12:03:55,447 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5OTM1RkI5QjgwMkVGMjI5MwA="}]}
2025-10-01 12:03:55,448 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 12:03:55,449 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-10-01 12:03:56,426 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMxQkE3Q0NGMkVGRTQzNDE4RAA="}]}
2025-10-01 12:03:56,427 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMxQkE3Q0NGMkVGRTQzNDE4RAA='}]}
2025-10-01 12:03:56,428 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:56] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:56,972 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-01 12:03:57,283 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:57] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:57,757 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:57] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:57,890 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:57] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:58,393 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:58] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:58,531 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:58] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:58,656 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:03:58] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:03:58,818 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:04:00,696 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:03:59.017389+00:00, interaction_count=472, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:04:01,269 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:04:01,270 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:04:01,270 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:04:01,270 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 12:04:01,270 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 12:04:01,271 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 12:04:01,271 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 12:04:02,557 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMwMDhCMjRGODk4M0M3MDQyOQA="}]}
2025-10-01 12:04:02,558 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:04:03,689 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDQkZGRjVFNUZGQUNDNTA4RgA="}]}
2025-10-01 12:04:03,690 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDQkZGRjVFNUZGQUNDNTA4RgA='}]}
2025-10-01 12:04:03,691 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:03] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:03,847 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:03] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:04,968 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:04] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:05,307 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-10-01 12:04:05,460 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:05] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:05,578 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:05] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:05,789 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:05] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:05,848 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:05] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:06,867 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:04:08,227 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:04:07.067045+00:00, interaction_count=473, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:04:08,806 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:04:08,806 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:04:08,807 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:04:08,807 - handlers.base_handler - INFO - GreetingHandler: Handling message 'jellof rice and fried rice' in greeting state for session 2348055614455.
2025-10-01 12:04:08,807 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 12:04:08,808 - handlers.base_handler - WARNING - Session 2348055614455: Invalid option 'jellof rice and fried rice' in greeting state for non-paid user.
2025-10-01 12:04:08,808 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:04:10,667 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEwODQyQTUxOEREOTk1OEY5QQA="}]}
2025-10-01 12:04:10,668 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEwODQyQTUxOEREOTk1OEY5QQA='}]}
2025-10-01 12:04:10,668 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:10] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:11,907 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:11] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:12,638 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:12] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:12,978 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:12] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:14,487 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-10-01 12:04:16,017 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:04:17,376 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:04:16.216972+00:00, interaction_count=474, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:04:17,986 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:04:17,987 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:04:17,987 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:04:17,987 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-10-01 12:04:17,988 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-10-01 12:04:17,988 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-10-01 12:04:17,988 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-10-01 12:04:17,989 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 12:04:17,989 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-10-01 12:04:18,957 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCNjdGRTJCRDk2MDAzRkI1OQA="}]}
2025-10-01 12:04:18,957 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 12:04:18,958 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-10-01 12:04:20,069 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVCOEE4Q0E3NTA4MUNFMTA2OAA="}]}
2025-10-01 12:04:20,070 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVCOEE4Q0E3NTA4MUNFMTA2OAA='}]}
2025-10-01 12:04:20,070 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:20] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:20,077 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:20] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:21,041 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:21,163 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:21,409 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:21,868 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:21,983 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:29,744 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-10-01 12:04:31,297 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:04:32,657 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:04:31.490660+00:00, interaction_count=475, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:04:33,237 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:04:33,238 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:04:33,238 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:04:33,238 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-10-01 12:04:36,646 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-10-01 12:04:36,658 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:04:37,677 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJEQUYyMzc4ODNGMTVGQkM2RgA="}]}
2025-10-01 12:04:37,677 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJEQUYyMzc4ODNGMTVGQkM2RgA='}]}
2025-10-01 12:04:37,678 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:37] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:38,693 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:38] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:39,319 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:39] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:39,789 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:39] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:41,638 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'modify_ai_order'}
2025-10-01 12:04:43,176 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:04:44,546 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:04:43.384065+00:00, interaction_count=476, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:04:45,176 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:04:45,176 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:04:45,177 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:04:45,177 - handlers.base_handler - INFO - User chose to modify AI order for session 2348055614455.
2025-10-01 12:04:45,177 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 12:04:48,057 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIzRDkxODVFQkM3MjQ3QkNENwA="}]}
2025-10-01 12:04:48,057 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIzRDkxODVFQkM3MjQ3QkNENwA='}]}
2025-10-01 12:04:48,058 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:49,194 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:49] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:49,579 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:49] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:49,919 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:04:49] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:04:56,562 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Remove jellof rice and add 2 egg'}
2025-10-01 12:04:58,110 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:04:59,447 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:04:58.298381+00:00, interaction_count=477, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:05:00,016 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:05:00,017 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:05:00,017 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:05:00,017 - handlers.message_processor - WARNING - Session 2348055614455: Unhandled AI state 'ai_order_modification'. Continuing with AI bulk order.
2025-10-01 12:05:00,018 - handlers.base_handler - INFO - AIHandler: Handling message 'continue_ordering' in AI bulk order state for session 2348055614455. Original: 'Remove jellof rice and add 2 egg'
2025-10-01 12:05:03,177 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-10-01 12:05:03,184 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:05:04,256 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgyMjQ3RjZGNDlDNzhDQ0U0RQA="}]}
2025-10-01 12:05:04,257 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgyMjQ3RjZGNDlDNzhDQ0U0RQA='}]}
2025-10-01 12:05:04,258 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:04] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:05,573 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:05] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:06,149 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:06] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:06,278 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:06] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:14,503 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'modify_ai_order'}
2025-10-01 12:05:16,049 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:05:17,426 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:05:16.247260+00:00, interaction_count=478, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:05:18,008 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:05:18,009 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:05:18,009 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:05:18,010 - handlers.base_handler - INFO - User chose to modify AI order for session 2348055614455.
2025-10-01 12:05:18,010 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-01 12:05:18,998 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJCOEQ1MzcxNzMxRTRCRTAwMQA="}]}
2025-10-01 12:05:18,999 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJCOEQ1MzcxNzMxRTRCRTAwMQA='}]}
2025-10-01 12:05:19,000 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:18] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:20,183 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:20] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:20,557 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:20] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:21,256 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:21] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:33,842 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'remove jollof rice and add 1 chicken'}
2025-10-01 12:05:35,502 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:05:36,926 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:05:35.696351+00:00, interaction_count=479, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:05:37,546 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:05:37,547 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:05:37,548 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:05:37,548 - handlers.message_processor - WARNING - Session 2348055614455: Unhandled AI state 'ai_order_modification'. Continuing with AI bulk order.
2025-10-01 12:05:37,548 - handlers.base_handler - INFO - AIHandler: Handling message 'continue_ordering' in AI bulk order state for session 2348055614455. Original: 'remove jollof rice and add 1 chicken'
2025-10-01 12:05:41,138 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-10-01 12:05:41,145 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:05:42,229 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCRTUxNEYyM0FGNDEwMUMwMQA="}]}
2025-10-01 12:05:42,230 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCRTUxNEYyM0FGNDEwMUMwMQA='}]}
2025-10-01 12:05:42,230 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:42] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:43,432 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:43] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:44,116 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:44] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:05:44,150 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:05:44] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:06:34,466 - handlers.webhook_handler - INFO - Processing message from 2348140889363 (User: Joshua): {'type': 'text', 'text': 'Holla'}
2025-10-01 12:06:34,466 - utils.session_manager - INFO - New session 2348140889363 initialized.
2025-10-01 12:06:36,237 - utils.data_manager - INFO - Retrieved lead 2348140889363 for merchant 20 from whatsapp_leads
2025-10-01 12:06:37,587 - utils.data_manager - DEBUG - Saving or updating lead 2348140889363: merchant_details_id=20, user_id=2348140889363, user_name=Joshua, phone_number=2348140889363, source=whatsapp, first_contact=2025-08-31 20:10:00.205829+00:00, last_interaction=2025-10-01 11:06:36.436744+00:00, interaction_count=2, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-10-01 12:06:38,167 - utils.data_manager - INFO - Lead 2348140889363 saved or updated in whatsapp_leads table
2025-10-01 12:06:38,168 - services.lead_tracker - INFO - Updated lead interaction: 2348140889363 (Joshua)
2025-10-01 12:06:38,169 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348140889363
2025-10-01 12:06:39,728 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348140889363. Trying whatsapp_user_details.
2025-10-01 12:06:39,926 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348140889363
2025-10-01 12:06:40,116 - utils.data_manager - DEBUG - No user data found for 2348140889363
2025-10-01 12:06:40,117 - handlers.base_handler - INFO - Session 2348140889363: New user or missing details. Initiating onboarding.
2025-10-01 12:06:40,117 - services.whatsapp_service - DEBUG - Created image message payload for 2348140889363
2025-10-01 12:06:40,117 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348140889363: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348140889363', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/lola-1.jpg', 'caption': 'Hi Guest! Welcome to Lola - your personal shopping assistant for discovering and ordering from your favorite stores. What name would you like me to call you?'}}
2025-10-01 12:06:40,870 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-01 12:06:40,871 - services.whatsapp_service - ERROR - Failed to send image to 2348140889363. Aborting button message.
2025-10-01 12:06:40,872 - handlers.message_processor - WARNING - Session 2348140889363: No handler response for handler 'greeting_handler', state 'start', message 'holla'. Resetting to greeting.
2025-10-01 12:06:40,872 - utils.data_manager - DEBUG - No user data found for 2348140889363
2025-10-01 12:06:40,872 - handlers.base_handler - INFO - Session 2348140889363: New user or missing details. Initiating onboarding.
2025-10-01 12:06:40,873 - services.whatsapp_service - DEBUG - Created image message payload for 2348140889363
2025-10-01 12:06:40,873 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348140889363: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348140889363', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/lola-1.jpg', 'caption': 'Hi Guest! Welcome to Lola - your personal shopping assistant for discovering and ordering from your favorite stores. What name would you like me to call you?'}}
2025-10-01 12:06:41,528 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-01 12:06:41,528 - services.whatsapp_service - ERROR - Failed to send image to 2348140889363. Aborting button message.
2025-10-01 12:06:41,529 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:06:41] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:06:47,155 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 12:06:47,156 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:07:18,175 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:07:19,706 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:07:21,395 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:07:21,605 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:07:21,840 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:22,056 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:22,276 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:22,516 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:22,736 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:22,957 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:23,176 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:23,396 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:23,619 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:23,836 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:24,055 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:24,276 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:24,486 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:24,697 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:26,439 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:07:26,636 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:07:26,637 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:07:26,637 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:07:26,639 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:07:27,339 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:07:27,340 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:07:27,340 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 12:07:27,340 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:07:27,341 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:07:27,341 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:07:27,342 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:07:27,342 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:07:28,158 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:07:28,855 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:07:29,046 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:07:29,235 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:29,425 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:29,628 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:29,825 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:30,016 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:30,295 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:30,488 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:30,685 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:30,876 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:31,066 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:31,266 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:31,467 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:31,665 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:31,865 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:07:33,576 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:07:33,766 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:07:33,767 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:07:33,767 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 12:07:33,767 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 12:07:34,103 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:07:34,103 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:07:34,103 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:07:34,115 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:07:34,115 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 12:07:34,116 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:07:34,116 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:07:34,116 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:07:34,117 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:07:34,462 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:07:34,462 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 12:07:34,462 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 12:07:34,462 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 12:07:34,463 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:07:34,463 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:07:34,464 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:07:34,493 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 12:07:34,493 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 12:08:08,155 - handlers.webhook_handler - INFO - Processing message from 2348140889363 (User: Joshua): {'type': 'text', 'text': 'Holla'}
2025-10-01 12:08:08,155 - utils.session_manager - INFO - New session 2348140889363 initialized.
2025-10-01 12:08:09,675 - utils.data_manager - INFO - Retrieved lead 2348140889363 for merchant 20 from whatsapp_leads
2025-10-01 12:08:11,005 - utils.data_manager - DEBUG - Saving or updating lead 2348140889363: merchant_details_id=20, user_id=2348140889363, user_name=Joshua, phone_number=2348140889363, source=whatsapp, first_contact=2025-08-31 20:10:00.205829+00:00, last_interaction=2025-10-01 11:08:09.856410+00:00, interaction_count=3, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-10-01 12:08:11,585 - utils.data_manager - INFO - Lead 2348140889363 saved or updated in whatsapp_leads table
2025-10-01 12:08:11,586 - services.lead_tracker - INFO - Updated lead interaction: 2348140889363 (Joshua)
2025-10-01 12:08:11,586 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348140889363
2025-10-01 12:08:13,086 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348140889363. Trying whatsapp_user_details.
2025-10-01 12:08:13,266 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348140889363
2025-10-01 12:08:13,455 - utils.data_manager - DEBUG - No user data found for 2348140889363
2025-10-01 12:08:13,456 - handlers.base_handler - INFO - Session 2348140889363: New user or missing details. Initiating onboarding.
2025-10-01 12:08:13,456 - services.whatsapp_service - DEBUG - Created image message payload for 2348140889363
2025-10-01 12:08:13,457 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348140889363: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348140889363', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/lola-1.jpg', 'caption': 'Hi Guest! Welcome to Lola - your personal shopping assistant for discovering and ordering from your favorite stores. What name would you like me to call you?'}}
2025-10-01 12:08:14,147 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-01 12:08:14,148 - services.whatsapp_service - ERROR - Failed to send image to 2348140889363. Aborting button message.
2025-10-01 12:08:14,149 - handlers.message_processor - WARNING - Session 2348140889363: No handler response for handler 'greeting_handler', state 'start', message 'holla'. Resetting to greeting.
2025-10-01 12:08:14,149 - utils.data_manager - DEBUG - No user data found for 2348140889363
2025-10-01 12:08:14,149 - handlers.base_handler - INFO - Session 2348140889363: New user or missing details. Initiating onboarding.
2025-10-01 12:08:14,150 - services.whatsapp_service - DEBUG - Created image message payload for 2348140889363
2025-10-01 12:08:14,150 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348140889363: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348140889363', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/lola-1.jpg', 'caption': 'Hi Guest! Welcome to Lola - your personal shopping assistant for discovering and ordering from your favorite stores. What name would you like me to call you?'}}
2025-10-01 12:08:14,834 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-01 12:08:14,835 - services.whatsapp_service - ERROR - Failed to send image to 2348140889363. Aborting button message.
2025-10-01 12:08:14,836 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:08:14] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:09:23,222 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 12:09:23,233 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:09:25,306 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:09:26,685 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:09:28,356 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:09:28,552 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:09:28,805 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:28,995 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:29,199 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:29,387 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:29,600 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:29,815 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:30,005 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:30,195 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:30,396 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:30,584 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:30,781 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:30,975 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:31,184 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:31,375 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:33,252 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:09:33,904 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:09:33,908 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:09:33,909 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:09:33,920 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:09:35,371 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:09:35,372 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:09:35,373 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 12:09:35,373 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:09:35,374 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:09:35,375 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:09:35,375 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:09:35,376 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:09:35,513 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:09:36,915 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:09:37,105 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:09:37,297 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:37,495 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:37,685 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:37,877 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:38,076 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:38,278 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:38,479 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:38,705 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:38,895 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:39,083 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:39,275 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:39,475 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:39,665 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:39,865 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:09:41,577 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:09:41,766 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:09:41,767 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:09:41,768 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 12:09:41,768 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 12:09:42,965 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:09:42,965 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:09:42,966 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:09:42,968 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:09:42,969 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 12:09:42,975 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:09:42,976 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:09:42,978 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:09:42,981 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:09:44,179 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:09:44,179 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 12:09:44,180 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 12:09:44,181 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 12:09:44,181 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:09:44,182 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:09:44,183 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:09:44,247 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 12:09:44,248 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 12:10:10,661 - handlers.webhook_handler - INFO - Processing message from 2348140889363 (User: Joshua): {'type': 'text', 'text': 'Holla'}
2025-10-01 12:10:10,662 - utils.session_manager - INFO - New session 2348140889363 initialized.
2025-10-01 12:10:12,407 - utils.data_manager - INFO - Retrieved lead 2348140889363 for merchant 20 from whatsapp_leads
2025-10-01 12:10:13,785 - utils.data_manager - DEBUG - Saving or updating lead 2348140889363: merchant_details_id=20, user_id=2348140889363, user_name=Joshua, phone_number=2348140889363, source=whatsapp, first_contact=2025-08-31 20:10:00.205829+00:00, last_interaction=2025-10-01 11:10:12.600404+00:00, interaction_count=4, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-10-01 12:10:15,049 - utils.data_manager - INFO - Lead 2348140889363 saved or updated in whatsapp_leads table
2025-10-01 12:10:15,051 - services.lead_tracker - INFO - Updated lead interaction: 2348140889363 (Joshua)
2025-10-01 12:10:15,052 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348140889363
2025-10-01 12:10:16,766 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348140889363. Trying whatsapp_user_details.
2025-10-01 12:10:16,967 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348140889363
2025-10-01 12:10:17,654 - utils.data_manager - DEBUG - No user data found for 2348140889363
2025-10-01 12:10:17,656 - handlers.base_handler - INFO - Session 2348140889363: New user or missing details. Initiating onboarding.
2025-10-01 12:10:17,657 - services.whatsapp_service - DEBUG - Created image message payload for 2348140889363
2025-10-01 12:10:17,659 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348140889363: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348140889363', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/lola-1.jpg', 'caption': 'Hi Guest! Welcome to Lola - your personal shopping assistant for discovering and ordering from your favorite stores. What name would you like me to call you?'}}
2025-10-01 12:10:19,184 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348140889363","wa_id":"2348140889363"}],"messages":[{"id":"wamid.HBgNMjM0ODE0MDg4OTM2MxUCABEYEkQ2QTMxRjRBMDFCODNBMzkxQgA="}]}
2025-10-01 12:10:19,187 - services.whatsapp_service - ERROR - Invalid parameters: to='2348140889363', text='Hi Guest! Welcome to Lola - your personal shopping assistant for discovering and ordering from your favorite stores. What name would you like me to call you?', buttons='[]'
2025-10-01 12:10:19,188 - services.whatsapp_service - DEBUG - Created text message payload for 2348140889363
2025-10-01 12:10:19,190 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348140889363: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348140889363', 'type': 'text', 'text': {'body': 'Hi Guest! Welcome to Lola - your personal shopping assistant for discovering and ordering from your favorite stores. What name would you like me to call you?'}}
2025-10-01 12:10:20,518 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348140889363","wa_id":"2348140889363"}],"messages":[{"id":"wamid.HBgNMjM0ODE0MDg4OTM2MxUCABEYEjQzMDU2M0MwNEYzMDg4RTI1RAA="}]}
2025-10-01 12:10:20,521 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348140889363', 'wa_id': '2348140889363'}], 'messages': [{'id': 'wamid.HBgNMjM0ODE0MDg4OTM2MxUCABEYEjQzMDU2M0MwNEYzMDg4RTI1RAA='}]}
2025-10-01 12:10:20,524 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:10:20] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:10:21,989 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:10:21] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:10:22,583 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:10:22] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:10:23,079 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:10:23] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:10:23,380 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:10:23] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:10:24,615 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:10:24] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:10:24,740 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:10:24] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:14:35,706 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:14:38,867 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 12:14:39,550 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:14:40,112 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:17:21,770 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:17:24,790 - __main__ - ERROR - Unexpected error: name 'BaseHandler' is not defined
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\run.py", line 151, in main
    from app import app
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\app.py", line 8, in <module>
    from handlers.webhook_handler import WebhookHandler
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\webhook_handler.py", line 10, in <module>
    from handlers.message_processor import MessageProcessor
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 4, in <module>
    from handlers.greeting_handler import GreetingHandler
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 14, in <module>
    class GreetingHandler(BaseHandler):
                          ^^^^^^^^^^^
NameError: name 'BaseHandler' is not defined
2025-10-01 12:17:52,753 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:17:54,802 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:17:56,548 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:17:56,744 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:17:56,934 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:57,134 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:57,324 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:57,524 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:57,715 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:57,904 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:58,095 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:58,284 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:58,474 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:58,664 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:58,857 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:59,055 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:59,254 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:17:59,445 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:01,278 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:18:01,481 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:18:01,482 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:18:01,483 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:18:01,485 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:18:02,212 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:18:02,212 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:18:02,213 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 12:18:02,213 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:18:02,214 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:18:02,215 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:18:02,216 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:18:02,217 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:18:03,185 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:18:03,831 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:18:04,025 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:18:04,248 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:04,445 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:04,644 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:04,834 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:05,060 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:05,264 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:05,479 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:05,676 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:05,880 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:06,084 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:06,288 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:06,484 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:06,708 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:06,981 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:18:08,866 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:18:09,066 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:18:09,067 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:18:09,068 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 12:18:09,068 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 12:18:09,658 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:18:09,659 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:18:09,659 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:18:09,661 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:18:09,662 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 12:18:09,663 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:18:09,663 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:18:09,664 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:18:09,665 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:18:10,271 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:18:10,272 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 12:18:10,272 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 12:18:10,273 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 12:18:10,274 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:18:10,275 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:18:10,276 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:18:10,310 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 12:18:10,311 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 12:18:13,940 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-01 12:18:13,941 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-01 12:18:15,744 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:18:17,320 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:18:16.031781+00:00, interaction_count=480, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:18:17,925 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:18:17,926 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-01 12:18:17,926 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:18:19,584 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-01 12:18:19,795 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 12:18:19,796 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 12:18:19,797 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 12:18:19,798 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 12:18:21,136 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYwMzlFOTlGRkE0OTRFMDY3QQA="}]}
2025-10-01 12:18:21,186 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:18:22,273 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc0M0QxNjUyODYxRkVGQjBBNQA="}]}
2025-10-01 12:18:22,274 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc0M0QxNjUyODYxRkVGQjBBNQA='}]}
2025-10-01 12:18:22,277 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:22] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:23,002 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:23] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:23,520 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:23] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:23,780 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:23] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:23,783 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:23] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:24,371 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:24] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:24,673 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:24] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:35,666 - handlers.webhook_handler - INFO - Processing message from 2348140889363 (User: Joshua): {'type': 'text', 'text': 'Hello'}
2025-10-01 12:18:35,666 - utils.session_manager - INFO - New session 2348140889363 initialized.
2025-10-01 12:18:37,213 - utils.data_manager - INFO - Retrieved lead 2348140889363 for merchant 20 from whatsapp_leads
2025-10-01 12:18:38,679 - utils.data_manager - DEBUG - Saving or updating lead 2348140889363: merchant_details_id=20, user_id=2348140889363, user_name=Joshua, phone_number=2348140889363, source=whatsapp, first_contact=2025-08-31 20:10:00.205829+00:00, last_interaction=2025-10-01 11:18:37.408457+00:00, interaction_count=5, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-10-01 12:18:39,250 - utils.data_manager - INFO - Lead 2348140889363 saved or updated in whatsapp_leads table
2025-10-01 12:18:39,251 - services.lead_tracker - INFO - Updated lead interaction: 2348140889363 (Joshua)
2025-10-01 12:18:39,252 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348140889363
2025-10-01 12:18:41,304 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348140889363. Trying whatsapp_user_details.
2025-10-01 12:18:41,512 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348140889363
2025-10-01 12:18:41,704 - handlers.message_processor - INFO - Session 2348140889363: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 12:18:41,705 - utils.data_manager - DEBUG - No user data found for 2348140889363
2025-10-01 12:18:41,705 - handlers.base_handler - INFO - Session 2348140889363 returned to main menu (greeting state). Address preserved: 
2025-10-01 12:18:41,706 - services.whatsapp_service - DEBUG - Created image message payload for 2348140889363
2025-10-01 12:18:43,025 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348140889363","wa_id":"2348140889363"}],"messages":[{"id":"wamid.HBgNMjM0ODE0MDg4OTM2MxUCABEYEjBFMjc0ODY2QTVDMTJFMzhFRgA="}]}
2025-10-01 12:18:43,027 - services.whatsapp_service - DEBUG - Created button message payload for 2348140889363
2025-10-01 12:18:44,580 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348140889363","wa_id":"2348140889363"}],"messages":[{"id":"wamid.HBgNMjM0ODE0MDg4OTM2MxUCABEYEjI1MDVCRkJDMzM3NUEwMjYyQwA="}]}
2025-10-01 12:18:44,582 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348140889363', 'wa_id': '2348140889363'}], 'messages': [{'id': 'wamid.HBgNMjM0ODE0MDg4OTM2MxUCABEYEjI1MDVCRkJDMzM3NUEwMjYyQwA='}]}
2025-10-01 12:18:44,583 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:44] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:45,034 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:45] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:45,663 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:45] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:45,776 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:45] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:46,201 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:46] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:47,892 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:47] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:18:48,008 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:18:48] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:23:03,456 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:23:05,209 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:26:16,976 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 12:26:16,977 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:27:20,355 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:27:23,514 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:27:25,322 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:27:25,522 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:27:25,723 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:25,913 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:26,112 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:26,300 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:26,484 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:26,713 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:26,913 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:27,102 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:27,288 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:27,485 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:27,694 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:27,893 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:28,095 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:28,294 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:30,103 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:27:30,303 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:27:30,304 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:27:30,305 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:27:30,306 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:27:31,193 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:27:31,193 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:27:31,194 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 12:27:31,194 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:27:31,195 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:27:31,195 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:27:31,196 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:27:31,197 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:27:32,039 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:27:32,802 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:27:33,008 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:27:33,203 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:33,403 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:33,617 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:33,817 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:34,013 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:34,213 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:34,412 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:34,613 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:34,833 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:35,033 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:35,330 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:35,526 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:35,722 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:35,913 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:27:37,716 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:27:37,915 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:27:37,916 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:27:37,917 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 12:27:37,917 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 12:27:38,677 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:27:38,678 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:27:38,679 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:27:38,731 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:27:38,732 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 12:27:38,734 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:27:38,736 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:27:38,737 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:27:38,739 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:27:39,553 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:27:39,554 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 12:27:39,554 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 12:27:39,555 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 12:27:39,555 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:27:39,556 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:27:39,557 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:27:39,642 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 12:27:39,643 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 12:27:49,323 - handlers.webhook_handler - INFO - Processing message from 2348140889363 (User: Joshua): {'type': 'text', 'text': 'Hello'}
2025-10-01 12:27:49,323 - utils.session_manager - INFO - New session 2348140889363 initialized.
2025-10-01 12:27:51,265 - utils.data_manager - INFO - Retrieved lead 2348140889363 for merchant 20 from whatsapp_leads
2025-10-01 12:27:52,663 - utils.data_manager - DEBUG - Saving or updating lead 2348140889363: merchant_details_id=20, user_id=2348140889363, user_name=Joshua, phone_number=2348140889363, source=whatsapp, first_contact=2025-08-31 20:10:00.205829+00:00, last_interaction=2025-10-01 11:27:51.453191+00:00, interaction_count=6, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-10-01 12:27:53,275 - utils.data_manager - INFO - Lead 2348140889363 saved or updated in whatsapp_leads table
2025-10-01 12:27:53,276 - services.lead_tracker - INFO - Updated lead interaction: 2348140889363 (Joshua)
2025-10-01 12:27:53,277 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348140889363
2025-10-01 12:27:55,892 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348140889363. Trying whatsapp_user_details.
2025-10-01 12:27:56,083 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348140889363
2025-10-01 12:27:56,283 - handlers.message_processor - INFO - Session 2348140889363: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 12:27:56,283 - utils.data_manager - DEBUG - No user data found for 2348140889363
2025-10-01 12:27:56,284 - handlers.base_handler - INFO - Session 2348140889363 returned to main menu (greeting state). Address preserved: 
2025-10-01 12:27:56,285 - services.whatsapp_service - DEBUG - Created image message payload for 2348140889363
2025-10-01 12:27:57,634 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348140889363","wa_id":"2348140889363"}],"messages":[{"id":"wamid.HBgNMjM0ODE0MDg4OTM2MxUCABEYEjg2NjM2OEI5ODExRjQ2RTAxOQA="}]}
2025-10-01 12:27:57,636 - services.whatsapp_service - DEBUG - Created button message payload for 2348140889363
2025-10-01 12:27:58,676 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348140889363","wa_id":"2348140889363"}],"messages":[{"id":"wamid.HBgNMjM0ODE0MDg4OTM2MxUCABEYEjQwRjk0NDM5QTA3OUMyRjI3MwA="}]}
2025-10-01 12:27:58,678 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348140889363', 'wa_id': '2348140889363'}], 'messages': [{'id': 'wamid.HBgNMjM0ODE0MDg4OTM2MxUCABEYEjQwRjk0NDM5QTA3OUMyRjI3MwA='}]}
2025-10-01 12:27:58,680 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:27:58] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:27:59,183 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:27:59] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:27:59,892 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:27:59] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:28:00,072 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:28:00] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:28:00,491 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:28:00] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:28:02,831 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:28:02] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:28:02,901 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:28:02] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:29:32,995 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-01 12:29:32,996 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-01 12:29:35,473 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:29:38,927 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-10-01 11:29:36.123589+00:00, interaction_count=481, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1050.0, conversion_stage=order_completed, final_order_value=1655.0, converted_at=2025-10-01 10:39:56.514485+00:00
2025-10-01 12:29:39,542 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:29:39,544 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-01 12:29:39,545 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:29:41,283 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-01 12:29:41,483 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 12:29:41,484 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 12:29:41,486 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 12:29:41,486 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 12:29:42,813 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhGMUQzMjAxNUUzMDdENkU5NQA="}]}
2025-10-01 12:29:42,815 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:29:43,865 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxOUM5MzcxM0NEMTQzRTIyRAA="}]}
2025-10-01 12:29:43,868 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxOUM5MzcxM0NEMTQzRTIyRAA='}]}
2025-10-01 12:29:43,871 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:29:43] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:29:44,944 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:29:44] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:29:45,210 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:29:45] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:29:45,345 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:29:45] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:29:45,801 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:29:45] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:29:46,279 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:29:46] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:29:46,679 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:29:46] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:29:51,740 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 12:29:51,742 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:33:39,019 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:33:43,123 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:33:44,831 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:33:45,031 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:33:45,303 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:45,502 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:45,702 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:45,903 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:46,102 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:46,301 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:46,492 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:46,685 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:46,940 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:47,146 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:47,352 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:47,562 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:47,781 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:47,982 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:49,911 - utils.data_manager - INFO - Successfully loaded 61 user details from database
2025-10-01 12:33:50,103 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:33:50,104 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:33:50,105 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:33:50,107 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:33:50,984 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:33:50,984 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:33:50,985 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 12:33:50,985 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:33:50,986 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:33:50,987 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:33:50,988 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:33:50,989 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:33:51,950 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:33:52,572 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:33:52,763 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:33:52,962 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:53,162 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:53,352 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:53,548 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:53,758 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:53,968 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:54,152 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:54,362 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:54,552 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:54,821 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:55,012 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:55,244 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:55,448 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:55,644 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:33:57,433 - utils.data_manager - INFO - Successfully loaded 61 user details from database
2025-10-01 12:33:57,625 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:33:57,626 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:33:57,626 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 12:33:57,626 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 12:33:58,213 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:33:58,213 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:33:58,214 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:33:58,264 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:33:58,265 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 12:33:58,266 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:33:58,266 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:33:58,267 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:33:58,268 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:33:58,866 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:33:58,866 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 12:33:58,867 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 12:33:58,868 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 12:33:58,868 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:33:58,869 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:33:58,870 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:33:58,955 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 12:33:58,956 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 12:34:05,406 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-01 12:34:05,407 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-01 12:34:07,332 - utils.data_manager - DEBUG - No lead found for user 2348055614455 and merchant 20 in whatsapp_leads
2025-10-01 12:34:08,842 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-01 11:34:07.628376+00:00, interaction_count=1, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-10-01 12:34:09,422 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:34:09,502 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:34:11,322 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-01 12:34:13,401 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-10-01 12:34:13,403 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 12:34:13,403 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 12:34:13,405 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 12:34:13,405 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 12:34:14,542 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNERTMzM0I1QjM4OTg3OUZFMwA="}]}
2025-10-01 12:34:14,544 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:34:15,563 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJDOUI3NEFDMjkxNTY5NUJEQwA="}]}
2025-10-01 12:34:15,565 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJDOUI3NEFDMjkxNTY5NUJEQwA='}]}
2025-10-01 12:34:15,567 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:15] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:16,076 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:16] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:16,750 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:16] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:16,851 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:16] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:17,346 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:17] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:18,255 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'hELLO'}
2025-10-01 12:34:18,282 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:18] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:18,390 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:18] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:20,223 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:34:21,753 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-01 11:34:20.442411+00:00, interaction_count=2, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-10-01 12:34:22,375 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:34:22,377 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-01 12:34:22,378 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:34:22,379 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 12:34:22,379 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 12:34:22,380 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 12:34:22,381 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 12:34:23,399 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyQzgxNjFCOTQ5MUNFQTEyMgA="}]}
2025-10-01 12:34:23,401 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:34:24,505 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE0QjhEQ0EwNjUyNUYzNkY4NQA="}]}
2025-10-01 12:34:24,507 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE0QjhEQ0EwNjUyNUYzNkY4NQA='}]}
2025-10-01 12:34:24,508 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:24] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:24,893 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:24] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:25,576 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:25] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:25,706 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:25] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:34:26,282 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:34:26] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:37:19,982 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 12:37:19,986 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:37:22,826 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:37:25,752 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:37:27,411 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:37:27,794 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:37:28,031 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:28,334 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:28,632 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:28,852 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:29,051 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:29,270 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:29,461 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:29,652 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:29,851 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:30,063 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:30,281 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:30,485 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:30,694 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:30,895 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:32,723 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:37:32,916 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:37:32,917 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:37:32,918 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:37:32,920 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:37:34,232 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:37:34,232 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:37:34,233 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 12:37:34,234 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:37:34,234 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:37:34,235 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:37:34,236 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:37:34,237 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:37:34,698 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:37:35,896 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:37:36,091 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:37:36,353 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:36,576 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:36,857 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:37,051 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:37,346 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:37,550 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:37,754 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:37,964 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:38,267 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:38,470 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:38,664 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:38,884 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:39,188 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:39,381 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:37:41,222 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:37:41,442 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:37:41,443 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:37:41,444 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 12:37:41,444 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 12:37:42,236 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:37:42,236 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:37:42,237 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:37:42,263 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:37:42,263 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 12:37:42,264 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:37:42,265 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:37:42,266 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:37:42,267 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:37:42,986 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:37:42,987 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 12:37:42,987 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 12:37:42,988 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 12:37:42,989 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:37:42,990 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:37:42,991 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:37:43,071 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 12:37:43,072 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 12:38:09,372 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-01 12:38:09,372 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-01 12:51:37,040 - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:51:39,141 - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:51:39,361 - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:51:39,560 - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:39,759 - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:39,960 - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:40,167 - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:40,399 - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:40,599 - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:40,819 - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:41,023 - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:41,231 - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:41,432 - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:41,629 - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:41,829 - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:42,030 - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:42,229 - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:44,097 - INFO - Successfully loaded 62 user details from database
2025-10-01 12:51:44,282 - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:51:44,284 - INFO - PaymentService initialized
2025-10-01 12:51:44,285 - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:51:44,288 - INFO - Initiating product sync for merchant 20...
2025-10-01 12:51:45,347 - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:51:45,348 - INFO - FeedbackHandler initialized.
2025-10-01 12:51:45,349 - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 12:51:45,350 - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:51:45,350 - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:51:45,351 - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:51:45,352 - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:51:45,353 - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:51:46,160 - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:51:46,970 - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:51:47,169 - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:51:47,379 - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:47,580 - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:47,783 - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:47,992 - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:48,306 - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:48,529 - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:48,730 - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:48,919 - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:49,112 - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:49,310 - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:49,510 - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:49,709 - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:49,909 - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:50,110 - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:51:51,989 - INFO - Successfully loaded 62 user details from database
2025-10-01 12:51:52,193 - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:51:52,195 - INFO - PaymentService initialized
2025-10-01 12:51:52,196 - INFO - LeadTracker initialized with DataManager
2025-10-01 12:51:52,197 - INFO - LeadTrackingHandler initialized.
2025-10-01 12:51:53,327 - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:51:53,327 - INFO - FeedbackHandler initialized.
2025-10-01 12:51:53,328 - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:51:53,330 - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:51:53,334 - INFO - OrderHandler initialized.
2025-10-01 12:51:53,336 - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:51:53,338 - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:51:53,341 - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:51:53,342 - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:51:54,277 - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:51:54,278 - INFO - AIHandler: AIService successfully initialized.
2025-10-01 12:51:54,278 - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 12:51:54,279 - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 12:51:54,279 - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:51:54,280 - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:51:54,281 - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:51:54,286 - WARNING - Attempted to clear non-existent session 2348055614455.
2025-10-01 12:51:54,286 - INFO - Cleared in-memory session for 2348055614455
2025-10-01 12:51:54,287 - INFO - New session 2348055614455 initialized.
2025-10-01 12:51:54,287 - INFO - New session state: user_name=None, address=None, current_state=start
2025-10-01 12:51:54,288 - INFO - Stopping product sync thread...
2025-10-01 12:51:54,289 - INFO - Product sync thread stopped.
2025-10-01 12:52:19,030 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-01 12:52:23,441 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:52:25,141 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:52:25,340 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:52:25,532 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:25,743 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:25,944 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:26,145 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:26,349 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:26,550 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:26,753 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:26,949 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:27,149 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:27,413 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:27,610 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:27,827 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:28,032 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:28,334 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:30,293 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:52:30,491 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:52:30,492 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:52:30,493 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-01 12:52:30,495 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-01 12:52:31,735 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:52:31,736 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:52:31,737 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-01 12:52:31,737 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:52:31,739 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:52:31,740 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:52:31,741 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:52:31,742 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-01 12:52:32,207 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-01 12:52:33,359 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-01 12:52:33,564 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-01 12:52:33,783 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:33,979 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:34,171 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:34,374 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:34,572 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:34,771 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:34,969 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:35,159 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:35,353 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:35,587 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:35,779 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:35,979 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:36,230 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:36,459 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-01 12:52:38,349 - utils.data_manager - INFO - Successfully loaded 62 user details from database
2025-10-01 12:52:38,607 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-01 12:52:38,610 - services.payment_service - INFO - PaymentService initialized
2025-10-01 12:52:38,612 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-01 12:52:38,614 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-01 12:52:39,652 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:52:39,653 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-01 12:52:39,654 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:52:39,655 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-01 12:52:39,656 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-01 12:52:39,657 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-01 12:52:39,659 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:52:39,660 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:52:39,661 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:52:40,789 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-01 12:52:40,790 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-01 12:52:40,790 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-01 12:52:40,792 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-01 12:52:40,793 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 
2025-10-01 12:52:40,794 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-01 12:52:40,796 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%
2025-10-01 12:52:40,882 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-01 12:52:40,883 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-01 12:52:41,422 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:52:41] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:52:41,618 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:52:41] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:52:44,467 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-01 12:52:44,469 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-01 12:52:46,042 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-01 12:52:47,504 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-01 11:52:46.242212+00:00, interaction_count=3, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-10-01 12:52:48,201 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-01 12:52:48,204 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-01 12:52:48,205 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-01 12:52:50,051 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-10-01 12:52:50,254 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_user_details
2025-10-01 12:52:50,460 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-01 12:52:50,461 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-01 12:52:50,463 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-01 12:52:50,465 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-01 12:52:51,902 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU4NkY3RjhCMzIwMEVCMUFEMwA="}]}
2025-10-01 12:52:51,954 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-01 12:52:53,031 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQzMjk2NDMyQTY0Mjg4REEyNQA="}]}
2025-10-01 12:52:53,035 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQzMjk2NDMyQTY0Mjg4REEyNQA='}]}
2025-10-01 12:52:53,038 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:52:53] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:52:53,731 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:52:53] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:52:54,411 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:52:54] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:52:54,479 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:52:54] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:52:54,493 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:52:54] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:52:54,890 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:52:54] "POST /webhook HTTP/1.1" 200 -
2025-10-01 12:52:54,991 - werkzeug - INFO - 127.0.0.1 - - [01/Oct/2025 12:52:54] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:29:20,640 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-02 12:29:26,749 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-02 12:29:43,590 - utils.data_manager - ERROR - Database error while ensuring columns: connection to server at "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" (52.167.188.143), port 5432 failed: server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 80, in _ensure_database_columns
    with psycopg2.connect(**self.db_params) as conn:
         ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\__init__.py", line 135, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: connection to server at "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" (52.167.188.143), port 5432 failed: server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.

2025-10-02 12:29:43,599 - app - ERROR - Error initializing a core service: cannot access local variable 'conn' where it is not associated with a value
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 80, in _ensure_database_columns
    with psycopg2.connect(**self.db_params) as conn:
         ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\__init__.py", line 135, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: connection to server at "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" (52.167.188.143), port 5432 failed: server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\app.py", line 42, in <module>
    data_manager = DataManager(config)
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 66, in __init__
    self._ensure_database_columns()
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 150, in _ensure_database_columns
    conn.rollback()
    ^^^^
UnboundLocalError: cannot access local variable 'conn' where it is not associated with a value
2025-10-02 12:30:12,573 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-02 12:30:17,682 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-02 12:30:19,486 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-02 12:30:19,686 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-02 12:30:19,881 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:20,082 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:20,281 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:20,477 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:20,674 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:20,878 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:21,074 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:21,271 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:21,468 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:21,666 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:21,864 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:22,062 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:22,262 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:22,462 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:24,332 - utils.data_manager - INFO - Successfully loaded 63 user details from database
2025-10-02 12:30:24,537 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-02 12:30:24,538 - services.payment_service - INFO - PaymentService initialized
2025-10-02 12:30:24,539 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-02 12:30:24,541 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-02 12:30:25,338 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-02 12:30:25,339 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-02 12:30:25,339 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-02 12:30:25,340 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-02 12:30:25,341 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 2348096500003, 2348129750653
2025-10-02 12:30:25,342 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-02 12:30:25,343 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-02 12:30:25,344 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-02 12:30:26,942 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-02 12:30:27,140 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-02 12:30:27,244 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-02 12:30:27,337 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:27,533 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:27,729 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:27,926 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:28,127 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:28,330 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:28,528 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:28,725 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:28,930 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:29,128 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:29,326 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:29,528 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:29,725 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:29,922 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:30:31,934 - utils.data_manager - INFO - Successfully loaded 63 user details from database
2025-10-02 12:30:32,219 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-02 12:30:32,221 - services.payment_service - INFO - PaymentService initialized
2025-10-02 12:30:32,221 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-02 12:30:32,222 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-02 12:30:32,974 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-02 12:30:32,974 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-02 12:30:32,975 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-02 12:30:32,978 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-02 12:30:32,978 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-02 12:30:32,979 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-02 12:30:32,979 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 2348096500003, 2348129750653
2025-10-02 12:30:32,980 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-02 12:30:32,981 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-02 12:30:34,115 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-02 12:30:34,116 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-02 12:30:34,116 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-02 12:30:34,116 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-02 12:30:34,117 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 2348096500003, 2348129750653
2025-10-02 12:30:34,119 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-02 12:30:34,121 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-02 12:30:34,159 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-02 12:30:34,160 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-02 12:31:58,902 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-02 12:31:58,903 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-02 12:32:01,527 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-02 12:32:03,136 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-02 12:32:04,767 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-02 12:32:04,959 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-02 12:32:05,204 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:05,399 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:05,591 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:05,784 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:05,975 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:06,222 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:06,425 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:06,697 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:06,890 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:07,082 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:07,275 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:07,466 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:07,660 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:07,851 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:09,615 - utils.data_manager - INFO - Successfully loaded 63 user details from database
2025-10-02 12:32:09,809 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-02 12:32:09,811 - services.payment_service - INFO - PaymentService initialized
2025-10-02 12:32:09,812 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-02 12:32:09,816 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-02 12:32:10,419 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-02 12:32:10,420 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-02 12:32:10,420 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-02 12:32:10,421 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-02 12:32:10,422 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 2348096500003, 2348129750653
2025-10-02 12:32:10,423 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-02 12:32:10,424 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-02 12:32:10,425 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-02 12:32:11,402 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-02 12:32:12,099 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-02 12:32:12,304 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-02 12:32:12,509 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:12,716 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:12,921 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:13,126 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:13,331 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:13,537 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:13,742 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:13,947 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:14,225 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:14,430 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:14,636 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:14,844 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:15,051 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:15,271 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:32:17,018 - utils.data_manager - INFO - Successfully loaded 63 user details from database
2025-10-02 12:32:17,208 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-02 12:32:17,208 - services.payment_service - INFO - PaymentService initialized
2025-10-02 12:32:17,209 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-02 12:32:17,209 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-02 12:32:17,807 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-02 12:32:17,808 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-02 12:32:17,809 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-02 12:32:17,810 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-02 12:32:17,811 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-02 12:32:17,811 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-02 12:32:17,812 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 2348096500003, 2348129750653
2025-10-02 12:32:17,813 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-02 12:32:17,814 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-02 12:32:18,398 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-02 12:32:18,398 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-02 12:32:18,399 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-02 12:32:18,400 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-02 12:32:18,401 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 2348096500003, 2348129750653
2025-10-02 12:32:18,402 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-02 12:32:18,403 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-02 12:32:18,431 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-02 12:32:18,432 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-02 12:33:27,534 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-02 12:33:27,535 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-02 12:33:29,109 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:33:30,501 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:33:29.300029+00:00, interaction_count=17, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4300.0, conversion_stage=order_completed, final_order_value=5230.0, converted_at=2025-10-02 10:21:03.193436+00:00
2025-10-02 12:33:31,075 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:33:31,077 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-02 12:33:31,078 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:33:32,718 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-02 12:33:32,914 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-02 12:33:32,915 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:33:32,917 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-02 12:33:32,918 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-02 12:33:34,542 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkzQ0UwRDQ4OTA2QUUwMzNDNAA="}]}
2025-10-02 12:33:34,543 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:33:35,240 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDMTg0RDc0ODcwN0Y4MEM2RQA="}]}
2025-10-02 12:33:35,242 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDMTg0RDc0ODcwN0Y4MEM2RQA='}]}
2025-10-02 12:33:35,245 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:35] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:35,920 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:35] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:36,317 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:36] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:36,444 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:36] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:37,082 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:37] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:37,200 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:37] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:38,185 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:38] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:38,296 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:38] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:39,469 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-10-02 12:33:41,023 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:33:42,445 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:33:41.214396+00:00, interaction_count=18, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4300.0, conversion_stage=order_completed, final_order_value=5230.0, converted_at=2025-10-02 10:21:03.193436+00:00
2025-10-02 12:33:43,118 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:33:43,119 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:33:43,120 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:33:43,120 - handlers.base_handler - INFO - Session 2348055614455: Handling message 'ai_bulk_order_direct' in greeting state with WhatsApp username 'Ziga'.
2025-10-02 12:33:43,121 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-10-02 12:33:43,121 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-10-02 12:33:43,122 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-10-02 12:33:43,122 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-02 12:33:43,123 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-10-02 12:33:44,097 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI5M0YyMUM0MjdFQ0VCMkI1RgA="}]}
2025-10-02 12:33:44,100 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:33:44,102 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-10-02 12:33:44,772 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA3NEMzMkE3RUJGNjg0M0QxRAA="}]}
2025-10-02 12:33:44,775 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA3NEMzMkE3RUJGNjg0M0QxRAA='}]}
2025-10-02 12:33:44,777 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:44] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:45,568 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:45] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:45,903 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:45] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:46,018 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:46] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:46,133 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:46] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:46,473 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:46] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:46,500 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:33:46] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:33:56,104 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '3 portions of jellof rice and fried rice'}
2025-10-02 12:33:57,748 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:33:59,184 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:33:57.952309+00:00, interaction_count=19, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4300.0, conversion_stage=order_completed, final_order_value=5230.0, converted_at=2025-10-02 10:21:03.193436+00:00
2025-10-02 12:33:59,782 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:33:59,785 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:33:59,787 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:33:59,789 - handlers.base_handler - INFO - AIHandler: Handling message '3 portions of jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: '3 portions of jellof rice and fried rice'
2025-10-02 12:34:04,343 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-10-02 12:34:04,361 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:34:05,065 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA0Rjg0MjE1M0U3OERBODVDOQA="}]}
2025-10-02 12:34:05,067 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA0Rjg0MjE1M0U3OERBODVDOQA='}]}
2025-10-02 12:34:05,068 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:05] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:06,157 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:06] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:06,259 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:06] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:06,504 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:06] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:08,812 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-10-02 12:34:10,399 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:34:11,770 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:34:10.598899+00:00, interaction_count=20, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4300.0, conversion_stage=order_completed, final_order_value=5230.0, converted_at=2025-10-02 10:21:03.193436+00:00
2025-10-02 12:34:12,343 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:34:12,346 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:34:12,347 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:34:12,348 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof rice': {'item_id': 1, 'quantity': 3, 'price': 500.0, 'total_price': 1500.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Fried rice': {'item_id': 2, 'quantity': 3, 'price': 550.0, 'total_price': 1650.0, 'variations': {}, 'food_share_pattern': 'Portion'}}. Redirecting to order handler.
2025-10-02 12:34:12,349 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-10-02 12:34:12,350 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:34:12,352 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-10-02 12:34:12,353 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-10-02 12:34:12,369 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:34:13,071 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0MzhCQkRGMjY1MTBBQjU2RgA="}]}
2025-10-02 12:34:14,222 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:14] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:14,489 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:14] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:14,540 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:14] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:14,707 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:34:15,382 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-10-02 12:34:16,086 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:34:14.905333+00:00, interaction_count=21, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=cart_added, final_order_value=5230.0, converted_at=2025-10-02 10:21:03.193436+00:00
2025-10-02 12:34:16,655 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:34:16,672 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-02 12:34:16,672 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0MzhCQkRGMjY1MTBBQjU2RgA='}]}
2025-10-02 12:34:16,673 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:16] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:16,934 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:34:18,479 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:34:17.132531+00:00, interaction_count=22, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=cart_added, final_order_value=5230.0, converted_at=2025-10-02 10:21:03.193436+00:00
2025-10-02 12:34:19,075 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:34:19,077 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:34:19,077 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:34:19,077 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-10-02 12:34:19,078 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:34:19,098 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:34:19,860 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCOUZCNzg5QTAzNTUyNzAxMgA="}]}
2025-10-02 12:34:20,772 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:21,162 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:21] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:21,407 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:34:21,439 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:21] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:22,814 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:34:21.598238+00:00, interaction_count=23, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=cart_added, final_order_value=5230.0, converted_at=2025-10-02 10:21:03.193436+00:00
2025-10-02 12:34:23,399 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:34:23,411 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-02 12:34:23,411 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCOUZCNzg5QTAzNTUyNzAxMgA='}]}
2025-10-02 12:34:23,413 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:34:23] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:34:41,121 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-10-02 12:34:42,702 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:34:44,143 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:34:42.897895+00:00, interaction_count=24, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=cart_added, final_order_value=5230.0, converted_at=2025-10-02 10:21:03.193436+00:00
2025-10-02 12:34:44,815 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:34:44,817 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:34:44,817 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:34:44,818 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-10-02 12:34:47,611 - utils.data_manager - DEBUG - Found product_id 1 for product_name Jollof rice
2025-10-02 12:34:47,802 - utils.data_manager - DEBUG - Assigned product_id 1 to item Jollof rice
2025-10-02 12:34:49,412 - utils.data_manager - DEBUG - Found product_id 2 for product_name Fried rice
2025-10-02 12:34:49,608 - utils.data_manager - DEBUG - Assigned product_id 2 to item Fried rice
2025-10-02 12:34:49,655 - utils.data_manager - WARNING - No payment_reference provided for order. Generated default: PAY-ORD-3B37B51D
2025-10-02 12:34:50,092 - utils.data_manager - INFO - Saved order 223 for customer 2348055614455 with payment_reference PAY-ORD-3B37B51D
2025-10-02 12:34:50,302 - utils.data_manager - INFO - Saved order item Jollof rice for order 223
2025-10-02 12:34:50,504 - utils.data_manager - INFO - Saved order item Fried rice for order 223
2025-10-02 12:34:50,702 - handlers.order_handler - INFO - Order ORD-3B37B51D saved to database with DB ID 223 for session 2348055614455.
2025-10-02 12:34:50,704 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:34:52,416 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:34:53,741 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:34:52.612120+00:00, interaction_count=25, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=order_completed, final_order_value=3965.0, converted_at=2025-10-02 11:34:52.612120+00:00
2025-10-02 12:34:54,298 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:34:54,313 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID ORD-3B37B51D
2025-10-02 12:34:54,324 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-10-02 12:34:54,325 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-10-02 12:34:54,326 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-10-02 12:34:57,878 - utils.data_manager - INFO - Updated order 223 to status pending_payment
2025-10-02 12:34:57,880 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-10-02 12:34:57,880 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-ORD-3B37B51D with amount: 396500, email: ziga4455@lola.com
2025-10-02 12:34:58,633 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/hfb3ha2v8gfqbvf
2025-10-02 12:34:58,634 - handlers.payment_handler - INFO - Starting payment monitoring for order 223, reference PAY-ORD-3B37B51D
2025-10-02 12:34:58,635 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-3B37B51D
2025-10-02 12:34:59,124 - services.payment_service - WARNING - Payment not successful for reference PAY-ORD-3B37B51D. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5393191230, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-ORD-3B37B51D', 'receipt_number': None, 'amount': 396500, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-10-02T11:34:58.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '169.255.124.12, 172.70.86.49, 172.31.63.81', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': 'ORD-3B37B51D', 'db_order_id': '223', 'delivery_address': 'Howson Wright', 'charges': '315', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 15948, 'integration': '3965', 'subaccount': 376587, 'params': {'bearer': 'subaccount', 'transaction_charge': '3965', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-10-02T11:34:58.000Z', 'requested_amount': 396500, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-10-02T11:34:58.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-10-02 12:34:59,125 - handlers.payment_handler - INFO - Payment not yet verified for order 223, attempt 1/15
2025-10-02 12:34:59,127 - handlers.payment_handler - INFO - Payment link created successfully for order 223 with subaccount ACCT_u9knhyzn5eq4iop
2025-10-02 12:35:00,755 - utils.data_manager - INFO - Retrieved 2 items for order 223
2025-10-02 12:35:00,941 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:35:02,764 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJDNTQ0RTkwMEZBNTRBNjU1RgA="}]}
2025-10-02 12:35:03,665 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:03] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:04,103 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:04] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:04,401 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:04] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:04,578 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:35:05,954 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:35:04.775983+00:00, interaction_count=26, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=cart_added, final_order_value=3965.0, converted_at=2025-10-02 11:34:52.612120+00:00
2025-10-02 12:35:06,528 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:35:06,550 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-02 12:35:06,550 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJDNTQ0RTkwMEZBNTRBNjU1RgA='}]}
2025-10-02 12:35:06,552 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:06] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:06,590 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-10-02 12:35:08,206 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:35:09,613 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:35:08.411861+00:00, interaction_count=27, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=cart_added, final_order_value=3965.0, converted_at=2025-10-02 11:34:52.612120+00:00
2025-10-02 12:35:10,210 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:35:10,212 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:35:10,213 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:35:10,929 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-ORD-3B37B51D
2025-10-02 12:35:11,933 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order ORD-3B37B51D.
2025-10-02 12:35:13,729 - utils.data_manager - ERROR - Database error retrieving items for order ORD-3B37B51D: invalid input syntax for type bigint: "ORD-3B37B51D"
LINE 4:                         WHERE order_id = 'ORD-3B37B51D'
                                                 ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 794, in get_order_items
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<4 lines>...
        (order_id,)
        ^^^^^^^^^^^
    )
    ^
psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type bigint: "ORD-3B37B51D"
LINE 4:                         WHERE order_id = 'ORD-3B37B51D'
                                                 ^

2025-10-02 12:35:13,732 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:35:14,377 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBGMzc0NkI1ODBEODMwMUM4RgA="}]}
2025-10-02 12:35:14,531 - utils.data_manager - INFO - Updated order 223 to status confirmed
2025-10-02 12:35:15,295 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:15] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:15,776 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:15] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:15,779 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:15] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:15,960 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:35:16,352 - utils.data_manager - INFO - Retrieved 2 items for order 223
2025-10-02 12:35:17,317 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:35:16.149364+00:00, interaction_count=28, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=cart_added, final_order_value=3965.0, converted_at=2025-10-02 11:34:52.612120+00:00
2025-10-02 12:35:17,901 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:35:17,916 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-02 12:35:17,917 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBGMzc0NkI1ODBEODMwMUM4RgA='}]}
2025-10-02 12:35:17,919 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:17] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:18,429 - utils.data_manager - INFO - Reduced inventory for product_id 1 by 3 for order 223
2025-10-02 12:35:18,824 - utils.data_manager - INFO - Reduced inventory for product_id 2 by 3 for order 223
2025-10-02 12:35:19,022 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-02 12:35:20,982 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-02 12:35:21,176 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 223
2025-10-02 12:35:24,720 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-10-02 12:35:24,722 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-10-02 12:35:26,477 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:35:27,277 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNEMzdGMEUxMDBFOTkwQjlDMwA="}]}
2025-10-02 12:35:27,278 - handlers.payment_handler - INFO - Sent payment success text message for order 223 to customer 2348055614455
2025-10-02 12:35:27,279 - handlers.payment_handler - ERROR - Error sending payment success messages for order 223: cannot access local variable 'state' where it is not associated with a value
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\payment_handler.py", line 369, in _send_payment_success_message
    self._initiate_feedback_collection(state, session_id, order_id)
                                       ^^^^^
UnboundLocalError: cannot access local variable 'state' where it is not associated with a value
2025-10-02 12:35:27,281 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-10-02 12:35:28,086 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjVCOTY5Rjc4NDI2QTQ5NkY2MQA="}]}
2025-10-02 12:35:28,089 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 223 to 2347082345056
2025-10-02 12:35:28,091 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:35:28,229 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:28] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:28,610 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:28] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:28,788 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIyRkUyMzkzRTcyOEFCMTQyMwA="}]}
2025-10-02 12:35:28,791 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 223 to 2348055614455
2025-10-02 12:35:28,793 - services.whatsapp_service - DEBUG - Created text message payload for 2348096500003
2025-10-02 12:35:29,128 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-02 12:35:29,131 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 223 to 2348096500003
2025-10-02 12:35:29,132 - services.whatsapp_service - DEBUG - Created text message payload for 2348129750653
2025-10-02 12:35:29,158 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:29] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:29,161 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:29] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:29,478 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-02 12:35:29,480 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 223 to 2348129750653
2025-10-02 12:35:29,482 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:29] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-10-02 12:35:30,000 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:30] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:30,023 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:30] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:46,664 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:46] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:46,820 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:46] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:46,840 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:35:46] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:35:59,132 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-3B37B51D
2025-10-02 12:35:59,729 - services.payment_service - INFO - Payment verified successfully for reference PAY-ORD-3B37B51D. Status: success
2025-10-02 12:35:59,731 - handlers.payment_handler - INFO - Payment verified for order 223 on attempt 2
2025-10-02 12:35:59,732 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-3B37B51D
2025-10-02 12:36:00,274 - services.payment_service - INFO - Payment verified successfully for reference PAY-ORD-3B37B51D. Status: success
2025-10-02 12:36:03,781 - utils.data_manager - INFO - Updated order 223 to status confirmed
2025-10-02 12:36:05,373 - utils.data_manager - INFO - Retrieved 2 items for order 223
2025-10-02 12:36:07,364 - utils.data_manager - INFO - Reduced inventory for product_id 1 by 3 for order 223
2025-10-02 12:36:07,756 - utils.data_manager - INFO - Reduced inventory for product_id 2 by 3 for order 223
2025-10-02 12:36:07,955 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-02 12:36:09,624 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-02 12:36:09,819 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 223
2025-10-02 12:36:15,516 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:36:16,853 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:36:15.722870+00:00, interaction_count=29, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=order_completed, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:36:17,449 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:36:17,461 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID 223
2025-10-02 12:37:11,603 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-02 12:37:13,440 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-02 12:38:17,138 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-02 12:38:17,982 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:38:17] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:38:19,627 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:38:19] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:38:19,741 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:38:19] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:38:30,914 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:38:30] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:38:35,395 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Helll'}
2025-10-02 12:38:42,598 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-02 12:38:45,133 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-02 12:38:45,134 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-02 12:38:47,614 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-02 12:38:49,355 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-02 12:38:50,917 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-02 12:38:51,103 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-02 12:38:51,289 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:51,475 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:51,661 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:51,846 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:52,034 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:52,222 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:52,423 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:52,610 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:52,797 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:52,984 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:53,170 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:53,358 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:53,546 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:53,732 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:55,480 - utils.data_manager - INFO - Successfully loaded 63 user details from database
2025-10-02 12:38:55,671 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-02 12:38:55,673 - services.payment_service - INFO - PaymentService initialized
2025-10-02 12:38:55,675 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-02 12:38:55,679 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-02 12:38:56,253 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-02 12:38:56,254 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-02 12:38:56,254 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-02 12:38:56,255 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-02 12:38:56,256 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 2348096500003, 2348129750653
2025-10-02 12:38:56,257 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-02 12:38:56,258 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-02 12:38:56,259 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-02 12:38:57,244 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-02 12:38:57,887 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-02 12:38:58,088 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-02 12:38:58,289 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:58,561 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:58,764 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:58,965 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:59,167 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:59,367 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:59,569 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:59,770 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:38:59,972 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:39:00,186 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:39:00,388 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:39:00,613 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:39:00,817 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:39:01,018 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-02 12:39:02,828 - utils.data_manager - INFO - Successfully loaded 63 user details from database
2025-10-02 12:39:03,024 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-02 12:39:03,026 - services.payment_service - INFO - PaymentService initialized
2025-10-02 12:39:03,027 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-02 12:39:03,028 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-02 12:39:03,515 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-02 12:39:03,516 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-02 12:39:03,517 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-02 12:39:03,518 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-02 12:39:03,518 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-02 12:39:03,519 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-02 12:39:03,520 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 2348096500003, 2348129750653
2025-10-02 12:39:03,521 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-02 12:39:03,521 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-02 12:39:04,007 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-02 12:39:04,008 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-02 12:39:04,008 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-02 12:39:04,009 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-02 12:39:04,010 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2347082345056, 2348055614455, 2348096500003, 2348129750653
2025-10-02 12:39:04,011 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-02 12:39:04,012 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%
2025-10-02 12:39:04,037 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-02 12:39:04,037 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-02 12:39:08,852 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Helll'}
2025-10-02 12:39:08,852 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-02 12:39:10,274 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-02 12:39:10,321 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-02 12:39:10,402 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:39:11,909 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:39:10.602907+00:00, interaction_count=30, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=order_completed, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:39:12,096 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:39:12,152 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:39:12,497 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:39:12,498 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-02 12:39:12,499 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:39:13,463 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:39:12.284547+00:00, interaction_count=30, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=order_completed, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:39:13,510 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:39:12.356264+00:00, interaction_count=30, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=order_completed, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:39:14,046 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:39:14,048 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-02 12:39:14,049 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:39:14,120 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-02 12:39:14,236 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:39:14,238 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-02 12:39:14,238 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:39:14,321 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:39:14,322 - handlers.base_handler - INFO - Session 2348055614455: user_data={'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}, provided whatsapp_username=Ziga
2025-10-02 12:39:14,323 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-10-02 12:39:14,324 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-02 12:39:15,579 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-02 12:39:15,769 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-02 12:39:15,769 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:39:15,770 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-02 12:39:15,771 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-02 12:39:15,879 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-02 12:39:16,084 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-02 12:39:16,085 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:39:16,087 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-02 12:39:16,088 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-02 12:39:16,312 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE4OTA5NEVEQzlGQUQ2RUNFRAA="}]}
2025-10-02 12:39:16,315 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:39:16,398 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEzRUZGMjk2NzA4QUNDMUMxRgA="}]}
2025-10-02 12:39:16,400 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:39:16,864 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFBQzNFNUQwOEVEMkE2Q0IyRgA="}]}
2025-10-02 12:39:16,866 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:39:16,999 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY2QzFCNTg3OEM1QzdFNTUyQQA="}]}
2025-10-02 12:39:17,001 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY2QzFCNTg3OEM1QzdFNTUyQQA='}]}
2025-10-02 12:39:17,004 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:17] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:17,095 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyNDA3MTcyQjY2OUZGNjBEQwA="}]}
2025-10-02 12:39:17,097 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyNDA3MTcyQjY2OUZGNjBEQwA='}]}
2025-10-02 12:39:17,098 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:17] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:17,548 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlDNzEwOTBDQTFDRDEzRDJDNgA="}]}
2025-10-02 12:39:17,551 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlDNzEwOTBDQTFDRDEzRDJDNgA='}]}
2025-10-02 12:39:17,553 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:17] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:17,770 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:17] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:17,799 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-02 12:39:18,287 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:18] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:18,845 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:18] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:19,289 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:39:19,543 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:19] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,067 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,517 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,598 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,600 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,618 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,688 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,708 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:39:19.476191+00:00, interaction_count=33, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=order_completed, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:39:20,736 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,764 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,841 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,844 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:20,847 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:20] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:21,116 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:21] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:21,304 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:39:21,305 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:39:21,305 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:39:21,306 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-02 12:39:21,306 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:39:21,307 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-02 12:39:21,308 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-02 12:39:21,921 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI5NTlCOEI2QjI1ODA5NTA5MwA="}]}
2025-10-02 12:39:21,924 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:39:22,061 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:22] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:22,375 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:22] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:22,503 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:22] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:22,553 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0OTQyQjc3NkQwMUFEODA5NwA="}]}
2025-10-02 12:39:22,554 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0OTQyQjc3NkQwMUFEODA5NwA='}]}
2025-10-02 12:39:22,555 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:22] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:23,512 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:23] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:23,997 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:23] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:24,511 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-10-02 12:39:24,569 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:24] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:24,602 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:24] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:24,687 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:24] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:24,791 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:24] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:26,091 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:39:27,545 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:39:26.282997+00:00, interaction_count=34, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=order_completed, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:39:28,160 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:39:28,162 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:39:28,162 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:39:28,163 - handlers.base_handler - INFO - Session 2348055614455: Handling message 'ai_bulk_order_direct' in greeting state with WhatsApp username 'Ziga'.
2025-10-02 12:39:28,164 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-10-02 12:39:28,165 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-10-02 12:39:28,166 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-10-02 12:39:28,167 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-02 12:39:28,168 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-10-02 12:39:28,863 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ5RUYwRTM4QUZEODlDOUVGMQA="}]}
2025-10-02 12:39:28,865 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:39:28,867 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-10-02 12:39:29,634 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQyMUNCREE4MzMzRTBDRDA3NwA="}]}
2025-10-02 12:39:29,636 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQyMUNCREE4MzMzRTBDRDA3NwA='}]}
2025-10-02 12:39:29,639 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:29] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:30,428 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:30] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:30,827 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:30] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:30,961 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:30] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:30,992 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:30] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:31,496 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:31] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:31,501 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:31] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:39,930 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice and egg and beed'}
2025-10-02 12:39:41,524 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:39:43,017 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:39:41.720837+00:00, interaction_count=35, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=order_completed, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:39:43,664 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:39:43,666 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:39:43,667 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:39:43,668 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice and egg and beed' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice and egg and beed'
2025-10-02 12:39:49,479 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-10-02 12:39:49,501 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:39:50,266 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU5RTdGOTZCQkNBREEzMDRGNgA="}]}
2025-10-02 12:39:50,269 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU5RTdGOTZCQkNBREEzMDRGNgA='}]}
2025-10-02 12:39:50,272 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:50] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:51,217 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:51] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:51,655 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:51] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:51,844 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:51] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:54,018 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-10-02 12:39:55,646 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:39:57,139 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:39:55.835974+00:00, interaction_count=36, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3150.0, conversion_stage=order_completed, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:39:57,767 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:39:57,770 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:39:57,771 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:39:57,772 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof rice': {'item_id': 1, 'quantity': 1, 'price': 500.0, 'total_price': 500.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Fried rice': {'item_id': 2, 'quantity': 1, 'price': 550.0, 'total_price': 550.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Egg': {'item_id': 32, 'quantity': 1, 'price': 350.0, 'total_price': 350.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Beef': {'item_id': 33, 'quantity': 1, 'price': 300.0, 'total_price': 300.0, 'variations': {}, 'food_share_pattern': 'Portion'}}. Redirecting to order handler.
2025-10-02 12:39:57,773 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-10-02 12:39:57,774 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:39:57,776 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-10-02 12:39:57,777 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-10-02 12:39:57,791 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:39:58,494 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBGNkRFQTQyRDJGOTBBN0IwRAA="}]}
2025-10-02 12:39:59,605 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:59] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:59,785 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:59] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:39:59,965 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:39:59] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:00,094 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:40:01,014 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-10-02 12:40:01,455 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:40:00.290626+00:00, interaction_count=37, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1700.0, conversion_stage=cart_added, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:40:02,062 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:40:02,074 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-02 12:40:02,074 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBGNkRFQTQyRDJGOTBBN0IwRAA='}]}
2025-10-02 12:40:02,076 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:02] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:02,589 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:40:04,078 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:40:02.810165+00:00, interaction_count=38, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1700.0, conversion_stage=cart_added, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:40:04,654 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:40:04,656 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:40:04,656 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:40:04,657 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-10-02 12:40:04,657 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:40:04,683 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-02 12:40:05,623 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM0RTA1QUM0QjlGMTI4RTk2RAA="}]}
2025-10-02 12:40:06,550 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:06] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:06,669 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:06] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:06,842 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:06] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:07,173 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:40:08,334 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-10-02 12:40:08,559 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:40:07.363010+00:00, interaction_count=39, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1700.0, conversion_stage=cart_added, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:40:09,144 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:40:09,164 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-02 12:40:09,164 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM0RTA1QUM0QjlGMTI4RTk2RAA='}]}
2025-10-02 12:40:09,166 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:09] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:09,941 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:40:11,385 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:40:10.161121+00:00, interaction_count=40, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1700.0, conversion_stage=cart_added, final_order_value=3965.0, converted_at=2025-10-02 11:36:15.722870+00:00
2025-10-02 12:40:11,985 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:40:11,988 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:40:11,989 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:40:11,990 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-10-02 12:40:14,747 - utils.data_manager - DEBUG - Found product_id 1 for product_name Jollof rice
2025-10-02 12:40:14,937 - utils.data_manager - DEBUG - Assigned product_id 1 to item Jollof rice
2025-10-02 12:40:16,584 - utils.data_manager - DEBUG - Found product_id 2 for product_name Fried rice
2025-10-02 12:40:16,783 - utils.data_manager - DEBUG - Assigned product_id 2 to item Fried rice
2025-10-02 12:40:18,359 - utils.data_manager - DEBUG - Found product_id 32 for product_name Egg
2025-10-02 12:40:18,550 - utils.data_manager - DEBUG - Assigned product_id 32 to item Egg
2025-10-02 12:40:20,292 - utils.data_manager - DEBUG - Found product_id 33 for product_name Beef
2025-10-02 12:40:20,853 - utils.data_manager - DEBUG - Assigned product_id 33 to item Beef
2025-10-02 12:40:20,853 - utils.data_manager - WARNING - No payment_reference provided for order. Generated default: PAY-ORD-CD62D3AD
2025-10-02 12:40:21,246 - utils.data_manager - INFO - Saved order 225 for customer 2348055614455 with payment_reference PAY-ORD-CD62D3AD
2025-10-02 12:40:21,442 - utils.data_manager - INFO - Saved order item Jollof rice for order 225
2025-10-02 12:40:21,641 - utils.data_manager - INFO - Saved order item Fried rice for order 225
2025-10-02 12:40:21,842 - utils.data_manager - INFO - Saved order item Egg for order 225
2025-10-02 12:40:22,037 - utils.data_manager - INFO - Saved order item Beef for order 225
2025-10-02 12:40:22,244 - handlers.order_handler - INFO - Order ORD-CD62D3AD saved to database with DB ID 225 for session 2348055614455.
2025-10-02 12:40:22,266 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-02 12:40:24,319 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:40:25,745 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:40:24.511005+00:00, interaction_count=41, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1700.0, conversion_stage=order_completed, final_order_value=2370.0, converted_at=2025-10-02 11:40:24.511005+00:00
2025-10-02 12:40:26,680 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:40:26,691 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID ORD-CD62D3AD
2025-10-02 12:40:26,703 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-10-02 12:40:26,704 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-10-02 12:40:26,705 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-10-02 12:40:30,529 - utils.data_manager - INFO - Updated order 225 to status pending_payment
2025-10-02 12:40:30,531 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-10-02 12:40:30,532 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-ORD-CD62D3AD with amount: 237000, email: ziga4455@lola.com
2025-10-02 12:40:31,320 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/pfe8rnzfjeqdscb
2025-10-02 12:40:31,321 - handlers.payment_handler - INFO - Starting payment monitoring for order 225, reference PAY-ORD-CD62D3AD
2025-10-02 12:40:31,322 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-CD62D3AD
2025-10-02 12:40:31,864 - services.payment_service - WARNING - Payment not successful for reference PAY-ORD-CD62D3AD. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5393203674, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-ORD-CD62D3AD', 'receipt_number': None, 'amount': 237000, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-10-02T11:40:31.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '169.255.124.15, 172.70.162.197, 172.31.62.52', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': 'ORD-CD62D3AD', 'db_order_id': '225', 'delivery_address': 'Howson Wright', 'charges': '170', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 3555, 'integration': '2370', 'subaccount': 231075, 'params': {'bearer': 'subaccount', 'transaction_charge': '2370', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-10-02T11:40:31.000Z', 'requested_amount': 237000, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-10-02T11:40:31.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-10-02 12:40:31,866 - handlers.payment_handler - INFO - Payment not yet verified for order 225, attempt 1/15
2025-10-02 12:40:31,869 - handlers.payment_handler - INFO - Payment link created successfully for order 225 with subaccount ACCT_u9knhyzn5eq4iop
2025-10-02 12:40:33,498 - utils.data_manager - INFO - Retrieved 4 items for order 225
2025-10-02 12:40:33,504 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-10-02 12:40:33,698 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:40:34,759 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJEQkFFREY5NjlFOTEyRDc0MQA="}]}
2025-10-02 12:40:35,094 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:40:36,006 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:36] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:36,115 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:36] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:36,342 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:36] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:36,646 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:40:35.284918+00:00, interaction_count=42, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1700.0, conversion_stage=order_completed, final_order_value=2370.0, converted_at=2025-10-02 11:40:24.511005+00:00
2025-10-02 12:40:36,800 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:40:37,248 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:40:37,250 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-02 12:40:37,250 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-02 12:40:38,200 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:40:36.996309+00:00, interaction_count=42, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1700.0, conversion_stage=cart_added, final_order_value=2370.0, converted_at=2025-10-02 11:40:24.511005+00:00
2025-10-02 12:40:38,858 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:40:38,870 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-02 12:40:38,871 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJEQkFFREY5NjlFOTEyRDc0MQA='}]}
2025-10-02 12:40:38,873 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:38] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:39,034 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order ORD-CD62D3AD.
2025-10-02 12:40:40,797 - utils.data_manager - ERROR - Database error retrieving items for order ORD-CD62D3AD: invalid input syntax for type bigint: "ORD-CD62D3AD"
LINE 4:                         WHERE order_id = 'ORD-CD62D3AD'
                                                 ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 794, in get_order_items
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<4 lines>...
        (order_id,)
        ^^^^^^^^^^^
    )
    ^
psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type bigint: "ORD-CD62D3AD"
LINE 4:                         WHERE order_id = 'ORD-CD62D3AD'
                                                 ^

2025-10-02 12:40:40,805 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:40:41,470 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM1RkI0OERCQjRCNkZBNkExQwA="}]}
2025-10-02 12:40:42,498 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-ORD-CD62D3AD
2025-10-02 12:40:42,575 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:42] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:42,779 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:42] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:42,941 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:42] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:43,053 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:40:44,408 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:40:43.247580+00:00, interaction_count=44, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1700.0, conversion_stage=cart_added, final_order_value=2370.0, converted_at=2025-10-02 11:40:24.511005+00:00
2025-10-02 12:40:44,976 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:40:44,988 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-02 12:40:44,989 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM1RkI0OERCQjRCNkZBNkExQwA='}]}
2025-10-02 12:40:44,991 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:44] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:46,217 - utils.data_manager - INFO - Updated order 225 to status confirmed
2025-10-02 12:40:47,839 - utils.data_manager - INFO - Retrieved 4 items for order 225
2025-10-02 12:40:50,183 - utils.data_manager - INFO - Reduced inventory for product_id 1 by 1 for order 225
2025-10-02 12:40:50,674 - utils.data_manager - INFO - Reduced inventory for product_id 2 by 1 for order 225
2025-10-02 12:40:51,082 - utils.data_manager - INFO - Reduced inventory for product_id 32 by 1 for order 225
2025-10-02 12:40:51,491 - utils.data_manager - INFO - Reduced inventory for product_id 33 by 1 for order 225
2025-10-02 12:40:51,698 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-02 12:40:53,373 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-02 12:40:53,571 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 225
2025-10-02 12:40:54,114 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:40:54] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:40:55,146 - utils.data_manager - WARNING - Low inventory for product id 1: 5 units remaining
2025-10-02 12:40:55,341 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 1: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 244, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-10-02 12:40:56,950 - utils.data_manager - WARNING - Low inventory for product id 2: 5 units remaining
2025-10-02 12:40:57,141 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 2: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 244, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-10-02 12:41:00,706 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-10-02 12:41:00,707 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-10-02 12:41:02,550 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:41:03,315 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQzQ0NCRDAwRDYyMDRDNDFGMwA="}]}
2025-10-02 12:41:03,316 - handlers.payment_handler - INFO - Sent payment success text message for order 225 to customer 2348055614455
2025-10-02 12:41:03,317 - handlers.payment_handler - ERROR - Error sending payment success messages for order 225: cannot access local variable 'state' where it is not associated with a value
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\payment_handler.py", line 369, in _send_payment_success_message
    self._initiate_feedback_collection(state, session_id, order_id)
                                       ^^^^^
UnboundLocalError: cannot access local variable 'state' where it is not associated with a value
2025-10-02 12:41:03,318 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-10-02 12:41:04,037 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkRFN0UyNjlEMUE2RDg2NkJFNQA="}]}
2025-10-02 12:41:04,039 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 225 to 2347082345056
2025-10-02 12:41:04,039 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-02 12:41:04,306 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:41:04] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:41:04,571 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:41:04] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:41:04,792 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEwQkVFNTYwNjA0NzU5MTk3RQA="}]}
2025-10-02 12:41:04,794 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 225 to 2348055614455
2025-10-02 12:41:04,796 - services.whatsapp_service - DEBUG - Created text message payload for 2348096500003
2025-10-02 12:41:04,876 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:41:04] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:41:05,685 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348096500003","wa_id":"2348096500003"}],"messages":[{"id":"wamid.HBgNMjM0ODA5NjUwMDAwMxUCABEYEkE5RkFGMzY0MUM5MzM3NzUzQgA="}]}
2025-10-02 12:41:05,688 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 225 to 2348096500003
2025-10-02 12:41:05,689 - services.whatsapp_service - DEBUG - Created text message payload for 2348129750653
2025-10-02 12:41:05,794 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:41:05] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:41:06,433 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:41:06] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:41:06,557 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-02 12:41:06,559 - handlers.payment_handler - INFO - Sent detailed fallback merchant notification for order 225 to 2348129750653
2025-10-02 12:41:06,562 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:41:06] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-10-02 12:41:06,791 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:41:06] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:41:13,415 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:41:13] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:41:13,639 - werkzeug - INFO - 127.0.0.1 - - [02/Oct/2025 12:41:13] "POST /webhook HTTP/1.1" 200 -
2025-10-02 12:41:31,878 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-CD62D3AD
2025-10-02 12:41:32,410 - services.payment_service - INFO - Payment verified successfully for reference PAY-ORD-CD62D3AD. Status: success
2025-10-02 12:41:32,412 - handlers.payment_handler - INFO - Payment verified for order 225 on attempt 2
2025-10-02 12:41:32,413 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-CD62D3AD
2025-10-02 12:41:32,918 - services.payment_service - INFO - Payment verified successfully for reference PAY-ORD-CD62D3AD. Status: success
2025-10-02 12:41:36,417 - utils.data_manager - INFO - Updated order 225 to status confirmed
2025-10-02 12:41:37,945 - utils.data_manager - INFO - Retrieved 4 items for order 225
2025-10-02 12:41:40,457 - utils.data_manager - INFO - Reduced inventory for product_id 1 by 1 for order 225
2025-10-02 12:41:40,860 - utils.data_manager - INFO - Reduced inventory for product_id 2 by 1 for order 225
2025-10-02 12:41:41,365 - utils.data_manager - INFO - Reduced inventory for product_id 32 by 1 for order 225
2025-10-02 12:41:41,755 - utils.data_manager - INFO - Reduced inventory for product_id 33 by 1 for order 225
2025-10-02 12:41:41,961 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-02 12:41:43,619 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-02 12:41:43,825 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 225
2025-10-02 12:41:45,376 - utils.data_manager - WARNING - Low inventory for product id 1: 4 units remaining
2025-10-02 12:41:45,565 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 1: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 244, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-10-02 12:41:47,165 - utils.data_manager - WARNING - Low inventory for product id 2: 4 units remaining
2025-10-02 12:41:47,356 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 2: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 244, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-10-02 12:41:52,845 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-02 12:41:54,247 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-02 11:41:53.040879+00:00, interaction_count=45, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1700.0, conversion_stage=order_completed, final_order_value=2370.0, converted_at=2025-10-02 11:41:53.040879+00:00
2025-10-02 12:41:54,850 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-02 12:41:54,857 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID 225
2025-10-02 12:42:46,528 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-02 12:42:46,529 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-09 13:06:43,112 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-09 13:06:48,480 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-09 13:06:50,700 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-09 13:06:51,029 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-09 13:06:51,234 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-09 13:06:51,439 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-09 13:06:51,637 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-09 13:06:51,848 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-09 13:06:52,053 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-09 13:06:52,257 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-09 13:06:52,484 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-09 13:06:52,678 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-09 13:06:53,158 - __main__ - INFO - Bot server stopped by user.
2025-10-11 12:45:24,173 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-11 12:45:26,096 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-11 12:45:28,564 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-11 12:45:28,769 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-11 12:45:28,962 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:29,198 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:29,394 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:29,597 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:29,802 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:29,998 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:30,237 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:30,438 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:30,657 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:30,850 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:31,048 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:31,242 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:31,458 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:31,653 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:33,462 - utils.data_manager - INFO - Successfully loaded 66 user details from database
2025-10-11 12:45:33,666 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-11 12:45:33,667 - services.payment_service - INFO - PaymentService initialized
2025-10-11 12:45:33,667 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-11 12:45:33,668 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-11 12:45:34,162 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-11 12:45:34,162 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-11 12:45:34,163 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-11 12:45:34,163 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-11 12:45:34,164 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2348096500003, 2347082345056, 2348055614455, 2348129750653
2025-10-11 12:45:34,164 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-11 12:45:34,165 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 10%
2025-10-11 12:45:34,165 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-11 12:45:35,250 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-11 12:45:35,823 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-11 12:45:36,021 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-11 12:45:36,223 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:36,498 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:36,698 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:36,913 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:37,111 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:37,310 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:37,509 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:37,706 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:37,904 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:38,103 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:38,300 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:38,497 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:38,695 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:38,892 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:45:40,651 - utils.data_manager - INFO - Successfully loaded 66 user details from database
2025-10-11 12:45:40,842 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-11 12:45:40,843 - services.payment_service - INFO - PaymentService initialized
2025-10-11 12:45:40,843 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-11 12:45:40,843 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-11 12:45:41,184 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-11 12:45:41,185 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-11 12:45:41,185 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-11 12:45:41,197 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-11 12:45:41,197 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-11 12:45:41,197 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-11 12:45:41,198 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2348096500003, 2347082345056, 2348055614455, 2348129750653
2025-10-11 12:45:41,198 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-11 12:45:41,199 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 10%
2025-10-11 12:45:41,545 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-11 12:45:41,546 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-11 12:45:41,546 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-11 12:45:41,546 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-11 12:45:41,547 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2348096500003, 2347082345056, 2348055614455, 2348129750653
2025-10-11 12:45:41,547 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-11 12:45:41,548 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 10%
2025-10-11 12:45:41,578 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-11 12:45:41,578 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-11 12:46:04,357 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-11 12:46:04,357 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-11 12:46:05,897 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:46:07,278 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:46:06.090005+00:00, interaction_count=100, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:46:07,879 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:46:07,880 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-11 12:46:07,880 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-11 12:46:09,475 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-11 12:46:09,670 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-11 12:46:09,671 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': 'WhatsAppService' object has no attribute 'send_typing_indicator'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 179, in _route_to_handler
    return self.greeting_handler.handle_back_to_main(state, session_id, whatsapp_username, "Let's start fresh. What can I do for you?")
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 318, in handle_back_to_main
    self.whatsapp_service.send_typing_indicator(session_id, duration=1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'WhatsAppService' object has no attribute 'send_typing_indicator'
2025-10-11 12:46:09,686 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-11 12:46:10,092 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-11 12:46:10,094 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:46:10] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:46:25,649 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-11 12:46:25,662 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-11 12:46:39,522 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-11 12:46:40,673 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-11 12:46:42,219 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-11 12:46:42,410 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-11 12:46:42,605 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:42,798 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:42,989 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:43,192 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:43,383 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:43,574 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:43,774 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:43,965 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:44,157 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:44,363 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:44,557 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:44,752 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:45,005 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:45,196 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:46,910 - utils.data_manager - INFO - Successfully loaded 66 user details from database
2025-10-11 12:46:47,097 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-11 12:46:47,098 - services.payment_service - INFO - PaymentService initialized
2025-10-11 12:46:47,098 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-11 12:46:47,099 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-11 12:46:47,486 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-11 12:46:47,487 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-11 12:46:47,487 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-11 12:46:47,488 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-11 12:46:47,488 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2348096500003, 2347082345056, 2348055614455, 2348129750653
2025-10-11 12:46:47,489 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-11 12:46:47,489 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 10%
2025-10-11 12:46:47,489 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-11 12:46:48,677 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-11 12:46:49,211 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-11 12:46:49,409 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-11 12:46:49,606 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:49,804 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:50,001 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:50,203 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:50,401 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:50,598 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:50,797 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:50,994 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:51,192 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:51,390 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:51,602 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:51,799 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:51,998 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:52,195 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:46:53,976 - utils.data_manager - INFO - Successfully loaded 66 user details from database
2025-10-11 12:46:54,170 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-11 12:46:54,171 - services.payment_service - INFO - PaymentService initialized
2025-10-11 12:46:54,171 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-11 12:46:54,171 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-11 12:46:54,521 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-11 12:46:54,521 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-11 12:46:54,521 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-11 12:46:54,522 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-11 12:46:54,522 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-11 12:46:54,523 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-11 12:46:54,523 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2348096500003, 2347082345056, 2348055614455, 2348129750653
2025-10-11 12:46:54,524 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-11 12:46:54,524 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 10%
2025-10-11 12:46:54,869 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-11 12:46:54,869 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-11 12:46:54,870 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-11 12:46:54,870 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-11 12:46:54,871 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2348096500003, 2347082345056, 2348055614455, 2348129750653
2025-10-11 12:46:54,871 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-11 12:46:54,872 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 10%
2025-10-11 12:46:54,891 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-11 12:46:54,891 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-11 12:47:00,475 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-11 12:47:00,475 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-11 12:47:02,054 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:47:03,397 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:47:02.248248+00:00, interaction_count=101, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:47:03,965 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:47:03,966 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-11 12:47:03,967 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-11 12:47:05,501 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-11 12:47:05,694 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-11 12:47:05,694 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': 'WhatsAppService' object has no attribute 'send_typing_indicator'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 179, in _route_to_handler
    return self.greeting_handler.handle_back_to_main(state, session_id, whatsapp_username, "Let's start fresh. What can I do for you?")
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 318, in handle_back_to_main
    self.whatsapp_service.send_typing_indicator(session_id, duration=1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'WhatsAppService' object has no attribute 'send_typing_indicator'
2025-10-11 12:47:05,697 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-11 12:47:07,456 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyQjA5RDI1NEMxRDI4QUZEOAA="}]}
2025-10-11 12:47:07,456 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyQjA5RDI1NEMxRDI4QUZEOAA='}]}
2025-10-11 12:47:07,457 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:47:07] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:47:09,625 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:47:09] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:47:09,751 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-11 12:47:09,959 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:47:09] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:47:09,972 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:47:09] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:47:11,326 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:47:12,716 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:47:11.522121+00:00, interaction_count=102, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:47:13,286 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:47:13,287 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-11 12:47:13,288 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-11 12:47:13,288 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-11 12:47:13,288 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'greeting': 'WhatsAppService' object has no attribute 'send_typing_indicator'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 179, in _route_to_handler
    return self.greeting_handler.handle_back_to_main(state, session_id, whatsapp_username, "Let's start fresh. What can I do for you?")
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 318, in handle_back_to_main
    self.whatsapp_service.send_typing_indicator(session_id, duration=1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'WhatsAppService' object has no attribute 'send_typing_indicator'
2025-10-11 12:47:13,290 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-11 12:47:14,631 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2RTBBRDZERkYzM0IyRDYwMwA="}]}
2025-10-11 12:47:14,632 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2RTBBRDZERkYzM0IyRDYwMwA='}]}
2025-10-11 12:47:14,633 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:47:14] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:47:15,706 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:47:15] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:47:16,108 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:47:16] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:47:16,227 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:47:16] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:47:35,444 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-11 12:47:35,445 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-10-11 12:52:47,049 - __main__ - INFO - Starting WhatsApp bot server...
2025-10-11 12:52:48,779 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-11 12:52:51,245 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-11 12:52:51,436 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-11 12:52:51,633 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:51,824 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:52,025 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:52,220 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:52,410 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:52,603 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:52,796 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:52,988 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:53,180 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:53,371 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:53,562 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:53,754 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:53,945 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:54,146 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:55,874 - utils.data_manager - INFO - Successfully loaded 66 user details from database
2025-10-11 12:52:56,067 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-11 12:52:56,068 - services.payment_service - INFO - PaymentService initialized
2025-10-11 12:52:56,068 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-10-11 12:52:56,069 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-11 12:52:56,521 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-11 12:52:56,521 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-11 12:52:56,521 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-10-11 12:52:56,522 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-11 12:52:56,522 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2349030918492, 2347082345056, 2348055614455
2025-10-11 12:52:56,523 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-11 12:52:56,523 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 10%
2025-10-11 12:52:56,524 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-10-11 12:52:57,575 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-11 12:52:58,115 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-10-11 12:52:58,312 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-10-11 12:52:58,508 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:58,703 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:58,899 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:59,095 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:59,293 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:59,537 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:59,733 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:52:59,929 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:53:00,126 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:53:00,322 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:53:00,518 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:53:00,714 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:53:00,912 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:53:01,109 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-10-11 12:53:02,875 - utils.data_manager - INFO - Successfully loaded 66 user details from database
2025-10-11 12:53:03,519 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-10-11 12:53:03,520 - services.payment_service - INFO - PaymentService initialized
2025-10-11 12:53:03,520 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-10-11 12:53:03,520 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-10-11 12:53:03,873 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-11 12:53:03,873 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-10-11 12:53:03,874 - handlers.enquiry_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-11 12:53:03,875 - handlers.complaint_handler - WARNING - MERCHANT_PHONE_NUMBER not configured, merchant notifications will be skipped
2025-10-11 12:53:03,875 - handlers.order_handler - INFO - OrderHandler initialized.
2025-10-11 12:53:03,876 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-10-11 12:53:03,876 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2349030918492, 2347082345056, 2348055614455
2025-10-11 12:53:03,877 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-11 12:53:03,877 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 10%
2025-10-11 12:53:04,231 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-10-11 12:53:04,231 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-10-11 12:53:04,231 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-10-11 12:53:04,232 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-10-11 12:53:04,232 - handlers.payment_handler - INFO - PaymentHandler initialized with merchant phone numbers: 2349030918492, 2347082345056, 2348055614455
2025-10-11 12:53:04,233 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-10-11 12:53:04,233 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 10%
2025-10-11 12:53:04,252 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-10-11 12:53:04,252 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-10-11 12:53:26,027 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-10-11 12:53:26,028 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-10-11 12:53:27,613 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:53:28,992 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:53:27.812238+00:00, interaction_count=103, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:53:29,561 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:53:29,562 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-10-11 12:53:29,563 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-11 12:53:31,105 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-10-11 12:53:31,297 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-10-11 12:53:31,297 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-11 12:53:31,298 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-10-11 12:53:31,298 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-11 12:53:32,180 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0Q0FDRTc1MjI2NzRDRjZDMQA="}]}
2025-10-11 12:53:32,182 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-11 12:53:32,926 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxODkwMzY0M0M1REZEOTYyQQA="}]}
2025-10-11 12:53:32,927 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxODkwMzY0M0M1REZEOTYyQQA='}]}
2025-10-11 12:53:32,928 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:32] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:34,135 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:34] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:34,394 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:34] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:34,409 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:34] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:34,987 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:34] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:35,886 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-10-11 12:53:37,453 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:53:38,839 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:53:37.649430+00:00, interaction_count=104, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:53:39,440 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:53:39,441 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-11 12:53:39,441 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-11 12:53:39,441 - handlers.base_handler - INFO - Session 2348055614455: Handling message 'ai_bulk_order_direct' in greeting state with WhatsApp username 'Ziga'.
2025-10-11 12:53:39,441 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-10-11 12:53:39,442 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-10-11 12:53:39,442 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-10-11 12:53:39,442 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-10-11 12:53:39,443 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-10-11 12:53:40,135 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxODk5MTgwN0I3MTI1NTIxQQA="}]}
2025-10-11 12:53:40,136 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-11 12:53:40,137 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-10-11 12:53:40,807 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBRTc0Q0ZFRDAwMEE5QjU3RgA="}]}
2025-10-11 12:53:40,808 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBRTc0Q0ZFRDAwMEE5QjU3RgA='}]}
2025-10-11 12:53:40,809 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:40] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:41,897 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:41] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:42,304 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:42] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:42,426 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:42] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:42,780 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:42] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:49,193 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-10-11 12:53:50,776 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:53:52,182 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:53:50.971993+00:00, interaction_count=105, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:53:52,781 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:53:52,782 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-11 12:53:52,782 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-11 12:53:52,782 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-10-11 12:53:56,867 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-10-11 12:53:56,883 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-11 12:53:57,912 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAwRkQyNUU0QTNFQUI4RUU5NgA="}]}
2025-10-11 12:53:57,912 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAwRkQyNUU0QTNFQUI4RUU5NgA='}]}
2025-10-11 12:53:57,913 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:57] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:58,884 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:58] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:59,500 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:59] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:53:59,572 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:53:59] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:04,380 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-10-11 12:54:05,959 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:54:07,333 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:54:06.155268+00:00, interaction_count=106, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:54:07,924 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:54:07,925 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-11 12:54:07,925 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-11 12:54:07,926 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof rice': {'item_id': 1, 'quantity': 1, 'price': 500.0, 'total_price': 500.0, 'variations': {}, 'food_share_pattern': 'Portion'}}. Redirecting to order handler.
2025-10-11 12:54:07,926 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-10-11 12:54:07,926 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-11 12:54:07,927 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-10-11 12:54:07,927 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-10-11 12:54:07,936 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-11 12:54:08,781 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk1OEIwRUFDQzAyRTZCQTlGNAA="}]}
2025-10-11 12:54:09,743 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:09] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:10,129 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:10] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:10,281 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:54:10,342 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:10] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:11,664 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:54:10.467527+00:00, interaction_count=107, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=500.0, conversion_stage=cart_added, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:54:12,253 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:54:12,264 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-11 12:54:12,264 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk1OEIwRUFDQzAyRTZCQTlGNAA='}]}
2025-10-11 12:54:12,266 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:12] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:13,274 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-10-11 12:54:14,830 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:54:16,257 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:54:15.054115+00:00, interaction_count=108, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=500.0, conversion_stage=cart_added, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:54:16,851 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:54:16,852 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-11 12:54:16,852 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-11 12:54:16,852 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-10-11 12:54:16,853 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-11 12:54:16,864 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-11 12:54:17,654 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM0NUQxMEI5NTFBNzI4NUNBQQA="}]}
2025-10-11 12:54:18,574 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:18] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:18,989 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:18] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:19,195 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:54:19,259 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:19] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:20,534 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:54:19.389130+00:00, interaction_count=109, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=500.0, conversion_stage=cart_added, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:54:21,091 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-10-11 12:54:21,096 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:54:21,101 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-11 12:54:21,102 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM0NUQxMEI5NTFBNzI4NUNBQQA='}]}
2025-10-11 12:54:21,103 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:21] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:22,674 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:54:24,049 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:54:22.869080+00:00, interaction_count=110, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=500.0, conversion_stage=cart_added, final_order_value=4350.0, converted_at=2025-10-09 12:36:45.121977+00:00
2025-10-11 12:54:24,619 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:54:24,620 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-10-11 12:54:24,620 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-10-11 12:54:24,620 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-10-11 12:54:27,345 - utils.data_manager - DEBUG - Found product_id 1 for product_name Jollof rice
2025-10-11 12:54:27,548 - utils.data_manager - DEBUG - Assigned product_id 1 to item Jollof rice
2025-10-11 12:54:27,549 - utils.data_manager - WARNING - No payment_reference provided for order. Generated default: PAY-ORD-94A062C0
2025-10-11 12:54:27,979 - utils.data_manager - INFO - Saved order 232 for customer 2348055614455 with payment_reference PAY-ORD-94A062C0
2025-10-11 12:54:28,181 - utils.data_manager - INFO - Saved order item Jollof rice for order 232
2025-10-11 12:54:28,376 - handlers.order_handler - INFO - Order ORD-94A062C0 saved to database with DB ID 232 for session 2348055614455.
2025-10-11 12:54:28,377 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-10-11 12:54:29,979 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:54:31,343 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:54:30.174578+00:00, interaction_count=111, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=500.0, conversion_stage=order_completed, final_order_value=1050.0, converted_at=2025-10-11 11:54:30.174578+00:00
2025-10-11 12:54:31,931 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:54:31,938 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID ORD-94A062C0
2025-10-11 12:54:31,944 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-10-11 12:54:31,944 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-10-11 12:54:31,944 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-10-11 12:54:35,501 - utils.data_manager - INFO - Updated order 232 to status pending_payment
2025-10-11 12:54:35,502 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=10%
2025-10-11 12:54:35,502 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-ORD-94A062C0 with amount: 105000, email: ziga4455@lola.com
2025-10-11 12:54:36,218 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/0uhydxwccghysb9
2025-10-11 12:54:36,219 - handlers.payment_handler - INFO - Starting payment monitoring for order 232, reference PAY-ORD-94A062C0
2025-10-11 12:54:36,219 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-94A062C0
2025-10-11 12:54:36,756 - services.payment_service - WARNING - Payment not successful for reference PAY-ORD-94A062C0. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5419538737, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-ORD-94A062C0', 'receipt_number': None, 'amount': 105000, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-10-11T11:54:36.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '169.255.124.4, 172.69.43.182, 172.31.68.120', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': 'ORD-94A062C0', 'db_order_id': '232', 'delivery_address': 'Howson Wright', 'charges': '50', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 1575, 'integration': 8925, 'subaccount': 94500, 'params': {'bearer': 'account', 'transaction_charge': '10500', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-10-11T11:54:36.000Z', 'requested_amount': 105000, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-10-11T11:54:36.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-10-11 12:54:36,756 - handlers.payment_handler - INFO - Payment not yet verified for order 232, attempt 1/15
2025-10-11 12:54:36,757 - handlers.payment_handler - INFO - Payment link created successfully for order 232 with subaccount ACCT_u9knhyzn5eq4iop
2025-10-11 12:54:38,289 - utils.data_manager - INFO - Retrieved 1 items for order 232
2025-10-11 12:54:38,480 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-11 12:54:39,508 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI3NjNBQUUxQzAzMzkxNzgwQwA="}]}
2025-10-11 12:54:40,579 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:40] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:41,047 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:41] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:41,106 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:54:41,245 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:41] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:54:42,464 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:54:41.302457+00:00, interaction_count=112, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=500.0, conversion_stage=cart_added, final_order_value=1050.0, converted_at=2025-10-11 11:54:30.174578+00:00
2025-10-11 12:54:43,039 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:54:43,046 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-10-11 12:54:43,046 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI3NjNBQUUxQzAzMzkxNzgwQwA='}]}
2025-10-11 12:54:43,047 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:54:43] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:55:36,760 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-94A062C0
2025-10-11 12:55:37,269 - services.payment_service - WARNING - Payment not successful for reference PAY-ORD-94A062C0. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5419538737, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-ORD-94A062C0', 'receipt_number': None, 'amount': 105000, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-10-11T11:54:36.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '169.255.124.4, 172.69.43.182, 172.31.68.120', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': 'ORD-94A062C0', 'db_order_id': '232', 'delivery_address': 'Howson Wright', 'charges': '50', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 1575, 'integration': 8925, 'subaccount': 94500, 'params': {'bearer': 'account', 'transaction_charge': '10500', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-10-11T11:54:36.000Z', 'requested_amount': 105000, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-10-11T11:54:36.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-10-11 12:55:37,270 - handlers.payment_handler - INFO - Payment not yet verified for order 232, attempt 2/15
2025-10-11 12:55:44,975 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-ORD-94A062C0
2025-10-11 12:55:48,445 - utils.data_manager - INFO - Updated order 232 to status confirmed
2025-10-11 12:55:50,037 - utils.data_manager - INFO - Retrieved 1 items for order 232
2025-10-11 12:55:51,968 - utils.data_manager - INFO - Reduced inventory for product_id 1 by 1 for order 232
2025-10-11 12:55:52,162 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-11 12:55:53,711 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-11 12:55:53,902 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 232
2025-10-11 12:55:55,421 - utils.data_manager - WARNING - Low inventory for product id 1: 0 units remaining
2025-10-11 12:55:55,605 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 1: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 244, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-10-11 12:55:55,610 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-10-11 12:55:55,610 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-10-11 12:55:57,451 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-11 12:55:58,166 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJCNDc2QURDRkU2M0E2NEE1NgA="}]}
2025-10-11 12:55:58,167 - handlers.payment_handler - INFO - Sent payment success text message for order 232 to customer 2348055614455
2025-10-11 12:55:58,167 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 232, session 2348055614455
2025-10-11 12:55:58,168 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 10, 11, 12, 55, 58, 168369), 'payment_reference': 'PAY-ORD-94A062C0', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'items': [{'name': 'Jollof rice', 'portions': 1, 'item_id': 1, 'price': 500.0, 'total_price': 500.0, 'variations': {}, 'food_share_pattern': 'Portion'}], 'packs': 1, 'grouping': 'None', 'special_instructions': '', 'order_total': 500.0, 'unrecognized_items': []}, 'total_price': 500.0, 'from_ai_order': True, 'order_id': 'ORD-94A062C0', 'db_order_id': '232', 'feedback_order_id': 232, 'feedback_started_at': '2025-10-11T12:55:58.168356'}
2025-10-11 12:55:58,173 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-10-11 12:55:58,831 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhEN0EzOTQ5NDE5Q0EwM0ZCOAA="}]}
2025-10-11 12:55:58,832 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 232, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhEN0EzOTQ5NDE5Q0EwM0ZCOAA='}]}
2025-10-11 12:55:58,833 - services.whatsapp_service - DEBUG - Created text message payload for 2349030918492
2025-10-11 12:55:59,164 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:55:59] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:55:59,172 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-11 12:55:59,173 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 232 to 2349030918492
2025-10-11 12:55:59,174 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-10-11 12:55:59,819 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:55:59] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:00,025 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:00] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:00,065 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:00] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:00,081 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkE1MUU3MkQyNzg4QUZFOTczNAA="}]}
2025-10-11 12:56:00,082 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 232 to 2347082345056
2025-10-11 12:56:00,082 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-11 12:56:00,254 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:00] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:00,294 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:00] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:01,172 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNFMDBENUNBQkRBRDYzQTlBNwA="}]}
2025-10-11 12:56:01,173 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 232 to 2348055614455
2025-10-11 12:56:01,174 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:01] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-10-11 12:56:02,110 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:02] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:02,163 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:02] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:02,575 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:02] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:02,601 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:02] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:37,285 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-94A062C0
2025-10-11 12:56:37,842 - services.payment_service - INFO - Payment verified successfully for reference PAY-ORD-94A062C0. Status: success
2025-10-11 12:56:37,843 - handlers.payment_handler - INFO - Payment verified for order 232 on attempt 3
2025-10-11 12:56:37,843 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-94A062C0
2025-10-11 12:56:38,359 - services.payment_service - INFO - Payment verified successfully for reference PAY-ORD-94A062C0. Status: success
2025-10-11 12:56:41,904 - utils.data_manager - INFO - Updated order 232 to status confirmed
2025-10-11 12:56:43,478 - utils.data_manager - INFO - Retrieved 1 items for order 232
2025-10-11 12:56:45,260 - utils.data_manager - ERROR - Insufficient inventory for product_id 1 in order 232: available 0, requested 1
2025-10-11 12:56:45,455 - handlers.payment_handler - ERROR - Failed to reduce inventory for order 232
2025-10-11 12:56:45,456 - services.whatsapp_service - DEBUG - Created text message payload for 2349030918492
2025-10-11 12:56:46,229 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-10-11 12:56:46,229 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-10-11 12:56:46,971 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjNDRjEwNUExRTk0MjgzOEVFNgA="}]}
2025-10-11 12:56:46,972 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-10-11 12:56:47,950 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBMjBFMjEzMENDNzRBNzU2OAA="}]}
2025-10-11 12:56:47,952 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-11 12:56:48,084 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:48] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:49,053 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:49] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:49,377 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:49] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:49,459 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-11 12:56:49,544 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:56:49] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:56:49,644 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 232
2025-10-11 12:56:51,187 - utils.data_manager - WARNING - Low inventory for product id 1: 0 units remaining
2025-10-11 12:56:51,377 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 1: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 244, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-10-11 12:56:52,922 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-10-11 12:56:54,279 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-10-01 11:34:07.628376+00:00, last_interaction=2025-10-11 11:56:53.112388+00:00, interaction_count=113, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=500.0, conversion_stage=order_completed, final_order_value=1050.0, converted_at=2025-10-11 11:56:53.112388+00:00
2025-10-11 12:56:54,850 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-10-11 12:56:54,855 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID 232
2025-10-11 12:57:02,635 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:57:02] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:57:02,752 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:57:02] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:57:02,754 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:57:02] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:57:02,898 - werkzeug - INFO - 127.0.0.1 - - [11/Oct/2025 12:57:02] "POST /webhook HTTP/1.1" 200 -
2025-10-11 12:57:57,771 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-10-11 12:57:59,844 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-10-11 13:00:18,496 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-10-11 13:00:18,497 - handlers.product_sync_handler - INFO - Product sync thread stopped.
