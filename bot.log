2025-08-31 22:26:02,751 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-31 22:26:05,970 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:26:08,767 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:26:09,007 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:26:11,108 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:26:11,339 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:26:11,340 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:26:13,171 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-31 22:26:13,404 - app - INFO - Initial product sync successful on startup
2025-08-31 22:26:13,404 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:26:13,405 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-31 22:26:13,405 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:26:13,405 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:26:13,405 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:26:13,406 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:26:15,516 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:26:15,773 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:26:18,266 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:26:18,500 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:26:18,500 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:26:18,501 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-31 22:26:18,501 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-31 22:26:18,501 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:26:18,502 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-08-31 22:26:18,512 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-08-31 22:26:18,513 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-31 22:26:18,513 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:26:18,514 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:26:18,515 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:26:19,991 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-31 22:26:19,991 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-31 22:26:19,992 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-31 22:26:19,992 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-31 22:26:19,993 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:26:19,993 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:26:20,055 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-31 22:26:20,055 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-31 22:26:56,101 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-31 22:26:56,101 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-31 22:26:58,078 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:26:59,759 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:26:58.308513+00:00, interaction_count=94, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=order_completed, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:27:00,477 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:27:00,478 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-31 22:27:03,977 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-08-31 22:27:04,221 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-31 22:27:04,222 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:27:04,222 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-31 22:27:04,222 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-31 22:27:04,223 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/img.jpg', 'caption': "Perfect! Got it. Here's how Lola works: You can browse products, place orders, and pay - all right here in this chat."}}
2025-08-31 22:27:07,348 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRCMTNEOUY1NUM0NTkwQTREOQA="}]}
2025-08-31 22:27:07,349 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:27:08,459 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA0REVCRjhDMTg4Mjk1QUQyQgA="}]}
2025-08-31 22:27:08,460 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA0REVCRjhDMTg4Mjk1QUQyQgA='}]}
2025-08-31 22:27:08,461 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:27:08] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:27:09,755 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:27:09] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:27:09,885 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:27:09] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:27:09,928 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:27:09] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:27:10,087 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:27:10] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:27:10,442 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:27:10] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:27:10,444 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:27:10] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:29:45,348 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-31 22:29:47,676 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:29:49,247 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:29:47.883300+00:00, interaction_count=95, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=order_completed, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:29:49,937 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:29:49,937 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:29:49,938 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-31 22:29:49,938 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-08-31 22:29:49,938 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-31 22:29:49,939 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-31 22:29:49,939 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-31 22:29:49,939 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-31 22:29:51,074 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJFQTEzODdBNzQ2Q0VBRkE2QwA="}]}
2025-08-31 22:29:51,076 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-31 22:29:51,077 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-31 22:29:52,828 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:29:52] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:29:52,897 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCNDBCRUE5OUZCRDc2M0M2OQA="}]}
2025-08-31 22:29:52,899 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCNDBCRUE5OUZCRDc2M0M2OQA='}]}
2025-08-31 22:29:52,900 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:29:52] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:29:53,317 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:29:53] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:29:53,368 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:29:53] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:29:53,834 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:29:53] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:29:54,330 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:29:54] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:29:54,480 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:29:54] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:29:54,481 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:29:54] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:29:54,499 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:29:54] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:03,598 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Frice rice'}
2025-08-31 22:30:05,471 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:30:07,007 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:30:05.696674+00:00, interaction_count=96, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=order_completed, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:30:07,667 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:30:07,668 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:30:07,668 - handlers.base_handler - INFO - AIHandler: Handling message 'frice rice' in AI bulk order state for session 2348055614455. Original: 'Frice rice'
2025-08-31 22:30:10,808 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-31 22:30:10,825 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:30:12,538 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwRkVDREVBNDFBMjc2RTgxMgA="}]}
2025-08-31 22:30:12,539 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwRkVDREVBNDFBMjc2RTgxMgA='}]}
2025-08-31 22:30:12,540 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:12] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:13,579 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:13] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:13,840 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:13] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:13,869 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:13] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:16,379 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-31 22:30:18,186 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:30:19,807 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:30:18.407354+00:00, interaction_count=97, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=order_completed, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:30:20,486 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:30:20,487 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:30:20,487 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-31 22:30:20,487 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-31 22:30:20,487 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:30:20,488 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-31 22:30:20,488 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-31 22:30:20,497 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:30:21,580 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNGNTRERTI0NjMxMzY1NUY3OAA="}]}
2025-08-31 22:30:22,558 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:22] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:22,919 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:22] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:22,953 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:22] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:23,904 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:30:25,207 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-08-31 22:30:25,506 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:30:24.126775+00:00, interaction_count=98, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:30:26,197 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:30:26,219 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNGNTRERTI0NjMxMzY1NUY3OAA='}]}
2025-08-31 22:30:26,220 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:26] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:27,016 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:30:28,628 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:30:27.236453+00:00, interaction_count=99, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:30:29,336 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:30:29,337 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:30:29,338 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-08-31 22:30:29,338 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'order_handler', state 'prompt_add_note': name 'added_note' is not defined
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 264, in _route_to_handler
    response = self.order_handler.handle_prompt_add_note_state(state, message, session_id)
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\order_handler.py", line 469, in handle_prompt_add_note_state
    state["current_state"] = added_note
                             ^^^^^^^^^^
NameError: name 'added_note' is not defined
2025-08-31 22:30:29,343 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-31 22:30:30,388 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBQUMwQjI5RkRBQzdFOUFFNgA="}]}
2025-08-31 22:30:31,578 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:31] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:31,689 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:31] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:32,028 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:32] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:30:32,127 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:30:34,097 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:30:32.346837+00:00, interaction_count=100, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:30:34,796 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:30:34,802 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBQUMwQjI5RkRBQzdFOUFFNgA='}]}
2025-08-31 22:30:34,803 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:30:34] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:33:36,880 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-31 22:33:38,776 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:33:40,756 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:33:41,025 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:33:43,695 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:33:44,068 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:33:44,068 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:33:52,229 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-31 22:33:52,484 - app - INFO - Initial product sync successful on startup
2025-08-31 22:33:52,484 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:33:52,484 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-31 22:33:52,485 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:33:52,485 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:33:52,486 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:33:52,486 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:33:54,262 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:33:54,536 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:33:56,696 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:33:56,946 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:33:56,947 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:33:56,947 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-31 22:33:56,947 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-31 22:33:56,947 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:33:56,948 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-08-31 22:33:56,953 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-08-31 22:33:56,953 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-31 22:33:56,954 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:33:56,954 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:33:56,955 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:33:57,382 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-31 22:33:57,383 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-31 22:33:57,383 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-31 22:33:57,383 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-31 22:33:57,384 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:33:57,385 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:33:57,409 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-31 22:33:57,410 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-31 22:34:03,200 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-31 22:34:03,201 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-31 22:34:05,016 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:34:06,606 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:34:05.237987+00:00, interaction_count=101, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:34:07,295 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:34:07,296 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-31 22:34:09,086 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-08-31 22:34:09,307 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-31 22:34:09,307 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:34:09,308 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-31 22:34:09,308 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-31 22:34:10,537 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQxODA1MzFBMEIyMjI4RkU5MQA="}]}
2025-08-31 22:34:10,538 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:34:11,599 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIwM0E0MjRDODkwQTFEREJDOAA="}]}
2025-08-31 22:34:11,600 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIwM0E0MjRDODkwQTFEREJDOAA='}]}
2025-08-31 22:34:11,601 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:11] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:12,039 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:12] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:12,629 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:12] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:12,658 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:12] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:12,810 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:12] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:13,224 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:13] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:13,414 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:13] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:19,727 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-31 22:34:21,203 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-31 22:34:21,616 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:34:23,011 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:34:23,258 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:34:21.855943+00:00, interaction_count=102, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:34:23,883 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:34:23,884 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:34:23,885 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-31 22:34:23,885 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:34:23,886 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-31 22:34:23,886 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-31 22:34:24,534 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:34:23.236098+00:00, interaction_count=102, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:34:25,037 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc1NkY3RDkwNUZFREUzMEYwRAA="}]}
2025-08-31 22:34:25,038 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:34:25,135 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:34:25,135 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:34:25,136 - handlers.base_handler - INFO - GreetingHandler: Handling message 'jellof rice' in greeting state for session 2348055614455.
2025-08-31 22:34:25,136 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:34:25,137 - handlers.base_handler - WARNING - Session 2348055614455: Invalid option 'jellof rice' in greeting state for non-paid user.
2025-08-31 22:34:25,137 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:34:26,067 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkyQUFGMzE4MTJBMDhBQUFCRgA="}]}
2025-08-31 22:34:26,070 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkyQUFGMzE4MTJBMDhBQUFCRgA='}]}
2025-08-31 22:34:26,071 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:26] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:26,269 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRDM0M5NDZEMzYzQUExMjg1QgA="}]}
2025-08-31 22:34:26,270 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRDM0M5NDZEMzYzQUExMjg1QgA='}]}
2025-08-31 22:34:26,271 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:26] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:26,365 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:26] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:26,564 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:26] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:26,787 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:26] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:27,116 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:27] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:28,018 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:28,021 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:28,117 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:28,178 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:28,736 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:28,877 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:35,876 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-31 22:34:37,636 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:34:39,185 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:34:37.856216+00:00, interaction_count=103, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:34:39,855 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:34:39,856 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:34:39,856 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-31 22:34:39,856 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-08-31 22:34:39,857 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-31 22:34:39,857 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-31 22:34:39,857 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-31 22:34:39,858 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-31 22:34:41,006 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ5MjlGOEIzQTc4Q0U0QzQ2NAA="}]}
2025-08-31 22:34:41,007 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-31 22:34:41,007 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-31 22:34:41,976 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDQ0JDNTNCRjBBQzAyNkQzNQA="}]}
2025-08-31 22:34:41,977 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDQ0JDNTNCRjBBQzAyNkQzNQA='}]}
2025-08-31 22:34:41,978 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:41] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:42,312 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:42] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:43,022 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:43] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:43,179 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:43] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:43,180 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:43] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:43,668 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:43] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:43,899 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:43] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:51,065 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-08-31 22:34:52,756 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:34:54,365 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:34:52.965550+00:00, interaction_count=104, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:34:55,045 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:34:55,046 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:34:55,047 - handlers.base_handler - INFO - AIHandler: Handling message 'fried rice' in AI bulk order state for session 2348055614455. Original: 'Fried rice'
2025-08-31 22:34:57,421 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-31 22:34:57,429 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:34:58,487 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQxNjkyM0VDMTkyNDQxQUNBQQA="}]}
2025-08-31 22:34:58,488 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQxNjkyM0VDMTkyNDQxQUNBQQA='}]}
2025-08-31 22:34:58,488 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:58] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:59,484 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:59] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:34:59,868 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:34:59] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:35:00,268 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:35:00] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:35:02,008 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-31 22:35:03,796 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:35:05,335 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:35:04.016339+00:00, interaction_count=105, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:35:05,985 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:35:05,986 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:35:05,986 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-31 22:35:05,986 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-31 22:35:05,987 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:35:05,987 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-31 22:35:05,988 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-31 22:35:05,995 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:35:07,016 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2MTgyNDFBRjhCMzVBNkFFNAA="}]}
2025-08-31 22:35:08,096 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:35:08] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:35:08,498 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:35:08] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:35:08,726 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:35:08,746 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:35:08] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:35:09,728 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-08-31 22:35:10,266 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:35:08.946522+00:00, interaction_count=106, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:35:10,926 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:35:10,933 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2MTgyNDFBRjhCMzVBNkFFNAA='}]}
2025-08-31 22:35:10,933 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:35:10] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:35:11,466 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:35:13,006 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:35:11.696127+00:00, interaction_count=107, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:35:13,705 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:35:13,706 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:35:13,707 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-08-31 22:35:13,708 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'order_handler', state 'prompt_add_note': name 'add_note' is not defined
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 264, in _route_to_handler
    response = self.order_handler.handle_prompt_add_note_state(state, message, session_id)
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\order_handler.py", line 469, in handle_prompt_add_note_state
    state["current_state"] = add_note
                             ^^^^^^^^
NameError: name 'add_note' is not defined
2025-08-31 22:35:13,710 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-31 22:35:15,726 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2NzkzQTEyNzlFOEVDRDhFMQA="}]}
2025-08-31 22:35:17,007 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:35:17] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:35:17,147 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:35:17] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:35:17,441 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:35:17] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:35:18,127 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:35:19,652 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:35:18.348216+00:00, interaction_count=108, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:35:20,261 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:35:20,271 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2NzkzQTEyNzlFOEVDRDhFMQA='}]}
2025-08-31 22:35:20,273 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:35:20] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:38:23,625 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-31 22:38:24,834 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:38:26,585 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:38:26,834 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:38:29,177 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:38:29,415 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:38:29,416 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:38:29,416 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-08-31 22:38:29,417 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:38:29,417 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-08-31 22:38:29,418 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-31 22:38:29,419 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:38:29,419 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:38:29,419 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:38:29,420 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:38:31,246 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:38:31,347 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-31 22:38:31,464 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:38:33,566 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:38:33,807 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:38:33,808 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:38:33,808 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-31 22:38:33,809 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-31 22:38:33,809 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:38:33,809 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-08-31 22:38:33,810 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-08-31 22:38:33,810 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-31 22:38:33,810 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:38:33,811 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:38:33,811 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:38:34,183 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-31 22:38:34,184 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-31 22:38:34,184 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-31 22:38:34,184 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-31 22:38:34,185 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:38:34,185 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:38:34,204 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-31 22:38:34,205 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-31 22:38:35,906 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-31 22:38:35,906 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-31 22:38:37,745 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:38:39,335 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:38:37.975511+00:00, interaction_count=109, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:38:40,004 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:38:40,005 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-31 22:38:41,914 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-08-31 22:38:42,126 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-31 22:38:42,126 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:38:42,127 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-31 22:38:42,127 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-31 22:38:43,315 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA2QjMyNTJBMjg4MTI1RTUyQgA="}]}
2025-08-31 22:38:43,316 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:38:44,385 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyMjUwMTc1OEFGMzI3QTUzRQA="}]}
2025-08-31 22:38:44,386 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyMjUwMTc1OEFGMzI3QTUzRQA='}]}
2025-08-31 22:38:44,387 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:38:44] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:38:44,997 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:38:44] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:38:45,678 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:38:45] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:38:45,817 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:38:45] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:38:46,086 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:38:46] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:38:46,218 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:38:46] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:38:46,528 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:38:46] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:20,395 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-31 22:39:22,075 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:39:23,632 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:39:22.285541+00:00, interaction_count=110, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:39:24,294 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:39:24,295 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:39:24,295 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-31 22:39:24,295 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-08-31 22:39:24,296 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-31 22:39:24,296 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-31 22:39:24,296 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-31 22:39:24,297 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-31 22:39:25,385 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQxNjVDNkUwNjlBQTJBMzBEOAA="}]}
2025-08-31 22:39:25,386 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-31 22:39:25,386 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-31 22:39:26,395 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVBQUJEOTg3MzYxQjIxODhGRAA="}]}
2025-08-31 22:39:26,396 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVBQUJEOTg3MzYxQjIxODhGRAA='}]}
2025-08-31 22:39:26,397 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:26] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:27,034 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:27] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:27,465 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:27] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:27,477 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:27] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:27,697 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:27] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:28,307 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:28,436 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:38,196 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-31 22:39:40,045 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:39:41,524 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:39:40.264747+00:00, interaction_count=111, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:39:42,154 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:39:42,155 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:39:42,155 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-31 22:39:44,336 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-31 22:39:44,346 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:39:45,355 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFERENFRjE0QTA5NjM5QTNCMAA="}]}
2025-08-31 22:39:45,355 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFERENFRjE0QTA5NjM5QTNCMAA='}]}
2025-08-31 22:39:45,357 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:45] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:46,381 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:46] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:46,770 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:46] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:47,137 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:47] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:50,684 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-31 22:39:52,404 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:39:54,014 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:39:52.624705+00:00, interaction_count=112, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:39:54,724 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:39:54,725 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:39:54,725 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-08-31 22:39:54,725 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-31 22:39:54,725 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:39:54,726 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-31 22:39:54,726 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-31 22:39:54,733 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:39:55,795 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkzNzE3RDEyNkRBREY4NjIwRgA="}]}
2025-08-31 22:39:56,755 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:56] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:57,065 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:57] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:57,544 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:39:57,726 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:57] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:39:59,044 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:39:57.766214+00:00, interaction_count=113, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:39:59,654 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:39:59,661 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkzNzE3RDEyNkRBREY4NjIwRgA='}]}
2025-08-31 22:39:59,662 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:39:59] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:40:00,123 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-08-31 22:40:01,995 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:40:03,505 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:40:02.226761+00:00, interaction_count=114, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:40:04,145 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:40:04,146 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:40:04,146 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-08-31 22:40:04,147 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-31 22:40:04,147 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please type your note for the order (e.g., 'Please deliver after 5 PM'). Type 'back' to skip adding a note."}}
2025-08-31 22:40:05,166 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY4MzRGMkI3MDVGMjVGNkNFOAA="}]}
2025-08-31 22:40:06,136 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:40:06] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:40:06,437 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:40:06] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:40:06,927 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:40:06] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:40:06,975 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:40:08,524 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:40:07.205080+00:00, interaction_count=115, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:40:09,155 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:40:09,162 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY4MzRGMkI3MDVGMjVGNkNFOAA='}]}
2025-08-31 22:40:09,162 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:40:09] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:40:57,573 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Make sure the rice to send the rice'}
2025-08-31 22:40:59,355 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:41:00,875 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:40:59.584699+00:00, interaction_count=116, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:41:01,554 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:41:01,555 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:41:01,555 - handlers.order_handler - INFO - Note 'make sure the rice to send the rice' added for session 2348055614455.
2025-08-31 22:41:01,556 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:41:01,568 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:41:02,594 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc4Mjg5MDlBQTFCNUNEMDczOQA="}]}
2025-08-31 22:41:03,683 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:41:03] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:41:04,031 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:41:04] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:41:04,375 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:41:04,637 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:41:04] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:41:05,884 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:41:04.594448+00:00, interaction_count=117, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:41:06,544 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:41:06,550 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc4Mjg5MDlBQTFCNUNEMDczOQA='}]}
2025-08-31 22:41:06,551 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:41:06] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:41:07,147 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-31 22:41:09,005 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:41:10,485 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:41:09.224505+00:00, interaction_count=118, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-30 20:21:19.482754+00:00
2025-08-31 22:41:11,104 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:41:11,105 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-31 22:41:11,106 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:41:12,894 - utils.data_manager - DEBUG - Found product_id 112 for product_name Jollof Rice
2025-08-31 22:41:14,844 - utils.data_manager - INFO - Saved order 205 for customer 2348055614455
2025-08-31 22:41:15,054 - utils.data_manager - INFO - Saved order item Jollof Rice for order 205
2025-08-31 22:41:15,254 - handlers.order_handler - INFO - Order 205 saved to database for session 2348055614455
2025-08-31 22:41:17,139 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-31 22:41:18,905 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:41:20,385 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:41:19.145489+00:00, interaction_count=119, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=order_completed, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-08-31 22:41:20,994 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:41:21,001 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-31 22:41:21,001 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-31 22:41:21,001 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-31 22:41:24,745 - utils.data_manager - INFO - Updated order 205 to status pending_payment
2025-08-31 22:41:24,746 - services.payment_service - INFO - Adding subaccount split: code=ACCT_iwv6csej0ra4k7g, percentage=1%
2025-08-31 22:41:24,746 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-205 with amount: 66500, email: ziga4455@lola.com
2025-08-31 22:41:25,410 - services.payment_service - ERROR - HTTP error creating Paystack payment link for PAY-205: 404 Client Error: Not Found for url: https://api.paystack.co/transaction/initialize. Response: {"status":false,"message":"Invalid Subaccount.","meta":{"nextStep":"Ensure that the value(s) you're passing are valid."},"type":"validation_error","code":"invalid_params"}
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\services\payment_service.py", line 87, in create_payment_link
    response.raise_for_status()  # Raise HTTPError for bad responses (4xx or 5xx)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\models.py", line 1024, in raise_for_status
    raise HTTPError(http_error_msg, response=self)
requests.exceptions.HTTPError: 404 Client Error: Not Found for url: https://api.paystack.co/transaction/initialize
2025-08-31 22:41:25,415 - handlers.payment_handler - ERROR - Failed to generate payment link for order 205
2025-08-31 22:41:25,415 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-31 22:41:27,475 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg1QTg5MTNFRkJBMTFDNUVCRAA="}]}
2025-08-31 22:41:28,471 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:41:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:41:28,827 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:41:28] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:41:29,215 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:41:29,276 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:41:29] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:41:30,785 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:41:29.434580+00:00, interaction_count=120, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-08-31 22:41:31,464 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:41:31,471 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg1QTg5MTNFRkJBMTFDNUVCRAA='}]}
2025-08-31 22:41:31,471 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:41:31] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:41:52,167 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-08-31 22:41:52,167 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-08-31 22:57:43,433 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-31 22:57:45,252 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:57:47,102 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:57:47,305 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:57:49,052 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:57:49,244 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:57:49,244 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:57:49,245 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-08-31 22:57:49,246 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:57:49,246 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-08-31 22:57:49,246 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-31 22:57:49,247 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:57:49,247 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:57:49,248 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:57:49,248 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:57:50,812 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:57:50,834 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-31 22:57:51,019 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:57:52,949 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:57:53,154 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:57:53,155 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:57:53,156 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-31 22:57:53,156 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-31 22:57:53,157 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:57:53,157 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-08-31 22:57:53,159 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-08-31 22:57:53,159 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-31 22:57:53,160 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:57:53,160 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:57:53,162 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:57:54,172 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-31 22:57:54,172 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-31 22:57:54,173 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-31 22:57:54,173 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-31 22:57:54,174 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:57:54,174 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:57:54,196 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-31 22:57:54,196 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-31 22:58:11,241 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hi'}
2025-08-31 22:58:11,242 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-31 22:58:12,811 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:58:14,242 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:58:13.001980+00:00, interaction_count=121, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-08-31 22:58:14,871 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:58:14,872 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-31 22:58:16,492 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-08-31 22:58:16,693 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 188, in _route_to_handler
    response = self.greeting_handler.generate_initial_greeting(state, session_id, user_name)
TypeError: GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
2025-08-31 22:58:16,707 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-31 22:58:17,992 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3QjgyM0I3MEVDREUxOTdFNAA="}]}
2025-08-31 22:58:17,993 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3QjgyM0I3MEVDREUxOTdFNAA='}]}
2025-08-31 22:58:17,994 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:58:17] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:58:19,093 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:58:19] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:58:19,294 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:58:19] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:58:19,554 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:58:19] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:58:48,944 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-08-31 22:58:48,946 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-08-31 22:58:51,207 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-31 22:58:52,508 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:58:54,113 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:58:54,313 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:58:56,062 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:58:56,251 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:58:56,252 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:58:56,252 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-08-31 22:58:56,253 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-08-31 22:58:56,254 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:58:56,254 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-31 22:58:56,255 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:58:56,255 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:58:56,255 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:58:56,256 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-31 22:58:57,793 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-31 22:58:57,871 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-31 22:58:58,073 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-31 22:58:59,902 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-08-31 22:59:00,102 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-31 22:59:00,102 - services.payment_service - INFO - PaymentService initialized
2025-08-31 22:59:00,102 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-31 22:59:00,103 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-31 22:59:00,103 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-31 22:59:00,103 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-08-31 22:59:00,104 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-08-31 22:59:00,104 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-31 22:59:00,105 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-31 22:59:00,105 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:59:00,106 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:59:00,518 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-31 22:59:00,519 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-31 22:59:00,519 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-31 22:59:00,519 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-31 22:59:00,520 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-31 22:59:00,520 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-08-31 22:59:00,534 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-31 22:59:00,534 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-31 22:59:02,394 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-31 22:59:02,394 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-31 22:59:03,971 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-31 22:59:05,352 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-31 21:59:04.161639+00:00, interaction_count=122, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-08-31 22:59:05,961 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-31 22:59:05,961 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-31 22:59:07,561 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-08-31 22:59:07,761 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-31 22:59:07,761 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-31 22:59:07,762 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-31 22:59:07,762 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-31 22:59:08,862 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjExRjcyNDBEQjE2MEE0MTgyMgA="}]}
2025-08-31 22:59:08,863 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-31 22:59:09,872 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU5NjcxMzJENEM0QjRFMEQwOQA="}]}
2025-08-31 22:59:09,873 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU5NjcxMzJENEM0QjRFMEQwOQA='}]}
2025-08-31 22:59:09,874 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:59:09] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:59:10,578 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:59:10] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:59:11,534 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:59:11] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:59:11,664 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:59:11] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:59:11,667 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:59:11] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:59:11,843 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:59:11] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:59:11,954 - werkzeug - INFO - 127.0.0.1 - - [31/Aug/2025 22:59:11] "POST /webhook HTTP/1.1" 200 -
2025-08-31 22:59:13,972 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-08-31 22:59:13,972 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 09:21:58,779 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 09:22:03,678 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:22:05,613 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:22:05,820 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:22:07,624 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:22:07,872 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:22:07,873 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:22:07,873 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 09:22:07,876 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:22:07,877 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:22:07,878 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 09:22:07,879 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:22:07,879 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:22:07,880 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:22:07,881 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:22:09,463 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:22:09,479 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:22:09,772 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:22:11,556 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:22:11,759 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:22:11,760 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:22:11,761 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 09:22:11,762 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 09:22:11,762 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:22:11,763 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 09:22:11,814 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 09:22:11,815 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 09:22:11,815 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:22:11,816 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:22:11,817 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:22:12,751 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 09:22:12,752 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 09:22:12,752 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 09:22:12,753 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 09:22:12,754 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:22:12,755 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:22:12,812 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 09:22:12,812 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 09:26:39,115 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 09:26:39,119 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 09:26:51,276 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 09:26:53,942 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:26:55,613 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:26:55,818 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:26:57,606 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:26:57,804 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:26:57,806 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:26:57,808 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 09:26:57,813 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:26:57,812 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:26:57,815 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 09:26:57,817 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:26:57,819 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:26:57,820 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:26:57,822 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:26:59,392 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:26:59,398 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:26:59,591 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:27:01,556 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:27:01,755 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:27:01,756 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:27:01,757 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 09:27:01,757 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 09:27:01,758 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:27:01,758 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 09:27:01,760 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 09:27:01,760 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 09:27:01,761 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:27:01,762 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:27:01,763 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:27:02,409 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 09:27:02,410 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 09:27:02,410 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 09:27:02,411 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 09:27:02,412 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:27:02,412 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:27:02,484 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 09:27:02,484 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 09:28:49,754 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 09:28:49,755 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 09:28:51,601 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:28:53,100 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 08:28:51.791579+00:00, interaction_count=138, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 09:28:53,782 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-09-02 09:28:53,783 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-09-02 09:28:55,441 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 09:28:55,631 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 09:28:55,632 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 09:28:55,632 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 09:28:55,633 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 09:28:57,443 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEzM0M2RkQyNzlBOUMxNDE2NAA="}]}
2025-09-02 09:28:57,494 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 09:28:59,012 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg5MjI1NzM5NDRBQTRFQkRBRQA="}]}
2025-09-02 09:28:59,013 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg5MjI1NzM5NDRBQTRFQkRBRQA='}]}
2025-09-02 09:28:59,016 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:28:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:28:59,663 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:28:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:00,115 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:00,136 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:00,249 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:00,755 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:00,776 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:02,126 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 09:29:03,921 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:29:05,308 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 08:29:04.126399+00:00, interaction_count=139, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 09:29:05,968 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-09-02 09:29:05,969 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 09:29:05,970 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 09:29:05,970 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 09:29:05,971 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 09:29:05,972 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 09:29:05,972 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 09:29:05,973 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 09:29:07,096 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE1NUM2OTZFQ0M5NDdBOEQ4RQA="}]}
2025-09-02 09:29:07,097 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 09:29:07,097 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 09:29:08,041 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUwRTU1QjdDMkE0NUQ4Qzk1NQA="}]}
2025-09-02 09:29:08,043 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUwRTU1QjdDMkE0NUQ4Qzk1NQA='}]}
2025-09-02 09:29:08,044 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:09,045 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:09,765 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:09,868 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:09,997 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:10,254 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:10,609 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:14,101 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-02 09:29:15,934 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:29:17,598 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 08:29:16.136149+00:00, interaction_count=140, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 09:29:18,215 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-09-02 09:29:18,216 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 09:29:18,217 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-02 09:29:21,612 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 09:29:21,635 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 09:29:22,571 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMxNDk3N0Y2QkYzODY2MEY5NQA="}]}
2025-09-02 09:29:22,572 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMxNDk3N0Y2QkYzODY2MEY5NQA='}]}
2025-09-02 09:29:22,573 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:22] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:23,675 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:23] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:24,194 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:24] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:39,127 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:40,155 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 09:29:41,801 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:29:43,151 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 08:29:41.983573+00:00, interaction_count=141, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 09:29:43,831 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-09-02 09:29:43,832 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 09:29:43,833 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 09:29:43,834 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 09:29:43,834 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 09:29:43,835 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 09:29:43,836 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 09:29:43,898 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 09:29:44,882 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyNDAxNUQ2N0Q3NUVDRjQ0MAA="}]}
2025-09-02 09:29:45,944 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:45] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:46,252 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:46] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:29:46,511 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:29:47,964 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 08:29:46.724967+00:00, interaction_count=142, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 09:29:48,567 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-09-02 09:29:48,633 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyNDAxNUQ2N0Q3NUVDRjQ0MAA='}]}
2025-09-02 09:29:48,634 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:29:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:03,583 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'Hi'}
2025-09-02 09:30:03,584 - utils.session_manager - INFO - New session 2347082345056 initialized.
2025-09-02 09:30:05,256 - utils.data_manager - DEBUG - No lead found for phone number 2347082345056 in whatsapp_leads
2025-09-02 09:30:06,681 - utils.data_manager - DEBUG - Saving lead 2347082345056: merchant_details_id=20, user_id=2347082345056, user_name=Olumayowa Oyaleke, phone_number=2347082345056, source=whatsapp, first_contact=2025-09-02 08:30:05.464112+00:00, last_interaction=2025-09-02 08:30:05.464150+00:00, interaction_count=2, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-09-02 09:30:07,326 - utils.data_manager - ERROR - Database error while saving lead 2347082345056 to whatsapp_leads: duplicate key value violates unique constraint "whatsapp_leads_phone_number_key"
DETAIL:  Key (phone_number)=(2347082345056) already exists.
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 823, in save_lead
    cur.execute(query, (
    ~~~~~~~~~~~^^^^^^^^^
        lead.merchant_details_id,
        ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<13 lines>...
        converted_at
        ^^^^^^^^^^^^
    ))
    ^^
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "whatsapp_leads_phone_number_key"
DETAIL:  Key (phone_number)=(2347082345056) already exists.

2025-09-02 09:30:07,330 - services.lead_tracker - ERROR - Error tracking user interaction for 2347082345056: duplicate key value violates unique constraint "whatsapp_leads_phone_number_key"
DETAIL:  Key (phone_number)=(2347082345056) already exists.
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\services\lead_tracker.py", line 66, in track_user_interaction
    self.data_manager.save_lead(lead)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 823, in save_lead
    cur.execute(query, (
    ~~~~~~~~~~~^^^^^^^^^
        lead.merchant_details_id,
        ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<13 lines>...
        converted_at
        ^^^^^^^^^^^^
    ))
    ^^
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "whatsapp_leads_phone_number_key"
DETAIL:  Key (phone_number)=(2347082345056) already exists.

2025-09-02 09:30:09,047 - utils.data_manager - DEBUG - Found address '873 Ozumba Mbadiwe Ave, Lagos, 106104, Lagos, NG' for phone number 2347082345056 in whatsapp_orders
2025-09-02 09:30:09,241 - handlers.message_processor - ERROR - Session 2347082345056: Error in message routing for handler 'greeting_handler', state 'start': GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 188, in _route_to_handler
    response = self.greeting_handler.generate_initial_greeting(state, session_id, user_name)
TypeError: GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
2025-09-02 09:30:09,242 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-09-02 09:30:11,200 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkMzQkQ0QUY5ODY2MDk0Q0ZBRQA="}]}
2025-09-02 09:30:11,203 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkMzQkQ0QUY5ODY2MDk0Q0ZBRQA='}]}
2025-09-02 09:30:11,206 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:12,554 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:12] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:12,732 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:12] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:12,996 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:12] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:18,121 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:18] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:19,652 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 09:30:21,231 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:30:22,570 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 08:30:21.422675+00:00, interaction_count=143, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 09:30:23,178 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-09-02 09:30:23,180 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 09:30:23,180 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 09:30:23,181 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 09:30:23,204 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 09:30:24,203 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEMEM5QjQwOTVBNUQ0MEE3MQA="}]}
2025-09-02 09:30:25,183 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:25] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:25,579 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:25] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:25,697 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:25] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:25,752 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:30:27,161 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 08:30:25.942166+00:00, interaction_count=144, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 09:30:27,790 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-09-02 09:30:27,802 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEMEM5QjQwOTVBNUQ0MEE3MQA='}]}
2025-09-02 09:30:27,803 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:27] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:32,290 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 09:30:33,921 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:30:35,368 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 08:30:34.121012+00:00, interaction_count=145, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 09:30:35,941 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-09-02 09:30:35,943 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 09:30:35,944 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 09:30:35,945 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 09:30:35,947 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 09:30:36,014 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 09:30:36,015 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Error: Invalid button configuration. Please try again or contact support.'}}
2025-09-02 09:30:36,962 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5MDFCOUY1Q0UyRjg2ODExQQA="}]}
2025-09-02 09:30:38,074 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:38,477 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:38,584 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:30:38,691 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:30:40,241 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 08:30:38.907389+00:00, interaction_count=146, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 09:30:40,810 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-09-02 09:30:40,822 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5MDFCOUY1Q0UyRjg2ODExQQA='}]}
2025-09-02 09:30:40,823 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:30:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:31:59,601 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:32:01,360 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:35:53,253 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 09:35:53,255 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 09:35:56,139 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 09:35:59,708 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:36:01,500 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:36:01,702 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:36:03,563 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:36:03,774 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:36:03,777 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:36:03,778 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 09:36:03,783 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:36:03,784 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:36:03,786 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 09:36:03,788 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:36:03,791 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:36:03,793 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:36:03,795 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:36:05,383 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:36:05,390 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:36:05,590 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:36:07,562 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:36:07,783 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:36:07,786 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:36:07,796 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 09:36:07,801 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 09:36:07,804 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:36:07,809 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 09:36:07,847 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 09:36:07,848 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 09:36:07,850 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:36:07,851 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:36:07,853 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:36:09,426 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 09:36:09,427 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 09:36:09,428 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 09:36:09,430 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 09:36:09,431 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:36:09,432 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:36:09,582 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 09:36:09,583 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 09:37:03,733 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 09:37:03,738 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 09:37:12,707 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 09:37:15,843 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:37:17,451 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:37:17,649 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:37:19,583 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:37:19,771 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:37:19,773 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:37:19,775 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 09:37:19,779 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:37:19,779 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:37:19,781 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 09:37:19,784 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:37:19,786 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:37:19,788 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:37:19,789 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:37:21,384 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:37:21,409 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:37:21,588 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:37:23,422 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:37:23,612 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:37:23,613 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:37:23,614 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 09:37:23,615 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 09:37:23,616 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:37:23,617 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 09:37:23,619 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 09:37:23,619 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 09:37:23,620 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:37:23,622 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:37:23,624 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:37:24,678 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 09:37:24,715 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 09:37:24,716 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 09:37:24,717 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 09:37:24,718 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:37:24,718 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:37:24,749 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 09:37:24,749 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 09:37:25,173 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 09:37:25,175 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 09:37:26,777 - utils.data_manager - INFO - Retrieved lead with phone number 2348055614455 from whatsapp_leads
2025-09-02 09:37:26,969 - services.lead_tracker - ERROR - Error tracking user interaction for 2348055614455: 'DataManager' object has no attribute 'save_lead'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\services\lead_tracker.py", line 66, in track_user_interaction
    self.data_manager.save_lead(lead)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'save_lead'
2025-09-02 09:37:26,977 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 09:37:28,468 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 09:37:28,648 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 09:37:28,649 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 09:37:28,651 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 09:37:28,652 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 09:37:29,862 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMzNzUwQkZGNjg0NUYzMDUxRAA="}]}
2025-09-02 09:37:29,865 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 09:37:30,892 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk3MTNCNTdDQTNGNEUxOEYxNgA="}]}
2025-09-02 09:37:30,896 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk3MTNCNTdDQTNGNEUxOEYxNgA='}]}
2025-09-02 09:37:30,900 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:37:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:37:31,186 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:37:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:37:31,903 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:37:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:37:32,042 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:37:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:37:32,309 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:37:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:37:32,599 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:37:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:37:32,606 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:37:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:38:41,925 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 09:38:41,934 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 09:38:52,429 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 09:38:55,878 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:38:58,019 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:38:58,209 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:39:00,481 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:39:00,670 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:39:00,671 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:39:00,672 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 09:39:00,674 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:39:00,675 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:39:00,676 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 09:39:00,677 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:39:00,677 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:39:00,678 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:39:00,679 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:39:02,446 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:39:03,462 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:39:03,660 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:39:05,451 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:39:05,637 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:39:05,638 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:39:05,639 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 09:39:05,639 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 09:39:05,640 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:39:05,640 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 09:39:05,642 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 09:39:05,642 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 09:39:05,643 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:39:05,644 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:39:05,645 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:39:06,790 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 09:39:06,791 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 09:39:06,793 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 09:39:06,794 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 09:39:06,795 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:39:06,797 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:39:06,862 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 09:39:06,863 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 09:39:08,124 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 09:39:08,125 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 09:39:09,690 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:39:11,462 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-09-02 09:39:11,678 - utils.data_manager - INFO - Lead with phone number 2348055614455 already exists. Skipping or updating as needed.
2025-09-02 09:39:11,680 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-09-02 09:39:11,681 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 09:39:13,299 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 09:39:13,491 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 09:39:13,493 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 09:39:13,510 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 09:39:13,512 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 09:39:14,611 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdFQjA2QkI5RjVBNjVFRjU4QwA="}]}
2025-09-02 09:39:14,613 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 09:39:15,520 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMwM0I1QjRFNTZCNUFENTg3RAA="}]}
2025-09-02 09:39:15,522 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMwM0I1QjRFNTZCNUFENTg3RAA='}]}
2025-09-02 09:39:15,525 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:39:15] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:39:16,459 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:39:16] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:39:17,093 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:39:17] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:39:17,241 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:39:17] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:39:17,438 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:39:17] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:39:17,847 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:39:17] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:39:57,145 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'Hi'}
2025-09-02 09:39:57,147 - utils.session_manager - INFO - New session 2347082345056 initialized.
2025-09-02 09:39:58,820 - utils.data_manager - DEBUG - No lead found for phone number 2347082345056 in whatsapp_leads
2025-09-02 09:40:00,580 - utils.data_manager - DEBUG - No lead found for phone number 2347082345056 in whatsapp_leads
2025-09-02 09:40:02,294 - utils.data_manager - DEBUG - Saving lead 2347082345056: merchant_details_id=20, user_id=2347082345056, user_name=Olumayowa Oyaleke, phone_number=2347082345056, source=whatsapp, first_contact=2025-09-02 08:39:59.010364+00:00, last_interaction=2025-09-02 08:39:59.010406+00:00, interaction_count=2, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-09-02 09:40:02,872 - utils.data_manager - ERROR - Duplicate phone number 2347082345056 detected: duplicate key value violates unique constraint "whatsapp_leads_phone_number_key"
DETAIL:  Key (phone_number)=(2347082345056) already exists.
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 843, in save_lead
    cur.execute(query, (
    ~~~~~~~~~~~^^^^^^^^^
        lead.merchant_details_id,
        ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<13 lines>...
        converted_at
        ^^^^^^^^^^^^
    ))
    ^^
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "whatsapp_leads_phone_number_key"
DETAIL:  Key (phone_number)=(2347082345056) already exists.

2025-09-02 09:40:02,897 - services.lead_tracker - INFO - Updated lead interaction: 2347082345056
2025-09-02 09:40:02,898 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2347082345056
2025-09-02 09:40:04,519 - utils.data_manager - DEBUG - Found address '873 Ozumba Mbadiwe Ave, Lagos, 106104, Lagos, NG' for phone number 2347082345056 in whatsapp_orders
2025-09-02 09:40:04,808 - handlers.message_processor - ERROR - Session 2347082345056: Error in message routing for handler 'greeting_handler', state 'start': GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 188, in _route_to_handler
    response = self.greeting_handler.generate_initial_greeting(state, session_id, user_name)
TypeError: GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
2025-09-02 09:40:04,810 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-09-02 09:40:05,892 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkRFQzM5NTgyODE0MENBNjEyNgA="}]}
2025-09-02 09:40:05,901 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkRFQzM5NTgyODE0MENBNjEyNgA='}]}
2025-09-02 09:40:05,905 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:40:05] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:40:07,238 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:40:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:40:08,023 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:40:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:40:08,072 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:40:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:42:24,173 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 09:42:24,175 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 09:42:27,160 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 09:42:30,891 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:42:33,129 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:42:33,318 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:42:35,222 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:42:35,421 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:42:35,423 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:42:35,425 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 09:42:35,430 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:42:35,432 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:42:35,435 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 09:42:35,437 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:42:35,439 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:42:35,441 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:42:35,443 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:42:37,011 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:42:37,051 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:42:37,249 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:42:39,005 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:42:39,203 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:42:39,205 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:42:39,206 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 09:42:39,206 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 09:42:39,207 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:42:39,208 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 09:42:39,211 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 09:42:39,212 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 09:42:39,216 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:42:39,218 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:42:39,220 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:42:40,719 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 09:42:40,720 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 09:42:40,721 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 09:42:40,721 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 09:42:40,722 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:42:40,723 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:42:40,822 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 09:42:40,822 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 09:47:37,202 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:47:39,544 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:47:51,182 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'Hi'}
2025-09-02 09:47:51,183 - utils.session_manager - INFO - New session 2347082345056 initialized.
2025-09-02 09:47:52,787 - utils.data_manager - DEBUG - No lead found for phone number 2347082345056 in whatsapp_leads
2025-09-02 09:47:54,598 - utils.data_manager - DEBUG - No lead found for phone number 2347082345056 in whatsapp_leads
2025-09-02 09:47:55,959 - utils.data_manager - DEBUG - Saving lead 2347082345056: merchant_details_id=20, user_id=2347082345056, user_name=Olumayowa Oyaleke, phone_number=2347082345056, source=whatsapp, first_contact=2025-09-02 08:47:52.968581+00:00, last_interaction=2025-09-02 08:47:52.968628+00:00, interaction_count=2, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-09-02 09:47:56,528 - utils.data_manager - ERROR - Duplicate phone number 2347082345056 detected: duplicate key value violates unique constraint "whatsapp_leads_phone_number_key"
DETAIL:  Key (phone_number)=(2347082345056) already exists.
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 843, in save_lead
    cur.execute(query, (
    ~~~~~~~~~~~^^^^^^^^^
        lead.merchant_details_id,
        ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<13 lines>...
        converted_at
        ^^^^^^^^^^^^
    ))
    ^^
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "whatsapp_leads_phone_number_key"
DETAIL:  Key (phone_number)=(2347082345056) already exists.

2025-09-02 09:47:56,584 - services.lead_tracker - INFO - Updated lead interaction: 2347082345056
2025-09-02 09:47:56,584 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2347082345056
2025-09-02 09:47:58,211 - utils.data_manager - DEBUG - Found address '873 Ozumba Mbadiwe Ave, Lagos, 106104, Lagos, NG' for phone number 2347082345056 in whatsapp_orders
2025-09-02 09:47:58,400 - handlers.message_processor - ERROR - Session 2347082345056: Error in message routing for handler 'greeting_handler', state 'start': GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 188, in _route_to_handler
    response = self.greeting_handler.generate_initial_greeting(state, session_id, user_name)
TypeError: GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
2025-09-02 09:47:58,454 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-09-02 09:47:59,562 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjk5OEQ4NjQ5MkRCREZGNUEyQQA="}]}
2025-09-02 09:47:59,565 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjk5OEQ4NjQ5MkRCREZGNUEyQQA='}]}
2025-09-02 09:47:59,570 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:47:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:48:00,628 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:48:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:48:01,851 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:48:01] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:48:01,972 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:48:01] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:50:28,302 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 09:50:28,305 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 09:50:37,593 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 09:50:41,802 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:50:43,704 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:50:43,907 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:50:45,839 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:50:46,031 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:50:46,034 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:50:46,036 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 09:50:46,045 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:50:46,047 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:50:46,049 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 09:50:46,052 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:50:46,055 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:50:46,058 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:50:46,060 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:50:47,713 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:50:47,722 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:50:47,908 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:50:49,838 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:50:50,042 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:50:50,044 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:50:50,046 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 09:50:50,047 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 09:50:50,048 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:50:50,049 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 09:50:50,053 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 09:50:50,055 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 09:50:50,056 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:50:50,058 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:50:50,060 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:50:51,417 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 09:50:51,417 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 09:50:51,418 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 09:50:51,419 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 09:50:51,420 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:50:51,421 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:50:51,455 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 09:50:51,456 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 09:51:46,717 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'Hi'}
2025-09-02 09:51:46,720 - utils.session_manager - INFO - New session 2347082345056 initialized.
2025-09-02 09:51:46,721 - services.lead_tracker - ERROR - DataManager method error for 2347082345056: 'DataManager' object has no attribute 'get_lead_by_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\services\lead_tracker.py", line 36, in track_user_interaction
    existing_lead = self.data_manager.get_lead_by_phone_number(phone_number)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'get_lead_by_phone_number'
2025-09-02 09:51:46,800 - handlers.lead_tracking_handler - ERROR - Error tracking user interaction for 2347082345056: 'DataManager' object has no attribute 'get_lead_by_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\lead_tracking_handler.py", line 34, in track_user_interaction
    self.lead_tracker.track_user_interaction(phone_number, user_name, is_new_session)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\services\lead_tracker.py", line 36, in track_user_interaction
    existing_lead = self.data_manager.get_lead_by_phone_number(phone_number)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'get_lead_by_phone_number'
2025-09-02 09:51:46,878 - handlers.message_processor - ERROR - Session 2347082345056: Error processing message: 'DataManager' object has no attribute 'get_lead_by_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 80, in process_message
    self.lead_tracking_handler.track_user_interaction(session_id, user_name, is_new_interaction)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\lead_tracking_handler.py", line 34, in track_user_interaction
    self.lead_tracker.track_user_interaction(phone_number, user_name, is_new_session)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\services\lead_tracker.py", line 36, in track_user_interaction
    existing_lead = self.data_manager.get_lead_by_phone_number(phone_number)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'get_lead_by_phone_number'
2025-09-02 09:51:46,893 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-09-02 09:51:48,182 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjNEMEU5MkM3OEEzODkzNzc3NAA="}]}
2025-09-02 09:51:48,186 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjNEMEU5MkM3OEEzODkzNzc3NAA='}]}
2025-09-02 09:51:48,190 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:51:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:51:49,319 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:51:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:51:50,861 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:51:50] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:51:51,126 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:51:51] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:55:47,917 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:55:49,660 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:57:23,971 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 09:57:23,974 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 09:57:26,625 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 09:57:30,410 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:57:32,066 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:57:32,256 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:57:33,948 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:57:34,137 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:57:34,138 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:57:34,139 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 09:57:34,142 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 09:57:34,142 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:57:34,143 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 09:57:34,144 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:57:34,145 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:57:34,146 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:57:34,147 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 09:57:35,759 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 09:57:35,761 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 09:57:35,956 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 09:57:37,779 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 09:57:37,968 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 09:57:37,969 - services.payment_service - INFO - PaymentService initialized
2025-09-02 09:57:37,970 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 09:57:37,971 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 09:57:37,972 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 09:57:37,973 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 09:57:37,975 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 09:57:37,976 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 09:57:37,977 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 09:57:37,978 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:57:37,979 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:57:39,402 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 09:57:39,403 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 09:57:39,404 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 09:57:39,405 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 09:57:39,406 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 09:57:39,407 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 09:57:39,458 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 09:57:39,459 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 09:58:19,314 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'Hi'}
2025-09-02 09:58:19,316 - utils.session_manager - INFO - New session 2347082345056 initialized.
2025-09-02 09:58:20,997 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 09:58:22,476 - utils.data_manager - DEBUG - Saving or updating lead 2347082345056: merchant_details_id=20, user_id=2347082345056, user_name=Olumayowa Oyaleke, phone_number=2347082345056, source=whatsapp, first_contact=2025-09-02 08:58:21.203669+00:00, last_interaction=2025-09-02 08:58:21.203669+00:00, interaction_count=1, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-09-02 09:58:23,176 - utils.data_manager - INFO - Lead 2347082345056 saved or updated in whatsapp_leads table
2025-09-02 09:58:23,291 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2347082345056
2025-09-02 09:58:24,999 - utils.data_manager - DEBUG - Found address '873 Ozumba Mbadiwe Ave, Lagos, 106104, Lagos, NG' for phone number 2347082345056 in whatsapp_orders
2025-09-02 09:58:25,197 - handlers.message_processor - ERROR - Session 2347082345056: Error in message routing for handler 'greeting_handler', state 'start': GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 188, in _route_to_handler
    response = self.greeting_handler.generate_initial_greeting(state, session_id, user_name)
TypeError: GreetingHandler.generate_initial_greeting() takes from 2 to 3 positional arguments but 4 were given
2025-09-02 09:58:25,200 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-09-02 09:58:26,341 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkJBNDYzMEZCRjA5OEQxMUVDRAA="}]}
2025-09-02 09:58:26,344 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkJBNDYzMEZCRjA5OEQxMUVDRAA='}]}
2025-09-02 09:58:26,346 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:58:26] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:58:27,702 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:58:27] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:58:28,793 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:58:28] "POST /webhook HTTP/1.1" 200 -
2025-09-02 09:58:29,170 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 09:58:29] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:01:43,111 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 10:01:43,114 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 10:01:46,685 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 10:01:50,548 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 10:01:52,472 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 10:01:52,665 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 10:01:54,599 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 10:01:54,799 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 10:01:54,801 - services.payment_service - INFO - PaymentService initialized
2025-09-02 10:01:54,803 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 10:01:54,807 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 10:01:54,808 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 10:01:54,812 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 10:01:54,814 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 10:01:54,816 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 10:01:54,818 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 10:01:54,820 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 10:01:56,466 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 10:01:56,495 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 10:01:56,655 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 10:01:58,541 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 10:01:58,823 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 10:01:58,825 - services.payment_service - INFO - PaymentService initialized
2025-09-02 10:01:58,826 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 10:01:58,827 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 10:01:58,829 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 10:01:58,830 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 10:01:58,833 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 10:01:58,835 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 10:01:58,836 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 10:01:58,838 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 10:01:58,840 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 10:02:00,326 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 10:02:00,327 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 10:02:00,327 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 10:02:00,328 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 10:02:00,328 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 10:02:00,329 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 10:02:00,361 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 10:02:00,362 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 10:02:23,875 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'Hi'}
2025-09-02 10:02:23,876 - utils.session_manager - INFO - New session 2347082345056 initialized.
2025-09-02 10:02:25,527 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 10:02:26,916 - utils.data_manager - DEBUG - Saving or updating lead 2347082345056: merchant_details_id=20, user_id=2347082345056, user_name=Olumayowa Oyaleke, phone_number=2347082345056, source=whatsapp, first_contact=2025-09-02 09:02:25.727097+00:00, last_interaction=2025-09-02 09:02:25.727097+00:00, interaction_count=1, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-09-02 10:02:27,486 - utils.data_manager - INFO - Lead 2347082345056 saved or updated in whatsapp_leads table
2025-09-02 10:02:27,582 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2347082345056
2025-09-02 10:02:29,206 - utils.data_manager - DEBUG - Found address '873 Ozumba Mbadiwe Ave, Lagos, 106104, Lagos, NG' for phone number 2347082345056 in whatsapp_orders
2025-09-02 10:02:29,386 - utils.data_manager - DEBUG - Retrieved user data for 2347082345056: {'name': 'oyaleke', 'phone_number': '2347082345056', 'address': '873 Ozumba Mbadiwe Ave, Lagos, 106104, Lagos, NG', 'user_perferred_name': 'oyaleke', 'address2': '', 'address3': '', 'display_name': 'oyaleke'}
2025-09-02 10:02:29,388 - handlers.base_handler - INFO - Session 2347082345056 greeted returning user 'oyaleke'.
2025-09-02 10:02:29,389 - services.whatsapp_service - DEBUG - Created image message payload for 2347082345056
2025-09-02 10:02:30,670 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjYzQjMyMkM2NzlFRkQzRDMwMQA="}]}
2025-09-02 10:02:30,673 - services.whatsapp_service - DEBUG - Created button message payload for 2347082345056
2025-09-02 10:02:31,777 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkIzNTVFNThENkU4NzlGMTlGMgA="}]}
2025-09-02 10:02:31,781 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkIzNTVFNThENkU4NzlGMTlGMgA='}]}
2025-09-02 10:02:31,784 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:02:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:02:32,144 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:02:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:02:33,061 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:02:33] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:02:35,819 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:02:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:02:36,275 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:02:36] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:02:38,304 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:02:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:02:38,313 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:02:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:03:48,454 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 10:03:50,205 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 10:03:50,395 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2347082345056
2025-09-02 10:03:50,396 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2347082345056.
2025-09-02 10:03:50,396 - handlers.base_handler - INFO - Session 2347082345056 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 10:03:50,397 - handlers.message_processor - INFO - Session 2347082345056: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 10:03:50,397 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2347082345056. Original: 'ai_bulk_order_direct'
2025-09-02 10:03:50,398 - services.whatsapp_service - DEBUG - Created image message payload for 2347082345056
2025-09-02 10:03:50,398 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2347082345056: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2347082345056', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 10:03:51,480 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjU3QUZCQzBGOUM0RjhDMEVGOQA="}]}
2025-09-02 10:03:51,485 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-09-02 10:03:51,487 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2347082345056: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2347082345056', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 10:03:52,447 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjE1OUQ4ODkzRDMxNjI4MTY3OQA="}]}
2025-09-02 10:03:52,449 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjE1OUQ4ODkzRDMxNjI4MTY3OQA='}]}
2025-09-02 10:03:52,451 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:03:52] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:03:53,763 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:03:53] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:03:54,119 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:03:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:03:54,245 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:03:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:03:54,852 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:03:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:03:54,975 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:03:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:03:54,982 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:03:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:00,262 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': '2 jollof'}
2025-09-02 10:04:02,096 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 10:04:02,286 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2347082345056
2025-09-02 10:04:02,287 - handlers.base_handler - INFO - AIHandler: Handling message '2 jollof' in AI bulk order state for session 2347082345056. Original: '2 jollof'
2025-09-02 10:04:06,338 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 10:04:06,394 - services.whatsapp_service - DEBUG - Created button message payload for 2347082345056
2025-09-02 10:04:07,399 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjYxQTg5QjI5NkEwOEY4OEIyMwA="}]}
2025-09-02 10:04:07,405 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjYxQTg5QjI5NkEwOEY4OEIyMwA='}]}
2025-09-02 10:04:07,408 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:08,472 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:10,357 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:10,642 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:13,438 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 10:04:15,195 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 10:04:15,386 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2347082345056
2025-09-02 10:04:15,387 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 2, 'price': 150.0, 'total_price': 300.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 10:04:15,388 - handlers.message_processor - INFO - Session 2347082345056: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 10:04:15,389 - utils.data_manager - DEBUG - Retrieved user data for 2347082345056: {'name': 'oyaleke', 'phone_number': '2347082345056', 'address': '873 Ozumba Mbadiwe Ave, Lagos, 106104, Lagos, NG', 'user_perferred_name': 'oyaleke', 'address2': '', 'address3': '', 'display_name': 'oyaleke'}
2025-09-02 10:04:15,390 - handlers.order_handler - INFO - AI initiated order processing for session 2347082345056.
2025-09-02 10:04:15,391 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2347082345056.
2025-09-02 10:04:15,420 - services.whatsapp_service - DEBUG - Created button message payload for 2347082345056
2025-09-02 10:04:16,476 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjg0ODczNTBFQzUyRTc1OTU2NQA="}]}
2025-09-02 10:04:17,587 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:17] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:18,119 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 10:04:19,436 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:19] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:19,475 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:19] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:19,536 - utils.data_manager - DEBUG - Saving or updating lead 2347082345056: merchant_details_id=20, user_id=2347082345056, user_name=Olumayowa Oyaleke, phone_number=2347082345056, source=whatsapp, first_contact=2025-09-02 09:04:18.316648+00:00, last_interaction=2025-09-02 09:04:18.316648+00:00, interaction_count=1, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=300.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-09-02 10:04:20,236 - utils.data_manager - INFO - Lead 2347082345056 saved or updated in whatsapp_leads table
2025-09-02 10:04:20,260 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2347082345056
2025-09-02 10:04:20,262 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjg0ODczNTBFQzUyRTc1OTU2NQA='}]}
2025-09-02 10:04:20,265 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:21,528 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'add_note'}
2025-09-02 10:04:23,206 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 10:04:23,410 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2347082345056
2025-09-02 10:04:23,411 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2347082345056.
2025-09-02 10:04:23,412 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-09-02 10:04:23,414 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2347082345056: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2347082345056', 'type': 'text', 'text': {'body': "Please type your note for the order (e.g., 'Please deliver after 5 PM'). Type 'back' to skip adding a note."}}
2025-09-02 10:04:24,479 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkFCRTY1OUFFMzY5N0E4NjhGOQA="}]}
2025-09-02 10:04:25,805 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:25] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:25,966 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:25] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:26,072 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:26] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:26,235 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 10:04:27,616 - utils.data_manager - DEBUG - Saving or updating lead 2347082345056: merchant_details_id=20, user_id=2347082345056, user_name=Olumayowa Oyaleke, phone_number=2347082345056, source=whatsapp, first_contact=2025-09-02 09:04:26.426245+00:00, last_interaction=2025-09-02 09:04:26.426245+00:00, interaction_count=1, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=300.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-09-02 10:04:28,187 - utils.data_manager - INFO - Lead 2347082345056 saved or updated in whatsapp_leads table
2025-09-02 10:04:28,207 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2347082345056
2025-09-02 10:04:28,208 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkFCRTY1OUFFMzY5N0E4NjhGOQA='}]}
2025-09-02 10:04:28,210 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:28] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:34,105 - handlers.webhook_handler - INFO - Processing message from 2347082345056 (User: Olumayowa Oyaleke): {'type': 'text', 'text': 'Deliver'}
2025-09-02 10:04:35,796 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 10:04:35,996 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2347082345056
2025-09-02 10:04:35,997 - handlers.order_handler - INFO - Note 'deliver' added for session 2347082345056.
2025-09-02 10:04:35,998 - utils.data_manager - DEBUG - Retrieved user data for 2347082345056: {'name': 'oyaleke', 'phone_number': '2347082345056', 'address': '873 Ozumba Mbadiwe Ave, Lagos, 106104, Lagos, NG', 'user_perferred_name': 'oyaleke', 'address2': '', 'address3': '', 'display_name': 'oyaleke'}
2025-09-02 10:04:36,066 - services.whatsapp_service - DEBUG - Created button message payload for 2347082345056
2025-09-02 10:04:37,229 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjc0NEVBMkE3MzBFQjc1N0ZEMAA="}]}
2025-09-02 10:04:38,506 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:38,785 - utils.data_manager - DEBUG - No lead found for user 2347082345056 and merchant 20 in whatsapp_leads
2025-09-02 10:04:40,135 - utils.data_manager - DEBUG - Saving or updating lead 2347082345056: merchant_details_id=20, user_id=2347082345056, user_name=Olumayowa Oyaleke, phone_number=2347082345056, source=whatsapp, first_contact=2025-09-02 09:04:38.978737+00:00, last_interaction=2025-09-02 09:04:38.978737+00:00, interaction_count=1, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=300.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-09-02 10:04:40,822 - utils.data_manager - INFO - Lead 2347082345056 saved or updated in whatsapp_leads table
2025-09-02 10:04:40,833 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2347082345056
2025-09-02 10:04:40,833 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2347082345056', 'wa_id': '2347082345056'}], 'messages': [{'id': 'wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjc0NEVBMkE3MzBFQjc1N0ZEMAA='}]}
2025-09-02 10:04:40,835 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:43,363 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:04:43,393 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:04:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:06:56,700 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 10:06:58,545 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 10:09:05,032 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 10:09:05,035 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 10:09:13,821 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 10:09:16,668 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 10:09:18,384 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 10:09:18,575 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 10:09:20,478 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 10:09:20,675 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 10:09:20,677 - services.payment_service - INFO - PaymentService initialized
2025-09-02 10:09:20,678 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 10:09:20,680 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 10:09:20,680 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 10:09:20,681 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 10:09:20,682 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 10:09:20,683 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 10:09:20,683 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 10:09:20,684 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 10:09:22,458 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 10:09:22,464 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 10:09:22,655 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 10:09:24,506 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 10:09:24,706 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 10:09:24,708 - services.payment_service - INFO - PaymentService initialized
2025-09-02 10:09:24,709 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 10:09:24,710 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 10:09:24,711 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 10:09:24,712 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 10:09:24,715 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 10:09:24,715 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 10:09:24,717 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 10:09:24,718 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 10:09:24,720 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 10:09:25,633 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 10:09:25,634 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 10:09:25,634 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 10:09:25,635 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 10:09:25,636 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 10:09:25,637 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 10:09:25,665 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 10:09:25,666 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 10:09:25,925 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 10:09:25,926 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 10:09:27,525 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 10:09:28,925 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 09:09:27.746844+00:00, interaction_count=147, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 10:09:29,589 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 10:09:29,592 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 10:09:29,593 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 10:09:31,194 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 10:09:31,396 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 10:09:31,397 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 10:09:31,399 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 10:09:31,400 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 10:09:34,247 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxNTE3OUUyQzlEMTUyMDJBMwA="}]}
2025-09-02 10:09:34,250 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 10:09:35,325 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM2M0M5RjM0REU5M0Q0MENBRAA="}]}
2025-09-02 10:09:35,327 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM2M0M5RjM0REU5M0Q0MENBRAA='}]}
2025-09-02 10:09:35,330 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:35,983 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:36,515 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:36] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:36,617 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:36] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:36,809 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:36] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:36,931 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:36] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:37,464 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:37] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:42,535 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 10:09:44,225 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 10:09:45,645 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 09:09:44.438537+00:00, interaction_count=148, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 10:09:46,265 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 10:09:46,269 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 10:09:46,270 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 10:09:46,271 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 10:09:46,272 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 10:09:46,273 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 10:09:46,274 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 10:09:46,276 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 10:09:46,278 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 10:09:47,287 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEOTY5OTBFNzEwOUIzQjdDMwA="}]}
2025-09-02 10:09:47,291 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 10:09:47,294 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 10:09:48,316 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAyQTE2NzQ2RDJDRUFFRTUzMAA="}]}
2025-09-02 10:09:48,319 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAyQTE2NzQ2RDJDRUFFRTUzMAA='}]}
2025-09-02 10:09:48,322 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:49,332 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:49,890 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:49,998 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:50,187 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:50] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:09:50,347 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:09:50] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:10:42,939 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:10:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:10:42,943 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 10:10:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 10:10:54,115 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 10:10:54,117 - handlers.product_sync_handler - INFO - Product sync thread stopped.
