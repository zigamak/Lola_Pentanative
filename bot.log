2025-09-02 12:03:54,596 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:03:57,936 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:04:00,155 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:04:00,344 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:04:02,042 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:04:02,222 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:04:02,224 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:04:02,224 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:04:02,227 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:04:02,227 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:04:02,228 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:04:02,229 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:04:02,230 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:04:02,231 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:04:02,232 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:04:03,752 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:04:03,775 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:04:03,959 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:04:05,696 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:04:05,887 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:04:05,888 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:04:05,889 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:04:05,889 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:04:05,890 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:04:05,890 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:04:05,898 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:04:05,898 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:04:05,899 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:04:05,900 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:04:05,901 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:04:06,581 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:04:06,582 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:04:06,582 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:04:06,583 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:04:06,584 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:04:06,584 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:04:06,617 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:04:06,618 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:04:10,876 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 12:04:10,876 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:04:12,421 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:13,763 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:12.610308+00:00, interaction_count=162, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:14,346 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:14,348 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:04:14,348 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:15,857 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:04:16,044 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 12:04:16,044 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:04:16,045 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 12:04:16,046 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:04:18,366 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFQjBFNkNBMTlDRkQwRDMyNQA="}]}
2025-09-02 12:04:18,368 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:19,356 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg3NkUyRTg2ODNEQUFFNEMyMAA="}]}
2025-09-02 12:04:19,359 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg3NkUyRTg2ODNEQUFFNEMyMAA='}]}
2025-09-02 12:04:19,364 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:19] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:20,535 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:20,848 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:21,132 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:21,738 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:23,196 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:04:24,745 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:26,037 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:24.926269+00:00, interaction_count=163, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:26,591 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:26,592 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:26,593 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:26,593 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:04:26,594 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:04:26,594 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:04:26,595 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:04:26,595 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:04:26,596 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:04:27,545 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE0MkMyQTA2NTRCMEU1RTVGMAA="}]}
2025-09-02 12:04:27,546 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:04:27,547 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:04:28,443 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYxMzVDN0Q2Nzk2MDJBNTVDNgA="}]}
2025-09-02 12:04:28,445 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYxMzVDN0Q2Nzk2MDJBNTVDNgA='}]}
2025-09-02 12:04:28,446 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:28] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:29,470 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,057 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,099 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,195 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,416 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:30,517 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:31,938 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-09-02 12:04:33,450 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:34,773 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:33.631560+00:00, interaction_count=164, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:35,323 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:35,324 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:35,324 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:35,325 - handlers.base_handler - INFO - AIHandler: Handling message 'fried rice' in AI bulk order state for session 2348055614455. Original: 'Fried rice'
2025-09-02 12:04:38,276 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:04:38,303 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:39,324 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0OUM5Q0NCMENENjY3NUFBRgA="}]}
2025-09-02 12:04:39,325 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0OUM5Q0NCMENENjY3NUFBRgA='}]}
2025-09-02 12:04:39,326 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:40,658 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:41,008 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:42,875 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:04:44,389 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:45,710 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:44.576712+00:00, interaction_count=165, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:46,268 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:46,270 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:46,270 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:46,271 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:04:46,271 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:04:46,272 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:04:46,273 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:04:46,273 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:04:46,289 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:47,194 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxNzRGQjRFREMzMzhGRUM0NwA="}]}
2025-09-02 12:04:48,277 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:48,556 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:48,703 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:48,899 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:50,013 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:48.894880+00:00, interaction_count=166, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:50,310 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:04:50,554 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:50,575 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:04:50,575 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxNzRGQjRFREMzMzhGRUM0NwA='}]}
2025-09-02 12:04:50,577 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:50] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:51,813 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:53,144 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:52.004088+00:00, interaction_count=167, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:53,714 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:53,716 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:04:53,716 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:04:53,717 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:04:53,717 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:04:53,744 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:04:54,875 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGNUM2QkMzQkMwRjFDOTczOAA="}]}
2025-09-02 12:04:56,005 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:56,386 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:04:56,415 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:56,589 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:57,702 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:56.584932+00:00, interaction_count=168, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:04:57,807 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:04:58,243 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:04:58,257 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:04:58,258 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGNUM2QkMzQkMwRjFDOTczOAA='}]}
2025-09-02 12:04:58,259 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:04:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:04:59,314 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:05:00,624 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:04:59.495236+00:00, interaction_count=169, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:05:01,192 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:05:01,194 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:05:01,194 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:05:01,195 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:05:01,196 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:05:01,196 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:05:01,213 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:05:01,214 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Error: Invalid button configuration. Please try again or contact support.'}}
2025-09-02 12:05:02,216 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyN0IyRkQ0OTY0NEVDQ0MyRQA="}]}
2025-09-02 12:05:03,227 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:05:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:05:03,723 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:05:03,992 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:05:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:05:04,995 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:05:03.902828+00:00, interaction_count=170, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:05:05,552 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:05:05,563 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:05:05,564 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyN0IyRkQ0OTY0NEVDQ0MyRQA='}]}
2025-09-02 12:05:05,565 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:05:05] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:49,005 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': "He'll"}
2025-09-02 12:06:50,528 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:06:51,832 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:06:50.708552+00:00, interaction_count=171, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:06:52,404 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:06:52,405 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:06:52,405 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:06:52,419 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:06:53,384 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE2MzI5QzFGMEFFM0E5QUM5QwA="}]}
2025-09-02 12:06:54,744 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:54,854 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:06:54,859 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:55,325 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:56,152 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:06:55.038839+00:00, interaction_count=172, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:06:56,700 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:06:56,711 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:06:56,712 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE2MzI5QzFGMEFFM0E5QUM5QwA='}]}
2025-09-02 12:06:56,713 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:06:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:06:59,557 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_palmpay_salvation'}
2025-09-02 12:07:01,085 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:07:02,410 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:07:01.273452+00:00, interaction_count=173, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:07:02,958 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:07:02,960 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:07:02,960 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:07:04,642 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:07:04,644 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-02 12:07:04,644 - handlers.location_address_handler - INFO - Selected preset address 'Palmpay Salvation' for session 2348055614455
2025-09-02 12:07:04,645 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-09-02 12:07:06,375 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:07:06,376 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-02 12:07:06,377 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-09-02 12:07:06,399 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:07:07,405 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEzQ0YxQjNFNkM4QzczNkY2RQA="}]}
2025-09-02 12:07:08,467 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:08,859 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:08,913 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:07:09,389 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:10,243 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:07:09.093265+00:00, interaction_count=174, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:07:10,797 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:07:10,811 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:07:10,811 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEzQ0YxQjNFNkM4QzczNkY2RQA='}]}
2025-09-02 12:07:10,812 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:07:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:07:34,813 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:07:34,814 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 12:07:38,947 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:07:41,387 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:07:42,923 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:07:43,108 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:07:44,902 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:07:45,081 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:07:45,083 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:07:45,084 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:07:45,087 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:07:45,088 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:07:45,089 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:07:45,090 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:07:45,090 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:07:45,091 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:07:45,092 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:07:46,582 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:07:46,601 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:07:46,793 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:07:48,532 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:07:48,724 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:07:48,725 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:07:48,726 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:07:48,727 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:07:48,728 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:07:48,728 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:07:48,730 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:07:48,731 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:07:48,732 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:07:48,733 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:07:48,734 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:07:49,442 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:07:49,443 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:07:49,443 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:07:49,444 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:07:49,445 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:07:49,445 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:07:49,480 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:07:49,481 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:08:26,234 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 12:08:26,235 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:08:27,689 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:08:29,033 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:27.877563+00:00, interaction_count=175, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:08:29,719 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:08:29,719 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:08:29,720 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:08:31,203 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:08:31,386 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 12:08:31,386 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:08:31,387 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 12:08:31,387 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:08:32,423 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCQTMwMEFEOTQzQTZBRTlCNAA="}]}
2025-09-02 12:08:32,424 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:08:33,423 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2MjQ1QjlGMUQ1QkU5QjFGQQA="}]}
2025-09-02 12:08:33,425 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2MjQ1QjlGMUQ1QkU5QjFGQQA='}]}
2025-09-02 12:08:33,426 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:33] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:33,731 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:33] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,453 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,573 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,810 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:34,963 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:35,143 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:36,344 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:08:37,881 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:08:39,193 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:38.063345+00:00, interaction_count=176, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:08:39,758 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:08:39,758 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:08:39,758 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:08:39,759 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:08:39,759 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:08:39,759 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:08:39,759 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:08:39,760 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:08:39,760 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:08:40,738 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkyMTIyMUIwRkIxN0RBRThFQwA="}]}
2025-09-02 12:08:40,739 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:08:40,739 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:08:41,573 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkREOTIyNTE0MjQ5NDEwQzQ2MgA="}]}
2025-09-02 12:08:41,574 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkREOTIyNTE0MjQ5NDEwQzQ2MgA='}]}
2025-09-02 12:08:41,574 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:42,110 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:42,714 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:42,739 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:43,005 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:43,215 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:43,266 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:47,251 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-02 12:08:48,727 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:08:50,019 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:48.906084+00:00, interaction_count=177, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:08:50,564 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:08:50,565 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:08:50,565 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:08:50,565 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-02 12:08:53,078 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:08:53,091 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:08:54,073 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwQTNCODk4RTM1Q0MzNDQ3OAA="}]}
2025-09-02 12:08:54,074 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwQTNCODk4RTM1Q0MzNDQ3OAA='}]}
2025-09-02 12:08:54,074 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:54] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:55,253 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:55,503 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:55,685 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:08:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:08:57,227 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:08:58,702 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:00,192 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:08:58.891202+00:00, interaction_count=178, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:00,736 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:00,737 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:00,737 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:00,737 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:09:00,737 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:09:00,738 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:09:00,738 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:09:00,738 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:09:00,746 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:09:01,672 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMDNDRjNGRDFCQUQ3RTE0RgA="}]}
2025-09-02 12:09:02,721 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:02] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:02,975 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:02] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:03,148 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:03,318 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:04,438 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:03.337024+00:00, interaction_count=179, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:04,980 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:04,990 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:04,991 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMDNDRjNGRDFCQUQ3RTE0RgA='}]}
2025-09-02 12:09:04,992 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:05,034 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:09:06,508 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:07,817 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:06.702859+00:00, interaction_count=180, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:08,354 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:08,355 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:08,355 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:08,355 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:09:08,356 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:09:08,373 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:09:09,242 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJFRUIzRkM0MTRCRTJBQzM2RgA="}]}
2025-09-02 12:09:10,313 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:10,706 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:10,885 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:11,195 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:12,006 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:10.892988+00:00, interaction_count=181, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:12,567 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:12,573 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:12,573 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJFRUIzRkM0MTRCRTJBQzM2RgA='}]}
2025-09-02 12:09:12,574 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:12] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:12,865 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:09:14,320 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:15,631 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:14.505882+00:00, interaction_count=182, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:16,206 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:16,206 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:16,207 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:16,207 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:09:16,207 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:09:16,208 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:09:16,215 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:09:17,534 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY5N0Y0NzM1NEY0MEM2Rjg2QQA="}]}
2025-09-02 12:09:18,684 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:18] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:18,860 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:18] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:19,058 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:19,665 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:19] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:20,383 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:19.234220+00:00, interaction_count=183, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:20,975 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:20,982 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:20,982 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY5N0Y0NzM1NEY0MEM2Rjg2QQA='}]}
2025-09-02 12:09:20,983 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:26,079 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_palmpay_salvation'}
2025-09-02 12:09:27,542 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:28,853 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:27.719751+00:00, interaction_count=184, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:29,425 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:29,426 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:09:29,426 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:09:31,062 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:09:31,063 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-02 12:09:31,063 - handlers.location_address_handler - INFO - Selected preset address 'Palmpay Salvation' for session 2348055614455
2025-09-02 12:09:31,064 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-09-02 12:09:32,798 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:09:32,799 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-02 12:09:32,800 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-09-02 12:09:32,812 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:09:33,753 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2MTk4Q0U5NkNDMzQyRTQwNgA="}]}
2025-09-02 12:09:34,953 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:35,166 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:35,273 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:09:36,004 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:36] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:09:36,567 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:09:35.462989+00:00, interaction_count=185, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:09:37,117 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:09:37,123 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:09:37,123 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2MTk4Q0U5NkNDMzQyRTQwNgA='}]}
2025-09-02 12:09:37,124 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:09:37] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:08,964 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:10:08,964 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 12:10:12,785 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:10:14,253 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:10:15,812 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:10:15,993 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:10:17,682 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:10:17,873 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:10:17,874 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:10:17,874 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:10:17,876 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:10:17,876 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:10:17,876 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:10:17,877 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:10:17,877 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:10:17,878 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:10:17,878 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:10:19,343 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:10:19,351 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:10:19,547 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:10:21,310 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:10:21,493 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:10:21,493 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:10:21,494 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:10:21,494 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:10:21,494 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:10:21,495 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:10:21,496 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:10:21,496 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:10:21,496 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:10:21,497 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:10:21,497 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:10:21,935 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:10:21,935 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:10:21,935 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:10:21,936 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:10:21,936 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:10:21,936 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:10:21,960 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:10:21,961 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:10:23,763 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hwllo'}
2025-09-02 12:10:23,764 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:10:25,242 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:10:26,578 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:10:25.432294+00:00, interaction_count=186, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:10:27,136 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:10:27,137 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:10:27,137 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:10:28,608 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:10:28,795 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:10:28,795 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-02 12:10:28,796 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:10:29,873 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJCNjk3Mjk4REYzNDlEMDE4MAA="}]}
2025-09-02 12:10:29,874 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:10:30,892 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExQ0IxQUQxRTRERkVFNTZDRQA="}]}
2025-09-02 12:10:30,893 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExQ0IxQUQxRTRERkVFNTZDRQA='}]}
2025-09-02 12:10:30,894 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:31,348 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:31,893 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:31,976 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:32,005 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:32,555 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:32,673 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:34,174 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:10:35,662 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:10:36,985 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:10:35.846676+00:00, interaction_count=187, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:10:37,548 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:10:37,549 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:10:37,549 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:10:37,550 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:10:37,550 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:10:37,551 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:10:37,551 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:10:37,551 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:10:37,552 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:10:38,546 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1M0I4MTJCMjVBMEYyQTg5QQA="}]}
2025-09-02 12:10:38,548 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:10:38,549 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:10:39,433 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBNjc4QzQ3REExNzJGMzRFQQA="}]}
2025-09-02 12:10:39,437 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBNjc4QzQ3REExNzJGMzRFQQA='}]}
2025-09-02 12:10:39,439 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,104 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,577 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,668 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:40,895 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:41,030 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:41,155 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:50,571 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-02 12:10:52,128 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:10:53,424 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:10:52.326433+00:00, interaction_count=188, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:10:53,965 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:10:53,966 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:10:53,967 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:10:53,967 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-02 12:10:57,311 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:10:57,322 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:10:58,183 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QjQ1NTE5QURDRThERTg0MwA="}]}
2025-09-02 12:10:58,184 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QjQ1NTE5QURDRThERTg0MwA='}]}
2025-09-02 12:10:58,185 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:59,193 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:59,730 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:10:59,827 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:10:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:01,794 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:11:03,280 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:04,548 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:03.463914+00:00, interaction_count=189, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:05,113 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:05,114 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:05,115 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:05,115 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:11:05,115 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:11:05,115 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:11:05,116 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:11:05,116 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:11:05,123 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:06,045 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0OTVGODAyMTQxNTU0MzQ1QQA="}]}
2025-09-02 12:11:07,104 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:07,399 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:07,547 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:07,853 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:08,913 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:07.723022+00:00, interaction_count=190, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:09,481 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:09,489 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:09,489 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0OTVGODAyMTQxNTU0MzQ1QQA='}]}
2025-09-02 12:11:09,490 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:09,717 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:11:11,332 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:12,643 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:11.528603+00:00, interaction_count=191, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:13,201 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:13,203 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:13,204 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:13,208 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:11:13,213 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Palmpay Salvation, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:11:13,329 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:14,516 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU4MjgwNEJCMDQ4ODE4MDkxRAA="}]}
2025-09-02 12:11:15,633 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:15] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:15,897 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:15] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:16,014 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:16,335 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:16] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:17,285 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:16.194908+00:00, interaction_count=192, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:17,832 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:17,837 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:17,838 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU4MjgwNEJCMDQ4ODE4MDkxRAA='}]}
2025-09-02 12:11:17,838 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:17] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:18,344 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:11:19,820 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:21,112 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:20.011376+00:00, interaction_count=193, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:21,666 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:21,667 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:21,667 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:21,668 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:11:21,668 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:11:21,668 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:11:21,674 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:22,652 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3OTAzNTM1M0FCNDUxMjBBMgA="}]}
2025-09-02 12:11:23,632 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:23] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:24,266 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:24] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:24,272 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:24,344 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:24] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:25,739 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:24.482499+00:00, interaction_count=194, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:26,303 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:26,314 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:26,314 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3OTAzNTM1M0FCNDUxMjBBMgA='}]}
2025-09-02 12:11:26,316 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:26] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:30,594 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-02 12:11:32,132 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:33,412 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:32.312993+00:00, interaction_count=195, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:33,964 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:33,965 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:11:33,965 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:11:35,632 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:11:35,633 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-02 12:11:35,633 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-02 12:11:35,633 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-09-02 12:11:37,283 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:11:37,284 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-02 12:11:37,285 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-09-02 12:11:37,290 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:11:38,252 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNzQ5QjE5QURDOENBM0UwRAA="}]}
2025-09-02 12:11:39,524 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:39,624 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:39,766 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:11:39,815 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:11:41,070 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:11:39.945500+00:00, interaction_count=196, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:11:41,608 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:11:41,613 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:11:41,614 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNzQ5QjE5QURDOENBM0UwRAA='}]}
2025-09-02 12:11:41,614 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:11:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:12:00,940 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:12:00,940 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 12:28:20,269 - __main__ - ERROR - Environment check failed. Please fix the issues above.
2025-09-02 12:30:35,792 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 12:30:38,235 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:30:44,340 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:30:45,065 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:30:51,660 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:30:52,122 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:30:52,123 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:30:52,123 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 12:30:52,125 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 12:30:52,126 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:30:52,127 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 12:30:52,127 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:30:52,127 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:30:52,128 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:30:52,128 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 12:30:56,918 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 12:30:56,946 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 12:30:57,471 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 12:31:00,898 - utils.data_manager - INFO - Successfully loaded 55 user details from database
2025-09-02 12:31:01,327 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 12:31:01,328 - services.payment_service - INFO - PaymentService initialized
2025-09-02 12:31:01,328 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 12:31:01,329 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 12:31:01,329 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 12:31:01,329 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 12:31:01,331 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 12:31:01,332 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 12:31:01,332 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 12:31:01,333 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:31:01,333 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:31:01,791 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 12:31:01,791 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 12:31:01,791 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 12:31:01,792 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 12:31:01,792 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 12:31:01,793 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 12:31:01,823 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 12:31:01,824 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 12:31:03,952 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:31:03,952 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 12:31:07,737 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:31:10,256 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:31:08.000998+00:00, interaction_count=197, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:31:11,643 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:31:11,644 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 12:31:11,645 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:31:16,217 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 12:31:16,626 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:31:16,626 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-02 12:31:16,627 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:31:18,683 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJGRjgxMzY0OTc5N0IzQjhGRQA="}]}
2025-09-02 12:31:18,695 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:31:20,345 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:20,418 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM2MENCQTk2OTA3MjczNjkwNAA="}]}
2025-09-02 12:31:20,419 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM2MENCQTk2OTA3MjczNjkwNAA='}]}
2025-09-02 12:31:20,419 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:20] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:21,534 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:21,586 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:21,820 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:22,126 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:22] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:22,407 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:22] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:23,467 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 12:31:28,233 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:31:33,143 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:31:28.880782+00:00, interaction_count=198, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:31:35,788 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:31:35,789 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:31:35,789 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:31:35,789 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 12:31:35,789 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 12:31:35,790 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 12:31:35,790 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 12:31:35,790 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 12:31:35,791 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 12:31:39,441 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU5NDU0RkVBNTVGNTlCQzA4MwA="}]}
2025-09-02 12:31:39,442 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 12:31:39,442 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 12:31:41,266 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:41,329 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwMDBCMDkzQjFGMkI4M0Y1NAA="}]}
2025-09-02 12:31:41,330 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwMDBCMDkzQjFGMkI4M0Y1NAA='}]}
2025-09-02 12:31:41,330 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:42,446 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:42,573 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:42,896 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:42,898 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:42] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:43,223 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:31:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:31:49,807 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-02 12:31:54,020 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:31:57,615 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:31:54.502187+00:00, interaction_count=199, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:31:59,974 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:31:59,975 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:31:59,975 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:31:59,976 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-02 12:32:05,467 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 12:32:05,482 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:32:08,358 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxOERDMTgxQjIxMTRCRDBEQQA="}]}
2025-09-02 12:32:08,359 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIxOERDMTgxQjIxMTRCRDBEQQA='}]}
2025-09-02 12:32:08,360 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:08] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:09,284 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:10,714 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:11,175 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:13,167 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 12:32:16,782 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:20,046 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:17.031875+00:00, interaction_count=200, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:22,176 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:22,177 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:32:22,177 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:32:22,178 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 12:32:22,178 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 12:32:22,178 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:32:22,179 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 12:32:22,179 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 12:32:22,197 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:32:24,754 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNDM1RkFCODMyQUE0QkNDNAA="}]}
2025-09-02 12:32:25,957 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:25] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:26,301 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:26] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:26,658 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:26] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:28,773 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:29,887 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 12:32:32,258 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:29.258875+00:00, interaction_count=201, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:33,546 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:33,565 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:33,584 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:32:33,584 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNDM1RkFCODMyQUE0QkNDNAA='}]}
2025-09-02 12:32:33,585 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:33] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:37,090 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:33.884253+00:00, interaction_count=201, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:38,602 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:38,602 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:32:38,603 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:32:38,603 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 12:32:38,603 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright, Abuja', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:32:38,615 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:32:39,761 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyQjE3NUY1ODk0QTY4RTMyNAA="}]}
2025-09-02 12:32:40,994 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:40] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:41,346 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:41,892 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:43,501 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:32:44,141 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:47,839 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:47,849 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:44.724267+00:00, interaction_count=203, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:49,827 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:49,832 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:32:49,833 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyQjE3NUY1ODk0QTY4RTMyNAA='}]}
2025-09-02 12:32:49,833 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:52,298 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:48.533691+00:00, interaction_count=203, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:53,663 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:53,664 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:32:53,664 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:32:53,664 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:32:53,664 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:32:53,665 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:32:53,671 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:32:54,698 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc0ODlFREMwQUJBNTRBQkE4RAA="}]}
2025-09-02 12:32:55,709 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:55] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:56,015 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:56,183 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:32:56,677 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:32:58,285 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:32:58,600 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:32:56.878221+00:00, interaction_count=205, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:32:59,239 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:32:59,244 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:32:59,245 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc0ODlFREMwQUJBNTRBQkE4RAA='}]}
2025-09-02 12:32:59,245 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:32:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:00,047 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:03,881 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:00.305753+00:00, interaction_count=206, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:05,898 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:05,899 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:33:05,899 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:33:05,900 - handlers.location_address_handler - INFO - User chose to enter their own address for session 2348055614455
2025-09-02 12:33:05,900 - handlers.location_address_handler - INFO - Showing address entry submenu for session 2348055614455
2025-09-02 12:33:05,907 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:33:08,195 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFBOEQxOEFGMDRDOEUyOTM2OAA="}]}
2025-09-02 12:33:09,249 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:10,254 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:11,097 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:12,714 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 12:33:15,406 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:20,672 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:23,041 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:16.119894+00:00, interaction_count=207, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:23,450 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:33:25,257 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:25,264 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:33:25,264 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFBOEQxOEFGMDRDOEUyOTM2OAA='}]}
2025-09-02 12:33:25,265 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:25] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:26,811 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:21.730990+00:00, interaction_count=207, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:30,443 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:30,443 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:33:30,444 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:33:30,444 - handlers.message_processor - WARNING - Session 2348055614455: Unexpected location state 'address_entry_submenu'. Attempting legacy handling.
2025-09-02 12:33:31,131 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:36,868 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:31.631892+00:00, interaction_count=209, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:37,842 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 12:33:37,914 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 12:33:37,915 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:33:37,928 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:33:40,402 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:40,403 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:33:40,403 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:33:40,403 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:33:40,415 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:33:42,362 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEQUI4QTgzRUM4OTEzMDNCOAA="}]}
2025-09-02 12:33:43,140 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVENTM5M0VBQkU1QUZGRjZCNwA="}]}
2025-09-02 12:33:43,399 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:43] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:44,243 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:44] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:44,421 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:44] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:45,231 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:45,402 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:46,401 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:46] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:47,109 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:48,609 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:33:49,669 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:50,635 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:53,014 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:47.696867+00:00, interaction_count=210, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:56,147 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:56,148 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:33:56,149 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:33:56,149 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:33:56,174 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:33:56,209 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:50.617840+00:00, interaction_count=210, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:56,217 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:33:56,935 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:51.459885+00:00, interaction_count=210, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:33:58,502 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:58,508 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:33:58,508 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEQUI4QTgzRUM4OTEzMDNCOAA='}]}
2025-09-02 12:33:58,509 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:58,830 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:33:58,837 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:33:58,837 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVENTM5M0VBQkU1QUZGRjZCNwA='}]}
2025-09-02 12:33:58,838 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:33:58] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:33:58,945 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc5NzNCRkM3MjIxMDE2MEY2RQA="}]}
2025-09-02 12:34:00,053 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:00,527 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:33:56.988725+00:00, interaction_count=211, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:34:00,751 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:01,010 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:01] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:02,870 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:34:02,871 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:34:02,871 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:34:02,872 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:34:02,882 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:34:03,031 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 12:34:03,373 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:03,694 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcwODE4NDU3RkEzREMyQTQ3NgA="}]}
2025-09-02 12:34:04,664 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:05,163 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:05] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:05,539 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:05,540 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:03.573892+00:00, interaction_count=214, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:34:06,062 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:06] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:07,037 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:07,263 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:34:07,270 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:34:07,270 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc5NzNCRkM3MjIxMDE2MEY2RQA='}]}
2025-09-02 12:34:07,271 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:15,319 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:34:16,573 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:05.977973+00:00, interaction_count=214, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:34:23,189 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:08.386264+00:00, interaction_count=214, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:34:24,053 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:34:28,548 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:34:28,549 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:34:28,549 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:34:28,550 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:34:28,561 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:34:29,817 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 12:34:30,625 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:34:30,632 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 12:34:30,632 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcwODE4NDU3RkEzREMyQTQ3NgA='}]}
2025-09-02 12:34:30,633 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:30] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:36,169 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQzQTZBRjk0MzU1N0M3M0FDMAA="}]}
2025-09-02 12:34:37,195 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:37] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:47,460 - utils.data_manager - ERROR - Database error while retrieving lead 2348055614455 from whatsapp_leads: connection to server at "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" (52.167.188.143), port 5432 failed: SSL SYSCALL error: EOF detected
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 851, in get_lead
    with psycopg2.connect(**self.db_params) as conn:
         ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\__init__.py", line 135, in connect
    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
psycopg2.OperationalError: connection to server at "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" (52.167.188.143), port 5432 failed: SSL SYSCALL error: EOF detected

2025-09-02 12:34:47,468 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:34:47,468 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:34:47,482 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:34:47,552 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:47,965 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:47] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:49,969 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:34:49,970 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:34:55,554 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 12:34:56,219 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:34:58,775 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjREQzAyQkJDRjkzRTA3M0MzMwA="}]}
2025-09-02 12:34:59,818 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:34:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:00,617 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:00,972 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:35:01,533 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:54.537958+00:00, interaction_count=217, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:35:01,885 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:35:02,098 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:34:58.589105+00:00, interaction_count=217, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:35:02,202 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:35:02,203 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:35:02,203 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:35:02,204 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 12:35:02,215 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:35:02,341 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:35:02,654 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:02] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:03,169 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 12:35:03,850 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 12:35:03,851 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 12:35:03,851 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 12:35:03,852 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 12:35:03,852 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 12:35:03,852 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 12:35:03,858 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 12:35:03,999 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 12:35:04,154 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0ODNCQTk0OTQ4ODU0QjRBOQA="}]}
2025-09-02 12:35:04,847 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:35:01.593466+00:00, interaction_count=217, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:35:05,153 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:05] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:07,823 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:08,444 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCQkY1MkYzQThFNDUyNUJDNwA="}]}
2025-09-02 12:35:08,931 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 11:35:02.089964+00:00, interaction_count=217, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 12:35:09,474 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:09,477 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 12:35:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 12:35:10,494 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 12:35:10,496 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 13:19:32,034 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 13:19:34,264 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 13:19:36,314 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 13:19:36,951 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 13:19:39,556 - utils.data_manager - INFO - Successfully loaded 56 user details from database
2025-09-02 13:19:39,768 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 13:19:39,768 - services.payment_service - INFO - PaymentService initialized
2025-09-02 13:19:39,769 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 13:19:39,770 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:19:39,781 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 13:19:39,781 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 13:19:39,782 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 13:19:39,783 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 13:19:39,783 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 13:19:39,783 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 13:19:41,747 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 13:19:41,754 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 13:19:41,960 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 13:19:44,006 - utils.data_manager - INFO - Successfully loaded 56 user details from database
2025-09-02 13:19:44,218 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 13:19:44,219 - services.payment_service - INFO - PaymentService initialized
2025-09-02 13:19:44,219 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 13:19:44,219 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 13:19:44,220 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 13:19:44,220 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 13:19:44,233 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 13:19:44,234 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 13:19:44,234 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 13:19:44,234 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 13:19:44,235 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 13:19:44,710 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 13:19:44,711 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 13:19:44,711 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 13:19:44,712 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 13:19:44,712 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 13:19:44,713 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 13:19:44,746 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 13:19:44,747 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 13:20:55,533 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 13:20:55,533 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 13:20:57,673 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 13:20:59,315 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 12:20:57.878609+00:00, interaction_count=219, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 13:21:00,109 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 13:21:00,111 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 13:21:00,111 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 13:21:02,310 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 13:21:02,617 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 13:21:02,618 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 13:21:02,619 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 13:21:02,620 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 13:21:03,419 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-09-02 13:21:03,423 - services.whatsapp_service - ERROR - Failed to send image to 2348055614455. Aborting button message.
2025-09-02 13:21:03,427 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 13:21:03] "POST /webhook HTTP/1.1" 200 -
2025-09-02 13:24:41,962 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:24:42,013 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:29:42,022 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:29:42,027 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:34:42,032 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:34:42,040 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:39:42,055 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:39:42,059 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:44:42,062 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:44:42,066 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:49:42,070 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:49:42,074 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:54:42,087 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:54:42,089 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 13:59:42,097 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 13:59:42,099 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:04:42,100 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:04:42,102 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:09:42,117 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:09:42,119 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:14:42,125 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:14:42,126 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:19:42,130 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:19:42,134 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 14:22:30,767 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 14:22:30,769 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-02 14:43:49,887 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-02 14:43:51,669 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 14:43:54,466 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 14:43:54,694 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 14:43:56,618 - utils.data_manager - INFO - Successfully loaded 56 user details from database
2025-09-02 14:43:56,903 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 14:43:56,904 - services.payment_service - INFO - PaymentService initialized
2025-09-02 14:43:56,904 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-02 14:43:56,905 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:43:56,906 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 14:43:56,906 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-02 14:43:56,907 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 14:43:56,907 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 14:43:56,907 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 14:43:56,908 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-02 14:43:58,661 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-02 14:43:58,682 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 14:43:58,873 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-02 14:44:00,753 - utils.data_manager - INFO - Successfully loaded 56 user details from database
2025-09-02 14:44:00,956 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-02 14:44:00,957 - services.payment_service - INFO - PaymentService initialized
2025-09-02 14:44:00,957 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-02 14:44:00,957 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-02 14:44:00,958 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-02 14:44:00,958 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-02 14:44:00,959 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-02 14:44:00,960 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-02 14:44:00,960 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-02 14:44:00,960 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 14:44:00,961 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 14:44:01,526 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-02 14:44:01,526 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-02 14:44:01,526 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-02 14:44:01,527 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-02 14:44:01,527 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-02 14:44:01,528 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-02 14:44:01,552 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-02 14:44:01,553 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-02 14:44:01,842 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-02 14:44:01,842 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-02 14:44:03,589 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:05,206 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:03.789105+00:00, interaction_count=220, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:05,864 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:05,865 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-02 14:44:05,865 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:44:07,520 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-02 14:44:07,721 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-02 14:44:07,721 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:44:07,722 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-02 14:44:07,722 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 14:44:09,081 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyQ0I5QTUxQTlCQTE4QkI0NQA="}]}
2025-09-02 14:44:09,093 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:44:09,800 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFRDYwQjhFNjc2QjAxOTk0QQA="}]}
2025-09-02 14:44:09,801 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFRDYwQjhFNjc2QjAxOTk0QQA='}]}
2025-09-02 14:44:09,802 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:09] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:10,807 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:10] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:11,451 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:11,793 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:11,814 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:11,888 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:11] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:12,110 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:12] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:27,634 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-02 14:44:29,307 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:30,792 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:29.540287+00:00, interaction_count=221, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:31,465 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:31,466 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:44:31,466 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:44:31,466 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-02 14:44:31,466 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-02 14:44:31,467 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-02 14:44:31,467 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-02 14:44:31,467 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-02 14:44:31,468 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-02 14:44:32,215 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEwOEQ4NDg3QTM5OTZENjc3MAA="}]}
2025-09-02 14:44:32,216 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-02 14:44:32,216 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-02 14:44:32,962 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNEOUFGMTVGQkU3MkNBMzhGMwA="}]}
2025-09-02 14:44:32,963 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNEOUFGMTVGQkU3MkNBMzhGMwA='}]}
2025-09-02 14:44:32,964 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:32] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,134 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,625 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,665 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,747 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:34,986 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:35,029 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:35,150 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:35,175 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:35] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:39,963 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-02 14:44:41,965 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:44,100 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:42.164731+00:00, interaction_count=222, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:44,698 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:44,699 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:44:44,700 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:44:44,700 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-02 14:44:47,505 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-02 14:44:47,521 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:44:48,308 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYyRDM2MUQzM0MxQTg5Mzg0RgA="}]}
2025-09-02 14:44:48,309 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYyRDM2MUQzM0MxQTg5Mzg0RgA='}]}
2025-09-02 14:44:48,310 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:49,425 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:49,473 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:49,524 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:49,592 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:49] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:51,275 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-02 14:44:52,981 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:54,505 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:53.186855+00:00, interaction_count=223, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:55,124 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:55,125 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:44:55,125 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:44:55,125 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-02 14:44:55,125 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-02 14:44:55,126 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:44:55,126 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-02 14:44:55,126 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-02 14:44:55,133 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:44:55,908 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4QkEwMUQxRDBGMzVFM0YyRAA="}]}
2025-09-02 14:44:56,939 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:56] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:57,241 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:57,365 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:57,475 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:44:57,699 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:44:58,720 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-02 14:44:59,142 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:44:57.897203+00:00, interaction_count=224, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:44:59,781 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:44:59,789 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:44:59,789 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4QkEwMUQxRDBGMzVFM0YyRAA='}]}
2025-09-02 14:44:59,790 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:44:59] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:00,388 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:01,893 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:00.581619+00:00, interaction_count=225, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:02,542 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:02,543 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:02,543 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:02,544 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-02 14:45:02,544 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:45:02,555 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:03,378 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVDOEFFMkRCNjlFNEZFMjUxNQA="}]}
2025-09-02 14:45:04,700 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:04,831 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:04,833 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:04,992 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:04] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:05,017 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:06,502 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:05.220094+00:00, interaction_count=226, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:06,757 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 14:45:07,095 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:07,100 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:07,101 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVDOEFFMkRCNjlFNEZFMjUxNQA='}]}
2025-09-02 14:45:07,101 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:07] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:09,083 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:10,584 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:09.285568+00:00, interaction_count=227, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:11,385 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:11,386 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:11,387 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:11,387 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 14:45:11,387 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 14:45:11,387 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 14:45:11,394 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:12,388 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZBNUY1RDQxNDc4NEU2M0NBMQA="}]}
2025-09-02 14:45:13,511 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:13] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:13,558 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:13] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:13,650 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:13] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:13,746 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:13] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:14,132 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:15,439 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 14:45:15,637 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:14.339371+00:00, interaction_count=228, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:16,258 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:16,263 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:16,264 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZBNUY1RDQxNDc4NEU2M0NBMQA='}]}
2025-09-02 14:45:16,264 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:16] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:17,113 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:18,612 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:17.326594+00:00, interaction_count=229, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:19,252 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:19,253 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:19,253 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:19,254 - handlers.location_address_handler - INFO - User chose to enter their own address for session 2348055614455
2025-09-02 14:45:19,254 - handlers.location_address_handler - INFO - Showing address entry submenu for session 2348055614455
2025-09-02 14:45:19,259 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:20,110 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBNUM0QTFDMTFBREI1MzM5OAA="}]}
2025-09-02 14:45:21,127 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:21,495 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:21] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:22,486 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:23,683 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-09-02 14:45:24,213 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:22.827013+00:00, interaction_count=230, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:24,828 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:24,834 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:24,834 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBNUM0QTFDMTFBREI1MzM5OAA='}]}
2025-09-02 14:45:24,835 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:24] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:25,499 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:26,989 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:25.700861+00:00, interaction_count=231, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:27,595 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:27,596 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:27,596 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:27,596 - handlers.message_processor - WARNING - Session 2348055614455: Unexpected location state 'address_entry_submenu'. Attempting legacy handling.
2025-09-02 14:45:29,484 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 14:45:29,484 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'share_current_location', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:45:29,496 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:30,291 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzRDEzMTZDRDA3OTlERTlGRgA="}]}
2025-09-02 14:45:31,572 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:31,588 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:31,630 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:31,654 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:31] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:32,025 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:32,783 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-02 14:45:33,577 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:32.232048+00:00, interaction_count=232, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:34,191 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:34,197 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:34,197 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzRDEzMTZDRDA3OTlERTlGRgA='}]}
2025-09-02 14:45:34,199 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:34] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:34,610 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:36,196 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:34.827008+00:00, interaction_count=233, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:36,900 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:36,901 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:36,901 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:36,901 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-09-02 14:45:36,901 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-02 14:45:36,902 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-02 14:45:36,908 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:37,624 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4QThCRkU2MTg0NzQzOEE4MQA="}]}
2025-09-02 14:45:38,753 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:38,943 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:38] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:39,012 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:39,064 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:39] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:39,335 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:40,784 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:39.539976+00:00, interaction_count=234, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:41,403 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:41,409 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:41,409 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4QThCRkU2MTg0NzQzOEE4MQA='}]}
2025-09-02 14:45:41,410 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:41] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:42,397 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enter_your_address'}
2025-09-02 14:45:44,102 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:45,734 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:44.297703+00:00, interaction_count=235, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:46,393 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:46,393 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:46,394 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:46,394 - handlers.location_address_handler - INFO - User chose to enter their own address for session 2348055614455
2025-09-02 14:45:46,394 - handlers.location_address_handler - INFO - Showing address entry submenu for session 2348055614455
2025-09-02 14:45:46,400 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:47,107 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVCRERBMzg3NEE3NzI0MkNFOAA="}]}
2025-09-02 14:45:48,354 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:48,376 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:48,548 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:48,646 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:48] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:48,936 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:49,711 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'type_address_manually'}
2025-09-02 14:45:50,543 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:49.141679+00:00, interaction_count=236, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:51,171 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:51,177 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:45:51,177 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVCRERBMzg3NEE3NzI0MkNFOAA='}]}
2025-09-02 14:45:51,178 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:51] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:51,380 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:52,978 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:51.578044+00:00, interaction_count=237, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:45:53,623 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:45:53,624 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-02 14:45:53,624 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-02 14:45:53,625 - handlers.message_processor - WARNING - Session 2348055614455: Unexpected location state 'address_entry_submenu'. Attempting legacy handling.
2025-09-02 14:45:55,550 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-02 14:45:55,550 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-02 14:45:55,565 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-02 14:45:56,370 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxQzQ5NTVBM0FEODg2QjA5MwA="}]}
2025-09-02 14:45:57,478 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:57,731 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:57,834 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:57,836 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:45:57] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:45:58,099 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-02 14:45:59,568 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-02 13:45:58.306585+00:00, interaction_count=238, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-02 14:46:00,183 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-02 14:46:00,188 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-02 14:46:00,189 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxQzQ5NTVBM0FEODg2QjA5MwA='}]}
2025-09-02 14:46:00,189 - werkzeug - INFO - 127.0.0.1 - - [02/Sep/2025 14:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-02 14:48:58,896 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:49:00,825 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 14:54:01,035 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:54:03,119 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 14:59:03,335 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 14:59:05,587 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:04:05,793 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:04:07,769 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:09:07,980 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:09:16,870 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:14:17,118 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:14:19,545 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:19:19,765 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:19:22,015 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:24:22,228 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:24:24,199 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:29:24,403 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:29:33,035 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:34:33,258 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:34:36,140 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-02 15:39:36,461 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:39:36,513 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 15:44:36,516 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:44:36,518 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 15:49:36,528 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:49:36,530 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 15:54:36,546 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:54:36,550 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 15:59:36,563 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 15:59:36,564 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 16:04:36,568 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 16:04:36,570 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 16:09:36,584 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-02 16:09:36,588 - handlers.product_sync_handler - ERROR - Database error while syncing products: could not translate host name "ep-autumn-flower-a8gfew31-pooler.eastus2.azure.neon.tech" to address: Name or service not known

2025-09-02 16:10:21,946 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-02 16:10:21,949 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:15:18,121 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:15:19,141 - __main__ - ERROR - Import error: No module named 'services.session_manager'
2025-09-03 19:15:39,190 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:15:39,785 - __main__ - ERROR - Import error: No module named 'services.session_manager'
2025-09-03 19:15:54,480 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:15:56,323 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:15:58,179 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:15:58,370 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:16:00,080 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:16:00,270 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:16:00,277 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:16:00,278 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:16:00,295 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:16:00,294 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:16:00,297 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:16:00,300 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:16:00,302 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:16:00,303 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:16:00,305 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:16:01,820 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:16:01,856 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:16:02,070 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:16:04,099 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:16:04,289 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:16:04,290 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:16:04,290 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:16:04,290 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:16:04,290 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:16:04,291 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:16:04,292 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:16:04,293 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:16:04,293 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:16:04,293 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:16:04,294 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:16:04,883 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:16:04,884 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:16:04,884 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:16:04,885 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:16:04,886 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:16:04,886 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:16:04,943 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:16:04,945 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:18:46,082 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:18:46,082 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:19:23,313 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:19:25,004 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:19:26,548 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:19:26,739 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:19:28,441 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:19:28,639 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:19:28,640 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:19:28,640 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:19:28,642 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:19:28,642 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:19:28,642 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:19:28,643 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:19:28,643 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:19:28,644 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:19:28,644 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:19:30,153 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:19:30,179 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:19:30,380 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:19:32,109 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:19:32,301 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:19:32,301 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:19:32,301 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:19:32,302 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:19:32,302 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:19:32,302 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:19:32,313 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:19:32,314 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:19:32,314 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:19:32,314 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:19:32,315 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:19:32,848 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:19:32,848 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:19:32,848 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:19:32,849 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:19:32,849 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:19:32,849 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:19:32,866 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:19:32,866 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:19:33,137 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:19:33,138 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:19:34,659 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:19:35,998 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:19:34.850267+00:00, interaction_count=239, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:19:36,579 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:19:36,580 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:19:36,580 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:19:38,119 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:19:38,309 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:19:38,309 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:19:38,310 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-03 19:19:38,310 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:19:39,718 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJBN0M0NzE0OEE0NjcyMkQyMAA="}]}
2025-09-03 19:19:39,720 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:19:40,669 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0MjM5QjcxRURFNDNCMUZGQQA="}]}
2025-09-03 19:19:40,670 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0MjM5QjcxRURFNDNCMUZGQQA='}]}
2025-09-03 19:19:40,682 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:40] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:42,319 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:42,853 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:42,919 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:43,501 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:43] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:45,391 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:19:46,921 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:19:48,249 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:19:47.108529+00:00, interaction_count=240, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:19:48,818 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:19:48,819 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:19:48,820 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:19:48,820 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:19:48,821 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:19:48,821 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:19:48,821 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:19:48,822 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:19:48,822 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:19:50,259 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEwQzFFODIzNTg3MERCMENDOQA="}]}
2025-09-03 19:19:50,260 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:19:50,261 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:19:51,199 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYzRDNFNTExMTI3QjlBMENGOQA="}]}
2025-09-03 19:19:51,199 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYzRDNFNTExMTI3QjlBMENGOQA='}]}
2025-09-03 19:19:51,200 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:51] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:52,317 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:52,929 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:53,050 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:53,082 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:53,301 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:53,460 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:19:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:19:58,886 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-03 19:20:00,408 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:01,940 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:00.599076+00:00, interaction_count=241, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:02,508 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:02,509 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:20:02,509 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:20:02,510 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-03 19:20:06,541 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:20:06,557 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:20:07,649 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ0RUE3MEI0ODdGQkRDMzFFMQA="}]}
2025-09-03 19:20:07,650 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ0RUE3MEI0ODdGQkRDMzFFMQA='}]}
2025-09-03 19:20:07,651 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:08,659 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:09,452 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:09] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:11,091 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:20:12,658 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:14,009 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:12.848838+00:00, interaction_count=242, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:14,578 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:14,579 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:20:14,579 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:20:14,579 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:20:14,580 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:20:14,580 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:20:14,580 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:20:14,581 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:20:14,590 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:20:15,519 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE4REUyN0I3M0MzQzBEQzM4RAA="}]}
2025-09-03 19:20:16,754 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:16,833 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:17,058 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:17,087 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:18,410 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:17.249574+00:00, interaction_count=243, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:18,531 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:20:19,078 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:19,098 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:20:19,098 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE4REUyN0I3M0MzQzBEQzM4RAA='}]}
2025-09-03 19:20:19,099 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:19] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:20,070 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:21,418 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:20.269444+00:00, interaction_count=244, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:21,988 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:21,989 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:20:21,989 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:20:21,990 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:20:21,990 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:20:22,003 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:20:22,929 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwQkY2QTEwQUI1NDg5NTU2OQA="}]}
2025-09-03 19:20:24,179 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:24,451 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:24,530 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:24,926 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:26,060 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:20:26,273 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:25.118571+00:00, interaction_count=245, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:26,848 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:26,855 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:20:26,855 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwQkY2QTEwQUI1NDg5NTU2OQA='}]}
2025-09-03 19:20:26,856 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:27,590 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:28,968 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:27.782368+00:00, interaction_count=246, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:29,582 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:29,583 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:20:29,583 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:20:29,584 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:20:29,584 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_address_handler' with message 'initiate_address_collection'.
2025-09-03 19:20:29,584 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'location_address_handler', state 'address_collection_menu', message 'initiate_address_collection'. Resetting to greeting.
2025-09-03 19:20:29,585 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:20:29,585 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-03 19:20:29,585 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:20:30,711 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0OEQ2M0JBMjBENEQ2Q0VCOAA="}]}
2025-09-03 19:20:30,712 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:20:31,875 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:32,271 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4NUEzQjA2QTgzQ0ZFOTZEMwA="}]}
2025-09-03 19:20:32,491 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:33,359 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:33,561 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:33,682 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:20:33,798 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:20:35,128 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:20:33.990595+00:00, interaction_count=247, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:20:35,709 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:20:35,716 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:20:35,717 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4NUEzQjA2QTgzQ0ZFOTZEMwA='}]}
2025-09-03 19:20:35,717 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:20:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:46,707 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:21:48,349 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:21:49,698 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:21:48.538034+00:00, interaction_count=248, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:21:50,257 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:21:50,258 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:21:50,258 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:21:50,259 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:21:50,259 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:21:50,259 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-03 19:21:50,259 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:21:51,278 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFM0M3NDk2MTFERjI0QTAyRQA="}]}
2025-09-03 19:21:51,279 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:21:52,259 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1QkVDNzlFRUI1N0NFRTdEMgA="}]}
2025-09-03 19:21:52,260 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1QkVDNzlFRUI1N0NFRTdEMgA='}]}
2025-09-03 19:21:52,260 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:52,502 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:53,271 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:53,508 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:21:53,921 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:21:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:16,695 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:22:16,696 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:22:30,286 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:22:31,562 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:22:33,107 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:22:33,298 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:22:34,999 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:22:35,182 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:22:35,182 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:22:35,183 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:22:35,184 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:22:35,184 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:22:35,185 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:22:35,185 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:22:35,186 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:22:35,186 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:22:35,186 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:22:36,697 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:22:36,707 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:22:36,898 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:22:38,648 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:22:38,838 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:22:38,839 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:22:38,839 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:22:38,839 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:22:38,840 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:22:38,840 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:22:38,841 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:22:38,841 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:22:38,841 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:22:38,842 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:22:38,842 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:22:39,217 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:22:39,217 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:22:39,218 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:22:39,218 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:22:39,219 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:22:39,219 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:22:39,239 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:22:39,239 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:22:39,921 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:39] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:40,102 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:22:40,102 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:22:41,119 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:41,608 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:22:42,925 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:22:41.797908+00:00, interaction_count=249, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:22:43,497 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:22:43,497 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:22:43,498 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:22:45,114 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:22:45,308 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:22:45,308 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:22:45,308 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-03 19:22:45,309 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:22:46,418 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCNjFDRTM0M0E4M0EzM0YyMQA="}]}
2025-09-03 19:22:46,419 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:22:47,279 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0NDVFMTBFRTlFNUNDMzUyMgA="}]}
2025-09-03 19:22:47,280 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI0NDVFMTBFRTlFNUNDMzUyMgA='}]}
2025-09-03 19:22:47,280 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:47,805 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,479 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,601 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,659 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,930 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:48,979 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:49,839 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:22:51,468 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:22:52,788 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:22:51.661628+00:00, interaction_count=250, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:22:53,348 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:22:53,349 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:22:53,349 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:22:53,350 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:22:53,350 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:22:53,350 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:22:53,351 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:22:53,351 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:22:53,351 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:22:54,448 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI1RUNERTE4OUMyNTIwMTkwRAA="}]}
2025-09-03 19:22:54,449 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:22:54,449 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:22:55,409 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVENDYwMUI0Q0NBMjY3Q0YyOAA="}]}
2025-09-03 19:22:55,410 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVENDYwMUI0Q0NBMjY3Q0YyOAA='}]}
2025-09-03 19:22:55,411 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:55] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:55,704 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:55] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:56,479 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:56,598 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:56,760 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:56,990 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:22:57,018 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:22:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:00,078 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-03 19:23:01,612 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:02,938 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:01.808502+00:00, interaction_count=251, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:03,496 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:03,497 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:03,497 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:03,498 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-03 19:23:06,048 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:23:06,057 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:07,048 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlCQzM1RDQ0QkVERTVEM0RGMQA="}]}
2025-09-03 19:23:07,049 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlCQzM1RDQ0QkVERTVEM0RGMQA='}]}
2025-09-03 19:23:07,050 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:08,279 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:08,500 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:08,601 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:09,701 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:23:11,268 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:12,598 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:11.458066+00:00, interaction_count=252, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:13,167 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:13,168 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:13,168 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:13,169 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:23:13,169 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:23:13,169 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:23:13,170 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:23:13,170 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:23:13,177 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:14,190 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyMTQ3ODVGQjEzNTIyMUQxMwA="}]}
2025-09-03 19:23:15,159 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:15,502 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:15,718 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:15,860 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:17,044 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:15.908193+00:00, interaction_count=253, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:17,621 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:17,628 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:23:17,628 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyMTQ3ODVGQjEzNTIyMUQxMwA='}]}
2025-09-03 19:23:17,629 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:17,691 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:23:19,199 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:20,527 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:19.388644+00:00, interaction_count=254, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:21,128 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:21,129 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:21,129 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:21,129 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:23:21,130 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:23:21,142 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:22,048 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5QzNCNDZFODVGQzM2RUQxOAA="}]}
2025-09-03 19:23:23,119 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:23,567 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:23,641 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:24,889 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:23:24,898 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:23.757667+00:00, interaction_count=255, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:25,598 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:25,605 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:23:25,605 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5QzNCNDZFODVGQzM2RUQxOAA='}]}
2025-09-03 19:23:25,605 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:26,448 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:27,779 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:26.638260+00:00, interaction_count=256, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:28,347 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:28,348 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:28,348 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:28,349 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:23:28,349 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:23:28,349 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-03 19:23:28,355 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:29,288 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE2ODcyQzQyNUZDQjlDOTE1NwA="}]}
2025-09-03 19:23:30,244 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:30,659 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:30,781 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:30,808 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:32,138 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:31.000949+00:00, interaction_count=257, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:32,787 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:32,794 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:23:32,794 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE2ODcyQzQyNUZDQjlDOTE1NwA='}]}
2025-09-03 19:23:32,795 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:35,494 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_palmpay_salvation'}
2025-09-03 19:23:37,018 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:38,348 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:37.209081+00:00, interaction_count=258, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:39,138 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:39,139 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:23:39,139 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:23:39,140 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'location_address_handler', state 'address_collection_menu', message 'preset_palmpay_salvation'. Resetting to greeting.
2025-09-03 19:23:39,140 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:23:39,141 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-03 19:23:39,141 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:23:40,197 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBMDVFOEQwNjJDMzczRjExNQA="}]}
2025-09-03 19:23:40,198 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:23:41,088 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBNTVGNTg3RDQ1ODFFODIzRAA="}]}
2025-09-03 19:23:41,395 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,173 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,300 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,369 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,479 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:42,638 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:23:42,658 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:23:43,987 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:23:42.829311+00:00, interaction_count=259, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:23:44,557 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:23:44,564 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:23:44,564 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBNTVGNTg3RDQ1ODFFODIzRAA='}]}
2025-09-03 19:23:44,565 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:23:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:24:35,269 - handlers.webhook_handler - WARNING - No valid message data extracted for 2348055614455. Message type: sticker
2025-09-03 19:24:35,269 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:24:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:24:40,838 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:24:40,839 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:27:57,492 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:27:59,141 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:28:00,957 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:28:01,157 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:28:02,897 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:28:03,088 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:28:03,088 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:28:03,089 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:28:03,090 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:28:03,090 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:28:03,090 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:28:03,091 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:28:03,091 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:28:03,092 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:28:03,092 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:28:04,606 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:28:04,607 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:28:04,797 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:28:06,499 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:28:06,688 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:28:06,688 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:28:06,688 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:28:06,689 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:28:06,689 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:28:06,689 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:28:06,691 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:28:06,691 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:28:06,691 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:28:06,692 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:28:06,692 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:28:07,106 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:28:07,107 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:28:07,107 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:28:07,108 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:28:07,108 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:28:07,109 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:28:07,145 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:28:07,146 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:28:07,620 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:28:07,620 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:28:09,139 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:10,497 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:09.327268+00:00, interaction_count=260, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:11,067 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:11,068 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:28:11,068 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:12,597 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:28:12,787 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:28:12,788 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:28:12,788 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-09-03 19:28:12,789 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:28:13,918 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY3OEM2MjUyN0E1MDJERUNGNQA="}]}
2025-09-03 19:28:13,929 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:15,078 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:15,077 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM0QkMzQkQ0MjFBNzQ5REFENgA="}]}
2025-09-03 19:28:15,080 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM0QkMzQkQ0MjFBNzQ5REFENgA='}]}
2025-09-03 19:28:15,081 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,008 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,145 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,309 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,417 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:16,748 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:17,467 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:28:18,996 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:20,317 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:19.186964+00:00, interaction_count=261, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:21,987 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:21,987 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:21,988 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:21,988 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:28:21,988 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:28:21,989 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:28:21,989 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:28:21,989 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:28:21,990 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:28:22,997 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI2RjdDNjE1NUVBNDFBMDQ1QwA="}]}
2025-09-03 19:28:22,998 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:28:22,998 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:28:23,869 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4NEUzMjc2MjA2MTBGNjMyNgA="}]}
2025-09-03 19:28:23,870 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4NEUzMjc2MjA2MTBGNjMyNgA='}]}
2025-09-03 19:28:23,870 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:24,058 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:24,927 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:25,018 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:25,150 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:25,448 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:25,809 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:27,289 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-03 19:28:28,827 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:30,161 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:29.016547+00:00, interaction_count=262, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:30,726 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:30,727 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:30,727 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:30,728 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-03 19:28:33,308 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:28:33,321 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:34,197 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ3MjcxMkE5Nzg3MEM5Njc1RQA="}]}
2025-09-03 19:28:34,198 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ3MjcxMkE5Nzg3MEM5Njc1RQA='}]}
2025-09-03 19:28:34,199 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:35,243 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:35,542 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:35,708 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:40,059 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:28:41,587 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:42,917 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:41.776460+00:00, interaction_count=263, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:43,486 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:43,487 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:43,487 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:43,487 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:28:43,488 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:28:43,488 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:28:43,488 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:28:43,488 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:28:43,494 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:44,408 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzQTE3NEM1RDQwMEM1REU2OAA="}]}
2025-09-03 19:28:45,413 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:45,708 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:45,938 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:45,959 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:47,069 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:28:47,287 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:46.137315+00:00, interaction_count=264, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:47,857 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:47,877 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:28:47,878 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzQTE3NEM1RDQwMEM1REU2OAA='}]}
2025-09-03 19:28:47,878 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:48,597 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:49,927 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:48.787298+00:00, interaction_count=265, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:50,517 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:50,518 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:50,518 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:50,518 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:28:50,519 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'type_address_manually', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:28:50,531 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:51,447 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNFQkMzRERBOTBBRjM0MzAzMwA="}]}
2025-09-03 19:28:52,748 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:52,969 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:53,006 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:53,089 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:54,347 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:53.187680+00:00, interaction_count=266, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:54,917 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:54,924 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:28:54,924 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNFQkMzRERBOTBBRjM0MzAzMwA='}]}
2025-09-03 19:28:54,924 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:28:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:28:55,080 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:28:56,607 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:28:57,947 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:28:56.797303+00:00, interaction_count=267, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:28:58,517 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:28:58,518 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:28:58,518 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:28:58,518 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:28:58,519 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:28:58,519 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-03 19:28:58,525 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:28:59,427 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDNUI4Nzg5NkQ3OENFOUZEMAA="}]}
2025-09-03 19:29:00,487 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:00,926 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:00,941 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:01,057 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:02,417 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:01.246731+00:00, interaction_count=268, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:02,986 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:02,992 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:29:02,992 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDNUI4Nzg5NkQ3OENFOUZEMAA='}]}
2025-09-03 19:29:02,993 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:02] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:03,228 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-03 19:29:04,758 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:06,120 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:04.947170+00:00, interaction_count=269, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:06,717 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:06,718 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:29:06,718 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:29:08,516 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:29:08,517 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-03 19:29:08,517 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-03 19:29:08,518 - handlers.location_address_handler - INFO - Redirecting back to order confirmation after address update for session 2348055614455
2025-09-03 19:29:10,227 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:29:10,228 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-03 19:29:10,228 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'show_order_confirmation_after_address_update'.
2025-09-03 19:29:10,245 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:29:11,278 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFRTdEQUEzMTU0NzcxQ0QwRAA="}]}
2025-09-03 19:29:12,573 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:12] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:12,787 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:12] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:12,847 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:12,850 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:12] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:14,187 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:13.047260+00:00, interaction_count=270, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:14,747 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:14,753 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:29:14,754 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFRTdEQUEzMTU0NzcxQ0QwRAA='}]}
2025-09-03 19:29:14,754 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:14] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:51,808 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:29:53,427 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:54,766 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:53.616691+00:00, interaction_count=271, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:55,336 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:55,337 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:29:55,337 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:29:55,338 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:29:55,338 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:29:55,338 - handlers.location_address_handler - INFO - Received update_address redirect from order handler for session 2348055614455
2025-09-03 19:29:55,344 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:29:56,347 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM4QUJENTg5NTBBMEIyNzE3MAA="}]}
2025-09-03 19:29:57,397 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:57,728 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:57,886 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:29:58,238 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:58] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:29:59,246 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:29:58.096806+00:00, interaction_count=272, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:29:59,816 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:29:59,822 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:29:59,822 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM4QUJENTg5NTBBMEIyNzE3MAA='}]}
2025-09-03 19:29:59,823 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:29:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:30:36,297 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:30:36,298 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:32:08,076 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:32:09,623 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:32:11,245 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:32:11,447 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:32:13,147 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:32:13,337 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:32:13,338 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:32:13,338 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:32:13,339 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:32:13,340 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:32:13,340 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:32:13,341 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:32:13,341 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:32:13,342 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:32:13,348 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:32:14,855 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:32:14,868 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:32:15,056 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:32:16,756 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:32:16,947 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:32:16,947 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:32:16,947 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:32:16,947 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:32:16,948 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:32:16,948 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:32:16,948 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:32:16,949 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:32:16,949 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:32:16,949 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:32:16,950 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:32:17,355 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:32:17,355 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:32:17,355 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:32:17,356 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:32:17,356 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:32:17,356 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:32:17,368 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:32:17,369 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:33:24,258 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hell'}
2025-09-03 19:33:24,258 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:33:26,068 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:33:27,418 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:33:26.266539+00:00, interaction_count=273, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:33:27,995 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:33:27,997 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:33:27,997 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:33:29,558 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:33:29,756 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:33:29,757 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-03 19:33:29,757 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:33:30,857 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJFNDA0QzY3ODQ0RDcxNUU3MQA="}]}
2025-09-03 19:33:30,858 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:33:31,854 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNGRDg4OUQ1NThENzk3ODI5MQA="}]}
2025-09-03 19:33:31,855 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNGRDg4OUQ1NThENzk3ODI5MQA='}]}
2025-09-03 19:33:31,856 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:32,407 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,026 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,073 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,308 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,510 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:33,529 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:37,398 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:33:38,938 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:33:41,231 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:33:39.129210+00:00, interaction_count=274, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:33:41,796 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:33:41,797 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:33:41,797 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:33:41,797 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:33:41,798 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:33:41,798 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:33:41,798 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:33:41,799 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:33:41,799 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:33:42,851 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBGOThBMTNDN0Q3NDFFQzk1MwA="}]}
2025-09-03 19:33:42,851 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:33:42,852 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:33:43,726 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwRjg1MTdENzYxNzcyODg0MAA="}]}
2025-09-03 19:33:43,727 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQwRjg1MTdENzYxNzcyODg0MAA='}]}
2025-09-03 19:33:43,728 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:43] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:44,713 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,220 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,287 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,338 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,639 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:45,658 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:46,858 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-03 19:33:48,355 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:33:49,696 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:33:48.546585+00:00, interaction_count=275, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:33:50,265 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:33:50,266 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:33:50,266 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:33:50,266 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-03 19:33:53,457 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:33:53,466 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:33:54,498 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3MUY4N0Y4MjdBN0M4NkI5QgA="}]}
2025-09-03 19:33:54,499 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3MUY4N0Y4MjdBN0M4NkI5QgA='}]}
2025-09-03 19:33:54,500 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:55,602 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:55] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:56,032 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:56,192 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:33:56] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:33:58,228 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:33:59,756 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:01,106 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:33:59.946419+00:00, interaction_count=276, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:01,686 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:01,687 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:34:01,687 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:34:01,688 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:34:01,688 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:34:01,689 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:34:01,689 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:34:01,689 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:34:01,696 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:34:02,886 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgxQTUxNzAwRUZFOEIwNUI1OQA="}]}
2025-09-03 19:34:03,881 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:03] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:04,268 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:04] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:04,391 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:04] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:04,455 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:05,606 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:34:05,796 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:04.656137+00:00, interaction_count=277, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:06,357 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:06,364 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:34:06,364 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgxQTUxNzAwRUZFOEIwNUI1OQA='}]}
2025-09-03 19:34:06,365 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:06] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:07,167 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:08,516 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:07.356318+00:00, interaction_count=278, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:09,086 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:09,087 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:34:09,087 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:34:09,087 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:34:09,088 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:34:09,102 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:34:10,097 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlBMDdFRDE5QzFGRkI1MzhBMAA="}]}
2025-09-03 19:34:11,146 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:11] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:11,498 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:11] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:11,656 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:11,737 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:11] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:12,688 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:34:13,066 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:11.846165+00:00, interaction_count=279, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:13,618 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:13,624 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:34:13,625 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlBMDdFRDE5QzFGRkI1MzhBMAA='}]}
2025-09-03 19:34:13,625 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:13] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:14,217 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:15,616 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:14.422798+00:00, interaction_count=280, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:16,186 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:16,187 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:34:16,187 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:34:16,187 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:34:16,188 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:34:16,194 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:34:17,137 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwRjMyQzIzQTE5NTFDMjhFRAA="}]}
2025-09-03 19:34:18,088 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:18] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:18,428 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:18] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:18,697 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:18] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:19,586 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:19,629 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-03 19:34:20,916 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:19.776251+00:00, interaction_count=281, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:21,155 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:21,498 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:21,505 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:34:21,514 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwRjMyQzIzQTE5NTFDMjhFRAA='}]}
2025-09-03 19:34:21,515 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:22,555 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:21.347204+00:00, interaction_count=281, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:23,101 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:23,102 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:34:23,102 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:34:24,878 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:34:24,879 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-03 19:34:24,879 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-03 19:34:24,880 - handlers.location_address_handler - INFO - Redirecting back to order confirmation after address update for session 2348055614455
2025-09-03 19:34:26,616 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:34:26,617 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-03 19:34:26,617 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'show_order_confirmation_after_address_update'.
2025-09-03 19:34:26,618 - handlers.order_handler - INFO - Showing order confirmation after address update for session 2348055614455
2025-09-03 19:34:26,618 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:34:26,629 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:34:27,576 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyMzc2RDREN0QyNjEzRUY2QgA="}]}
2025-09-03 19:34:28,652 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:29,006 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:29] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:29,030 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:29] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:34:29,116 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:34:30,567 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:34:29.306186+00:00, interaction_count=283, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:34:31,168 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:34:31,175 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:34:31,175 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyMzc2RDREN0QyNjEzRUY2QgA='}]}
2025-09-03 19:34:31,176 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:34:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:07,056 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:35:07,057 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:35:09,708 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:35:10,899 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:35:12,586 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:35:12,782 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:35:14,512 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:35:14,768 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:35:14,769 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:35:14,769 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:35:14,770 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:35:14,771 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:35:14,771 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:35:14,772 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:35:14,772 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:35:14,773 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:35:14,773 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:35:16,295 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:35:16,340 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:35:16,576 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:35:18,296 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:35:18,486 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:35:18,487 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:35:18,487 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:35:18,487 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:35:18,487 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:35:18,488 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:35:18,488 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:35:18,489 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:35:18,489 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:35:18,489 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:35:18,490 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:35:18,874 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:35:18,874 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:35:18,874 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:35:18,875 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:35:18,875 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:35:18,876 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:35:18,890 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:35:18,890 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:35:22,977 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:35:22,978 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:35:24,486 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:35:25,826 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:35:24.676006+00:00, interaction_count=284, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:35:26,396 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:35:26,397 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:35:26,397 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:35:27,984 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:35:28,176 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:35:28,176 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:35:28,177 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 19:35:28,177 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:35:29,258 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNCQUI5RjlCRjZCNDBERTZCNQA="}]}
2025-09-03 19:35:29,259 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:35:30,196 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEOERFOERENkExODFFRTk5NgA="}]}
2025-09-03 19:35:30,197 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEOERFOERENkExODFFRTk5NgA='}]}
2025-09-03 19:35:30,198 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:30,476 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:31,317 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:31,349 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:31,372 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:31,758 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:31] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:32,019 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:35:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:35:44,709 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:35:44,709 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:38:20,500 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:38:22,658 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:38:25,474 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:38:25,664 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:38:27,577 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:38:27,776 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:38:27,777 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:38:27,778 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:38:27,779 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:38:27,780 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:38:27,780 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:38:27,781 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:38:27,781 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:38:27,782 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:38:27,782 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:38:29,298 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:38:29,305 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:38:29,485 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:38:31,215 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:38:31,405 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:38:31,406 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:38:31,406 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:38:31,407 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:38:31,407 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:38:31,407 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:38:31,418 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:38:31,418 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:38:31,419 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:38:31,419 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:38:31,419 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:38:31,961 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:38:31,962 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:38:31,963 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:38:31,964 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:38:31,964 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:38:31,964 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:38:31,998 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:38:31,998 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:39:13,140 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:39:13,140 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:39:15,190 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:39:16,386 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:39:17,954 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:39:18,136 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:39:19,866 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:39:20,056 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:39:20,056 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:39:20,057 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:39:20,058 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:39:20,058 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:39:20,059 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:39:20,059 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:39:20,059 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:39:20,060 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:39:20,060 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:39:21,537 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:39:21,567 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:39:21,735 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:39:23,456 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:39:23,645 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:39:23,646 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:39:23,646 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:39:23,647 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:39:23,647 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:39:23,647 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:39:23,648 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:39:23,648 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:39:23,649 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:39:23,649 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:39:23,649 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:39:24,169 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:39:24,169 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:39:24,169 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:39:24,170 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:39:24,170 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:39:24,170 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:39:24,191 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:39:24,191 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:39:24,857 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:39:24,858 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:39:26,399 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:39:27,736 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:39:26.585561+00:00, interaction_count=285, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:39:28,335 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:39:28,336 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:39:28,336 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:39:29,865 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:39:30,054 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:39:30,055 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:39:30,055 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 19:39:30,056 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:39:31,126 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNFQTk5RDZFRTM0RUYwRDA4OQA="}]}
2025-09-03 19:39:31,127 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:39:32,146 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEMUI4RDI2NDVFNzZCRjBENwA="}]}
2025-09-03 19:39:32,147 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEMUI4RDI2NDVFNzZCRjBENwA='}]}
2025-09-03 19:39:32,158 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:32,525 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,148 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,165 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,337 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,515 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:39:33,758 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:39:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:42:01,067 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:42:01,067 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:44:05,774 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:44:06,969 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:44:08,653 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:44:08,844 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:44:10,574 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:44:10,766 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:44:10,766 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:44:10,767 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:44:10,768 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:44:10,768 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:44:10,769 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:44:10,769 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:44:10,770 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:44:10,770 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:44:10,770 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:44:12,273 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:44:12,286 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:44:12,464 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:44:14,224 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:44:14,415 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:44:14,415 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:44:14,416 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:44:14,416 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:44:14,416 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:44:14,417 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:44:14,417 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:44:14,418 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:44:14,418 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:44:14,418 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:44:14,419 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:44:14,796 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:44:14,796 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:44:14,796 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:44:14,797 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:44:14,797 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:44:14,798 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:44:14,810 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:44:14,811 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:44:28,067 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:44:28,067 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:45:25,604 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:45:26,960 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:45:28,525 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:45:28,713 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:45:30,434 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:45:30,624 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:45:30,624 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:45:30,625 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:45:30,626 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:45:30,626 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:45:30,626 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:45:30,627 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:45:30,627 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:45:30,628 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:45:30,628 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:45:32,146 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:45:32,163 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:45:32,354 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:45:34,084 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:45:34,274 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:45:34,274 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:45:34,275 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:45:34,275 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:45:34,275 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:45:34,276 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:45:34,276 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:45:34,276 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:45:34,277 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:45:34,277 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:45:34,278 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:45:34,662 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:45:34,662 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:45:34,663 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:45:34,663 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:45:34,664 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:45:34,664 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:45:34,678 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:45:34,678 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:45:42,010 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hell hello'}
2025-09-03 19:45:42,010 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:45:43,635 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:45:44,965 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:45:43.823836+00:00, interaction_count=286, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:45:45,534 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:45:45,535 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:45:45,535 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:45:47,116 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:45:47,326 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:45:47,327 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-09-03 19:45:47,327 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:45:48,595 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2RUY4QUMxQUNDMDRCODMzQQA="}]}
2025-09-03 19:45:48,596 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:45:49,414 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM4Rjg3QUZCMjYyQTY5Q0M4RQA="}]}
2025-09-03 19:45:49,415 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM4Rjg3QUZCMjYyQTY5Q0M4RQA='}]}
2025-09-03 19:45:49,416 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:50,491 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:50,937 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:50,996 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:51,126 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:51] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:51,406 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:51] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:51,637 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:51] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:52,634 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:45:54,183 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:45:55,975 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:45:54.374430+00:00, interaction_count=287, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:45:56,633 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:45:56,634 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:45:56,634 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:45:56,635 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:45:56,635 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:45:56,635 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:45:56,635 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:45:56,636 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:45:56,636 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:45:57,876 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM1NEM2OUEyQUNCN0ZGNjgyRgA="}]}
2025-09-03 19:45:57,877 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:45:57,878 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:45:58,765 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgxQzE5QUU5QjJBMjI0RjU1NgA="}]}
2025-09-03 19:45:58,766 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgxQzE5QUU5QjJBMjI0RjU1NgA='}]}
2025-09-03 19:45:58,767 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:58] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:45:59,710 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:45:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,387 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,405 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,687 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,756 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:00,795 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:08,794 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-03 19:46:10,324 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:11,674 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:10.513868+00:00, interaction_count=288, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:12,243 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:12,245 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:46:12,246 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:46:12,247 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-03 19:46:15,215 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:46:15,233 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:46:16,474 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4RUMyRDQ4RDI3RUU0MTQ3QwA="}]}
2025-09-03 19:46:16,474 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4RUMyRDQ4RDI3RUU0MTQ3QwA='}]}
2025-09-03 19:46:16,476 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:16] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:17,541 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:17,945 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:17,997 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:17] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:19,886 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:46:21,423 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:22,843 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:21.613356+00:00, interaction_count=289, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:23,433 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:23,434 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:46:23,434 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:46:23,434 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:46:23,435 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:46:23,435 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:46:23,435 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:46:23,436 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:46:23,448 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:46:24,835 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3RUJBNTUzRjg0ODEzMDE5QgA="}]}
2025-09-03 19:46:26,000 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:26,176 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:26,414 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:26,656 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:27,765 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:26.605929+00:00, interaction_count=290, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:27,974 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:46:28,333 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:28,353 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:46:28,353 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3RUJBNTUzRjg0ODEzMDE5QgA='}]}
2025-09-03 19:46:28,354 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:29,506 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:30,864 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:29.694154+00:00, interaction_count=291, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:31,464 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:31,465 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:46:31,465 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:46:31,465 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:46:31,466 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:46:31,480 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:46:33,194 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBRjVBNzg3QTk4OUZDMzJGQgA="}]}
2025-09-03 19:46:34,166 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:34,497 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:34,685 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:34,734 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:36,134 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:34.923755+00:00, interaction_count=292, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:36,266 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 19:46:36,733 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:36,740 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:46:36,740 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBRjVBNzg3QTk4OUZDMzJGQgA='}]}
2025-09-03 19:46:36,741 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:36] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:37,795 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:39,144 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:37.983571+00:00, interaction_count=293, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:39,714 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:39,715 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:46:39,715 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:46:39,715 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-09-03 19:46:39,716 - handlers.order_handler - ERROR - Failed to save order ORD-9B633AD3 for session 2348055614455: 'DataManager' object has no attribute 'save_order'
2025-09-03 19:46:39,716 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:46:40,694 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlERkI2MjVGM0Y2NjE0MzAzMwA="}]}
2025-09-03 19:46:41,710 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:42,176 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:42,223 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:46:42,346 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:46:43,544 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:46:42.423565+00:00, interaction_count=294, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:46:44,113 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:46:44,119 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:46:44,119 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlERkI2MjVGM0Y2NjE0MzAzMwA='}]}
2025-09-03 19:46:44,120 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:46:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:03,031 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:48:03,032 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:48:05,320 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:48:06,785 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:48:08,423 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:48:08,623 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:48:10,364 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:48:10,565 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:48:10,567 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:48:10,568 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:48:10,570 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:48:10,571 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:48:10,573 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:48:10,574 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:48:10,575 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:48:10,576 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:48:10,576 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:48:12,139 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:48:12,145 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:48:12,334 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:48:14,096 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:48:14,299 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:48:14,299 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:48:14,299 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:48:14,299 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:48:14,300 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:48:14,300 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:48:14,300 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:48:14,301 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:48:14,301 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:48:14,301 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:48:14,302 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:48:14,746 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:48:14,746 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:48:14,746 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:48:14,747 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:48:14,747 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:48:14,747 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:48:14,761 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:48:14,761 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:48:37,231 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:48:37,232 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:48:38,823 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:48:40,219 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:48:39.015214+00:00, interaction_count=295, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:48:40,818 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:48:40,819 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:48:40,819 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:48:42,424 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:48:42,613 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:48:42,614 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:48:42,614 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 19:48:42,614 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:48:43,735 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJCMzNEM0VCQzI1QTc2QkQ5RQA="}]}
2025-09-03 19:48:43,736 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:48:44,853 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFEMjBEQUM3ODEyNzM2MjExOAA="}]}
2025-09-03 19:48:44,854 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFEMjBEQUM3ODEyNzM2MjExOAA='}]}
2025-09-03 19:48:44,855 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:44,989 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:45,365 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:46,083 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:46] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:46,197 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:46] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:46,321 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:46] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:46,336 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:46] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:47,457 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:48:48,983 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:48:50,353 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:48:49.183823+00:00, interaction_count=296, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:48:50,943 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:48:50,944 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:48:50,944 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:48:50,945 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:48:50,945 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:48:50,945 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:48:50,946 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:48:50,946 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:48:50,946 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:48:51,973 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4MzRGQjdBNTcwNDRFQTcxQgA="}]}
2025-09-03 19:48:51,974 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:48:51,974 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:48:52,844 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg1MkQ5MjkzNkMxNzZBQjM0MQA="}]}
2025-09-03 19:48:52,845 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg1MkQ5MjkzNkMxNzZBQjM0MQA='}]}
2025-09-03 19:48:52,846 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:53,254 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:53,946 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:53,964 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:54,274 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:54,346 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:54,574 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:48:54] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:48:59,604 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-03 19:49:01,153 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:02,742 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:01.589091+00:00, interaction_count=297, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:03,303 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:03,303 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:49:03,304 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:49:03,304 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-03 19:49:06,536 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:49:06,545 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:49:07,473 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNBMTlGRDQwMUYyOEZDMzc2NAA="}]}
2025-09-03 19:49:07,474 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNBMTlGRDQwMUYyOEZDMzc2NAA='}]}
2025-09-03 19:49:07,475 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:08,521 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:08,976 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:09,107 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:09] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:15,369 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:49:17,154 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:18,504 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:17.353009+00:00, interaction_count=298, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:19,074 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:19,075 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:49:19,076 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:49:19,076 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:49:19,076 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:49:19,077 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:49:19,077 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:49:19,077 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:49:19,083 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:49:20,053 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3ODM1RTA4OTkzRTQwMzcwRgA="}]}
2025-09-03 19:49:21,241 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:21,316 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:21,583 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:21,666 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:22,706 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:49:22,923 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:21.783328+00:00, interaction_count=299, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:23,493 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:23,500 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:49:23,500 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3ODM1RTA4OTkzRTQwMzcwRgA='}]}
2025-09-03 19:49:23,501 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:24,215 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:25,554 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:24.403828+00:00, interaction_count=300, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:26,123 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:26,124 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:49:26,124 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:49:26,124 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:49:26,125 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:49:26,137 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:49:27,114 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJDRDcxQjQwQjhGNzBEQjY1MgA="}]}
2025-09-03 19:49:28,231 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:28,367 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:28,665 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:28] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:28,673 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:30,004 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:28.863471+00:00, interaction_count=301, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:30,573 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:30,579 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:49:30,579 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJDRDcxQjQwQjhGNzBEQjY1MgA='}]}
2025-09-03 19:49:30,580 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:30] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:35,344 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 19:49:36,883 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:38,244 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:37.074966+00:00, interaction_count=302, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=665.0, converted_at=2025-08-31 21:41:19.145497+00:00
2025-09-03 19:49:38,814 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:38,814 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:49:38,815 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:49:38,815 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-09-03 19:49:39,964 - utils.data_manager - ERROR - Unexpected error saving order for customer 2348055614455: 'item_name'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 349, in save_user_order
    product_id = self._get_product_id_by_name(item["item_name"])
                                              ~~~~^^^^^^^^^^^^^
KeyError: 'item_name'
2025-09-03 19:49:39,966 - handlers.order_handler - INFO - Order ORD-66D105DE saved to database for session 2348055614455.
2025-09-03 19:49:39,966 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:49:41,533 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:42,902 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:41.724992+00:00, interaction_count=303, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=order_completed, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:49:43,482 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:43,488 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID ORD-66D105DE
2025-09-03 19:49:43,494 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-09-03 19:49:43,495 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-09-03 19:49:43,495 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-09-03 19:49:45,244 - utils.data_manager - ERROR - Database error retrieving order ORD-66D105DE: invalid input syntax for type bigint: "ORD-66D105DE"
LINE 6:                         WHERE id = 'ORD-66D105DE' AND mercha...
                                           ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 674, in get_order_by_id
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<6 lines>...
        (order_id, self.merchant_id)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type bigint: "ORD-66D105DE"
LINE 6:                         WHERE id = 'ORD-66D105DE' AND mercha...
                                           ^

2025-09-03 19:49:45,247 - handlers.payment_handler - ERROR - Order ORD-66D105DE not found in database for session 2348055614455
2025-09-03 19:49:45,247 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:49:46,284 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI5RTA0Q0FERTdERTBBNjk3NgA="}]}
2025-09-03 19:49:47,390 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:47,606 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:47,795 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:49:47,843 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:49:49,303 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:49:48.153335+00:00, interaction_count=304, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:49:49,872 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:49:49,878 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:49:49,879 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI5RTA0Q0FERTdERTBBNjk3NgA='}]}
2025-09-03 19:49:49,879 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:49:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:51:28,166 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 19:51:28,166 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 19:57:55,476 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 19:57:57,294 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:57:59,411 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:57:59,611 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:58:01,367 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:58:01,562 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:58:01,562 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:58:01,562 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 19:58:01,564 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 19:58:01,564 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:58:01,564 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 19:58:01,565 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:58:01,565 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:58:01,566 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:58:01,566 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 19:58:03,122 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 19:58:03,154 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 19:58:03,311 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 19:58:05,071 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 19:58:05,282 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 19:58:05,283 - services.payment_service - INFO - PaymentService initialized
2025-09-03 19:58:05,283 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 19:58:05,283 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 19:58:05,284 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 19:58:05,284 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 19:58:05,296 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 19:58:05,296 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 19:58:05,297 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 19:58:05,297 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:58:05,297 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:58:05,732 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 19:58:05,732 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 19:58:05,733 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 19:58:05,733 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 19:58:05,733 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 19:58:05,734 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 19:58:05,765 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 19:58:05,766 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 19:58:06,039 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 19:58:06,039 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 19:58:07,602 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:09,131 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:07.802251+00:00, interaction_count=305, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:09,752 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:09,752 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 19:58:09,753 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:11,374 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 19:58:11,573 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 19:58:11,574 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:58:11,574 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 19:58:11,575 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:58:12,691 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJCQ0Y2OTNBQUEwNjZERjlBNQA="}]}
2025-09-03 19:58:12,704 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:13,572 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFFNjA4NUQ5RUZDN0NBOTVGRQA="}]}
2025-09-03 19:58:13,573 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFFNjA4NUQ5RUZDN0NBOTVGRQA='}]}
2025-09-03 19:58:13,574 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:13] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:14,143 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:14] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:14,734 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:14] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:14,943 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:14] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:15,022 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:15,116 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:15,194 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:16,544 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 19:58:18,132 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:19,492 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:18.332453+00:00, interaction_count=306, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:20,071 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:20,072 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:20,072 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:20,073 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 19:58:20,073 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 19:58:20,073 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 19:58:20,074 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 19:58:20,074 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 19:58:20,075 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 19:58:21,114 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEyMUI1OUUxRTI2NUY4RTc0QQA="}]}
2025-09-03 19:58:21,115 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:58:21,115 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 19:58:22,733 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:22] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:22,994 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:22] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:23,065 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:23,111 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFRDZGRjNDN0ZFM0ZDODQ3OAA="}]}
2025-09-03 19:58:23,112 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNFRDZGRjNDN0ZFM0ZDODQ3OAA='}]}
2025-09-03 19:58:23,112 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:24,122 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:24,443 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:24,544 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:26,353 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-09-03 19:58:27,912 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:29,356 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:28.111731+00:00, interaction_count=307, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:29,951 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:29,951 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:29,952 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:29,952 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-09-03 19:58:32,862 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 19:58:32,876 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:33,792 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzODVCMzEyQzgxNjBDRUFENgA="}]}
2025-09-03 19:58:33,793 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzODVCMzEyQzgxNjBDRUFENgA='}]}
2025-09-03 19:58:33,794 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:34,833 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:35,124 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:35,564 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:36,826 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 19:58:38,371 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:39,741 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:38.561453+00:00, interaction_count=308, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:40,331 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:40,332 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:40,333 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:40,333 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 19:58:40,333 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 19:58:40,334 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:58:40,334 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 19:58:40,335 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 19:58:40,341 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:41,812 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwQUMwMTY3MkY4QzVDMTVDNwA="}]}
2025-09-03 19:58:42,822 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:43,114 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:43] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:43,292 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:43] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:43,442 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:44,434 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-03 19:58:44,841 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:43.641220+00:00, interaction_count=309, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:45,411 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:45,417 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:58:45,417 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwQUMwMTY3MkY4QzVDMTVDNwA='}]}
2025-09-03 19:58:45,417 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:45,961 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:47,341 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:46.152508+00:00, interaction_count=310, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:48,021 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:48,022 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:48,022 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:48,022 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-03 19:58:48,023 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:58:48,035 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:48,932 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk1OUJBOERGRDkzOUJDRkYyNgA="}]}
2025-09-03 19:58:49,962 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:50,213 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:50,481 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:50,724 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:51,354 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 19:58:51,833 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:50.682018+00:00, interaction_count=311, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:52,432 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:52,438 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:58:52,438 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk1OUJBOERGRDkzOUJDRkYyNgA='}]}
2025-09-03 19:58:52,439 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:52] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:52,911 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:54,282 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:53.102121+00:00, interaction_count=312, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:54,851 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:54,852 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:58:54,852 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:58:54,853 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 19:58:54,853 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 19:58:54,859 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:58:56,224 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQxN0M3M0YyN0U0QjQ5M0IyQgA="}]}
2025-09-03 19:58:57,207 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:57,702 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:57,823 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:57] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:58:57,831 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:58:59,202 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:58:58.031389+00:00, interaction_count=313, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:58:59,771 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:58:59,778 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:58:59,778 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQxN0M3M0YyN0U0QjQ5M0IyQgA='}]}
2025-09-03 19:58:59,779 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:58:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:03,578 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-03 19:59:05,112 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:59:06,521 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:59:05.301533+00:00, interaction_count=314, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:59:07,141 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:59:07,142 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:59:07,143 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:59:08,951 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:59:08,952 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-03 19:59:08,952 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-03 19:59:08,953 - handlers.location_address_handler - INFO - Redirecting back to order confirmation after address update for session 2348055614455
2025-09-03 19:59:10,721 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 19:59:10,722 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-03 19:59:10,722 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'show_order_confirmation_after_address_update'.
2025-09-03 19:59:10,723 - handlers.order_handler - INFO - Showing order confirmation after address update for session 2348055614455
2025-09-03 19:59:10,723 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 19:59:10,735 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 19:59:11,752 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRDMjUxODgwRTk3MjdDOTYzMAA="}]}
2025-09-03 19:59:12,759 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:12] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:13,173 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:13] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:13,254 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:13] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:13,362 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:59:14,422 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 19:59:14,721 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:59:13.561443+00:00, interaction_count=315, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:59:15,311 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:59:15,317 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:59:15,317 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRDMjUxODgwRTk3MjdDOTYzMAA='}]}
2025-09-03 19:59:15,318 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:15,992 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:59:17,382 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:59:16.193805+00:00, interaction_count=316, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:59:17,991 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:59:17,992 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 19:59:17,992 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 19:59:17,993 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-09-03 19:59:20,791 - utils.data_manager - DEBUG - Found product_id 112 for product_name Jollof Rice
2025-09-03 19:59:21,002 - utils.data_manager - DEBUG - Assigned product_id 112 to item Jollof Rice
2025-09-03 19:59:21,604 - utils.data_manager - ERROR - Database error saving order for customer 2348055614455: null value in column "payment_reference" of relation "whatsapp_orders" violates not-null constraint
DETAIL:  Failing row contains (207, 20, 2348055614455, 1, Howson Wright, pending payment, 665.0, null, paystack, 2025-09-03 18:59:17.993565+00, 2025-09-03 18:59:17.993565+00, 2025-09-03 18:59:17.993565+00, null, , 15.00).
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 357, in save_user_order
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<22 lines>...
        )
        ^
    )
    ^
psycopg2.errors.NotNullViolation: null value in column "payment_reference" of relation "whatsapp_orders" violates not-null constraint
DETAIL:  Failing row contains (207, 20, 2348055614455, 1, Howson Wright, pending payment, 665.0, null, paystack, 2025-09-03 18:59:17.993565+00, 2025-09-03 18:59:17.993565+00, 2025-09-03 18:59:17.993565+00, null, , 15.00).

2025-09-03 19:59:21,616 - handlers.order_handler - ERROR - Failed to save order ORD-E5F2B237 for session 2348055614455: No database ID returned
2025-09-03 19:59:21,617 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 19:59:22,614 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDNzY1OTM5RjlENjA5MkJDQwA="}]}
2025-09-03 19:59:23,678 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:24,143 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:24,174 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 19:59:24,201 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 19:59:25,601 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 18:59:24.394617+00:00, interaction_count=317, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 19:59:26,201 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 19:59:26,208 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 19:59:26,208 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDNzY1OTM5RjlENjA5MkJDQwA='}]}
2025-09-03 19:59:26,209 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 19:59:26] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:20,755 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 20:01:20,755 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-03 20:01:22,513 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-03 20:01:24,303 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 20:01:25,881 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 20:01:26,082 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 20:01:28,153 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 20:01:28,365 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 20:01:28,366 - services.payment_service - INFO - PaymentService initialized
2025-09-03 20:01:28,366 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-03 20:01:28,367 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 20:01:28,368 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 20:01:28,368 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-03 20:01:28,369 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 20:01:28,369 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 20:01:28,369 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 20:01:28,370 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-03 20:01:29,971 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 20:01:29,981 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-03 20:01:30,180 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-03 20:01:32,094 - utils.data_manager - INFO - Successfully loaded 58 user details from database
2025-09-03 20:01:32,302 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-03 20:01:32,303 - services.payment_service - INFO - PaymentService initialized
2025-09-03 20:01:32,303 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-03 20:01:32,303 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-03 20:01:32,303 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-03 20:01:32,304 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-03 20:01:32,315 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-03 20:01:32,316 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-03 20:01:32,316 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-03 20:01:32,316 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 20:01:32,317 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 20:01:32,747 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-03 20:01:32,747 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-03 20:01:32,747 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-03 20:01:32,748 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-03 20:01:32,748 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-03 20:01:32,749 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_u9knhyzn5eq4iop, split percentage 1%, merchant phone 2347082345056
2025-09-03 20:01:32,784 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-03 20:01:32,784 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-03 20:01:32,862 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-03 20:01:32,863 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-03 20:01:34,580 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:01:35,994 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:01:34.802161+00:00, interaction_count=318, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:01:36,751 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:01:36,752 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-03 20:01:36,752 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:01:38,471 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_orders
2025-09-03 20:01:38,681 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-03 20:01:38,681 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:01:38,682 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Location: 6.5864785, 3.3744879
2025-09-03 20:01:38,682 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 20:01:39,771 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc3MUNDRDI0MEI5RkVGNjY2NwA="}]}
2025-09-03 20:01:39,772 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:01:40,681 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4QzE1REEwNEIyNDE0MzY4MgA="}]}
2025-09-03 20:01:40,681 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4QzE1REEwNEIyNDE0MzY4MgA='}]}
2025-09-03 20:01:40,682 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:40] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:40,988 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:40] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:41,723 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:41,834 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:41,945 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:41] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:42,153 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:42,363 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:42] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:43,383 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-03 20:01:44,901 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:01:46,258 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:01:45.083715+00:00, interaction_count=319, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:01:46,841 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:01:46,842 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:01:46,842 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:01:46,843 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-03 20:01:46,843 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-03 20:01:46,843 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-03 20:01:46,843 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-03 20:01:46,844 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-03 20:01:46,844 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-03 20:01:47,932 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEzMTA5NjQ4RDM5REI4RTJGRgA="}]}
2025-09-03 20:01:47,933 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:01:47,933 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-03 20:01:48,841 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMzMEM4RUZCQUI5OTUyNUJGNwA="}]}
2025-09-03 20:01:48,842 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMzMEM4RUZCQUI5OTUyNUJGNwA='}]}
2025-09-03 20:01:48,842 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:48] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:49,288 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:49,853 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:49] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:50,012 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:50,053 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:50,223 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:50,795 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-03 20:01:50,862 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:50] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:52,331 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:01:53,741 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:01:52.521204+00:00, interaction_count=320, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:01:54,366 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:01:54,367 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:01:54,367 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:01:54,368 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-03 20:01:57,372 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-03 20:01:57,395 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:01:58,371 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBDMjg0OTVCQjc0QTFBNzlBQgA="}]}
2025-09-03 20:01:58,371 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBDMjg0OTVCQjc0QTFBNzlBQgA='}]}
2025-09-03 20:01:58,372 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:58] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:59,412 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:01:59,802 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:01:59] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:00,213 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:00] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:01,872 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-03 20:02:03,530 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:04,942 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:03.720652+00:00, interaction_count=321, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:05,581 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:05,582 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:05,582 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:05,582 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-09-03 20:02:05,583 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-03 20:02:05,583 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:02:05,583 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-03 20:02:05,584 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-03 20:02:05,601 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:06,521 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlGQjc1NDA3NzZGNDg3QTE0RgA="}]}
2025-09-03 20:02:07,737 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:07,922 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:07] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:08,073 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:08,132 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:09,383 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-09-03 20:02:09,531 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:08.333326+00:00, interaction_count=322, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:10,133 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:10,142 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:10,143 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlGQjc1NDA3NzZGNDg3QTE0RgA='}]}
2025-09-03 20:02:10,143 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:10] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:10,940 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:12,361 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:11.151451+00:00, interaction_count=323, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:12,971 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:12,972 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:12,972 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:12,972 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-09-03 20:02:12,973 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:02:12,973 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please type your note for the order (e.g., 'Please deliver after 5 PM'). Type 'back' to skip adding a note."}}
2025-09-03 20:02:14,081 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwQzE4RTk1QzIwQjg0RDcxMgA="}]}
2025-09-03 20:02:15,077 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:15,321 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:15,772 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:15] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:15,831 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:17,431 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:16.037091+00:00, interaction_count=324, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:18,090 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:18,097 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:18,097 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwQzE4RTk1QzIwQjg0RDcxMgA='}]}
2025-09-03 20:02:18,097 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:18] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:19,152 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Make sure your rice is not cold'}
2025-09-03 20:02:20,851 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:22,221 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:21.061313+00:00, interaction_count=325, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:22,820 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:22,821 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:22,822 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:22,822 - handlers.order_handler - INFO - Note 'make sure your rice is not cold' added for session 2348055614455.
2025-09-03 20:02:22,823 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:02:22,838 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:23,782 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMTIxQUYwOTYwOUYwMTk2MQA="}]}
2025-09-03 20:02:24,792 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:24] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:25,193 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:25,273 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:25] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:25,341 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:26,793 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 20:02:26,870 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:25.541169+00:00, interaction_count=326, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:27,551 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:27,558 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:27,558 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlEMTIxQUYwOTYwOUYwMTk2MQA='}]}
2025-09-03 20:02:27,559 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:27] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:28,390 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:29,781 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:28.591464+00:00, interaction_count=327, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:30,361 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:30,361 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:30,362 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:30,362 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 20:02:30,362 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 20:02:30,369 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:31,354 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIxQzUxMkFDRUZCQTJFMTFFNwA="}]}
2025-09-03 20:02:32,577 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:32,783 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:32,852 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:32] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:32,961 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:33,873 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'preset_howson_wright'}
2025-09-03 20:02:34,341 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:33.161126+00:00, interaction_count=328, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:34,910 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:34,916 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:34,917 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIxQzUxMkFDRUZCQTJFMTFFNwA='}]}
2025-09-03 20:02:34,917 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:35,430 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:37,021 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:35.631793+00:00, interaction_count=329, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:37,680 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:37,681 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:37,682 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:39,641 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 20:02:39,642 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-09-03 20:02:39,642 - handlers.location_address_handler - INFO - Selected preset address 'Howson Wright' for session 2348055614455
2025-09-03 20:02:39,642 - handlers.location_address_handler - INFO - Redirecting back to order confirmation after address update for session 2348055614455
2025-09-03 20:02:41,591 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-09-03 20:02:41,592 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-09-03 20:02:41,592 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'show_order_confirmation_after_address_update'.
2025-09-03 20:02:41,592 - handlers.order_handler - INFO - Showing order confirmation after address update for session 2348055614455
2025-09-03 20:02:41,593 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:02:41,603 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:43,501 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY5QTFEM0E0NTE1N0NFNzA4MAA="}]}
2025-09-03 20:02:44,611 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:44,841 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:44] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:45,111 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:45,334 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:45] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:46,252 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-09-03 20:02:46,422 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 20:02:46,511 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:45.312078+00:00, interaction_count=330, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:47,110 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:47,117 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:47,118 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY5QTFEM0E0NTE1N0NFNzA4MAA='}]}
2025-09-03 20:02:47,118 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:47] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:47,851 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:48,030 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:49,391 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:48.231204+00:00, interaction_count=331, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:49,421 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:48.050468+00:00, interaction_count=331, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:49,971 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:49,972 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:49,972 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:49,972 - handlers.order_handler - INFO - User confirmed final order for session 2348055614455.
2025-09-03 20:02:50,201 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:50,202 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:02:50,202 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:02:50,203 - handlers.order_handler - INFO - User chose to update address for session 2348055614455.
2025-09-03 20:02:50,203 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'update_address'.
2025-09-03 20:02:50,208 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:02:51,732 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QUVCM0ZERUY0NzNFNDM2MQA="}]}
2025-09-03 20:02:52,840 - utils.data_manager - DEBUG - Found product_id 112 for product_name Jollof Rice
2025-09-03 20:02:53,000 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:53,030 - utils.data_manager - DEBUG - Assigned product_id 112 to item Jollof Rice
2025-09-03 20:02:53,065 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:53,303 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:53] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:53,330 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:54,690 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:53.520639+00:00, interaction_count=333, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 18:49:41.724992+00:00
2025-09-03 20:02:54,751 - utils.data_manager - DEBUG - Found product_id 113 for product_name Fried Rice
2025-09-03 20:02:54,961 - utils.data_manager - DEBUG - Assigned product_id 113 to item Fried Rice
2025-09-03 20:02:54,961 - utils.data_manager - WARNING - No payment_reference provided for order. Generated default: PAY-ORD-7736F985
2025-09-03 20:02:55,260 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:55,266 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:02:55,267 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QUVCM0ZERUY0NzNFNDM2MQA='}]}
2025-09-03 20:02:55,267 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:02:55] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:02:55,350 - utils.data_manager - INFO - Saved order 208 for customer 2348055614455 with payment_reference PAY-ORD-7736F985
2025-09-03 20:02:55,551 - utils.data_manager - INFO - Saved order item Jollof Rice for order 208
2025-09-03 20:02:55,751 - utils.data_manager - INFO - Saved order item Fried Rice for order 208
2025-09-03 20:02:55,952 - handlers.order_handler - INFO - Order ORD-7736F985 saved to database with DB ID 208 for session 2348055614455.
2025-09-03 20:02:55,953 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-03 20:02:57,583 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:02:59,148 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:02:57.781234+00:00, interaction_count=334, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=order_completed, final_order_value=2865.0, converted_at=2025-09-03 19:02:57.781234+00:00
2025-09-03 20:02:59,840 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:02:59,846 - handlers.lead_tracking_handler - INFO - Successfully tracked order conversion for phone number 2348055614455, order ID ORD-7736F985
2025-09-03 20:02:59,851 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-09-03 20:02:59,851 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-09-03 20:02:59,851 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-09-03 20:03:03,640 - utils.data_manager - INFO - Updated order 208 to status pending_payment
2025-09-03 20:03:03,641 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-09-03 20:03:03,641 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-ORD-7736F985 with amount: 286500, email: ziga4455@lola.com
2025-09-03 20:03:04,337 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/yc15cwpvtswdyah
2025-09-03 20:03:04,338 - handlers.payment_handler - INFO - Starting payment monitoring for order 208, reference PAY-ORD-7736F985
2025-09-03 20:03:04,338 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-ORD-7736F985
2025-09-03 20:03:04,880 - services.payment_service - WARNING - Payment not successful for reference PAY-ORD-7736F985. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5303403959, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-ORD-7736F985', 'receipt_number': None, 'amount': 286500, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-09-03T19:03:04.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.67.12.153, 172.69.224.19, 172.31.68.120', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': 'ORD-7736F985', 'db_order_id': '208', 'delivery_address': 'Howson Wright', 'charges': '215', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 14298, 'integration': '2865', 'subaccount': 269337, 'params': {'bearer': 'subaccount', 'transaction_charge': '2865', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-09-03T19:03:04.000Z', 'requested_amount': 286500, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-09-03T19:03:04.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-09-03 20:03:04,881 - handlers.payment_handler - INFO - Payment not yet verified for order 208, attempt 1/15
2025-09-03 20:03:04,882 - handlers.payment_handler - INFO - Payment link created successfully for order 208 with subaccount ACCT_u9knhyzn5eq4iop
2025-09-03 20:03:06,431 - utils.data_manager - INFO - Retrieved 2 items for order 208
2025-09-03 20:03:06,651 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:03:07,651 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEMDI5QjNFRTg3Q0RGMjdFRgA="}]}
2025-09-03 20:03:08,676 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:08] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:09,092 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:09] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:09,191 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:03:09,252 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:09] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:10,690 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:03:09.391153+00:00, interaction_count=335, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:02:57.781234+00:00
2025-09-03 20:03:11,310 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:03:11,316 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:03:11,316 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEMDI5QjNFRTg3Q0RGMjdFRgA='}]}
2025-09-03 20:03:11,317 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:11] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:11,711 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-09-03 20:03:13,340 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:03:14,871 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:03:13.650421+00:00, interaction_count=336, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:02:57.781234+00:00
2025-09-03 20:03:15,470 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:03:15,471 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-03 20:03:15,471 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-03 20:03:16,787 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-ORD-7736F985
2025-09-03 20:03:17,331 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order ORD-7736F985.
2025-09-03 20:03:19,150 - utils.data_manager - ERROR - Database error retrieving items for order ORD-7736F985: invalid input syntax for type bigint: "ORD-7736F985"
LINE 4:                         WHERE order_id = 'ORD-7736F985'
                                                 ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\utils\data_manager.py", line 759, in get_order_items
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<4 lines>...
        (order_id,)
        ^^^^^^^^^^^
    )
    ^
psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type bigint: "ORD-7736F985"
LINE 4:                         WHERE order_id = 'ORD-7736F985'
                                                 ^

2025-09-03 20:03:19,152 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:03:20,061 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU2NDk4RjYxMTE3NkNFNzdEMgA="}]}
2025-09-03 20:03:20,370 - utils.data_manager - INFO - Updated order 208 to status confirmed
2025-09-03 20:03:21,034 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:21,383 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:21,531 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:21] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:21,691 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-03 20:03:21,950 - utils.data_manager - INFO - Retrieved 2 items for order 208
2025-09-03 20:03:23,107 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-03 19:03:21.901075+00:00, interaction_count=337, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:02:57.781234+00:00
2025-09-03 20:03:23,721 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-03 20:03:23,727 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-03 20:03:23,727 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU2NDk4RjYxMTE3NkNFNzdEMgA='}]}
2025-09-03 20:03:23,728 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:23] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:23,940 - utils.data_manager - INFO - Reduced inventory for product_id 112 by 1 for order 208
2025-09-03 20:03:24,361 - utils.data_manager - INFO - Reduced inventory for product_id 113 by 1 for order 208
2025-09-03 20:03:24,550 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-03 20:03:26,073 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-09-03 20:03:26,261 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 208
2025-09-03 20:03:29,840 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-09-03 20:03:29,841 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-09-03 20:03:31,760 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-03 20:03:32,971 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEwODEzRDBBOTRFNkVGNzk3MQA="}]}
2025-09-03 20:03:32,972 - handlers.payment_handler - INFO - Sent payment success text message for order 208 to customer 2348055614455
2025-09-03 20:03:32,973 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 208, session 2348055614455
2025-09-03 20:03:32,973 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 9, 3, 20, 3, 32, 973710), 'payment_reference': 'PAY-ORD-7736F985', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '112', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 150.0, 'total_price': 150.0}, {'item_id': '113', 'name': 'Fried Rice', 'quantity': 1, 'variations': {}, 'price': 2000.0, 'total_price': 2000.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 2150.0, 'error': ''}, 'total_price': 2150.0, 'from_ai_order': True, 'order_note': 'make sure your rice is not cold', 'latitude': None, 'longitude': None, 'map_link': '', 'order_id': 'ORD-7736F985', 'from_confirm_order': True, 'db_order_id': '208', 'feedback_order_id': 208, 'feedback_started_at': '2025-09-03T20:03:32.973702'}
2025-09-03 20:03:32,980 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-03 20:03:33,966 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:33] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:34,022 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBMEVDMURFOTFBNEMzQjEyQQA="}]}
2025-09-03 20:03:34,023 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 208, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBMEVDMURFOTFBNEMzQjEyQQA='}]}
2025-09-03 20:03:34,023 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-09-03 20:03:34,503 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:34] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:35,031 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:35,233 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:35,251 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjAwNEFBMEVGNzAxMTBCQzFDMAA="}]}
2025-09-03 20:03:35,252 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 208 to 2347082345056
2025-09-03 20:03:35,253 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:35] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-09-03 20:03:35,422 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:35] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:36,591 - werkzeug - INFO - 127.0.0.1 - - [03/Sep/2025 20:03:36] "POST /webhook HTTP/1.1" 200 -
2025-09-03 20:03:40,124 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-03 20:03:40,125 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:11:21,883 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:11:25,754 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:11:27,340 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:11:27,574 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:11:27,770 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:27,950 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,151 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,341 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,529 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,720 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:28,911 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,091 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,280 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,470 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,660 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:29,926 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:30,160 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:30,349 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:32,093 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:11:32,291 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:11:32,292 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:11:32,292 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:11:32,294 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:11:32,294 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:11:32,294 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:11:32,294 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:11:32,295 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:11:32,295 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:11:32,296 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:11:33,803 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:11:33,848 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:11:34,041 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:11:34,241 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:34,430 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:34,620 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:34,810 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,000 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,190 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,380 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,562 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,740 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:35,931 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:36,120 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:36,313 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:36,510 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:36,700 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:11:38,413 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:11:38,608 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:11:38,608 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:11:38,609 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:11:38,609 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:11:38,609 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:11:38,609 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:11:38,611 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:11:38,611 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:11:38,612 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:11:38,612 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:11:38,612 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:11:39,132 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:11:39,132 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:11:39,132 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:11:39,132 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:11:39,133 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:11:39,133 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:11:39,162 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:11:39,162 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:11:48,270 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:11:48,271 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:16:01,441 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:16:03,506 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:16:05,329 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:16:05,602 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:16:05,806 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,009 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,209 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,416 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,636 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:06,829 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,029 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,232 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,430 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,629 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:07,829 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:08,035 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:08,239 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:08,439 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:10,173 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:16:10,370 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:16:10,371 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:16:10,371 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:16:10,373 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:16:10,372 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:16:10,373 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:16:10,374 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:16:10,374 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:16:10,375 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:16:10,375 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:16:11,909 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:16:11,914 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:16:12,101 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:16:12,293 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:12,599 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:12,790 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:12,979 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,163 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,358 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,551 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,749 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:13,939 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,129 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,319 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,536 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,745 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:14,943 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:16:16,797 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:16:16,992 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:16:16,993 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:16:16,994 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:16:16,994 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:16:16,995 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:16:16,995 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:16:16,998 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:16:16,998 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:16:16,998 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:16:17,000 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:16:17,001 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:16:18,083 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:16:18,083 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:16:18,084 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:16:18,084 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:16:18,084 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:16:18,085 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:16:18,134 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:16:18,135 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:17:39,419 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:17:39,420 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:17:42,352 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:17:44,455 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:17:46,019 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:17:46,208 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:17:46,415 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:46,609 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:46,799 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:46,989 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,179 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,369 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,609 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,799 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:47,990 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,179 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,369 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,559 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,751 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:48,939 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:50,650 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:17:50,845 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:17:50,846 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:17:50,846 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:17:50,847 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:17:50,847 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:17:50,848 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:17:50,848 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:17:50,848 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:17:50,849 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:17:50,849 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:17:52,349 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:17:52,502 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:17:52,540 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:17:52,730 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:52,919 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,110 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,299 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,489 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,679 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:53,872 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,069 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,259 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,449 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,639 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:54,829 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:55,030 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:55,229 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:17:56,989 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:17:57,181 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:17:57,182 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:17:57,182 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:17:57,182 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:17:57,182 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:17:57,183 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:17:57,183 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:17:57,183 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:17:57,184 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:17:57,184 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:17:57,185 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:17:57,590 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:17:57,590 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:17:57,590 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:17:57,591 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:17:57,591 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:17:57,591 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:17:57,604 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:17:57,604 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:19:07,040 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:19:07,041 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:19:08,590 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:19:09,899 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:19:08.779740+00:00, interaction_count=401, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:19:10,511 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:19:10,511 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:19:10,512 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:19:12,069 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:19:12,257 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:19:12,258 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:19:12,258 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:19:12,259 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:19:13,769 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhEOEJDNDlDNkU5MjI2NEQzQwA="}]}
2025-09-27 01:19:13,770 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:19:14,750 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJFQ0RCNThDOUU2MzVFOERDMAA="}]}
2025-09-27 01:19:14,751 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJFQ0RCNThDOUU2MzVFOERDMAA='}]}
2025-09-27 01:19:14,753 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:14] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:16,380 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:16,940 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:16,991 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:17,184 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:17,661 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:18,101 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:18] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:19,620 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 01:19:21,179 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:19:22,525 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:19:21.369358+00:00, interaction_count=402, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:19:23,090 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:19:23,092 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:19:23,093 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:19:23,093 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 01:19:23,093 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 01:19:23,094 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 01:19:23,094 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 01:19:23,094 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:19:23,095 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 01:19:24,239 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBMEMyNTc0QUE5MzhGNDNEOAA="}]}
2025-09-27 01:19:24,240 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:19:24,240 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-27 01:19:25,159 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDMzQ0N0I2MzFBOUZDNTMwNQA="}]}
2025-09-27 01:19:25,160 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhDMzQ0N0I2MzFBOUZDNTMwNQA='}]}
2025-09-27 01:19:25,160 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:25] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:25,801 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:25] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:26,410 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:26,531 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:26,750 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:26,812 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:27,152 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:33,235 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-27 01:19:34,761 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:19:36,132 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:19:34.949534+00:00, interaction_count=403, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:19:36,719 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:19:36,719 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:19:36,720 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:19:36,720 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-27 01:19:40,404 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:19:40,412 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:19:42,369 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1NzdCRTYxNzE5NUI1NEFDOQA="}]}
2025-09-27 01:19:42,370 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1NzdCRTYxNzE5NUI1NEFDOQA='}]}
2025-09-27 01:19:42,371 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:43,205 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:43] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:43,801 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:43] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:19:44,230 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:19:44] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:20:17,625 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '2 portions of jellof rice and 1 portion of fried rice'}
2025-09-27 01:20:19,159 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:20:20,522 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:20:19.349596+00:00, interaction_count=404, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:20:21,139 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:20:21,140 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:20:21,140 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:20:21,140 - handlers.message_processor - WARNING - Session 2348055614455: Unhandled AI state 'ai_portion_clarification'. Resetting to AI menu.
2025-09-27 01:20:21,141 - handlers.base_handler - INFO - AIHandler: Handling message 'initial_entry' in AI menu state for session 2348055614455. Original: '2 portions of jellof rice and 1 portion of fried rice'
2025-09-27 01:20:21,147 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:20:22,299 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1MjE1OTNBRDIzRjRCODM3NAA="}]}
2025-09-27 01:20:22,300 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1MjE1OTNBRDIzRjRCODM3NAA='}]}
2025-09-27 01:20:22,301 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:20:22] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:20:23,540 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:20:23] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:20:23,732 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:20:23] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:20:24,111 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:20:24] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:22:52,690 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:22:54,362 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:25:38,638 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:25:40,168 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:25:41,588 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:25:40.358221+00:00, interaction_count=405, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:25:42,153 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:25:42,154 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:25:42,154 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:25:42,155 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:25:42,155 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:25:42,156 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:25:42,156 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:25:44,069 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkxQzBFNjY5RUU1M0E5NDYxNAA="}]}
2025-09-27 01:25:44,104 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:25:45,061 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzNzRFNjc1NThGQzE1QTBEQgA="}]}
2025-09-27 01:25:45,063 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUzNzRFNjc1NThGQzE1QTBEQgA='}]}
2025-09-27 01:25:45,063 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:25:45,688 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:25:45,987 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:25:46,119 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:46] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:25:46,770 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:25:46] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:27:13,313 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:27:13] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:27:13,639 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:27:13] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:27:54,577 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:27:56,430 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:27:56,758 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:27:56,758 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:29:04,631 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:29:06,285 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:29:07,827 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:29:08,017 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:29:08,207 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:08,398 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:08,587 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:08,778 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:08,967 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,157 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,357 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,554 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,747 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:09,937 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:10,127 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:10,318 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:10,508 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:10,697 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:12,438 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:29:12,628 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:29:12,629 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:29:12,629 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:29:12,631 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:29:12,631 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:29:12,631 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:29:12,632 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:29:12,633 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:29:12,633 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:29:12,633 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:29:14,125 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:29:14,140 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:29:14,317 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:29:14,507 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:14,697 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:14,889 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,077 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,267 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,457 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,648 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:15,838 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,029 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,218 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,407 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,597 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,787 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:16,977 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:29:19,074 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:29:19,268 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:29:19,268 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:29:19,269 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:29:19,269 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:29:19,269 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:29:19,270 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:29:19,271 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:29:19,271 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:29:19,271 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:29:19,272 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:29:19,272 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:29:19,707 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:29:19,707 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:29:19,708 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:29:19,708 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:29:19,709 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:29:19,709 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:29:19,728 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:29:19,728 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:29:25,358 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:29:25,359 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:29:26,908 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:29:28,268 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:29:27.097511+00:00, interaction_count=406, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:29:28,837 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:29:28,838 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:29:28,838 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:29:30,398 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:29:30,587 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to AI bulk order.
2025-09-27 01:29:30,588 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': 'AIHandler' object has no attribute 'handle_ai_bulk_order'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 185, in _route_to_handler
    return self.ai_handler.handle_ai_bulk_order(state, session_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'AIHandler' object has no attribute 'handle_ai_bulk_order'. Did you mean: 'handle_ai_bulk_order_state'?
2025-09-27 01:29:30,590 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:29:31,799 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3MjY5N0NGNjdCNENDMDlBMwA="}]}
2025-09-27 01:29:31,799 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3MjY5N0NGNjdCNENDMDlBMwA='}], 'recipient_id': '2348055614455'}
2025-09-27 01:29:31,800 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:29:31] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:29:32,920 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:29:32] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:29:33,328 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:29:33] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:29:33,698 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:29:33] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:29:58,480 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:29:58,481 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:30:03,417 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:30:04,651 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:30:06,317 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:30:06,507 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:30:06,698 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:06,887 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,077 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,268 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,458 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,647 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:07,837 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,027 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,218 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,418 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,628 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:08,820 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:09,017 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:09,212 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:10,940 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:30:11,128 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:30:11,129 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:30:11,129 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:30:11,130 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:30:11,130 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:30:11,131 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:30:11,131 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:30:11,132 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:30:11,132 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:30:11,133 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:30:12,648 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:30:12,650 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:30:12,837 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:30:13,027 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,217 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,410 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,608 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,797 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:13,987 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,177 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,367 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,557 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,749 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:14,947 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:15,139 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:15,337 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:15,641 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:30:17,602 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:30:17,800 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:30:17,800 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:30:17,801 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:30:17,801 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:30:17,801 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:30:17,801 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:30:17,802 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:30:17,802 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:30:17,803 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:30:17,803 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:30:17,803 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:30:18,199 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:30:18,199 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:30:18,200 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:30:18,200 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:30:18,200 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:30:18,201 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:30:18,214 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:30:18,214 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:30:21,551 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:30:21,552 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:30:23,089 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:30:24,437 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:30:23.277773+00:00, interaction_count=407, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:30:25,008 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:30:25,009 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:30:25,010 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:30:26,538 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:30:26,732 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to AI bulk order.
2025-09-27 01:30:26,732 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': 'AIHandler' object has no attribute 'handle_ai_bulk_order'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 185, in _route_to_handler
    return self.ai_handler.handle_ai_bulk_order(state, session_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'AIHandler' object has no attribute 'handle_ai_bulk_order'. Did you mean: 'handle_ai_bulk_order_state'?
2025-09-27 01:30:26,734 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:30:27,918 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNDMDUzOTM0NkQ2Qjc4QjA5QQA="}]}
2025-09-27 01:30:27,919 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNDMDUzOTM0NkQ2Qjc4QjA5QQA='}], 'recipient_id': '2348055614455'}
2025-09-27 01:30:27,920 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:30:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:30:29,005 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:30:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:30:29,730 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:30:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:30:29,732 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:30:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:35:12,851 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:35:14,511 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:35:34,218 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:35:34,219 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:35:43,352 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:35:44,839 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:35:46,387 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:35:46,576 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:35:46,767 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:46,956 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,147 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,338 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,526 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,708 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:47,896 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,086 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,276 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,468 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,656 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:48,836 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:49,026 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:49,217 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:50,957 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:35:51,148 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:35:51,149 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:35:51,149 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:35:51,150 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:35:51,151 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:35:51,151 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:35:51,151 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:35:51,152 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:35:51,152 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:35:51,153 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:35:52,717 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:35:52,719 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:35:52,912 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:35:53,114 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:53,317 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:53,516 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:53,706 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:53,897 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,113 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,306 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,502 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,718 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:54,907 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:55,097 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:55,286 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:55,476 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:55,683 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:35:57,527 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:35:57,718 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:35:57,718 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:35:57,718 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:35:57,719 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:35:57,719 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:35:57,719 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:35:57,720 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:35:57,721 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:35:57,721 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:35:57,721 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:35:57,722 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:35:58,153 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:35:58,154 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:35:58,154 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:35:58,154 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:35:58,155 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:35:58,155 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:35:58,186 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:35:58,187 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:35:58,980 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:35:58,980 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:36:00,538 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:36:01,880 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:36:00.716747+00:00, interaction_count=408, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:36:02,447 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:36:02,448 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:36:02,448 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:36:03,990 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:36:04,177 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:36:04,178 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:36:04,178 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:36:04,179 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:36:06,048 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBBOTgxMzE3NTYxMThFM0NDQgA="}]}
2025-09-27 01:36:06,049 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:36:07,447 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM4OTgzQzEzQzQzQUVDN0EwOQA="}]}
2025-09-27 01:36:07,448 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM4OTgzQzEzQzQzQUVDN0EwOQA='}]}
2025-09-27 01:36:07,449 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:07] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:07,863 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:07] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:08,021 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:08] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:08,347 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:08] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:08,587 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:08] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:08,819 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:08] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:09,209 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:09] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:10,196 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 01:36:11,716 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:36:13,182 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:36:11.908985+00:00, interaction_count=409, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:36:13,847 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:36:13,848 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:36:13,848 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:36:13,848 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 01:36:13,849 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 01:36:13,849 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 01:36:13,849 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 01:36:13,850 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:36:13,850 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 01:36:15,086 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjczNTIxQzYwMUZBNDdDRjc2RAA="}]}
2025-09-27 01:36:15,087 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:36:15,087 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-09-27 01:36:16,307 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCMjY2RDY2Mzc1MzQ0MEJBQQA="}]}
2025-09-27 01:36:16,308 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCMjY2RDY2Mzc1MzQ0MEJBQQA='}]}
2025-09-27 01:36:16,309 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:16,720 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:16] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:17,180 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:17,298 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:17,299 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:17,659 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:17] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:18,116 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:18] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:27,238 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-09-27 01:36:28,806 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:36:30,136 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:36:28.997163+00:00, interaction_count=410, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:36:30,706 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:36:30,707 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:36:30,708 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:36:30,708 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-09-27 01:36:34,849 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:36:34,857 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:36:35,957 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc3QkM5RDdBNkUxRjJCMzc2RAA="}]}
2025-09-27 01:36:35,958 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc3QkM5RDdBNkUxRjJCMzc2RAA='}]}
2025-09-27 01:36:35,959 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:35] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:36,787 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:37,409 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:37] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:36:37,686 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:36:37] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:03,644 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '1 portion of jellof rice and 3 portion of fried rice'}
2025-09-27 01:37:05,186 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:06,537 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:05.377046+00:00, interaction_count=411, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:07,096 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:07,097 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:37:07,097 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:37:10,349 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:37:10,356 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:37:11,657 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBMkEzMkVGMUZCQUQ4RjAyMQA="}]}
2025-09-27 01:37:11,658 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBMkEzMkVGMUZCQUQ4RjAyMQA='}]}
2025-09-27 01:37:11,658 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:11] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:12,815 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:12] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:13,319 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:13] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:13,428 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:13] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:24,028 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-09-27 01:37:25,596 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:26,936 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:25.787027+00:00, interaction_count=412, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=27000.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:27,507 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:27,508 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:37:27,509 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:37:27,509 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof rice': {'item_id': 1, 'quantity': 1, 'price': 500.0, 'total_price': 500.0, 'variations': {}, 'food_share_pattern': 'Portion'}, 'Fried rice': {'item_id': 2, 'quantity': 3, 'price': 550.0, 'total_price': 1650.0, 'variations': {}, 'food_share_pattern': 'Portion'}}. Redirecting to order handler.
2025-09-27 01:37:27,509 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-09-27 01:37:27,510 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:37:27,510 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-09-27 01:37:27,511 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-09-27 01:37:27,518 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:37:28,587 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZCMzc4RjM2RDFGMzdFRjY1MAA="}]}
2025-09-27 01:37:29,603 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:30,106 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:30,209 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:30] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:30,318 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:30] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:31,436 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:30.297236+00:00, interaction_count=413, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:32,008 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:32,017 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-27 01:37:32,017 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZCMzc4RjM2RDFGMzdFRjY1MAA='}]}
2025-09-27 01:37:32,018 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:32] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:32,152 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-09-27 01:37:33,716 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:35,076 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:33.920964+00:00, interaction_count=414, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:35,658 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:35,658 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:37:35,659 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:37:35,659 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-09-27 01:37:35,659 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:37:35,671 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:37:36,789 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU0RTk5NzJCNzU3M0ZFNzM1MQA="}]}
2025-09-27 01:37:37,893 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:37] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:38,316 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:37:38,489 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:38] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:38,519 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:38] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:37:39,676 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:37:38.507295+00:00, interaction_count=415, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:37:40,224 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:37:40,229 - handlers.lead_tracking_handler - INFO - Successfully tracked cart activity for phone number 2348055614455
2025-09-27 01:37:40,229 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU0RTk5NzJCNzU3M0ZFNzM1MQA='}]}
2025-09-27 01:37:40,230 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:37:40] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:40:52,924 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:40:54,718 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:42:46,423 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:42:46,435 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:42:48,364 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:42:49,536 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:42:51,086 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:42:51,278 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:42:51,476 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:51,665 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:51,855 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,045 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,235 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,425 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,625 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:52,826 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,016 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,207 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,395 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,597 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,796 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:53,987 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:55,706 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:42:55,888 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:42:55,922 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:42:55,923 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:42:55,925 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:42:55,925 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:42:55,932 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:42:55,936 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:42:55,939 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:42:55,939 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:42:55,940 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:42:57,458 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:42:57,487 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:42:57,675 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:42:57,866 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,055 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,245 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,435 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,628 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:58,825 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,015 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,205 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,395 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,585 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,787 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:42:59,975 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:43:00,165 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:43:00,355 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:43:02,087 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:43:02,276 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:43:02,276 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:43:02,277 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:43:02,277 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:43:02,277 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:43:02,278 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:43:02,278 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:43:02,279 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:43:02,279 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:43:02,279 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:43:02,280 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:43:02,678 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:43:02,678 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:43:02,678 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:43:02,679 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:43:02,679 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:43:02,680 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:43:02,694 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:43:02,694 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:43:18,586 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:43:18,586 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:43:20,126 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:43:21,465 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:43:20.315444+00:00, interaction_count=416, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:43:22,035 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:43:22,036 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:43:22,037 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:43:23,555 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:43:23,746 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:43:23,746 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:43:23,747 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:43:23,747 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:43:25,266 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExRDk5Njg0NTNCOTE4QjQyRAA="}]}
2025-09-27 01:43:25,267 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:43:26,286 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM5OTMwNjQzQjg2NUQ4NkFFNgA="}]}
2025-09-27 01:43:26,287 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM5OTMwNjQzQjg2NUQ4NkFFNgA='}]}
2025-09-27 01:43:26,288 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:26,987 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:26] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:27,536 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:27,648 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:27] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:28,107 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:28,258 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:28,576 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:29,666 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 01:43:31,195 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:43:32,505 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:43:31.386532+00:00, interaction_count=417, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:43:33,075 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:43:33,076 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:43:33,076 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:43:33,077 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 01:43:33,077 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 01:43:33,077 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 01:43:33,078 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 01:43:33,078 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:43:33,078 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 01:43:34,126 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc4NzUxMzY0N0JGMDc1M0Q3QQA="}]}
2025-09-27 01:43:34,127 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:43:34,127 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi! Please tell me what you'd like to order.\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nWhat would you like to order?"}}
2025-09-27 01:43:35,236 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5QjM0MDJGQUU0MTJGNjg3QgA="}]}
2025-09-27 01:43:35,237 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5QjM0MDJGQUU0MTJGNjg3QgA='}]}
2025-09-27 01:43:35,237 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:35] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:35,619 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:35] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,128 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,358 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,567 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,937 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:43:36,977 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:43:36] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:44:46,722 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '1 portion of fried rice and 2 portion jellof rice in 2 packs'}
2025-09-27 01:44:48,275 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:44:49,595 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:44:48.450799+00:00, interaction_count=418, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:44:50,165 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:44:50,165 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:44:50,166 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:44:50,166 - handlers.base_handler - INFO - AIHandler: Handling message '1 portion of fried rice and 2 portion jellof rice in 2 packs' in AI bulk order state for session 2348055614455. Original: '1 portion of fried rice and 2 portion jellof rice in 2 packs'
2025-09-27 01:44:53,556 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:44:53,565 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:44:54,865 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEzOTdDMzM0RjBDQzJCNENEOAA="}]}
2025-09-27 01:44:54,866 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEzOTdDMzM0RjBDQzJCNENEOAA='}]}
2025-09-27 01:44:54,867 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:44:54] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:44:55,874 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:44:55] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:44:56,487 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:44:56] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:44:56,689 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:44:56] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:47:57,651 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:47:59,448 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:52:59,658 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:53:01,466 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:53:37,362 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 01:53:37,374 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 01:53:40,024 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 01:53:41,491 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:53:43,043 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:53:43,234 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:53:43,423 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:43,616 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:43,803 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:43,993 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,193 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,384 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,574 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,764 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:44,954 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,143 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,334 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,526 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,714 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:45,904 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:47,704 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:53:47,894 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:53:47,895 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:53:47,895 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 01:53:47,896 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:53:47,896 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:53:47,897 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 01:53:47,897 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:53:47,898 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:53:47,898 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:53:47,899 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 01:53:49,424 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 01:53:49,426 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 01:53:49,614 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 01:53:49,805 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,004 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,194 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,375 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,563 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,754 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:50,944 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,123 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,313 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,503 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,704 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:51,894 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:52,085 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:52,274 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 01:53:53,994 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 01:53:54,185 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 01:53:54,185 - services.payment_service - INFO - PaymentService initialized
2025-09-27 01:53:54,185 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 01:53:54,186 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 01:53:54,186 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 01:53:54,186 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 01:53:54,197 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 01:53:54,197 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 01:53:54,197 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 01:53:54,198 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:53:54,198 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:53:54,613 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 01:53:54,613 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 01:53:54,613 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 01:53:54,614 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 01:53:54,614 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 01:53:54,615 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 01:53:54,645 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 01:53:54,645 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 01:53:54,805 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 01:53:54,805 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 01:53:56,324 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:53:57,664 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:53:56.514464+00:00, interaction_count=419, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:53:58,264 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:53:58,264 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 01:53:58,265 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:53:59,894 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 01:54:00,084 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 01:54:00,084 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 01:54:00,085 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 01:54:00,085 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:54:01,574 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRCRTM0ODZEMTY1MDZGNUZENAA="}]}
2025-09-27 01:54:01,575 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:54:02,745 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBQjhCQzBDM0JBOTIxNTlDNAA="}]}
2025-09-27 01:54:02,746 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBQjhCQzBDM0JBOTIxNTlDNAA='}]}
2025-09-27 01:54:02,747 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:02] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:03,016 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:03] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:03,897 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:03] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:04,017 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:04] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:04,027 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:04] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:04,097 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:04] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:04,556 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:04] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:05,476 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 01:54:07,004 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:54:08,344 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:54:07.194019+00:00, interaction_count=420, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:54:08,914 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:54:08,915 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:54:08,915 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:54:08,915 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 01:54:08,915 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 01:54:08,916 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 01:54:08,916 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 01:54:08,916 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 01:54:08,917 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 01:54:09,946 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFQ0JFRDQzQThDOUNBQTg0MQA="}]}
2025-09-27 01:54:09,947 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 01:54:09,948 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-09-27 01:54:10,994 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY4Rjk0NUQwRTc0MkFEMEM1QQA="}]}
2025-09-27 01:54:10,995 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY4Rjk0NUQwRTc0MkFEMEM1QQA='}]}
2025-09-27 01:54:10,996 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:10] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:11,330 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:11] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:11,855 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:11] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:11,976 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:11] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:12,227 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:12] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:12,559 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:12] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:12,577 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:12] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:34,606 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello I want 3 Jellof rice and fried rice for 3 people \nAdd chicken in one and fish in the other two'}
2025-09-27 01:54:36,124 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 01:54:37,464 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 00:54:36.314281+00:00, interaction_count=421, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 01:54:38,033 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 01:54:38,034 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 01:54:38,034 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 01:54:38,035 - handlers.base_handler - INFO - AIHandler: Handling message 'hello i want 3 jellof rice and fried rice for 3 people 
add chicken in one and fish in the other two' in AI bulk order state for session 2348055614455. Original: 'Hello I want 3 Jellof rice and fried rice for 3 people 
Add chicken in one and fish in the other two'
2025-09-27 01:54:43,104 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 01:54:43,112 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 01:54:44,334 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3M0UwREQ3N0ZFNDI3QzRBNgA="}]}
2025-09-27 01:54:44,335 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3M0UwREQ3N0ZFNDI3QzRBNgA='}]}
2025-09-27 01:54:44,335 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:44] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:45,594 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:45,936 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:45] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:54:46,286 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 01:54:46] "POST /webhook HTTP/1.1" 200 -
2025-09-27 01:58:49,619 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 01:58:51,457 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 02:02:39,579 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 02:02:39,590 - handlers.product_sync_handler - INFO - Product sync thread stopped.
2025-09-27 02:03:17,355 - __main__ - INFO - Starting WhatsApp bot server...
2025-09-27 02:03:19,806 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 02:03:21,389 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 02:03:21,582 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 02:03:21,772 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:21,963 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,162 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,352 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,547 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,742 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:22,932 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,122 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,312 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,502 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,692 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:23,888 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:24,082 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:24,272 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:26,002 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 02:03:26,194 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 02:03:26,195 - services.payment_service - INFO - PaymentService initialized
2025-09-27 02:03:26,195 - handlers.product_sync_handler - INFO - Starting product sync thread. Sync interval: 5.0 minutes.
2025-09-27 02:03:26,196 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 02:03:26,196 - handlers.product_sync_handler - INFO - Initiating product sync for merchant 20...
2025-09-27 02:03:26,197 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-09-27 02:03:26,197 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 02:03:26,198 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:03:26,198 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:03:26,199 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-09-27 02:03:27,712 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-09-27 02:03:27,715 - handlers.product_sync_handler - INFO - Successfully synced 47 products for merchant 20 to data\products.json
2025-09-27 02:03:27,903 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-09-27 02:03:28,162 - utils.data_manager - DEBUG - id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:28,353 - utils.data_manager - DEBUG - merchant_details_id column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:28,543 - utils.data_manager - DEBUG - product_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:28,732 - utils.data_manager - DEBUG - description column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:28,924 - utils.data_manager - DEBUG - product_category column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,122 - utils.data_manager - DEBUG - variant_name column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,312 - utils.data_manager - DEBUG - currency column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,502 - utils.data_manager - DEBUG - price column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,692 - utils.data_manager - DEBUG - availability_status column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:29,882 - utils.data_manager - DEBUG - quantity column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:30,073 - utils.data_manager - DEBUG - last_updated column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:30,262 - utils.data_manager - DEBUG - date_created column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:30,452 - utils.data_manager - DEBUG - channel column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:30,643 - utils.data_manager - DEBUG - food_share_pattern column already exists in whatsapp_merchant_product_inventory table.
2025-09-27 02:03:32,352 - utils.data_manager - INFO - Successfully loaded 60 user details from database
2025-09-27 02:03:32,542 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-09-27 02:03:32,543 - services.payment_service - INFO - PaymentService initialized
2025-09-27 02:03:32,543 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-09-27 02:03:32,543 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-09-27 02:03:32,544 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-09-27 02:03:32,544 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-09-27 02:03:32,555 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-09-27 02:03:32,556 - handlers.order_handler - INFO - OrderHandler initialized.
2025-09-27 02:03:32,556 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-09-27 02:03:32,557 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:03:32,557 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:03:32,988 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-09-27 02:03:32,988 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-09-27 02:03:32,989 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-09-27 02:03:32,989 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-09-27 02:03:32,989 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-09-27 02:03:32,990 - handlers.payment_handler - INFO - PaymentHandler initialized with subaccount ACCT_iwv6csej0ra4k7g, split percentage 1%, merchant phone 2347082345056
2025-09-27 02:03:33,006 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-09-27 02:03:33,007 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-09-27 02:03:33,783 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-09-27 02:03:33,784 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-09-27 02:03:35,322 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:03:36,667 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:03:35.512874+00:00, interaction_count=422, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:03:37,242 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:03:37,243 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455 (Ziga)
2025-09-27 02:03:37,243 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:03:38,862 - utils.data_manager - DEBUG - Found address 'Howson Wright' for phone number 2348055614455 in whatsapp_orders
2025-09-27 02:03:39,205 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-09-27 02:03:39,206 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Howson Wright', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-09-27 02:03:39,206 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state). Address preserved: Howson Wright
2025-09-27 02:03:39,207 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 02:03:40,643 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEwRjE0MUYyNTFCQTQyNjYyMQA="}]}
2025-09-27 02:03:40,644 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:03:41,874 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIzN0M1QUNDODQzRjMxQzIzRgA="}]}
2025-09-27 02:03:41,875 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIzN0M1QUNDODQzRjMxQzIzRgA='}]}
2025-09-27 02:03:41,876 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:41] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:42,093 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:42,935 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:42,938 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:42,941 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:42] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:43,254 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:43] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:43,596 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:43] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:44,934 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-09-27 02:03:46,452 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:03:47,793 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:03:46.643157+00:00, interaction_count=423, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:03:48,362 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:03:48,363 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:03:48,363 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:03:48,364 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-09-27 02:03:48,364 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-09-27 02:03:48,364 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-09-27 02:03:48,365 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-09-27 02:03:48,365 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-09-27 02:03:48,365 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-09-27 02:03:49,413 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE1Q0QyQkI3QUJBNDM4REE2MwA="}]}
2025-09-27 02:03:49,414 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 02:03:49,414 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador Express!\n\nHow to order:\n List the items and portions\n Say how many packs you want\n\nExample: '1 portion of Jollof Rice and 1 portion of Fried Rice in 2 packs'\n\nTake a look at the menu and tell me what you'd like to order.\n\n"}}
2025-09-27 02:03:50,654 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0MEZBNkI3MzExM0ExQUNEQQA="}]}
2025-09-27 02:03:50,655 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0MEZBNkI3MzExM0ExQUNEQQA='}]}
2025-09-27 02:03:50,655 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:50] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:51,149 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:51] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:51,593 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:51] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:51,723 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:51] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:51,853 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:51] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:52,084 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:52] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:52,293 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:03:52] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:03:55,125 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello I want 3 Jellof rice and fried rice for 3 people \nAdd chicken in one and fish in\xa0the\xa0other\xa0two'}
2025-09-27 02:03:56,952 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:03:58,461 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:03:57.142831+00:00, interaction_count=424, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:03:59,162 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:03:59,163 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:03:59,164 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:03:59,164 - handlers.base_handler - INFO - AIHandler: Handling message 'hello i want 3 jellof rice and fried rice for 3 people 
add chicken in one and fish intheothertwo' in AI bulk order state for session 2348055614455. Original: 'Hello I want 3 Jellof rice and fried rice for 3 people 
Add chicken in one and fish intheothertwo'
2025-09-27 02:04:04,531 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-09-27 02:04:04,540 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-09-27 02:04:05,743 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRCMzNEQTU3QzNDNUZDREFBQwA="}]}
2025-09-27 02:04:05,744 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRCMzNEQTU3QzNDNUZDREFBQwA='}]}
2025-09-27 02:04:05,745 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:05] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:06,600 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:06] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:07,095 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:07] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:07,242 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:07] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:23,431 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'modify_ai_order'}
2025-09-27 02:04:24,953 - utils.data_manager - INFO - Retrieved lead 2348055614455 for merchant 20 from whatsapp_leads
2025-09-27 02:04:26,292 - utils.data_manager - DEBUG - Saving or updating lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-09-27 01:04:25.142650+00:00, interaction_count=425, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=2865.0, converted_at=2025-09-03 19:39:56.091630+00:00
2025-09-27 02:04:26,862 - utils.data_manager - INFO - Lead 2348055614455 saved or updated in whatsapp_leads table
2025-09-27 02:04:26,863 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-09-27 02:04:26,863 - handlers.lead_tracking_handler - INFO - Successfully tracked user interaction for phone number 2348055614455
2025-09-27 02:04:26,864 - handlers.base_handler - INFO - User chose to modify AI order for session 2348055614455.
2025-09-27 02:04:26,864 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-09-27 02:04:26,864 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Please tell me your updated order:'}}
2025-09-27 02:04:28,105 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ3MjkyMzI0MUI1RTY4NjBFQgA="}]}
2025-09-27 02:04:28,105 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ3MjkyMzI0MUI1RTY4NjBFQgA='}]}
2025-09-27 02:04:28,106 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:28] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:29,109 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:29,716 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:29,847 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:04:29,849 - werkzeug - INFO - 127.0.0.1 - - [27/Sep/2025 02:04:29] "POST /webhook HTTP/1.1" 200 -
2025-09-27 02:05:33,753 - handlers.product_sync_handler - INFO - Stopping product sync thread...
2025-09-27 02:05:33,754 - handlers.product_sync_handler - INFO - Product sync thread stopped.
