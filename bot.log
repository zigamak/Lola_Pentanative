2025-08-10 04:41:44,606 - utils.data_manager - INFO - Successfully loaded 16 user details from database
2025-08-10 04:41:44,813 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 04:41:44,814 - services.payment_service - INFO - PaymentService initialized
2025-08-10 04:41:44,814 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 04:41:44,814 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 04:41:44,815 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 04:41:44,816 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 04:41:44,816 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 04:41:44,820 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 04:41:45,191 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 04:41:45,191 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 04:41:45,191 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 04:41:45,192 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 04:41:45,209 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 04:41:45,209 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 04:41:50,910 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 04:41:50,911 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 04:41:53,111 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:41:54,556 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:41:53.311320+00:00, interaction_count=718, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:32:44.275696+00:00
2025-08-10 04:41:55,343 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:41:55,344 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 04:41:57,008 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 04:41:57,215 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 04:41:57,215 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'ziga'.
2025-08-10 04:41:57,216 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 04:41:58,406 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk0OUJFQzUzODZDODkxOERFRQA="}]}
2025-08-10 04:41:58,407 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk0OUJFQzUzODZDODkxOERFRQA='}]}
2025-08-10 04:41:58,408 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:41:58] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:41:59,420 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:41:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:41:59,555 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:41:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:01,641 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 04:42:03,417 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:42:05,497 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:42:03.617638+00:00, interaction_count=719, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:32:44.275696+00:00
2025-08-10 04:42:06,383 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:42:06,384 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:42:06,385 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 04:42:06,385 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 04:42:06,385 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 04:42:06,385 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 04:42:06,386 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 04:42:06,386 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 04:42:07,556 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5N0JBNzE5NTg5MUI5MUYxQgA="}]}
2025-08-10 04:42:07,557 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 04:42:07,558 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 04:42:08,480 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ5RDA2MjUxNTBFQkZBQTcwQQA="}]}
2025-08-10 04:42:08,481 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ5RDA2MjUxNTBFQkZBQTcwQQA='}]}
2025-08-10 04:42:08,482 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:08] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:09,109 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:09,639 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:09,775 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:09,837 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:10,240 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:10,356 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:13,903 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Plantain'}
2025-08-10 04:42:15,710 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:42:17,188 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:42:15.934885+00:00, interaction_count=720, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:32:44.275696+00:00
2025-08-10 04:42:17,815 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:42:17,816 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:42:17,816 - handlers.base_handler - INFO - AIHandler: Handling message 'plantain' in AI bulk order state for session 2348055614455. Original: 'Plantain'
2025-08-10 04:42:21,575 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 04:42:21,577 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 04:42:22,744 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI4MDc0NTc4MjlGODg2RTY4NAA="}]}
2025-08-10 04:42:22,745 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI4MDc0NTc4MjlGODg2RTY4NAA='}]}
2025-08-10 04:42:22,746 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:22] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:23,723 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:23] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:24,117 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:26,159 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 04:42:27,854 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:42:29,339 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:42:28.055879+00:00, interaction_count=721, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:32:44.275696+00:00
2025-08-10 04:42:29,984 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:42:29,984 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:42:29,985 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Plantain': {'item_id': '107', 'quantity': 1, 'price': 100.0, 'total_price': 100.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 04:42:29,985 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 04:42:29,986 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 04:42:29,986 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 04:42:29,987 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 04:42:29,987 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 04:42:30,950 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcyRjFBMjdCNUIzRUZEOUExNAA="}]}
2025-08-10 04:42:31,873 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:32,137 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:32] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:32,283 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:32] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:32,579 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:42:34,105 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 04:42:34,179 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:42:32.778821+00:00, interaction_count=722, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:32:44.275696+00:00
2025-08-10 04:42:34,791 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:42:34,797 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcyRjFBMjdCNUIzRUZEOUExNAA='}]}
2025-08-10 04:42:34,798 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:34] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:35,860 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:42:37,447 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:42:36.072309+00:00, interaction_count=723, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:32:44.275696+00:00
2025-08-10 04:42:38,098 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:42:38,099 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:42:38,100 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 04:42:38,100 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 04:42:38,106 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 04:42:39,008 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZFNzBDMEVGOTM4RjcyMTVGQwA="}]}
2025-08-10 04:42:40,174 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:40,300 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:40,381 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:40,735 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:42:42,170 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:42:40.933511+00:00, interaction_count=724, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:32:44.275696+00:00
2025-08-10 04:42:42,285 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 04:42:42,805 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:42:42,811 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZFNzBDMEVGOTM4RjcyMTVGQwA='}]}
2025-08-10 04:42:42,812 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:42:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:42:43,978 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:42:45,471 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:42:44.191390+00:00, interaction_count=725, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:32:44.275696+00:00
2025-08-10 04:42:46,076 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:42:46,077 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:42:46,077 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 04:42:49,337 - utils.data_manager - ERROR - Unexpected error saving order for customer 2348055614455: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 352, in save_user_order
    self.merchant_id,
    ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 04:42:49,340 - handlers.order_handler - INFO - Order None saved to database for session 2348055614455
2025-08-10 04:42:52,518 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 04:42:52,518 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 04:42:54,716 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:42:56,326 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:42:54.919062+00:00, interaction_count=726, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=order_completed, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:42:56,951 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:42:56,957 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 04:42:56,958 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 04:42:56,958 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 04:42:58,991 - utils.data_manager - ERROR - Unexpected error retrieving order None: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 641, in get_order_by_id
    (order_id, self.merchant_id)
               ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 04:42:58,993 - handlers.payment_handler - ERROR - Order None not found in database for session 2348055614455
2025-08-10 04:42:58,994 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 04:43:00,349 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY3MTQyODU5Njk2OTQ5REFFMwA="}]}
2025-08-10 04:43:01,427 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:43:01] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:43:01,697 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:43:01] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:43:02,051 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:43:03,625 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:43:02.249730+00:00, interaction_count=727, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:43:04,643 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:43:04,650 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY3MTQyODU5Njk2OTQ5REFFMwA='}]}
2025-08-10 04:43:04,651 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:43:04] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:15,470 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 04:44:16,930 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 04:44:18,656 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 04:44:18,868 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 04:44:21,033 - utils.data_manager - INFO - Successfully loaded 16 user details from database
2025-08-10 04:44:21,253 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 04:44:21,254 - services.payment_service - INFO - PaymentService initialized
2025-08-10 04:44:24,353 - handlers.product_sync_handler - INFO - Successfully synced 15 products to data\products.json
2025-08-10 04:44:24,557 - app - INFO - Initial product sync successful on startup
2025-08-10 04:44:24,558 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 04:44:24,558 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 04:44:24,558 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 04:44:24,566 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 04:44:26,342 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 04:44:26,638 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 04:44:29,467 - utils.data_manager - INFO - Successfully loaded 16 user details from database
2025-08-10 04:44:29,695 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 04:44:29,696 - services.payment_service - INFO - PaymentService initialized
2025-08-10 04:44:29,696 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 04:44:29,696 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 04:44:29,696 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 04:44:29,697 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 04:44:29,697 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 04:44:29,702 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 04:44:30,187 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 04:44:30,188 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 04:44:30,188 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 04:44:30,188 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 04:44:30,206 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 04:44:30,207 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 04:44:35,013 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 04:44:35,014 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 04:44:36,715 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:44:38,204 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:44:36.915303+00:00, interaction_count=728, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:44:38,903 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:44:38,904 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 04:44:40,696 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 04:44:40,902 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 04:44:40,902 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'ziga'.
2025-08-10 04:44:40,903 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 04:44:41,942 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI0RjJDMERCNkQwQjU1MzlBQQA="}]}
2025-08-10 04:44:41,943 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI0RjJDMERCNkQwQjU1MzlBQQA='}]}
2025-08-10 04:44:41,944 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:41] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:43,164 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:43,401 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:44,980 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 04:44:46,991 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:44:49,255 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:44:47.199691+00:00, interaction_count=729, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:44:49,911 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:44:49,912 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:44:49,912 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 04:44:49,912 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 04:44:49,912 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 04:44:49,913 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 04:44:49,913 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 04:44:49,913 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 04:44:51,610 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFEQzNDMUI4M0E0NjZDMzJDRgA="}]}
2025-08-10 04:44:51,611 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 04:44:51,612 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 04:44:52,436 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZDNjM1RTFEMUY4MTVERjQyOAA="}]}
2025-08-10 04:44:52,437 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZDNjM1RTFEMUY4MTVERjQyOAA='}]}
2025-08-10 04:44:52,438 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:52,817 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:52,921 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:53,011 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:53,514 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:54,119 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:54] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:54,153 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:44:54] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:44:56,085 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Plantain'}
2025-08-10 04:44:57,952 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:44:59,459 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:44:58.152073+00:00, interaction_count=730, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:45:00,103 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:45:00,103 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:45:00,104 - handlers.base_handler - INFO - AIHandler: Handling message 'plantain' in AI bulk order state for session 2348055614455. Original: 'Plantain'
2025-08-10 04:45:02,296 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 04:45:02,298 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 04:45:03,331 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZFODZBMDU3RUYzNjJEN0VDOQA="}]}
2025-08-10 04:45:03,332 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZFODZBMDU3RUYzNjJEN0VDOQA='}]}
2025-08-10 04:45:03,332 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:03] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:04,256 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:04] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:04,558 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:04] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:06,013 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 04:45:09,352 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:45:13,336 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:45:09.554375+00:00, interaction_count=731, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:45:15,380 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:45:15,381 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:45:15,381 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Plantain': {'item_id': '107', 'quantity': 1, 'price': 100.0, 'total_price': 100.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 04:45:15,382 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 04:45:15,382 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 04:45:15,382 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 04:45:15,383 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 04:45:15,383 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 04:45:16,313 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVENTEzNkE0NzY1MzAxQzIyQQA="}]}
2025-08-10 04:45:17,431 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:17,614 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:17,931 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:18,016 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:45:19,291 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 04:45:19,521 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:45:18.231475+00:00, interaction_count=732, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:45:20,208 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:45:20,214 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVENTEzNkE0NzY1MzAxQzIyQQA='}]}
2025-08-10 04:45:20,215 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:20] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:21,752 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:45:23,402 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:45:21.960560+00:00, interaction_count=733, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:45:24,039 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:45:24,040 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:45:24,040 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 04:45:24,040 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 04:45:24,045 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 04:45:25,015 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJCQzNBRDYzQ0FCREU5RTEwRAA="}]}
2025-08-10 04:45:26,493 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:26,666 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:27,334 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:45:28,015 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 04:45:29,270 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:45:27.537238+00:00, interaction_count=734, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:45:29,906 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:45:29,912 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJCQzNBRDYzQ0FCREU5RTEwRAA='}]}
2025-08-10 04:45:29,912 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:29,936 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:45:31,488 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:45:30.140822+00:00, interaction_count=735, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:42:54.919069+00:00
2025-08-10 04:45:32,098 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:45:32,099 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 04:45:32,099 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 04:45:33,938 - utils.data_manager - ERROR - Unexpected error saving order for customer 2348055614455: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 352, in save_user_order
    self.merchant_id,
    ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 04:45:33,942 - handlers.order_handler - INFO - Order None saved to database for session 2348055614455
2025-08-10 04:45:35,901 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 04:45:35,902 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 04:45:37,783 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:45:39,277 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:45:37.983258+00:00, interaction_count=736, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=order_completed, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 04:45:39,901 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:45:39,906 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 04:45:39,907 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 04:45:39,907 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 04:45:41,356 - utils.data_manager - ERROR - Unexpected error retrieving order None: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 641, in get_order_by_id
    (order_id, self.merchant_id)
               ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 04:45:41,358 - handlers.payment_handler - ERROR - Order None not found in database for session 2348055614455
2025-08-10 04:45:41,358 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 04:45:42,395 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA0QThCRjNBRTRCOUVEOTNDMwA="}]}
2025-08-10 04:45:43,581 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:43,724 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:43,811 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 04:45:44,077 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 04:45:45,876 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 03:45:44.276602+00:00, interaction_count=737, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 04:45:47,548 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 04:45:47,555 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA0QThCRjNBRTRCOUVEOTNDMwA='}]}
2025-08-10 04:45:47,556 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 04:45:47] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:33:08,896 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 17:33:10,456 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 17:33:12,585 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 17:33:12,826 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 17:33:14,756 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 17:33:14,970 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 17:33:14,971 - services.payment_service - INFO - PaymentService initialized
2025-08-10 17:33:16,627 - handlers.product_sync_handler - INFO - Successfully synced 15 products to data\products.json
2025-08-10 17:33:16,828 - app - INFO - Initial product sync successful on startup
2025-08-10 17:33:16,828 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 17:33:16,829 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 17:33:16,829 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 17:33:16,839 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 17:33:18,496 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 17:33:18,706 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 17:33:20,688 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 17:33:20,906 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 17:33:20,907 - services.payment_service - INFO - PaymentService initialized
2025-08-10 17:33:20,907 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 17:33:20,907 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 17:33:20,908 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 17:33:20,920 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 17:33:20,920 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 17:33:20,927 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 17:33:21,411 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 17:33:21,411 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 17:33:21,412 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 17:33:21,412 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 17:33:21,441 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 17:33:21,441 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 17:34:44,553 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 17:34:44,553 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 17:34:46,205 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:34:47,790 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:34:46.483251+00:00, interaction_count=738, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 17:34:48,547 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:34:48,548 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 17:34:50,282 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 17:34:50,490 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 17:34:50,491 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'ziga'.
2025-08-10 17:34:50,491 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:34:51,578 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM3QTBGNDY2NDk0MkJGOTYxNwA="}]}
2025-08-10 17:34:51,591 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM3QTBGNDY2NDk0MkJGOTYxNwA='}]}
2025-08-10 17:34:51,593 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:34:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:34:53,155 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:34:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:34:53,669 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:34:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:34:54,043 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:34:54] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:34:57,208 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 17:34:59,044 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:35:00,615 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:34:59.263256+00:00, interaction_count=739, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 17:35:01,397 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:35:01,398 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:35:01,398 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 17:35:01,398 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 17:35:01,398 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 17:35:01,399 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 17:35:01,399 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 17:35:01,399 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 17:35:02,446 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg5Rjc1MTFCNDZFMUI2NTRGMAA="}]}
2025-08-10 17:35:02,447 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 17:35:02,447 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 17:35:03,151 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIzMjQ2MDE2ODczODlCNjZDQQA="}]}
2025-08-10 17:35:03,151 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIzMjQ2MDE2ODczODlCNjZDQQA='}]}
2025-08-10 17:35:03,152 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:03] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:04,545 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:04] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:05,061 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:05,147 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:05,226 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:05,282 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:05,669 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:09,354 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-10 17:35:11,105 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:35:12,675 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:35:11.317272+00:00, interaction_count=740, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 17:35:13,299 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:35:13,301 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:35:13,301 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-10 17:35:16,968 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 17:35:16,977 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:35:17,790 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyNDg3QTBDNTI2MTE5NzUxMAA="}]}
2025-08-10 17:35:17,791 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIyNDg3QTBDNTI2MTE5NzUxMAA='}]}
2025-08-10 17:35:17,792 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:18,974 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:19,102 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:19,209 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:21,411 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 17:35:23,195 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:35:24,682 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:35:23.400130+00:00, interaction_count=741, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 17:35:25,291 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:35:25,292 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:35:25,292 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 17:35:25,292 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 17:35:25,293 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 17:35:25,293 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 17:35:25,294 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 17:35:25,299 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:35:26,096 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyQzlCRUFGRDZGNzgyQTY5RAA="}]}
2025-08-10 17:35:27,396 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:27,516 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:27,571 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:27,806 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:35:29,277 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:35:28.004131+00:00, interaction_count=742, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 17:35:29,887 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:35:29,906 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEyQzlCRUFGRDZGNzgyQTY5RAA='}]}
2025-08-10 17:35:29,907 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:40,421 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 17:35:42,358 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:35:44,621 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:35:42.924956+00:00, interaction_count=743, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 17:35:45,351 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:35:45,353 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:35:45,354 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 17:35:45,354 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 17:35:45,361 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:35:47,195 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE3ODdGNTQ5ODlEQzU1RDNDQgA="}]}
2025-08-10 17:35:48,307 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:48] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:48,543 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:48] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:48,577 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:48] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:48,912 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:35:50,482 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:35:49.117092+00:00, interaction_count=744, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 17:35:51,129 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:35:51,185 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE3ODdGNTQ5ODlEQzU1RDNDQgA='}]}
2025-08-10 17:35:51,188 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:35:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:35:53,845 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 17:35:55,617 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:35:57,086 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:35:55.812164+00:00, interaction_count=745, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-10 03:45:37.983267+00:00
2025-08-10 17:35:57,689 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:35:57,691 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:35:57,691 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 17:35:58,977 - utils.data_manager - ERROR - Unexpected error saving order for customer 2348055614455: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 352, in save_user_order
    self.merchant_id,
    ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 17:35:58,980 - handlers.order_handler - INFO - Order None saved to database for session 2348055614455
2025-08-10 17:36:00,912 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 17:36:00,913 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 17:36:02,626 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:36:04,106 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:36:02.828166+00:00, interaction_count=746, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:36:04,729 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:36:04,735 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 17:36:04,735 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 17:36:04,736 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 17:36:06,156 - utils.data_manager - ERROR - Unexpected error retrieving order None: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 641, in get_order_by_id
    (order_id, self.merchant_id)
               ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 17:36:06,158 - handlers.payment_handler - ERROR - Order None not found in database for session 2348055614455
2025-08-10 17:36:06,158 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 17:36:07,069 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFFMzUzOEY3NTcwOTkxOTkzRQA="}]}
2025-08-10 17:36:08,250 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:36:08] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:36:08,449 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:36:08] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:36:08,470 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:36:08] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:36:08,751 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:36:10,217 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:36:08.955932+00:00, interaction_count=747, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:36:10,898 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:36:10,903 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFFMzUzOEY3NTcwOTkxOTkzRQA='}]}
2025-08-10 17:36:10,904 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:36:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:43:14,572 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 17:43:15,683 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 17:43:19,283 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 17:43:19,504 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 17:43:21,676 - utils.data_manager - ERROR - Database error while loading user details: column "merchant_details_id" does not exist
LINE 11:                         WHERE merchant_details_id = '18'
                                       ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 262, in load_user_details
    cur.execute(query, (self.merchant_id,))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedColumn: column "merchant_details_id" does not exist
LINE 11:                         WHERE merchant_details_id = '18'
                                       ^

2025-08-10 17:43:21,681 - utils.data_manager - INFO - DataManager initialized with merchant_id: 18
2025-08-10 17:43:21,681 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 17:43:21,682 - services.payment_service - INFO - PaymentService initialized
2025-08-10 17:43:23,667 - handlers.product_sync_handler - INFO - Successfully synced 15 products to data\products.json
2025-08-10 17:43:23,869 - app - INFO - Initial product sync successful on startup
2025-08-10 17:43:23,869 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 17:43:23,870 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 17:43:23,870 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 17:43:23,877 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 17:43:25,746 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 17:43:25,955 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 17:43:28,004 - utils.data_manager - ERROR - Database error while loading user details: column "merchant_details_id" does not exist
LINE 11:                         WHERE merchant_details_id = '18'
                                       ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 262, in load_user_details
    cur.execute(query, (self.merchant_id,))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedColumn: column "merchant_details_id" does not exist
LINE 11:                         WHERE merchant_details_id = '18'
                                       ^

2025-08-10 17:43:28,006 - utils.data_manager - INFO - DataManager initialized with merchant_id: 18
2025-08-10 17:43:28,006 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 17:43:28,007 - services.payment_service - INFO - PaymentService initialized
2025-08-10 17:43:28,007 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 17:43:28,007 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 17:43:28,007 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 17:43:28,008 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 17:43:28,008 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 17:43:28,013 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 17:43:28,382 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 17:43:28,383 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 17:43:28,383 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 17:43:28,383 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 17:43:28,400 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 17:43:28,400 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 17:43:52,998 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 17:43:52,998 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 17:43:55,067 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:43:56,522 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:43:55.274003+00:00, interaction_count=748, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:43:57,208 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:43:57,208 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 17:43:58,944 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 17:44:01,144 - utils.data_manager - ERROR - Database error while saving user details for 2348055614455: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 306, in save_user_details
    cur.execute(query, (
    ~~~~~~~~~~~^^^^^^^^^
        user_id,
        ^^^^^^^^
    ...<6 lines>...
        self.merchant_id
        ^^^^^^^^^^^^^^^^
    ))
    ^^
psycopg2.errors.UndefinedColumn: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^

2025-08-10 17:44:01,146 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'address': 'horizon estate'}
2025-08-10 17:44:01,147 - handlers.base_handler - INFO - Session 2348055614455: New user or missing details. Initiating onboarding.
2025-08-10 17:44:01,147 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 17:44:01,148 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Hello Ziga, welcome to Lola!\nPlease enter your preferred name.'}}
2025-08-10 17:44:02,048 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4QzQ0QzgxNDIxN0VGNzZBMgA="}]}
2025-08-10 17:44:02,048 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4QzQ0QzgxNDIxN0VGNzZBMgA='}]}
2025-08-10 17:44:02,049 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:44:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:44:03,179 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:44:03] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:44:03,300 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:44:03] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:44:03,501 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:44:03] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:44:32,028 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Victor Makinde'}
2025-08-10 17:44:36,215 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:44:38,194 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:44:36.417105+00:00, interaction_count=749, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:44:38,834 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:44:38,835 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:44:38,835 - handlers.base_handler - INFO - Session 2348055614455: Preferred name received: 'victor makinde'.
2025-08-10 17:44:38,835 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'address': 'horizon estate'}
2025-08-10 17:44:40,755 - utils.data_manager - ERROR - Database error while saving user details for 2348055614455: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 306, in save_user_details
    cur.execute(query, (
    ~~~~~~~~~~~^^^^^^^^^
        user_id,
        ^^^^^^^^
    ...<6 lines>...
        self.merchant_id
        ^^^^^^^^^^^^^^^^
    ))
    ^^
psycopg2.errors.UndefinedColumn: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^

2025-08-10 17:44:40,756 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 17:44:40,757 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Thanks, victor makinde! Now, please enter your delivery address.'}}
2025-08-10 17:44:41,477 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ1QTc3NkJDNDgzRjdBREJBRQA="}]}
2025-08-10 17:44:41,478 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ1QTc3NkJDNDgzRjdBREJBRQA='}]}
2025-08-10 17:44:41,479 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:44:41] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:44:42,568 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:44:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:44:42,906 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:44:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:44:43,038 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:44:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:44:56,398 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Howson wright'}
2025-08-10 17:44:58,074 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:44:59,571 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:44:58.271331+00:00, interaction_count=750, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:45:00,186 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:45:00,187 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:45:00,187 - handlers.base_handler - INFO - Session 2348055614455: Delivery address received: 'howson wright'.
2025-08-10 17:45:00,188 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'address': 'horizon estate', 'user_perferred_name': 'victor makinde', 'display_name': 'victor makinde', 'user_id': '2348055614455', 'user_number': '2348055614455'}
2025-08-10 17:45:02,108 - utils.data_manager - ERROR - Database error while saving user details for 2348055614455: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 306, in save_user_details
    cur.execute(query, (
    ~~~~~~~~~~~^^^^^^^^^
        user_id,
        ^^^^^^^^
    ...<6 lines>...
        self.merchant_id
        ^^^^^^^^^^^^^^^^
    ))
    ^^
psycopg2.errors.UndefinedColumn: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^

2025-08-10 17:45:02,109 - handlers.base_handler - INFO - Session 2348055614455 onboarding complete. Greeting victor makinde.
2025-08-10 17:45:02,110 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:45:02,892 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUyMTY0REQ0N0Y4RjBBRTRCRQA="}]}
2025-08-10 17:45:02,893 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUyMTY0REQ0N0Y4RjBBRTRCRQA='}]}
2025-08-10 17:45:02,894 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:04,128 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:04] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:04,189 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:04] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:04,288 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:04] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:08,588 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 17:45:10,373 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:45:11,974 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:45:10.591919+00:00, interaction_count=751, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:45:12,605 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:45:12,606 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:45:12,606 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 17:45:12,607 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 17:45:12,607 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 17:45:12,607 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 17:45:12,607 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 17:45:12,608 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 17:45:13,883 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkyRkRDOEI4MkE1MEFCREE5RQA="}]}
2025-08-10 17:45:13,884 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 17:45:13,885 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 17:45:14,750 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVEMTYzQTQ4Njg0NzIxMTE3OQA="}]}
2025-08-10 17:45:14,751 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVEMTYzQTQ4Njg0NzIxMTE3OQA='}]}
2025-08-10 17:45:14,752 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:14] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:15,779 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:16,496 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:16,631 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:16,723 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:16,906 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:16,909 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:22,996 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-10 17:45:24,749 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:45:26,209 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:45:24.958492+00:00, interaction_count=752, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:45:26,827 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:45:26,828 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:45:26,829 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-10 17:45:29,411 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 17:45:29,413 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:45:30,253 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk5MDQxNTE2NEI0MUJBQTk0MgA="}]}
2025-08-10 17:45:30,254 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk5MDQxNTE2NEI0MUJBQTk0MgA='}]}
2025-08-10 17:45:30,255 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:30] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:31,479 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:31,560 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:31,706 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:34,600 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 17:45:36,551 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:45:38,040 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:45:36.748776+00:00, interaction_count=753, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:45:38,670 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:45:38,671 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:45:38,671 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 17:45:38,671 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 17:45:38,672 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'address': 'howson wright', 'user_perferred_name': 'victor makinde', 'display_name': 'victor makinde', 'user_id': '2348055614455', 'user_number': '2348055614455'}
2025-08-10 17:45:38,672 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 17:45:38,673 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 17:45:38,673 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:45:39,384 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVDOTIxOThENzc2NTYyOTlCMQA="}]}
2025-08-10 17:45:40,683 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:40,814 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:41,003 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:41] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:41,235 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:45:42,692 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:45:41.434964+00:00, interaction_count=754, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:45:42,796 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 17:45:43,300 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:45:43,307 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVDOTIxOThENzc2NTYyOTlCMQA='}]}
2025-08-10 17:45:43,308 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:44,593 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:45:46,197 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:45:44.885435+00:00, interaction_count=755, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:45:46,808 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:45:46,809 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:45:46,809 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 17:45:46,809 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'address': 'howson wright', 'user_perferred_name': 'victor makinde', 'display_name': 'victor makinde', 'user_id': '2348055614455', 'user_number': '2348055614455'}
2025-08-10 17:45:46,815 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:45:47,588 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5NzAzNjlCMTAwMDREM0RERAA="}]}
2025-08-10 17:45:48,703 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:48] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:49,068 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:49] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:49,131 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:49] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:45:49,288 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:45:50,861 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:45:49.548720+00:00, interaction_count=756, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:45:51,846 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:45:51,853 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5NzAzNjlCMTAwMDREM0RERAA='}]}
2025-08-10 17:45:51,854 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:45:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:46:02,199 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 17:46:04,022 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:46:05,563 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:46:04.222976+00:00, interaction_count=757, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:36:02.828174+00:00
2025-08-10 17:46:06,192 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:46:06,192 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:46:06,193 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'address': 'howson wright', 'user_perferred_name': 'victor makinde', 'display_name': 'victor makinde', 'user_id': '2348055614455', 'user_number': '2348055614455'}
2025-08-10 17:46:08,003 - utils.data_manager - INFO - Saved order 160 for customer 2348055614455
2025-08-10 17:46:08,219 - utils.data_manager - INFO - Saved order item Jollof Rice for order 160
2025-08-10 17:46:08,421 - handlers.order_handler - INFO - Order 160 saved to database for session 2348055614455
2025-08-10 17:46:10,353 - utils.data_manager - ERROR - Database error while saving user details for 2348055614455: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 306, in save_user_details
    cur.execute(query, (
    ~~~~~~~~~~~^^^^^^^^^
        user_id,
        ^^^^^^^^
    ...<6 lines>...
        self.merchant_id
        ^^^^^^^^^^^^^^^^
    ))
    ^^
psycopg2.errors.UndefinedColumn: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^

2025-08-10 17:46:10,354 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 17:46:12,170 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:46:13,619 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:46:12.369922+00:00, interaction_count=758, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-10 16:46:12.369930+00:00
2025-08-10 17:46:14,223 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:46:14,228 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 17:46:14,229 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 17:46:14,229 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 17:46:18,076 - utils.data_manager - INFO - Updated order 160 to status pending_payment
2025-08-10 17:46:18,077 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-10 17:46:18,078 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-160 with amount: 253750, email: victor4455@lola.com
2025-08-10 17:46:18,996 - services.payment_service - INFO - Payment link created for victor makinde (2348055614455), URL: https://checkout.paystack.com/c8yhymnobmh4sqx
2025-08-10 17:46:18,997 - handlers.payment_handler - INFO - Starting payment monitoring for order 160, reference PAY-160
2025-08-10 17:46:18,997 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-160
2025-08-10 17:46:19,591 - services.payment_service - WARNING - Payment not successful for reference PAY-160. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5226599850, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-160', 'receipt_number': None, 'amount': 253750, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-10T16:46:19.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.85.139, 172.68.229.163, 172.31.63.81', 'metadata': {'customer_name': 'victor makinde', 'customer_phone': '2348055614455', 'first_name': 'victor', 'last_name': 'makinde', 'order_id': '160', 'delivery_address': 'horizon estate', 'delivery_fee': '1000', 'service_charge': '37.5', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 13807, 'integration': '2537', 'subaccount': 237406, 'params': {'bearer': 'subaccount', 'transaction_charge': '2537', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 298544392, 'first_name': None, 'last_name': None, 'email': 'victor4455@lola.com', 'customer_code': 'CUS_7jin6ox9ekhe6y3', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-10T16:46:19.000Z', 'requested_amount': 253750, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-10T16:46:19.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-10 17:46:19,591 - handlers.payment_handler - INFO - Payment not yet verified for order 160, attempt 1/15
2025-08-10 17:46:19,592 - handlers.payment_handler - INFO - Payment link created successfully for order 160 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-10 17:46:21,279 - utils.data_manager - INFO - Retrieved 1 items for order 160
2025-08-10 17:46:21,486 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 17:46:22,235 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ1RDcxM0U5OTUwMTQ2MThFMAA="}]}
2025-08-10 17:46:23,404 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:46:23] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:46:23,580 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:46:23] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:46:23,827 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:46:23] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:46:23,890 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:46:25,327 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:46:24.089983+00:00, interaction_count=759, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 16:46:12.369930+00:00
2025-08-10 17:46:25,955 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:46:25,960 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ1RDcxM0U5OTUwMTQ2MThFMAA='}]}
2025-08-10 17:46:25,960 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:46:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:46:36,163 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-160
2025-08-10 17:46:38,140 - handlers.payment_handler - ERROR - Error handling payment webhook for reference PAY-160: 'order_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\payment_handler.py", line 880, in handle_payment_webhook
    order_data["order_id"],
    ~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'order_id'
2025-08-10 17:46:38,142 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:46:38] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-10 17:47:19,607 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-160
2025-08-10 17:47:20,193 - services.payment_service - INFO - Payment verified successfully for reference PAY-160. Status: success
2025-08-10 17:47:20,195 - handlers.payment_handler - INFO - Payment verified for order 160 on attempt 2
2025-08-10 17:47:20,197 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-160
2025-08-10 17:47:20,757 - services.payment_service - INFO - Payment verified successfully for reference PAY-160. Status: success
2025-08-10 17:47:24,582 - utils.data_manager - INFO - Updated order 160 to status confirmed
2025-08-10 17:47:26,353 - utils.data_manager - INFO - Retrieved 1 items for order 160
2025-08-10 17:47:27,819 - utils.data_manager - ERROR - Invalid order item for order 160: missing product_id or quantity: {'item_name': 'Jollof Rice', 'quantity': 1, 'unit_price': 1500.0, 'subtotal': 1500.0, 'product_id': None}
2025-08-10 17:47:27,820 - handlers.payment_handler - ERROR - Failed to reduce inventory for order 160
2025-08-10 17:47:27,820 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 17:47:28,867 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkQzNDU2MkI5NkE0QkQ1OTk0QgA="}]}
2025-08-10 17:47:30,114 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:47:30] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:47:32,157 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:47:32] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:47:32,527 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:47:34,031 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:47:32.737356+00:00, interaction_count=760, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:47:34,649 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:55:31,031 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:55:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:57:24,232 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 17:57:25,774 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 17:57:27,808 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 17:57:28,013 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 17:57:30,202 - utils.data_manager - ERROR - Database error while loading user details: column "merchant_details_id" does not exist
LINE 11:                         WHERE merchant_details_id = '18'
                                       ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 262, in load_user_details
    cur.execute(query, (self.merchant_id,))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedColumn: column "merchant_details_id" does not exist
LINE 11:                         WHERE merchant_details_id = '18'
                                       ^

2025-08-10 17:57:30,209 - utils.data_manager - INFO - DataManager initialized with merchant_id: 18
2025-08-10 17:57:30,209 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 17:57:30,210 - services.payment_service - INFO - PaymentService initialized
2025-08-10 17:57:31,948 - handlers.product_sync_handler - INFO - Successfully synced 15 products to data\products.json
2025-08-10 17:57:32,150 - app - INFO - Initial product sync successful on startup
2025-08-10 17:57:32,151 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 17:57:32,151 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 17:57:32,151 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 17:57:32,171 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 17:57:34,153 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 17:57:34,493 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 17:57:37,118 - utils.data_manager - ERROR - Database error while loading user details: column "merchant_details_id" does not exist
LINE 11:                         WHERE merchant_details_id = '18'
                                       ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 262, in load_user_details
    cur.execute(query, (self.merchant_id,))
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.UndefinedColumn: column "merchant_details_id" does not exist
LINE 11:                         WHERE merchant_details_id = '18'
                                       ^

2025-08-10 17:57:37,119 - utils.data_manager - INFO - DataManager initialized with merchant_id: 18
2025-08-10 17:57:37,120 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 17:57:37,120 - services.payment_service - INFO - PaymentService initialized
2025-08-10 17:57:37,120 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 17:57:37,121 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 17:57:37,121 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 17:57:37,122 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 17:57:37,123 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 17:57:37,129 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 17:57:37,573 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 17:57:37,574 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 17:57:37,574 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 17:57:37,574 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 17:57:37,605 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 17:57:37,605 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 17:58:12,967 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 17:58:12,967 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 17:58:14,685 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:58:16,400 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:58:14.888492+00:00, interaction_count=761, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:58:17,799 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:58:17,800 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 17:58:19,533 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 17:58:21,680 - utils.data_manager - ERROR - Database error while saving user details for 2348055614455: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 306, in save_user_details
    cur.execute(query, (
    ~~~~~~~~~~~^^^^^^^^^
        user_id,
        ^^^^^^^^
    ...<6 lines>...
        self.merchant_id
        ^^^^^^^^^^^^^^^^
    ))
    ^^
psycopg2.errors.UndefinedColumn: column "merchant_details_id" of relation "whatsapp_user_details" does not exist
LINE 4: ...         user_perferred_name, address2, address3, merchant_d...
                                                             ^

2025-08-10 17:58:21,682 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'address': 'horizon estate'}
2025-08-10 17:58:21,683 - handlers.base_handler - INFO - Session 2348055614455: New user or missing details. Initiating onboarding.
2025-08-10 17:58:21,683 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 17:58:21,684 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Hello Ziga, welcome to Lola!\nPlease enter your preferred name.'}}
2025-08-10 17:58:22,764 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE0MDQxNzdFNEU5QTQ0REUxNgA="}]}
2025-08-10 17:58:22,765 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE0MDQxNzdFNEU5QTQ0REUxNgA='}]}
2025-08-10 17:58:22,766 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:58:22] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:58:24,167 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:58:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:58:24,299 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:58:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:58:24,302 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:58:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:58:37,152 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 17:58:38,340 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 17:58:40,070 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 17:58:40,283 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 17:58:42,199 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 17:58:42,439 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 17:58:42,440 - services.payment_service - INFO - PaymentService initialized
2025-08-10 17:58:44,121 - handlers.product_sync_handler - INFO - Successfully synced 15 products to data\products.json
2025-08-10 17:58:44,316 - app - INFO - Initial product sync successful on startup
2025-08-10 17:58:44,317 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 17:58:44,317 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 17:58:44,317 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 17:58:44,324 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 17:58:46,037 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 17:58:46,244 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 17:58:48,534 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 17:58:48,738 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 17:58:48,738 - services.payment_service - INFO - PaymentService initialized
2025-08-10 17:58:48,739 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 17:58:48,739 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 17:58:48,739 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 17:58:48,740 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 17:58:48,741 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 17:58:48,747 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 17:58:49,135 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 17:58:49,135 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 17:58:49,135 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 17:58:49,136 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 17:58:49,158 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 17:58:49,158 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 17:59:00,969 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 17:59:00,969 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 17:59:02,916 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:59:04,407 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:59:03.121648+00:00, interaction_count=762, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:59:05,060 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:59:05,061 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 17:59:06,727 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 17:59:06,934 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 17:59:06,935 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'ziga'.
2025-08-10 17:59:06,935 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:59:07,866 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhBRjA5OUQ2NTc4QzRDRUJFRAA="}]}
2025-08-10 17:59:07,867 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhBRjA5OUQ2NTc4QzRDRUJFRAA='}]}
2025-08-10 17:59:07,868 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:07] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:08,887 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:08] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:09,133 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:09,265 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:11,400 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 17:59:13,406 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:59:15,057 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:59:13.613903+00:00, interaction_count=763, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:59:15,120 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 17:59:15,666 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:59:15,667 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:59:15,667 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 17:59:15,668 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 17:59:15,668 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 17:59:15,668 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 17:59:15,669 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 17:59:15,669 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 17:59:16,655 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZDODVEMzMwODNDODlGREFFNAA="}]}
2025-08-10 17:59:16,656 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 17:59:16,656 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 17:59:16,766 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:59:17,379 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ3QjRERUQ5QkNERjQxMDQwNwA="}]}
2025-08-10 17:59:17,380 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ3QjRERUQ5QkNERjQxMDQwNwA='}]}
2025-08-10 17:59:17,381 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:18,536 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:18,726 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:59:16.962481+00:00, interaction_count=764, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:59:19,298 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:19,321 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:19,325 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:19,389 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:59:19,391 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:59:19,392 - handlers.base_handler - INFO - AIHandler: Handling message 'hello' in AI bulk order state for session 2348055614455. Original: 'Hello'
2025-08-10 17:59:19,615 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:20,218 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:20] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:22,137 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 17:59:22,140 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 17:59:22,995 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk0ODM3NUNFMDNDQzZGNUNEOQA="}]}
2025-08-10 17:59:22,995 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk0ODM3NUNFMDNDQzZGNUNEOQA='}]}
2025-08-10 17:59:22,996 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:22] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:24,163 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:24,682 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-10 17:59:24,905 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:25,003 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:26,407 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:59:28,059 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:59:26.627297+00:00, interaction_count=765, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:59:28,659 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:59:28,660 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:59:28,660 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-10 17:59:30,774 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 17:59:30,775 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:59:31,820 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI0NTlCODMxMjU0REU0RkY4QQA="}]}
2025-08-10 17:59:31,821 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI0NTlCODMxMjU0REU0RkY4QQA='}]}
2025-08-10 17:59:31,822 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:32,765 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:32] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:32,895 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:32] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:33,232 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:33] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:34,861 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 17:59:36,603 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:59:39,038 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:59:37.207464+00:00, interaction_count=766, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:59:39,822 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:59:39,823 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:59:39,823 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 17:59:39,823 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 17:59:39,824 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 17:59:39,824 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 17:59:39,824 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 17:59:39,824 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:59:40,640 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhBMzc2RDlEQkYyMzYzQjQ0RQA="}]}
2025-08-10 17:59:41,985 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:41] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:42,108 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:42,110 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:42,370 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:59:43,792 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:59:42.566607+00:00, interaction_count=767, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:59:44,037 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 17:59:44,549 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:59:44,557 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhBMzc2RDlEQkYyMzYzQjQ0RQA='}]}
2025-08-10 17:59:44,558 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:45,919 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:59:47,484 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:59:46.124219+00:00, interaction_count=768, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:59:48,099 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:59:48,101 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:59:48,101 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 17:59:48,102 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 17:59:48,109 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 17:59:48,966 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0MzE4RTcwNzJCQUEwMkNFMwA="}]}
2025-08-10 17:59:50,119 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:50,273 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:50,422 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:50,679 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:59:52,283 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:59:50.919236+00:00, interaction_count=769, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:59:52,939 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:59:52,947 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0MzE4RTcwNzJCQUEwMkNFMwA='}]}
2025-08-10 17:59:52,948 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 17:59:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 17:59:55,786 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 17:59:57,673 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 17:59:59,118 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 16:59:57.871771+00:00, interaction_count=770, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 16:47:32.737366+00:00
2025-08-10 17:59:59,757 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 17:59:59,758 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 17:59:59,758 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:00:01,119 - utils.data_manager - ERROR - Unexpected error saving order for customer 2348055614455: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 352, in save_user_order
    self.merchant_id,
    ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 18:00:01,124 - handlers.order_handler - INFO - Order None saved to database for session 2348055614455
2025-08-10 18:00:03,045 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 18:00:03,046 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 18:00:04,718 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:00:06,199 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:00:04.924208+00:00, interaction_count=771, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:00:06,821 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:00:06,828 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 18:00:06,829 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 18:00:06,830 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 18:00:08,122 - utils.data_manager - ERROR - Unexpected error retrieving order None: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 641, in get_order_by_id
    (order_id, self.merchant_id)
               ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 18:00:08,127 - handlers.payment_handler - ERROR - Order None not found in database for session 2348055614455
2025-08-10 18:00:08,127 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:00:08,945 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJDRTBEMDc3REYwNzU3RkJBNAA="}]}
2025-08-10 18:00:10,187 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:00:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:00:10,296 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:00:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:00:10,515 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:00:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:00:11,050 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:00:12,660 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:00:11.256967+00:00, interaction_count=772, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:00:13,263 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:00:13,269 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJDRTBEMDc3REYwNzU3RkJBNAA='}]}
2025-08-10 18:00:13,270 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:00:13] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:01:55,090 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 18:01:56,271 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 18:01:57,963 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 18:01:58,209 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 18:02:00,930 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 18:02:01,130 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 18:02:01,131 - services.payment_service - INFO - PaymentService initialized
2025-08-10 18:02:02,969 - handlers.product_sync_handler - INFO - Successfully synced 15 products to data\products.json
2025-08-10 18:02:03,160 - app - INFO - Initial product sync successful on startup
2025-08-10 18:02:03,161 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 18:02:03,161 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 18:02:03,161 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 18:02:03,167 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 18:02:04,823 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 18:02:05,037 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 18:02:06,944 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 18:02:07,136 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 18:02:07,137 - services.payment_service - INFO - PaymentService initialized
2025-08-10 18:02:07,137 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 18:02:07,137 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 18:02:07,138 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 18:02:07,139 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 18:02:07,139 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 18:02:07,145 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 18:02:07,559 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 18:02:07,560 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 18:02:07,560 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 18:02:07,560 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 18:02:07,582 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 18:02:07,583 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 18:02:08,905 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 18:02:08,906 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 18:02:10,711 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:02:12,279 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:02:10.919413+00:00, interaction_count=773, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:02:12,977 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:02:12,978 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 18:02:14,629 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 18:02:14,830 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:02:14,830 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'ziga'.
2025-08-10 18:02:14,831 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:02:15,736 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRGQkVFRDlDQ0JCRDJERjQ1NQA="}]}
2025-08-10 18:02:15,737 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRGQkVFRDlDQ0JCRDJERjQ1NQA='}]}
2025-08-10 18:02:15,738 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:17,129 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:17,190 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:18,543 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 18:02:20,746 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:02:22,352 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:02:20.955245+00:00, interaction_count=774, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:02:22,963 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:02:22,964 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:02:22,965 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 18:02:22,965 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 18:02:22,965 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 18:02:22,966 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 18:02:22,966 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 18:02:22,967 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 18:02:23,955 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQxNjBDNjU2NzEyREJGRjM2MAA="}]}
2025-08-10 18:02:23,956 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:02:23,956 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 18:02:24,852 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZBQzg2QUVBRDlEMEVCMUYyRQA="}]}
2025-08-10 18:02:24,853 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZBQzg2QUVBRDlEMEVCMUYyRQA='}]}
2025-08-10 18:02:24,854 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:25,906 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:26,197 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:26,271 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:26,491 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:26,804 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:26,859 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:30,810 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-10 18:02:32,988 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:02:34,518 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:02:33.199282+00:00, interaction_count=775, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:02:35,197 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:02:35,197 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:02:35,198 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-10 18:02:41,286 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 18:02:41,289 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:02:42,162 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZENzlFODg4OEVEOTRFNzE1OQA="}]}
2025-08-10 18:02:42,162 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZENzlFODg4OEVEOTRFNzE1OQA='}]}
2025-08-10 18:02:42,163 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:43,470 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:43,514 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:43,814 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:46,197 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 18:02:47,994 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:02:49,603 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:02:48.199205+00:00, interaction_count=776, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:02:50,242 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:02:50,243 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:02:50,243 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 18:02:50,244 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 18:02:50,244 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:02:50,244 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 18:02:50,245 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 18:02:50,245 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:02:51,144 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJGODgxQkY3MTY2QTQzMzBDQgA="}]}
2025-08-10 18:02:52,094 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:52,225 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:52,437 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:52,880 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:02:54,423 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:02:53.136817+00:00, interaction_count=777, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:02:54,498 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 18:02:55,072 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:02:55,079 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJGODgxQkY3MTY2QTQzMzBDQgA='}]}
2025-08-10 18:02:55,080 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:02:55] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:02:56,200 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:02:57,864 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:02:56.494645+00:00, interaction_count=778, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:02:58,718 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:02:58,719 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:02:58,719 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 18:02:58,720 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:02:58,726 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:02:59,737 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNCMUFDMEM2QjI4Q0M0QTE4RAA="}]}
2025-08-10 18:03:00,931 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:03:00] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:03:01,069 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:03:01] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:03:01,091 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:03:01] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:03:03,166 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:03:04,356 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 18:03:04,719 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:03:03.398412+00:00, interaction_count=779, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:03:05,330 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:03:05,338 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNCMUFDMEM2QjI4Q0M0QTE4RAA='}]}
2025-08-10 18:03:05,339 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:03:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:03:06,046 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:03:07,548 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:03:06.246698+00:00, interaction_count=780, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:00:04.924216+00:00
2025-08-10 18:03:08,205 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:03:08,205 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:03:08,206 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:03:09,484 - utils.data_manager - ERROR - Unexpected error saving order for customer 2348055614455: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 352, in save_user_order
    self.merchant_id,
    ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 18:03:09,487 - handlers.order_handler - INFO - Order None saved to database for session 2348055614455
2025-08-10 18:03:11,441 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 18:03:11,442 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 18:03:13,318 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:03:14,854 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:03:13.523817+00:00, interaction_count=781, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:03:15,468 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:03:15,476 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 18:03:15,477 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 18:03:15,477 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 18:03:16,756 - utils.data_manager - ERROR - Unexpected error retrieving order None: 'DataManager' object has no attribute 'merchant_id'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 640, in get_order_by_id
    (order_id, self.merchant_id)
               ^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_id'
2025-08-10 18:03:16,759 - handlers.payment_handler - ERROR - Order None not found in database for session 2348055614455
2025-08-10 18:03:16,759 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:03:17,705 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVFNEVGQjEyQ0EwRUY5Q0NCQgA="}]}
2025-08-10 18:03:18,831 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:03:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:03:19,003 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:03:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:03:19,122 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:03:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:03:19,438 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:03:20,986 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:03:19.638031+00:00, interaction_count=782, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:03:21,599 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:03:21,608 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVFNEVGQjEyQ0EwRUY5Q0NCQgA='}]}
2025-08-10 18:03:21,609 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:03:21] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:09:38,455 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:09:38] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:12,783 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 18:15:14,136 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 18:15:16,876 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 18:15:17,109 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 18:15:19,755 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 18:15:19,967 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 18:15:19,967 - services.payment_service - INFO - PaymentService initialized
2025-08-10 18:15:21,662 - handlers.product_sync_handler - INFO - Successfully synced 15 products to data\products.json
2025-08-10 18:15:21,882 - app - INFO - Initial product sync successful on startup
2025-08-10 18:15:21,883 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 18:15:21,883 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 18:15:21,883 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 18:15:21,896 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 18:15:24,369 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 18:15:24,596 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 18:15:27,100 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 18:15:27,302 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 18:15:27,302 - services.payment_service - INFO - PaymentService initialized
2025-08-10 18:15:27,303 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 18:15:27,303 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 18:15:27,303 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 18:15:27,315 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 18:15:27,315 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 18:15:27,321 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 18:15:27,746 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 18:15:27,746 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 18:15:27,746 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 18:15:27,747 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 18:15:27,779 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 18:15:27,779 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 18:15:31,629 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 18:15:31,630 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 18:15:33,480 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:15:35,169 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:15:33.723016+00:00, interaction_count=783, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:15:35,822 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:15:35,823 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 18:15:37,584 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 18:15:37,878 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:15:37,878 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'ziga'.
2025-08-10 18:15:37,879 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:15:38,793 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExNUY4QUY1QzE4RUFCRDUxNAA="}]}
2025-08-10 18:15:38,795 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkExNUY4QUY1QzE4RUFCRDUxNAA='}]}
2025-08-10 18:15:38,796 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:38] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:40,018 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:40,150 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:40,285 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:41,951 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 18:15:43,764 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:15:45,765 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:15:43.965704+00:00, interaction_count=784, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:15:46,480 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:15:46,482 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:15:46,482 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 18:15:46,483 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 18:15:46,483 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 18:15:46,483 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 18:15:46,484 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 18:15:46,484 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 18:15:47,641 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUzNTJGQkU1REY2NDM0MkQ2OAA="}]}
2025-08-10 18:15:47,642 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:15:47,643 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 18:15:48,359 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE1Qzk3RDNFOTkwNkY2NzVDQwA="}]}
2025-08-10 18:15:48,361 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE1Qzk3RDNFOTkwNkY2NzVDQwA='}]}
2025-08-10 18:15:48,362 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:48] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:49,882 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:49] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:50,281 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:50,388 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:50,523 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:50,727 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:15:50,960 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:15:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:16:02,187 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-10 18:16:03,878 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:16:05,376 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:16:04.074262+00:00, interaction_count=785, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:16:05,990 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:16:05,992 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:16:05,992 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-10 18:16:09,530 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 18:16:09,533 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:16:10,356 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwOEI1RjY4RDhERjAyQUFFNwA="}]}
2025-08-10 18:16:10,357 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwOEI1RjY4RDhERjAyQUFFNwA='}]}
2025-08-10 18:16:10,358 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:16:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:16:11,517 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:16:11] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:16:11,626 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:16:11] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:16:11,697 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:16:11] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:16:47,167 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 18:16:48,826 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:16:50,364 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:16:49.030278+00:00, interaction_count=786, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:16:50,980 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:16:50,981 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:16:50,981 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 18:16:50,981 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 18:16:50,981 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:16:50,982 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 18:16:50,982 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 18:16:50,982 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:16:51,837 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNGNEFENjg0RjAzNTIxQ0FBMgA="}]}
2025-08-10 18:16:52,946 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:16:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:16:53,175 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:16:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:16:53,590 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:16:53,722 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:16:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:16:55,053 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:16:53.790601+00:00, interaction_count=787, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:16:55,648 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:16:55,667 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNGNEFENjg0RjAzNTIxQ0FBMgA='}]}
2025-08-10 18:16:55,668 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:16:55] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:16:56,380 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 18:16:58,072 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:16:59,593 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:16:58.266186+00:00, interaction_count=788, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:17:00,230 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:17:00,232 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:17:00,232 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 18:17:00,233 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:17:00,240 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:17:01,134 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjczRTJDODY2RUJFNkI4NkNENQA="}]}
2025-08-10 18:17:02,294 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:02,423 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:02,539 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:02,868 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:17:04,396 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:17:03.085252+00:00, interaction_count=789, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:17:05,054 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:17:05,061 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjczRTJDODY2RUJFNkI4NkNENQA='}]}
2025-08-10 18:17:05,062 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:15,128 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 18:17:16,850 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:17:18,345 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:17:17.070421+00:00, interaction_count=790, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:03:13.523825+00:00
2025-08-10 18:17:18,991 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:17:18,992 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:17:18,992 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:17:20,813 - utils.data_manager - INFO - Saved order 161 for customer 2348055614455
2025-08-10 18:17:21,032 - utils.data_manager - INFO - Saved order item Jollof Rice for order 161
2025-08-10 18:17:21,379 - handlers.order_handler - INFO - Order 161 saved to database for session 2348055614455
2025-08-10 18:17:23,393 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 18:17:23,394 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 18:17:25,101 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:17:27,318 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:17:25.303987+00:00, interaction_count=791, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-10 17:17:25.303997+00:00
2025-08-10 18:17:27,994 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:17:28,000 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 18:17:28,000 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 18:17:28,001 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 18:17:31,992 - utils.data_manager - INFO - Updated order 161 to status pending_payment
2025-08-10 18:17:31,993 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-10 18:17:31,994 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-161 with amount: 253750, email: ziga4455@lola.com
2025-08-10 18:17:32,651 - services.payment_service - INFO - Payment link created for ziga ziga (2348055614455), URL: https://checkout.paystack.com/95qbg70rrtnje22
2025-08-10 18:17:32,651 - handlers.payment_handler - INFO - Starting payment monitoring for order 161, reference PAY-161
2025-08-10 18:17:32,652 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-161
2025-08-10 18:17:32,914 - services.payment_service - ERROR - Network or connection error verifying Paystack payment for PAY-161: HTTPSConnectionPool(host='api.paystack.co', port=443): Max retries exceeded with url: /transaction/verify/PAY-161 (Caused by SSLError(SSLError(1, '[SSL: DECRYPTION_FAILED_OR_BAD_RECORD_MAC] decryption failed or bad record mac (_ssl.c:1020)')))
Traceback (most recent call last):
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\connectionpool.py", line 464, in _make_request
    self._validate_conn(conn)
    ~~~~~~~~~~~~~~~~~~~^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\connectionpool.py", line 1093, in _validate_conn
    conn.connect()
    ~~~~~~~~~~~~^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\connection.py", line 741, in connect
    sock_and_verified = _ssl_wrap_socket_and_match_hostname(
        sock=sock,
    ...<14 lines>...
        assert_fingerprint=self.assert_fingerprint,
    )
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\connection.py", line 920, in _ssl_wrap_socket_and_match_hostname
    ssl_sock = ssl_wrap_socket(
        sock=sock,
    ...<8 lines>...
        tls_in_tls=tls_in_tls,
    )
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\util\ssl_.py", line 480, in ssl_wrap_socket
    ssl_sock = _ssl_wrap_socket_impl(sock, context, tls_in_tls, server_hostname)
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\util\ssl_.py", line 524, in _ssl_wrap_socket_impl
    return ssl_context.wrap_socket(sock, server_hostname=server_hostname)
           ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\ssl.py", line 455, in wrap_socket
    return self.sslsocket_class._create(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        sock=sock,
        ^^^^^^^^^^
    ...<5 lines>...
        session=session
        ^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\ssl.py", line 1076, in _create
    self.do_handshake()
    ~~~~~~~~~~~~~~~~~^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\ssl.py", line 1372, in do_handshake
    self._sslobj.do_handshake()
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^
ssl.SSLError: [SSL: DECRYPTION_FAILED_OR_BAD_RECORD_MAC] decryption failed or bad record mac (_ssl.c:1020)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\connectionpool.py", line 787, in urlopen
    response = self._make_request(
        conn,
    ...<10 lines>...
        **response_kw,
    )
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\connectionpool.py", line 488, in _make_request
    raise new_e
urllib3.exceptions.SSLError: [SSL: DECRYPTION_FAILED_OR_BAD_RECORD_MAC] decryption failed or bad record mac (_ssl.c:1020)

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\adapters.py", line 667, in send
    resp = conn.urlopen(
        method=request.method,
    ...<9 lines>...
        chunked=chunked,
    )
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\connectionpool.py", line 841, in urlopen
    retries = retries.increment(
        method, url, error=new_e, _pool=self, _stacktrace=sys.exc_info()[2]
    )
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\util\retry.py", line 519, in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
urllib3.exceptions.MaxRetryError: HTTPSConnectionPool(host='api.paystack.co', port=443): Max retries exceeded with url: /transaction/verify/PAY-161 (Caused by SSLError(SSLError(1, '[SSL: DECRYPTION_FAILED_OR_BAD_RECORD_MAC] decryption failed or bad record mac (_ssl.c:1020)')))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\services\payment_service.py", line 123, in verify_payment_detailed
    response = requests.get(url, headers=headers)
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\api.py", line 73, in get
    return request("get", url, params=params, **kwargs)
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\api.py", line 59, in request
    return session.request(method=method, url=url, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\sessions.py", line 589, in request
    resp = self.send(prep, **send_kwargs)
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\sessions.py", line 703, in send
    r = adapter.send(request, **kwargs)
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\adapters.py", line 698, in send
    raise SSLError(e, request=request)
requests.exceptions.SSLError: HTTPSConnectionPool(host='api.paystack.co', port=443): Max retries exceeded with url: /transaction/verify/PAY-161 (Caused by SSLError(SSLError(1, '[SSL: DECRYPTION_FAILED_OR_BAD_RECORD_MAC] decryption failed or bad record mac (_ssl.c:1020)')))
2025-08-10 18:17:32,929 - handlers.payment_handler - INFO - Payment not yet verified for order 161, attempt 1/15
2025-08-10 18:17:32,929 - handlers.payment_handler - INFO - Payment link created successfully for order 161 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-10 18:17:34,908 - utils.data_manager - INFO - Retrieved 1 items for order 161
2025-08-10 18:17:35,109 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:17:35,853 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJBMTNBOTA5OTI0REUzNUEzRAA="}]}
2025-08-10 18:17:37,047 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:37] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:37,146 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:37] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:37,326 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:37] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:37,489 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:17:39,149 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:17:37.694032+00:00, interaction_count=792, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:17:25.303997+00:00
2025-08-10 18:17:39,793 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:17:39,798 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJBMTNBOTA5OTI0REUzNUEzRAA='}]}
2025-08-10 18:17:39,799 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:40,142 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 18:17:41,831 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:17:43,290 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:17:42.029990+00:00, interaction_count=793, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:17:25.303997+00:00
2025-08-10 18:17:43,972 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:17:43,973 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:17:46,802 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 161.
2025-08-10 18:17:48,606 - utils.data_manager - INFO - Retrieved 1 items for order 161
2025-08-10 18:17:48,806 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:17:49,642 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZFNjUxNTQ2NDFFRDNFODEwQQA="}]}
2025-08-10 18:17:50,782 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:50,924 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:50,998 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:17:51,334 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:17:52,855 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:17:51.549048+00:00, interaction_count=794, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:17:25.303997+00:00
2025-08-10 18:17:53,480 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:17:53,486 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZFNjUxNTQ2NDFFRDNFODEwQQA='}]}
2025-08-10 18:17:53,486 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:17:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:00,279 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-161
2025-08-10 18:18:04,109 - utils.data_manager - INFO - Updated order 161 to status confirmed
2025-08-10 18:18:05,951 - utils.data_manager - INFO - Retrieved 1 items for order 161
2025-08-10 18:18:07,513 - utils.data_manager - ERROR - Invalid order item for order 161: missing product_id or quantity: {'item_name': 'Jollof Rice', 'quantity': 1, 'unit_price': 1500.0, 'subtotal': 1500.0, 'product_id': None}
2025-08-10 18:18:07,514 - handlers.payment_handler - ERROR - Failed to reduce inventory for order 161
2025-08-10 18:18:07,514 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 18:18:08,566 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjhEN0M1MzIxMDA1RUMzRDM2OAA="}]}
2025-08-10 18:18:09,959 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:10,567 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-10 18:18:10,568 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-10 18:18:12,286 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:12,454 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:18:13,395 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE0NTIwMUY4MkQzRDE3QTZBMQA="}]}
2025-08-10 18:18:13,396 - handlers.payment_handler - INFO - Sent payment success text message for order 161 to customer 2348055614455
2025-08-10 18:18:13,396 - handlers.payment_handler - WARNING - FeedbackHandler not available for order 161, transitioning to greeting state
2025-08-10 18:18:13,397 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:18:14,198 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4NTRBOERCNkQ0RThFMkI3MAA="}]}
2025-08-10 18:18:14,199 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 18:18:14,381 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:14] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:14,879 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjVDRTAwMjA1RDU1QTEzQ0I0NAA="}]}
2025-08-10 18:18:14,879 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 161 to 2347082345056
2025-08-10 18:18:14,880 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:14] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-10 18:18:15,680 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:15,681 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:15,683 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:15,684 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:15,685 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:15,847 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:17,702 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:18,020 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:18,153 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:32,945 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-161
2025-08-10 18:18:33,503 - services.payment_service - INFO - Payment verified successfully for reference PAY-161. Status: success
2025-08-10 18:18:33,503 - handlers.payment_handler - INFO - Payment verified for order 161 on attempt 2
2025-08-10 18:18:33,504 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-161
2025-08-10 18:18:34,064 - services.payment_service - INFO - Payment verified successfully for reference PAY-161. Status: success
2025-08-10 18:18:37,894 - utils.data_manager - INFO - Updated order 161 to status confirmed
2025-08-10 18:18:39,645 - utils.data_manager - INFO - Retrieved 1 items for order 161
2025-08-10 18:18:41,154 - utils.data_manager - ERROR - Invalid order item for order 161: missing product_id or quantity: {'item_name': 'Jollof Rice', 'quantity': 1, 'unit_price': 1500.0, 'subtotal': 1500.0, 'product_id': None}
2025-08-10 18:18:41,155 - handlers.payment_handler - ERROR - Failed to reduce inventory for order 161
2025-08-10 18:18:41,155 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 18:18:42,055 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjdEQ0M1QUY2MjNBMEYxQ0IyOQA="}]}
2025-08-10 18:18:42,888 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:45,014 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:18:45] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:18:45,871 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:18:47,390 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:18:46.080019+00:00, interaction_count=795, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:18:46.080025+00:00
2025-08-10 18:18:48,029 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:24:02,366 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:24:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:30:23,954 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:30:23] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:30:24,088 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:30:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:30:24,090 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:30:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:35:46,189 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 18:35:47,476 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 18:35:51,010 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 18:35:51,239 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 18:35:53,170 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 18:35:53,367 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 18:35:53,368 - services.payment_service - INFO - PaymentService initialized
2025-08-10 18:35:55,065 - handlers.product_sync_handler - INFO - Successfully synced 15 products to data\products.json
2025-08-10 18:35:55,258 - app - INFO - Initial product sync successful on startup
2025-08-10 18:35:55,258 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 18:35:55,258 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 18:35:55,259 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 18:35:55,265 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 18:35:56,937 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 18:35:57,150 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 18:35:59,210 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 18:35:59,412 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 18:35:59,413 - services.payment_service - INFO - PaymentService initialized
2025-08-10 18:35:59,413 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 18:35:59,414 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 18:35:59,414 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 18:35:59,416 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 18:35:59,416 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 18:35:59,421 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 18:35:59,885 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 18:35:59,885 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 18:35:59,886 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 18:35:59,886 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 18:35:59,906 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 18:35:59,906 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 18:36:22,203 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 18:36:22,204 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 18:36:24,514 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:36:26,002 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:36:24.717954+00:00, interaction_count=796, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:18:46.080025+00:00
2025-08-10 18:36:26,662 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:36:26,664 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 18:36:28,424 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 18:36:28,632 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:36:28,633 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'ziga'.
2025-08-10 18:36:28,633 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:36:29,664 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBQTExM0Y3MjkxMjM3NENBRAA="}]}
2025-08-10 18:36:29,666 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRBQTExM0Y3MjkxMjM3NENBRAA='}]}
2025-08-10 18:36:29,667 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:31,098 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:31,195 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:31,402 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:32,651 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 18:36:34,459 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:36:35,998 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:36:34.659895+00:00, interaction_count=797, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:18:46.080025+00:00
2025-08-10 18:36:36,622 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:36:36,623 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:36:36,624 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 18:36:36,624 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 18:36:36,624 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 18:36:36,625 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 18:36:36,625 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 18:36:36,625 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 18:36:37,521 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNCOEEwNUQyODIyQjQ1RDVDRQA="}]}
2025-08-10 18:36:37,522 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:36:37,522 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 18:36:38,696 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU5QUM5RDUzNEZDNTMyNTMzMAA="}]}
2025-08-10 18:36:38,698 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU5QUM5RDUzNEZDNTMyNTMzMAA='}]}
2025-08-10 18:36:38,699 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:38] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:39,609 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:40,306 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:40,435 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:40,633 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:40,653 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:40,728 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:45,271 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-10 18:36:46,998 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:36:48,454 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:36:47.200116+00:00, interaction_count=798, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:18:46.080025+00:00
2025-08-10 18:36:49,072 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:36:49,073 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:36:49,074 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-10 18:36:51,660 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 18:36:51,662 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:36:52,427 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYzQzI0REE5NERBQjNDNzU3MQA="}]}
2025-08-10 18:36:52,428 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYzQzI0REE5NERBQjNDNzU3MQA='}]}
2025-08-10 18:36:52,429 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:53,515 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:53,801 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:53,936 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:36:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:36:57,139 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 18:36:59,314 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:37:01,378 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:36:59.522517+00:00, interaction_count=799, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:18:46.080025+00:00
2025-08-10 18:37:02,102 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:37:02,104 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:37:02,104 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 18:37:02,105 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 18:37:02,105 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:37:02,105 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 18:37:02,106 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 18:37:02,106 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:37:04,042 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIyQjI2NzUzODhFRDIwNjcyRgA="}]}
2025-08-10 18:37:05,239 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:05,363 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:05,491 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:05] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:05,779 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:37:07,265 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:37:05.995894+00:00, interaction_count=800, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 17:18:46.080025+00:00
2025-08-10 18:37:07,989 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:37:07,995 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIyQjI2NzUzODhFRDIwNjcyRgA='}]}
2025-08-10 18:37:07,997 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:07] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:12,123 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 18:37:13,954 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:37:15,652 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:37:14.161010+00:00, interaction_count=801, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 17:18:46.080025+00:00
2025-08-10 18:37:16,541 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:37:16,542 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:37:16,543 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 18:37:16,543 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:37:16,548 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:37:17,253 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU1MjM3MkU3MTRDQTFCNUI1MAA="}]}
2025-08-10 18:37:18,360 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:18,716 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:18,818 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:19,172 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:37:20,854 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:37:19.520269+00:00, interaction_count=802, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 17:18:46.080025+00:00
2025-08-10 18:37:21,504 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:37:21,511 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU1MjM3MkU3MTRDQTFCNUI1MAA='}]}
2025-08-10 18:37:21,513 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:21] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:21,785 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 18:37:23,588 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:37:25,077 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:37:23.795884+00:00, interaction_count=803, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 17:18:46.080025+00:00
2025-08-10 18:37:25,693 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:37:25,694 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:37:25,694 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'ziga', 'address2': '', 'address3': '', 'display_name': 'ziga'}
2025-08-10 18:37:28,927 - utils.data_manager - DEBUG - Found product_id 99 for product_name Jollof Rice
2025-08-10 18:37:29,133 - utils.data_manager - DEBUG - Assigned product_id 99 to item Jollof Rice
2025-08-10 18:37:29,592 - utils.data_manager - INFO - Saved order 162 for customer 2348055614455
2025-08-10 18:37:29,814 - utils.data_manager - INFO - Saved order item Jollof Rice for order 162
2025-08-10 18:37:30,045 - handlers.order_handler - INFO - Order 162 saved to database for session 2348055614455
2025-08-10 18:37:31,971 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 18:37:31,972 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 18:37:33,714 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:37:35,239 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:37:33.912167+00:00, interaction_count=804, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-10 17:37:33.912174+00:00
2025-08-10 18:37:35,851 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:37:35,858 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 18:37:35,859 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 18:37:35,859 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 18:37:39,932 - utils.data_manager - INFO - Updated order 162 to status pending_payment
2025-08-10 18:37:39,933 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-10 18:37:39,933 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-162 with amount: 253750, email: ziga4455@lola.com
2025-08-10 18:37:40,786 - services.payment_service - INFO - Payment link created for ziga ziga (2348055614455), URL: https://checkout.paystack.com/1613xc7ja18ivtz
2025-08-10 18:37:40,787 - handlers.payment_handler - INFO - Starting payment monitoring for order 162, reference PAY-162
2025-08-10 18:37:40,787 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-162
2025-08-10 18:37:41,370 - services.payment_service - WARNING - Payment not successful for reference PAY-162. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5226706777, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-162', 'receipt_number': None, 'amount': 253750, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-10T17:37:41.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.85.139, 141.101.98.45, 172.31.68.120', 'metadata': {'customer_name': 'ziga', 'customer_phone': '2348055614455', 'first_name': 'ziga', 'last_name': 'ziga', 'order_id': '162', 'delivery_address': 'horizon estate', 'delivery_fee': '1000', 'service_charge': '37.5', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 13807, 'integration': '2537', 'subaccount': 237406, 'params': {'bearer': 'subaccount', 'transaction_charge': '2537', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-10T17:37:41.000Z', 'requested_amount': 253750, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-10T17:37:41.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-10 18:37:41,371 - handlers.payment_handler - INFO - Payment not yet verified for order 162, attempt 1/15
2025-08-10 18:37:41,372 - handlers.payment_handler - INFO - Payment link created successfully for order 162 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-10 18:37:43,169 - utils.data_manager - INFO - Retrieved 1 items for order 162
2025-08-10 18:37:43,370 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:37:44,340 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRGMDM5NDlFRUM3ODM1NjExRAA="}]}
2025-08-10 18:37:45,457 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:45] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:45,604 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:45] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:46,011 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:46] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:46,011 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:37:47,117 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 18:37:47,534 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:37:46.226866+00:00, interaction_count=805, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:37:33.912174+00:00
2025-08-10 18:37:48,201 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:37:48,206 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRGMDM5NDlFRUM3ODM1NjExRAA='}]}
2025-08-10 18:37:48,207 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:48] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:48,883 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:37:50,532 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:37:49.091306+00:00, interaction_count=806, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:37:33.912174+00:00
2025-08-10 18:37:51,112 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-162
2025-08-10 18:37:51,231 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:37:51,232 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 18:37:53,208 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 162.
2025-08-10 18:37:55,139 - utils.data_manager - INFO - Retrieved 1 items for order 162
2025-08-10 18:37:55,341 - utils.data_manager - INFO - Updated order 162 to status confirmed
2025-08-10 18:37:55,344 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:37:56,022 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY5MEQ1M0VCQjFERDQwMjFFMwA="}]}
2025-08-10 18:37:57,307 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:57,435 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:57,516 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:37:57,619 - utils.data_manager - INFO - Retrieved 1 items for order 162
2025-08-10 18:37:57,819 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:37:59,315 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:37:58.031589+00:00, interaction_count=807, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 17:37:33.912174+00:00
2025-08-10 18:37:59,713 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 162
2025-08-10 18:37:59,921 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:37:59,928 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY5MEQ1M0VCQjFERDQwMjFFMwA='}]}
2025-08-10 18:37:59,928 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:37:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:01,736 - utils.data_manager - WARNING - Low inventory for product id 99: 3 units remaining
2025-08-10 18:38:02,029 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 99: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 18:38:02,033 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-10 18:38:02,033 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-10 18:38:04,048 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:38:05,053 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMxMkU3OUFCRURGODRCMDExRAA="}]}
2025-08-10 18:38:05,054 - handlers.payment_handler - INFO - Sent payment success text message for order 162 to customer 2348055614455
2025-08-10 18:38:05,055 - handlers.payment_handler - WARNING - FeedbackHandler not available for order 162, transitioning to greeting state
2025-08-10 18:38:05,055 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 18:38:05,813 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUyM0FGMjA0NEY5QUNDRjk5OAA="}]}
2025-08-10 18:38:05,814 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 18:38:06,137 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:06] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:06,992 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkMzQzVENkM0MzRGRTk0OUU0RQA="}]}
2025-08-10 18:38:06,993 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 162 to 2347082345056
2025-08-10 18:38:06,994 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:06] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-10 18:38:06,995 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:06] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:07,161 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:07] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:07,163 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:07] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:07,264 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:07] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:07,296 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:07] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:07,948 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:07] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:10,322 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:14,710 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:14] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:15,304 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:15,360 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:15,552 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:38:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:38:41,374 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-162
2025-08-10 18:38:41,993 - services.payment_service - INFO - Payment verified successfully for reference PAY-162. Status: success
2025-08-10 18:38:41,994 - handlers.payment_handler - INFO - Payment verified for order 162 on attempt 2
2025-08-10 18:38:41,994 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-162
2025-08-10 18:38:42,530 - services.payment_service - INFO - Payment verified successfully for reference PAY-162. Status: success
2025-08-10 18:38:46,593 - utils.data_manager - INFO - Updated order 162 to status confirmed
2025-08-10 18:38:48,444 - utils.data_manager - INFO - Retrieved 1 items for order 162
2025-08-10 18:38:50,630 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 162
2025-08-10 18:38:52,541 - utils.data_manager - WARNING - Low inventory for product id 99: 2 units remaining
2025-08-10 18:38:52,744 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 99: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 18:38:54,799 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:38:56,505 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:38:55.003721+00:00, interaction_count=808, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 18:38:57,126 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:46:39,290 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 18:57:39,841 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 18:57:40,919 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 18:57:42,646 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 18:57:42,857 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 18:57:44,746 - utils.data_manager - INFO - Successfully loaded 16 user details from database
2025-08-10 18:57:44,947 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 18:57:44,948 - services.payment_service - INFO - PaymentService initialized
2025-08-10 18:57:46,648 - handlers.product_sync_handler - INFO - Successfully synced 15 products to data\products.json
2025-08-10 18:57:46,839 - app - INFO - Initial product sync successful on startup
2025-08-10 18:57:46,840 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 18:57:46,840 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 18:57:46,841 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 18:57:46,847 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 18:57:48,599 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 18:57:48,802 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 18:57:50,630 - utils.data_manager - INFO - Successfully loaded 16 user details from database
2025-08-10 18:57:50,831 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 18:57:50,832 - services.payment_service - INFO - PaymentService initialized
2025-08-10 18:57:50,832 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 18:57:50,832 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 18:57:50,833 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 18:57:50,833 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 18:57:50,834 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 18:57:50,838 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 18:57:51,203 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 18:57:51,203 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 18:57:51,204 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 18:57:51,204 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 18:57:51,220 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 18:57:51,220 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 18:57:51,910 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 18:57:51,911 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 18:57:53,587 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 18:57:55,060 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 17:57:53.781381+00:00, interaction_count=809, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 18:57:55,726 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 18:57:55,727 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 18:57:57,395 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 18:57:59,479 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 18:57:59,480 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 18:57:59,481 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 18:57:59,481 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 18:58:00,532 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIwMjlEQ0E3NkYzQzVGOEQ4MgA="}]}
2025-08-10 18:58:00,532 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIwMjlEQ0E3NkYzQzVGOEQ4MgA='}]}
2025-08-10 18:58:00,533 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:58:00] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:58:01,672 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:58:01] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:58:01,928 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:58:01] "POST /webhook HTTP/1.1" 200 -
2025-08-10 18:58:02,305 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 18:58:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:15:34,567 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 19:15:36,637 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:15:38,159 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:15:36.834983+00:00, interaction_count=810, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:15:39,432 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:15:39,433 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:15:39,433 - handlers.base_handler - INFO - GreetingHandler: Handling message 'hello' in greeting state for session 2348055614455.
2025-08-10 19:15:39,434 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:15:39,434 - handlers.base_handler - WARNING - Session 2348055614455: Invalid option 'hello' in greeting state for non-paid user.
2025-08-10 19:15:39,434 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:15:39,814 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-10 19:15:39,815 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'greeting_handler', state 'greeting', message 'hello'. Resetting to greeting.
2025-08-10 19:15:39,815 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:15:39,816 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 19:15:39,816 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:15:40,106 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-10 19:15:40,108 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:15:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:16:14,387 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:16:14] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:16:14,958 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 19:16:16,654 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:16:18,195 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:16:16.876543+00:00, interaction_count=811, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:16:18,833 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:16:18,834 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:16:18,834 - handlers.base_handler - INFO - GreetingHandler: Handling message 'hello' in greeting state for session 2348055614455.
2025-08-10 19:16:18,834 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:16:18,835 - handlers.base_handler - WARNING - Session 2348055614455: Invalid option 'hello' in greeting state for non-paid user.
2025-08-10 19:16:18,835 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:16:19,111 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-10 19:16:19,111 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'greeting_handler', state 'greeting', message 'hello'. Resetting to greeting.
2025-08-10 19:16:19,112 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:16:19,112 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 19:16:19,113 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:16:19,394 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-10 19:16:19,395 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:16:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:23:32,386 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 19:23:33,802 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 19:23:36,499 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 19:23:36,718 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 19:23:38,697 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 19:23:38,907 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 19:23:38,908 - services.payment_service - INFO - PaymentService initialized
2025-08-10 19:23:40,692 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 19:23:40,889 - app - INFO - Initial product sync successful on startup
2025-08-10 19:23:40,890 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 19:23:40,890 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 19:23:40,890 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 19:23:40,891 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 19:23:40,900 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 19:23:42,741 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 19:23:42,971 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 19:23:45,425 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 19:23:45,641 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 19:23:45,642 - services.payment_service - INFO - PaymentService initialized
2025-08-10 19:23:45,642 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 19:23:45,642 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 19:23:45,642 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 19:23:45,653 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 19:23:45,654 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-10 19:23:45,654 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 19:23:45,661 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 19:23:46,111 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 19:23:46,112 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 19:23:46,112 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 19:23:46,113 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-10 19:23:46,113 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 19:23:46,138 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 19:23:46,138 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 19:23:50,863 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 19:23:50,863 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 19:23:52,591 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:23:54,134 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:23:52.865577+00:00, interaction_count=812, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:23:54,740 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:23:54,741 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 19:23:56,570 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 19:23:56,827 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:23:56,828 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 19:23:56,828 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:23:57,763 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE0MDU4OEYzM0E0QjEyOERBNwA="}]}
2025-08-10 19:23:57,764 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE0MDU4OEYzM0E0QjEyOERBNwA='}]}
2025-08-10 19:23:57,764 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:23:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:23:58,867 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:23:58] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:23:59,351 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:23:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:23:59,592 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:23:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:03,482 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:24:05,627 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:24:07,776 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:24:05.967276+00:00, interaction_count=813, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:24:08,430 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:24:08,430 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:24:08,431 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 19:24:08,431 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 19:24:08,431 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 19:24:08,431 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 19:24:08,432 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 19:24:08,432 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 19:24:09,343 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJENDAyNjkyOEQ2MzFGQTRBNwA="}]}
2025-08-10 19:24:09,344 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:24:09,344 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 19:24:10,087 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJEMjc0QTFDODg0NkZCRTI3MwA="}]}
2025-08-10 19:24:10,088 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJEMjc0QTFDODg0NkZCRTI3MwA='}]}
2025-08-10 19:24:10,088 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:11,632 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:11] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:12,027 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:12,092 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:12,323 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:12,731 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:12,751 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:20,733 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and 3 fried rice'}
2025-08-10 19:24:22,519 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:24:24,030 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:24:22.715358+00:00, interaction_count=814, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:24:24,657 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:24:24,658 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:24:24,659 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and 3 fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and 3 fried rice'
2025-08-10 19:24:27,499 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 19:24:27,507 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:24:28,222 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk2MzlCOTg0MzIyNDIxMzEzOAA="}]}
2025-08-10 19:24:28,228 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk2MzlCOTg0MzIyNDIxMzEzOAA='}]}
2025-08-10 19:24:28,233 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:29,880 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:30,035 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:30] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:30,038 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:30] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:35,775 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 19:24:37,533 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:24:39,028 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:24:37.737769+00:00, interaction_count=815, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:24:39,677 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:24:39,678 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:24:39,679 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}, 'Teriyaki Rice': {'item_id': '111', 'quantity': 3, 'price': 2000.0, 'total_price': 6000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 19:24:39,679 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 19:24:39,679 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:24:39,680 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 19:24:39,681 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 19:24:39,681 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:24:40,476 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBENjUyNDlENEUzN0Y2QkUzRQA="}]}
2025-08-10 19:24:41,606 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:41] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:41,833 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:41] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:42,078 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:42,129 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:24:43,774 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:24:42.325446+00:00, interaction_count=816, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:24:44,679 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:24:44,700 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBENjUyNDlENEUzN0Y2QkUzRQA='}]}
2025-08-10 19:24:44,701 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:49,389 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 19:24:51,174 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:24:52,691 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:24:51.375115+00:00, interaction_count=817, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:24:53,334 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:24:53,335 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:24:53,335 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 19:24:53,335 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:24:53,346 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:24:54,124 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFDNjc1RTI0QTAwNDUzNjQxRgA="}]}
2025-08-10 19:24:55,224 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:55] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:55,514 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:55] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:55,709 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:55] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:55,811 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:24:57,333 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:24:56.009003+00:00, interaction_count=818, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:24:57,962 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:24:57,969 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFDNjc1RTI0QTAwNDUzNjQxRgA='}]}
2025-08-10 19:24:57,970 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:24:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:24:58,422 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 19:25:00,136 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:25:01,619 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:25:00.337629+00:00, interaction_count=819, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-10 17:38:55.003727+00:00
2025-08-10 19:25:02,233 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:25:02,234 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:25:02,235 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:25:05,192 - utils.data_manager - DEBUG - Found product_id 99 for product_name Jollof Rice
2025-08-10 19:25:05,390 - utils.data_manager - DEBUG - Assigned product_id 99 to item Jollof Rice
2025-08-10 19:25:07,107 - utils.data_manager - DEBUG - Found product_id 111 for product_name Teriyaki Rice
2025-08-10 19:25:07,305 - utils.data_manager - DEBUG - Assigned product_id 111 to item Teriyaki Rice
2025-08-10 19:25:07,756 - utils.data_manager - INFO - Saved order 163 for customer 2348055614455
2025-08-10 19:25:07,987 - utils.data_manager - INFO - Saved order item Jollof Rice for order 163
2025-08-10 19:25:08,198 - utils.data_manager - INFO - Saved order item Teriyaki Rice for order 163
2025-08-10 19:25:08,417 - handlers.order_handler - INFO - Order 163 saved to database for session 2348055614455
2025-08-10 19:25:10,337 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 19:25:10,338 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 19:25:12,082 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:25:13,741 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:25:12.309594+00:00, interaction_count=820, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=7500.0, converted_at=2025-08-10 18:25:12.309600+00:00
2025-08-10 19:25:14,428 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:25:14,434 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 19:25:14,434 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 19:25:14,435 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 19:25:18,264 - utils.data_manager - INFO - Updated order 163 to status pending_payment
2025-08-10 19:25:18,265 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-10 19:25:18,265 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-163 with amount: 868750, email: ziga4455@lola.com
2025-08-10 19:25:19,028 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/g7v4irotbk0j88y
2025-08-10 19:25:19,028 - handlers.payment_handler - INFO - Starting payment monitoring for order 163, reference PAY-163
2025-08-10 19:25:19,029 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-163
2025-08-10 19:25:19,571 - services.payment_service - WARNING - Payment not successful for reference PAY-163. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5226799753, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-163', 'receipt_number': None, 'amount': 868750, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-10T18:25:19.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.85.139, 172.68.229.51, 172.31.62.52', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': '163', 'delivery_address': 'horizon estate', 'delivery_fee': '1000', 'service_charge': '187.5', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 23032, 'integration': '8687', 'subaccount': 837031, 'params': {'bearer': 'subaccount', 'transaction_charge': '8687', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-10T18:25:19.000Z', 'requested_amount': 868750, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-10T18:25:19.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-10 19:25:19,572 - handlers.payment_handler - INFO - Payment not yet verified for order 163, attempt 1/15
2025-08-10 19:25:19,572 - handlers.payment_handler - INFO - Payment link created successfully for order 163 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-10 19:25:21,712 - utils.data_manager - INFO - Retrieved 2 items for order 163
2025-08-10 19:25:21,937 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:25:23,022 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM0MkI0NUUwQjNFQzg2QkI1MAA="}]}
2025-08-10 19:25:23,432 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 19:25:24,155 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:24,382 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:24,660 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:24,714 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:25:25,124 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:25:26,209 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:25:24.921167+00:00, interaction_count=821, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=cart_added, final_order_value=7500.0, converted_at=2025-08-10 18:25:12.309600+00:00
2025-08-10 19:25:26,602 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:25:25.323520+00:00, interaction_count=821, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=7500.0, converted_at=2025-08-10 18:25:12.309600+00:00
2025-08-10 19:25:26,842 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:25:26,848 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM0MkI0NUUwQjNFQzg2QkI1MAA='}]}
2025-08-10 19:25:26,849 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:27,217 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:25:27,218 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:25:29,283 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 163.
2025-08-10 19:25:31,108 - utils.data_manager - INFO - Retrieved 2 items for order 163
2025-08-10 19:25:31,340 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:25:31,940 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-163
2025-08-10 19:25:32,283 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJBNUM4NzdGODYzNDIwOTBEQwA="}]}
2025-08-10 19:25:33,369 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:33] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:33,566 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:33] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:33,850 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:33] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:34,041 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:25:35,504 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:25:34.243411+00:00, interaction_count=822, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=cart_added, final_order_value=7500.0, converted_at=2025-08-10 18:25:12.309600+00:00
2025-08-10 19:25:35,716 - utils.data_manager - INFO - Updated order 163 to status confirmed
2025-08-10 19:25:36,114 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:25:36,120 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJBNUM4NzdGODYzNDIwOTBEQwA='}]}
2025-08-10 19:25:36,121 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:36] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:37,458 - utils.data_manager - INFO - Retrieved 2 items for order 163
2025-08-10 19:25:39,618 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 163
2025-08-10 19:25:40,058 - utils.data_manager - INFO - Reduced inventory for product_id 111 by 3 for order 163
2025-08-10 19:25:42,306 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 19:25:42,516 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 163
2025-08-10 19:25:46,227 - utils.data_manager - WARNING - Low inventory for product id 111: 2 units remaining
2025-08-10 19:25:46,428 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 111: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 19:25:46,436 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-10 19:25:46,436 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-10 19:25:48,413 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:25:49,072 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlFRkUwNUIyNUU4Q0MzNkIwQwA="}]}
2025-08-10 19:25:49,073 - handlers.payment_handler - INFO - Sent payment success text message for order 163 to customer 2348055614455
2025-08-10 19:25:49,074 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 163, session 2348055614455
2025-08-10 19:25:49,074 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'selected_category': None, 'selected_item': None, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 8, 10, 19, 25, 49, 74756), 'payment_reference': 'PAY-163', 'order_id': '163', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'delivery_address': 'horizon estate', 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '99', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 1500.0, 'total_price': 1500.0}, {'item_id': '111', 'name': 'Teriyaki Rice', 'quantity': 3, 'variations': {}, 'price': 2000.0, 'total_price': 6000.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 7500.0, 'error': ''}, 'total_price': 7500.0, 'from_ai_order': True, 'total_amount': 7500.0, 'order_status': 'confirmed', 'order_timestamp': '2025-08-10T19:25:02.235583', 'feedback_order_id': 163, 'feedback_started_at': '2025-08-10T19:25:49.074743'}
2025-08-10 19:25:49,075 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:25:49,786 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM0QkQ1MzM4OTcxMjVFMDIzOAA="}]}
2025-08-10 19:25:49,787 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 163, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM0QkQ1MzM4OTcxMjVFMDIzOAA='}]}
2025-08-10 19:25:49,787 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 19:25:50,256 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:50,675 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkFFQUQ5QjRERDJGQkE3MDI0MgA="}]}
2025-08-10 19:25:50,676 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 163 to 2347082345056
2025-08-10 19:25:50,677 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:50] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-10 19:25:50,860 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:50,959 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:50,960 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:51,523 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:51,542 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:51,904 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:25:55,496 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:25:55] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:02,702 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:02,831 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:07,759 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'excellent'}
2025-08-10 19:26:09,542 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:26:10,982 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:26:09.743374+00:00, interaction_count=823, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=cart_added, final_order_value=7500.0, converted_at=2025-08-10 18:25:12.309600+00:00
2025-08-10 19:26:11,620 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:26:11,621 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:26:11,633 - handlers.feedback_handler - INFO - Feedback saved to data/feedback.json
2025-08-10 19:26:11,633 - handlers.feedback_handler - INFO - Feedback saved for order 163: excellent
2025-08-10 19:26:11,634 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:26:11,634 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Thank you for your feedback!'}}
2025-08-10 19:26:12,619 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyQ0ExNzE5NDhFNDhGMjIwOQA="}]}
2025-08-10 19:26:12,619 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyQ0ExNzE5NDhFNDhGMjIwOQA='}]}
2025-08-10 19:26:12,620 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:12,717 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:13,608 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:13] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:13,773 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:13] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:13,924 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:13] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:19,581 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-163
2025-08-10 19:26:20,227 - services.payment_service - INFO - Payment verified successfully for reference PAY-163. Status: success
2025-08-10 19:26:20,228 - handlers.payment_handler - INFO - Payment verified for order 163 on attempt 2
2025-08-10 19:26:20,228 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-163
2025-08-10 19:26:20,791 - services.payment_service - INFO - Payment verified successfully for reference PAY-163. Status: success
2025-08-10 19:26:22,960 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 19:26:24,520 - utils.data_manager - INFO - Updated order 163 to status confirmed
2025-08-10 19:26:24,604 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:26:26,074 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:26:24.806525+00:00, interaction_count=824, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=cart_added, final_order_value=7500.0, converted_at=2025-08-10 18:25:12.309600+00:00
2025-08-10 19:26:26,244 - utils.data_manager - INFO - Retrieved 2 items for order 163
2025-08-10 19:26:26,723 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:26:26,723 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:26:26,724 - handlers.feedback_handler - INFO - Session 2348055614455: User sent a message after feedback. Redirecting to main menu.
2025-08-10 19:26:26,724 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:26:26,724 - handlers.feedback_handler - INFO - Session 2348055614455: User has no active paid session, redirecting to standard menu.
2025-08-10 19:26:26,725 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:26:27,529 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZDMTM0RTA2ODcxMDQ4MTBGMwA="}]}
2025-08-10 19:26:27,530 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZDMTM0RTA2ODcxMDQ4MTBGMwA='}]}
2025-08-10 19:26:27,531 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:28,414 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 163
2025-08-10 19:26:28,621 - utils.data_manager - ERROR - Insufficient inventory for product_id 111 in order 163: available 2, requested 3
2025-08-10 19:26:28,761 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:28,820 - handlers.payment_handler - ERROR - Failed to reduce inventory for order 163
2025-08-10 19:26:28,820 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 19:26:28,928 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:29,206 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:29,559 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjUxMjQ1Nzk3RDhFNjlFNTgyRQA="}]}
2025-08-10 19:26:30,528 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:30] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:31,734 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 19:26:31,947 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 163
2025-08-10 19:26:33,579 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:26:33] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:26:35,718 - utils.data_manager - WARNING - Low inventory for product id 111: 2 units remaining
2025-08-10 19:26:35,920 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 111: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 19:26:37,702 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:26:39,395 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:26:37.902758+00:00, interaction_count=825, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:26:40,018 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:26:46,923 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:27:12,731 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:27:30,368 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'enquiry'}
2025-08-10 19:27:31,830 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:27:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:27:37,912 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:28:04,773 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:28:56,883 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:34:38,259 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 19:34:40,230 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 19:34:43,204 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 19:34:43,422 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 19:34:45,336 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 19:34:45,540 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 19:34:45,541 - services.payment_service - INFO - PaymentService initialized
2025-08-10 19:34:47,275 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 19:34:47,477 - app - INFO - Initial product sync successful on startup
2025-08-10 19:34:47,478 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 19:34:47,478 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 19:34:47,478 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 19:34:47,479 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 19:34:47,485 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 19:34:49,322 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 19:34:49,548 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 19:34:51,910 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 19:34:52,113 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 19:34:52,113 - services.payment_service - INFO - PaymentService initialized
2025-08-10 19:34:52,113 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 19:34:52,114 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 19:34:52,114 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 19:34:52,115 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 19:34:52,115 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-10 19:34:52,115 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 19:34:52,120 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 19:34:52,575 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 19:34:52,575 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 19:34:52,575 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 19:34:52,576 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-10 19:34:52,576 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 19:34:52,592 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 19:34:52,593 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 19:35:35,568 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 19:35:35,568 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 19:35:38,023 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:35:39,577 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:35:38.255452+00:00, interaction_count=826, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:35:40,217 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:35:40,218 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 19:35:41,926 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 19:35:42,120 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:35:42,121 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 19:35:42,121 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:35:42,996 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU1ODg5QjFCMUYzMUE5RTUzMQA="}]}
2025-08-10 19:35:42,997 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU1ODg5QjFCMUYzMUE5RTUzMQA='}]}
2025-08-10 19:35:42,998 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:44,108 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:44,260 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:44,634 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:46,409 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:35:47,580 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:35:48,082 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:35:49,266 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:35:49,651 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:35:48.283716+00:00, interaction_count=827, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:35:50,897 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:35:50,898 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:35:50,898 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 19:35:50,899 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 19:35:50,899 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 19:35:50,899 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 19:35:50,900 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 19:35:50,900 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 19:35:51,406 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:35:49.506230+00:00, interaction_count=827, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:35:52,086 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRDREE1N0MxOENBMUJGNzU5RgA="}]}
2025-08-10 19:35:52,086 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:35:52,087 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 19:35:52,114 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:35:52,115 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:35:52,116 - handlers.base_handler - INFO - AIHandler: Handling message 'ai_bulk_order_direct' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 19:35:52,914 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwRTM5OTE0NDk4RDkzRDI1MAA="}]}
2025-08-10 19:35:52,915 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQwRTM5OTE0NDk4RDkzRDI1MAA='}]}
2025-08-10 19:35:52,916 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:53,874 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:54,699 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:54] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:54,905 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:54] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:54,908 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:54] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:54,911 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:54] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:54,964 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 19:35:54,966 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:35:55,622 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:55] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:55,736 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcyNUVDMTkyQkUyMTFBNzY3NgA="}]}
2025-08-10 19:35:55,737 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcyNUVDMTkyQkUyMTFBNzY3NgA='}]}
2025-08-10 19:35:55,738 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:55] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:56,862 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:56] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:57,067 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:35:57,188 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:35:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:06,604 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '4 Jellof rice and 3 fried rice'}
2025-08-10 19:36:08,307 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:36:09,803 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:36:08.509011+00:00, interaction_count=828, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:36:10,425 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:36:10,425 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:36:10,426 - handlers.base_handler - INFO - AIHandler: Handling message '4 jellof rice and 3 fried rice' in AI bulk order state for session 2348055614455. Original: '4 Jellof rice and 3 fried rice'
2025-08-10 19:36:12,551 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 19:36:12,551 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:36:13,003 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-10 19:36:13,004 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'ai_handler', state 'ai_bulk_order', message '4 jellof rice and 3 fried rice'. Resetting to greeting.
2025-08-10 19:36:13,004 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:36:13,005 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 19:36:13,005 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:36:13,730 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0RDlFMDI3Nzg3MjkyMzQ2QgA="}]}
2025-08-10 19:36:13,732 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0RDlFMDI3Nzg3MjkyMzQ2QgA='}]}
2025-08-10 19:36:13,733 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:13] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:14,855 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:14] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:15,015 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:15,132 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:15] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:16,908 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:36:18,622 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:36:20,083 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:36:18.824972+00:00, interaction_count=829, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:36:20,721 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:36:20,722 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:36:20,722 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 19:36:20,722 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 19:36:20,723 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 19:36:20,723 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 19:36:20,723 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 19:36:20,724 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 19:36:21,666 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUwNzY3REVFQ0Y2QzQ5MUM3NQA="}]}
2025-08-10 19:36:21,667 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:36:21,667 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 19:36:22,469 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEQkEwRkVGQkNBNDcwN0YyRgA="}]}
2025-08-10 19:36:22,469 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEQkEwRkVGQkNBNDcwN0YyRgA='}]}
2025-08-10 19:36:22,470 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:22] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:23,349 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:23] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:24,056 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:24,186 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:24,188 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:24,307 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:24,383 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:32,443 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '5 jellof rice and 3 fried rice'}
2025-08-10 19:36:34,122 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:36:35,607 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:36:34.324309+00:00, interaction_count=830, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:36:36,219 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:36:36,220 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:36:36,221 - handlers.base_handler - INFO - AIHandler: Handling message '5 jellof rice and 3 fried rice' in AI bulk order state for session 2348055614455. Original: '5 jellof rice and 3 fried rice'
2025-08-10 19:36:38,297 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 19:36:38,298 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:36:38,904 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-10 19:36:38,905 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'ai_handler', state 'ai_bulk_order', message '5 jellof rice and 3 fried rice'. Resetting to greeting.
2025-08-10 19:36:38,905 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:36:38,905 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 19:36:38,905 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:36:39,737 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI4NDIxNDkyQUMzMkMzMjFBMAA="}]}
2025-08-10 19:36:39,738 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI4NDIxNDkyQUMzMkMzMjFBMAA='}]}
2025-08-10 19:36:39,739 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:40,844 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:40,985 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:41,280 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:36:41] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:36:56,337 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 19:36:57,492 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 19:36:59,227 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 19:36:59,443 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 19:37:01,331 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 19:37:01,538 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 19:37:01,538 - services.payment_service - INFO - PaymentService initialized
2025-08-10 19:37:03,329 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 19:37:03,530 - app - INFO - Initial product sync successful on startup
2025-08-10 19:37:03,531 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 19:37:03,531 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 19:37:03,531 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 19:37:03,537 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 19:37:05,238 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 19:37:05,451 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 19:37:07,372 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 19:37:07,570 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 19:37:07,571 - services.payment_service - INFO - PaymentService initialized
2025-08-10 19:37:07,571 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 19:37:07,572 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 19:37:07,572 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 19:37:07,572 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 19:37:07,573 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 19:37:07,577 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 19:37:07,947 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 19:37:07,947 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 19:37:07,948 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 19:37:07,948 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be skipped
2025-08-10 19:37:07,971 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 19:37:07,971 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 19:37:10,686 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 19:37:10,686 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 19:37:12,531 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:37:14,527 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:37:12.733541+00:00, interaction_count=831, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:37:15,133 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:37:15,134 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 19:37:16,852 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 19:37:17,074 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:37:17,075 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 19:37:17,075 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:37:17,904 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFEOEU3RkMzODU5REQ3MDRBRQA="}]}
2025-08-10 19:37:17,904 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFEOEU3RkMzODU5REQ3MDRBRQA='}]}
2025-08-10 19:37:17,905 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:19,202 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:19,343 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:19,344 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:21,818 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:37:23,520 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:37:25,079 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:37:23.712309+00:00, interaction_count=832, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:37:25,696 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:37:25,697 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:37:25,698 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 19:37:25,698 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 19:37:25,698 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 19:37:25,699 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 19:37:25,699 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 19:37:25,699 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 19:37:26,632 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg5NTU4OEQxQTZDQjdCM0JDQgA="}]}
2025-08-10 19:37:26,633 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:37:26,633 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 19:37:27,416 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ3NkFEMzI5RjZBNjA2RTU5NgA="}]}
2025-08-10 19:37:27,417 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ3NkFEMzI5RjZBNjA2RTU5NgA='}]}
2025-08-10 19:37:27,418 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:27,842 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:28,514 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:28,660 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:28,718 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:28,793 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:28,972 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:29,743 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '4 Jellof rice and 3 fried rice'}
2025-08-10 19:37:32,404 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:37:33,867 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:37:32.607179+00:00, interaction_count=833, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:37:34,492 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:37:34,493 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:37:34,494 - handlers.base_handler - INFO - AIHandler: Handling message '4 jellof rice and 3 fried rice' in AI bulk order state for session 2348055614455. Original: '4 Jellof rice and 3 fried rice'
2025-08-10 19:37:37,757 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 19:37:37,759 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:37:38,215 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-10 19:37:38,216 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'ai_handler', state 'ai_bulk_order', message '4 jellof rice and 3 fried rice'. Resetting to greeting.
2025-08-10 19:37:38,216 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:37:38,217 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 19:37:38,217 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:37:39,006 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIzRUQ3M0ZCQ0Q1MTVEMDU0MwA="}]}
2025-08-10 19:37:39,007 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkIzRUQ3M0ZCQ0Q1MTVEMDU0MwA='}]}
2025-08-10 19:37:39,008 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:40,095 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:40,301 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:37:40,676 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:37:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:05,392 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 19:38:06,494 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 19:38:08,279 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 19:38:08,510 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 19:38:10,464 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 19:38:10,712 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 19:38:10,712 - services.payment_service - INFO - PaymentService initialized
2025-08-10 19:38:12,373 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 19:38:12,586 - app - INFO - Initial product sync successful on startup
2025-08-10 19:38:12,587 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 19:38:12,587 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 19:38:12,588 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 19:38:12,588 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 19:38:12,594 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 19:38:14,736 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 19:38:14,946 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 19:38:16,799 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 19:38:17,008 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 19:38:17,009 - services.payment_service - INFO - PaymentService initialized
2025-08-10 19:38:17,009 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 19:38:17,009 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 19:38:17,010 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 19:38:17,010 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 19:38:17,010 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-10 19:38:17,011 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 19:38:17,016 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 19:38:17,388 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 19:38:17,389 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 19:38:17,389 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 19:38:17,389 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-10 19:38:17,390 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 19:38:17,405 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 19:38:17,405 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 19:38:26,495 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 19:38:26,495 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 19:38:28,183 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:38:29,703 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:38:28.385026+00:00, interaction_count=834, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:38:30,324 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:38:30,325 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 19:38:32,057 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 19:38:32,308 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:38:32,309 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 19:38:32,309 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:38:33,024 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVDQkNDODQwQjI2QjJFRjExQgA="}]}
2025-08-10 19:38:33,025 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVDQkNDODQwQjI2QjJFRjExQgA='}]}
2025-08-10 19:38:33,026 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:33] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:34,185 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:34] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:34,454 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:34] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:34,456 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:34] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:36,352 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:38:38,072 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:38:39,597 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:38:38.328809+00:00, interaction_count=835, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:38:40,212 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:38:40,213 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:38:40,214 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 19:38:40,214 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 19:38:40,214 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 19:38:40,215 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 19:38:40,215 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 19:38:40,216 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 19:38:41,227 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjczRDY5N0E1MTNCQzIxQTAwQwA="}]}
2025-08-10 19:38:41,228 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:38:41,229 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 19:38:42,065 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYzMzUxNzZBREY5RDM2NzNEMwA="}]}
2025-08-10 19:38:42,066 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYzMzUxNzZBREY5RDM2NzNEMwA='}]}
2025-08-10 19:38:42,067 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:42,412 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:42,789 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 19:38:43,124 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:43,255 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:43,399 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:43,468 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:43,525 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:44,500 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:38:45,930 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:38:44.712309+00:00, interaction_count=836, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:38:46,627 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:38:46,628 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:38:46,628 - handlers.base_handler - INFO - AIHandler: Handling message 'hello' in AI bulk order state for session 2348055614455. Original: 'Hello'
2025-08-10 19:38:48,526 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 19:38:48,528 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:38:49,218 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg3QkE3M0I4NzYxNDZGRjI2MgA="}]}
2025-08-10 19:38:49,219 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg3QkE3M0I4NzYxNDZGRjI2MgA='}]}
2025-08-10 19:38:49,220 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:49] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:50,460 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:50,483 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:50,591 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:38:52,407 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-10 19:38:54,086 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:38:55,555 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:38:54.288933+00:00, interaction_count=837, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:38:56,159 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:38:56,160 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:38:56,161 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-08-10 19:38:58,487 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 19:38:58,488 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:38:59,226 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIxRUY2NzFDRDE2OEE2NkE5NQA="}]}
2025-08-10 19:38:59,226 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIxRUY2NzFDRDE2OEE2NkE5NQA='}]}
2025-08-10 19:38:59,227 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:38:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:00,315 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:00] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:00,600 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:00] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:00,613 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:00] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:02,802 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'teriyaki_rice'}
2025-08-10 19:39:04,545 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:39:06,013 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:39:04.768116+00:00, interaction_count=838, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:39:06,619 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:39:06,620 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:39:06,620 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:39:07,363 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdDRTNCREExNjBCQ0I2Q0RCQQA="}]}
2025-08-10 19:39:07,363 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdDRTNCREExNjBCQ0I2Q0RCQQA='}]}
2025-08-10 19:39:07,364 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:07] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:08,890 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:08] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:09,026 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:09,028 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:10,412 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 19:39:12,087 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:39:13,687 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:39:12.335069+00:00, interaction_count=839, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=7500.0, conversion_stage=order_completed, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:39:14,326 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:39:14,327 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:39:14,327 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}, 'Teriyaki Rice': {'item_id': '111', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 19:39:14,327 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 19:39:14,327 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:39:14,328 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 19:39:14,328 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 19:39:14,329 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:39:15,091 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdCQjdENzYwNzhBQzQxMTFEQgA="}]}
2025-08-10 19:39:16,090 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:16,265 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:16,381 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:16,766 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:39:18,021 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-08-10 19:39:18,680 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:39:16.967001+00:00, interaction_count=840, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:39:19,298 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:39:19,305 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdCQjdENzYwNzhBQzQxMTFEQgA='}]}
2025-08-10 19:39:19,306 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:19,725 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:39:21,192 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:39:19.924896+00:00, interaction_count=841, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:39:21,831 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:39:21,832 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:39:21,833 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-08-10 19:39:21,833 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:39:21,833 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please type your note for the order (e.g., 'Please deliver after 5 PM'). Type 'back' to skip adding a note."}}
2025-08-10 19:39:22,557 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEzMkUzMkE5MzRCMzQ5NTI3QgA="}]}
2025-08-10 19:39:23,904 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:23] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:24,030 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:24,073 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:24,213 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:39:25,708 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:39:24.431270+00:00, interaction_count=842, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:39:26,324 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:39:26,330 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEzMkUzMkE5MzRCMzQ5NTI3QgA='}]}
2025-08-10 19:39:26,331 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:29,778 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Make sure the rice is not cold'}
2025-08-10 19:39:31,437 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:39:32,904 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:39:31.652132+00:00, interaction_count=843, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:39:33,841 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:39:33,842 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:39:33,843 - handlers.order_handler - INFO - Note 'make sure the rice is not cold' added for session 2348055614455.
2025-08-10 19:39:33,843 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:39:33,848 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:39:34,696 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM0NDc5OUVGMjA4RThERjI2OQA="}]}
2025-08-10 19:39:35,885 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:35] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:36,057 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:36] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:36,347 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:39:36,349 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:36] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:37,834 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:39:36.550302+00:00, interaction_count=844, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:39:37,889 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 19:39:38,443 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:39:38,449 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM0NDc5OUVGMjA4RThERjI2OQA='}]}
2025-08-10 19:39:38,449 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:39:38] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:39:39,572 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:39:41,021 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:39:39.773857+00:00, interaction_count=845, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=8687.5, converted_at=2025-08-10 18:26:37.902763+00:00
2025-08-10 19:39:41,655 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:39:41,656 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:39:41,656 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:39:45,917 - utils.data_manager - DEBUG - Found product_id 99 for product_name Jollof Rice
2025-08-10 19:39:46,116 - utils.data_manager - DEBUG - Assigned product_id 99 to item Jollof Rice
2025-08-10 19:39:47,861 - utils.data_manager - DEBUG - Found product_id 111 for product_name Teriyaki Rice
2025-08-10 19:39:48,060 - utils.data_manager - DEBUG - Assigned product_id 111 to item Teriyaki Rice
2025-08-10 19:39:48,530 - utils.data_manager - INFO - Saved order 164 for customer 2348055614455
2025-08-10 19:39:48,748 - utils.data_manager - INFO - Saved order item Jollof Rice for order 164
2025-08-10 19:39:48,954 - utils.data_manager - INFO - Saved order item Teriyaki Rice for order 164
2025-08-10 19:39:49,157 - handlers.order_handler - INFO - Order 164 saved to database for session 2348055614455
2025-08-10 19:39:51,051 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 19:39:51,052 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 19:39:52,771 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:39:54,730 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:39:52.973443+00:00, interaction_count=846, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:39:55,377 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:39:55,383 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 19:39:55,383 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 19:39:55,384 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 19:39:59,217 - utils.data_manager - INFO - Updated order 164 to status pending_payment
2025-08-10 19:39:59,218 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-10 19:39:59,219 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-164 with amount: 458750, email: ziga4455@lola.com
2025-08-10 19:39:59,752 - services.payment_service - ERROR - Network or connection error creating Paystack payment link for PAY-164: HTTPSConnectionPool(host='api.paystack.co', port=443): Max retries exceeded with url: /transaction/initialize (Caused by SSLError(SSLError(1, '[SSL: SSLV3_ALERT_BAD_RECORD_MAC] sslv3 alert bad record mac (_ssl.c:2580)')))
urllib3.exceptions.SSLError: [SSL: SSLV3_ALERT_BAD_RECORD_MAC] sslv3 alert bad record mac (_ssl.c:2580)

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\adapters.py", line 667, in send
    resp = conn.urlopen(
        method=request.method,
    ...<9 lines>...
        chunked=chunked,
    )
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\connectionpool.py", line 841, in urlopen
    retries = retries.increment(
        method, url, error=new_e, _pool=self, _stacktrace=sys.exc_info()[2]
    )
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\urllib3\util\retry.py", line 519, in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
urllib3.exceptions.MaxRetryError: HTTPSConnectionPool(host='api.paystack.co', port=443): Max retries exceeded with url: /transaction/initialize (Caused by SSLError(SSLError(1, '[SSL: SSLV3_ALERT_BAD_RECORD_MAC] sslv3 alert bad record mac (_ssl.c:2580)')))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\services\payment_service.py", line 86, in create_payment_link
    response = requests.post(url, json=data, headers=headers)
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\api.py", line 115, in post
    return request("post", url, data=data, json=json, **kwargs)
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\api.py", line 59, in request
    return session.request(method=method, url=url, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\sessions.py", line 589, in request
    resp = self.send(prep, **send_kwargs)
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\sessions.py", line 703, in send
    r = adapter.send(request, **kwargs)
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\adapters.py", line 698, in send
    raise SSLError(e, request=request)
requests.exceptions.SSLError: HTTPSConnectionPool(host='api.paystack.co', port=443): Max retries exceeded with url: /transaction/initialize (Caused by SSLError(SSLError(1, '[SSL: SSLV3_ALERT_BAD_RECORD_MAC] sslv3 alert bad record mac (_ssl.c:2580)')))
2025-08-10 19:39:59,765 - handlers.payment_handler - ERROR - Failed to generate payment link for order 164
2025-08-10 19:39:59,766 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:40:00,611 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM2NUI3QUExODM5RDBGQ0FFNgA="}]}
2025-08-10 19:40:01,763 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:01] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:02,168 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:02,373 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:02] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:02,394 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:03,126 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 19:40:04,070 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:02.647224+00:00, interaction_count=847, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:04,840 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:04,846 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM2NUI3QUExODM5RDBGQ0FFNgA='}]}
2025-08-10 19:40:04,847 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:04] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:05,048 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:06,651 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:05.320809+00:00, interaction_count=848, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:07,267 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:07,268 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:40:07,268 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:40:07,269 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please select 'Checkout', 'Order More', 'Add Note', 'Other Options', or type 'remove', 'cancel', or 'note'."}}
2025-08-10 19:40:08,008 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE3RDNERDY0RDQ1OUU4MjZCMAA="}]}
2025-08-10 19:40:09,263 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:09,308 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:09,401 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:09,831 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:11,338 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:10.051692+00:00, interaction_count=849, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:11,945 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:11,951 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE3RDNERDY0RDQ1OUU4MjZCMAA='}]}
2025-08-10 19:40:11,952 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:11] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:13,039 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Checkout'}
2025-08-10 19:40:14,771 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:16,254 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:14.969684+00:00, interaction_count=850, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:16,892 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:16,893 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:40:16,893 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:40:16,894 - handlers.order_handler - INFO - User selected 'Checkout' for session 2348055614455.
2025-08-10 19:40:16,894 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:40:17,652 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc4NDAxNkJBOTA3REYyMTkxMgA="}]}
2025-08-10 19:40:18,802 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:18,868 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:19,309 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:19,772 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:21,347 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'details_correct'}
2025-08-10 19:40:21,377 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:20.052975+00:00, interaction_count=851, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:21,989 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:21,995 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc4NDAxNkJBOTA3REYyMTkxMgA='}]}
2025-08-10 19:40:21,995 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:21] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:23,050 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:24,562 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:23.251729+00:00, interaction_count=852, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:25,254 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:25,255 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:40:25,255 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:40:25,255 - handlers.order_handler - INFO - User confirmed details are correct for session 2348055614455.
2025-08-10 19:40:27,149 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 19:40:27,150 - handlers.order_handler - INFO - User details saved for session 2348055614455 during checkout.
2025-08-10 19:40:27,150 - handlers.order_handler - INFO - Address set, prompting for note for manual session 2348055614455.
2025-08-10 19:40:27,151 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:40:27,974 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEQzYxMEY3QUNDNDExNTlENgA="}]}
2025-08-10 19:40:29,207 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:29,333 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:29,562 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:29,935 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:32,739 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:30.135290+00:00, interaction_count=853, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:33,407 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:33,413 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEQzYxMEY3QUNDNDExNTlENgA='}]}
2025-08-10 19:40:33,414 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:33] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:33,467 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-08-10 19:40:35,292 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:36,772 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:35.493218+00:00, interaction_count=854, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:37,412 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:37,412 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:40:37,413 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-08-10 19:40:37,413 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:40:37,414 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please type your note for the order (e.g., 'Please deliver after 5 PM'). Type 'back' to skip adding a note."}}
2025-08-10 19:40:38,195 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5NDdFQkI4NTVDNEQ5RTlCMAA="}]}
2025-08-10 19:40:39,365 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:39,533 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:39,657 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:39,861 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:41,411 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:40.061098+00:00, interaction_count=855, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:42,066 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:42,072 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5NDdFQkI4NTVDNEQ5RTlCMAA='}]}
2025-08-10 19:40:42,073 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:43,751 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Make sure the rice is not cold'}
2025-08-10 19:40:45,863 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:47,356 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:46.064289+00:00, interaction_count=856, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:48,007 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:48,007 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:40:48,008 - handlers.order_handler - INFO - Note 'make sure the rice is not cold' added for session 2348055614455.
2025-08-10 19:40:48,008 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:40:48,013 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:40:48,734 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwQjI0QjdDMjEyNjVBOTAzOAA="}]}
2025-08-10 19:40:50,085 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:50,376 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:50,398 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:50,400 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:51,874 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 19:40:51,915 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:50.620750+00:00, interaction_count=857, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:52,528 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:52,535 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwQjI0QjdDMjEyNjVBOTAzOAA='}]}
2025-08-10 19:40:52,535 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:40:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:40:53,573 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:40:55,133 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:40:53.775410+00:00, interaction_count=858, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:39:52.973450+00:00
2025-08-10 19:40:55,735 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:40:55,736 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:40:55,737 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:40:58,737 - utils.data_manager - DEBUG - Found product_id 99 for product_name Jollof Rice
2025-08-10 19:40:58,933 - utils.data_manager - DEBUG - Assigned product_id 99 to item Jollof Rice
2025-08-10 19:41:00,621 - utils.data_manager - DEBUG - Found product_id 111 for product_name Teriyaki Rice
2025-08-10 19:41:00,818 - utils.data_manager - DEBUG - Assigned product_id 111 to item Teriyaki Rice
2025-08-10 19:41:01,257 - utils.data_manager - INFO - Saved order 165 for customer 2348055614455
2025-08-10 19:41:01,479 - utils.data_manager - INFO - Saved order item Jollof Rice for order 165
2025-08-10 19:41:01,693 - utils.data_manager - INFO - Saved order item Teriyaki Rice for order 165
2025-08-10 19:41:01,893 - handlers.order_handler - INFO - Order 165 saved to database for session 2348055614455
2025-08-10 19:41:03,843 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 19:41:03,844 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 19:41:05,517 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:41:07,065 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:41:05.725882+00:00, interaction_count=859, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 19:41:07,735 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:41:07,740 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 19:41:07,740 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 19:41:07,741 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 19:41:11,621 - utils.data_manager - INFO - Updated order 165 to status pending_payment
2025-08-10 19:41:11,622 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-10 19:41:11,622 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-165 with amount: 458750, email: ziga4455@lola.com
2025-08-10 19:41:12,266 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/dwtvpu7xysguhvx
2025-08-10 19:41:12,267 - handlers.payment_handler - INFO - Starting payment monitoring for order 165, reference PAY-165
2025-08-10 19:41:12,267 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-165
2025-08-10 19:41:12,842 - services.payment_service - WARNING - Payment not successful for reference PAY-165. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5226832665, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-165', 'receipt_number': None, 'amount': 458750, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-10T18:41:12.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.85.139, 162.158.216.18, 172.31.63.81', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': '165', 'delivery_address': 'horizon estate', 'delivery_fee': '1000', 'service_charge': '87.5', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 16882, 'integration': '4587', 'subaccount': 437281, 'params': {'bearer': 'subaccount', 'transaction_charge': '4587', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-10T18:41:12.000Z', 'requested_amount': 458750, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-10T18:41:12.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-10 19:41:12,843 - handlers.payment_handler - INFO - Payment not yet verified for order 165, attempt 1/15
2025-08-10 19:41:12,844 - handlers.payment_handler - INFO - Payment link created successfully for order 165 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-10 19:41:14,524 - utils.data_manager - INFO - Retrieved 2 items for order 165
2025-08-10 19:41:14,727 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:41:15,545 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA4MTFDNkI2RjJCMUM5Mzc0MgA="}]}
2025-08-10 19:41:16,685 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:17,121 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:17,228 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:17,249 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:41:17,350 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 19:41:18,726 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:41:17.473710+00:00, interaction_count=860, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 19:41:19,101 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:41:19,342 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:41:19,347 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA4MTFDNkI2RjJCMUM5Mzc0MgA='}]}
2025-08-10 19:41:19,348 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:20,604 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:41:19.341974+00:00, interaction_count=860, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 19:41:21,304 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:41:21,305 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:41:23,188 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 165.
2025-08-10 19:41:24,879 - utils.data_manager - INFO - Retrieved 2 items for order 165
2025-08-10 19:41:25,090 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:41:25,377 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-165
2025-08-10 19:41:25,873 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc1RTdEOTNGNDlBMkE1RDA5RAA="}]}
2025-08-10 19:41:26,985 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:27,287 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:27,451 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:27,717 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:41:29,240 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:41:27.944826+00:00, interaction_count=861, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 19:41:29,396 - utils.data_manager - INFO - Updated order 165 to status confirmed
2025-08-10 19:41:29,892 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:41:29,898 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc1RTdEOTNGNDlBMkE1RDA5RAA='}]}
2025-08-10 19:41:29,898 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:31,135 - utils.data_manager - INFO - Retrieved 2 items for order 165
2025-08-10 19:41:33,329 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 165
2025-08-10 19:41:33,743 - utils.data_manager - INFO - Reduced inventory for product_id 111 by 1 for order 165
2025-08-10 19:41:35,615 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 19:41:35,828 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 165
2025-08-10 19:41:39,543 - utils.data_manager - WARNING - Low inventory for product id 111: 1 units remaining
2025-08-10 19:41:40,131 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 111: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 19:41:40,136 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-10 19:41:40,136 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-10 19:41:42,017 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:41:42,856 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUwNjFGQzU1NEI0OTIyNDY1MQA="}]}
2025-08-10 19:41:42,857 - handlers.payment_handler - INFO - Sent payment success text message for order 165 to customer 2348055614455
2025-08-10 19:41:42,857 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 165, session 2348055614455
2025-08-10 19:41:42,857 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'selected_category': None, 'selected_item': None, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 8, 10, 19, 41, 42, 857698), 'payment_reference': 'PAY-165', 'order_id': '165', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'delivery_address': 'horizon estate', 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '99', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 1500.0, 'total_price': 1500.0}, {'item_id': '111', 'name': 'Teriyaki Rice', 'quantity': 1, 'variations': {}, 'price': 2000.0, 'total_price': 2000.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 3500.0, 'error': ''}, 'total_price': 3500.0, 'from_ai_order': True, 'order_note': 'make sure the rice is not cold', 'total_amount': 3500.0, 'order_status': 'confirmed', 'order_timestamp': '2025-08-10T19:40:55.737766', 'feedback_order_id': 165, 'feedback_started_at': '2025-08-10T19:41:42.857688'}
2025-08-10 19:41:42,858 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:41:43,528 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2Nzk2MEE4QTBDRTIyRUU3NAA="}]}
2025-08-10 19:41:43,529 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 165, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2Nzk2MEE4QTBDRTIyRUU3NAA='}]}
2025-08-10 19:41:43,529 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 19:41:43,972 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:43] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:44,334 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjVENzA5MDkyQTcxQUI3RjIzRAA="}]}
2025-08-10 19:41:44,335 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 165 to 2347082345056
2025-08-10 19:41:44,336 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:44] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-10 19:41:44,654 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:44,760 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:44,773 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:44,884 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:45,232 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:45] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:45,404 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:45] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:47,709 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:47] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:51,574 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'good'}
2025-08-10 19:41:53,330 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:41:54,791 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:41:53.531243+00:00, interaction_count=862, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 19:41:55,537 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:41:55,538 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:41:55,539 - handlers.feedback_handler - INFO - Feedback saved to data/feedback.json
2025-08-10 19:41:55,540 - handlers.feedback_handler - INFO - Feedback saved for order 165: good
2025-08-10 19:41:55,540 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:41:55,540 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Thank you for your feedback!'}}
2025-08-10 19:41:56,263 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE4QzM2QjQwQUVERTZDOThFMQA="}]}
2025-08-10 19:41:56,264 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE4QzM2QjQwQUVERTZDOThFMQA='}]}
2025-08-10 19:41:56,264 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:56] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:57,453 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:57,668 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:41:57,759 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:41:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:05,197 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Thank you'}
2025-08-10 19:42:06,850 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:42:08,334 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:42:07.050111+00:00, interaction_count=863, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 19:42:09,039 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:42:09,040 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:42:09,040 - handlers.feedback_handler - INFO - Session 2348055614455: User sent a message after feedback. Redirecting to main menu.
2025-08-10 19:42:09,040 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 19:42:09,041 - handlers.feedback_handler - INFO - Session 2348055614455: User has no active paid session, redirecting to standard menu.
2025-08-10 19:42:09,041 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 19:42:09,780 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4MDk2N0JBNEY3QjQ1NjVERQA="}]}
2025-08-10 19:42:09,781 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ4MDk2N0JBNEY3QjQ1NjVERQA='}]}
2025-08-10 19:42:09,782 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:09] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:10,997 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:11,136 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:11] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:11,217 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:11] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:12,855 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-165
2025-08-10 19:42:13,457 - services.payment_service - INFO - Payment verified successfully for reference PAY-165. Status: success
2025-08-10 19:42:13,458 - handlers.payment_handler - INFO - Payment verified for order 165 on attempt 2
2025-08-10 19:42:13,458 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-165
2025-08-10 19:42:14,047 - services.payment_service - INFO - Payment verified successfully for reference PAY-165. Status: success
2025-08-10 19:42:17,860 - utils.data_manager - INFO - Updated order 165 to status confirmed
2025-08-10 19:42:18,461 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 19:42:19,522 - utils.data_manager - INFO - Retrieved 2 items for order 165
2025-08-10 19:42:20,194 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:42:21,699 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 165
2025-08-10 19:42:21,715 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:42:20.400356+00:00, interaction_count=864, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 19:42:22,117 - utils.data_manager - INFO - Reduced inventory for product_id 111 by 1 for order 165
2025-08-10 19:42:22,350 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:42:22,350 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:42:22,351 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 19:42:22,351 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 19:42:22,351 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 19:42:22,352 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 19:42:22,352 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 19:42:22,352 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 19:42:23,240 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM5QzVBQzI3RkMzNkVDRTlDMgA="}]}
2025-08-10 19:42:23,241 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 19:42:23,242 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 19:42:23,991 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVGMkExQUQyRjM4RDVEODIwRQA="}]}
2025-08-10 19:42:23,992 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVGMkExQUQyRjM4RDVEODIwRQA='}]}
2025-08-10 19:42:23,993 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:23] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:24,205 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 19:42:24,419 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 165
2025-08-10 19:42:24,568 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:25,302 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:25,444 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:25,445 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:25,448 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:26,209 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:28,138 - utils.data_manager - WARNING - Low inventory for product id 111: 0 units remaining
2025-08-10 19:42:28,342 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 111: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 19:42:30,589 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:42:30,769 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-08-10 19:42:32,127 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:42:30.849893+00:00, interaction_count=865, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=order_completed, final_order_value=4587.5, converted_at=2025-08-10 18:42:30.849898+00:00
2025-08-10 19:42:32,564 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 19:42:32,777 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:42:34,330 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 18:42:32.780031+00:00, interaction_count=865, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 19:42:34,940 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 19:42:34,941 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 19:42:45,989 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 19:42:45] "POST /webhook HTTP/1.1" 200 -
2025-08-10 19:42:55,755 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-08-10 19:43:20,926 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-08-10 19:43:47,452 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-08-10 19:44:38,627 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-08-10 19:52:01,114 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Fried rice'}
2025-08-10 20:00:36,423 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 20:00:38,142 - __main__ - ERROR - Import error: No module named 'handlers.feedback_handler'
2025-08-10 20:01:01,010 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 20:01:02,865 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 20:01:09,132 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 20:01:09,374 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 20:01:11,629 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 20:01:11,935 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 20:01:11,937 - services.payment_service - INFO - PaymentService initialized
2025-08-10 20:01:14,295 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 20:01:14,497 - app - INFO - Initial product sync successful on startup
2025-08-10 20:01:14,499 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 20:01:14,500 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 20:01:14,501 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 20:01:14,502 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 20:01:14,514 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 20:01:16,952 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 20:01:17,158 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 20:01:20,445 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 20:01:20,678 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 20:01:20,680 - services.payment_service - INFO - PaymentService initialized
2025-08-10 20:01:20,680 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 20:01:20,681 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 20:01:20,681 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 20:01:20,682 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 20:01:20,683 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 20:01:20,684 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 20:01:20,694 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 20:01:21,214 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 20:01:21,215 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 20:01:21,215 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 20:01:21,215 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-10 20:01:21,216 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 20:01:21,245 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 20:01:21,245 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 20:01:37,522 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-10 20:01:37,523 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 20:01:39,613 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:01:41,427 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:01:39.891336+00:00, interaction_count=866, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 20:01:42,348 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:01:42,351 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 20:01:44,315 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 20:01:44,528 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 20:01:44,530 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 20:01:44,532 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:01:46,550 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJBNkE3QjcwMjVCNkVDQkU4MwA="}]}
2025-08-10 20:01:46,552 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJBNkE3QjcwMjVCNkVDQkU4MwA='}]}
2025-08-10 20:01:46,556 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:46] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:47,378 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:47] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:47,644 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:47] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:47,731 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:47] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:49,950 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 20:01:52,156 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:01:54,228 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:01:52.362072+00:00, interaction_count=867, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 20:01:55,053 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:01:55,056 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:01:55,058 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 20:01:55,059 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 20:01:55,060 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 20:01:55,061 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 20:01:55,063 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 20:01:55,064 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 20:01:56,379 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE3QzVFMEEyMjE0NjZGNjgxMgA="}]}
2025-08-10 20:01:56,382 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:01:56,383 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 20:01:57,237 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk2QUFDRUVBODYyRkE4M0E5QgA="}]}
2025-08-10 20:01:57,238 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk2QUFDRUVBODYyRkE4M0E5QgA='}]}
2025-08-10 20:01:57,239 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:57] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:58,645 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:58] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:58,968 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:58] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:59,056 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:59,105 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:59,597 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:01:59,626 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:01:59] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:02:02,815 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-10 20:02:04,987 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:02:08,388 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:02:05.238461+00:00, interaction_count=868, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 20:02:09,178 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:02:09,181 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:02:09,182 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-10 20:02:15,428 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 20:02:15,435 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:02:16,347 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRGODRGODRBRkUzRkNGM0QwQQA="}]}
2025-08-10 20:02:16,348 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRGODRGODRBRkUzRkNGM0QwQQA='}]}
2025-08-10 20:02:16,350 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:02:16] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:02:17,488 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:02:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:02:17,629 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:02:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:02:17,644 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:02:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:02:44,043 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 20:02:45,956 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:02:48,017 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:02:46.250097+00:00, interaction_count=869, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 20:02:48,710 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:02:48,712 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:02:48,713 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 20:02:48,713 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 20:02:48,714 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 20:02:48,715 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 20:02:48,715 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 20:02:48,716 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:02:49,555 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdFMjRGREU3RUIwMzEzRjUzOAA="}]}
2025-08-10 20:02:50,898 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:02:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:02:51,014 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:02:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:02:51,116 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:02:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:02:51,381 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:02:53,123 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:02:51.677421+00:00, interaction_count=870, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 20:02:53,274 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-10 20:02:53,738 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:02:53,753 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdFMjRGREU3RUIwMzEzRjUzOAA='}]}
2025-08-10 20:02:53,755 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:02:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:02:55,937 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:02:57,534 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:02:56.183066+00:00, interaction_count=871, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 20:02:58,230 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:02:58,234 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:02:58,235 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-10 20:02:58,236 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 20:02:58,260 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:02:59,030 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0Q0QyMjk2QjYzNDQzMzcxRQA="}]}
2025-08-10 20:03:00,188 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:00] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:00,384 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:00] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:00,402 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:00] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:00,870 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:03:02,633 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:03:01.078681+00:00, interaction_count=872, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 20:03:03,411 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:03:03,421 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0Q0QyMjk2QjYzNDQzMzcxRQA='}]}
2025-08-10 20:03:03,422 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:03] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:13,022 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 20:03:15,332 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:03:17,277 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:03:15.640053+00:00, interaction_count=873, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=3500.0, converted_at=2025-08-10 18:41:05.725888+00:00
2025-08-10 20:03:17,911 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:03:17,912 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:03:17,913 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 20:03:21,476 - utils.data_manager - DEBUG - Found product_id 99 for product_name Jollof Rice
2025-08-10 20:03:21,750 - utils.data_manager - DEBUG - Assigned product_id 99 to item Jollof Rice
2025-08-10 20:03:22,263 - utils.data_manager - INFO - Saved order 166 for customer 2348055614455
2025-08-10 20:03:22,500 - utils.data_manager - INFO - Saved order item Jollof Rice for order 166
2025-08-10 20:03:22,778 - handlers.order_handler - INFO - Order 166 saved to database for session 2348055614455
2025-08-10 20:03:25,265 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 20:03:25,268 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 20:03:29,295 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:03:30,896 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:03:29.536458+00:00, interaction_count=874, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:03:31,716 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:03:31,730 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 20:03:31,731 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 20:03:31,732 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 20:03:36,324 - utils.data_manager - INFO - Updated order 166 to status pending_payment
2025-08-10 20:03:36,327 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-10 20:03:36,327 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-166 with amount: 253750, email: ziga4455@lola.com
2025-08-10 20:03:37,042 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/8tgwbjvja3709a0
2025-08-10 20:03:37,043 - handlers.payment_handler - INFO - Starting payment monitoring for order 166, reference PAY-166
2025-08-10 20:03:37,044 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-166
2025-08-10 20:03:37,761 - services.payment_service - WARNING - Payment not successful for reference PAY-166. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5226873914, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-166', 'receipt_number': None, 'amount': 253750, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-10T19:03:37.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.85.139, 172.70.163.51, 172.31.68.120', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': '166', 'delivery_address': 'horizon estate', 'delivery_fee': '1000', 'service_charge': '37.5', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 13807, 'integration': '2537', 'subaccount': 237406, 'params': {'bearer': 'subaccount', 'transaction_charge': '2537', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-10T19:03:37.000Z', 'requested_amount': 253750, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-10T19:03:37.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-10 20:03:37,763 - handlers.payment_handler - INFO - Payment not yet verified for order 166, attempt 1/15
2025-08-10 20:03:37,766 - handlers.payment_handler - INFO - Payment link created successfully for order 166 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-10 20:03:38,182 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 20:03:39,717 - utils.data_manager - INFO - Retrieved 1 items for order 166
2025-08-10 20:03:39,934 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:03:40,204 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:03:40,859 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRFMjFEQTMwRjFENjUzQzIzNwA="}]}
2025-08-10 20:03:41,752 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:03:40.420755+00:00, interaction_count=875, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:03:41,835 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:41] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:42,132 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:42,323 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:42,420 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:03:42,421 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:03:42,623 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:03:44,517 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:03:42.878103+00:00, interaction_count=876, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:03:44,824 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 166.
2025-08-10 20:03:45,335 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:03:45,345 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRFMjFEQTMwRjFENjUzQzIzNwA='}]}
2025-08-10 20:03:45,346 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:45] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:46,974 - utils.data_manager - INFO - Retrieved 1 items for order 166
2025-08-10 20:03:47,282 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:03:48,203 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjczNjk3ODEyMDBEODcyQkYwOAA="}]}
2025-08-10 20:03:49,151 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:49] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:49,383 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:49] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:49,607 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:49] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:03:50,040 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:03:51,688 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:03:50.240077+00:00, interaction_count=877, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:03:52,400 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:03:52,414 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjczNjk3ODEyMDBEODcyQkYwOAA='}]}
2025-08-10 20:03:52,416 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:03:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:07,434 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-166
2025-08-10 20:04:11,755 - utils.data_manager - INFO - Updated order 166 to status confirmed
2025-08-10 20:04:13,832 - utils.data_manager - INFO - Retrieved 1 items for order 166
2025-08-10 20:04:16,875 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 166
2025-08-10 20:04:19,232 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 20:04:19,539 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 166
2025-08-10 20:04:21,745 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-10 20:04:21,747 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-10 20:04:24,147 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:04:25,185 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4MEQyOTdEOEQ0NTA5NzFBOAA="}]}
2025-08-10 20:04:25,187 - handlers.payment_handler - INFO - Sent payment success text message for order 166 to customer 2348055614455
2025-08-10 20:04:25,189 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 166, session 2348055614455
2025-08-10 20:04:25,190 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'payment_handler', 'cart': {}, 'selected_category': None, 'selected_item': None, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 8, 10, 20, 4, 25, 190039), 'payment_reference': 'PAY-166', 'order_id': '166', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'delivery_address': 'horizon estate', 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '99', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 1500.0, 'total_price': 1500.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 1500.0, 'error': ''}, 'total_price': 1500.0, 'from_ai_order': True, 'total_amount': 1500.0, 'order_status': 'confirmed', 'order_timestamp': '2025-08-10T20:03:17.914084', 'feedback_order_id': 166, 'feedback_started_at': '2025-08-10T20:04:25.190021'}
2025-08-10 20:04:25,191 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:04:26,522 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:26,525 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:26,527 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:26] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:26,743 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYzMkZBMDA3QjdDN0FDQkRDMwA="}]}
2025-08-10 20:04:26,746 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 166, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYzMkZBMDA3QjdDN0FDQkRDMwA='}]}
2025-08-10 20:04:26,747 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 20:04:27,610 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjYwRENCQzIwQjk2Qjc3QzAzMgA="}]}
2025-08-10 20:04:27,612 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 166 to 2347082345056
2025-08-10 20:04:27,614 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:27] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-10 20:04:27,891 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:27,993 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:27,999 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:27] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:28,193 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:28,201 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:28,492 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:28] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:30,553 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'excellent'}
2025-08-10 20:04:32,586 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:04:34,489 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:04:32.782787+00:00, interaction_count=878, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:04:35,322 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:04:35,324 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:04:37,739 - handlers.payment_handler - INFO - Saved feedback to database with ID 1 for order 166
2025-08-10 20:04:37,740 - handlers.payment_handler - INFO - Feedback saved for session 2348055614455, order 166
2025-08-10 20:04:37,741 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:04:37,777 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-166
2025-08-10 20:04:38,381 - services.payment_service - INFO - Payment verified successfully for reference PAY-166. Status: success
2025-08-10 20:04:38,384 - handlers.payment_handler - INFO - Payment verified for order 166 on attempt 2
2025-08-10 20:04:38,385 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-166
2025-08-10 20:04:38,621 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwMDEzOTlGMkRFQ0VDRkQ5NAA="}]}
2025-08-10 20:04:38,623 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwMDEzOTlGMkRFQ0VDRkQ5NAA='}]}
2025-08-10 20:04:38,624 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:38] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:39,308 - services.payment_service - INFO - Payment verified successfully for reference PAY-166. Status: success
2025-08-10 20:04:39,749 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:40,125 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:40,336 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:04:40] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:04:43,500 - utils.data_manager - INFO - Updated order 166 to status confirmed
2025-08-10 20:04:45,856 - utils.data_manager - INFO - Retrieved 1 items for order 166
2025-08-10 20:04:48,494 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 166
2025-08-10 20:04:50,936 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 20:04:51,138 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 166
2025-08-10 20:04:55,786 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:04:56,028 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'order'}
2025-08-10 20:04:57,571 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:04:55.994971+00:00, interaction_count=879, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-10 19:04:55.994979+00:00
2025-08-10 20:04:57,990 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:04:58,192 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:04:59,724 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:04:58.205390+00:00, interaction_count=879, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:05:00,396 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:05:00,398 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:05:21,178 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'order'}
2025-08-10 20:05:46,406 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'order'}
2025-08-10 20:06:14,003 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-10 20:06:15,694 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 20:06:18,632 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 20:06:19,042 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 20:06:21,808 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 20:06:22,090 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 20:06:22,091 - services.payment_service - INFO - PaymentService initialized
2025-08-10 20:06:24,164 - handlers.product_sync_handler - INFO - Successfully synced 12 products to data\products.json
2025-08-10 20:06:24,400 - app - INFO - Initial product sync successful on startup
2025-08-10 20:06:24,401 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 20:06:24,401 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-10 20:06:24,402 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 20:06:24,403 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 20:06:24,417 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-10 20:06:26,516 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-10 20:06:26,825 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-10 20:06:29,509 - utils.data_manager - INFO - Successfully loaded 17 user details from database
2025-08-10 20:06:29,749 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-10 20:06:29,750 - services.payment_service - INFO - PaymentService initialized
2025-08-10 20:06:29,751 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-10 20:06:29,751 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-10 20:06:29,752 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-10 20:06:29,753 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-10 20:06:29,753 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-10 20:06:29,754 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 20:06:29,764 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-10 20:06:30,268 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-10 20:06:30,269 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-10 20:06:30,270 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-10 20:06:30,270 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-10 20:06:30,271 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-10 20:06:30,309 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-10 20:06:30,310 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-10 20:06:32,271 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'order'}
2025-08-10 20:06:32,271 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-10 20:06:34,603 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:06:36,553 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:06:34.802739+00:00, interaction_count=880, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:06:37,577 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:06:37,578 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-10 20:06:39,953 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-10 20:06:40,158 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 20:06:40,159 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-10 20:06:40,160 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:06:41,061 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyM0E5QTFDQkQ2RjdGQUQyRgA="}]}
2025-08-10 20:06:41,062 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyM0E5QTFDQkQ2RjdGQUQyRgA='}]}
2025-08-10 20:06:41,064 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:41] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:42,121 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:42,304 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:42,440 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:44,546 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-10 20:06:46,589 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:06:48,432 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:06:46.864663+00:00, interaction_count=881, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:06:49,251 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:06:49,254 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:06:49,255 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-10 20:06:49,256 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-10 20:06:49,257 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-10 20:06:49,258 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-10 20:06:49,259 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-10 20:06:49,260 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-10 20:06:50,232 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0MEZCNDYxNDg2QkE5NzE2MAA="}]}
2025-08-10 20:06:50,234 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:06:50,236 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-10 20:06:50,979 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ2NEFFODZGN0I1ODQyNDkxRQA="}]}
2025-08-10 20:06:50,981 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ2NEFFODZGN0I1ODQyNDkxRQA='}]}
2025-08-10 20:06:50,983 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:51,663 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:52,433 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:52,572 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:52,623 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:52,696 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:06:52,706 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:06:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:07:39,128 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '3 Jellof rice and 3 fried rice with 2 eggs and 2 moi moi and 3 fish'}
2025-08-10 20:07:41,328 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:07:43,013 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:07:41.572400+00:00, interaction_count=882, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:07:43,831 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:07:43,834 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:07:43,835 - handlers.base_handler - INFO - AIHandler: Handling message '3 jellof rice and 3 fried rice with 2 eggs and 2 moi moi and 3 fish' in AI bulk order state for session 2348055614455. Original: '3 Jellof rice and 3 fried rice with 2 eggs and 2 moi moi and 3 fish'
2025-08-10 20:07:49,581 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 20:07:49,594 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:07:50,775 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0QUVFREZDNDdBRDUzQUJFOAA="}]}
2025-08-10 20:07:50,777 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY0QUVFREZDNDdBRDUzQUJFOAA='}]}
2025-08-10 20:07:50,778 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:07:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:07:51,935 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:07:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:07:52,186 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:07:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:07:52,262 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:07:52] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:09:02,874 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Okay'}
2025-08-10 20:09:04,831 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:09:06,778 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:09:05.139932+00:00, interaction_count=883, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:09:07,597 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:09:07,600 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:09:07,601 - handlers.base_handler - INFO - AIHandler: Handling message 'okay' in AI bulk order state for session 2348055614455. Original: 'Okay'
2025-08-10 20:09:09,633 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 20:09:09,638 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:09:09,639 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "I couldn't find any items to add to your order. Would you like to try again or see our menu?"}}
2025-08-10 20:09:10,537 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk0Mjk0MzE3QjZCMzZGNjBCOQA="}]}
2025-08-10 20:09:10,538 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk0Mjk0MzE3QjZCMzZGNjBCOQA='}]}
2025-08-10 20:09:10,539 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:09:10] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:09:11,764 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:09:11] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:09:12,065 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:09:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:09:12,171 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:09:12] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:09:22,592 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Continue'}
2025-08-10 20:09:24,494 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:09:26,405 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:09:24.801902+00:00, interaction_count=884, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:09:27,361 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:09:27,364 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:09:27,365 - handlers.base_handler - INFO - AIHandler: Handling message 'continue' in AI bulk order state for session 2348055614455. Original: 'Continue'
2025-08-10 20:09:29,001 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 20:09:29,005 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:09:29,850 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4QUVGOEFFMzAwMEEwNjBFMQA="}]}
2025-08-10 20:09:29,851 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4QUVGOEFFMzAwMEEwNjBFMQA='}]}
2025-08-10 20:09:29,853 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:09:29] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:09:31,039 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:09:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:09:31,240 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:09:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:09:31,242 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:09:31] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:10:15,229 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': '3 Jellof rice and with 2 eggs and 3 moi moi'}
2025-08-10 20:10:17,436 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:10:19,603 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:10:17.744053+00:00, interaction_count=885, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:10:20,303 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:10:20,304 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:10:20,305 - handlers.base_handler - INFO - AIHandler: Handling message '3 jellof rice and with 2 eggs and 3 moi moi' in AI bulk order state for session 2348055614455. Original: '3 Jellof rice and with 2 eggs and 3 moi moi'
2025-08-10 20:10:23,327 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-10 20:10:23,329 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:10:24,443 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNERDRDM0Y2OTU1RTIzOEZBNwA="}]}
2025-08-10 20:10:24,444 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNERDRDM0Y2OTU1RTIzOEZBNwA='}]}
2025-08-10 20:10:24,445 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:10:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:10:25,582 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:10:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:10:25,762 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:10:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:10:25,920 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:10:25] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:10:37,756 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-10 20:10:39,492 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:10:41,251 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:10:39.702449+00:00, interaction_count=886, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:10:42,167 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:10:42,168 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:10:42,169 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 3, 'price': 1500.0, 'total_price': 4500.0, 'variations': {}}, 'Egg': {'item_id': '108', 'quantity': 2, 'price': 100.0, 'total_price': 200.0, 'variations': {}}, 'Moi Moi': {'item_id': '106', 'quantity': 3, 'price': 200.0, 'total_price': 600.0, 'variations': {}}}. Redirecting to order handler.
2025-08-10 20:10:42,169 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-10 20:10:42,170 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 20:10:42,171 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-10 20:10:42,171 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-10 20:10:42,171 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:10:43,288 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZERTI4RDZEMzkzMEE2NENDNgA="}]}
2025-08-10 20:10:44,403 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:10:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:10:44,548 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:10:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:10:44,652 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:10:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:10:45,044 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:10:46,688 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:10:45.261434+00:00, interaction_count=887, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:10:47,542 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:10:47,557 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZERTI4RDZEMzkzMEE2NENDNgA='}]}
2025-08-10 20:10:47,560 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:10:47] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:11:31,349 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-08-10 20:11:35,170 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:11:36,900 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:11:35.407338+00:00, interaction_count=888, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:11:37,519 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:11:37,520 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:11:37,521 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-08-10 20:11:37,521 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:11:37,522 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please type your note for the order (e.g., 'Please deliver after 5 PM'). Type 'back' to skip adding a note."}}
2025-08-10 20:11:38,394 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBCRjE1Q0U2QTczNzA5NjkwOQA="}]}
2025-08-10 20:11:39,586 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:11:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:11:39,710 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:11:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:11:39,748 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:11:39] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:11:40,640 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:11:41,642 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Make sure the rice is not burned and cold'}
2025-08-10 20:11:42,226 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:11:40.840570+00:00, interaction_count=889, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:11:42,969 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:11:42,980 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBCRjE1Q0U2QTczNzA5NjkwOQA='}]}
2025-08-10 20:11:42,982 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:11:42] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:11:43,530 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:11:45,133 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:11:43.730166+00:00, interaction_count=890, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:11:45,810 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:11:45,811 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:11:45,811 - handlers.order_handler - INFO - Note 'make sure the rice is not burned and cold' added for session 2348055614455.
2025-08-10 20:11:45,812 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 20:11:45,825 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:11:46,630 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwNzQ0MzcwMTFDOTg3RTBDOQA="}]}
2025-08-10 20:11:47,780 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:11:47] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:11:47,940 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:11:47] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:11:48,237 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:11:48] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:11:48,370 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:11:49,979 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:11:48.678183+00:00, interaction_count=891, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:11:51,302 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:11:51,324 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwNzQ0MzcwMTFDOTg3RTBDOQA='}]}
2025-08-10 20:11:51,326 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:11:51] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:12:14,336 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 20:12:16,204 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:12:17,825 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:12:16.428834+00:00, interaction_count=892, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-10 19:03:29.536470+00:00
2025-08-10 20:12:18,510 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:12:18,511 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:12:18,512 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-10 20:12:21,679 - utils.data_manager - DEBUG - Found product_id 99 for product_name Jollof Rice
2025-08-10 20:12:21,888 - utils.data_manager - DEBUG - Assigned product_id 99 to item Jollof Rice
2025-08-10 20:12:23,594 - utils.data_manager - DEBUG - Found product_id 108 for product_name Egg
2025-08-10 20:12:23,794 - utils.data_manager - DEBUG - Assigned product_id 108 to item Egg
2025-08-10 20:12:26,980 - utils.data_manager - DEBUG - Found product_id 106 for product_name Moi Moi
2025-08-10 20:12:27,238 - utils.data_manager - DEBUG - Assigned product_id 106 to item Moi Moi
2025-08-10 20:12:27,654 - utils.data_manager - INFO - Saved order 167 for customer 2348055614455
2025-08-10 20:12:27,873 - utils.data_manager - INFO - Saved order item Jollof Rice for order 167
2025-08-10 20:12:28,081 - utils.data_manager - INFO - Saved order item Egg for order 167
2025-08-10 20:12:28,295 - utils.data_manager - INFO - Saved order item Moi Moi for order 167
2025-08-10 20:12:28,512 - handlers.order_handler - INFO - Order 167 saved to database for session 2348055614455
2025-08-10 20:12:30,464 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-10 20:12:30,465 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-10 20:12:32,375 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:12:33,970 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:12:32.590516+00:00, interaction_count=893, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=order_completed, final_order_value=5300.0, converted_at=2025-08-10 19:12:32.590527+00:00
2025-08-10 20:12:34,658 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:12:34,679 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-10 20:12:34,679 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-10 20:12:34,681 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-10 20:12:38,749 - utils.data_manager - INFO - Updated order 167 to status pending_payment
2025-08-10 20:12:38,752 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-10 20:12:38,752 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-167 with amount: 643250, email: ziga4455@lola.com
2025-08-10 20:12:39,292 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-10 20:12:39,550 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/1lnd0m7s1yeb75i
2025-08-10 20:12:39,551 - handlers.payment_handler - INFO - Starting payment monitoring for order 167, reference PAY-167
2025-08-10 20:12:39,552 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-167
2025-08-10 20:12:40,190 - services.payment_service - WARNING - Payment not successful for reference PAY-167. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5226890414, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-167', 'receipt_number': None, 'amount': 643250, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-10T19:12:39.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.85.139, 172.71.241.3, 172.31.62.52', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': '167', 'delivery_address': 'horizon estate', 'delivery_fee': '1000', 'service_charge': '132.5', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 19649, 'integration': '6432', 'subaccount': 617169, 'params': {'bearer': 'subaccount', 'transaction_charge': '6432', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-10T19:12:39.000Z', 'requested_amount': 643250, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-10T19:12:39.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-10 20:12:40,193 - handlers.payment_handler - INFO - Payment not yet verified for order 167, attempt 1/15
2025-08-10 20:12:40,196 - handlers.payment_handler - INFO - Payment link created successfully for order 167 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-10 20:12:41,059 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:12:42,030 - utils.data_manager - INFO - Retrieved 3 items for order 167
2025-08-10 20:12:42,242 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:12:42,683 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:12:41.265772+00:00, interaction_count=894, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=order_completed, final_order_value=5300.0, converted_at=2025-08-10 19:12:32.590527+00:00
2025-08-10 20:12:43,251 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5OTg0M0VDRDNCMTI4NEU1MgA="}]}
2025-08-10 20:12:43,355 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:12:43,357 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:12:44,401 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:12:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:12:44,599 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:12:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:12:44,725 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:12:44] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:12:45,155 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:12:45,422 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 167.
2025-08-10 20:12:47,084 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:12:45.410518+00:00, interaction_count=895, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=cart_added, final_order_value=5300.0, converted_at=2025-08-10 19:12:32.590527+00:00
2025-08-10 20:12:47,494 - utils.data_manager - INFO - Retrieved 3 items for order 167
2025-08-10 20:12:47,763 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:12:47,764 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:12:47,773 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5OTg0M0VDRDNCMTI4NEU1MgA='}]}
2025-08-10 20:12:47,787 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:12:47] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:12:48,624 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyRkUxOTBERDlCNDJDMUJGQgA="}]}
2025-08-10 20:12:49,828 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:12:49] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:12:50,020 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:12:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:12:50,037 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:12:50] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:12:50,531 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:12:50,996 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-167
2025-08-10 20:12:52,475 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:12:50.939578+00:00, interaction_count=896, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=cart_added, final_order_value=5300.0, converted_at=2025-08-10 19:12:32.590527+00:00
2025-08-10 20:12:53,256 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:12:53,268 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyRkUxOTBERDlCNDJDMUJGQgA='}]}
2025-08-10 20:12:53,270 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:12:53] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:12:55,649 - utils.data_manager - INFO - Updated order 167 to status confirmed
2025-08-10 20:12:58,107 - utils.data_manager - INFO - Retrieved 3 items for order 167
2025-08-10 20:13:00,666 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 3 for order 167
2025-08-10 20:13:01,589 - utils.data_manager - INFO - Reduced inventory for product_id 108 by 2 for order 167
2025-08-10 20:13:02,306 - utils.data_manager - INFO - Reduced inventory for product_id 106 by 3 for order 167
2025-08-10 20:13:05,306 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-10 20:13:05,531 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 167
2025-08-10 20:13:10,292 - utils.data_manager - WARNING - Low inventory for product id 108: 1 units remaining
2025-08-10 20:13:10,506 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 108: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 20:13:12,770 - utils.data_manager - WARNING - Low inventory for product id 106: 1 units remaining
2025-08-10 20:13:13,057 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 106: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 20:13:13,064 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-10 20:13:13,064 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-10 20:13:15,525 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-10 20:13:16,336 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY1RDRGOURDRkM4MTAzQ0U5NAA="}]}
2025-08-10 20:13:16,339 - handlers.payment_handler - INFO - Sent payment success text message for order 167 to customer 2348055614455
2025-08-10 20:13:16,341 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 167, session 2348055614455
2025-08-10 20:13:16,343 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'payment_handler', 'cart': {}, 'selected_category': None, 'selected_item': None, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 8, 10, 20, 13, 16, 343056), 'payment_reference': 'PAY-167', 'order_id': '167', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'delivery_address': 'horizon estate', 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '99', 'name': 'Jollof Rice', 'quantity': 3, 'variations': {}, 'price': 1500.0, 'total_price': 4500.0}, {'item_id': '108', 'name': 'Egg', 'quantity': 2, 'variations': {}, 'price': 100.0, 'total_price': 200.0}, {'item_id': '106', 'name': 'Moi Moi', 'quantity': 3, 'variations': {}, 'price': 200.0, 'total_price': 600.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 5300.0, 'error': ''}, 'total_price': 5300.0, 'from_ai_order': True, 'order_note': 'make sure the rice is not burned and cold', 'total_amount': 5300.0, 'order_status': 'confirmed', 'order_timestamp': '2025-08-10T20:12:18.512843', 'feedback_order_id': 167, 'feedback_started_at': '2025-08-10T20:13:16.343011'}
2025-08-10 20:13:16,346 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:13:17,218 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRFNzQxQzc4QzAzRkZFMDBFRAA="}]}
2025-08-10 20:13:17,220 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 167, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRFNzQxQzc4QzAzRkZFMDBFRAA='}]}
2025-08-10 20:13:17,221 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 20:13:17,683 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:17] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:17,893 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjgwM0ZBMjYwNDhFQzA5MkM5QwA="}]}
2025-08-10 20:13:17,895 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 167 to 2347082345056
2025-08-10 20:13:17,898 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:17] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-10 20:13:18,321 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:18,486 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:18,582 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:18,788 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:18] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:19,006 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:19,009 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:19] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:24,757 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:24,764 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:24,982 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:24] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:27,505 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'good'}
2025-08-10 20:13:29,596 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:13:31,490 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:13:29.803404+00:00, interaction_count=897, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=cart_added, final_order_value=5300.0, converted_at=2025-08-10 19:12:32.590527+00:00
2025-08-10 20:13:32,309 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:13:32,312 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-10 20:13:34,869 - handlers.payment_handler - INFO - Saved feedback to database with ID 2 for order 167
2025-08-10 20:13:34,870 - handlers.payment_handler - INFO - Feedback saved for session 2348055614455, order 167
2025-08-10 20:13:34,871 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-10 20:13:35,819 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI2OTRBODU2MTNFNTFCQjJFQQA="}]}
2025-08-10 20:13:35,820 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI2OTRBODU2MTNFNTFCQjJFQQA='}]}
2025-08-10 20:13:35,821 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:35] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:36,934 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:36] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:37,027 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:37] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:37,065 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:37] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:40,201 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-167
2025-08-10 20:13:42,348 - services.payment_service - INFO - Payment verified successfully for reference PAY-167. Status: success
2025-08-10 20:13:42,349 - handlers.payment_handler - INFO - Payment verified for order 167 on attempt 2
2025-08-10 20:13:42,350 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-167
2025-08-10 20:13:43,168 - services.payment_service - INFO - Payment verified successfully for reference PAY-167. Status: success
2025-08-10 20:13:48,395 - utils.data_manager - INFO - Updated order 167 to status confirmed
2025-08-10 20:13:50,332 - utils.data_manager - INFO - Retrieved 3 items for order 167
2025-08-10 20:13:53,097 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 3 for order 167
2025-08-10 20:13:53,432 - utils.data_manager - ERROR - Insufficient inventory for product_id 108 in order 167: available 1, requested 2
2025-08-10 20:13:53,642 - utils.data_manager - ERROR - Insufficient inventory for product_id 106 in order 167: available 1, requested 3
2025-08-10 20:13:53,852 - handlers.payment_handler - ERROR - Failed to reduce inventory for order 167
2025-08-10 20:13:53,853 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-10 20:13:55,044 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkNCMjVGQTlBNzkzODFDMjgwOAA="}]}
2025-08-10 20:13:55,772 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:13:55] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:13:57,503 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-10 20:13:57,738 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 167
2025-08-10 20:14:02,313 - utils.data_manager - WARNING - Low inventory for product id 108: 1 units remaining
2025-08-10 20:14:02,620 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 108: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 20:14:04,626 - utils.data_manager - WARNING - Low inventory for product id 106: 1 units remaining
2025-08-10 20:14:04,837 - utils.data_manager - ERROR - Unexpected error checking low inventory for product 106: 'DataManager' object has no attribute 'merchant_phone_number'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 209, in check_low_inventory
    if self.merchant_phone_number and self.whatsapp_service:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DataManager' object has no attribute 'merchant_phone_number'
2025-08-10 20:14:07,024 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-10 20:14:08,985 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-10 19:14:07.331722+00:00, interaction_count=898, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=order_completed, final_order_value=6432.5, converted_at=2025-08-10 19:14:07.331737+00:00
2025-08-10 20:14:09,810 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-10 20:14:45,034 - werkzeug - INFO - 127.0.0.1 - - [10/Aug/2025 20:14:45] "POST /webhook HTTP/1.1" 200 -
2025-08-10 20:14:48,810 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'order'}
2025-08-10 20:15:14,167 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'order'}
2025-08-10 20:15:39,659 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'order'}
2025-08-14 02:11:25,190 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 02:11:27,530 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 02:11:32,340 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 02:11:32,549 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 02:11:34,414 - utils.data_manager - INFO - Successfully loaded 34 user details from database
2025-08-14 02:11:34,620 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 02:11:34,621 - services.payment_service - INFO - PaymentService initialized
2025-08-14 02:11:40,198 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 02:11:40,397 - app - INFO - Initial product sync successful on startup
2025-08-14 02:11:40,398 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 02:11:40,398 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 02:11:40,398 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 02:11:40,399 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 02:11:40,418 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 02:11:42,114 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 02:11:42,324 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 02:11:44,364 - utils.data_manager - INFO - Successfully loaded 34 user details from database
2025-08-14 02:11:44,561 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 02:11:44,561 - services.payment_service - INFO - PaymentService initialized
2025-08-14 02:11:44,561 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 02:11:44,562 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 02:11:44,562 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 02:11:44,569 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 02:11:44,569 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 02:11:44,570 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 02:11:44,577 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 02:11:45,120 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 02:11:45,121 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 02:11:45,121 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 02:11:45,121 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 02:11:45,122 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 02:11:45,161 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 02:11:45,161 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 02:16:42,132 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:16:42] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:16:54,515 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 02:16:55,630 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 02:16:58,302 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 02:16:58,584 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 02:17:00,504 - utils.data_manager - INFO - Successfully loaded 34 user details from database
2025-08-14 02:17:00,705 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 02:17:00,705 - services.payment_service - INFO - PaymentService initialized
2025-08-14 02:17:02,997 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 02:17:03,198 - app - INFO - Initial product sync successful on startup
2025-08-14 02:17:03,198 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 02:17:03,198 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 02:17:03,199 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 02:17:03,199 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 02:17:03,205 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 02:17:06,550 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 02:17:06,759 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 02:17:08,632 - utils.data_manager - INFO - Successfully loaded 34 user details from database
2025-08-14 02:17:08,844 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 02:17:08,845 - services.payment_service - INFO - PaymentService initialized
2025-08-14 02:17:08,845 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 02:17:08,845 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 02:17:08,846 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 02:17:08,846 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 02:17:08,847 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 02:17:08,847 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 02:17:08,852 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 02:17:09,216 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 02:17:09,217 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 02:17:09,217 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 02:17:09,217 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 02:17:09,218 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 02:17:09,235 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 02:17:09,235 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 02:18:00,732 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 02:18:00,733 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-14 02:18:02,452 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:18:03,949 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:18:02.654463+00:00, interaction_count=899, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=order_completed, final_order_value=6432.5, converted_at=2025-08-10 19:14:07.331737+00:00
2025-08-14 02:18:04,581 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:18:04,582 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-14 02:18:06,278 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-14 02:18:06,476 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:18:06,477 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-14 02:18:06,477 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:18:07,582 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2RDlDNDBDMjgxMUEwNkE2MAA="}]}
2025-08-14 02:18:07,583 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2RDlDNDBDMjgxMUEwNkE2MAA='}]}
2025-08-14 02:18:07,584 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:07] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:08,687 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:08] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:09,141 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:09] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:12,635 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 02:18:14,366 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:18:15,871 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:18:14.595506+00:00, interaction_count=900, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=order_completed, final_order_value=6432.5, converted_at=2025-08-10 19:14:07.331737+00:00
2025-08-14 02:18:17,597 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:18:17,598 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:18:17,599 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 02:18:17,599 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 02:18:17,599 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 02:18:17,599 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 02:18:17,600 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 02:18:17,600 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 02:18:18,608 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0NDk2QTc5ODVCNkMzRTAyNwA="}]}
2025-08-14 02:18:18,609 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:18:18,609 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 02:18:19,440 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZDNjBGMDYzRTFCQzlFRThGMAA="}]}
2025-08-14 02:18:19,441 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjZDNjBGMDYzRTFCQzlFRThGMAA='}]}
2025-08-14 02:18:19,442 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:20,668 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:20] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:20,989 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:20] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:21,155 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:21] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:21,225 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:21] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:21,340 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:21] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:21,382 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:21] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:23,984 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-14 02:18:25,978 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:18:27,571 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:18:26.297877+00:00, interaction_count=901, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=order_completed, final_order_value=6432.5, converted_at=2025-08-10 19:14:07.331737+00:00
2025-08-14 02:18:28,205 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:18:28,207 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:18:28,207 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-14 02:18:31,046 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-14 02:18:31,048 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:18:31,931 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0MENCNzE4NzNDMTU1MTZDOAA="}]}
2025-08-14 02:18:31,932 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0MENCNzE4NzNDMTU1MTZDOAA='}]}
2025-08-14 02:18:31,933 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:31] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:32,873 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:32] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:33,357 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:33] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:34,757 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-14 02:18:36,506 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:18:38,112 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:18:36.704596+00:00, interaction_count=902, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=5300.0, conversion_stage=order_completed, final_order_value=6432.5, converted_at=2025-08-10 19:14:07.331737+00:00
2025-08-14 02:18:38,742 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:18:38,743 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:18:38,743 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-14 02:18:38,743 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-14 02:18:38,744 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:18:38,744 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-14 02:18:38,744 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-14 02:18:38,744 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:18:39,738 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdDODVBNkI2RDM2N0U3NDdCRAA="}]}
2025-08-14 02:18:40,694 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:40] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:40,948 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:40] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:40,978 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:40] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:41,368 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:18:42,559 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-14 02:18:42,922 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:18:41.674438+00:00, interaction_count=903, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=6432.5, converted_at=2025-08-10 19:14:07.331737+00:00
2025-08-14 02:18:43,539 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:18:43,545 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdDODVBNkI2RDM2N0U3NDdCRAA='}]}
2025-08-14 02:18:43,546 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:43] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:44,226 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:18:45,750 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:18:44.420367+00:00, interaction_count=904, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=6432.5, converted_at=2025-08-10 19:14:07.331737+00:00
2025-08-14 02:18:46,406 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:18:46,407 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:18:46,407 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-14 02:18:46,407 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:18:46,413 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:18:47,320 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwQzIwQzlERTc0QUYwOUJFOQA="}]}
2025-08-14 02:18:48,291 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:48] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:48,492 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:48] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:49,014 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:18:50,251 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-14 02:18:50,684 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:18:49.322280+00:00, interaction_count=905, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=6432.5, converted_at=2025-08-10 19:14:07.331737+00:00
2025-08-14 02:18:51,352 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:18:51,359 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwQzIwQzlERTc0QUYwOUJFOQA='}]}
2025-08-14 02:18:51,360 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:18:51] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:18:52,153 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:18:53,618 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:18:52.355610+00:00, interaction_count=906, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=6432.5, converted_at=2025-08-10 19:14:07.331737+00:00
2025-08-14 02:18:54,239 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:18:54,240 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:18:54,240 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:18:57,209 - utils.data_manager - DEBUG - Found product_id 99 for product_name Jollof Rice
2025-08-14 02:18:57,409 - utils.data_manager - DEBUG - Assigned product_id 99 to item Jollof Rice
2025-08-14 02:18:57,871 - utils.data_manager - INFO - Saved order 170 for customer 2348055614455
2025-08-14 02:18:58,092 - utils.data_manager - INFO - Saved order item Jollof Rice for order 170
2025-08-14 02:18:58,296 - handlers.order_handler - INFO - Order 170 saved to database for session 2348055614455
2025-08-14 02:19:02,286 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-14 02:19:02,287 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-14 02:19:03,993 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:19:05,521 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:19:04.189828+00:00, interaction_count=907, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-14 01:19:04.189835+00:00
2025-08-14 02:19:06,210 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:19:06,216 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-14 02:19:06,217 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-14 02:19:06,217 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-14 02:19:11,091 - utils.data_manager - INFO - Updated order 170 to status pending_payment
2025-08-14 02:19:11,092 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-14 02:19:11,092 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-170 with amount: 253750, email: ziga4455@lola.com
2025-08-14 02:19:11,877 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/ycc546k279vi6tu
2025-08-14 02:19:11,878 - handlers.payment_handler - INFO - Starting payment monitoring for order 170, reference PAY-170
2025-08-14 02:19:11,879 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-170
2025-08-14 02:19:12,566 - services.payment_service - WARNING - Payment not successful for reference PAY-170. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5236227834, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-170', 'receipt_number': None, 'amount': 253750, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-14T01:19:11.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.75.255, 172.69.195.243, 172.31.62.52', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': '170', 'delivery_address': 'horizon estate', 'delivery_fee': '1000', 'service_charge': '37.5', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 13807, 'integration': '2537', 'subaccount': 237406, 'params': {'bearer': 'subaccount', 'transaction_charge': '2537', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-14T01:19:11.000Z', 'requested_amount': 253750, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-14T01:19:11.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-14 02:19:12,567 - handlers.payment_handler - INFO - Payment not yet verified for order 170, attempt 1/15
2025-08-14 02:19:12,568 - handlers.payment_handler - INFO - Payment link created successfully for order 170 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-14 02:19:14,261 - utils.data_manager - INFO - Retrieved 1 items for order 170
2025-08-14 02:19:14,479 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:19:15,385 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVCRjIwRTFFRTc5OTUzRTQ2MAA="}]}
2025-08-14 02:19:15,509 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-14 02:19:16,577 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:16] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:16,768 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:16] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:17,047 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:19:17,286 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:19:18,651 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:19:17.287131+00:00, interaction_count=908, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 01:19:04.189835+00:00
2025-08-14 02:19:19,001 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:19:17.588643+00:00, interaction_count=908, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-14 01:19:04.189835+00:00
2025-08-14 02:19:19,245 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:19:19,251 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVCRjIwRTFFRTc5OTUzRTQ2MAA='}]}
2025-08-14 02:19:19,252 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:19,645 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:19:19,646 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:19:22,643 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 170.
2025-08-14 02:19:24,448 - utils.data_manager - INFO - Retrieved 1 items for order 170
2025-08-14 02:19:24,650 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:19:25,399 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUxNTYwMzI2NUNEOUIzRUJGNgA="}]}
2025-08-14 02:19:26,569 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:26] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:26,700 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:26] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:26,907 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:26] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:27,061 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:19:28,576 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:19:27.294620+00:00, interaction_count=909, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 01:19:04.189835+00:00
2025-08-14 02:19:29,294 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:19:29,299 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUxNTYwMzI2NUNEOUIzRUJGNgA='}]}
2025-08-14 02:19:29,300 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:29] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:29,713 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-170
2025-08-14 02:19:33,973 - utils.data_manager - INFO - Updated order 170 to status confirmed
2025-08-14 02:19:35,749 - utils.data_manager - INFO - Retrieved 1 items for order 170
2025-08-14 02:19:37,874 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:37] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:37,980 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 170
2025-08-14 02:19:39,890 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 02:19:40,100 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 170
2025-08-14 02:19:42,064 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-14 02:19:42,064 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-14 02:19:43,936 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:19:45,147 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk4NjcyNDQyMjQwMUFCQTg5OAA="}]}
2025-08-14 02:19:45,148 - handlers.payment_handler - INFO - Sent payment success text message for order 170 to customer 2348055614455
2025-08-14 02:19:45,148 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 170, session 2348055614455
2025-08-14 02:19:45,149 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'selected_category': None, 'selected_item': None, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 8, 14, 2, 19, 45, 149344), 'payment_reference': 'PAY-170', 'order_id': '170', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'delivery_address': 'horizon estate', 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '99', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 1500.0, 'total_price': 1500.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 1500.0, 'error': ''}, 'total_price': 1500.0, 'from_ai_order': True, 'total_amount': 1500.0, 'order_status': 'confirmed', 'order_timestamp': '2025-08-14T02:18:54.241303', 'feedback_order_id': 170, 'feedback_started_at': '2025-08-14T02:19:45.149334'}
2025-08-14 02:19:45,150 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:19:46,101 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDMUE3QjMyMERFMTlCQ0E5MQA="}]}
2025-08-14 02:19:46,101 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 170, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDMUE3QjMyMERFMTlCQ0E5MQA='}]}
2025-08-14 02:19:46,102 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-14 02:19:46,107 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:46,359 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:46,435 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:47,291 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjFDRTE4QThBMUIwNTQ0N0JDRgA="}]}
2025-08-14 02:19:47,292 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 170 to 2347082345056
2025-08-14 02:19:47,292 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:47] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-14 02:19:47,557 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:47] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:47,602 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:47] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:47,701 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:47] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:48,768 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:48] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:49,806 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'good'}
2025-08-14 02:19:51,544 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:19:53,160 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:19:51.783491+00:00, interaction_count=910, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 01:19:04.189835+00:00
2025-08-14 02:19:53,780 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:19:53,780 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:19:53,783 - handlers.feedback_handler - INFO - Feedback saved to data/feedback.json
2025-08-14 02:19:53,784 - handlers.feedback_handler - INFO - Feedback saved for order 170: good
2025-08-14 02:19:53,784 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:19:53,784 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Thank you for your feedback!'}}
2025-08-14 02:19:55,037 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY1N0Y0NkZCOEM2M0JENjBCOAA="}]}
2025-08-14 02:19:55,037 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY1N0Y0NkZCOEM2M0JENjBCOAA='}]}
2025-08-14 02:19:55,038 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:55] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:56,150 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:56] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:56,194 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:56] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:19:56,319 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:19:56] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:03,630 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 02:20:05,530 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:20:07,069 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:20:05.739524+00:00, interaction_count=911, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 01:19:04.189835+00:00
2025-08-14 02:20:07,778 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:20:07,778 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:20:07,779 - handlers.feedback_handler - INFO - Session 2348055614455: User sent a message after feedback. Redirecting to main menu.
2025-08-14 02:20:07,779 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:20:07,779 - handlers.feedback_handler - INFO - Session 2348055614455: User has no active paid session, redirecting to standard menu.
2025-08-14 02:20:07,780 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:20:08,641 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM3MTg4NzYwMjJCMjYzNDlDNwA="}]}
2025-08-14 02:20:08,642 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM3MTg4NzYwMjJCMjYzNDlDNwA='}]}
2025-08-14 02:20:08,643 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:08] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:09,809 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:09] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:09,941 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:09] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:12,570 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-170
2025-08-14 02:20:13,672 - services.payment_service - INFO - Payment verified successfully for reference PAY-170. Status: success
2025-08-14 02:20:13,673 - handlers.payment_handler - INFO - Payment verified for order 170 on attempt 2
2025-08-14 02:20:13,673 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-170
2025-08-14 02:20:14,235 - services.payment_service - INFO - Payment verified successfully for reference PAY-170. Status: success
2025-08-14 02:20:17,752 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 02:20:18,074 - utils.data_manager - INFO - Updated order 170 to status confirmed
2025-08-14 02:20:19,553 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:20:19,762 - utils.data_manager - INFO - Retrieved 1 items for order 170
2025-08-14 02:20:21,148 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:20:19.746559+00:00, interaction_count=912, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 01:19:04.189835+00:00
2025-08-14 02:20:21,811 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:20:21,812 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:20:21,812 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 02:20:21,813 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 02:20:21,813 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 02:20:21,813 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 02:20:21,814 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 02:20:21,814 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 02:20:22,168 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 170
2025-08-14 02:20:22,779 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVEQTlFQjg3OEZENzU3Mjc5NgA="}]}
2025-08-14 02:20:22,782 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:20:22,782 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 02:20:24,189 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:24] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:24,334 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:24] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:24,335 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:24] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:24,687 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 02:20:24,852 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk2RjA5QzI2MTgzM0YxODAxNwA="}]}
2025-08-14 02:20:24,853 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk2RjA5QzI2MTgzM0YxODAxNwA='}]}
2025-08-14 02:20:24,854 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:24] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:24,904 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 170
2025-08-14 02:20:25,830 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:25] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:26,004 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:26] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:26,219 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:20:26] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:20:28,805 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:20:30,275 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:20:28.998351+00:00, interaction_count=913, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:20:30,280 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-14 02:20:30,923 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:20:31,964 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:20:33,518 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:20:32.170478+00:00, interaction_count=914, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:20:34,139 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:20:34,140 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:20:55,343 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-14 02:21:20,527 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-14 02:21:47,308 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-14 02:22:34,520 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-14 02:31:33,580 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 02:31:35,030 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 02:31:38,550 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 02:31:38,778 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 02:31:40,700 - utils.data_manager - INFO - Successfully loaded 34 user details from database
2025-08-14 02:31:40,896 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 02:31:40,896 - services.payment_service - INFO - PaymentService initialized
2025-08-14 02:31:42,670 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 02:31:42,876 - app - INFO - Initial product sync successful on startup
2025-08-14 02:31:42,876 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 02:31:42,877 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 02:31:42,877 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 02:31:42,877 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 02:31:42,885 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 02:31:44,520 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 02:31:44,758 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 02:31:47,325 - utils.data_manager - INFO - Successfully loaded 34 user details from database
2025-08-14 02:31:47,521 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 02:31:47,522 - services.payment_service - INFO - PaymentService initialized
2025-08-14 02:31:47,522 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 02:31:47,523 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 02:31:47,523 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 02:31:47,523 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 02:31:47,524 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 02:31:47,524 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 02:31:47,529 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 02:31:47,951 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 02:31:47,952 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 02:31:47,952 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 02:31:47,952 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 02:31:47,953 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 02:31:47,987 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 02:31:47,988 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 02:31:56,345 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 02:31:56,345 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-14 02:31:58,037 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:31:59,516 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:31:58.279464+00:00, interaction_count=915, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:32:00,170 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:32:00,171 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-14 02:32:01,898 - utils.data_manager - DEBUG - Found address 'horizon estate' for phone number 2348055614455 in whatsapp_orders
2025-08-14 02:32:02,095 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-14 02:32:02,096 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:32:02,096 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:32:02,954 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZDNDMxQjM2Njc1MDdEQkY4QQA="}]}
2025-08-14 02:32:02,955 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZDNDMxQjM2Njc1MDdEQkY4QQA='}]}
2025-08-14 02:32:02,956 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:02] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:04,183 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:04] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:04,312 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:04] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:06,592 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 02:32:08,259 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:32:09,836 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:32:08.475365+00:00, interaction_count=916, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:32:10,470 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:32:10,471 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:32:10,472 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 02:32:10,472 - handlers.base_handler - INFO - Session 2348055614455: New order keyword 'ai_bulk_order_direct' detected. Redirecting to AI bulk order.
2025-08-14 02:32:10,472 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 02:32:10,473 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 02:32:10,473 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 02:32:10,473 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 02:32:10,474 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 02:32:11,484 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRFNUE3NzBBMjhCNTQzOEEyRgA="}]}
2025-08-14 02:32:11,485 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:32:11,486 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 02:32:12,362 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFQUU0MzI0Mjc2OEM2QzQwRQA="}]}
2025-08-14 02:32:12,363 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFQUU0MzI0Mjc2OEM2QzQwRQA='}]}
2025-08-14 02:32:12,364 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:12] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:13,257 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:13] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:13,826 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:13] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:13,960 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:13] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:13,960 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:13] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:14,300 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:14] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:14,534 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:14] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:20,706 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-14 02:32:22,492 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:32:24,150 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:32:22.712161+00:00, interaction_count=917, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:32:24,759 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:32:24,760 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:32:24,760 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-08-14 02:32:27,765 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-14 02:32:27,767 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:32:28,598 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMzRTBGRkQ5NEQzNEY5QkNFMAA="}]}
2025-08-14 02:32:28,599 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMzRTBGRkQ5NEQzNEY5QkNFMAA='}]}
2025-08-14 02:32:28,600 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:28] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:29,519 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:29] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:29,861 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:29] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:32,439 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-14 02:32:34,088 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:32:35,620 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:32:34.294585+00:00, interaction_count=918, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:32:36,257 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:32:36,258 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:32:36,258 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}, 'Fried Rice': {'item_id': '100', 'quantity': 1, 'price': 1700.0, 'total_price': 1700.0, 'variations': {}}}. Redirecting to order handler.
2025-08-14 02:32:36,259 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-14 02:32:36,259 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:32:36,260 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-14 02:32:36,260 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-14 02:32:36,260 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:32:37,040 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNERTI0OUFBRUY1ODZCMUIyRgA="}]}
2025-08-14 02:32:37,999 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:37] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:38,316 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:38] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:38,317 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:38] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:39,018 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:32:40,148 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-14 02:32:40,509 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:32:39.216611+00:00, interaction_count=919, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:32:41,174 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:32:41,180 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNERTI0OUFBRUY1ODZCMUIyRgA='}]}
2025-08-14 02:32:41,181 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:41] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:41,882 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:32:43,651 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:32:42.096635+00:00, interaction_count=920, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:32:44,336 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:32:44,337 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:32:44,337 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-14 02:32:44,337 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:32:44,343 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:32:45,142 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU2NDQ1N0ZDRDY2RDBFMTU4RQA="}]}
2025-08-14 02:32:46,026 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:46,298 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:46,486 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:46,890 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:32:47,995 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-14 02:32:48,420 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:32:47.096208+00:00, interaction_count=921, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:32:49,056 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:32:49,062 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU2NDQ1N0ZDRDY2RDBFMTU4RQA='}]}
2025-08-14 02:32:49,063 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:32:49] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:32:49,693 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:32:51,589 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:32:49.893608+00:00, interaction_count=922, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=cart_added, final_order_value=2537.5, converted_at=2025-08-14 01:20:28.998358+00:00
2025-08-14 02:32:53,050 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:32:53,051 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:32:53,052 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:32:56,255 - utils.data_manager - DEBUG - Found product_id 99 for product_name Jollof Rice
2025-08-14 02:32:56,473 - utils.data_manager - DEBUG - Assigned product_id 99 to item Jollof Rice
2025-08-14 02:32:58,459 - utils.data_manager - DEBUG - Found product_id 100 for product_name Fried Rice
2025-08-14 02:32:58,659 - utils.data_manager - DEBUG - Assigned product_id 100 to item Fried Rice
2025-08-14 02:32:59,114 - utils.data_manager - INFO - Saved order 171 for customer 2348055614455
2025-08-14 02:32:59,346 - utils.data_manager - INFO - Saved order item Jollof Rice for order 171
2025-08-14 02:32:59,616 - utils.data_manager - INFO - Saved order item Fried Rice for order 171
2025-08-14 02:32:59,818 - handlers.order_handler - INFO - Order 171 saved to database for session 2348055614455
2025-08-14 02:33:01,865 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-14 02:33:01,867 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-14 02:33:03,584 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:33:05,474 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:33:03.794230+00:00, interaction_count=923, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=order_completed, final_order_value=3200.0, converted_at=2025-08-14 01:33:03.794237+00:00
2025-08-14 02:33:06,126 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:33:06,132 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-14 02:33:06,133 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-14 02:33:06,133 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-14 02:33:10,401 - utils.data_manager - INFO - Updated order 171 to status pending_payment
2025-08-14 02:33:10,402 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-14 02:33:10,402 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-171 with amount: 428000, email: ziga4455@lola.com
2025-08-14 02:33:11,322 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/yu3b3skgji1k2ey
2025-08-14 02:33:11,322 - handlers.payment_handler - INFO - Starting payment monitoring for order 171, reference PAY-171
2025-08-14 02:33:11,323 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-171
2025-08-14 02:33:11,897 - services.payment_service - WARNING - Payment not successful for reference PAY-171. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5236233775, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-171', 'receipt_number': None, 'amount': 428000, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-14T01:33:11.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.75.255, 172.70.90.201, 172.31.62.52', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': '171', 'delivery_address': 'horizon estate', 'delivery_fee': '1000', 'service_charge': '80', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 16420, 'integration': '4280', 'subaccount': 407300, 'params': {'bearer': 'subaccount', 'transaction_charge': '4280', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-14T01:33:11.000Z', 'requested_amount': 428000, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-14T01:33:11.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-14 02:33:11,897 - handlers.payment_handler - INFO - Payment not yet verified for order 171, attempt 1/15
2025-08-14 02:33:11,898 - handlers.payment_handler - INFO - Payment link created successfully for order 171 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-14 02:33:13,226 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-14 02:33:14,405 - utils.data_manager - INFO - Retrieved 2 items for order 171
2025-08-14 02:33:14,620 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:33:15,043 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:33:15,514 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI4RkNGQjEwNTc2NDBGOTg4MgA="}]}
2025-08-14 02:33:16,486 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:16] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:16,582 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:33:15.269171+00:00, interaction_count=924, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=order_completed, final_order_value=3200.0, converted_at=2025-08-14 01:33:03.794237+00:00
2025-08-14 02:33:16,721 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:16] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:17,370 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:33:17,375 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:33:17,376 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:33:19,338 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 171.
2025-08-14 02:33:19,474 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:33:17.649390+00:00, interaction_count=924, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=cart_added, final_order_value=3200.0, converted_at=2025-08-14 01:33:03.794237+00:00
2025-08-14 02:33:20,102 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:33:20,108 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI4RkNGQjEwNTc2NDBGOTg4MgA='}]}
2025-08-14 02:33:20,108 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:20] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:21,049 - utils.data_manager - INFO - Retrieved 2 items for order 171
2025-08-14 02:33:21,254 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:33:22,033 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU5NUExRDM2MjcwOUY0NkQ4QQA="}]}
2025-08-14 02:33:23,043 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:23] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:23,228 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:23] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:23,392 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:23] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:23,820 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:33:24,421 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-171
2025-08-14 02:33:25,422 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:33:24.063465+00:00, interaction_count=925, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=cart_added, final_order_value=3200.0, converted_at=2025-08-14 01:33:03.794237+00:00
2025-08-14 02:33:26,081 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:33:26,087 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU5NUExRDM2MjcwOUY0NkQ4QQA='}]}
2025-08-14 02:33:26,087 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:26] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:30,468 - utils.data_manager - INFO - Updated order 171 to status confirmed
2025-08-14 02:33:32,157 - utils.data_manager - INFO - Retrieved 2 items for order 171
2025-08-14 02:33:34,320 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 171
2025-08-14 02:33:34,730 - utils.data_manager - INFO - Reduced inventory for product_id 100 by 1 for order 171
2025-08-14 02:33:36,935 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 02:33:37,150 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 171
2025-08-14 02:33:41,238 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-14 02:33:41,239 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-14 02:33:43,296 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:33:44,074 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAwODQyQzMzREIyRTk3RDA4QgA="}]}
2025-08-14 02:33:44,075 - handlers.payment_handler - INFO - Sent payment success text message for order 171 to customer 2348055614455
2025-08-14 02:33:44,075 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 171, session 2348055614455
2025-08-14 02:33:44,076 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'selected_category': None, 'selected_item': None, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 8, 14, 2, 33, 44, 76129), 'payment_reference': 'PAY-171', 'order_id': '171', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '99', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 1500.0, 'total_price': 1500.0}, {'item_id': '100', 'name': 'Fried Rice', 'quantity': 1, 'variations': {}, 'price': 1700.0, 'total_price': 1700.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 3200.0, 'error': ''}, 'total_price': 3200.0, 'from_ai_order': True, 'total_amount': 3200.0, 'order_status': 'confirmed', 'order_timestamp': '2025-08-14T02:32:53.052625', 'feedback_order_id': 171, 'feedback_started_at': '2025-08-14T02:33:44.076119'}
2025-08-14 02:33:44,076 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:33:45,080 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:45] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:45,270 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:45] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:45,511 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ2RTlCRDE4MkVCNzJDQzUxNQA="}]}
2025-08-14 02:33:45,512 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 171, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ2RTlCRDE4MkVCNzJDQzUxNQA='}]}
2025-08-14 02:33:45,513 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-14 02:33:46,416 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkUzMjAwRTlGRjQ4NDA2NTEzMAA="}]}
2025-08-14 02:33:46,417 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 171 to 2347082345056
2025-08-14 02:33:46,418 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:46] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-14 02:33:46,719 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:46,747 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:46,955 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:47,352 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:47] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:50,032 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:50] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:50,197 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:50] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:50,360 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:50] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:33:52,925 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'good'}
2025-08-14 02:33:54,585 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:33:57,203 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:33:54.782681+00:00, interaction_count=926, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=cart_added, final_order_value=3200.0, converted_at=2025-08-14 01:33:03.794237+00:00
2025-08-14 02:33:58,470 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:33:58,471 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:33:58,473 - handlers.feedback_handler - INFO - Feedback saved to data/feedback.json
2025-08-14 02:33:58,473 - handlers.feedback_handler - INFO - Feedback saved for order 171: good
2025-08-14 02:33:58,473 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:33:58,474 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Thank you for your feedback!'}}
2025-08-14 02:33:59,333 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyNUNCRENERjQzNkVBRjY1RAA="}]}
2025-08-14 02:33:59,334 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyNUNCRENERjQzNkVBRjY1RAA='}]}
2025-08-14 02:33:59,335 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:33:59] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:00,423 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:00] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:00,481 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:00] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:00,705 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:00] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:04,536 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 02:34:06,256 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:34:07,775 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:34:06.456923+00:00, interaction_count=927, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=cart_added, final_order_value=3200.0, converted_at=2025-08-14 01:33:03.794237+00:00
2025-08-14 02:34:08,415 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:34:08,416 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:34:08,416 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-14 02:34:08,416 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'horizon estate', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 02:34:08,417 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 02:34:09,204 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQzNzE1REJBRjc4RDVCMkE4RAA="}]}
2025-08-14 02:34:09,205 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQzNzE1REJBRjc4RDVCMkE4RAA='}]}
2025-08-14 02:34:09,206 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:09] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:10,162 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:10] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:10,449 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:10] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:11,899 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-171
2025-08-14 02:34:12,410 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 02:34:12,589 - services.payment_service - INFO - Payment verified successfully for reference PAY-171. Status: success
2025-08-14 02:34:12,589 - handlers.payment_handler - INFO - Payment verified for order 171 on attempt 2
2025-08-14 02:34:12,590 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-171
2025-08-14 02:34:13,239 - services.payment_service - INFO - Payment verified successfully for reference PAY-171. Status: success
2025-08-14 02:34:14,127 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:34:15,588 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:34:14.327333+00:00, interaction_count=928, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=cart_added, final_order_value=3200.0, converted_at=2025-08-14 01:33:03.794237+00:00
2025-08-14 02:34:16,242 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:34:16,243 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 02:34:16,243 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 02:34:16,243 - handlers.base_handler - INFO - Session 2348055614455: New order keyword 'ai_bulk_order_direct' detected. Redirecting to AI bulk order.
2025-08-14 02:34:16,243 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 02:34:16,244 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 02:34:16,244 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 02:34:16,244 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 02:34:16,244 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 02:34:17,150 - utils.data_manager - INFO - Updated order 171 to status confirmed
2025-08-14 02:34:17,200 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5RjQ4MjI1QUQyREE5M0U5NwA="}]}
2025-08-14 02:34:17,201 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 02:34:17,202 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 02:34:18,048 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlGNkQyMTZEN0ZENzJBMkVDMgA="}]}
2025-08-14 02:34:18,048 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlGNkQyMTZEN0ZENzJBMkVDMgA='}]}
2025-08-14 02:34:18,049 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:18] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:18,760 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:18] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:18,838 - utils.data_manager - INFO - Retrieved 2 items for order 171
2025-08-14 02:34:19,096 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:19,110 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:19,242 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:19,683 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:19,698 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 02:34:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 02:34:20,993 - utils.data_manager - INFO - Reduced inventory for product_id 99 by 1 for order 171
2025-08-14 02:34:21,398 - utils.data_manager - INFO - Reduced inventory for product_id 100 by 1 for order 171
2025-08-14 02:34:23,303 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 02:34:23,512 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 171
2025-08-14 02:34:31,371 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 02:34:32,908 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=18, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=None, first_contact=2025-08-10 02:51:45.849279+00:00, last_interaction=2025-08-14 01:34:31.590989+00:00, interaction_count=929, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=3200.0, conversion_stage=order_completed, final_order_value=4280.0, converted_at=2025-08-14 01:34:31.590995+00:00
2025-08-14 02:34:33,522 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 02:34:34,162 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Friied rice'}
2025-08-14 02:34:59,445 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Friied rice'}
2025-08-14 22:02:51,710 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 22:02:53,487 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 22:02:57,575 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 22:02:57,794 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 22:03:00,090 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 22:03:00,292 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 22:03:00,293 - services.payment_service - INFO - PaymentService initialized
2025-08-14 22:03:02,175 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 22:03:02,375 - app - INFO - Initial product sync successful on startup
2025-08-14 22:03:02,376 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 22:03:02,376 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 22:03:02,376 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 22:03:02,376 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 22:03:02,387 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 22:03:04,231 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 22:03:04,482 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 22:03:06,593 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 22:03:06,877 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 22:03:06,877 - services.payment_service - INFO - PaymentService initialized
2025-08-14 22:03:06,878 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 22:03:06,878 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 22:03:06,878 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 22:03:06,879 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 22:03:06,879 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 22:03:06,879 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 22:03:06,884 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 22:03:07,308 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 22:03:07,308 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 22:03:07,308 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 22:03:07,309 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 22:03:07,309 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 22:03:07,338 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 22:03:07,338 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 22:03:28,607 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:28] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:30,968 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 22:03:30,968 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-14 22:03:32,758 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:03:34,618 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:03:33.132157+00:00, interaction_count=14, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-14 20:33:43.682046+00:00
2025-08-14 22:03:35,279 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:03:35,280 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-14 22:03:37,087 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-14 22:03:37,295 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-14 22:03:37,296 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 22:03:37,296 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-14 22:03:37,296 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:03:38,494 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRBOTlEMjczN0FBODUxMEQyNAA="}]}
2025-08-14 22:03:38,495 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRBOTlEMjczN0FBODUxMEQyNAA='}]}
2025-08-14 22:03:38,496 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:38] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:39,567 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:39] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:39,851 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:39] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:40,041 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:40] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:50,113 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 22:03:52,211 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:03:54,599 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:03:52.422870+00:00, interaction_count=15, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-14 20:33:43.682046+00:00
2025-08-14 22:03:55,251 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:03:55,251 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:03:55,252 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 22:03:55,252 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 22:03:55,252 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 22:03:55,253 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 22:03:55,253 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 22:03:55,253 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 22:03:56,140 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM5QzhEOENENDFBQkZBOURCNAA="}]}
2025-08-14 22:03:56,141 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 22:03:56,141 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 22:03:56,885 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZDRjRCQTE0OTBGQzBGRjZFNAA="}]}
2025-08-14 22:03:56,886 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZDRjRCQTE0OTBGQzBGRjZFNAA='}]}
2025-08-14 22:03:56,886 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:56] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:57,862 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:57] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:58,698 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:58] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:58,846 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:58] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:58,846 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:58] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:58,981 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:58] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:03:59,073 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:03:59] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:04:01,898 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-14 22:04:03,708 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:04:05,230 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:04:03.919368+00:00, interaction_count=16, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=100.0, conversion_stage=cart_added, final_order_value=100.0, converted_at=2025-08-14 20:33:43.682046+00:00
2025-08-14 22:04:06,550 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:04:06,551 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:04:06,552 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-14 22:04:09,361 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-14 22:04:09,376 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:04:10,632 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-14 22:04:10,633 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'ai_handler', state 'ai_bulk_order', message 'jellof rice'. Resetting to greeting.
2025-08-14 22:04:10,633 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 22:04:10,634 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-14 22:04:10,634 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:04:11,585 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1QkVBMjdDQkQ1RjM3QjdFRgA="}]}
2025-08-14 22:04:11,586 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1QkVBMjdDQkQ1RjM3QjdFRgA='}]}
2025-08-14 22:04:11,587 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:04:11] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:04:12,495 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:04:12] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:04:12,610 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:04:12] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:04:12,763 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:04:12] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:48:26,434 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 22:48:27,797 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 22:48:30,502 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 22:48:30,733 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 22:48:33,471 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 22:48:33,751 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 22:48:33,751 - services.payment_service - INFO - PaymentService initialized
2025-08-14 22:48:36,169 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 22:48:36,376 - app - INFO - Initial product sync successful on startup
2025-08-14 22:48:36,377 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 22:48:36,377 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 22:48:36,377 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 22:48:36,378 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 22:48:36,384 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 22:48:39,000 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 22:48:39,204 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 22:48:41,803 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 22:48:43,819 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 22:48:43,819 - services.payment_service - INFO - PaymentService initialized
2025-08-14 22:48:43,820 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 22:48:43,820 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 22:48:43,820 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 22:48:43,821 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 22:48:43,821 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 22:48:43,821 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 22:48:43,826 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 22:48:44,259 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 22:48:44,259 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 22:48:44,259 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 22:48:44,260 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 22:48:44,260 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 22:48:44,282 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 22:48:44,283 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 22:48:45,863 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 22:48:45,863 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-14 22:48:47,733 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:48:49,380 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:48:47.964279+00:00, interaction_count=55, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:48:50,198 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:48:50,199 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-14 22:48:52,705 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-14 22:48:52,942 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-14 22:48:52,942 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 22:48:52,943 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-14 22:48:52,943 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:48:54,353 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMyOTczNjkxOTA3OEM3NjZFOAA="}]}
2025-08-14 22:48:54,354 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMyOTczNjkxOTA3OEM3NjZFOAA='}]}
2025-08-14 22:48:54,355 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:48:54] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:48:55,579 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:48:55] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:48:55,732 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:48:55] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:11,998 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:11] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:16,604 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-14 22:49:22,400 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:49:24,172 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:49:22.631898+00:00, interaction_count=56, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:49:24,791 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 22:49:24,972 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:49:24,973 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:49:24,973 - handlers.base_handler - INFO - GreetingHandler: Handling message 'update_address' in greeting state for session 2348055614455.
2025-08-14 22:49:24,974 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 22:49:24,974 - handlers.base_handler - WARNING - Session 2348055614455: Invalid option 'update_address' in greeting state for non-paid user.
2025-08-14 22:49:24,975 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:49:25,920 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFRDc1RjAzRDEwNzQzNDcxNQA="}]}
2025-08-14 22:49:25,921 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFRDc1RjAzRDEwNzQzNDcxNQA='}]}
2025-08-14 22:49:25,922 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:25] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:26,626 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:49:26,998 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:26] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:27,242 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:27,244 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:27,413 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:28,381 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:49:26.830966+00:00, interaction_count=57, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:49:29,062 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:49:29,062 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:49:29,063 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 22:49:29,063 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 22:49:29,063 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 22:49:29,064 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 22:49:29,064 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 22:49:29,064 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 22:49:29,965 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU2MDU1NDdFMzQ5NUQyQTM1QwA="}]}
2025-08-14 22:49:29,966 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 22:49:29,966 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 22:49:31,395 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNGNzNBQjFBQzIzRkJENzUxRAA="}]}
2025-08-14 22:49:31,396 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNGNzNBQjFBQzIzRkJENzUxRAA='}]}
2025-08-14 22:49:31,396 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:31] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:31,607 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:31] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:32,120 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 22:49:32,755 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:32] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:32,969 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:32] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:32,982 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:32] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:33,196 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:33] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:33,332 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:33] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:33,454 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:33] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:33,542 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:33] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:34,182 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:49:36,591 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:49:34.407759+00:00, interaction_count=58, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:49:37,362 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:49:37,363 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:49:37,364 - handlers.base_handler - INFO - AIHandler: Handling message 'ai_bulk_order_direct' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 22:49:37,721 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-14 22:49:39,728 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-14 22:49:39,731 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:49:40,377 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:49:41,587 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVDNDI5RTNBNTY3RUI2NjAxQQA="}]}
2025-08-14 22:49:41,588 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVDNDI5RTNBNTY3RUI2NjAxQQA='}]}
2025-08-14 22:49:41,589 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:41] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:42,700 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:42] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:42,859 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:42] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:42,994 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:42] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:43,036 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:43] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:43,095 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:49:40.710939+00:00, interaction_count=59, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:49:43,785 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:49:43,786 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:49:43,786 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:49:44,750 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA3QkVBNTY1MTMzRTg3M0RFNwA="}]}
2025-08-14 22:49:44,751 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA3QkVBNTY1MTMzRTg3M0RFNwA='}]}
2025-08-14 22:49:44,752 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:44] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:45,957 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:45] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:46,955 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'cancel_ai_order'}
2025-08-14 22:49:46,962 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:47,219 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:47] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:47,221 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:47] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:48,744 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'cancel_ai_order'}
2025-08-14 22:49:49,456 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:49:50,730 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:49:51,026 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:49:49.671507+00:00, interaction_count=60, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:49:51,761 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:49:51,763 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:49:51,763 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:49:52,358 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:49:50.928015+00:00, interaction_count=60, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:49:52,605 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUzRDJGNTI5QUUzMDJDQzM3MAA="}]}
2025-08-14 22:49:52,606 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUzRDJGNTI5QUUzMDJDQzM3MAA='}]}
2025-08-14 22:49:52,606 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:52] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:53,100 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:49:53,101 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:49:53,101 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:49:53,693 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:53] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:53,751 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:53] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:53,836 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:53] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:53,966 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5NTcxMzhGMDZBNDUzQTkyNAA="}]}
2025-08-14 22:49:53,967 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5NTcxMzhGMDZBNDUzQTkyNAA='}]}
2025-08-14 22:49:53,967 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:53] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:55,138 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:55] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:55,290 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:55] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:55,292 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:55] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:49:55,385 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:49:55] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:50:28,715 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'cancel_ai_order'}
2025-08-14 22:50:30,652 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:50:32,223 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:50:30.874493+00:00, interaction_count=61, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:50:32,920 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:50:32,921 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:50:32,921 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:50:33,782 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFMTRDMjNDMDdCNjNERERENgA="}]}
2025-08-14 22:50:33,783 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFMTRDMjNDMDdCNjNERERENgA='}]}
2025-08-14 22:50:33,783 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:50:33] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:50:34,752 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:50:34] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:50:35,064 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:50:35] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:11,573 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 22:51:12,673 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 22:51:14,505 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 22:51:14,718 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 22:51:16,734 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 22:51:16,971 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 22:51:16,971 - services.payment_service - INFO - PaymentService initialized
2025-08-14 22:51:19,505 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 22:51:20,014 - app - INFO - Initial product sync successful on startup
2025-08-14 22:51:20,014 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 22:51:20,015 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 22:51:20,015 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 22:51:20,016 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 22:51:20,024 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 22:51:23,213 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 22:51:23,455 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 22:51:25,573 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 22:51:25,782 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 22:51:25,783 - services.payment_service - INFO - PaymentService initialized
2025-08-14 22:51:25,783 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 22:51:25,783 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 22:51:25,784 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 22:51:25,785 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 22:51:25,785 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 22:51:25,785 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 22:51:25,790 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 22:51:26,207 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 22:51:26,207 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 22:51:26,207 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 22:51:26,208 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 22:51:26,208 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 22:51:26,223 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 22:51:26,224 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 22:51:28,422 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 22:51:28,422 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-14 22:51:30,308 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:51:31,951 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:51:30.514575+00:00, interaction_count=62, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:51:32,645 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:51:32,646 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-14 22:51:34,784 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-14 22:51:35,040 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-14 22:51:35,040 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 22:51:35,041 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-14 22:51:35,041 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:51:36,014 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJGQTZENDIyQTYyNEI5NDA0QwA="}]}
2025-08-14 22:51:36,016 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJGQTZENDIyQTYyNEI5NDA0QwA='}]}
2025-08-14 22:51:36,017 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:36] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:37,071 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:37] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:37,348 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:37] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:37,433 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:37] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:41,400 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 22:51:43,283 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:51:44,938 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:51:43.528705+00:00, interaction_count=63, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:51:45,745 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:51:45,745 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:51:45,746 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 22:51:45,746 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 22:51:45,746 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 22:51:45,747 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 22:51:45,747 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 22:51:45,747 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 22:51:46,839 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg2OTFFM0MzOUIwQUY0QTlERgA="}]}
2025-08-14 22:51:46,840 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 22:51:46,840 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 22:51:48,351 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:48] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:48,498 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJDRDU0QTAyODJCM0Y0MUQ4NAA="}]}
2025-08-14 22:51:48,500 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:48] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:48,499 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJDRDU0QTAyODJCM0Y0MUQ4NAA='}]}
2025-08-14 22:51:48,501 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:48] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:49,035 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:49] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:49,558 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:49] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:49,635 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:49] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:49,828 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:51:49] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:51:53,852 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-14 22:51:55,648 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:51:57,384 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:51:56.020984+00:00, interaction_count=64, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:51:58,779 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:51:58,780 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:51:58,781 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-14 22:52:02,054 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-14 22:52:02,056 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:52:02,842 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE5MDZBMUUzMzEwNjFERTdEQQA="}]}
2025-08-14 22:52:02,842 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE5MDZBMUUzMzEwNjFERTdEQQA='}]}
2025-08-14 22:52:02,843 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:02] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:03,816 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:03] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:04,013 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:04] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:04,340 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:04] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:06,566 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-14 22:52:08,371 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:52:10,015 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:52:08.597510+00:00, interaction_count=65, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1800.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:52:10,690 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:52:10,691 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:52:10,692 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-14 22:52:10,692 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-14 22:52:10,693 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 22:52:10,693 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-14 22:52:10,693 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-14 22:52:10,694 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:52:12,589 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxMTQ3NjE5RThCRjFEOTE3NQA="}]}
2025-08-14 22:52:13,573 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:13] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:13,886 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:13] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:14,934 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:52:16,026 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-14 22:52:16,893 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:52:15.559743+00:00, interaction_count=66, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:52:17,646 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:52:17,653 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxMTQ3NjE5RThCRjFEOTE3NQA='}]}
2025-08-14 22:52:17,654 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:17] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:17,905 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:52:19,410 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:52:18.102860+00:00, interaction_count=67, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:52:20,119 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:52:20,120 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:52:20,121 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-14 22:52:20,121 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 22:52:20,126 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 22:52:21,076 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUyNDZDNTQwMzFGNkQ3QzkwMwA="}]}
2025-08-14 22:52:22,045 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:22] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:22,169 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:22] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:22,214 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:22] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:22,844 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:52:24,435 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:52:23.049759+00:00, interaction_count=68, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:52:25,169 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:52:25,176 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUyNDZDNTQwMzFGNkQ3QzkwMwA='}]}
2025-08-14 22:52:25,177 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:25] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:28,505 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-14 22:52:30,455 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:52:32,013 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:52:30.662206+00:00, interaction_count=69, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1800.0, converted_at=2025-08-14 21:22:05.501753+00:00
2025-08-14 22:52:32,663 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:52:32,664 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 22:52:32,665 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 22:52:35,940 - utils.data_manager - WARNING - No product found with name Jollof Rice for merchant 20
2025-08-14 22:52:36,145 - utils.data_manager - ERROR - No product_id found for item Jollof Rice in whatsapp_merchant_product_inventory
2025-08-14 22:52:36,148 - handlers.order_handler - INFO - Order None saved to database for session 2348055614455
2025-08-14 22:52:38,524 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-14 22:52:38,526 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-14 22:52:40,327 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:52:42,403 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:52:40.560608+00:00, interaction_count=70, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 22:52:43,087 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:52:43,094 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-14 22:52:43,095 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-14 22:52:43,095 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-14 22:52:45,129 - utils.data_manager - ERROR - Database error retrieving order None: invalid input syntax for type bigint: "None"
LINE 6:                         WHERE id = 'None' AND merchant_detai...
                                           ^
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\utils\data_manager.py", line 669, in get_order_by_id
    cur.execute(
    ~~~~~~~~~~~^
        """
        ^^^
    ...<6 lines>...
        (order_id, self.merchant_id)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\extras.py", line 236, in execute
    return super().execute(query, vars)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^
psycopg2.errors.InvalidTextRepresentation: invalid input syntax for type bigint: "None"
LINE 6:                         WHERE id = 'None' AND merchant_detai...
                                           ^

2025-08-14 22:52:45,132 - handlers.payment_handler - ERROR - Order None not found in database for session 2348055614455
2025-08-14 22:52:45,132 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 22:52:46,146 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk1NjEyNDcxNzdCREZBQzY0OAA="}]}
2025-08-14 22:52:47,165 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:47] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:47,314 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:47] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:47,476 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:47] "POST /webhook HTTP/1.1" 200 -
2025-08-14 22:52:48,004 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 22:52:49,531 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 21:52:48.219624+00:00, interaction_count=71, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 22:52:50,161 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 22:52:50,167 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk1NjEyNDcxNzdCREZBQzY0OAA='}]}
2025-08-14 22:52:50,167 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 22:52:50] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:02:53,660 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 23:02:54,955 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:02:58,484 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:02:58,714 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:03:00,654 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:03:00,855 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:03:00,856 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:03:02,787 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 23:03:03,012 - app - INFO - Initial product sync successful on startup
2025-08-14 23:03:03,013 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:03:03,013 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 23:03:03,014 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:03:03,014 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:03:03,021 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:03:06,154 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:03:06,397 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:03:08,791 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:03:09,007 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:03:09,008 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:03:09,008 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 23:03:09,008 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 23:03:09,009 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:03:09,009 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 23:03:09,010 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:03:09,010 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:03:09,015 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 23:03:09,401 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 23:03:09,401 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 23:03:09,402 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 23:03:09,402 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 23:03:09,402 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:03:09,417 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 23:03:09,417 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 23:03:10,172 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 23:03:10,173 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-14 23:03:12,377 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:03:14,246 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:03:12.586393+00:00, interaction_count=72, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 23:03:15,046 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:03:15,047 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-14 23:03:17,010 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-14 23:03:17,216 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-14 23:03:17,217 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:03:17,217 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-14 23:03:17,218 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:03:18,145 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRFMEI5RkVCNDMyRkYyQkM1QgA="}]}
2025-08-14 23:03:18,146 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRFMEI5RkVCNDMyRkYyQkM1QgA='}]}
2025-08-14 23:03:18,147 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:18] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:19,186 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:19,417 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:19,475 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:20,666 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 23:03:22,427 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:03:24,049 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:03:22.633364+00:00, interaction_count=73, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 23:03:24,766 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:03:24,767 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:03:24,767 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 23:03:24,768 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 23:03:24,768 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 23:03:24,768 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 23:03:24,769 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 23:03:24,769 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 23:03:25,754 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3QjAyMTIwRjJGQjdGMkU5QwA="}]}
2025-08-14 23:03:25,755 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:03:25,756 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 23:03:26,599 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0ODMzMEQ1RDI1MDlGQzFDNAA="}]}
2025-08-14 23:03:26,600 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ0ODMzMEQ1RDI1MDlGQzFDNAA='}]}
2025-08-14 23:03:26,600 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:26] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:27,477 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:28,167 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:28] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:28,168 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:28] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:28,229 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:28] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:28,651 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:28] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:28,674 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:28] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:31,922 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-14 23:03:33,778 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:03:35,329 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:03:34.011461+00:00, interaction_count=74, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 23:03:36,088 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:03:36,089 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:03:36,089 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-14 23:03:38,300 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-14 23:03:38,302 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:03:39,322 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVGNEE2MzMwRkY0NEY4QjgxRgA="}]}
2025-08-14 23:03:39,323 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVGNEE2MzMwRkY0NEY4QjgxRgA='}]}
2025-08-14 23:03:39,325 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:39] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:40,295 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:40] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:40,554 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:40] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:40,815 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:40] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:46,517 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-14 23:03:48,970 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:03:50,896 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:03:49.222089+00:00, interaction_count=75, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 23:03:51,549 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:03:51,550 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:03:51,551 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-14 23:03:51,551 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-14 23:03:51,551 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:03:51,552 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-14 23:03:51,552 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-14 23:03:51,552 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:03:52,414 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdFNDQ5RjM1RTI5REMzQzNFRgA="}]}
2025-08-14 23:03:53,570 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:53] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:53,642 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:53] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:54,546 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:03:55,415 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-14 23:03:56,368 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:03:54.783728+00:00, interaction_count=76, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 23:03:56,993 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:03:57,000 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdFNDQ5RjM1RTI5REMzQzNFRgA='}]}
2025-08-14 23:03:57,001 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:03:57] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:03:57,226 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:03:58,769 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:03:57.443610+00:00, interaction_count=77, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 23:03:59,448 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:03:59,449 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:03:59,449 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-14 23:03:59,449 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:03:59,454 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:04:00,294 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY1N0E1MjAxQUJFRjBEOEI2MwA="}]}
2025-08-14 23:04:01,288 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:04:01] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:04:01,616 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:04:01] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:04:01,735 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:04:01] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:04:03,102 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:04:04,044 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-14 23:04:04,690 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:04:03.334948+00:00, interaction_count=78, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 23:04:05,376 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:04:05,382 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY1N0E1MjAxQUJFRjBEOEI2MwA='}]}
2025-08-14 23:04:05,383 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:04:05] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:04:05,819 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:04:07,400 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:04:06.026619+00:00, interaction_count=79, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 21:52:40.560616+00:00
2025-08-14 23:04:08,221 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:04:08,222 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:04:08,222 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:04:11,725 - utils.data_manager - WARNING - No product found with name Jollof Rice for merchant 20
2025-08-14 23:04:11,929 - utils.data_manager - ERROR - No product_id found for item Jollof Rice in whatsapp_merchant_product_inventory
2025-08-14 23:04:11,930 - handlers.order_handler - INFO - Order None saved to database for session 2348055614455
2025-08-14 23:04:14,007 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-14 23:04:14,008 - handlers.order_handler - INFO - User details saved for session 2348055614455 during order confirmation.
2025-08-14 23:04:15,826 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:04:17,697 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:04:16.049162+00:00, interaction_count=80, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=order_completed, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:04:18,308 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:04:18,315 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-14 23:04:18,315 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-14 23:04:18,315 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-14 23:04:18,316 - handlers.payment_handler - ERROR - Invalid order_id 'None' found for session 2348055614455
2025-08-14 23:04:18,316 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:04:19,172 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVDNzEyMTk5NjcxODFDRTQ1OAA="}]}
2025-08-14 23:04:20,219 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:04:20] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:04:20,338 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:04:20] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:04:20,397 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:04:20] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:04:21,118 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:04:22,733 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:04:21.320671+00:00, interaction_count=81, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:04:23,345 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:04:23,352 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVDNzEyMTk5NjcxODFDRTQ1OAA='}]}
2025-08-14 23:04:23,352 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:04:23] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:06:56,455 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 23:06:57,640 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:06:59,513 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:06:59,728 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:07:01,671 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:07:01,883 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:07:01,883 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:07:03,612 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 23:07:03,823 - app - INFO - Initial product sync successful on startup
2025-08-14 23:07:03,823 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:07:03,824 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 23:07:03,824 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:07:03,825 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:07:03,831 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:07:06,575 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:07:06,795 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:07:09,123 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:07:09,332 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:07:09,333 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:07:09,333 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 23:07:09,333 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 23:07:09,334 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:07:09,334 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 23:07:09,335 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:07:09,335 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:07:09,340 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 23:07:09,755 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 23:07:09,756 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 23:07:09,756 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 23:07:09,757 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 23:07:09,757 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:07:09,773 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 23:07:09,774 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 23:09:48,385 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 23:09:50,033 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:09:54,028 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:09:54,247 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:09:56,302 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:09:56,525 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:09:56,526 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:09:58,567 - handlers.product_sync_handler - INFO - Successfully synced 13 products to data\products.json
2025-08-14 23:09:58,765 - app - INFO - Initial product sync successful on startup
2025-08-14 23:09:58,765 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:09:58,765 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 23:09:58,766 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:09:58,766 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:09:58,778 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:10:00,585 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:10:00,815 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:10:02,879 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:10:03,093 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:10:03,094 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:10:03,094 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 23:10:03,094 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 23:10:03,095 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:10:03,096 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 23:10:03,097 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:10:03,097 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:10:03,104 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 23:10:03,552 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 23:10:03,552 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 23:10:03,553 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 23:10:03,553 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 23:10:03,554 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:10:03,588 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 23:10:03,589 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 23:10:04,040 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 23:10:04,040 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-14 23:10:05,782 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:10:07,365 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:10:05.983904+00:00, interaction_count=82, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:10:08,021 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:10:08,022 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-14 23:10:09,774 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-14 23:10:10,006 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-14 23:10:10,006 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:10:10,007 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-14 23:10:10,007 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:10:11,252 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5N0Q3NDc0RDFCQTdBODkyMgA="}]}
2025-08-14 23:10:11,265 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5N0Q3NDc0RDFCQTdBODkyMgA='}]}
2025-08-14 23:10:11,267 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:11] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:12,305 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:12] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:12,571 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:12] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:12,635 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:12] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:14,203 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 23:10:15,967 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:10:17,730 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:10:16.171871+00:00, interaction_count=83, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:10:18,421 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:10:18,422 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:10:18,423 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 23:10:18,423 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 23:10:18,424 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 23:10:18,424 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 23:10:18,424 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 23:10:18,425 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 23:10:19,347 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhBNjhEN0ZGMDg1QzVFNjkyOAA="}]}
2025-08-14 23:10:19,348 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:10:19,349 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 23:10:20,124 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcxMEE3NkU1NDMwOEY4MTFBRQA="}]}
2025-08-14 23:10:20,125 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcxMEE3NkU1NDMwOEY4MTFBRQA='}]}
2025-08-14 23:10:20,126 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:20] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:20,742 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:20] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:21,365 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:21] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:21,498 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:21] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:21,499 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:21] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:21,874 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:21] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:22,084 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:22] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:33,212 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-14 23:10:34,918 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:10:36,585 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:10:35.140366+00:00, interaction_count=84, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:10:37,653 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:10:37,654 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:10:37,655 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-14 23:10:42,382 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-14 23:10:42,389 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:10:43,334 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5MjQ1QTREMTYxQkNCRENCRAA="}]}
2025-08-14 23:10:43,334 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5MjQ1QTREMTYxQkNCRENCRAA='}]}
2025-08-14 23:10:43,335 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:43] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:44,461 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:44] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:44,659 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:44] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:44,804 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:44] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:47,162 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-14 23:10:49,924 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:10:51,886 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:10:50.135057+00:00, interaction_count=85, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:10:52,625 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:10:52,626 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:10:52,626 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '99', 'quantity': 1, 'price': 1500.0, 'total_price': 1500.0, 'variations': {}}}. Redirecting to order handler.
2025-08-14 23:10:52,626 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-14 23:10:52,627 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:10:52,627 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-14 23:10:52,627 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-14 23:10:52,627 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:10:53,505 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAzRTBEM0VBNjQ0MDBEMUY5NgA="}]}
2025-08-14 23:10:54,545 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:54] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:54,772 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:54] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:54,844 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:54] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:55,191 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:10:56,733 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-14 23:10:56,916 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:10:55.441398+00:00, interaction_count=86, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:10:57,740 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:10:57,748 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAzRTBEM0VBNjQ0MDBEMUY5NgA='}]}
2025-08-14 23:10:57,749 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:10:57] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:10:58,651 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:11:00,278 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:10:58.852755+00:00, interaction_count=87, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:11:01,443 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:11:01,445 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:11:01,445 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-14 23:11:01,445 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:11:01,451 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:11:02,363 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyNjhENUQ0MzRBREEyMzVDRgA="}]}
2025-08-14 23:11:03,368 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:11:03] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:11:03,531 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:11:03] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:11:03,694 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:11:03] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:11:04,106 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:11:06,181 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:11:04.311716+00:00, interaction_count=88, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:11:06,806 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:11:06,811 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyNjhENUQ0MzRBREEyMzVDRgA='}]}
2025-08-14 23:11:06,812 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:11:06] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:11:07,168 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-14 23:11:09,013 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:11:10,571 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:11:09.215882+00:00, interaction_count=89, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:11:11,220 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:11:11,221 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:11:11,221 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:11:13,046 - utils.data_manager - WARNING - No product found with name Jollof Rice for merchant 20
2025-08-14 23:11:13,251 - handlers.order_handler - ERROR - Could not find product_id for item: Jollof Rice
2025-08-14 23:11:13,251 - handlers.order_handler - ERROR - No valid items in cart for session 2348055614455
2025-08-14 23:11:13,252 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:11:14,158 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY3RTZBNTVFNzU1M0ZERUZBNgA="}]}
2025-08-14 23:11:15,420 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:11:15] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:11:15,608 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:11:15] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:11:15,610 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:11:15] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:11:15,874 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:11:18,621 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:11:16.073891+00:00, interaction_count=90, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:11:19,535 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:11:19,541 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY3RTZBNTVFNzU1M0ZERUZBNgA='}]}
2025-08-14 23:11:19,542 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:11:19] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:16:55,945 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 23:16:57,212 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:17:01,309 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:17:01,537 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:17:03,595 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:17:03,813 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:17:03,814 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:17:05,591 - handlers.product_sync_handler - INFO - Successfully synced 30 products to data\products.json
2025-08-14 23:17:05,799 - app - INFO - Initial product sync successful on startup
2025-08-14 23:17:05,800 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:17:05,800 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 23:17:05,801 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:17:05,801 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:17:05,808 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:17:07,868 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:17:08,093 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:17:10,419 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:17:10,645 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:17:10,646 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:17:10,646 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 23:17:10,646 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 23:17:10,647 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:17:10,648 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 23:17:10,648 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:17:10,648 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:17:10,653 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 23:17:11,050 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 23:17:11,050 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 23:17:11,050 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 23:17:11,051 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 23:17:11,051 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:17:11,068 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 23:17:11,068 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 23:18:37,905 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 23:18:39,135 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:18:41,328 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:18:41,534 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:18:44,330 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:18:44,543 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:18:44,543 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:18:46,478 - handlers.product_sync_handler - INFO - Successfully synced 30 products to data\products.json
2025-08-14 23:18:46,726 - app - INFO - Initial product sync successful on startup
2025-08-14 23:18:46,726 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:18:46,727 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 23:18:46,728 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:18:46,728 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:18:46,735 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:18:48,634 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:18:48,843 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:18:50,829 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:18:51,115 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:18:51,116 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:18:51,116 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 23:18:51,116 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 23:18:51,116 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:18:51,117 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 23:18:51,117 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:18:51,117 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:18:51,121 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 23:18:51,561 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 23:18:51,561 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 23:18:51,562 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 23:18:51,562 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 23:18:51,563 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:18:51,586 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 23:18:51,586 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 23:19:02,200 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 23:19:03,632 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:19:07,832 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:19:08,062 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:19:10,650 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:19:10,858 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:19:10,859 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:19:12,999 - handlers.product_sync_handler - INFO - Successfully synced 30 products to data\products.json
2025-08-14 23:19:13,212 - app - INFO - Initial product sync successful on startup
2025-08-14 23:19:13,213 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:19:13,213 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 23:19:13,213 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:19:13,214 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:19:13,220 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:19:15,546 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:19:15,770 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:19:18,172 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:19:18,383 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:19:18,384 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:19:18,384 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 23:19:18,384 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 23:19:18,384 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:19:18,385 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 23:19:18,385 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:19:18,386 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:19:18,390 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 23:19:18,864 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 23:19:18,864 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 23:19:18,865 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 23:19:18,865 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 23:19:18,865 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:19:18,879 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 23:19:18,879 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 23:19:36,916 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 23:19:38,114 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:19:39,965 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:19:40,182 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:19:42,337 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:19:42,552 - utils.data_manager - ERROR - Error decoding JSON from data\products.json: Expecting value: line 1 column 1 (char 0)
2025-08-14 23:19:42,552 - utils.data_manager - WARNING - File not found or empty: data\products.json
2025-08-14 23:19:42,552 - utils.data_manager - WARNING - Product data in data\products.json is not a dictionary. Initializing as empty.
2025-08-14 23:19:42,553 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:19:42,554 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:19:44,364 - handlers.product_sync_handler - INFO - Successfully synced 30 products to data\products.json
2025-08-14 23:19:44,585 - app - INFO - Initial product sync successful on startup
2025-08-14 23:19:44,586 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:19:44,586 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 23:19:44,586 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:19:44,587 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:19:44,596 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:19:46,381 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:19:46,707 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:19:49,360 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:19:49,741 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:19:49,742 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:19:49,742 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 23:19:49,742 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 23:19:49,743 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:19:49,743 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 23:19:49,744 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:19:49,744 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:19:49,749 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 23:19:50,161 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 23:19:50,161 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 23:19:50,161 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 23:19:50,162 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 23:19:50,162 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:19:50,178 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 23:19:50,178 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 23:20:40,260 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-14 23:20:41,592 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:20:43,734 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:20:43,988 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:20:47,251 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:20:47,532 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:20:47,533 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:20:49,512 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-14 23:20:49,726 - app - INFO - Initial product sync successful on startup
2025-08-14 23:20:49,726 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:20:49,726 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-14 23:20:49,727 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:20:49,727 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:20:49,734 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-14 23:20:51,737 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-14 23:20:51,969 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-14 23:20:54,413 - utils.data_manager - INFO - Successfully loaded 39 user details from database
2025-08-14 23:20:55,140 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-14 23:20:55,140 - services.payment_service - INFO - PaymentService initialized
2025-08-14 23:20:55,141 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-14 23:20:55,141 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-14 23:20:55,141 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-14 23:20:55,142 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-14 23:20:55,142 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-14 23:20:55,143 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:20:55,147 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-14 23:20:55,536 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-14 23:20:55,536 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-14 23:20:55,536 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-14 23:20:55,537 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-14 23:20:55,537 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-14 23:20:55,554 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-14 23:20:55,554 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-14 23:21:09,626 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-14 23:21:09,627 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-14 23:21:11,731 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:21:13,587 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:21:11.963079+00:00, interaction_count=91, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:21:14,307 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:21:14,308 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-14 23:21:16,419 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-14 23:21:16,647 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-14 23:21:16,647 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:21:16,648 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-14 23:21:16,648 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:21:17,500 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFDRTY1QjQ5QkI0MkIxMzQ0NgA="}]}
2025-08-14 23:21:17,501 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFDRTY1QjQ5QkI0MkIxMzQ0NgA='}]}
2025-08-14 23:21:17,503 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:17] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:18,665 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:18] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:18,804 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:18] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:18,948 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:18] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:19,785 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-14 23:21:21,914 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:21:23,560 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:21:22.134477+00:00, interaction_count=92, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:21:24,215 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:21:24,216 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:21:24,216 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-14 23:21:24,216 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-14 23:21:24,217 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-14 23:21:24,217 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-14 23:21:24,217 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-14 23:21:24,218 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-thursday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-14 23:21:25,243 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYyRjIwODAyREQ5M0RCMjc4RAA="}]}
2025-08-14 23:21:25,244 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:21:25,244 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-14 23:21:26,067 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQxOUQ5MkE3QzA0OUI3M0UzRAA="}]}
2025-08-14 23:21:26,067 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQxOUQ5MkE3QzA0OUI3M0UzRAA='}]}
2025-08-14 23:21:26,068 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:26] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:27,108 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:27,504 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:27,595 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:27,597 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:27,904 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:27,930 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:27] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:36,935 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice with 2 eggs'}
2025-08-14 23:21:38,773 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:21:40,359 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:21:39.011246+00:00, interaction_count=93, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:21:41,162 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:21:41,163 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:21:41,163 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice with 2 eggs' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice with 2 eggs'
2025-08-14 23:21:44,178 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-14 23:21:44,181 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:21:45,003 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwMkQ1ODZCNkVGRkY1MzFGNQA="}]}
2025-08-14 23:21:45,003 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYwMkQ1ODZCNkVGRkY1MzFGNQA='}]}
2025-08-14 23:21:45,004 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:45] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:45,963 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:45] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:46,231 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:46,232 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:46] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:47,987 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-14 23:21:49,891 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:21:51,465 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:21:50.124429+00:00, interaction_count=94, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:21:52,336 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:21:52,337 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:21:52,337 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}, 'Egg': {'item_id': '124', 'quantity': 2, 'price': 2000.0, 'total_price': 4000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-14 23:21:52,338 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-14 23:21:52,338 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:21:52,338 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-14 23:21:52,339 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-14 23:21:52,339 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:21:53,208 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYyMzI1MUIxNjgyN0IxMEM1MAA="}]}
2025-08-14 23:21:54,481 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:54] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:54,882 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:54] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:54,884 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:54] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:21:55,661 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:21:55,786 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-08-14 23:21:57,506 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:21:55.865970+00:00, interaction_count=95, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:21:58,016 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:21:58,241 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:21:58,247 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYyMzI1MUIxNjgyN0IxMEM1MAA='}]}
2025-08-14 23:21:58,248 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:21:58] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:00,809 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:21:58.241273+00:00, interaction_count=95, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=1500.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:22:01,459 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:22:01,460 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:22:01,460 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-08-14 23:22:01,461 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:22:01,461 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please type your note for the order (e.g., 'Please deliver after 5 PM'). Type 'back' to skip adding a note."}}
2025-08-14 23:22:02,384 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEyNTFFODQyOTIzNURBNDQ5NgA="}]}
2025-08-14 23:22:03,444 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:03] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:04,015 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:04] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:04,017 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:04] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:04,675 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:22:06,337 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:22:04.896273+00:00, interaction_count=96, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:22:07,213 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:22:07,219 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEyNTFFODQyOTIzNURBNDQ5NgA='}]}
2025-08-14 23:22:07,220 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:07] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:11,248 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': "Don't mix the egg and fried rice"}
2025-08-14 23:22:13,464 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:22:15,295 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:22:13.733756+00:00, interaction_count=97, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:22:16,006 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:22:16,007 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:22:16,007 - handlers.order_handler - INFO - Note 'don't mix the egg and fried rice' added for session 2348055614455.
2025-08-14 23:22:16,008 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:22:16,014 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:22:17,219 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY5ODNGNTJGOTkxNkYwMzQyRQA="}]}
2025-08-14 23:22:18,315 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:18] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:18,420 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:18] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:18,562 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:18] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:19,149 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:22:20,016 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-14 23:22:21,459 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:22:19.530951+00:00, interaction_count=98, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:22:22,144 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:22:22,150 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY5ODNGNTJGOTkxNkYwMzQyRQA='}]}
2025-08-14 23:22:22,151 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:22] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:22,484 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:22:24,154 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:22:22.681434+00:00, interaction_count=99, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=cart_added, final_order_value=1500.0, converted_at=2025-08-14 22:04:16.049170+00:00
2025-08-14 23:22:24,781 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:22:24,782 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:22:24,783 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-14 23:22:26,505 - utils.data_manager - DEBUG - Found product_id 112 for product_name Jollof Rice
2025-08-14 23:22:28,450 - utils.data_manager - DEBUG - Found product_id 113 for product_name Fried Rice
2025-08-14 23:22:30,524 - utils.data_manager - DEBUG - Found product_id 124 for product_name Egg
2025-08-14 23:22:32,579 - utils.data_manager - INFO - Saved order 179 for customer 2348055614455
2025-08-14 23:22:32,813 - utils.data_manager - INFO - Saved order item Jollof Rice for order 179
2025-08-14 23:22:33,041 - utils.data_manager - INFO - Saved order item Fried Rice for order 179
2025-08-14 23:22:33,261 - utils.data_manager - INFO - Saved order item Egg for order 179
2025-08-14 23:22:33,485 - handlers.order_handler - INFO - Order 179 saved to database for session 2348055614455
2025-08-14 23:22:35,824 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-14 23:22:37,713 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:22:39,403 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:22:37.912116+00:00, interaction_count=100, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=8000.0, converted_at=2025-08-14 22:22:37.912124+00:00
2025-08-14 23:22:41,006 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:22:41,012 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-14 23:22:41,013 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-14 23:22:41,013 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-14 23:22:45,297 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-14 23:22:46,189 - utils.data_manager - INFO - Updated order 179 to status pending_payment
2025-08-14 23:22:46,190 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-14 23:22:46,190 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-179 with amount: 920000, email: ziga4455@lola.com
2025-08-14 23:22:47,035 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/y0ag03p84v2ey6l
2025-08-14 23:22:47,036 - handlers.payment_handler - INFO - Starting payment monitoring for order 179, reference PAY-179
2025-08-14 23:22:47,036 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-179
2025-08-14 23:22:47,092 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:22:47,581 - services.payment_service - WARNING - Payment not successful for reference PAY-179. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5239166816, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-179', 'receipt_number': None, 'amount': 920000, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-14T22:22:46.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.84.23, 172.70.86.134, 172.31.62.52', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': '179', 'delivery_address': 'lagos', 'delivery_fee': '1000', 'service_charge': '200', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 23800, 'integration': '9200', 'subaccount': 887000, 'params': {'bearer': 'subaccount', 'transaction_charge': '9200', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-14T22:22:46.000Z', 'requested_amount': 920000, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-14T22:22:46.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-14 23:22:47,583 - handlers.payment_handler - INFO - Payment not yet verified for order 179, attempt 1/15
2025-08-14 23:22:47,591 - handlers.payment_handler - INFO - Payment link created successfully for order 179 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-14 23:22:48,712 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:22:47.312450+00:00, interaction_count=101, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=8000.0, converted_at=2025-08-14 22:22:37.912124+00:00
2025-08-14 23:22:49,436 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:22:49,437 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:22:49,467 - utils.data_manager - INFO - Retrieved 3 items for order 179
2025-08-14 23:22:49,742 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:22:50,680 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU1Njk2N0M4ODVDNkQxODAwQQA="}]}
2025-08-14 23:22:51,770 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 179.
2025-08-14 23:22:51,943 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:51] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:52,100 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:52] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:52,102 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:52] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:53,760 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:22:53,992 - utils.data_manager - INFO - Retrieved 3 items for order 179
2025-08-14 23:22:54,207 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:22:55,026 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIwMzhGRUFFMjFCODgzOTgyRgA="}]}
2025-08-14 23:22:55,324 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:22:53.993024+00:00, interaction_count=102, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=cart_added, final_order_value=8000.0, converted_at=2025-08-14 22:22:37.912124+00:00
2025-08-14 23:22:55,988 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:22:55,992 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU1Njk2N0M4ODVDNkQxODAwQQA='}]}
2025-08-14 23:22:55,993 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:55] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:56,006 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:56] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:56,272 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:56] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:56,345 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:56] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:22:57,374 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:22:58,995 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:22:57.585322+00:00, interaction_count=103, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=cart_added, final_order_value=8000.0, converted_at=2025-08-14 22:22:37.912124+00:00
2025-08-14 23:22:59,671 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:22:59,676 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjIwMzhGRUFFMjFCODgzOTgyRgA='}]}
2025-08-14 23:22:59,677 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:22:59] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:00,506 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-179
2025-08-14 23:23:04,499 - utils.data_manager - INFO - Updated order 179 to status confirmed
2025-08-14 23:23:06,209 - utils.data_manager - INFO - Retrieved 3 items for order 179
2025-08-14 23:23:08,470 - utils.data_manager - INFO - Reduced inventory for product_id 112 by 1 for order 179
2025-08-14 23:23:09,045 - utils.data_manager - INFO - Reduced inventory for product_id 113 by 1 for order 179
2025-08-14 23:23:09,479 - utils.data_manager - INFO - Reduced inventory for product_id 124 by 2 for order 179
2025-08-14 23:23:11,525 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-14 23:23:11,759 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 179
2025-08-14 23:23:17,854 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-14 23:23:17,855 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-14 23:23:20,001 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:23:21,152 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc4Rjk0QkJGNDhGOEQ0QkEzMwA="}]}
2025-08-14 23:23:21,152 - handlers.payment_handler - INFO - Sent payment success text message for order 179 to customer 2348055614455
2025-08-14 23:23:21,153 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 179, session 2348055614455
2025-08-14 23:23:21,153 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 8, 14, 23, 23, 21, 153526), 'payment_reference': 'PAY-179', 'order_id': '179', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '112', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 2000.0, 'total_price': 2000.0}, {'item_id': '113', 'name': 'Fried Rice', 'quantity': 1, 'variations': {}, 'price': 2000.0, 'total_price': 2000.0}, {'item_id': '124', 'name': 'Egg', 'quantity': 2, 'variations': {}, 'price': 2000.0, 'total_price': 4000.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 8000.0, 'error': ''}, 'total_price': 8000.0, 'from_ai_order': True, 'order_note': "don't mix the egg and fried rice", 'total_amount': 8000.0, 'order_status': 'pending_payment', 'order_timestamp': '2025-08-14T22:22:30.734311+00:00', 'feedback_order_id': 179, 'feedback_started_at': '2025-08-14T23:23:21.153514'}
2025-08-14 23:23:21,154 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-14 23:23:21,946 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdGMDNBQzdGNzMxMEZERUFEMgA="}]}
2025-08-14 23:23:21,947 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 179, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdGMDNBQzdGNzMxMEZERUFEMgA='}]}
2025-08-14 23:23:21,947 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-14 23:23:22,135 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:22] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:22,265 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:22] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:22,337 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:22] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:22,963 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:22] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:23,132 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:23] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:23,134 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjEzMDg1MDc5ODFBN0M3OTlCOAA="}]}
2025-08-14 23:23:23,135 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 179 to 2347082345056
2025-08-14 23:23:23,136 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:23] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-14 23:23:23,383 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:23] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:23,435 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:23] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:25,025 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:25] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:31,885 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'excellent'}
2025-08-14 23:23:34,123 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:23:35,804 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:23:34.413464+00:00, interaction_count=104, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=cart_added, final_order_value=8000.0, converted_at=2025-08-14 22:22:37.912124+00:00
2025-08-14 23:23:36,455 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-14 23:23:36,455 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-14 23:23:36,467 - handlers.feedback_handler - INFO - Feedback saved to data/feedback.json
2025-08-14 23:23:36,468 - handlers.feedback_handler - INFO - Feedback saved for order 179: excellent
2025-08-14 23:23:36,468 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-14 23:23:36,468 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Thank you for your feedback!'}}
2025-08-14 23:23:37,305 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUxNzJGQ0VDRDIyRDc2NkU0RgA="}]}
2025-08-14 23:23:37,306 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUxNzJGQ0VDRDIyRDc2NkU0RgA='}]}
2025-08-14 23:23:37,307 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:37] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:38,288 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:38] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:38,591 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:38] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:38,924 - werkzeug - INFO - 127.0.0.1 - - [14/Aug/2025 23:23:38] "POST /webhook HTTP/1.1" 200 -
2025-08-14 23:23:47,604 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-179
2025-08-14 23:23:48,178 - services.payment_service - INFO - Payment verified successfully for reference PAY-179. Status: success
2025-08-14 23:23:48,179 - handlers.payment_handler - INFO - Payment verified for order 179 on attempt 2
2025-08-14 23:23:48,179 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-179
2025-08-14 23:23:48,862 - services.payment_service - INFO - Payment verified successfully for reference PAY-179. Status: success
2025-08-14 23:23:53,136 - utils.data_manager - INFO - Updated order 179 to status confirmed
2025-08-14 23:23:54,909 - utils.data_manager - INFO - Retrieved 3 items for order 179
2025-08-14 23:23:57,253 - utils.data_manager - INFO - Reduced inventory for product_id 112 by 1 for order 179
2025-08-14 23:23:57,739 - utils.data_manager - INFO - Reduced inventory for product_id 113 by 1 for order 179
2025-08-14 23:23:58,293 - utils.data_manager - INFO - Reduced inventory for product_id 124 by 2 for order 179
2025-08-14 23:24:00,364 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-14 23:24:00,559 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 179
2025-08-14 23:24:08,922 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-14 23:24:10,401 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-14 22:24:09.128709+00:00, interaction_count=105, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-14 23:24:11,022 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:12:07,896 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 01:12:10,215 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:12:14,179 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:12:14,493 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:12:16,697 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:12:16,949 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:12:16,949 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:12:18,814 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 01:12:19,025 - app - INFO - Initial product sync successful on startup
2025-08-15 01:12:19,025 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:12:19,025 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 01:12:19,025 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:12:19,026 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:12:19,040 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:12:20,889 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:12:21,115 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:12:23,523 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:12:23,722 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:12:23,723 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:12:23,723 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 01:12:23,723 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 01:12:23,723 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:12:23,724 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 01:12:23,724 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:12:23,725 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:12:23,729 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 01:12:24,328 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 01:12:24,328 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 01:12:24,329 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 01:12:24,329 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 01:12:24,329 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:12:24,374 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 01:12:24,374 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 01:12:44,834 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 01:12:44,834 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 01:12:46,940 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:12:48,589 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:12:47.187187+00:00, interaction_count=153, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:12:49,244 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:12:49,245 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 01:12:51,026 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 01:12:51,242 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 01:12:51,243 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:12:51,243 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 01:12:51,243 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': 'WhatsAppService' object has no attribute 'create_image_message'
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 180, in _route_to_handler
    return self.greeting_handler.handle_back_to_main(state, session_id, "Let's start fresh. What can I do for you?")
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 294, in handle_back_to_main
    return self._send_greeting_with_image(session_id, user_name, "guest", message)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 303, in _send_greeting_with_image
    response = self.whatsapp_service.create_image_message(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'WhatsAppService' object has no attribute 'create_image_message'. Did you mean: 'create_list_message'?
2025-08-15 01:12:51,257 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:12:52,980 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg2NzAxNzk5ODcxQTBENDAzNQA="}]}
2025-08-15 01:12:52,982 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg2NzAxNzk5ODcxQTBENDAzNQA='}]}
2025-08-15 01:12:52,983 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:12:52] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:12:54,059 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:12:54] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:12:54,268 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:12:54] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:12:54,416 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:12:54] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:15:24,001 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 01:15:25,591 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:15:28,550 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:15:28,850 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:15:31,248 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:15:31,465 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:15:31,466 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:15:33,280 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 01:15:33,496 - app - INFO - Initial product sync successful on startup
2025-08-15 01:15:33,496 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:15:33,496 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 01:15:33,497 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:15:33,497 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:15:33,505 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:15:35,621 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:15:35,852 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:15:38,298 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:15:38,539 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:15:38,540 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:15:38,540 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 01:15:38,541 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 01:15:38,541 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:15:38,542 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 01:15:38,542 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:15:38,542 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:15:38,547 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 01:15:39,029 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 01:15:39,029 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 01:15:39,030 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 01:15:39,030 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 01:15:39,030 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:15:39,053 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 01:15:39,054 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 01:15:55,617 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 01:15:55,617 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 01:15:59,974 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:16:02,107 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:16:00.216951+00:00, interaction_count=154, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:16:02,936 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:16:02,937 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 01:16:05,060 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 01:16:05,305 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 01:16:05,306 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:16:05,306 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 01:16:05,306 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:16:05,307 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:16:06,517 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE2RUUxNTNFQjM2MzVCRDkwNQA="}]}
2025-08-15 01:16:06,945 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 01:16:06,947 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:06] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:16:07,786 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:07] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:16:07,907 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:07] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:16:18,492 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 01:16:21,061 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:16:22,989 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:16:21.463056+00:00, interaction_count=155, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:16:23,602 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:16:23,603 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:16:23,604 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 01:16:23,604 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 01:16:23,605 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 01:16:23,605 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 01:16:23,606 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:16:23,606 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 01:16:24,619 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRDMzk3MTU0NzkxRUY2QjhDNAA="}]}
2025-08-15 01:16:24,620 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:16:24,621 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 01:16:25,721 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMwQzY3Q0YwNkFGMDMwMjM2NAA="}]}
2025-08-15 01:16:25,722 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMwQzY3Q0YwNkFGMDMwMjM2NAA='}]}
2025-08-15 01:16:25,724 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:25] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:16:26,495 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:26] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:16:27,029 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:27] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:16:27,031 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:27] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:16:27,170 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:27] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:16:27,465 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:27] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:16:27,503 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:16:27] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:20:06,456 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 01:20:09,994 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:20:13,254 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:20:13,589 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:20:15,737 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:20:15,941 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:20:15,942 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:20:17,809 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 01:20:18,142 - app - INFO - Initial product sync successful on startup
2025-08-15 01:20:18,143 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:20:18,143 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 01:20:18,145 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:20:18,148 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:20:18,218 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:20:20,039 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:20:20,321 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:20:22,431 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:20:22,641 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:20:22,642 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:20:22,642 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 01:20:22,643 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 01:20:22,644 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:20:22,645 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 01:20:22,646 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:20:22,647 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:20:22,660 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 01:20:23,713 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 01:20:23,714 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 01:20:23,715 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 01:20:23,715 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 01:20:23,716 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:20:23,757 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 01:20:23,758 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 01:20:36,471 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 01:20:36,472 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 01:20:38,448 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:20:40,369 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:20:38.759257+00:00, interaction_count=156, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:20:41,808 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:20:41,810 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 01:20:45,478 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 01:20:45,692 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 01:20:45,693 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:20:45,694 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 01:20:45,695 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:20:45,696 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:20:48,006 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM5QzgwRUU5RTRGNUMzREQwRgA="}]}
2025-08-15 01:20:48,317 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 01:20:48,319 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:20:48] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:20:49,204 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:20:49] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:20:49,387 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:20:49] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:20:49,649 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:20:49] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:20:53,093 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 01:20:55,545 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:20:57,608 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:20:55.816956+00:00, interaction_count=157, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:20:58,488 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:20:58,490 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:20:58,490 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 01:20:58,491 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 01:20:58,491 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 01:20:58,492 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 01:20:58,492 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:20:58,493 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 01:20:59,669 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVFNkU2Q0VEOUM2NDM3NTA3NQA="}]}
2025-08-15 01:20:59,710 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:20:59,713 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 01:21:00,778 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJCMzExNERGQjlGRjk3MzM2MwA="}]}
2025-08-15 01:21:00,780 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJCMzExNERGQjlGRjk3MzM2MwA='}]}
2025-08-15 01:21:00,782 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:21:00] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:21:01,153 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:21:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:21:01,192 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:21:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:21:01,828 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:21:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:21:01,849 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:21:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:21:02,169 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:21:02] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:21:02,343 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:21:02] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:26:55,151 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 01:26:56,952 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:26:59,957 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:27:00,168 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:27:02,315 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:27:02,647 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:27:02,648 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:27:05,264 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 01:27:05,476 - app - INFO - Initial product sync successful on startup
2025-08-15 01:27:05,477 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:27:05,477 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 01:27:05,478 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:27:05,478 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:27:05,484 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:27:07,973 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:27:08,230 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:27:10,170 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:27:10,463 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:27:10,470 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:27:10,470 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 01:27:10,470 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 01:27:10,471 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:27:10,472 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 01:27:10,472 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:27:10,472 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:27:10,478 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 01:27:10,942 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 01:27:10,942 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 01:27:10,942 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 01:27:10,943 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 01:27:10,943 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:27:10,959 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 01:27:10,960 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 01:27:13,470 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 01:27:13,470 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 01:27:16,131 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:27:17,615 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:27:16.338336+00:00, interaction_count=158, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:27:18,347 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:27:18,348 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 01:27:20,181 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 01:27:20,388 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 01:27:20,389 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:27:20,389 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 01:27:20,390 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:27:20,390 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:27:21,451 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI1NTg2RUM1NTU1OTVBRDRFMAA="}]}
2025-08-15 01:27:21,748 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 01:27:21,749 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:21] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:22,555 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:22] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:22,882 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:22] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:23,036 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:23] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:24,709 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 01:27:26,564 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:27:28,226 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:27:26.793957+00:00, interaction_count=159, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:27:28,881 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:27:28,882 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:27:28,882 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 01:27:28,883 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 01:27:28,883 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 01:27:28,883 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 01:27:28,883 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:27:28,884 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 01:27:29,862 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjMwNDFBOTc0QzYwMjk1QzI1MQA="}]}
2025-08-15 01:27:29,863 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:27:29,863 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 01:27:30,779 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNENTFFQ0IwRDRCMDg4QzgyQQA="}]}
2025-08-15 01:27:30,780 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjNENTFFQ0IwRDRCMDg4QzgyQQA='}]}
2025-08-15 01:27:30,781 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:30] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:30,952 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:30] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:31,766 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:31] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:31,916 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:31] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:31,919 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:31] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:32,022 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:32] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:32,580 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:32] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:38,122 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-15 01:27:39,879 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:27:41,399 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:27:40.090836+00:00, interaction_count=160, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:27:42,046 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:27:42,047 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:27:42,048 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-08-15 01:27:45,211 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-15 01:27:45,216 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:27:46,100 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFDNUQwQUJCQkM2RUUwRUFGNAA="}]}
2025-08-15 01:27:46,101 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFDNUQwQUJCQkM2RUUwRUFGNAA='}]}
2025-08-15 01:27:46,102 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:46] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:47,130 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:47] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:47,395 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:47] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:47,397 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:47] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:49,404 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-15 01:27:52,127 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:27:53,612 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:27:52.333536+00:00, interaction_count=161, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=8000.0, conversion_stage=order_completed, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:27:54,252 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:27:54,253 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:27:54,253 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-15 01:27:54,253 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-15 01:27:54,254 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:27:54,254 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-15 01:27:54,254 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-15 01:27:54,255 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:27:55,130 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ5QUU1QkNEMjdGNEFBNTlCRQA="}]}
2025-08-15 01:27:56,152 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:56] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:56,472 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:56] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:56,632 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:56] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:27:56,933 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:27:58,250 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-15 01:27:58,495 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:27:57.140829+00:00, interaction_count=162, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:27:59,122 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:27:59,140 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ5QUU1QkNEMjdGNEFBNTlCRQA='}]}
2025-08-15 01:27:59,140 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:27:59] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:01,231 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:28:02,802 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:28:01.489273+00:00, interaction_count=163, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:28:03,437 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:28:03,438 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:28:03,438 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-15 01:28:03,438 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:28:03,444 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:28:04,479 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2Mzc5MjJBRDREQzVGRTY1OQA="}]}
2025-08-15 01:28:05,536 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:05] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:05,729 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:05] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:05,828 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:05] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:06,148 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:28:07,224 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-15 01:28:07,846 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:28:06.463069+00:00, interaction_count=164, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:28:08,473 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:28:08,480 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY2Mzc5MjJBRDREQzVGRTY1OQA='}]}
2025-08-15 01:28:08,480 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:08] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:08,903 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:28:10,368 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:28:09.101356+00:00, interaction_count=165, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=9200.0, converted_at=2025-08-14 22:24:09.128761+00:00
2025-08-15 01:28:11,006 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:28:11,007 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:28:11,007 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:28:12,699 - utils.data_manager - DEBUG - Found product_id 112 for product_name Jollof Rice
2025-08-15 01:28:14,758 - utils.data_manager - DEBUG - Found product_id 113 for product_name Fried Rice
2025-08-15 01:28:16,827 - utils.data_manager - INFO - Saved order 182 for customer 2348055614455
2025-08-15 01:28:17,034 - utils.data_manager - INFO - Saved order item Jollof Rice for order 182
2025-08-15 01:28:17,270 - utils.data_manager - INFO - Saved order item Fried Rice for order 182
2025-08-15 01:28:17,490 - handlers.order_handler - INFO - Order 182 saved to database for session 2348055614455
2025-08-15 01:28:19,993 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-15 01:28:21,715 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:28:23,397 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:28:21.981205+00:00, interaction_count=166, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:28:24,019 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:28:24,025 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-15 01:28:24,025 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-15 01:28:24,026 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-15 01:28:27,919 - utils.data_manager - INFO - Updated order 182 to status pending_payment
2025-08-15 01:28:27,920 - services.payment_service - INFO - Adding subaccount split: code=ACCT_iwv6csej0ra4k7g, percentage=1%
2025-08-15 01:28:27,921 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-182 with amount: 510000, email: ziga4455@lola.com
2025-08-15 01:28:28,653 - services.payment_service - ERROR - HTTP error creating Paystack payment link for PAY-182: 404 Client Error: Not Found for url: https://api.paystack.co/transaction/initialize. Response: {"status":false,"message":"Invalid Subaccount.","meta":{"nextStep":"Ensure that the value(s) you're passing are valid."},"type":"validation_error","code":"invalid_params"}
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\services\payment_service.py", line 87, in create_payment_link
    response.raise_for_status()  # Raise HTTPError for bad responses (4xx or 5xx)
    ~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "C:\Users\zigam\AppData\Local\Programs\Python\Python313\Lib\site-packages\requests\models.py", line 1024, in raise_for_status
    raise HTTPError(http_error_msg, response=self)
requests.exceptions.HTTPError: 404 Client Error: Not Found for url: https://api.paystack.co/transaction/initialize
2025-08-15 01:28:28,656 - handlers.payment_handler - ERROR - Failed to generate payment link for order 182
2025-08-15 01:28:28,657 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:28:29,610 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4QkNFQjlBQUQ5M0VBRTZCNQA="}]}
2025-08-15 01:28:30,607 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:30] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:30,792 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:30] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:31,039 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:31] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:31,446 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:28:32,477 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-15 01:28:33,048 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:28:31.661292+00:00, interaction_count=167, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:28:33,724 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:28:33,730 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU4QkNFQjlBQUQ5M0VBRTZCNQA='}]}
2025-08-15 01:28:33,731 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:33] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:34,274 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:28:35,832 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:28:34.483370+00:00, interaction_count=168, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:28:36,494 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:28:36,495 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:28:36,495 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:28:36,495 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please select 'Checkout', 'Order More', 'Add Note', 'Other Options', or type 'remove', 'cancel', or 'note'."}}
2025-08-15 01:28:37,724 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFEMzFFMzA4QUFEOEI4MUY4NwA="}]}
2025-08-15 01:28:38,789 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:38] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:38,930 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:38] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:39,072 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:39] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:28:39,459 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:28:41,093 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:28:39.661463+00:00, interaction_count=169, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:28:41,708 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:28:41,714 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFEMzFFMzA4QUFEOEI4MUY4NwA='}]}
2025-08-15 01:28:41,715 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:28:41] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:29:43,925 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 01:29:45,769 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:29:47,487 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:29:47,699 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:29:49,683 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:29:49,886 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:29:49,886 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:29:52,605 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 01:29:52,807 - app - INFO - Initial product sync successful on startup
2025-08-15 01:29:52,808 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:29:52,808 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 01:29:52,808 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:29:52,809 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:29:52,826 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 01:29:56,816 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 01:29:57,037 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 01:29:59,000 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 01:29:59,220 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 01:29:59,221 - services.payment_service - INFO - PaymentService initialized
2025-08-15 01:29:59,221 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 01:29:59,222 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 01:29:59,222 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 01:29:59,223 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 01:29:59,223 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 01:29:59,224 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:29:59,229 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 01:29:59,875 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 01:29:59,876 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 01:29:59,876 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 01:29:59,877 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 01:29:59,877 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 01:29:59,900 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 01:29:59,901 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 01:43:47,482 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Checkout'}
2025-08-15 01:43:47,482 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 01:43:53,314 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:43:54,786 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:43:53.515531+00:00, interaction_count=170, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:43:55,497 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:43:55,499 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 01:43:57,846 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 01:43:58,055 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:43:58,055 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-15 01:43:58,056 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:43:58,056 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:43:59,201 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ1OTYxQUNFRkY3NjJERjgzQQA="}]}
2025-08-15 01:43:59,470 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 01:43:59,471 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:43:59] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:44:00,349 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:44:00] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:44:00,448 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:44:00] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:44:02,517 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 01:44:04,388 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:44:06,452 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:44:04.588406+00:00, interaction_count=171, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:44:07,818 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:44:07,819 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:44:07,819 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 01:44:07,820 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 01:44:07,820 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 01:44:07,821 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 01:44:07,821 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:44:07,822 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 01:44:08,784 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVFNzZEMTEyNjFCNEMxMUE5QgA="}]}
2025-08-15 01:44:08,785 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:44:08,785 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 01:44:09,845 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCNzY3NkRDQTkzNjc2QTZCOAA="}]}
2025-08-15 01:44:09,851 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFCNzY3NkRDQTkzNjc2QTZCOAA='}]}
2025-08-15 01:44:09,852 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:44:09] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:44:10,886 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:44:10] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:44:11,128 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:44:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:44:11,152 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:44:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:44:11,208 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:44:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:44:11,646 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:44:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:44:11,649 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:44:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:46:10,749 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-15 01:46:12,535 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:46:14,218 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:46:12.738580+00:00, interaction_count=172, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:46:14,850 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:46:14,851 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:46:14,851 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-08-15 01:46:18,945 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-15 01:46:18,949 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:46:19,821 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDMURCMTk2N0RGQjI4M0Q4MwA="}]}
2025-08-15 01:46:19,822 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNDMURCMTk2N0RGQjI4M0Q4MwA='}]}
2025-08-15 01:46:19,823 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:46:19] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:46:20,978 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:46:20] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:46:21,157 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:46:21] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:46:21,161 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:46:21] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:46:45,595 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-15 01:46:49,084 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:46:50,618 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:46:49.350464+00:00, interaction_count=173, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:46:51,511 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:46:51,512 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:46:51,513 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-15 01:46:51,513 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-15 01:46:51,514 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:46:51,514 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-15 01:46:51,514 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-15 01:46:51,515 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:46:52,641 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg2MDA4MTgzRTg0QTRENkYwNgA="}]}
2025-08-15 01:46:53,795 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:46:53] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:46:53,923 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:46:53] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:46:53,992 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:46:53] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:46:54,647 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:46:56,178 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:46:54.859107+00:00, interaction_count=174, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:46:56,847 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:46:56,852 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg2MDA4MTgzRTg0QTRENkYwNgA='}]}
2025-08-15 01:46:56,853 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:46:56] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:46:58,930 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-15 01:47:00,659 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:47:02,817 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:47:00.868164+00:00, interaction_count=175, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:47:04,831 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:47:04,832 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:47:04,832 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-15 01:47:04,832 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:47:04,839 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:47:05,854 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk5QjZGQkRGQjU4ODc1RjY1RAA="}]}
2025-08-15 01:47:06,967 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:47:06] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:47:07,062 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:47:07] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:47:07,064 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:47:07] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:47:07,538 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:47:09,029 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:47:07.761763+00:00, interaction_count=176, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:47:09,533 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-15 01:47:09,700 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:47:09,707 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjk5QjZGQkRGQjU4ODc1RjY1RAA='}]}
2025-08-15 01:47:09,709 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:47:09] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:47:12,462 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:47:14,076 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:47:12.660839+00:00, interaction_count=177, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:47:14,698 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:47:14,699 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:47:14,700 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'order_handler', state 'confirm_order', message 'update_address'. Resetting to greeting.
2025-08-15 01:47:14,700 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:47:14,700 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-15 01:47:14,701 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:47:14,701 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:47:15,545 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNCRTY2QURBMTQxNjk1NDY5NwA="}]}
2025-08-15 01:47:16,747 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:47:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:47:16,817 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:47:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:47:16,887 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:47:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:47:17,241 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:47:19,063 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:47:17.453006+00:00, interaction_count=178, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:47:19,717 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:47:20,237 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 01:47:20,238 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:47:20] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:55:47,821 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 01:55:50,349 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:55:51,852 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:55:50.563645+00:00, interaction_count=179, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:55:52,482 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:55:52,483 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:55:52,484 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 01:55:52,485 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 01:55:52,485 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 01:55:52,486 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 01:55:52,486 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:55:52,488 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 01:55:53,480 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRDMkM2NzM2QkFDNTRGRjMzOAA="}]}
2025-08-15 01:55:53,481 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:55:53,482 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 01:55:54,429 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI4NkZEM0JCMTdEOTk0NERGNwA="}]}
2025-08-15 01:55:55,127 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:55:55] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:55:55,872 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:55:55] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:55:55,972 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:55:55] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:55:56,088 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:55:56] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:55:56,190 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:55:56,269 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:55:56] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:55:56,296 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:55:56] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:55:57,732 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:55:56.389467+00:00, interaction_count=180, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:55:58,383 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:55:58,399 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI4NkZEM0JCMTdEOTk0NERGNwA='}]}
2025-08-15 01:55:58,401 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:55:58] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:25,970 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-15 01:56:27,683 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:56:29,184 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:56:27.883745+00:00, interaction_count=181, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:56:29,804 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:56:29,806 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:56:29,806 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-08-15 01:56:32,327 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-15 01:56:32,330 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:56:33,173 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUzOTJENzgxMDY2MzJDRUFFRQA="}]}
2025-08-15 01:56:34,270 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:34] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:34,474 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:34] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:34,583 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:34] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:34,898 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:56:36,403 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:56:35.102742+00:00, interaction_count=182, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:56:36,489 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-15 01:56:37,046 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:56:37,058 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUzOTJENzgxMDY2MzJDRUFFRQA='}]}
2025-08-15 01:56:37,060 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:37] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:38,211 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:56:40,224 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:56:38.414365+00:00, interaction_count=183, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:56:40,954 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:56:40,955 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:56:40,956 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-15 01:56:40,956 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-15 01:56:40,957 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:56:40,958 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-15 01:56:40,958 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-15 01:56:40,959 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:56:41,800 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVEOEI3RkE1MDY3QjZGM0QwNQA="}]}
2025-08-15 01:56:42,885 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:42] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:43,060 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:43] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:43,137 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:43] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:43,534 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:56:45,192 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-15 01:56:46,777 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:56:43.746606+00:00, interaction_count=184, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:56:46,912 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:56:47,418 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:56:47,430 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVEOEI3RkE1MDY3QjZGM0QwNQA='}]}
2025-08-15 01:56:47,432 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:47] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:48,919 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:56:47.125971+00:00, interaction_count=184, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:56:49,601 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:56:49,602 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:56:49,602 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-15 01:56:49,603 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:56:49,615 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:56:50,498 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCMEE5N0Q0Q0E4MDNDREQ4RAA="}]}
2025-08-15 01:56:51,556 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:51] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:51,763 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:51] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:51,855 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:51] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:56:53,247 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:56:54,768 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:56:53.456396+00:00, interaction_count=185, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:56:55,406 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:56:55,415 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCMEE5N0Q0Q0E4MDNDREQ4RAA='}]}
2025-08-15 01:56:55,417 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:56:55] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:00,627 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'cancel_order'}
2025-08-15 01:57:02,436 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:57:04,128 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:57:02.646867+00:00, interaction_count=186, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:57:04,776 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:57:04,777 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:57:04,778 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'order_handler', state 'confirm_order', message 'cancel_order'. Resetting to greeting.
2025-08-15 01:57:04,778 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:57:04,779 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-15 01:57:04,780 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:57:04,780 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:57:05,632 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQyRDQ2MkVEOUMxQTI1QjdDQgA="}]}
2025-08-15 01:57:06,792 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:06] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:06,939 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:06] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:06,966 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:06] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:07,379 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:57:08,855 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:57:07.585156+00:00, interaction_count=187, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:57:09,467 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:57:09,742 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 01:57:09,744 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:09] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:12,452 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 01:57:14,177 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:57:15,630 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:57:14.382483+00:00, interaction_count=188, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:57:16,294 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:57:16,295 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:57:16,296 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 01:57:16,296 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 01:57:16,297 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 01:57:16,298 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 01:57:16,298 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 01:57:16,299 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 01:57:17,254 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE0NDdEMzc3ODc1RUE0ODc3QwA="}]}
2025-08-15 01:57:17,255 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:57:17,256 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 01:57:18,795 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:18] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:19,032 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:19] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:19,035 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:19] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:19,083 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGMkEwMUU0MjQ1NzBDQUQ5OAA="}]}
2025-08-15 01:57:20,284 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:20] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:20,335 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:20] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:20,416 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:20] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:21,410 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:57:24,266 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:57:22.013373+00:00, interaction_count=189, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:57:24,902 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:57:24,924 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGMkEwMUU0MjQ1NzBDQUQ5OAA='}]}
2025-08-15 01:57:24,926 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:24] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:25,815 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-15 01:57:28,547 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:57:30,495 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:57:28.769741+00:00, interaction_count=190, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:57:31,114 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:57:31,115 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:57:31,116 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-08-15 01:57:33,330 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-15 01:57:33,332 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:57:34,211 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJBMTYyRTg4NTNENzU1Q0E2NQA="}]}
2025-08-15 01:57:35,291 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:35] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:35,588 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:35] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:35,594 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:35] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:36,038 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:57:38,126 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:57:36.246127+00:00, interaction_count=191, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:57:38,544 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-15 01:57:40,004 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:57:40,013 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJBMTYyRTg4NTNENzU1Q0E2NQA='}]}
2025-08-15 01:57:40,015 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:40] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:41,037 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:57:43,386 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:57:41.237881+00:00, interaction_count=192, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:57:44,015 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:57:44,016 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:57:44,017 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-15 01:57:44,018 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-15 01:57:44,018 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:57:44,019 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-15 01:57:44,019 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-15 01:57:44,020 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:57:44,893 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE1MUQ2MjhERTU3QkYwQkRGOAA="}]}
2025-08-15 01:57:45,958 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:45] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:46,133 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:46] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:46,273 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:46] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:46,618 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:57:48,204 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:57:46.825873+00:00, interaction_count=193, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:57:48,942 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:57:48,953 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE1MUQ2MjhERTU3QkYwQkRGOAA='}]}
2025-08-15 01:57:48,957 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:57:48] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:57:51,396 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'add_note'}
2025-08-15 01:57:53,848 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:57:57,785 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:57:54.090725+00:00, interaction_count=194, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:57:58,420 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:57:58,421 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:57:58,421 - handlers.order_handler - INFO - User chose to add a note after confirmation for session 2348055614455.
2025-08-15 01:57:58,422 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:57:58,422 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please type your note for the order (e.g., 'Please deliver after 5 PM'). Type 'back' to skip adding a note."}}
2025-08-15 01:57:59,320 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYwN0Q1MjJENUFCQkYyNDFCNQA="}]}
2025-08-15 01:58:00,389 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:58:00] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:58:00,621 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:58:00] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:58:01,102 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:58:02,617 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:58:01.318474+00:00, interaction_count=195, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:58:03,260 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:58:03,270 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYwN0Q1MjJENUFCQkYyNDFCNQA='}]}
2025-08-15 01:58:03,272 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:58:03] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:58:03,484 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:58:03] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:58:13,479 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Make sure the rice is not soggy'}
2025-08-15 01:58:15,207 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:58:16,715 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:58:15.411182+00:00, interaction_count=196, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:58:17,338 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:58:17,340 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:58:17,340 - handlers.order_handler - INFO - Note 'make sure the rice is not soggy' added for session 2348055614455.
2025-08-15 01:58:17,341 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:58:17,351 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:58:18,261 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBDMjgyOUYwQjMwNjk3Mjg0MwA="}]}
2025-08-15 01:58:19,353 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:58:19] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:58:19,790 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:58:19] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:58:19,929 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:58:19] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:58:20,004 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:58:21,607 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:58:20.287851+00:00, interaction_count=197, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:58:22,261 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:58:22,272 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBDMjgyOUYwQjMwNjk3Mjg0MwA='}]}
2025-08-15 01:58:22,274 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:58:22] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:58:29,613 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-15 01:58:31,388 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:58:34,613 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:58:31.593109+00:00, interaction_count=198, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:28:21.981213+00:00
2025-08-15 01:58:35,969 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:58:35,970 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:58:35,971 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 01:58:37,686 - utils.data_manager - DEBUG - Found product_id 112 for product_name Jollof Rice
2025-08-15 01:58:40,799 - utils.data_manager - DEBUG - Found product_id 113 for product_name Fried Rice
2025-08-15 01:58:43,776 - utils.data_manager - INFO - Saved order 183 for customer 2348055614455
2025-08-15 01:58:44,869 - utils.data_manager - INFO - Saved order item Jollof Rice for order 183
2025-08-15 01:58:45,069 - utils.data_manager - INFO - Saved order item Fried Rice for order 183
2025-08-15 01:58:45,295 - handlers.order_handler - INFO - Order 183 saved to database for session 2348055614455
2025-08-15 01:58:47,195 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-15 01:58:48,915 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:58:50,478 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:58:49.116762+00:00, interaction_count=199, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=4000.0, converted_at=2025-08-15 00:58:49.116779+00:00
2025-08-15 01:58:51,126 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:58:51,138 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-15 01:58:51,138 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-15 01:58:51,140 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-15 01:58:54,762 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-15 01:58:55,101 - utils.data_manager - INFO - Updated order 183 to status pending_payment
2025-08-15 01:58:55,102 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-15 01:58:55,103 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-183 with amount: 510000, email: ziga4455@lola.com
2025-08-15 01:58:55,862 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/lado3l0nqbukjtt
2025-08-15 01:58:55,863 - handlers.payment_handler - INFO - Starting payment monitoring for order 183, reference PAY-183
2025-08-15 01:58:55,864 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-183
2025-08-15 01:58:56,460 - services.payment_service - WARNING - Payment not successful for reference PAY-183. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5239308932, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-183', 'receipt_number': None, 'amount': 510000, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-15T00:58:55.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.89.84.23, 172.68.229.169, 172.31.63.81', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': '183', 'delivery_address': 'lagos', 'delivery_fee': '1000', 'service_charge': '100', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 17650, 'integration': '5100', 'subaccount': 487250, 'params': {'bearer': 'subaccount', 'transaction_charge': '5100', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-15T00:58:55.000Z', 'requested_amount': 510000, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-15T00:58:55.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-15 01:58:56,462 - handlers.payment_handler - INFO - Payment not yet verified for order 183, attempt 1/15
2025-08-15 01:58:56,463 - handlers.payment_handler - INFO - Payment link created successfully for order 183 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-15 01:58:56,552 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:58:58,078 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:58:56.763363+00:00, interaction_count=200, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=4000.0, converted_at=2025-08-15 00:58:49.116779+00:00
2025-08-15 01:58:58,203 - utils.data_manager - INFO - Retrieved 2 items for order 183
2025-08-15 01:58:58,406 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:58:58,772 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:58:58,774 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 01:58:59,320 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjExMDQ1RDAwNDE1QjY5RUFDOAA="}]}
2025-08-15 01:59:00,383 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:00] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:00,619 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:00] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:00,645 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:00] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:01,099 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:59:01,249 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 183.
2025-08-15 01:59:02,625 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:59:01.297465+00:00, interaction_count=201, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:58:49.116779+00:00
2025-08-15 01:59:02,993 - utils.data_manager - INFO - Retrieved 2 items for order 183
2025-08-15 01:59:03,196 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:59:03,268 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:59:03,278 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjExMDQ1RDAwNDE1QjY5RUFDOAA='}]}
2025-08-15 01:59:03,279 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:03] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:04,087 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNBQ0YyRTA2RjE3QTI4MDM3NQA="}]}
2025-08-15 01:59:05,369 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:05] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:05,514 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:05] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:05,519 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:05] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:05,847 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 01:59:06,886 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-183
2025-08-15 01:59:07,454 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 00:59:06.089150+00:00, interaction_count=202, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-15 00:58:49.116779+00:00
2025-08-15 01:59:08,088 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 01:59:08,107 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkNBQ0YyRTA2RjE3QTI4MDM3NQA='}]}
2025-08-15 01:59:08,108 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:08] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:12,158 - utils.data_manager - INFO - Updated order 183 to status confirmed
2025-08-15 01:59:13,089 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:13] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:14,481 - utils.data_manager - INFO - Retrieved 2 items for order 183
2025-08-15 01:59:18,431 - utils.data_manager - INFO - Reduced inventory for product_id 112 by 1 for order 183
2025-08-15 01:59:19,592 - utils.data_manager - INFO - Reduced inventory for product_id 113 by 1 for order 183
2025-08-15 01:59:22,094 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 01:59:22,293 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 183
2025-08-15 01:59:27,142 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-15 01:59:27,144 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-15 01:59:29,090 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 01:59:30,620 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZFNzBBMzNGNEE4MDE4RjY3QQA="}]}
2025-08-15 01:59:30,622 - handlers.payment_handler - INFO - Sent payment success text message for order 183 to customer 2348055614455
2025-08-15 01:59:30,624 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 183, session 2348055614455
2025-08-15 01:59:30,625 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'selected_category': None, 'selected_item': None, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 8, 15, 1, 59, 30, 625007), 'payment_reference': 'PAY-183', 'order_id': '183', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'delivery_address': 'lagos', 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '112', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 2000.0, 'total_price': 2000.0}, {'item_id': '113', 'name': 'Fried Rice', 'quantity': 1, 'variations': {}, 'price': 2000.0, 'total_price': 2000.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 4000.0, 'error': ''}, 'total_price': 4000.0, 'from_ai_order': True, 'order_note': 'make sure the rice is not soggy', 'total_amount': 4000.0, 'order_status': 'pending_payment', 'order_timestamp': '2025-08-15T00:58:41.030132+00:00', 'feedback_order_id': 183, 'feedback_started_at': '2025-08-15T01:59:30.624978'}
2025-08-15 01:59:30,626 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 01:59:31,533 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxQzEyRjdBRTc1NDRFQkEyNQA="}]}
2025-08-15 01:59:31,534 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 183, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjYxQzEyRjdBRTc1NDRFQkEyNQA='}]}
2025-08-15 01:59:31,535 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-15 01:59:31,676 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:31] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:32,035 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:32] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:32,042 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:32] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:32,581 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:32] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:32,777 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkUwNDU1NjMzMjkzQjZGREI0QQA="}]}
2025-08-15 01:59:32,779 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 183 to 2347082345056
2025-08-15 01:59:32,781 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:32] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-15 01:59:32,910 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:32] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:32,951 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:32] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:34,442 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 01:59:34] "POST /webhook HTTP/1.1" 200 -
2025-08-15 01:59:56,469 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-183
2025-08-15 01:59:57,228 - services.payment_service - INFO - Payment verified successfully for reference PAY-183. Status: success
2025-08-15 01:59:57,228 - handlers.payment_handler - INFO - Payment verified for order 183 on attempt 2
2025-08-15 01:59:57,229 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-183
2025-08-15 01:59:58,193 - services.payment_service - INFO - Payment verified successfully for reference PAY-183. Status: success
2025-08-15 02:00:02,093 - utils.data_manager - INFO - Updated order 183 to status confirmed
2025-08-15 02:00:03,781 - utils.data_manager - INFO - Retrieved 2 items for order 183
2025-08-15 02:00:05,889 - utils.data_manager - INFO - Reduced inventory for product_id 112 by 1 for order 183
2025-08-15 02:00:06,300 - utils.data_manager - INFO - Reduced inventory for product_id 113 by 1 for order 183
2025-08-15 02:00:08,256 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 02:00:08,453 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 183
2025-08-15 02:00:14,072 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:00:15,576 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:00:14.274985+00:00, interaction_count=203, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:00:16,197 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:34:37,992 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 02:34:41,038 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:34:49,940 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:34:50,177 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:34:52,104 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:34:52,322 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:34:52,323 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:34:54,097 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 02:34:54,294 - app - INFO - Initial product sync successful on startup
2025-08-15 02:34:54,294 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:34:54,294 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 02:34:54,294 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:34:54,295 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:34:54,305 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:34:55,945 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:34:56,158 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:34:58,164 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:34:58,458 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:34:58,458 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:34:58,459 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 02:34:58,459 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 02:34:58,459 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:34:58,460 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 02:34:58,460 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:34:58,461 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:34:58,466 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 02:34:59,014 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 02:34:59,014 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 02:34:59,015 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 02:34:59,015 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 02:34:59,016 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:34:59,047 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 02:34:59,047 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 02:36:15,514 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 02:36:15,514 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 02:36:17,490 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:36:18,959 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:36:17.702174+00:00, interaction_count=204, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:36:19,614 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:36:19,614 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 02:36:23,217 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 02:36:23,435 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 02:36:23,436 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:36:23,436 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 02:36:23,436 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:36:23,437 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:36:23,818 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:36:23,830 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': 'NoneType' object is not iterable
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 180, in _route_to_handler
    return self.greeting_handler.handle_back_to_main(state, session_id, "Let's start fresh. What can I do for you?")
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 294, in handle_back_to_main
    return self._send_greeting_with_image(session_id, user_name, "guest", message)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 312, in _send_greeting_with_image
    response.update(self.send_main_menu(session_id, user_name, "How can I help you today?"))
    ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: 'NoneType' object is not iterable
2025-08-15 02:36:23,832 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 02:36:24,187 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:36:24,189 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:36:24] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:36:37,748 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:36:37] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:16,050 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 02:38:17,582 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:38:19,287 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:38:19,496 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:38:21,367 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:38:21,623 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:38:21,624 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:38:24,815 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 02:38:25,017 - app - INFO - Initial product sync successful on startup
2025-08-15 02:38:25,017 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:38:25,018 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 02:38:25,018 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:38:25,019 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:38:25,026 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:38:26,727 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:38:26,927 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:38:29,718 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:38:29,958 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:38:29,958 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:38:29,959 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 02:38:29,960 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 02:38:29,961 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:38:29,962 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 02:38:29,962 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:38:29,963 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:38:29,968 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 02:38:30,458 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 02:38:30,459 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 02:38:30,459 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 02:38:30,459 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 02:38:30,460 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:38:30,485 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 02:38:30,486 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 02:38:31,076 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 02:38:31,077 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 02:38:32,904 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:38:34,642 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:38:33.115380+00:00, interaction_count=205, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:38:35,263 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:38:35,264 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 02:38:37,029 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 02:38:37,239 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 02:38:37,240 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:38:37,240 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 02:38:37,240 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:38:37,241 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:38:38,809 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU5MUM0QTg4M0M4QkU5QUE5MwA="}]}
2025-08-15 02:38:39,066 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:38:39,068 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:39] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:39,836 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:39] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:40,049 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:40] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:45,908 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 02:38:47,612 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:38:49,151 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:38:47.810116+00:00, interaction_count=206, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:38:49,779 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:38:49,780 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:38:49,780 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 02:38:49,780 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 02:38:49,781 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 02:38:49,781 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 02:38:49,781 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:38:49,782 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 02:38:52,587 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUwNzRBNDBDRDJBMURBODUzNwA="}]}
2025-08-15 02:38:52,588 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 02:38:52,589 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 02:38:54,495 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:54] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:54,552 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:54] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:54,922 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:54] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:55,806 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwMDczQTFBQjQ5MTZBNEExNgA="}]}
2025-08-15 02:38:55,807 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgwMDczQTFBQjQ5MTZBNEExNgA='}]}
2025-08-15 02:38:55,808 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:55] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:56,826 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:56] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:57,085 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:57] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:38:57,191 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:38:57] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:01,938 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-15 02:39:03,653 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:39:05,127 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:39:03.857561+00:00, interaction_count=207, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:39:05,758 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:39:05,759 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:39:05,760 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-15 02:39:08,365 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-15 02:39:08,372 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:39:09,441 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBOERDMTMzOUY5NEZEQTM4NQA="}]}
2025-08-15 02:39:09,442 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBOERDMTMzOUY5NEZEQTM4NQA='}]}
2025-08-15 02:39:09,443 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:09] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:10,506 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:10] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:10,922 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:10] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:12,731 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-15 02:39:14,479 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:39:16,096 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:39:14.685020+00:00, interaction_count=208, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:39:16,726 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:39:16,727 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:39:16,728 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-15 02:39:16,728 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-15 02:39:16,728 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:39:16,729 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-15 02:39:16,729 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-15 02:39:16,729 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:39:17,757 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ5QzZBNTQ4NEY0NzMyOUM1OQA="}]}
2025-08-15 02:39:18,921 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:18] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:19,063 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:19] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:19,065 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:19] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:19,784 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:39:21,403 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-15 02:39:22,803 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:39:20.008892+00:00, interaction_count=209, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:39:23,051 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:39:24,724 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:39:24,734 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ5QzZBNTQ4NEY0NzMyOUM1OQA='}]}
2025-08-15 02:39:24,735 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:24] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:24,848 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:39:23.322950+00:00, interaction_count=209, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=order_completed, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:39:25,472 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:39:25,472 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:39:25,473 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-15 02:39:25,473 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:39:25,477 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:39:26,352 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlFNEREQTQ5OEVBNjZGNzQyNAA="}]}
2025-08-15 02:39:27,521 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:27] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:27,671 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:27] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:27,902 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:27] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:28,151 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:39:29,472 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-15 02:39:29,642 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:39:28.372357+00:00, interaction_count=210, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:39:30,466 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:39:30,473 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlFNEREQTQ5OEVBNjZGNzQyNAA='}]}
2025-08-15 02:39:30,473 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:30] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:31,335 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:39:33,040 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:39:31.540253+00:00, interaction_count=211, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:39:33,749 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:39:33,750 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:39:33,750 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-08-15 02:39:33,750 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'initiate_address_collection'.
2025-08-15 02:39:33,751 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 02:39:33,751 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Please choose a valid option from the menu.'}}
2025-08-15 02:39:34,619 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQxOTNBRjlDQUQ3NjQ0ODQ2NwA="}]}
2025-08-15 02:39:34,619 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:39:35,025 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:39:35,026 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'location_handler', state 'address_collection_menu', message 'initiate_address_collection'. Resetting to greeting.
2025-08-15 02:39:35,026 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:39:35,027 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-15 02:39:35,027 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:39:35,027 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:39:35,876 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:35] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:35,884 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFBOURBODFDODIyMENENzBBQgA="}]}
2025-08-15 02:39:36,012 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:36] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:36,988 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:36] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:37,222 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:37] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:37,224 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:37] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:39:37,617 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:39:39,945 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:39:37.842107+00:00, interaction_count=212, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:39:40,589 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:39:40,953 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:39:40,954 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:39:40] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:41:38,757 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 02:41:41,548 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:41:42,999 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:41:41.750380+00:00, interaction_count=213, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:41:43,617 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:41:43,618 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:41:43,619 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 02:41:43,619 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:41:43,619 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 02:41:43,620 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:41:43,620 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:41:46,163 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVBMkZENkY2MDczMEMyNzY3QQA="}]}
2025-08-15 02:41:46,407 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:41:46,408 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:41:46] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:41:49,777 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 02:41:51,592 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:41:53,416 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:41:53,632 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:41:55,546 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:41:55,756 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:41:55,756 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:41:57,565 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 02:41:57,765 - app - INFO - Initial product sync successful on startup
2025-08-15 02:41:57,766 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:41:57,766 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 02:41:57,767 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:41:57,767 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:41:57,774 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:41:59,413 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:41:59,617 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:42:01,587 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:42:01,792 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:42:01,793 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:42:01,793 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 02:42:01,794 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 02:42:01,794 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:42:01,795 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 02:42:01,796 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:42:01,796 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:42:01,802 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 02:42:02,327 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 02:42:02,327 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 02:42:02,328 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 02:42:02,328 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 02:42:02,328 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:42:02,353 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 02:42:02,353 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 02:42:03,700 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 02:42:03,701 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 02:42:05,375 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:42:06,871 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:42:05.575821+00:00, interaction_count=214, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:42:07,498 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:42:07,499 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 02:42:09,221 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 02:42:09,453 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:42:09,453 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-15 02:42:09,454 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:42:09,454 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:42:10,753 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI0ODU4OTNDQjU5RjA4OEY2QgA="}]}
2025-08-15 02:42:11,027 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:42:11,028 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:12,223 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:12] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:12,272 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:12] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:13,678 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 02:42:14,735 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:14] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:16,320 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:16,873 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:18,593 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:42:20,983 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:42:18.809245+00:00, interaction_count=215, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:42:22,269 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:42:22,270 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:42:22,270 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 02:42:22,270 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 02:42:22,271 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 02:42:22,271 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 02:42:22,271 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:42:22,272 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 02:42:23,166 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg3MTE0QkJGRTM2MUE4RDI0QgA="}]}
2025-08-15 02:42:23,168 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 02:42:23,168 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 02:42:24,041 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU2MjI5Qzg3OTM2NTY4RkRBQQA="}]}
2025-08-15 02:42:24,042 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU2MjI5Qzg3OTM2NTY4RkRBQQA='}]}
2025-08-15 02:42:24,043 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:24] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:24,376 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:24] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:25,134 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:25] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:25,137 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:25] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:25,293 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:25] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:25,611 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:25] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:25,742 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:25] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:33,085 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-15 02:42:35,011 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:42:36,522 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:42:35.218780+00:00, interaction_count=216, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:42:37,150 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:42:37,152 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:42:37,153 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-08-15 02:42:41,159 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-15 02:42:41,172 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:42:42,293 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFEMEY1NzQyQjEwMDMxN0Y1MQA="}]}
2025-08-15 02:42:42,294 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFEMEY1NzQyQjEwMDMxN0Y1MQA='}]}
2025-08-15 02:42:42,296 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:42] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:43,359 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:43] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:43,657 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:43] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:45,179 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-15 02:42:47,831 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:42:49,356 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:42:48.047416+00:00, interaction_count=217, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:42:50,009 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:42:50,010 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:42:50,010 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-15 02:42:50,011 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-15 02:42:50,011 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:42:50,011 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-15 02:42:50,012 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-15 02:42:50,012 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:42:50,983 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUwMUJEMTZGQzZEMDI5Qjg1QQA="}]}
2025-08-15 02:42:52,200 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:52] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:52,371 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:52] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:52,426 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:52] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:53,210 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:42:53,926 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-15 02:42:54,688 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:42:53.418028+00:00, interaction_count=218, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:42:55,308 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:42:55,314 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjUwMUJEMTZGQzZEMDI5Qjg1QQA='}]}
2025-08-15 02:42:55,314 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:42:55] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:42:55,728 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:42:57,198 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:42:55.929986+00:00, interaction_count=219, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:42:57,835 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:42:57,836 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:42:57,836 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-15 02:42:57,836 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:42:57,841 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:43:00,126 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdFOTFENzgzMzUzNTgxQjQ3NgA="}]}
2025-08-15 02:43:01,239 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:43:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:43:01,383 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:43:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:43:01,404 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:43:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:43:01,884 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:43:03,190 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-15 02:43:04,448 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:43:02.095974+00:00, interaction_count=220, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:43:04,867 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:43:05,341 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:43:05,346 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdFOTFENzgzMzUzNTgxQjQ3NgA='}]}
2025-08-15 02:43:05,347 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:43:05] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:43:06,375 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:43:05.064632+00:00, interaction_count=220, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:43:07,032 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:43:07,033 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:43:07,033 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-08-15 02:43:07,033 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'initiate_address_collection'.
2025-08-15 02:43:07,034 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 02:43:07,034 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Please choose a valid option from the menu.'}}
2025-08-15 02:43:07,872 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRCRjIzMEE4QjdGQTNBM0NBOQA="}]}
2025-08-15 02:43:08,869 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:43:08] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:43:09,109 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:43:09] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:43:10,929 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:43:12,365 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:43:11.126030+00:00, interaction_count=221, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:43:13,023 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:43:13,029 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRCRjIzMEE4QjdGQTNBM0NBOQA='}]}
2025-08-15 02:43:13,029 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:43:13] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:45:50,018 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 02:45:51,953 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:45:53,666 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:45:53,877 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:45:55,776 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:45:55,983 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:45:55,984 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:45:57,730 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 02:45:57,936 - app - INFO - Initial product sync successful on startup
2025-08-15 02:45:57,937 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:45:57,937 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 02:45:57,938 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:45:57,938 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:45:57,945 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:45:59,601 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:45:59,807 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:46:01,784 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:46:01,981 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:46:01,982 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:46:01,982 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 02:46:01,983 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 02:46:01,983 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:46:01,984 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 02:46:01,984 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:46:01,984 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:46:01,989 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 02:46:02,448 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 02:46:02,448 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 02:46:02,448 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 02:46:02,449 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 02:46:02,449 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:46:02,469 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 02:46:02,469 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 02:46:05,401 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 02:46:05,402 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 02:46:08,346 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:46:10,343 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:46:09.064348+00:00, interaction_count=222, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:46:11,012 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:46:11,013 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 02:46:12,822 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 02:46:13,025 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 02:46:13,025 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:46:13,026 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 02:46:13,026 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:46:13,027 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:46:15,040 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAwM0IwQ0M2MTk0Njg4NTkzRgA="}]}
2025-08-15 02:46:15,358 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:46:15,359 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:15] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:15,979 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:15] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:16,238 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:16,295 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:22,542 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 02:46:24,350 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:46:26,136 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:46:24.552021+00:00, interaction_count=223, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:46:26,752 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:46:26,753 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:46:26,753 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 02:46:26,753 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 02:46:26,754 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 02:46:26,754 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 02:46:26,755 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:46:26,755 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 02:46:27,685 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdENzU3NkU1MTY2Q0NCQTgzQwA="}]}
2025-08-15 02:46:27,686 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 02:46:27,686 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 02:46:28,528 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5RUU0OTFFMEMyNjBERkIxMwA="}]}
2025-08-15 02:46:28,529 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5RUU0OTFFMEMyNjBERkIxMwA='}]}
2025-08-15 02:46:28,529 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:28] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:28,967 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:28] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:29,649 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:29] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:29,672 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:29] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:29,745 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:29] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:30,131 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:30] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:30,414 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:30] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:33,859 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-15 02:46:35,849 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:46:37,375 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:46:36.052455+00:00, interaction_count=224, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:46:37,983 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:46:37,984 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:46:37,985 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-15 02:46:40,470 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-15 02:46:40,473 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:46:41,348 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0Q0E1MDNCODc2NTM2NEJCRgA="}]}
2025-08-15 02:46:41,349 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0Q0E1MDNCODc2NTM2NEJCRgA='}]}
2025-08-15 02:46:41,350 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:41] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:42,341 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:42] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:42,536 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:42] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:42,680 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:42] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:45,175 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-15 02:46:49,499 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:46:51,053 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:46:49.749186+00:00, interaction_count=225, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:46:51,675 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:46:51,676 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:46:51,676 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-15 02:46:51,676 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-15 02:46:51,677 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:46:51,677 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-15 02:46:51,678 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-15 02:46:51,678 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:46:52,523 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEMjU1NjhEMEQxRjE1MUY5OAA="}]}
2025-08-15 02:46:53,650 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:53] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:53,782 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:53] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:53,975 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:53] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:54,276 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:46:55,250 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-15 02:46:55,780 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:46:54.486899+00:00, interaction_count=226, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:46:56,421 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:46:56,428 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjVEMjU1NjhEMEQxRjE1MUY5OAA='}]}
2025-08-15 02:46:56,429 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:46:56] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:46:56,964 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:46:58,727 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:46:57.163866+00:00, interaction_count=227, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:46:59,340 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:46:59,341 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:46:59,341 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-15 02:46:59,342 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:46:59,347 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:47:00,210 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRCQzMwMUE2NUU0OEVBOEE2RAA="}]}
2025-08-15 02:47:01,218 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:47:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:47:01,494 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:47:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:47:01,495 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:47:01] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:47:01,908 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:47:02,967 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-15 02:47:03,446 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:47:02.127466+00:00, interaction_count=228, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:47:04,106 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:47:04,112 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRCQzMwMUE2NUU0OEVBOEE2RAA='}]}
2025-08-15 02:47:04,113 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:47:04] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:47:06,689 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:47:08,219 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:47:06.888833+00:00, interaction_count=229, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:47:08,924 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:47:08,925 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:47:08,926 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-08-15 02:47:08,926 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'initiate_address_collection'.
2025-08-15 02:47:08,926 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 02:47:08,927 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Please choose a valid option from the menu.'}}
2025-08-15 02:47:09,755 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgyNkMzMTFGOUE2M0MzOEVCNgA="}]}
2025-08-15 02:47:11,037 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:47:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:47:11,040 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:47:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:47:11,173 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:47:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:47:11,457 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:47:12,955 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:47:11.654998+00:00, interaction_count=230, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:47:13,579 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:47:13,586 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgyNkMzMTFGOUE2M0MzOEVCNgA='}]}
2025-08-15 02:47:13,590 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:47:13] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:15,195 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 02:48:16,734 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:48:18,504 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:48:18,714 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:48:21,031 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:48:21,232 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:48:21,233 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:48:24,075 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 02:48:24,284 - app - INFO - Initial product sync successful on startup
2025-08-15 02:48:24,284 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:48:24,285 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 02:48:24,285 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:48:24,285 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:48:24,292 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:48:26,012 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:48:26,224 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:48:28,139 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:48:28,356 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:48:28,357 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:48:28,357 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 02:48:28,357 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 02:48:28,358 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:48:28,358 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 02:48:28,359 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:48:28,359 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:48:28,366 - handlers.location_address_handler - INFO - LocationAddressHandler initialized.
2025-08-15 02:48:28,987 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 02:48:28,988 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 02:48:28,988 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 02:48:28,988 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 02:48:28,989 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:48:29,013 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 02:48:29,014 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 02:48:32,957 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hwllo'}
2025-08-15 02:48:32,958 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 02:48:34,760 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:48:36,328 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:48:34.991452+00:00, interaction_count=231, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:48:36,988 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:48:36,989 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 02:48:40,268 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 02:48:40,482 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:48:40,482 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-15 02:48:40,483 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:48:40,483 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:48:41,448 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYzN0E0OEM4N0Q0NjY2NERENwA="}]}
2025-08-15 02:48:41,723 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:48:41,724 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:41] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:42,642 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:42] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:42,776 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:42] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:42,780 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:42] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:45,551 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 02:48:47,323 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:48:48,883 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:48:47.557941+00:00, interaction_count=232, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:48:49,525 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:48:49,526 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:48:49,526 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 02:48:49,526 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 02:48:49,527 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 02:48:49,527 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 02:48:49,528 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:48:49,528 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 02:48:50,483 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY4OTFGOTI1OTIyN0VDNjZBRAA="}]}
2025-08-15 02:48:50,484 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 02:48:50,485 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 02:48:51,444 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3NUZGNjg3RUUxMENCOURBRQA="}]}
2025-08-15 02:48:51,445 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkU3NUZGNjg3RUUxMENCOURBRQA='}]}
2025-08-15 02:48:51,446 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:51] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:51,539 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:51] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:51,765 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:51] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:52,635 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:52] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:52,642 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:52] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:52,824 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:52] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:52,894 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:48:52] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:48:55,677 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-15 02:48:57,383 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:48:59,070 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:48:57.616207+00:00, interaction_count=233, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:48:59,686 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:48:59,687 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:48:59,688 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-15 02:49:01,911 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-15 02:49:01,914 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:49:02,775 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5NjExQkJFQzFDMkMwMDA0QgA="}]}
2025-08-15 02:49:02,776 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA5NjExQkJFQzFDMkMwMDA0QgA='}]}
2025-08-15 02:49:02,777 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:02] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:03,825 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:03] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:03,937 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:03] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:04,164 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:04] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:05,710 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-15 02:49:07,426 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:49:08,875 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:49:07.623894+00:00, interaction_count=234, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:49:09,519 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:49:09,520 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:49:09,520 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-15 02:49:09,521 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-15 02:49:09,521 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:49:09,521 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-15 02:49:09,521 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-15 02:49:09,521 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:49:10,355 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFGNjQ4N0YxNzE1RTk2NEFCRgA="}]}
2025-08-15 02:49:11,526 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:11,560 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:11,777 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:11] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:12,081 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:49:13,604 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:49:12.290531+00:00, interaction_count=235, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:49:14,229 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-15 02:49:14,365 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:49:14,372 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFGNjQ4N0YxNzE1RTk2NEFCRgA='}]}
2025-08-15 02:49:14,373 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:14] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:15,924 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:49:21,223 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:49:16.124236+00:00, interaction_count=236, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:49:22,985 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:49:22,987 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:49:22,987 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-15 02:49:22,988 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:49:22,993 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:49:24,933 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyNzY4RTJFMDQ5OUNGNERCQgA="}]}
2025-08-15 02:49:25,994 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:25] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:26,201 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:26] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:26,482 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:26] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:28,341 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:49:30,371 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:49:28.550400+00:00, interaction_count=237, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:49:31,716 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:49:31,728 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyNzY4RTJFMDQ5OUNGNERCQgA='}]}
2025-08-15 02:49:31,731 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:31] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:42,593 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-15 02:49:44,677 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:49:46,596 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:49:45.274214+00:00, interaction_count=238, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:49:47,266 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:49:47,266 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:49:47,267 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-08-15 02:49:47,267 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'initiate_address_collection'.
2025-08-15 02:49:47,267 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:49:47,723 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:49:47,724 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'location_handler', state 'address_collection_menu', message 'initiate_address_collection'. Resetting to greeting.
2025-08-15 02:49:47,724 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:49:47,724 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-15 02:49:47,725 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:49:47,725 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:49:48,817 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZGODJBQTIxNUI5MTI4OTg2OAA="}]}
2025-08-15 02:49:49,869 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:49] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:50,287 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:50] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:50,294 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:50] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:49:50,926 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:49:52,476 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:49:51.163185+00:00, interaction_count=239, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:49:53,090 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:49:53,378 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:49:53,380 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:49:53] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:20,498 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 02:59:22,976 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:59:27,385 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:59:27,600 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:59:29,468 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:59:29,679 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:59:29,679 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:59:31,966 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 02:59:32,597 - app - INFO - Initial product sync successful on startup
2025-08-15 02:59:32,598 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:59:32,598 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 02:59:32,598 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:59:32,599 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:59:32,609 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 02:59:34,419 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 02:59:34,630 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 02:59:36,736 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 02:59:36,982 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 02:59:36,982 - services.payment_service - INFO - PaymentService initialized
2025-08-15 02:59:36,983 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 02:59:36,983 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 02:59:36,984 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 02:59:36,985 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 02:59:36,985 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 02:59:36,985 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:59:37,517 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 02:59:37,517 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 02:59:37,517 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 02:59:37,518 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 02:59:37,518 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 02:59:37,542 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 02:59:37,542 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 02:59:40,759 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 02:59:40,759 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 02:59:42,506 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:59:43,999 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:59:42.704726+00:00, interaction_count=240, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:59:44,657 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:59:44,658 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 02:59:46,448 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 02:59:46,688 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 02:59:46,689 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 02:59:46,689 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 02:59:46,689 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:59:46,690 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 02:59:47,766 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdCNjdCMUIwMjY0N0Q3MjBERgA="}]}
2025-08-15 02:59:48,022 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 02:59:48,023 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:48] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:48,956 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:48] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:49,021 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:49] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:49,491 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:49] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:51,449 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 02:59:53,127 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 02:59:54,593 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 01:59:53.333871+00:00, interaction_count=241, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 02:59:55,231 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 02:59:55,232 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 02:59:55,232 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 02:59:55,232 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 02:59:55,232 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 02:59:55,233 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 02:59:55,233 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 02:59:55,233 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 02:59:56,264 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE0RDVBNDVFMjdGNjNCQ0M0QwA="}]}
2025-08-15 02:59:56,265 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 02:59:56,265 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 02:59:57,096 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3RUQ0NkI0QTQwQjk0NjFFQQA="}]}
2025-08-15 02:59:57,098 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY3RUQ0NkI0QTQwQjk0NjFFQQA='}]}
2025-08-15 02:59:57,099 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:57] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:57,909 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:57] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:58,622 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:58] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:58,759 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:58] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:58,788 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:58] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:58,859 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:58] "POST /webhook HTTP/1.1" 200 -
2025-08-15 02:59:59,197 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 02:59:59] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:02,150 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-15 03:00:03,851 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 03:00:05,288 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 02:00:04.051302+00:00, interaction_count=242, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 03:00:05,936 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 03:00:05,937 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 03:00:05,937 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-15 03:00:13,908 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-15 03:00:13,911 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 03:00:14,893 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMxNjI2MzUyMDAwMEU5QjhERAA="}]}
2025-08-15 03:00:14,894 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMxNjI2MzUyMDAwMEU5QjhERAA='}]}
2025-08-15 03:00:14,895 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:14] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:16,059 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:16,311 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:16,313 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:16] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:18,188 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-15 03:00:19,996 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 03:00:21,505 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 02:00:20.201396+00:00, interaction_count=243, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 03:00:22,201 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 03:00:22,202 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 03:00:22,202 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-15 03:00:22,202 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-15 03:00:22,203 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 03:00:22,203 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-15 03:00:22,203 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-15 03:00:22,204 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 03:00:23,028 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBFNEFGQTk3MzZEODU2NTY5NgA="}]}
2025-08-15 03:00:24,111 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:24] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:24,285 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:24] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:24,418 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:24] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:26,109 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 03:00:27,654 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 02:00:26.313073+00:00, interaction_count=244, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 03:00:28,278 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 03:00:28,284 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBFNEFGQTk3MzZEODU2NTY5NgA='}]}
2025-08-15 03:00:28,285 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:28] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:32,786 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-15 03:00:34,520 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 03:00:36,021 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 02:00:34.717653+00:00, interaction_count=245, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 03:00:36,680 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 03:00:36,682 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 03:00:36,682 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-15 03:00:36,682 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 03:00:36,689 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 03:00:37,714 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzNEVBMDhCRDdCMEIyQUVEMQA="}]}
2025-08-15 03:00:38,703 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:38] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:38,885 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:38] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:39,062 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:39] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:40,009 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 03:00:42,495 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 02:00:40.647932+00:00, interaction_count=246, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 03:00:43,013 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-15 03:00:43,173 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 03:00:43,179 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMzNEVBMDhCRDdCMEIyQUVEMQA='}]}
2025-08-15 03:00:43,180 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:43] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:44,719 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 03:00:47,271 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 02:00:44.917869+00:00, interaction_count=247, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 03:00:47,920 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 03:00:47,922 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 03:00:47,922 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-08-15 03:00:47,923 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'initiate_address_collection'.
2025-08-15 03:00:47,923 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 03:00:47,924 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Please choose a valid option.'}}
2025-08-15 03:00:49,107 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU0NjI3Njk2NTg4MjdFRUE0QQA="}]}
2025-08-15 03:00:50,113 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:50] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:50,392 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:50] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:50,431 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:50] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:00:50,926 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 03:00:52,548 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 02:00:51.132173+00:00, interaction_count=248, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 03:00:53,241 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 03:00:53,248 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjU0NjI3Njk2NTg4MjdFRUE0QQA='}]}
2025-08-15 03:00:53,248 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:00:53] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:10:27,562 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-15 03:10:29,620 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 03:10:33,723 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 03:10:33,936 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 03:10:35,945 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 03:10:36,169 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 03:10:36,170 - services.payment_service - INFO - PaymentService initialized
2025-08-15 03:10:39,030 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-15 03:10:39,241 - app - INFO - Initial product sync successful on startup
2025-08-15 03:10:39,242 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 03:10:39,242 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-15 03:10:39,243 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 03:10:39,243 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 03:10:39,257 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-15 03:10:41,087 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-15 03:10:41,338 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-15 03:10:43,497 - utils.data_manager - INFO - Successfully loaded 40 user details from database
2025-08-15 03:10:43,707 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-15 03:10:43,708 - services.payment_service - INFO - PaymentService initialized
2025-08-15 03:10:43,709 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-15 03:10:43,709 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-15 03:10:43,710 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-15 03:10:43,711 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-15 03:10:43,712 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-15 03:10:43,713 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 03:10:44,393 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-15 03:10:44,394 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-15 03:10:44,394 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-15 03:10:44,395 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-15 03:10:44,396 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-15 03:10:44,426 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-15 03:10:44,427 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-15 03:11:09,548 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-15 03:11:09,549 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-15 03:11:11,907 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 03:11:13,419 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 02:11:12.124419+00:00, interaction_count=249, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 03:11:14,188 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 03:11:14,189 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-15 03:11:16,351 - utils.data_manager - DEBUG - Found address 'lagos' for phone number 2348055614455 in whatsapp_orders
2025-08-15 03:11:16,615 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-15 03:11:16,615 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 03:11:16,617 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-15 03:11:16,617 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 03:11:16,618 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 03:11:17,664 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVBMDg2MkMyOTZCMjFDNzk3QgA="}]}
2025-08-15 03:11:18,132 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 400 Client Error: Bad Request for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-15 03:11:18,134 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:11:18] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:11:18,726 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:11:18] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:11:18,950 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:11:18] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:11:19,174 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:11:19] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:11:24,828 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 03:11:24] "POST /webhook HTTP/1.1" 200 -
2025-08-15 03:11:26,570 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-15 03:11:28,416 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-15 03:11:31,162 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-15 02:11:28.627926+00:00, interaction_count=250, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=5100.0, converted_at=2025-08-15 01:00:14.274992+00:00
2025-08-15 03:11:32,730 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-15 03:11:32,733 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-15 03:11:32,734 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-15 03:11:32,735 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Let Lola Order).
2025-08-15 03:11:32,736 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-15 03:11:32,737 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-15 03:11:32,738 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 03:11:32,739 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-friday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-15 04:30:06,527 - services.whatsapp_service - ERROR - Request error sending WhatsApp message: ('Connection aborted.', ConnectionAbortedError(10053, 'An established connection was aborted by the software in your host machine', None, 10053, None))
2025-08-15 04:30:07,669 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 04:30:07,697 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-15 04:30:07,860 - services.whatsapp_service - ERROR - Request error sending WhatsApp message: HTTPSConnectionPool(host='graph.facebook.com', port=443): Max retries exceeded with url: /v17.0/204426689424598/messages (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x000001D9920BAD50>: Failed to resolve 'graph.facebook.com' ([Errno 11001] getaddrinfo failed)"))
2025-08-15 04:30:07,876 - handlers.message_processor - WARNING - Session 2348055614455: No handler response for handler 'ai_handler', state 'ai_bulk_order', message 'start_ai_bulk_order'. Resetting to greeting.
2025-08-15 04:30:07,888 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-15 04:30:07,912 - handlers.base_handler - INFO - Session 2348055614455 greeted returning user 'Ziga'.
2025-08-15 04:30:07,921 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-15 04:30:07,924 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-15 04:30:08,070 - services.whatsapp_service - ERROR - Request error sending WhatsApp message: HTTPSConnectionPool(host='graph.facebook.com', port=443): Max retries exceeded with url: /v17.0/204426689424598/messages (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x000001D9920BA490>: Failed to resolve 'graph.facebook.com' ([Errno 11001] getaddrinfo failed)"))
2025-08-15 04:30:08,078 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'ai_handler', state 'ai_bulk_order': 'NoneType' object is not iterable
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 319, in _route_to_handler
    response = self.greeting_handler.generate_initial_greeting(state, session_id, user_name)
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 183, in generate_initial_greeting
    return self._send_greeting_with_image(session_id, username, "guest", message)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 312, in _send_greeting_with_image
    response.update(self.send_main_menu(session_id, user_name, "How can I help you today?"))
    ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: 'NoneType' object is not iterable
2025-08-15 04:30:08,087 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-15 04:30:08,291 - services.whatsapp_service - ERROR - Request error sending WhatsApp message: HTTPSConnectionPool(host='graph.facebook.com', port=443): Max retries exceeded with url: /v17.0/204426689424598/messages (Caused by NameResolutionError("<urllib3.connection.HTTPSConnection object at 0x000001D9920BA710>: Failed to resolve 'graph.facebook.com' ([Errno 11001] getaddrinfo failed)"))
2025-08-15 04:30:08,297 - werkzeug - INFO - 127.0.0.1 - - [15/Aug/2025 04:30:08] "POST /webhook HTTP/1.1" 200 -
2025-08-18 00:05:05,583 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-18 00:05:08,616 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-18 00:05:11,400 - __main__ - INFO - Bot server stopped by user.
2025-08-20 04:21:02,186 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-20 04:21:04,083 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-20 04:21:06,435 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-20 04:21:06,625 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-20 04:21:08,346 - utils.data_manager - INFO - Successfully loaded 52 user details from database
2025-08-20 04:21:08,546 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-20 04:21:08,546 - services.payment_service - INFO - PaymentService initialized
2025-08-20 04:21:10,119 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-20 04:21:10,305 - app - INFO - Initial product sync successful on startup
2025-08-20 04:21:10,305 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-20 04:21:10,306 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-20 04:21:10,306 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-20 04:21:10,307 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-20 04:21:10,317 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-20 04:21:11,835 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-20 04:21:12,026 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-20 04:21:13,746 - utils.data_manager - INFO - Successfully loaded 52 user details from database
2025-08-20 04:21:13,935 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-20 04:21:13,936 - services.payment_service - INFO - PaymentService initialized
2025-08-20 04:21:13,936 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-20 04:21:13,937 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-20 04:21:13,937 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-20 04:21:13,948 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-20 04:21:13,948 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-20 04:21:13,949 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-20 04:21:14,380 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-20 04:21:14,380 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-20 04:21:14,381 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-20 04:21:14,381 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-20 04:21:14,382 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-20 04:21:14,419 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-20 04:21:14,419 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-20 04:21:23,878 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-20 04:21:23,878 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-20 04:21:25,445 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:21:26,788 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:21:25.635394+00:00, interaction_count=566, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:21:27,355 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:21:27,356 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-20 04:21:28,987 - utils.data_manager - DEBUG - Found address 'Location: 6.5864913, 3.3744984' for phone number 2348055614455 in whatsapp_orders
2025-08-20 04:21:29,175 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-20 04:21:29,175 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864913, 3.3744984', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:21:29,176 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-20 04:21:29,176 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-20 04:21:30,495 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjgzRjBFRkQ0REY4RDkzRDU2OQA="}]}
2025-08-20 04:21:30,508 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:21:31,755 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEwNDRCRTJGQTk0NUQzMEUyOQA="}]}
2025-08-20 04:21:31,757 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkEwNDRCRTJGQTk0NUQzMEUyOQA='}]}
2025-08-20 04:21:31,759 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:31] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:32,176 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:32] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:32,671 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:32] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:32,686 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:32] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:32,938 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:32] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:33,398 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:33] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:33,777 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:33] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:37,765 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-20 04:21:39,405 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:21:40,785 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:21:39.595323+00:00, interaction_count=567, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:21:41,425 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:21:41,426 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:21:41,427 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-20 04:21:41,427 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-08-20 04:21:41,428 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-20 04:21:41,428 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-20 04:21:41,429 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-20 04:21:41,430 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-20 04:21:42,526 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc1QjIwRTIyREZBNkY1QzUwNAA="}]}
2025-08-20 04:21:42,527 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:21:42,528 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-20 04:21:43,950 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:43] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:44,349 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:44] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:44,708 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:44] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:44,716 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY4QTVFOTFGRDcxMkU5RjJENAA="}]}
2025-08-20 04:21:44,720 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY4QTVFOTFGRDcxMkU5RjJENAA='}]}
2025-08-20 04:21:44,724 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:44] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:45,676 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:45] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:46,071 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:46] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:46,193 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:46] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:50,650 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-20 04:21:52,325 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:21:53,866 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:21:52.536258+00:00, interaction_count=568, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:21:54,455 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:21:54,456 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:21:54,457 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-08-20 04:21:57,663 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-20 04:21:57,735 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:21:58,884 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBMDkyRTAyODFBNDc5QzcxQgA="}]}
2025-08-20 04:21:58,886 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBMDkyRTAyODFBNDc5QzcxQgA='}]}
2025-08-20 04:21:58,888 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:58] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:21:59,966 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:21:59] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:00,136 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:00] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:00,633 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:00] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:02,769 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-20 04:22:04,405 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:22:05,847 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:22:04.596442+00:00, interaction_count=569, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:22:06,455 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:22:06,457 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:22:06,458 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-20 04:22:06,459 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-20 04:22:06,460 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864913, 3.3744984', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:22:06,462 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-20 04:22:06,463 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-20 04:22:06,479 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:22:07,537 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5MUFBQzczQUQ3M0NFMDMwMwA="}]}
2025-08-20 04:22:08,515 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:08] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:08,762 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:08] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:09,165 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:22:10,665 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:22:09.355642+00:00, interaction_count=570, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:22:11,245 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:22:11,261 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5MUFBQzczQUQ3M0NFMDMwMwA='}]}
2025-08-20 04:22:11,263 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:11] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:19,762 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:19] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:21,346 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-20 04:22:23,062 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:22:24,595 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:22:23.358596+00:00, interaction_count=571, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:22:25,165 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:22:25,167 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:22:25,169 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-20 04:22:25,170 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864913, 3.3744984', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:22:25,203 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:22:27,138 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY2QzY4MTc3RDhCMUYzQ0VDRgA="}]}
2025-08-20 04:22:27,537 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:27] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:27,971 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:27] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:28,110 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:28] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:28,785 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:22:30,423 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:22:28.990392+00:00, interaction_count=572, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:22:31,006 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:22:31,026 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY2QzY4MTc3RDhCMUYzQ0VDRgA='}]}
2025-08-20 04:22:31,027 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:31] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:31,386 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-20 04:22:32,905 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:22:34,415 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:22:33.095778+00:00, interaction_count=573, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:22:35,031 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:22:35,034 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:22:35,035 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-08-20 04:22:35,036 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'initiate_address_collection'.
2025-08-20 04:22:35,056 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:22:36,096 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3MzRFNzJGOEM2MDQwMkU2QgA="}]}
2025-08-20 04:22:37,078 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:37] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:37,366 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:37] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:37,636 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:37] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:37,655 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:22:39,230 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:22:37.845201+00:00, interaction_count=574, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:22:39,844 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:22:39,856 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI3MzRFNzJGOEM2MDQwMkU2QgA='}]}
2025-08-20 04:22:39,858 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:39] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:42,237 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'type_address_manually'}
2025-08-20 04:22:43,940 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:22:45,374 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:22:44.145858+00:00, interaction_count=575, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:22:45,988 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:22:45,991 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:22:45,992 - handlers.location_address_handler - INFO - Requested manual address for session 2348055614455
2025-08-20 04:22:45,992 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:22:47,116 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEOEVCRTNERjQ1NEM5RDAxQwA="}]}
2025-08-20 04:22:48,036 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:48] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:48,306 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:48] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:48,753 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:22:48,776 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:48] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:50,187 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:22:48.946003+00:00, interaction_count=576, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:22:50,801 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:22:50,814 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBEOEVCRTNERjQ1NEM5RDAxQwA='}]}
2025-08-20 04:22:50,816 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:22:50] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:22:57,307 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hwoson wirhjts ,Lagos'}
2025-08-20 04:22:59,096 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:23:00,632 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:22:59.295338+00:00, interaction_count=577, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:23:01,215 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:23:01,217 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:23:03,089 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-20 04:23:03,091 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-08-20 04:23:03,092 - handlers.location_address_handler - INFO - Manual address 'Hwoson wirhjts ,Lagos' processed for 2348055614455
2025-08-20 04:23:03,092 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-08-20 04:23:04,904 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-20 04:23:04,906 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-08-20 04:23:04,907 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-08-20 04:23:04,935 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:23:06,016 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwMDRBRUZBNzE0RDJFODYxNAA="}]}
2025-08-20 04:23:06,980 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:23:06] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:23:07,309 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:23:07] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:23:07,695 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:23:07,719 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:23:07] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:23:09,246 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:23:07.905196+00:00, interaction_count=578, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:23:09,824 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:23:09,838 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkMwMDRBRUZBNzE0RDJFODYxNAA='}]}
2025-08-20 04:23:09,840 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:23:09] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:24:34,253 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-20 04:24:35,955 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:24:37,394 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:24:36.172074+00:00, interaction_count=579, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:24:38,015 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:24:38,017 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:24:38,018 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-20 04:24:38,018 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Hwoson wirhjts ,Lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:24:38,019 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-20 04:24:38,020 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-20 04:24:39,246 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlFMEE0NjJFM0Y2RDU2M0ZFMgA="}]}
2025-08-20 04:24:39,247 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:24:40,373 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5MENFQ0NCMkIwQkVFODQxOQA="}]}
2025-08-20 04:24:40,374 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjE5MENFQ0NCMkIwQkVFODQxOQA='}]}
2025-08-20 04:24:40,376 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:24:40] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:24:40,665 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:24:40] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:24:41,429 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:24:41] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:24:41,432 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:24:41] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:24:41,559 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:24:41] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:24:41,829 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:24:41] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:24:41,926 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:24:41] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:24:57,539 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-20 04:24:59,416 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:25:00,953 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:24:59.621854+00:00, interaction_count=580, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:25:01,558 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:25:01,560 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:25:01,561 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-20 04:25:01,561 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-08-20 04:25:01,562 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-20 04:25:01,562 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-20 04:25:01,563 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-20 04:25:01,564 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-20 04:25:02,676 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFCNUE2REMxNjRDNEUyODRGNAA="}]}
2025-08-20 04:25:02,679 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:25:02,680 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-20 04:25:03,824 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRBODAwRTE4QTRCNTBGQzhBNAA="}]}
2025-08-20 04:25:03,826 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRBODAwRTE4QTRCNTBGQzhBNAA='}]}
2025-08-20 04:25:03,828 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:03] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:03,905 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:03] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:04,616 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:04] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:04,739 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:04] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:05,158 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:05] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:05,289 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:05] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:05,557 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:05] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:09,445 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-20 04:25:11,193 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:25:12,626 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:25:11.390146+00:00, interaction_count=581, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:25:13,240 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:25:13,243 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:25:13,244 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-20 04:25:15,700 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-20 04:25:15,724 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:25:16,836 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAxNERBMkIwNjc4QjY2MjYyQgA="}]}
2025-08-20 04:25:16,838 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAxNERBMkIwNjc4QjY2MjYyQgA='}]}
2025-08-20 04:25:16,840 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:16] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:17,867 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:17] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:18,157 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:18] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:18,546 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:18] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:20,618 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-20 04:25:22,264 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:25:23,704 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:25:22.454920+00:00, interaction_count=582, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=4000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:25:24,274 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:25:24,276 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:25:24,276 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-20 04:25:24,277 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-20 04:25:24,278 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Hwoson wirhjts ,Lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:25:24,279 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-20 04:25:24,279 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-20 04:25:24,293 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:25:25,396 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0RDU4MUM2MzI5MUJDRDlCOAA="}]}
2025-08-20 04:25:26,262 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:26] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:26,677 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:26] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:26,823 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:26] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:25:27,035 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:25:28,587 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:25:27.225352+00:00, interaction_count=583, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:25:29,185 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:25:29,206 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkY0RDU4MUM2MzI5MUJDRDlCOAA='}]}
2025-08-20 04:25:29,209 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:25:29] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:02,629 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-20 04:26:05,446 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-20 04:26:07,384 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-20 04:26:07,574 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-20 04:26:09,552 - utils.data_manager - INFO - Successfully loaded 52 user details from database
2025-08-20 04:26:09,767 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-20 04:26:09,768 - services.payment_service - INFO - PaymentService initialized
2025-08-20 04:26:11,614 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-20 04:26:11,804 - app - INFO - Initial product sync successful on startup
2025-08-20 04:26:11,805 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-20 04:26:11,806 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-20 04:26:11,806 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-20 04:26:11,807 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-20 04:26:11,824 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-20 04:26:13,454 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-20 04:26:13,654 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-20 04:26:15,466 - utils.data_manager - INFO - Successfully loaded 52 user details from database
2025-08-20 04:26:15,707 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-20 04:26:15,709 - services.payment_service - INFO - PaymentService initialized
2025-08-20 04:26:15,710 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-20 04:26:15,711 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-20 04:26:15,712 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-20 04:26:15,714 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-20 04:26:15,715 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-20 04:26:15,717 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-20 04:26:16,560 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-20 04:26:16,561 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-20 04:26:16,561 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-20 04:26:16,562 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-20 04:26:16,563 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-20 04:26:16,604 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-20 04:26:16,605 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-20 04:26:31,166 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-20 04:26:31,167 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-20 04:26:32,724 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:26:34,240 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:26:32.915275+00:00, interaction_count=584, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:26:34,814 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:26:34,816 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-20 04:26:36,474 - utils.data_manager - DEBUG - Found address 'Location: 6.5864913, 3.3744984' for phone number 2348055614455 in whatsapp_orders
2025-08-20 04:26:36,664 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-20 04:26:36,665 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Hwoson wirhjts ,Lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:26:36,666 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-20 04:26:36,667 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-20 04:26:37,866 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQ4OEZDRDZBRUE4NEI1MkI1OQA="}]}
2025-08-20 04:26:37,882 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:26:38,953 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg5NzhGQjIwRjA1MjlEQTIyRQA="}]}
2025-08-20 04:26:38,956 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg5NzhGQjIwRjA1MjlEQTIyRQA='}]}
2025-08-20 04:26:38,958 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:38] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:39,043 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:39] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:39,286 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:39] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:40,061 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:40] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:40,187 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:40] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:40,421 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:40] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:40,668 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:40] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:42,201 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-20 04:26:43,389 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-20 04:26:43,834 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:26:45,095 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:26:45,324 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:26:44.025193+00:00, interaction_count=585, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:26:45,885 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:26:45,887 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:26:45,888 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-20 04:26:45,889 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-08-20 04:26:45,889 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-20 04:26:45,890 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-20 04:26:45,891 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-20 04:26:45,892 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-20 04:26:46,528 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:26:45.299691+00:00, interaction_count=585, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:26:47,006 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjc2QjA5MThBNTcxMDI5RDQwOQA="}]}
2025-08-20 04:26:47,008 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:26:47,010 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-20 04:26:47,124 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:26:47,126 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:26:47,126 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-20 04:26:47,127 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Hwoson wirhjts ,Lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:26:47,128 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-20 04:26:47,128 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-20 04:26:48,175 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEyQTM5Qjc0QTVBRkVFODc2MAA="}]}
2025-08-20 04:26:48,177 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjEyQTM5Qjc0QTVBRkVFODc2MAA='}]}
2025-08-20 04:26:48,179 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:48] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:48,193 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:48] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:48,297 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhGMjNGRjU2NENGMDNBQzExOAA="}]}
2025-08-20 04:26:48,299 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:26:48,478 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:48] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:49,001 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:49] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:49,127 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:49] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:49,285 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRBNzYyRjY4MjY4QTUzRDA2MQA="}]}
2025-08-20 04:26:49,287 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRBNzYyRjY4MjY4QTUzRDA2MQA='}]}
2025-08-20 04:26:49,288 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:49] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:49,707 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:49] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:49,933 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:49] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:50,160 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:50] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:50,456 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:50] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:50,508 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:50] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:50,775 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:50] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:50,896 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:50] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:26:51,246 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:26:51] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:01,501 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-20 04:27:03,049 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-20 04:27:03,085 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:04,445 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:03.285265+00:00, interaction_count=586, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:04,615 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:05,044 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:05,047 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:27:05,048 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-20 04:27:05,049 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-08-20 04:27:05,049 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-20 04:27:05,050 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-20 04:27:05,051 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-20 04:27:05,053 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://eventio.africa/wp-content/uploads/2025/08/ganador-wednesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-20 04:27:06,087 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:04.858576+00:00, interaction_count=586, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:06,137 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRDQzNCNTBGMTkzODhGQTQ4OQA="}]}
2025-08-20 04:27:06,140 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:27:06,142 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-20 04:27:06,655 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:06,658 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:27:06,659 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-20 04:27:07,175 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFDMTc3OTIyNzBCMTI3M0ZGQwA="}]}
2025-08-20 04:27:07,177 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFDMTc3OTIyNzBCMTI3M0ZGQwA='}]}
2025-08-20 04:27:07,181 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:07] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:07,571 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:07] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:08,139 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:08] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:08,207 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:08] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:08,329 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:08] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:08,595 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:08] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:09,065 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:09] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:09,570 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-20 04:27:09,590 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:27:10,696 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVCOTUxMDhEMzQ0M0U1RjQ3QgA="}]}
2025-08-20 04:27:10,699 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkVCOTUxMDhEMzQ0M0U1RjQ3QgA='}]}
2025-08-20 04:27:10,701 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:10] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:11,589 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:11] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:11,946 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-20 04:27:12,161 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:12] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:12,376 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:12] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:13,534 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:14,233 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-20 04:27:14,986 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:13.767832+00:00, interaction_count=587, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:15,609 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:15,612 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:27:15,613 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:27:15,614 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': 'Please choose from the available options.'}}
2025-08-20 04:27:15,804 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:16,685 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRBQTRDMkQ1RjUxMDAwMjQ1MQA="}]}
2025-08-20 04:27:16,687 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkRBQTRDMkQ1RjUxMDAwMjQ1MQA='}]}
2025-08-20 04:27:16,689 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:16] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:17,555 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:15.995109+00:00, interaction_count=588, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:17,699 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:17] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:17,975 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:17] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:18,124 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:18,125 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:27:18,126 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-20 04:27:18,127 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-20 04:27:18,127 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Hwoson wirhjts ,Lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:27:18,129 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-20 04:27:18,129 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-20 04:27:18,145 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:27:18,321 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:18] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:19,297 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM2NDlEQTJCNDJCMTBBQzk0MgA="}]}
2025-08-20 04:27:20,138 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:20] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:20,456 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:20] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:20,935 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:20,943 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:20] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:22,278 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-20 04:27:22,354 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:21.125202+00:00, interaction_count=589, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:22,924 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:22,937 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM2NDlEQTJCNDJCMTBBQzk0MgA='}]}
2025-08-20 04:27:22,939 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:22] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:23,875 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:25,349 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:24.064745+00:00, interaction_count=590, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:25,924 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:25,925 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:27:25,926 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-20 04:27:25,926 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Hwoson wirhjts ,Lagos', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:27:25,951 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:27:27,005 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFFMkQzOEMxRDhDNDVDRjIwRgA="}]}
2025-08-20 04:27:27,972 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:27] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:28,225 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:28] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:28,615 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:28,621 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:28] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:30,150 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:28.804620+00:00, interaction_count=591, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:30,754 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:30,763 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-20 04:27:30,773 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkFFMkQzOEMxRDhDNDVDRjIwRgA='}]}
2025-08-20 04:27:30,775 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:30] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:32,374 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:33,784 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:32.565168+00:00, interaction_count=592, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:34,451 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:34,453 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:27:34,455 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-08-20 04:27:34,455 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'initiate_address_collection'.
2025-08-20 04:27:34,474 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:27:35,556 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJEMEFBRTc2Nzk2RTY3OUY0QwA="}]}
2025-08-20 04:27:36,469 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:36] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:37,027 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:37] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:37,121 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:37] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:37,194 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:38,521 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-08-20 04:27:38,664 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:37.384652+00:00, interaction_count=593, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:39,367 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:39,388 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkJEMEFBRTc2Nzk2RTY3OUY0QwA='}]}
2025-08-20 04:27:39,391 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:39] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:40,186 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:41,722 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:40.391571+00:00, interaction_count=594, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:42,636 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:42,638 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:27:42,638 - handlers.location_address_handler - INFO - Requested live location for session 2348055614455
2025-08-20 04:27:42,639 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:27:43,746 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQzNTJCRkRBMjk4NzI4NUQ0NQA="}]}
2025-08-20 04:27:44,648 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:44] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:44,989 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:44] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:45,354 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:45,469 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:45] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:46,744 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:45.544900+00:00, interaction_count=595, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:47,355 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:47,375 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkQzNTJCRkRBMjk4NzI4NUQ0NQA='}]}
2025-08-20 04:27:47,376 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:47] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:50,455 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'location', 'latitude': 6.58649, 'longitude': 3.3744969, 'name': None, 'address': None}
2025-08-20 04:27:52,104 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:27:53,445 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:27:52.294817+00:00, interaction_count=596, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:27:54,112 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:27:54,115 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:27:54,116 - handlers.location_address_handler - INFO - Processing live location for 2348055614455: Lat=6.58649, Lon=3.3744969, Name='None', Address='None'
2025-08-20 04:27:54,117 - handlers.location_address_handler - WARNING - No readable address for 2348055614455 from 6.58649,3.3744969. Awaiting coordinates confirmation.
2025-08-20 04:27:54,136 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:27:55,240 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1RTI5N0Q0OUI0QTk0ODk0RAA="}]}
2025-08-20 04:27:55,243 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1RTI5N0Q0OUI0QTk0ODk0RAA='}]}
2025-08-20 04:27:55,244 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:55] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:56,174 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:56] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:56,408 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:56] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:56,727 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:27:56] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:27:58,165 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'use_coordinates'}
2025-08-20 04:27:59,804 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:28:01,385 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:28:00.052311+00:00, interaction_count=597, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:28:01,998 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:28:02,001 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:28:03,841 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-20 04:28:03,842 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-08-20 04:28:03,843 - handlers.location_address_handler - INFO - Confirmed coordinates for 2348055614455: Location: 6.58649, 3.3744969
2025-08-20 04:28:03,843 - handlers.location_address_handler - INFO - Redirecting to OrderHandler for session 2348055614455 after address update
2025-08-20 04:28:05,674 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-20 04:28:05,675 - handlers.location_address_handler - INFO - Address saved to user details for session 2348055614455
2025-08-20 04:28:05,676 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-08-20 04:28:05,691 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:28:06,811 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM3MEM1Rjk5MTA4RTZEOTg1RgA="}]}
2025-08-20 04:28:07,859 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:07] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:07,998 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:07] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:08,449 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:28:08,473 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:08] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:09,894 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:28:08.644563+00:00, interaction_count=598, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:28:10,584 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:28:10,587 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-20 04:28:10,605 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjM3MEM1Rjk5MTA4RTZEOTg1RgA='}]}
2025-08-20 04:28:10,607 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:10] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:12,266 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:28:13,774 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:28:12.455207+00:00, interaction_count=599, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=4000.0, converted_at=2025-08-20 03:04:45.557793+00:00
2025-08-20 04:28:14,374 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:28:14,375 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:28:14,376 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.58649, 3.3744969', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-20 04:28:16,114 - utils.data_manager - DEBUG - Found product_id 112 for product_name Jollof Rice
2025-08-20 04:28:18,381 - utils.data_manager - INFO - Saved order 192 for customer 2348055614455
2025-08-20 04:28:18,624 - utils.data_manager - INFO - Saved order item Jollof Rice for order 192
2025-08-20 04:28:18,894 - handlers.order_handler - INFO - Order 192 saved to database for session 2348055614455
2025-08-20 04:28:20,737 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-20 04:28:22,376 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:28:23,911 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:28:22.580980+00:00, interaction_count=600, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=order_completed, final_order_value=2000.0, converted_at=2025-08-20 03:28:22.581001+00:00
2025-08-20 04:28:24,495 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:28:24,514 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'payment_handler' with message 'initiate_payment'.
2025-08-20 04:28:24,515 - handlers.payment_handler - INFO - Handling payment processing for session 2348055614455, message: initiate_payment
2025-08-20 04:28:24,516 - handlers.payment_handler - INFO - Creating payment link for session 2348055614455
2025-08-20 04:28:28,204 - utils.data_manager - INFO - Updated order 192 to status pending_payment
2025-08-20 04:28:28,206 - services.payment_service - INFO - Adding subaccount split: code=ACCT_u9knhyzn5eq4iop, percentage=1%
2025-08-20 04:28:28,207 - services.payment_service - INFO - Attempting to create payment link for reference: PAY-192 with amount: 305000, email: ziga4455@lola.com
2025-08-20 04:28:28,979 - services.payment_service - INFO - Payment link created for Ziga Ziga (2348055614455), URL: https://checkout.paystack.com/9jgxloq1thwqwe0
2025-08-20 04:28:28,980 - handlers.payment_handler - INFO - Starting payment monitoring for order 192, reference PAY-192
2025-08-20 04:28:28,981 - services.payment_service - INFO - Attempting to verify payment for reference: PAY-192
2025-08-20 04:28:29,547 - services.payment_service - WARNING - Payment not successful for reference PAY-192. Paystack status: abandoned. Response: {'status': True, 'message': 'Verification successful', 'data': {'id': 5255425766, 'domain': 'test', 'status': 'abandoned', 'reference': 'PAY-192', 'receipt_number': None, 'amount': 305000, 'message': None, 'gateway_response': 'The transaction was not completed', 'paid_at': None, 'created_at': '2025-08-20T03:28:28.000Z', 'channel': 'card', 'currency': 'NGN', 'ip_address': '102.67.12.153, 172.69.224.170, 172.31.68.120', 'metadata': {'customer_name': 'Ziga', 'customer_phone': '2348055614455', 'first_name': 'Ziga', 'last_name': 'Ziga', 'order_id': '192', 'delivery_address': 'Location: 6.58649, 3.3744969', 'delivery_fee': '1000', 'service_charge': '50', 'phone_number': '2348055614455'}, 'log': None, 'fees': None, 'fees_split': {'paystack': 14575, 'integration': '3050', 'subaccount': 287375, 'params': {'bearer': 'subaccount', 'transaction_charge': '3050', 'percentage_charge': '0'}}, 'authorization': {}, 'customer': {'id': 296816511, 'first_name': None, 'last_name': None, 'email': 'ziga4455@lola.com', 'customer_code': 'CUS_3maokfy2as1d6qe', 'phone': None, 'metadata': None, 'risk_action': 'default', 'international_format_phone': None}, 'plan': None, 'split': {}, 'order_id': None, 'paidAt': None, 'createdAt': '2025-08-20T03:28:28.000Z', 'requested_amount': 305000, 'pos_transaction_data': None, 'source': None, 'fees_breakdown': None, 'connect': None, 'transaction_date': '2025-08-20T03:28:28.000Z', 'plan_object': {}, 'subaccount': {'id': 1381359, 'subaccount_code': 'ACCT_u9knhyzn5eq4iop', 'business_name': 'MAKINDE VICTOR OLUWASEGUN', 'description': 'MAKINDE VICTOR OLUWASEGUN', 'primary_contact_name': None, 'primary_contact_email': None, 'primary_contact_phone': None, 'metadata': None, 'percentage_charge': 0, 'settlement_bank': 'First City Monument Bank', 'bank_id': 8, 'account_number': '4955073017', 'currency': 'NGN', 'active': True, 'is_verified': True}}}
2025-08-20 04:28:29,549 - handlers.payment_handler - INFO - Payment not yet verified for order 192, attempt 1/15
2025-08-20 04:28:29,552 - handlers.payment_handler - INFO - Payment link created successfully for order 192 with subaccount ACCT_u9knhyzn5eq4iop
2025-08-20 04:28:31,274 - utils.data_manager - INFO - Retrieved 1 items for order 192
2025-08-20 04:28:31,464 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:28:32,525 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJBNUZFOUY5OERFRjgyMzIzMwA="}]}
2025-08-20 04:28:33,551 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:33] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:33,678 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:33] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:34,151 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:28:34,158 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:34] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:35,585 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:28:34.344982+00:00, interaction_count=601, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=2000.0, converted_at=2025-08-20 03:28:22.581001+00:00
2025-08-20 04:28:36,092 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'final_confirm'}
2025-08-20 04:28:36,196 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:28:36,219 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJBNUZFOUY5OERFRjgyMzIzMwA='}]}
2025-08-20 04:28:36,221 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:36] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:37,735 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:28:39,185 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:28:37.941357+00:00, interaction_count=602, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=2000.0, converted_at=2025-08-20 03:28:22.581001+00:00
2025-08-20 04:28:39,754 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:28:39,756 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-20 04:28:40,434 - handlers.payment_handler - INFO - Received 'charge.success' webhook for reference: PAY-192
2025-08-20 04:28:41,626 - handlers.payment_handler - INFO - User sent message while still awaiting payment for order 192.
2025-08-20 04:28:43,194 - utils.data_manager - INFO - Retrieved 1 items for order 192
2025-08-20 04:28:43,384 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:28:43,954 - utils.data_manager - INFO - Updated order 192 to status confirmed
2025-08-20 04:28:44,425 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJGNUE3RjY5REUxODFBOEI1MAA="}]}
2025-08-20 04:28:45,359 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:45] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:45,504 - utils.data_manager - INFO - Retrieved 1 items for order 192
2025-08-20 04:28:45,632 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:45] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:45,967 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-20 04:28:47,172 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:47] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:47,304 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-20 03:28:46.155223+00:00, interaction_count=603, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=2000.0, converted_at=2025-08-20 03:28:22.581001+00:00
2025-08-20 04:28:47,434 - utils.data_manager - INFO - Reduced inventory for product_id 112 by 1 for order 192
2025-08-20 04:28:47,884 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-20 04:28:47,896 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjJGNUE3RjY5REUxODFBOEI1MAA='}]}
2025-08-20 04:28:47,898 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:47] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:49,412 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-20 04:28:49,614 - handlers.payment_handler - INFO - Successfully synced products to JSON after inventory reduction for order 192
2025-08-20 04:28:51,560 - handlers.payment_handler - DEBUG - Lead tracking handler not available for order conversion tracking
2025-08-20 04:28:51,561 - handlers.payment_handler - DEBUG - No location coordinates or valid address/API key to generate maps info.
2025-08-20 04:28:53,385 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-20 04:28:54,632 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkZCRTlENEQ4RkNBODQ3RDg2RQA="}]}
2025-08-20 04:28:54,635 - handlers.payment_handler - INFO - Sent payment success text message for order 192 to customer 2348055614455
2025-08-20 04:28:54,636 - handlers.payment_handler - INFO - Initiating manual feedback collection for order 192, session 2348055614455
2025-08-20 04:28:54,638 - handlers.payment_handler - DEBUG - Updated state for session 2348055614455: {'current_state': 'feedback_rating', 'current_handler': 'feedback_handler', 'cart': {}, 'user_name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.58649, 3.3744969', 'quantity_prompt_sent': False, 'last_activity': datetime.datetime(2025, 8, 20, 4, 28, 54, 638187), 'payment_reference': 'PAY-192', 'order_id': '192', 'total_cost': 0, 'is_paid_user': False, 'extended_session': False, 'recent_order_id': None, 'paid_session_expires': None, 'freshly_reset_timestamp': None, 'ai_mode': 'bulk_order', 'parsed_order': {'success': True, 'recognized_items': [{'item_id': '112', 'name': 'Jollof Rice', 'quantity': 1, 'variations': {}, 'price': 2000.0, 'total_price': 2000.0}], 'ambiguous_items': [], 'unrecognized_items': [], 'order_total': 2000.0, 'error': ''}, 'total_price': 2000.0, 'from_ai_order': True, 'map_link': '', 'latitude': 6.58649, 'longitude': 3.3744969, 'total_amount': 2000.0, 'order_status': 'pending_payment', 'order_timestamp': '2025-08-20T03:28:16.334320+00:00', 'feedback_order_id': 192, 'feedback_started_at': '2025-08-20T04:28:54.638159'}
2025-08-20 04:28:54,657 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-20 04:28:55,481 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:55] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:55,734 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY2RkU3OUM4ODQ4Nzg1MDFFRAA="}]}
2025-08-20 04:28:55,736 - handlers.payment_handler - INFO - Manual feedback prompt sent for order 192, session 2348055614455, response: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY2RkU3OUM4ODQ4Nzg1MDFFRAA='}]}
2025-08-20 04:28:55,737 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-20 04:28:55,846 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:55] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:56,208 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:56] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:56,935 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:56] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:57,128 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:57] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:57,393 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:57] "POST /webhook HTTP/1.1" 200 -
2025-08-20 04:28:57,655 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEkMwQ0E2NjJFMDk5RTg4RUY1OQA="}]}
2025-08-20 04:28:57,657 - handlers.payment_handler - INFO - Sent detailed merchant notification for order 192 to 2347082345056
2025-08-20 04:28:57,658 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:57] "POST /api/paystack/webhook HTTP/1.1" 200 -
2025-08-20 04:28:59,862 - werkzeug - INFO - 127.0.0.1 - - [20/Aug/2025 04:28:59] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:26:20,249 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-26 13:26:22,846 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 13:26:25,235 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 13:26:25,455 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 13:26:27,522 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 13:26:27,731 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 13:26:27,731 - services.payment_service - INFO - PaymentService initialized
2025-08-26 13:26:29,562 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-26 13:26:29,791 - app - INFO - Initial product sync successful on startup
2025-08-26 13:26:29,801 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 13:26:29,802 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-26 13:26:29,802 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 13:26:29,803 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:26:29,814 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 13:26:31,582 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 13:26:31,786 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 13:26:33,668 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 13:26:33,879 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 13:26:33,880 - services.payment_service - INFO - PaymentService initialized
2025-08-26 13:26:33,880 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-26 13:26:33,881 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-26 13:26:33,881 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 13:26:33,892 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-26 13:26:33,893 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 13:26:33,893 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:26:34,370 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-26 13:26:34,371 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-26 13:26:34,371 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-26 13:26:34,371 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-26 13:26:34,372 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:26:34,416 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-26 13:26:34,416 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-26 13:27:52,532 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-26 13:27:54,175 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 13:27:56,009 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 13:27:56,216 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 13:27:58,127 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 13:27:58,340 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 13:27:58,341 - services.payment_service - INFO - PaymentService initialized
2025-08-26 13:28:00,074 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-26 13:28:00,272 - app - INFO - Initial product sync successful on startup
2025-08-26 13:28:00,273 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 13:28:00,273 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-26 13:28:00,273 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 13:28:00,274 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:28:00,279 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 13:28:02,003 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 13:28:02,215 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 13:28:04,094 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 13:28:04,297 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 13:28:04,297 - services.payment_service - INFO - PaymentService initialized
2025-08-26 13:28:04,298 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-26 13:28:04,298 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-26 13:28:04,298 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 13:28:04,299 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-26 13:28:04,299 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 13:28:04,300 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:28:04,688 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-26 13:28:04,689 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-26 13:28:04,689 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-26 13:28:04,689 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-26 13:28:04,689 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:28:04,704 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-26 13:28:04,704 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-26 13:29:37,524 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-26 13:29:37,524 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-26 13:29:39,290 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 13:29:40,790 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-26 12:29:39.504428+00:00, interaction_count=604, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=2000.0, converted_at=2025-08-20 03:28:22.581001+00:00
2025-08-26 13:29:41,400 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 13:29:41,401 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-26 13:29:43,069 - utils.data_manager - DEBUG - Found address 'Location: 6.5864913, 3.3744984' for phone number 2348055614455 in whatsapp_orders
2025-08-26 13:29:43,288 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-26 13:29:43,288 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.58649, 3.3744969', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-26 13:29:43,289 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-26 13:29:43,289 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': WhatsAppService.send_image_with_buttons() takes 5 positional arguments but 6 were given
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 179, in _route_to_handler
    return self.greeting_handler.handle_back_to_main(state, session_id, "Let's start fresh. What can I do for you?")
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 302, in handle_back_to_main
    return self._send_greeting_with_image(session_id, user_name, "guest")
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 341, in _send_greeting_with_image
    return self.whatsapp_service.send_image_with_buttons(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        session_id,
        ^^^^^^^^^^^
    ...<3 lines>...
        buttons
        ^^^^^^^
    )
    ^
TypeError: WhatsAppService.send_image_with_buttons() takes 5 positional arguments but 6 were given
2025-08-26 13:29:43,291 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-26 13:29:44,644 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI4QzRCRUNDREU0QTUwRDQyMAA="}]}
2025-08-26 13:29:44,645 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI4QzRCRUNDREU0QTUwRDQyMAA='}]}
2025-08-26 13:29:44,658 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:29:44] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:29:45,976 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:29:45] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:29:46,130 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:29:46] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:29:46,132 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:29:46] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:36:19,105 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-26 13:36:21,858 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 13:36:24,265 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 13:36:24,482 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 13:36:26,351 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 13:36:26,553 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 13:36:26,554 - services.payment_service - INFO - PaymentService initialized
2025-08-26 13:36:28,283 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-26 13:36:28,483 - app - INFO - Initial product sync successful on startup
2025-08-26 13:36:28,483 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 13:36:28,484 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-26 13:36:28,485 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 13:36:28,486 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:36:28,515 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 13:36:30,141 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 13:36:30,343 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 13:36:32,353 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 13:36:32,558 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 13:36:32,559 - services.payment_service - INFO - PaymentService initialized
2025-08-26 13:36:32,559 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-26 13:36:32,559 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-26 13:36:32,559 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 13:36:32,571 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-26 13:36:32,571 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 13:36:32,572 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:36:33,141 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-26 13:36:33,141 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-26 13:36:33,141 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-26 13:36:33,142 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-26 13:36:33,142 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:36:33,184 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-26 13:36:33,185 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-26 13:36:44,331 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-26 13:36:44,331 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-26 13:36:45,998 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 13:36:47,474 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-26 12:36:46.192652+00:00, interaction_count=605, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=2000.0, converted_at=2025-08-20 03:28:22.581001+00:00
2025-08-26 13:36:48,158 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 13:36:48,159 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-26 13:36:49,836 - utils.data_manager - DEBUG - Found address 'Location: 6.5864913, 3.3744984' for phone number 2348055614455 in whatsapp_orders
2025-08-26 13:36:50,043 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-26 13:36:50,043 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.58649, 3.3744969', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-26 13:36:50,044 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-26 13:36:50,044 - handlers.message_processor - ERROR - Session 2348055614455: Error in message routing for handler 'greeting_handler', state 'start': WhatsAppService.send_image_with_buttons() takes 5 positional arguments but 6 were given
Traceback (most recent call last):
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\message_processor.py", line 179, in _route_to_handler
    return self.greeting_handler.handle_back_to_main(state, session_id, "Let's start fresh. What can I do for you?")
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 295, in handle_back_to_main
    return self._send_greeting_with_image(session_id, user_name, "guest")
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\zigam\Documents\Coding\Pentanative\Lola_Pentanative\handlers\greeting_handler.py", line 328, in _send_greeting_with_image
    return self.whatsapp_service.send_image_with_buttons(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        session_id,
        ^^^^^^^^^^^
    ...<3 lines>...
        button_prompt
        ^^^^^^^^^^^^^
    )
    ^
TypeError: WhatsAppService.send_image_with_buttons() takes 5 positional arguments but 6 were given
2025-08-26 13:36:50,046 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-26 13:36:50,953 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ1QkFCMzI0RDgxQTBCMjQ2NwA="}]}
2025-08-26 13:36:50,954 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjQ1QkFCMzI0RDgxQTBCMjQ2NwA='}]}
2025-08-26 13:36:50,954 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:36:50] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:36:52,317 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:36:52] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:36:52,319 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:36:52] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:36:52,989 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:36:52] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:43:58,630 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-26 13:43:59,711 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 13:44:02,182 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 13:44:02,437 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 13:44:04,352 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 13:44:04,582 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 13:44:04,582 - services.payment_service - INFO - PaymentService initialized
2025-08-26 13:44:06,289 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-26 13:44:06,488 - app - INFO - Initial product sync successful on startup
2025-08-26 13:44:06,489 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 13:44:06,489 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-26 13:44:06,489 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 13:44:06,490 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:44:06,496 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 13:44:08,215 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 13:44:08,425 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 13:44:10,295 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 13:44:10,490 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 13:44:10,491 - services.payment_service - INFO - PaymentService initialized
2025-08-26 13:44:10,491 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-26 13:44:10,492 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-26 13:44:10,492 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 13:44:10,493 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-26 13:44:10,493 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 13:44:10,493 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:44:10,865 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-26 13:44:10,865 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-26 13:44:10,866 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-26 13:44:10,866 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-26 13:44:10,866 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 13:44:10,883 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-26 13:44:10,884 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-26 13:44:19,963 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-26 13:44:19,963 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-26 13:44:21,748 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 13:44:23,365 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-14 20:32:42.382750+00:00, last_interaction=2025-08-26 12:44:21.954801+00:00, interaction_count=606, status=converted, has_added_to_cart=True, has_placed_order=True, total_cart_value=2000.0, conversion_stage=cart_added, final_order_value=2000.0, converted_at=2025-08-20 03:28:22.581001+00:00
2025-08-26 13:44:24,041 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 13:44:24,042 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-26 13:44:25,754 - utils.data_manager - DEBUG - Found address 'Location: 6.5864913, 3.3744984' for phone number 2348055614455 in whatsapp_orders
2025-08-26 13:44:25,952 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-26 13:44:25,952 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.58649, 3.3744969', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-26 13:44:25,953 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-26 13:44:25,953 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-26 13:44:26,987 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhCQTVFMTg0RDFCRDI2NEI2MQA="}]}
2025-08-26 13:44:26,988 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 13:44:27,858 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkzRjA0MjA1QjM0RkJCOUQ3NwA="}]}
2025-08-26 13:44:27,859 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkzRjA0MjA1QjM0RkJCOUQ3NwA='}]}
2025-08-26 13:44:27,860 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:44:27] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:44:28,959 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:44:28] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:44:29,417 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:44:29] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:44:29,577 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:44:29] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:44:29,658 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:44:29] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:44:29,860 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:44:29] "POST /webhook HTTP/1.1" 200 -
2025-08-26 13:44:30,304 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 13:44:30] "POST /webhook HTTP/1.1" 200 -
2025-08-26 14:59:58,880 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-26 15:00:00,649 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 15:00:04,191 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 15:00:04,390 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 15:00:06,300 - utils.data_manager - INFO - Successfully loaded 53 user details from database
2025-08-26 15:00:06,533 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 15:00:06,534 - services.payment_service - INFO - PaymentService initialized
2025-08-26 15:00:08,214 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-26 15:00:08,418 - app - INFO - Initial product sync successful on startup
2025-08-26 15:00:08,418 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 15:00:08,419 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-26 15:00:08,419 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 15:00:08,419 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 15:00:08,431 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 15:00:10,329 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 15:00:10,834 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 15:00:12,681 - utils.data_manager - INFO - Successfully loaded 53 user details from database
2025-08-26 15:00:12,880 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 15:00:12,881 - services.payment_service - INFO - PaymentService initialized
2025-08-26 15:00:12,881 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-26 15:00:12,881 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-26 15:00:12,881 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 15:00:12,883 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-26 15:00:12,883 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 15:00:12,884 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 15:00:13,322 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-26 15:00:13,322 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-26 15:00:13,323 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-26 15:00:13,323 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-26 15:00:13,324 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 15:00:13,363 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-26 15:00:13,364 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-26 15:00:26,387 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-26 15:00:26,388 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-26 15:00:28,391 - utils.data_manager - DEBUG - No lead found for phone number 2348055614455 in whatsapp_leads
2025-08-26 15:00:30,432 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:00:28.590911+00:00, interaction_count=1, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-08-26 15:00:31,106 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:00:33,709 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-26 15:00:33,992 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348055614455
2025-08-26 15:00:34,458 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-26 15:00:34,459 - utils.data_manager - DEBUG - No user data found for 2348055614455
2025-08-26 15:00:34,459 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-26 15:00:34,459 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-26 15:00:35,224 - services.whatsapp_service - ERROR - HTTP error sending WhatsApp message: 401 Client Error: Unauthorized for url: https://graph.facebook.com/v17.0/204426689424598/messages - Response: No response
2025-08-26 15:00:35,234 - services.whatsapp_service - ERROR - Failed to send image to 2348055614455. Aborting button message.
2025-08-26 15:00:35,235 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:00:35] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:04:16,515 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-26 15:04:17,701 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 15:04:19,515 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 15:04:19,750 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 15:04:21,601 - utils.data_manager - INFO - Successfully loaded 53 user details from database
2025-08-26 15:04:21,821 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 15:04:21,822 - services.payment_service - INFO - PaymentService initialized
2025-08-26 15:04:23,414 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-26 15:04:23,616 - app - INFO - Initial product sync successful on startup
2025-08-26 15:04:23,617 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 15:04:23,617 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-26 15:04:23,617 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 15:04:23,618 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 15:04:23,624 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 15:04:25,280 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 15:04:25,484 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 15:04:27,508 - utils.data_manager - INFO - Successfully loaded 53 user details from database
2025-08-26 15:04:27,715 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 15:04:27,716 - services.payment_service - INFO - PaymentService initialized
2025-08-26 15:04:27,716 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-26 15:04:27,716 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-26 15:04:27,717 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 15:04:27,717 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-26 15:04:27,717 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 15:04:27,718 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 15:04:28,085 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-26 15:04:28,086 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-26 15:04:28,086 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-26 15:04:28,086 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-26 15:04:28,087 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 15:04:28,102 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-26 15:04:28,102 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-26 15:04:30,897 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-26 15:04:30,898 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-26 15:04:32,629 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:04:34,381 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:04:32.836998+00:00, interaction_count=2, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-08-26 15:04:35,201 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:04:35,202 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-26 15:04:37,330 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-26 15:04:37,530 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348055614455
2025-08-26 15:04:37,731 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-26 15:04:37,731 - utils.data_manager - DEBUG - No user data found for 2348055614455
2025-08-26 15:04:37,731 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-26 15:04:37,732 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-26 15:04:39,294 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYxM0ZEQjJBQzIxOUFDREMyQgA="}]}
2025-08-26 15:04:39,295 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 15:04:40,420 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY4OEE0MTI5NjQ3MUVBREMxOAA="}]}
2025-08-26 15:04:40,421 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjY4OEE0MTI5NjQ3MUVBREMxOAA='}]}
2025-08-26 15:04:40,422 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:04:40] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:04:41,290 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:04:41] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:04:41,746 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:04:41] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:04:41,859 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:04:41] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:04:42,320 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:04:42] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:06:45,605 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-26 15:06:47,355 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:06:48,872 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:06:47.670775+00:00, interaction_count=3, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-08-26 15:06:49,470 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:06:49,470 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 15:06:52,985 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-26 15:06:53,205 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348055614455
2025-08-26 15:06:53,445 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-26 15:06:53,446 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-08-26 15:06:53,446 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-26 15:06:53,446 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-26 15:06:53,446 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-26 15:06:53,447 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-26 15:06:54,722 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjI4QUQyM0E2ODdGOTc5MjgxNQA="}]}
2025-08-26 15:06:54,723 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-26 15:06:54,724 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-26 15:06:55,835 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBRTVEQ0MyQUNGRjA1QTU5RQA="}]}
2025-08-26 15:06:55,836 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjdBRTVEQ0MyQUNGRjA1QTU5RQA='}]}
2025-08-26 15:06:55,837 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:06:55] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:06:57,125 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:06:57] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:06:58,328 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:06:58] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:06:58,409 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:06:58] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:06:58,564 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:06:58] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:05,666 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice'}
2025-08-26 15:07:07,321 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:07:09,098 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:07:07.581130+00:00, interaction_count=4, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-08-26 15:07:09,713 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:07:09,713 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 15:07:11,510 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-26 15:07:11,709 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348055614455
2025-08-26 15:07:11,964 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice'
2025-08-26 15:07:15,253 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-26 15:07:15,271 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 15:07:16,462 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNTZBRTZEQUVFNDgyRTlBRgA="}]}
2025-08-26 15:07:16,463 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFFNTZBRTZEQUVFNDgyRTlBRgA='}]}
2025-08-26 15:07:16,464 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:16] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:17,537 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:17] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:17,972 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:17] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:21,302 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-26 15:07:22,949 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:07:24,370 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:07:23.156721+00:00, interaction_count=5, status=new_lead, has_added_to_cart=False, has_placed_order=False, total_cart_value=0.0, conversion_stage=initial_contact, final_order_value=0.0, converted_at=None
2025-08-26 15:07:24,994 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:07:24,995 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 15:07:26,739 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-26 15:07:26,940 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348055614455
2025-08-26 15:07:27,140 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}}. Redirecting to order handler.
2025-08-26 15:07:27,141 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-26 15:07:27,141 - utils.data_manager - DEBUG - No user data found for 2348055614455
2025-08-26 15:07:27,142 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-26 15:07:27,142 - handlers.order_handler - INFO - Address not set after AI order, redirecting to location handler for session 2348055614455.
2025-08-26 15:07:27,142 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'initiate_address_collection'.
2025-08-26 15:07:27,150 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 15:07:28,182 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcwMzRBNzA3RTM1MEU3NkM1NAA="}]}
2025-08-26 15:07:29,272 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:29] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:29,522 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:29] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:29,619 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:29] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:29,872 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:07:31,542 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:07:30.179680+00:00, interaction_count=6, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:07:32,183 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:07:32,190 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcwMzRBNzA3RTM1MEU3NkM1NAA='}]}
2025-08-26 15:07:32,190 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:32] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:33,789 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'share_current_location'}
2025-08-26 15:07:35,445 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:07:36,919 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:07:35.714647+00:00, interaction_count=7, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:07:37,520 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:07:37,521 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 15:07:39,212 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-26 15:07:39,409 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348055614455
2025-08-26 15:07:39,611 - handlers.location_address_handler - INFO - Requested live location for session 2348055614455
2025-08-26 15:07:39,611 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-26 15:07:40,672 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM5MEE2MDAyMjQ3NkM4OTc4NAA="}]}
2025-08-26 15:07:41,714 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:41] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:42,126 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:42] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:42,390 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:07:43,828 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:07:42.594629+00:00, interaction_count=8, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:07:44,482 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:07:44,488 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM5MEE2MDAyMjQ3NkM4OTc4NAA='}]}
2025-08-26 15:07:44,488 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:44] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:51,811 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'location', 'latitude': 6.5864785, 'longitude': 3.3744879, 'name': None, 'address': None}
2025-08-26 15:07:53,509 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:07:54,964 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:07:53.713438+00:00, interaction_count=9, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:07:55,568 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:07:55,569 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 15:07:55,570 - handlers.location_address_handler - INFO - Processing live location for 2348055614455: Lat=6.5864785, Lon=3.3744879, Name='None', Address='None'
2025-08-26 15:07:55,570 - handlers.location_address_handler - WARNING - No readable address for 2348055614455 from 6.5864785,3.3744879. Awaiting coordinates confirmation.
2025-08-26 15:07:55,576 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 15:07:56,551 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg1NzZBOTJEMTgwQzZEMkZGMgA="}]}
2025-08-26 15:07:56,551 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjg1NzZBOTJEMTgwQzZEMkZGMgA='}]}
2025-08-26 15:07:56,552 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:56] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:57,526 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:57] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:57,875 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:57] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:58,061 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:07:58] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:07:59,902 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'use_coordinates'}
2025-08-26 15:08:01,598 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:08:03,274 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:08:01.809341+00:00, interaction_count=10, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:08:03,962 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:08:03,963 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 15:08:05,826 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-26 15:08:06,031 - utils.data_manager - DEBUG - No address found in whatsapp_user_details for phone number 2348055614455
2025-08-26 15:08:08,141 - utils.data_manager - INFO - User details for 2348055614455 saved to database
2025-08-26 15:08:08,142 - handlers.location_address_handler - INFO - Address and coordinates saved for 2348055614455
2025-08-26 15:08:08,143 - handlers.location_address_handler - INFO - Confirmed coordinates for 2348055614455: Location: 6.5864785, 3.3744879
2025-08-26 15:08:08,143 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'handle_confirm_order_state'.
2025-08-26 15:08:08,153 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-26 15:08:09,111 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhBNEYxODUzNUQzNjNDMkJENwA="}]}
2025-08-26 15:08:10,444 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:10] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:10,658 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:10] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:10,673 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:10] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:11,299 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:08:12,907 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:08:11.507314+00:00, interaction_count=11, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:08:13,547 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:08:13,553 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhBNEYxODUzNUQzNjNDMkJENwA='}]}
2025-08-26 15:08:13,554 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:13] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:19,340 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Yes'}
2025-08-26 15:08:21,084 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:08:22,640 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:08:21.288627+00:00, interaction_count=12, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:08:23,439 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:08:23,439 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 15:08:23,440 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-26 15:08:23,440 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please select 'Confirm & Pay', 'Update Address', 'Add Note', or 'Cancel Order'."}}
2025-08-26 15:08:24,698 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI3NzA1QUE3NjE5NEZCQjgzOAA="}]}
2025-08-26 15:08:25,689 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:25] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:26,211 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:26] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:26,252 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:26] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:26,499 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:08:27,898 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:08:26.710482+00:00, interaction_count=13, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:08:28,498 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:08:28,503 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI3NzA1QUE3NjE5NEZCQjgzOAA='}]}
2025-08-26 15:08:28,504 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:28] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:46,818 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Confirm & Pay'}
2025-08-26 15:08:48,581 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:08:50,058 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:08:48.780688+00:00, interaction_count=14, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:08:50,665 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:08:50,666 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 15:08:50,667 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-26 15:08:50,667 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Please select 'Confirm & Pay', 'Update Address', 'Add Note', or 'Cancel Order'."}}
2025-08-26 15:08:51,763 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAzRTk2OUU4NTA4ODhFQjExMgA="}]}
2025-08-26 15:08:52,804 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:52] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:53,158 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:53] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:53,199 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:53] "POST /webhook HTTP/1.1" 200 -
2025-08-26 15:08:53,445 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 15:08:54,909 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 14:08:53.658975+00:00, interaction_count=15, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 15:08:55,509 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 15:08:55,515 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjAzRTk2OUU4NTA4ODhFQjExMgA='}]}
2025-08-26 15:08:55,516 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 15:08:55] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:33:08,972 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-26 16:33:11,511 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 16:33:13,868 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 16:33:14,070 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 16:33:15,823 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 16:33:16,051 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 16:33:16,051 - services.payment_service - INFO - PaymentService initialized
2025-08-26 16:33:17,642 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-26 16:33:17,839 - app - INFO - Initial product sync successful on startup
2025-08-26 16:33:17,839 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 16:33:17,840 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-26 16:33:17,840 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 16:33:17,841 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 16:33:17,854 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 16:33:19,610 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 16:33:19,810 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 16:33:21,574 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 16:33:21,782 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 16:33:21,783 - services.payment_service - INFO - PaymentService initialized
2025-08-26 16:33:21,783 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-26 16:33:21,783 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-26 16:33:21,783 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 16:33:21,785 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-26 16:33:21,785 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 16:33:21,785 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 16:33:22,351 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-26 16:33:22,351 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-26 16:33:22,351 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-26 16:33:22,352 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-26 16:33:22,352 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 16:33:22,389 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-26 16:33:22,389 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-26 16:33:36,905 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-26 16:33:36,906 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-26 16:33:38,560 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:33:39,969 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:33:38.760591+00:00, interaction_count=16, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:33:40,618 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:33:40,619 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-26 16:33:42,258 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-26 16:33:42,441 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_user_details
2025-08-26 16:33:42,640 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-26 16:33:42,641 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-26 16:33:42,641 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-26 16:33:42,642 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-26 16:33:44,831 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjkxRkM0M0NGMjk2NTExQUVFNAA="}]}
2025-08-26 16:33:44,832 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 16:33:46,610 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5Mzc3Q0EwNDU3NkU0RkIwOAA="}]}
2025-08-26 16:33:46,611 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkI5Mzc3Q0EwNDU3NkU0RkIwOAA='}]}
2025-08-26 16:33:46,613 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:33:46] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:33:46,751 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:33:46] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:33:47,030 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:33:47] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:33:47,764 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:33:47] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:33:47,910 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:33:47] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:33:48,549 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:33:48] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:33:52,942 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'ai_bulk_order_direct'}
2025-08-26 16:33:54,541 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:33:55,939 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:33:54.740069+00:00, interaction_count=17, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:33:56,569 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:33:56,570 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 16:33:56,570 - handlers.base_handler - INFO - GreetingHandler: Handling message 'ai_bulk_order_direct' in greeting state for session 2348055614455.
2025-08-26 16:33:56,570 - handlers.base_handler - INFO - Session 2348055614455 redirecting to AIHandler for AI Bulk Order (Make an Order).
2025-08-26 16:33:56,571 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'ai_handler' with message 'start_ai_bulk_order'.
2025-08-26 16:33:56,571 - handlers.base_handler - INFO - AIHandler: Handling message 'start_ai_bulk_order' in AI bulk order state for session 2348055614455. Original: 'ai_bulk_order_direct'
2025-08-26 16:33:56,571 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-26 16:33:56,572 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'image', 'image': {'link': 'https://rsvp.eventio.africa/wp-content/uploads/2025/08/tuesday.jpg', 'caption': 'Our Delicious Menu!'}}
2025-08-26 16:33:56,636 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:33:56] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:33:57,835 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1REEwOEQ4NEUwQzk2Q0IzOQA="}]}
2025-08-26 16:33:57,835 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-26 16:33:57,836 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "Hi, I'm Lola from Ganador \n\nTake a look at the menu and type in your order\n\n"}}
2025-08-26 16:33:58,781 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyNzVGMTI0MTE1NkI5NTI3RgA="}]}
2025-08-26 16:33:58,782 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkUyNzVGMTI0MTE1NkI5NTI3RgA='}]}
2025-08-26 16:33:58,782 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:33:58] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:33:59,788 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:33:59] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:00,453 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:00] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:00,455 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:00] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:00,651 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:00] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:00,933 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:00] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:01,211 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:01] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:12,388 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Jellof rice and fried rice'}
2025-08-26 16:34:14,078 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:34:15,580 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:34:14.294545+00:00, interaction_count=18, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:34:16,227 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:34:16,228 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 16:34:16,228 - handlers.base_handler - INFO - AIHandler: Handling message 'jellof rice and fried rice' in AI bulk order state for session 2348055614455. Original: 'Jellof rice and fried rice'
2025-08-26 16:34:20,331 - httpx - INFO - HTTP Request: POST https://insig-maduyfup-eastus2.cognitiveservices.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2024-12-01-preview "HTTP/1.1 200 OK"
2025-08-26 16:34:20,345 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 16:34:21,430 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhFMkIwQzNGNzAxNjJBNjEzMAA="}]}
2025-08-26 16:34:21,431 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjhFMkIwQzNGNzAxNjJBNjEzMAA='}]}
2025-08-26 16:34:21,432 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:21] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:22,464 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:22] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:22,722 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:22] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:22,981 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:22] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:25,396 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'confirm_ai_order'}
2025-08-26 16:34:27,113 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:34:28,571 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:34:27.310467+00:00, interaction_count=19, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:34:29,260 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:34:29,261 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 16:34:29,261 - handlers.base_handler - INFO - AI order confirmed. Cart: {'Jollof Rice': {'item_id': '112', 'quantity': 1, 'price': 150.0, 'total_price': 150.0, 'variations': {}}, 'Fried Rice': {'item_id': '113', 'quantity': 1, 'price': 2000.0, 'total_price': 2000.0, 'variations': {}}}. Redirecting to order handler.
2025-08-26 16:34:29,261 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'order_handler' with message 'process_final_order'.
2025-08-26 16:34:29,261 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-26 16:34:29,262 - handlers.order_handler - INFO - AI initiated order processing for session 2348055614455.
2025-08-26 16:34:29,262 - handlers.order_handler - INFO - Prompting for note after AI order confirmation for session 2348055614455.
2025-08-26 16:34:29,269 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 16:34:31,391 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYxOUJCQkFBQzE4RjE2MjgyQQA="}]}
2025-08-26 16:34:32,361 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:32] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:32,663 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:32] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:32,791 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:32] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:33,051 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:34:34,322 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'proceed_to_confirmation'}
2025-08-26 16:34:34,429 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:34:33.250043+00:00, interaction_count=20, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:34:35,021 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:34:35,039 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkYxOUJCQkFBQzE4RjE2MjgyQQA='}]}
2025-08-26 16:34:35,040 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:35] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:36,129 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:34:37,581 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:34:36.331105+00:00, interaction_count=21, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:34:38,224 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:34:38,224 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 16:34:38,225 - handlers.order_handler - INFO - User chose to proceed to final confirmation without adding a note for session 2348055614455.
2025-08-26 16:34:38,225 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-26 16:34:38,236 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 16:34:39,734 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE0RDcyQzUwQUM4NUU3NzdCOAA="}]}
2025-08-26 16:34:40,754 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:40] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:41,064 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:41] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:41,169 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:41] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:41,360 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:34:42,749 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:34:41.570475+00:00, interaction_count=22, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:34:43,327 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:34:43,334 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkE0RDcyQzUwQUM4NUU3NzdCOAA='}]}
2025-08-26 16:34:43,334 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:43] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:43,480 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'update_address'}
2025-08-26 16:34:45,111 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:34:46,531 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:34:45.301258+00:00, interaction_count=23, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:34:47,183 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:34:47,183 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 16:34:47,184 - handlers.order_handler - INFO - User opted to update address for session 2348055614455.
2025-08-26 16:34:47,184 - handlers.message_processor - INFO - Session 2348055614455: Redirecting to handler 'location_handler' with message 'initiate_address_collection'.
2025-08-26 16:34:47,200 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 16:34:48,200 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1MUQ0MDRDNEYwNzcwOUI5NgA="}]}
2025-08-26 16:34:49,487 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:49] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:49,531 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:49] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:49,809 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:34:49,921 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:49] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:34:51,188 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:34:50.011317+00:00, interaction_count=24, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:34:51,779 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:34:51,785 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjA1MUQ0MDRDNEYwNzcwOUI5NgA='}]}
2025-08-26 16:34:51,785 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:34:51] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:39:42,203 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-26 16:39:44,349 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 16:39:46,139 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 16:39:46,333 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 16:39:48,130 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 16:39:48,337 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 16:39:48,338 - services.payment_service - INFO - PaymentService initialized
2025-08-26 16:39:49,885 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-26 16:39:50,093 - app - INFO - Initial product sync successful on startup
2025-08-26 16:39:50,094 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 16:39:50,094 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-26 16:39:50,095 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 16:39:50,095 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 16:39:50,105 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-26 16:39:51,748 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-26 16:39:51,949 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-26 16:39:53,739 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-26 16:39:53,934 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-26 16:39:53,935 - services.payment_service - INFO - PaymentService initialized
2025-08-26 16:39:53,935 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-26 16:39:53,935 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-26 16:39:53,935 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-26 16:39:53,936 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-08-26 16:39:53,937 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-26 16:39:53,937 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-26 16:39:53,937 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 16:39:54,458 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-26 16:39:54,458 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-26 16:39:54,459 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-26 16:39:54,459 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-26 16:39:54,459 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-26 16:39:54,497 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-26 16:39:54,497 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-26 16:39:56,229 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-26 16:39:56,229 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-26 16:39:57,809 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:39:59,204 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:39:58.008097+00:00, interaction_count=25, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:39:59,808 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:39:59,809 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-26 16:40:01,419 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-26 16:40:01,629 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_user_details
2025-08-26 16:40:01,828 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-26 16:40:01,829 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-26 16:40:01,829 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-26 16:40:01,830 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-26 16:40:03,000 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEkM5REREMEM4OTIwQjNGQkE3OAA="}]}
2025-08-26 16:40:03,001 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 16:40:03,951 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcyNUYyQUM0QkU0MzlGNkJGRAA="}]}
2025-08-26 16:40:03,952 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjcyNUYyQUM0QkU0MzlGNkJGRAA='}]}
2025-08-26 16:40:03,954 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:03] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:04,768 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:04] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:05,221 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:05] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:05,292 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:05] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:05,447 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:05] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:05,708 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:05] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:06,008 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:06] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:07,011 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'complain'}
2025-08-26 16:40:08,648 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:40:10,146 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:40:08.859018+00:00, interaction_count=26, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:40:10,778 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:40:10,779 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 16:40:10,779 - handlers.base_handler - INFO - GreetingHandler: Handling message 'complain' in greeting state for session 2348055614455.
2025-08-26 16:40:10,779 - handlers.base_handler - INFO - Session 2348055614455 entering complaint state.
2025-08-26 16:40:10,780 - services.whatsapp_service - DEBUG - Created text message payload for 2348055614455
2025-08-26 16:40:10,780 - services.whatsapp_service - INFO - Sending WhatsApp payload to 2348055614455: {'messaging_product': 'whatsapp', 'recipient_type': 'individual', 'to': '2348055614455', 'type': 'text', 'text': {'body': "We're sorry to hear you're having an issue. Please tell us about your complaint and we'll address it promptly."}}
2025-08-26 16:40:11,739 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGRTQyNDY0REY2ODU1ODRFQwA="}]}
2025-08-26 16:40:11,740 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjFGRTQyNDY0REY2ODU1ODRFQwA='}]}
2025-08-26 16:40:11,740 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:11] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:12,799 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:12] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:13,028 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:13] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:13,395 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:13] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:28,696 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Your delivery is slow and no one is answering'}
2025-08-26 16:40:30,378 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-26 16:40:31,805 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-26 15:40:30.599020+00:00, interaction_count=27, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-26 16:40:32,429 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-26 16:40:32,430 - services.lead_tracker - INFO - Updated ongoing interaction: 2348055614455
2025-08-26 16:40:32,430 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-26 16:40:34,308 - utils.data_manager - INFO - Complaint 17 saved to database
2025-08-26 16:40:34,309 - handlers.base_handler - INFO - Session 2348055614455: Complaint 17 saved for user Ziga (phone: 2348055614455) with text: Your delivery is slow and no one is answering
2025-08-26 16:40:34,309 - services.whatsapp_service - DEBUG - Created text message payload for 2347082345056
2025-08-26 16:40:35,628 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2347082345056","wa_id":"2347082345056"}],"messages":[{"id":"wamid.HBgNMjM0NzA4MjM0NTA1NhUCABEYEjZBMTgxQTg3Qjc5QkEzQzMwRgA="}]}
2025-08-26 16:40:35,629 - handlers.base_handler - INFO - Sent merchant notification for complaint 17 to 2347082345056
2025-08-26 16:40:35,629 - handlers.base_handler - INFO - Session 2348055614455: Returned to main menu from complaint handler.
2025-08-26 16:40:35,635 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-26 16:40:36,640 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlCNzM3QzVBQkJERDY0NkFGMQA="}]}
2025-08-26 16:40:36,641 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjlCNzM3QzVBQkJERDY0NkFGMQA='}]}
2025-08-26 16:40:36,641 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:36] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:37,337 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:37] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:37,622 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:37] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:38,150 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:38] "POST /webhook HTTP/1.1" 200 -
2025-08-26 16:40:38,152 - werkzeug - INFO - 127.0.0.1 - - [26/Aug/2025 16:40:38] "POST /webhook HTTP/1.1" 200 -
2025-08-27 14:01:06,779 - __main__ - INFO - Starting WhatsApp bot server...
2025-08-27 14:01:10,623 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-27 14:01:13,078 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-27 14:01:13,287 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-27 14:01:15,136 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-27 14:01:15,344 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-27 14:01:15,344 - services.payment_service - INFO - PaymentService initialized
2025-08-27 14:01:16,925 - handlers.product_sync_handler - INFO - Successfully synced 17 products for merchant 20 to data\products.json
2025-08-27 14:01:17,130 - app - INFO - Initial product sync successful on startup
2025-08-27 14:01:17,131 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-27 14:01:17,131 - app - INFO - GreetingHandler and FeedbackHandler initialized.
2025-08-27 14:01:17,132 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-27 14:01:17,132 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-27 14:01:17,143 - utils.session_manager - INFO - SessionManager initialized. Default timeouts: Unpaid=3000s, Paid=12000s
2025-08-27 14:01:18,732 - utils.data_manager - DEBUG - customers_note column already exists in whatsapp_orders table.
2025-08-27 14:01:18,943 - utils.data_manager - DEBUG - service_charge column already exists in whatsapp_orders table.
2025-08-27 14:01:20,704 - utils.data_manager - INFO - Successfully loaded 54 user details from database
2025-08-27 14:01:20,903 - services.whatsapp_service - DEBUG - WhatsAppService initialized with phone_number_id: 204426689424598
2025-08-27 14:01:20,903 - services.payment_service - INFO - PaymentService initialized
2025-08-27 14:01:20,904 - services.lead_tracker - INFO - LeadTracker initialized with DataManager
2025-08-27 14:01:20,904 - handlers.lead_tracking_handler - INFO - LeadTrackingHandler initialized.
2025-08-27 14:01:20,904 - handlers.feedback_handler - INFO - FeedbackHandler initialized.
2025-08-27 14:01:20,905 - handlers.enquiry_handler - INFO - EnquiryHandler initialized with merchant phone 2347082345056
2025-08-27 14:01:20,906 - handlers.complaint_handler - INFO - ComplaintHandler initialized with merchant phone 2347082345056
2025-08-27 14:01:20,907 - handlers.order_handler - INFO - OrderHandler initialized.
2025-08-27 14:01:20,907 - handlers.payment_handler - INFO - FeedbackHandler successfully provided to PaymentHandler
2025-08-27 14:01:20,907 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-27 14:01:21,813 - services.ai_service - INFO - Azure OpenAI client initialized successfully in AIService.
2025-08-27 14:01:21,814 - handlers.ai_handler - INFO - AIHandler: AIService successfully initialized.
2025-08-27 14:01:21,814 - handlers.message_processor - INFO - MessageProcessor initialized with lead tracking, AI support, and feedback collection.
2025-08-27 14:01:21,814 - handlers.payment_handler - WARNING - FeedbackHandler not provided, feedback collection will be manual
2025-08-27 14:01:21,815 - handlers.payment_handler - INFO - ProductSyncHandler successfully provided to PaymentHandler
2025-08-27 14:01:21,852 - werkzeug - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on http://127.0.0.1:8000
2025-08-27 14:01:21,853 - werkzeug - INFO - [33mPress CTRL+C to quit[0m
2025-08-27 14:05:20,275 - handlers.webhook_handler - INFO - Processing message from 2348055614455 (User: Ziga): {'type': 'text', 'text': 'Hello'}
2025-08-27 14:05:20,276 - utils.session_manager - INFO - New session 2348055614455 initialized.
2025-08-27 14:05:21,922 - utils.data_manager - INFO - Retrieved lead by phone number 2348055614455 from whatsapp_leads
2025-08-27 14:05:23,311 - utils.data_manager - DEBUG - Saving lead 2348055614455: merchant_details_id=20, user_id=2348055614455, user_name=Ziga, phone_number=2348055614455, source=whatsapp, first_contact=2025-08-26 14:00:28.590908+00:00, last_interaction=2025-08-27 13:05:22.101000+00:00, interaction_count=28, status=new_lead, has_added_to_cart=True, has_placed_order=False, total_cart_value=2150.0, conversion_stage=cart_added, final_order_value=0.0, converted_at=None
2025-08-27 14:05:23,886 - utils.data_manager - INFO - Lead 2348055614455 saved to whatsapp_leads table
2025-08-27 14:05:23,887 - services.lead_tracker - INFO - Updated lead interaction: 2348055614455
2025-08-27 14:05:25,433 - utils.data_manager - DEBUG - No address found in whatsapp_orders for phone number 2348055614455. Trying whatsapp_user_details.
2025-08-27 14:05:25,637 - utils.data_manager - DEBUG - Found address 'Location: 6.5864785, 3.3744879' for phone number 2348055614455 in whatsapp_user_details
2025-08-27 14:05:25,826 - handlers.message_processor - INFO - Session 2348055614455: Global escape keyword 'hello' detected. Resetting to greeting.
2025-08-27 14:05:25,826 - utils.data_manager - DEBUG - Retrieved user data for 2348055614455: {'name': 'Ziga', 'phone_number': '2348055614455', 'address': 'Location: 6.5864785, 3.3744879', 'user_perferred_name': 'Ziga', 'address2': '', 'address3': '', 'display_name': 'Ziga'}
2025-08-27 14:05:25,827 - handlers.base_handler - INFO - Session 2348055614455 returned to main menu (greeting state).
2025-08-27 14:05:25,828 - services.whatsapp_service - DEBUG - Created image message payload for 2348055614455
2025-08-27 14:05:27,712 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjRCMjUxODc3MDhDMTIwQUVGQgA="}]}
2025-08-27 14:05:27,722 - services.whatsapp_service - DEBUG - Created button message payload for 2348055614455
2025-08-27 14:05:28,811 - services.whatsapp_service - INFO - WhatsApp API response: 200 - {"messaging_product":"whatsapp","contacts":[{"input":"2348055614455","wa_id":"2348055614455"}],"messages":[{"id":"wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBDODhBQzY4MzAwQzAwOTYwMgA="}]}
2025-08-27 14:05:28,812 - services.whatsapp_service - ERROR - Missing 'to' parameter in payload: {'messaging_product': 'whatsapp', 'contacts': [{'input': '2348055614455', 'wa_id': '2348055614455'}], 'messages': [{'id': 'wamid.HBgNMjM0ODA1NTYxNDQ1NRUCABEYEjBDODhBQzY4MzAwQzAwOTYwMgA='}]}
2025-08-27 14:05:28,814 - werkzeug - INFO - 127.0.0.1 - - [27/Aug/2025 14:05:28] "POST /webhook HTTP/1.1" 200 -
2025-08-27 14:05:30,702 - werkzeug - INFO - 127.0.0.1 - - [27/Aug/2025 14:05:30] "POST /webhook HTTP/1.1" 200 -
2025-08-27 14:05:31,171 - werkzeug - INFO - 127.0.0.1 - - [27/Aug/2025 14:05:31] "POST /webhook HTTP/1.1" 200 -
2025-08-27 14:05:31,265 - werkzeug - INFO - 127.0.0.1 - - [27/Aug/2025 14:05:31] "POST /webhook HTTP/1.1" 200 -
2025-08-27 14:05:31,594 - werkzeug - INFO - 127.0.0.1 - - [27/Aug/2025 14:05:31] "POST /webhook HTTP/1.1" 200 -
2025-08-27 14:05:31,872 - werkzeug - INFO - 127.0.0.1 - - [27/Aug/2025 14:05:31] "POST /webhook HTTP/1.1" 200 -
2025-08-27 14:05:31,955 - werkzeug - INFO - 127.0.0.1 - - [27/Aug/2025 14:05:31] "POST /webhook HTTP/1.1" 200 -
2025-08-27 14:05:36,088 - werkzeug - INFO - 127.0.0.1 - - [27/Aug/2025 14:05:36] "POST /webhook HTTP/1.1" 200 -
2025-08-27 14:05:36,322 - werkzeug - INFO - 127.0.0.1 - - [27/Aug/2025 14:05:36] "POST /webhook HTTP/1.1" 200 -
